---
sidebar_position: 8
title: å®æˆ˜æ¡ˆä¾‹ï¼šæœ¬åœ°ç”µè„‘ç›‘æ§å¤§å±
description: ä½¿ç”¨ OpenTwins åˆ›å»ºç”µè„‘æ€§èƒ½ç›‘æ§ç³»ç»Ÿå’Œå¯è§†åŒ–å¤§å±çš„å®Œæ•´æ•™ç¨‹
tags: [æ•°å­—å­ªç”Ÿ, OpenTwins, å®æˆ˜æ¡ˆä¾‹, Grafana, ç›‘æ§å¤§å±, Python]
---

# å®æˆ˜æ¡ˆä¾‹ï¼šæœ¬åœ°ç”µè„‘ç›‘æ§å¤§å±

æœ¬æ•™ç¨‹å°†å¼•å¯¼ä½ ä½¿ç”¨ OpenTwins åˆ›å»ºä¸€ä¸ªå®Œæ•´çš„ç”µè„‘æ€§èƒ½ç›‘æ§ç³»ç»Ÿï¼Œå®æ—¶é‡‡é›†å¹¶å±•ç¤º CPUã€å†…å­˜ã€ç£ç›˜ç­‰æ€§èƒ½æŒ‡æ ‡ã€‚

## ä¸€ã€æ¡ˆä¾‹æ¦‚è¿°

### 1.1 åŠŸèƒ½ç›®æ ‡

- âœ… å®æ—¶ç›‘æ§æœ¬åœ°ç”µè„‘çš„ CPU ä½¿ç”¨ç‡
- âœ… å®æ—¶ç›‘æ§å†…å­˜ä½¿ç”¨æƒ…å†µ
- âœ… å®æ—¶ç›‘æ§ç£ç›˜ç©ºé—´
- âœ… åœ¨ Grafana ä¸­åˆ›å»ºå¯è§†åŒ–å¤§å±
- âœ… æ”¯æŒå†å²æ•°æ®æŸ¥è¯¢å’Œè¶‹åŠ¿åˆ†æ

### 1.2 ç³»ç»Ÿæ¶æ„

```mermaid
graph LR
    A[Windows ç”µè„‘] -->|é‡‡é›†æ•°æ®| B[Python è„šæœ¬]
    B -->|MQTT åè®®| C[Mosquitto]
    C -->|ä¼ è¾“| D[Eclipse Ditto]
    D -->|å­˜å‚¨| E[InfluxDB]
    E -->|æŸ¥è¯¢| F[Grafana å¤§å±]
```

### 1.3 æŠ€æœ¯æ ˆ

- **æ•°æ®é‡‡é›†**: Python + psutil
- **æ•°æ®ä¼ è¾“**: MQTT åè®®
- **æ•°å­—å­ªç”Ÿ**: Eclipse Ditto
- **æ—¶åºæ•°æ®åº“**: InfluxDB 2.x
- **æ•°æ®å¯è§†åŒ–**: Grafana

### 1.4 å‰ç½®æ¡ä»¶

- âœ… å·²å®Œæˆ OpenTwins éƒ¨ç½²ï¼ˆå‚è§ [OpenTwins Windows éƒ¨ç½²æŒ‡å—](./opentwins-windows-deployment.mdx)ï¼‰
- âœ… æ‰€æœ‰ç«¯å£è½¬å‘æ­£åœ¨è¿è¡Œ
- âœ… å·²å®‰è£… Python 3.7+
- âœ… å·²å®‰è£… pip

## äºŒã€å¿«é€Ÿå¼€å§‹ï¼ˆ5 åˆ†é’Ÿä½“éªŒï¼‰

### 2.1 é…ç½® Grafana

1. è®¿é—® http://localhost:3002
2. ç™»å½•ï¼ˆadmin/adminï¼‰
3. è·³è¿‡ä¿®æ”¹å¯†ç ï¼ˆæˆ–è®¾ç½®æ–°å¯†ç ï¼‰

### 2.2 åˆ›å»ºæ•°å­—å­ªç”Ÿ

æ‰“å¼€ PowerShellï¼Œè¿è¡Œï¼š

```powershell
# ç¬¬ä¸€æ­¥ï¼šåˆ›å»º Policy
$policyBody = @{
    policyId = "local:pc-monitor"
    entries = @{
        DEFAULT = @{
            subjects = @{
                "nginx:ditto" = @{ type = "Basic auth user" }
            }
            resources = @{
                "policy:/" = @{ grant = @("READ", "WRITE"); revoke = @() }
                "thing:/" = @{ grant = @("READ", "WRITE"); revoke = @() }
                "message:/" = @{ grant = @("READ", "WRITE"); revoke = @() }
            }
        }
    }
} | ConvertTo-Json -Depth 10

# å‡†å¤‡è®¤è¯ä¿¡æ¯
$auth = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes("ditto:ditto"))
$headers = @{
    "Content-Type" = "application/json"
    "Authorization" = "Basic $auth"
}

# åˆ›å»º Policy
Write-Host "åˆ›å»º Policy..." -ForegroundColor Yellow
Invoke-RestMethod -Uri "http://localhost:8080/api/2/policies/local:pc-monitor" `
    -Method Put `
    -Headers $headers `
    -Body $policyBody

# ç¬¬äºŒæ­¥ï¼šåˆ›å»º Thing
$thingBody = @{
    "thingId" = "local:pc-monitor"
    "policyId" = "local:pc-monitor"
    "attributes" = @{
        "hostname" = $env:COMPUTERNAME
        "os" = "Windows"
        "createdAt" = (Get-Date -Format "yyyy-MM-ddTHH:mm:ssZ")
    }
    "features" = @{
        "cpu" = @{
            "properties" = @{
                "usage" = 0.0
                "cores" = [System.Environment]::ProcessorCount
            }
        }
        "memory" = @{
            "properties" = @{
                "usage" = 0.0
                "total" = [Math]::Round((Get-CimInstance Win32_ComputerSystem).TotalPhysicalMemory / 1GB, 2)
            }
        }
        "disk" = @{
            "properties" = @{
                "usage" = 0.0
                "total" = [Math]::Round((Get-PSDrive C).Used / 1GB + (Get-PSDrive C).Free / 1GB, 2)
            }
        }
    }
} | ConvertTo-Json -Depth 10

# åˆ›å»º Thing
Write-Host "åˆ›å»º Thing..." -ForegroundColor Yellow
Invoke-RestMethod -Uri "http://localhost:8080/api/2/things/local:pc-monitor" `
    -Method Put `
    -Headers $headers `
    -Body $thingBody | ConvertTo-Json -Depth 10

Write-Host "`nâœ… æ•°å­—å­ªç”Ÿåˆ›å»ºæˆåŠŸï¼" -ForegroundColor Green
Write-Host "ä¸»æœºå: $env:COMPUTERNAME" -ForegroundColor Cyan
Write-Host "CPU æ ¸å¿ƒ: $([System.Environment]::ProcessorCount)" -ForegroundColor Cyan
```

### 2.3 éªŒè¯åˆ›å»º

```powershell
# æŸ¥è¯¢ Thing
$auth = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes("ditto:ditto"))
Invoke-RestMethod -Uri "http://localhost:8080/api/2/things/local:pc-monitor" `
    -Method Get `
    -Headers @{"Authorization"="Basic $auth"} | ConvertTo-Json -Depth 10
```

## ä¸‰ã€æ•°æ®é‡‡é›†ï¼ˆæ— éœ€ Pythonï¼‰

### 3.1 ä½¿ç”¨ PowerShell é‡‡é›†æ•°æ®

**æ— éœ€å®‰è£… Python**ï¼Œç›´æ¥ä½¿ç”¨ Windows PowerShell è¿›è¡Œæ•°æ®é‡‡é›†ï¼

### 3.2 æ‰‹åŠ¨å‘é€ä¸€æ¬¡æ•°æ®ï¼ˆæµ‹è¯•ï¼‰

```powershell
# å‡†å¤‡è®¤è¯ä¿¡æ¯
$auth = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes("ditto:ditto"))
$headers = @{
    "Content-Type" = "application/json"
    "Authorization" = "Basic $auth"
}

# é‡‡é›†ç³»ç»Ÿæ•°æ®
$cpuUsage = (Get-Counter '\Processor(_Total)\% Processor Time').CounterSamples.CookedValue
$os = Get-CimInstance Win32_OperatingSystem
$computerSystem = Get-CimInstance Win32_ComputerSystem
$totalMemory = $computerSystem.TotalPhysicalMemory
$freeMemory = $os.FreePhysicalMemory * 1KB
$usedMemory = $totalMemory - $freeMemory
$memUsagePercent = ($usedMemory / $totalMemory) * 100
$disk = Get-PSDrive C
$diskUsagePercent = ($disk.Used / ($disk.Used + $disk.Free)) * 100

# æ˜¾ç¤ºé‡‡é›†çš„æ•°æ®
Write-Host "é‡‡é›†åˆ°çš„æ•°æ®:" -ForegroundColor Yellow
Write-Host "  CPU: $([Math]::Round($cpuUsage, 2))%" -ForegroundColor Cyan
Write-Host "  å†…å­˜: $([Math]::Round($memUsagePercent, 2))%" -ForegroundColor Cyan
Write-Host "  ç£ç›˜: $([Math]::Round($diskUsagePercent, 2))%" -ForegroundColor Cyan

# æ„å»º JSON æ•°æ®
$updateBody = @{
    cpu = @{
        properties = @{
            usage = [Math]::Round($cpuUsage, 2)
            cores = [System.Environment]::ProcessorCount
        }
    }
    memory = @{
        properties = @{
            usage = [Math]::Round($memUsagePercent, 2)
            total_gb = [Math]::Round($totalMemory / 1GB, 2)
            used_gb = [Math]::Round($usedMemory / 1GB, 2)
            available_gb = [Math]::Round($freeMemory / 1GB, 2)
        }
    }
    disk = @{
        properties = @{
            usage = [Math]::Round($diskUsagePercent, 2)
            total_gb = [Math]::Round(($disk.Used + $disk.Free) / 1GB, 2)
            used_gb = [Math]::Round($disk.Used / 1GB, 2)
            free_gb = [Math]::Round($disk.Free / 1GB, 2)
        }
    }
} | ConvertTo-Json -Depth 10

# å‘é€åˆ° OpenTwins
$url = "http://localhost:8080/api/2/things/local:pc-monitor/features"
Invoke-RestMethod -Uri $url -Method PUT -Headers $headers -Body $updateBody

Write-Host "`nâœ… æ•°æ®å‘é€æˆåŠŸï¼" -ForegroundColor Green
```

### 3.3 æŸ¥çœ‹æ›´æ–°åçš„æ•°æ®

```powershell
# æŸ¥è¯¢ Thing éªŒè¯æ•°æ®
$auth = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes("ditto:ditto"))
$thing = Invoke-RestMethod -Uri "http://localhost:8080/api/2/things/local:pc-monitor" `
    -Method Get `
    -Headers @{"Authorization"="Basic $auth"}

Write-Host "`nå½“å‰ç›‘æ§æ•°æ®:" -ForegroundColor Green
Write-Host "  CPU: $($thing.features.cpu.properties.usage)%" -ForegroundColor Cyan
Write-Host "  å†…å­˜: $($thing.features.memory.properties.usage)%" -ForegroundColor Cyan
Write-Host "  ç£ç›˜: $($thing.features.disk.properties.usage)%" -ForegroundColor Cyan
```

## å››ã€æŒç»­ç›‘æ§ï¼ˆå¯é€‰ï¼‰

### 4.1 æ–¹æ³• 1ï¼šä½¿ç”¨ HTML ç®¡ç†å™¨æ‰‹åŠ¨æ›´æ–°

æ‰“å¼€é¡¹ç›®æ ¹ç›®å½•çš„ `opentwins-manager.html`ï¼š
1. Thing ID å¡«å†™ï¼š`local:pc-monitor`
2. ç‚¹å‡»"æŸ¥è¯¢ Thing"æŸ¥çœ‹å½“å‰æ•°æ®
3. CPU ä½¿ç”¨ç‡å¡«å†™æ–°å€¼ï¼ˆå¦‚ 45.5ï¼‰
4. ç‚¹å‡»"æ›´æ–° CPU"æŒ‰é’®

### 4.2 æ–¹æ³• 2ï¼šPowerShell å¾ªç¯è„šæœ¬

åˆ›å»ºæ–‡ä»¶ `monitor-loop.ps1`ï¼š

```powershell title="monitor-loop.ps1"
# OpenTwins PC ç›‘æ§ - æŒç»­é‡‡é›†è„šæœ¬
$THING_ID = "local:pc-monitor"
$INTERVAL = 10  # é‡‡é›†é—´éš”ï¼ˆç§’ï¼‰

$auth = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes("ditto:ditto"))
$headers = @{
    "Content-Type" = "application/json"
    "Authorization" = "Basic $auth"
}

Write-Host "å¼€å§‹ç›‘æ§... (æŒ‰ Ctrl+C åœæ­¢)" -ForegroundColor Green
Write-Host ""

while ($true) {
    try {
        # é‡‡é›†æ•°æ®
        $cpu = (Get-Counter '\Processor(_Total)\% Processor Time').CounterSamples.CookedValue
        $os = Get-CimInstance Win32_OperatingSystem
        $cs = Get-CimInstance Win32_ComputerSystem
        $totalMem = $cs.TotalPhysicalMemory
        $freeMem = $os.FreePhysicalMemory * 1KB
        $usedMem = $totalMem - $freeMem
        $memPct = ($usedMem / $totalMem) * 100
        $disk = Get-PSDrive C
        $diskPct = ($disk.Used / ($disk.Used + $disk.Free)) * 100
        
        # æ„å»ºæ•°æ®
        $body = @{
            cpu = @{
                properties = @{
                    usage = [Math]::Round($cpu, 2)
                    cores = [System.Environment]::ProcessorCount
                }
            }
            memory = @{
                properties = @{
                    usage = [Math]::Round($memPct, 2)
                    total_gb = [Math]::Round($totalMem / 1GB, 2)
                    used_gb = [Math]::Round($usedMem / 1GB, 2)
                }
            }
            disk = @{
                properties = @{
                    usage = [Math]::Round($diskPct, 2)
                    total_gb = [Math]::Round(($disk.Used + $disk.Free) / 1GB, 2)
                    used_gb = [Math]::Round($disk.Used / 1GB, 2)
                }
            }
        } | ConvertTo-Json -Depth 10
        
        # å‘é€æ•°æ®
        Invoke-RestMethod -Uri "http://localhost:8080/api/2/things/$THING_ID/features" `
            -Method PUT -Headers $headers -Body $body | Out-Null
        
        # æ˜¾ç¤ºçŠ¶æ€
        $time = Get-Date -Format "HH:mm:ss"
        $cpuStr = "{0,5:N1}%" -f [Math]::Round($cpu, 2)
        $memStr = "{0,5:N1}%" -f [Math]::Round($memPct, 2)
        $diskStr = "{0,5:N1}%" -f [Math]::Round($diskPct, 2)
        
        Write-Host "[$time] CPU: $cpuStr | Memory: $memStr | Disk: $diskStr" -ForegroundColor Cyan
        
        Start-Sleep -Seconds $INTERVAL
    }
    catch {
        Write-Host "[ERROR] $_" -ForegroundColor Red
        Start-Sleep -Seconds $INTERVAL
    }
}
```

### 4.3 è¿è¡Œç›‘æ§è„šæœ¬

```powershell
powershell -ExecutionPolicy Bypass -File .\monitor-loop.ps1
```

### 4.4 æ–¹æ³• 3ï¼šPython è„šæœ¬ï¼ˆå¯é€‰ï¼‰

å¦‚æœæ‚¨å·²å®‰è£… Pythonï¼Œå¯ä»¥ä½¿ç”¨åŸç‰ˆçš„ Python è„šæœ¬ï¼š

```python title="pc-monitor.py"
"""
OpenTwins ç”µè„‘æ€§èƒ½ç›‘æ§è„šæœ¬
å®æ—¶é‡‡é›† CPUã€å†…å­˜ã€ç£ç›˜ä½¿ç”¨æƒ…å†µå¹¶å‘é€åˆ°æ•°å­—å­ªç”Ÿå¹³å°
"""

import paho.mqtt.client as mqtt
import psutil
import json
import time
import platform
from datetime import datetime

# ==================== é…ç½® ====================
MQTT_BROKER = "localhost"
MQTT_PORT = 1883
THING_ID = "local:pc-monitor"
COLLECT_INTERVAL = 5  # é‡‡é›†é—´éš”ï¼ˆç§’ï¼‰

# ==================== MQTT å›è°ƒå‡½æ•° ====================
def on_connect(client, userdata, flags, rc):
    """MQTT è¿æ¥å›è°ƒ"""
    if rc == 0:
        print("âœ… å·²è¿æ¥åˆ° MQTT Broker")
    else:
        print(f"âŒ è¿æ¥å¤±è´¥ï¼Œè¿”å›ç : {rc}")

def on_publish(client, userdata, mid):
    """æ¶ˆæ¯å‘å¸ƒå›è°ƒ"""
    pass  # å¯ä»¥æ·»åŠ æ—¥å¿—è®°å½•

# ==================== æ•°æ®é‡‡é›†å‡½æ•° ====================
def get_cpu_usage():
    """è·å– CPU ä½¿ç”¨æƒ…å†µ"""
    cpu_percent = psutil.cpu_percent(interval=1)
    cpu_freq = psutil.cpu_freq()
    
    return {
        "usage": round(cpu_percent, 2),
        "cores": psutil.cpu_count(logical=False),
        "threads": psutil.cpu_count(logical=True),
        "frequency": round(cpu_freq.current, 2) if cpu_freq else 0
    }

def get_memory_usage():
    """è·å–å†…å­˜ä½¿ç”¨æƒ…å†µ"""
    mem = psutil.virtual_memory()
    
    return {
        "total": mem.total,
        "available": mem.available,
        "used": mem.used,
        "usage": round(mem.percent, 2),
        "total_gb": round(mem.total / (1024**3), 2),
        "used_gb": round(mem.used / (1024**3), 2),
        "available_gb": round(mem.available / (1024**3), 2)
    }

def get_disk_usage():
    """è·å– C ç›˜ä½¿ç”¨æƒ…å†µ"""
    disk = psutil.disk_usage('C:\\')
    
    return {
        "total": disk.total,
        "free": disk.free,
        "used": disk.used,
        "usage": round(disk.percent, 2),
        "total_gb": round(disk.total / (1024**3), 2),
        "free_gb": round(disk.free / (1024**3), 2),
        "used_gb": round(disk.used / (1024**3), 2)
    }

def send_metrics(client):
    """é‡‡é›†å¹¶å‘é€æ‰€æœ‰æŒ‡æ ‡"""
    try:
        # é‡‡é›†æ•°æ®
        cpu_data = get_cpu_usage()
        memory_data = get_memory_usage()
        disk_data = get_disk_usage()
        
        # æ„å»º Ditto æ¶ˆæ¯æ ¼å¼
        payload = {
            "topic": f"{THING_ID}/things/twin/commands/modify",
            "headers": {
                "response-required": False
            },
            "path": "/features",
            "value": {
                "cpu": {
                    "properties": cpu_data
                },
                "memory": {
                    "properties": memory_data
                },
                "disk": {
                    "properties": disk_data
                }
            }
        }
        
        # å‘å¸ƒåˆ° MQTT
        topic = f"{THING_ID}/things/twin/commands/modify"
        message = json.dumps(payload)
        result = client.publish(topic, message, qos=0)
        
        # æ‰“å°çŠ¶æ€
        timestamp = datetime.now().strftime("%H:%M:%S")
        print(f"[{timestamp}] "
              f"CPU: {cpu_data['usage']:5.1f}% | "
              f"å†…å­˜: {memory_data['usage']:5.1f}% ({memory_data['used_gb']:.1f}GB/{memory_data['total_gb']:.1f}GB) | "
              f"ç£ç›˜: {disk_data['usage']:5.1f}% ({disk_data['used_gb']:.0f}GB/{disk_data['total_gb']:.0f}GB)")
        
        return True
        
    except Exception as e:
        print(f"âŒ å‘é€æ•°æ®å¤±è´¥: {e}")
        return False

# ==================== ä¸»ç¨‹åº ====================
def main():
    """ä¸»å‡½æ•°"""
    # åˆ›å»º MQTT å®¢æˆ·ç«¯
    client = mqtt.Client(client_id=f"pc-monitor-{platform.node()}")
    client.on_connect = on_connect
    client.on_publish = on_publish
    
    # è¿æ¥åˆ° MQTT Broker
    try:
        client.connect(MQTT_BROKER, MQTT_PORT, 60)
        client.loop_start()
        time.sleep(2)  # ç­‰å¾…è¿æ¥å»ºç«‹
    except Exception as e:
        print(f"âŒ æ— æ³•è¿æ¥åˆ° MQTT Broker: {e}")
        print("\nè¯·ç¡®è®¤:")
        print("1. OpenTwins æ­£åœ¨è¿è¡Œ")
        print("2. ç«¯å£è½¬å‘å·²å¯åŠ¨: kubectl port-forward svc/opentwins-mosquitto 1883:1883")
        return
    
    # æ˜¾ç¤ºå¯åŠ¨ä¿¡æ¯
    print("\n" + "=" * 70)
    print("ğŸ–¥ï¸  OpenTwins ç”µè„‘æ€§èƒ½ç›‘æ§ç³»ç»Ÿ")
    print("=" * 70)
    print(f"ğŸ“Œ ç”µè„‘åç§°: {platform.node()}")
    print(f"ğŸ’» æ“ä½œç³»ç»Ÿ: {platform.system()} {platform.release()}")
    print(f"ğŸ”— Thing ID: {THING_ID}")
    print(f"â° é‡‡é›†é—´éš”: {COLLECT_INTERVAL} ç§’")
    print(f"ğŸ“Š Grafana: http://localhost:3002")
    print("=" * 70)
    print("\nå¼€å§‹é‡‡é›†æ•°æ®... (æŒ‰ Ctrl+C åœæ­¢)\n")
    
    # ä¸»å¾ªç¯
    try:
        while True:
            send_metrics(client)
            time.sleep(COLLECT_INTERVAL)
            
    except KeyboardInterrupt:
        print("\n\nâ¹ï¸  åœæ­¢ç›‘æ§")
        client.loop_stop()
        client.disconnect()
        print("âœ… å·²æ–­å¼€è¿æ¥")

if __name__ == "__main__":
    main()
```

è¿è¡Œ Python è„šæœ¬ï¼š

```powershell
pip install paho-mqtt psutil
python pc-monitor.py
```

**é¢„æœŸè¾“å‡º**:
```
âœ… å·²è¿æ¥åˆ° MQTT Broker

======================================================================
ğŸ–¥ï¸  OpenTwins ç”µè„‘æ€§èƒ½ç›‘æ§ç³»ç»Ÿ
======================================================================
ğŸ“Œ ç”µè„‘åç§°: YOUR-PC-NAME
ğŸ’» æ“ä½œç³»ç»Ÿ: Windows 10
ğŸ”— Thing ID: local:pc-monitor
â° é‡‡é›†é—´éš”: 5 ç§’
ğŸ“Š Grafana: http://localhost:3002
======================================================================

å¼€å§‹é‡‡é›†æ•°æ®... (æŒ‰ Ctrl+C åœæ­¢)

[14:30:15] CPU:  25.3% | å†…å­˜:  45.2% (7.2GB/16.0GB) | ç£ç›˜:  68.5% (342GB/500GB)
[14:30:20] CPU:  18.7% | å†…å­˜:  45.3% (7.2GB/16.0GB) | ç£ç›˜:  68.5% (342GB/500GB)
[14:30:25] CPU:  32.1% | å†…å­˜:  45.1% (7.2GB/16.0GB) | ç£ç›˜:  68.5% (342GB/500GB)
```

**éªŒè¯æ•°æ®æ›´æ–°**ï¼š

åœ¨å¦ä¸€ä¸ª PowerShell çª—å£ä¸­ï¼š

```powershell
# æŸ¥è¯¢æ•°å­—å­ªç”Ÿçš„å®æ—¶æ•°æ®
$auth = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes("ditto:ditto"))
Invoke-RestMethod -Uri "http://localhost:8080/api/2/things/local:pc-monitor" `
    -Method Get `
    -Headers @{"Authorization"="Basic $auth"} | ConvertTo-Json -Depth 10
```

åº”è¯¥èƒ½çœ‹åˆ° `features` ä¸­çš„æ•°æ®åœ¨å®æ—¶æ›´æ–°ï¼

## äº”ã€åˆ›å»º Grafana å¯è§†åŒ–å¤§å±

### 5.1 ç™»å½• Grafana

1. è®¿é—® http://localhost:3002
2. ç™»å½•ï¼ˆadmin/adminï¼‰

### 5.2 éªŒè¯æ•°æ®æº

1. ç‚¹å‡»å·¦ä¾§èœå• âš™ï¸ **Configuration** â†’ **Data Sources**
2. åº”è¯¥èƒ½çœ‹åˆ° `InfluxDB` æ•°æ®æºï¼ˆç»¿è‰²âœ…è¡¨ç¤ºæ­£å¸¸ï¼‰

### 5.3 åˆ›å»ºæ–°ä»ªè¡¨æ¿

1. ç‚¹å‡»å·¦ä¾§ **+** â†’ **Dashboard**
2. ç‚¹å‡» **Add a new panel**

### 5.4 åˆ›å»º CPU ä½¿ç”¨ç‡é¢æ¿

:::warning é‡è¦æ­¥éª¤
å¦‚æœé¢æ¿æ˜¾ç¤º **"No data"**ï¼Œè¯·ç¡®ä¿ï¼š
1. âœ… ç›‘æ§è„šæœ¬ `monitor-loop.ps1` æ­£åœ¨è¿è¡Œ
2. âœ… è‡³å°‘è¿è¡Œ 5-10 åˆ†é’Ÿä»¥ç§¯ç´¯æ•°æ®
3. âœ… æ—¶é—´èŒƒå›´è®¾ç½®ä¸º "Last 15 minutes"
4. âœ… æŸ¥è¯¢è¯­å¥å®Œå…¨æ­£ç¡®ï¼ˆå¤åˆ¶ç²˜è´´ä¸‹é¢çš„æŸ¥è¯¢ï¼‰
:::

#### æ­¥éª¤ 1ï¼šé€‰æ‹©æ•°æ®æº

åœ¨ Query é…ç½®åŒºåŸŸï¼š
1. **Data source**: ä¸‹æ‹‰é€‰æ‹© `InfluxDB` (opentwins)
2. **Language**: ç¡®ä¿é€‰æ‹© `Flux` (ä¸æ˜¯ InfluxQL)

#### æ­¥éª¤ 2ï¼šè¾“å…¥æŸ¥è¯¢è¯­å¥

ç‚¹å‡»æŸ¥è¯¢ç¼–è¾‘å™¨åº•éƒ¨çš„ **Flux language syntax** æ ‡ç­¾ï¼Œåœ¨æ–‡æœ¬æ¡†ä¸­è¾“å…¥ï¼š

```flux
from(bucket: "ditto")
  |> range(start: -1h)
  |> filter(fn: (r) => r["_measurement"] == "local:pc-monitor")
  |> filter(fn: (r) => r["_field"] == "features.cpu.properties.usage")
  |> aggregateWindow(every: 10s, fn: mean, createEmpty: false)
  |> yield(name: "mean")
```

**æŸ¥è¯¢è¯´æ˜**ï¼š
- `bucket: "ditto"` - InfluxDB æ•°æ®æ¡¶åç§°
- `_measurement == "local:pc-monitor"` - Thing IDï¼ˆå¿…é¡»åŒ¹é…ï¼‰
- `_field == "features.cpu.properties.usage"` - CPU ä½¿ç”¨ç‡å­—æ®µè·¯å¾„
- `range(start: -1h)` - æŸ¥è¯¢æœ€è¿‘ 1 å°æ—¶çš„æ•°æ®
- `aggregateWindow(every: 10s)` - æ¯ 10 ç§’èšåˆä¸€æ¬¡æ•°æ®

#### æ­¥éª¤ 3ï¼šæµ‹è¯•æŸ¥è¯¢

ç‚¹å‡»å³ä¸Šè§’çš„ **Run Query** æŒ‰é’®ï¼ˆæˆ–æŒ‰ `Shift+Enter`ï¼‰ï¼Œåº”è¯¥çœ‹åˆ°ï¼š
- âœ… æ•°æ®æ›²çº¿æ˜¾ç¤ºåœ¨é¢„è§ˆåŒºåŸŸ
- âŒ å¦‚æœæ˜¾ç¤º "No data"ï¼Œæ£€æŸ¥ä¸Šæ–¹çš„è­¦å‘Šæç¤º

#### æ­¥éª¤ 4ï¼šé…ç½®é¢æ¿æ ·å¼

åœ¨å³ä¾§é¢æ¿é…ç½®åŒºåŸŸï¼š

**Panel options**:
- **Panel title**: `CPU ä½¿ç”¨ç‡`
- **Description**: `å®æ—¶ç›‘æ§ CPU ä½¿ç”¨ç™¾åˆ†æ¯”`

**Visualization**:
- ç‚¹å‡»å³ä¸Šè§’å¯è§†åŒ–ç±»å‹ï¼Œé€‰æ‹© `Gauge` (ä»ªè¡¨ç›˜)

**Standard options**:
- **Unit**: æœç´¢å¹¶é€‰æ‹© `Percent (0-100)`
- **Min**: `0`
- **Max**: `100`

**Thresholds**:
- ç‚¹å‡» **+ Add threshold**
- è®¾ç½®é˜ˆå€¼ï¼š
  - ğŸŸ¢ Base (0): Green
  - ğŸŸ¡ 60: Yellow
  - ğŸ”´ 80: Red

#### æ­¥éª¤ 5ï¼šä¿å­˜é¢æ¿

ç‚¹å‡»å³ä¸Šè§’ **Apply** ä¿å­˜é¢æ¿ã€‚

### 5.5 åˆ›å»ºå†…å­˜ä½¿ç”¨ç‡é¢æ¿

1. ç‚¹å‡» **Add panel** â†’ **Add a new panel**

**æŸ¥è¯¢è¯­å¥**ï¼š
```flux
from(bucket: "ditto")
  |> range(start: -1h)
  |> filter(fn: (r) => r["_measurement"] == "local:pc-monitor")
  |> filter(fn: (r) => r["_field"] == "features.memory.properties.usage")
  |> aggregateWindow(every: 10s, fn: mean, createEmpty: false)
  |> yield(name: "mean")
```

#### é…ç½®é¢æ¿

- **Panel title**: `å†…å­˜ä½¿ç”¨ç‡`
- **Visualization**: `Gauge`
- **Unit**: `Percent (0-100)`
- **Thresholds**: 0-70 (ç»¿), 70-85 (é»„), 85-100 (çº¢)

### 5.6 åˆ›å»ºç£ç›˜ä½¿ç”¨ç‡é¢æ¿

**æŸ¥è¯¢è¯­å¥**ï¼š
```flux
from(bucket: "ditto")
  |> range(start: -1h)
  |> filter(fn: (r) => r["_measurement"] == "local:pc-monitor")
  |> filter(fn: (r) => r["_field"] == "features.disk.properties.usage")
  |> aggregateWindow(every: 10s, fn: mean, createEmpty: false)
  |> yield(name: "mean")
```

#### é…ç½®é¢æ¿

- **Panel title**: `ç£ç›˜ä½¿ç”¨ç‡`
- **Visualization**: `Gauge`
- **Unit**: `Percent (0-100)`

### 5.7 åˆ›å»ºè¶‹åŠ¿å›¾é¢æ¿

#### CPU è¶‹åŠ¿å›¾

**æŸ¥è¯¢è¯­å¥**ï¼š
```flux
from(bucket: "ditto")
  |> range(start: -30m)
  |> filter(fn: (r) => r["_measurement"] == "local:pc-monitor")
  |> filter(fn: (r) => r["_field"] == "features.cpu.properties.usage")
  |> aggregateWindow(every: 10s, fn: mean, createEmpty: false)
```

#### é…ç½®é¢æ¿

- **Panel title**: `CPU ä½¿ç”¨ç‡è¶‹åŠ¿ï¼ˆ30åˆ†é’Ÿï¼‰`
- **Visualization**: `Time series` (æ—¶é—´åºåˆ—å›¾)
- **Unit**: `Percent (0-100)`
- **Graph style**: `Lines`
- **Fill opacity**: `20`
- **Line width**: `2`

### 5.8 åˆ›å»ºç»Ÿè®¡å¡ç‰‡

#### å½“å‰ CPU ä½¿ç”¨ç‡å¡ç‰‡

**æŸ¥è¯¢è¯­å¥**ï¼š
```flux
from(bucket: "ditto")
  |> range(start: -1m)
  |> filter(fn: (r) => r["_measurement"] == "local:pc-monitor")
  |> filter(fn: (r) => r["_field"] == "features.cpu.properties.usage")
  |> last()
```

#### é…ç½®é¢æ¿

- **Panel title**: `å½“å‰ CPU`
- **Visualization**: `Stat`
- **Value**: `Last` (æœ€æ–°å€¼)
- **Unit**: `Percent (0-100)`
- **Text size**: `Title` è®¾ç½®ä¸ºå¤§å­—ä½“

### 5.9 æ¨èçš„å¤§å±å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”µè„‘æ€§èƒ½ç›‘æ§å¤§å± ğŸ–¥ï¸                                    â”‚
â”‚  YOUR-PC-NAME                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ CPU       â”‚ å†…å­˜      â”‚ ç£ç›˜      â”‚  ç³»ç»Ÿä¿¡æ¯           â”‚
â”‚ 32.5%     â”‚ 45.2%     â”‚ 68.5%     â”‚  æ ¸å¿ƒ: 8            â”‚
â”‚ (Gauge)   â”‚ (Gauge)   â”‚ (Gauge)   â”‚  å†…å­˜: 16GB         â”‚
â”‚           â”‚           â”‚           â”‚  ç£ç›˜: 500GB        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  CPU ä½¿ç”¨ç‡è¶‹åŠ¿ï¼ˆ30åˆ†é’Ÿï¼‰                               â”‚
â”‚  [æŠ˜çº¿å›¾æ˜¾ç¤º CPU æ³¢åŠ¨]                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å†…å­˜ä½¿ç”¨ç‡è¶‹åŠ¿ï¼ˆ30åˆ†é’Ÿï¼‰                               â”‚
â”‚  [æŠ˜çº¿å›¾æ˜¾ç¤ºå†…å­˜ä½¿ç”¨]                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç£ç›˜ä½¿ç”¨ç‡è¶‹åŠ¿ï¼ˆ30åˆ†é’Ÿï¼‰                               â”‚
â”‚  [æŠ˜çº¿å›¾æ˜¾ç¤ºç£ç›˜å˜åŒ–]                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.10 ä¿å­˜ä»ªè¡¨æ¿

1. ç‚¹å‡»å³ä¸Šè§’ ğŸ’¾ **Save dashboard**
2. **Dashboard name**: `ç”µè„‘æ€§èƒ½ç›‘æ§å¤§å±`
3. **Folder**: `General` æˆ–åˆ›å»ºæ–°æ–‡ä»¶å¤¹
4. ç‚¹å‡» **Save**

### 5.11 è®¾ç½®è‡ªåŠ¨åˆ·æ–°

1. ç‚¹å‡»å³ä¸Šè§’çš„æ—¶é—´èŒƒå›´é€‰æ‹©å™¨æ—è¾¹çš„åˆ·æ–°å›¾æ ‡
2. é€‰æ‹© **5s** (æ¯ 5 ç§’è‡ªåŠ¨åˆ·æ–°)
3. æˆ–é€‰æ‹© **10s** / **30s** æ ¹æ®éœ€è¦

### 5.12 å…¨å±æ˜¾ç¤º

1. ç‚¹å‡»å³ä¸Šè§’çš„ **Cycle view mode** å›¾æ ‡ï¼ˆå…¨å±æŒ‰é’®ï¼‰
2. æˆ–æŒ‰é”®ç›˜ `F` é”®è¿›å…¥å…¨å±æ¨¡å¼
3. æŒ‰ `Esc` é€€å‡ºå…¨å±

## å…­ã€é«˜çº§åŠŸèƒ½

### 6.1 æ·»åŠ å‘Šè­¦

#### åˆ›å»º CPU é«˜ä½¿ç”¨ç‡å‘Šè­¦

1. ç¼–è¾‘ CPU ä½¿ç”¨ç‡é¢æ¿
2. ç‚¹å‡» **Alert** æ ‡ç­¾
3. ç‚¹å‡» **Create alert rule from this panel**
4. é…ç½®æ¡ä»¶ï¼š
   ```
   WHEN avg() OF query(A, 5m, now) IS ABOVE 80
   ```
5. é…ç½®é€šçŸ¥æ¸ é“ï¼ˆé‚®ä»¶ã€Webhook ç­‰ï¼‰

### 6.2 ç›‘æ§å¤šå°ç”µè„‘

#### ä¿®æ”¹è„šæœ¬æ”¯æŒå¤šå°ç”µè„‘

åœ¨ `pc-monitor.py` ä¸­ä¿®æ”¹ï¼š

```python
# ä½¿ç”¨ç”µè„‘åç§°ä½œä¸º Thing ID
import socket
THING_ID = f"local:pc-{socket.gethostname().lower()}"
```

#### åœ¨ Grafana ä¸­æ·»åŠ å˜é‡

1. Dashboard Settings â†’ **Variables** â†’ **Add variable**
2. **Name**: `hostname`
3. **Type**: `Query`
4. **Query**:
   ```flux
   import "influxdata/influxdb/schema"
   schema.measurementTagValues(
     bucket: "ditto",
     measurement: "local:pc-*",
     tag: "_measurement"
   )
   ```

5. åœ¨æŸ¥è¯¢ä¸­ä½¿ç”¨å˜é‡ï¼š
   ```flux
   filter(fn: (r) => r["_measurement"] == "${hostname}")
   ```

### 6.3 æ·»åŠ ç½‘ç»œç›‘æ§

åœ¨ `pc-monitor.py` ä¸­æ·»åŠ ï¼š

```python
def get_network_usage():
    """è·å–ç½‘ç»œä½¿ç”¨æƒ…å†µ"""
    net_io = psutil.net_io_counters()
    return {
        "bytes_sent": net_io.bytes_sent,
        "bytes_recv": net_io.bytes_recv,
        "packets_sent": net_io.packets_sent,
        "packets_recv": net_io.packets_recv,
        "bytes_sent_mb": round(net_io.bytes_sent / (1024**2), 2),
        "bytes_recv_mb": round(net_io.bytes_recv / (1024**2), 2)
    }

# åœ¨ send_metrics ä¸­æ·»åŠ 
network_data = get_network_usage()
payload["value"]["network"] = {
    "properties": network_data
}
```

### 6.4 æ·»åŠ è¿›ç¨‹ç›‘æ§

```python
def get_top_processes(limit=5):
    """è·å– CPU å ç”¨æœ€é«˜çš„å‰ N ä¸ªè¿›ç¨‹"""
    processes = []
    for proc in psutil.process_iter(['pid', 'name', 'cpu_percent']):
        try:
            processes.append({
                'pid': proc.info['pid'],
                'name': proc.info['name'],
                'cpu': proc.info['cpu_percent']
            })
        except:
            pass
    
    # æŒ‰ CPU ä½¿ç”¨ç‡æ’åº
    processes.sort(key=lambda x: x['cpu'], reverse=True)
    return processes[:limit]
```

### 6.5 åå°è¿è¡Œè„šæœ¬

#### æ–¹æ³• 1ï¼šä½¿ç”¨ Windows ä»»åŠ¡è®¡åˆ’ç¨‹åº

1. æ‰“å¼€ **ä»»åŠ¡è®¡åˆ’ç¨‹åº**
2. åˆ›å»ºåŸºæœ¬ä»»åŠ¡
3. åç§°: `PC Monitor`
4. è§¦å‘å™¨: **è®¡ç®—æœºå¯åŠ¨æ—¶**
5. æ“ä½œ: **å¯åŠ¨ç¨‹åº**
   - ç¨‹åº: `python.exe`
   - å‚æ•°: `D:\path\to\pc-monitor.py`
   - èµ·å§‹äº: `D:\path\to\`

#### æ–¹æ³• 2ï¼šåˆ›å»ºæ‰¹å¤„ç†æ–‡ä»¶

åˆ›å»º `start-monitor.bat`ï¼š

```batch
@echo off
cd /d "%~dp0"
python pc-monitor.py
pause
```

åŒå‡»è¿è¡Œå³å¯ã€‚

#### æ–¹æ³• 3ï¼šä½¿ç”¨ pythonwï¼ˆæ— çª—å£è¿è¡Œï¼‰

```powershell
pythonw pc-monitor.py
```

## ä¸ƒã€æ•…éšœæ’æŸ¥

### 7.1 å¸¸è§é—®é¢˜

#### é—®é¢˜ 1ï¼šè„šæœ¬æ— æ³•è¿æ¥ MQTT

**ç—‡çŠ¶**ï¼š
```
âŒ æ— æ³•è¿æ¥åˆ° MQTT Broker: [Errno 10061] ç”±äºç›®æ ‡è®¡ç®—æœºç§¯ææ‹’ç»ï¼Œæ— æ³•è¿æ¥ã€‚
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```powershell
# 1. ç¡®è®¤ç«¯å£è½¬å‘æ­£åœ¨è¿è¡Œ
Test-NetConnection -ComputerName localhost -Port 1883

# 2. å¦‚æœå¤±è´¥ï¼Œé‡æ–°å¯åŠ¨ç«¯å£è½¬å‘
kubectl port-forward svc/opentwins-mosquitto 1883:1883
```

#### é—®é¢˜ 2ï¼šGrafana ä¸­æ²¡æœ‰æ•°æ®

**æ£€æŸ¥æ¸…å•**ï¼š

1. **ç¡®è®¤è„šæœ¬æ­£åœ¨è¿è¡Œ**
   ```powershell
   # åº”è¯¥çœ‹åˆ°æŒç»­çš„æ•°æ®è¾“å‡º
   ```

2. **éªŒè¯ Ditto æ”¶åˆ°æ•°æ®**
   ```powershell
   Invoke-RestMethod -Uri "http://localhost:8080/api/2/things/local:pc-monitor" -Method Get
   ```

3. **æ£€æŸ¥ InfluxDB**
   - è®¿é—® http://localhost:8086
   - ç™»å½•åæŸ¥çœ‹ `ditto` bucket
   - Data Explorer â†’ é€‰æ‹© `local:pc-monitor`

4. **æ£€æŸ¥ Grafana æŸ¥è¯¢è¯­å¥**
   - measurement åç§°æ˜¯å¦æ­£ç¡®ï¼š`local:pc-monitor`
   - field åç§°æ ¼å¼ï¼š`features.cpu.properties.usage`

#### é—®é¢˜ 3ï¼šæ•°æ®ä¸æ›´æ–°

**å¯èƒ½åŸå› **ï¼š

1. **Thing ID ä¸åŒ¹é…**
   ```python
   # æ£€æŸ¥è„šæœ¬ä¸­çš„ THING_ID
   THING_ID = "local:pc-monitor"  # å¿…é¡»ä¸ Grafana æŸ¥è¯¢ä¸­çš„ä¸€è‡´
   ```

2. **æ—¶é—´èŒƒå›´å¤ªçŸ­**
   - åœ¨ Grafana å³ä¸Šè§’è°ƒæ•´æ—¶é—´èŒƒå›´ä¸º `Last 5 minutes`

3. **èšåˆçª—å£å¤ªå¤§**
   ```flux
   # å‡å°èšåˆçª—å£
   |> aggregateWindow(every: 5s, fn: mean, createEmpty: false)
   ```

#### é—®é¢˜ 4ï¼šPython æ¨¡å—æœªå®‰è£…

```powershell
# é‡æ–°å®‰è£…
pip install paho-mqtt psutil --upgrade

# æˆ–ä½¿ç”¨å›½å†…é•œåƒ
pip install paho-mqtt psutil -i https://pypi.tuna.tsinghua.edu.cn/simple
```

### 7.2 è°ƒè¯•æŠ€å·§

#### å¯ç”¨è¯¦ç»†æ—¥å¿—

åœ¨ `pc-monitor.py` ä¸­æ·»åŠ ï¼š

```python
import logging
logging.basicConfig(level=logging.DEBUG)
```

#### æŸ¥çœ‹ MQTT æ¶ˆæ¯

ä½¿ç”¨ MQTT Explorer è¿æ¥åˆ° `localhost:1883`ï¼Œè®¢é˜…ä¸»é¢˜ï¼š
```
local:pc-monitor/#
```

#### æ‰‹åŠ¨æµ‹è¯• Ditto API

```powershell
# æ‰‹åŠ¨æ›´æ–° CPU æ•°æ®
$body = @{
    "usage" = 50.0
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://localhost:8080/api/2/things/local:pc-monitor/features/cpu/properties" `
    -Method PUT `
    -Headers @{"Content-Type"="application/json"} `
    -Body $body
```

## å…«ã€æ€§èƒ½ä¼˜åŒ–

### 8.1 è°ƒæ•´é‡‡é›†é¢‘ç‡

```python
# åœ¨ pc-monitor.py ä¸­
COLLECT_INTERVAL = 10  # ä» 5 ç§’æ”¹ä¸º 10 ç§’ï¼Œå‡å°‘æ•°æ®é‡
```

### 8.2 æ•°æ®ä¿ç•™ç­–ç•¥

åœ¨ InfluxDB ä¸­è®¾ç½®æ•°æ®ä¿ç•™æ—¶é—´ï¼š

1. è®¿é—® http://localhost:8086
2. **Data** â†’ **Buckets** â†’ `ditto`
3. è®¾ç½®ä¿ç•™æ—¶é—´ï¼ˆå¦‚ 7 å¤©ã€30 å¤©ï¼‰

### 8.3 ä¼˜åŒ– Grafana æŸ¥è¯¢

```flux
# ä½¿ç”¨æ›´å¤§çš„èšåˆçª—å£å‡å°‘æ•°æ®ç‚¹
from(bucket: "ditto")
  |> range(start: -1h)
  |> filter(fn: (r) => r["_measurement"] == "local:pc-monitor")
  |> filter(fn: (r) => r["_field"] == "features.cpu.properties.usage")
  |> aggregateWindow(every: 30s, fn: mean, createEmpty: false)  # 30ç§’èšåˆ
```

## ä¹ã€æ‰©å±•æ–¹æ¡ˆ

### 9.1 ç›‘æ§æœåŠ¡å™¨é›†ç¾¤

- åœ¨æ¯å°æœåŠ¡å™¨ä¸Šè¿è¡Œç›‘æ§è„šæœ¬
- ä½¿ç”¨ä¸åŒçš„ Thing ID
- åœ¨ Grafana ä¸­åˆ›å»ºå¤šæœåŠ¡å™¨æ¦‚è§ˆä»ªè¡¨æ¿

### 9.2 ç§»åŠ¨ç«¯è®¿é—®

- é…ç½® Grafana çš„ç§»åŠ¨ç«¯æ˜¾ç¤º
- ä½¿ç”¨ Grafana Cloud å®ç°è¿œç¨‹è®¿é—®

### 9.3 é›†æˆå‘Šè­¦ç³»ç»Ÿ

- é‚®ä»¶å‘Šè­¦
- ä¼ä¸šå¾®ä¿¡/é’‰é’‰å‘Šè­¦
- Webhook é›†æˆå…¶ä»–ç³»ç»Ÿ

### 9.4 æ•°æ®åˆ†æ

- å¯¼å‡ºå†å²æ•°æ®åˆ° Excel
- ä½¿ç”¨ Python/Jupyter è¿›è¡Œæ•°æ®åˆ†æ
- é¢„æµ‹èµ„æºä½¿ç”¨è¶‹åŠ¿

## åã€æ€»ç»“

### 10.1 å­¦åˆ°çš„çŸ¥è¯†

- âœ… å¦‚ä½•ä½¿ç”¨ Ditto API åˆ›å»ºæ•°å­—å­ªç”Ÿ
- âœ… å¦‚ä½•é€šè¿‡ MQTT å‘é€æ•°æ®åˆ° OpenTwins
- âœ… å¦‚ä½•åœ¨ Grafana ä¸­åˆ›å»ºå¯è§†åŒ–å¤§å±
- âœ… å¦‚ä½•ç¼–å†™ Flux æŸ¥è¯¢è¯­å¥
- âœ… å¦‚ä½•ä½¿ç”¨ Python é‡‡é›†ç³»ç»Ÿæ€§èƒ½æ•°æ®

### 10.2 å®Œæ•´ä»£ç 

æ‰€æœ‰ç¤ºä¾‹ä»£ç å·²åŒ…å«åœ¨æ•™ç¨‹ä¸­ï¼Œå®Œæ•´çš„é¡¹ç›®ç»“æ„ï¼š

```
pc-monitor/
â”œâ”€â”€ pc-monitor.py          # ä¸»ç›‘æ§è„šæœ¬
â”œâ”€â”€ requirements.txt       # Python ä¾èµ–
â”œâ”€â”€ start-monitor.bat      # Windows å¯åŠ¨è„šæœ¬
â””â”€â”€ README.md             # è¯´æ˜æ–‡æ¡£
```

### 10.3 ä¸‹ä¸€æ­¥

1. å°è¯•æ·»åŠ æ›´å¤šç›‘æ§æŒ‡æ ‡ï¼ˆç½‘ç»œã€GPUã€æ¸©åº¦ï¼‰
2. åˆ›å»ºæ›´å¤æ‚çš„ Grafana ä»ªè¡¨æ¿
3. é…ç½®å‘Šè­¦è§„åˆ™
4. ç›‘æ§å¤šå°ç”µè„‘
5. æ¢ç´¢ OpenTwins çš„å…¶ä»–åŠŸèƒ½

## åä¸€ã€å‚è€ƒèµ„æº

- [OpenTwins å®˜æ–¹æ–‡æ¡£](https://ertis-research.github.io/opentwins/)
- [Eclipse Ditto API æ–‡æ¡£](https://www.eclipse.org/ditto/httpapi-overview.html)
- [Grafana æ–‡æ¡£](https://grafana.com/docs/)
- [InfluxDB Flux æŸ¥è¯¢è¯­è¨€](https://docs.influxdata.com/influxdb/v2.0/query-data/get-started/)
- [Python psutil æ–‡æ¡£](https://psutil.readthedocs.io/)

---

**æ•™ç¨‹ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025-01-19  
**éš¾åº¦**: â­â­â­ ä¸­çº§

**å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒ [OpenTwins éƒ¨ç½²æ–‡æ¡£](./opentwins-windows-deployment.mdx) çš„æ•…éšœæ’æŸ¥éƒ¨åˆ†ã€‚**

