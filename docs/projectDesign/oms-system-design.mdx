---
sidebar_position: 4
title: OMS è®¢å•ç®¡ç†ç³»ç»Ÿè®¾è®¡
description: åŸºäº Spring Cloud çš„é«˜å¹¶å‘è®¢å•ç®¡ç†ç³»ç»Ÿå®Œæ•´è®¾è®¡æ–¹æ¡ˆ
tags: [OMS, è®¢å•ç®¡ç†, Spring Cloud, å¾®æœåŠ¡, é«˜å¹¶å‘, ç³»ç»Ÿè®¾è®¡]
---

# OMS è®¢å•ç®¡ç†ç³»ç»Ÿè®¾è®¡

## ä¸€ã€ç³»ç»Ÿæ¦‚è¿°

### 1.1 ç³»ç»Ÿç®€ä»‹

OMSï¼ˆOrder Management Systemï¼‰è®¢å•ç®¡ç†ç³»ç»Ÿæ˜¯ä¸€ä¸ªä¸“æ³¨äºè®¢å•å…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†çš„ç³»ç»Ÿï¼Œæ¶µç›–è®¢å•æ¥æ”¶ã€è®¢å•å¤„ç†ã€åº“å­˜åˆ†é…ã€è®¢å•å±¥çº¦ã€å”®åæœåŠ¡ç­‰æ ¸å¿ƒç¯èŠ‚ï¼Œæ”¯æŒå¤šæ¸ é“ã€å¤šä»“åº“ã€å¤šå•†å®¶çš„å¤æ‚ä¸šåŠ¡åœºæ™¯ã€‚

### 1.2 æ ¸å¿ƒä»·å€¼

| ä»·å€¼ç‚¹ | è¯´æ˜ | é¢„æœŸæ•ˆæœ |
|--------|------|----------|
| âš¡ **é«˜å¹¶å‘å¤„ç†** | æ”¯æŒç§’æ€å¤§ä¿ƒåœºæ™¯ | å³°å€¼ 10000+ TPS |
| ğŸ¯ **æ™ºèƒ½åˆ†å•** | æ™ºèƒ½è®¢å•åˆ†é…ç­–ç•¥ | å±¥çº¦æ•ˆç‡æå‡ 45% |
| ğŸ”„ **å…¨é“¾è·¯è¿½è¸ª** | è®¢å•çŠ¶æ€å®æ—¶åŒæ­¥ | å®¢æˆ·æ»¡æ„åº¦æå‡ 40% |
| ğŸ“Š **æ•°æ®ä¸€è‡´æ€§** | å¼ºä¸€è‡´æ€§ä¿è¯ | æ•°æ®å‡†ç¡®ç‡ 99.99% |
| ğŸš€ **å¿«é€Ÿå“åº”** | æ¯«ç§’çº§è®¢å•å¤„ç† | å“åº”æ—¶é—´ < 100ms |

### 1.3 ä¸šåŠ¡éœ€æ±‚

#### æ ¸å¿ƒåŠŸèƒ½
- **è®¢å•æ¥æ”¶**ï¼šå¤šæ¸ é“è®¢å•æ¥å…¥ã€è®¢å•éªŒè¯ã€è®¢å•æ‹†åˆ†åˆå¹¶
- **è®¢å•å¤„ç†**ï¼šè®¢å•å®¡æ ¸ã€é£æ§æ£€æŸ¥ã€æ”¯ä»˜ç¡®è®¤ã€åº“å­˜é”å®š
- **è®¢å•å±¥çº¦**ï¼šè®¢å•åˆ†é…ã€æ‹£è´§æ‰“åŒ…ã€ç‰©æµå‘è´§ã€é…é€è·Ÿè¸ª
- **å”®åæœåŠ¡**ï¼šé€€è´§é€€æ¬¾ã€æ¢è´§è¡¥å‘ã€å”®åå®¡æ ¸
- **è®¢å•æŸ¥è¯¢**ï¼šè®¢å•çŠ¶æ€æŸ¥è¯¢ã€ç‰©æµè·Ÿè¸ªã€è®¢å•æŠ¥è¡¨
- **å¼‚å¸¸å¤„ç†**ï¼šè¶…æ—¶å¤„ç†ã€å¼‚å¸¸è®¢å•ã€è¡¥å¿æœºåˆ¶

#### éåŠŸèƒ½éœ€æ±‚
- **é«˜å¹¶å‘**ï¼šæ”¯æŒç§’æ€ã€å¤§ä¿ƒåœºæ™¯ï¼Œå³°å€¼ 10000+ TPS
- **é«˜å¯ç”¨**ï¼šç³»ç»Ÿå¯ç”¨æ€§ 99.99%
- **å®æ—¶æ€§**ï¼šè®¢å•çŠ¶æ€å®æ—¶æ›´æ–°
- **å¯æ‰©å±•**ï¼šæ”¯æŒå¤šæ¸ é“ã€å¤šä»“åº“æ‰©å±•
- **æ•°æ®ä¸€è‡´æ€§**ï¼šä¿è¯è®¢å•æ•°æ®å¼ºä¸€è‡´æ€§

---

## äºŒã€ç³»ç»Ÿæ¶æ„

### 2.1 æŠ€æœ¯æ¶æ„

```mermaid
graph TB
    subgraph Channel["ğŸ“± è®¢å•æ¸ é“"]
        WebMall["ç”µå•†å¹³å°"]
        MobileApp["ç§»åŠ¨APP"]
        MiniProgram["å°ç¨‹åº"]
        ThirdParty["ç¬¬ä¸‰æ–¹å¹³å°<br/>(æ·˜å®/äº¬ä¸œ)"]
    end

    subgraph Gateway["ğŸŒ æ¥å…¥å±‚"]
        SpringGW["Spring Cloud Gateway<br/>â€¢ é™æµç†”æ–­<br/>â€¢ è·¯ç”±è½¬å‘<br/>â€¢ è´Ÿè½½å‡è¡¡"]
    end

    subgraph Business["âš™ï¸ ä¸šåŠ¡æœåŠ¡å±‚"]
        Order["è®¢å•æœåŠ¡<br/>order-service"]
        Fulfillment["å±¥çº¦æœåŠ¡<br/>fulfillment-service"]
        AfterSale["å”®åæœåŠ¡<br/>aftersale-service"]
        Payment["æ”¯ä»˜æœåŠ¡<br/>payment-service"]
        Inventory["åº“å­˜æœåŠ¡<br/>inventory-service"]
        Logistics["ç‰©æµæœåŠ¡<br/>logistics-service"]
        Notify["é€šçŸ¥æœåŠ¡<br/>notify-service"]
    end

    subgraph Infrastructure["ğŸ”§ åŸºç¡€è®¾æ–½å±‚"]
        subgraph Registry["æ³¨å†Œä¸­å¿ƒ"]
            Nacos["Nacos<br/>æœåŠ¡æ³¨å†Œä¸å‘ç°"]
        end
        
        subgraph Message["æ¶ˆæ¯é˜Ÿåˆ—"]
            RabbitMQ["RabbitMQ<br/>å¼‚æ­¥æ¶ˆæ¯"]
            RocketMQ["RocketMQ<br/>å»¶æ—¶æ¶ˆæ¯"]
        end
        
        subgraph Transaction["åˆ†å¸ƒå¼äº‹åŠ¡"]
            Seata["Seata<br/>äº‹åŠ¡åè°ƒ"]
        end
        
        subgraph FlowControl["æµé‡æ§åˆ¶"]
            Sentinel["Sentinel<br/>é™æµé™çº§"]
        end
    end

    subgraph Data["ğŸ’¾ æ•°æ®å±‚"]
        MySQL["MySQL<br/>è®¢å•æ•°æ®(åˆ†åº“åˆ†è¡¨)"]
        Redis["Redis<br/>ç¼“å­˜ + åˆ†å¸ƒå¼é”"]
        MongoDB["MongoDB<br/>è®¢å•æ—¥å¿—"]
        ES["Elasticsearch<br/>è®¢å•æœç´¢"]
    end

    %% è¿æ¥å…³ç³»
    WebMall --> SpringGW
    MobileApp --> SpringGW
    MiniProgram --> SpringGW
    ThirdParty --> SpringGW
    
    SpringGW --> Order
    SpringGW --> Fulfillment
    SpringGW --> AfterSale
    SpringGW --> Payment
    
    Order --> Nacos
    Fulfillment --> Nacos
    AfterSale --> Nacos
    Payment --> Nacos
    Inventory --> Nacos
    Logistics --> Nacos
    Notify --> Nacos
    
    Order --> RabbitMQ
    Fulfillment --> RabbitMQ
    AfterSale --> RabbitMQ
    
    Order --> RocketMQ
    Payment --> RocketMQ
    
    Order --> Seata
    Payment --> Seata
    Inventory --> Seata
    
    Order --> Sentinel
    Payment --> Sentinel
    
    Order --> MySQL
    Fulfillment --> MySQL
    AfterSale --> MySQL
    
    Order --> Redis
    Payment --> Redis
    Inventory --> Redis
    
    Order --> MongoDB
    Fulfillment --> MongoDB
    
    Order --> ES
    AfterSale --> ES

    %% æ ·å¼å®šä¹‰
    classDef channelStyle fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef gatewayStyle fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef serviceStyle fill:#e8f5e9,stroke:#388e3c,stroke-width:2px
    classDef infraStyle fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef dataStyle fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    
    class WebMall,MobileApp,MiniProgram,ThirdParty channelStyle
    class SpringGW gatewayStyle
    class Order,Fulfillment,AfterSale,Payment,Inventory,Logistics,Notify serviceStyle
    class Nacos,RabbitMQ,RocketMQ,Seata,Sentinel infraStyle
    class MySQL,Redis,MongoDB,ES dataStyle
```

### 2.2 è®¢å•å…¨æµç¨‹

```mermaid
flowchart TD
    Start([ç”¨æˆ·ä¸‹å•]) --> Validate[è®¢å•éªŒè¯]
    Validate --> Risk{é£æ§æ£€æŸ¥}
    Risk -->|é€šè¿‡| Lock[é”å®šåº“å­˜]
    Risk -->|æ‹¦æˆª| Block([è®¢å•æ‹¦æˆª])
    
    Lock --> PayCheck{æ”¯ä»˜ç¡®è®¤}
    PayCheck -->|è¶…æ—¶| Cancel1[è‡ªåŠ¨å–æ¶ˆ]
    PayCheck -->|æˆåŠŸ| Allocate[è®¢å•åˆ†é…]
    
    Allocate --> Split{æ˜¯å¦æ‹†å•}
    Split -->|æ˜¯| SubOrder[ç”Ÿæˆå­è®¢å•]
    Split -->|å¦| Warehouse[åˆ†é…ä»“åº“]
    
    SubOrder --> Warehouse
    
    Warehouse --> Pick[æ‹£è´§]
    Pick --> Pack[æ‰“åŒ…]
    Pack --> Ship[å‘è´§]
    
    Ship --> Deliver[é…é€ä¸­]
    Deliver --> Sign{ç­¾æ”¶}
    
    Sign -->|æˆåŠŸ| Complete([è®¢å•å®Œæˆ])
    Sign -->|æ‹’æ”¶| Return1[é€€è´§æµç¨‹]
    
    Cancel1 --> Unlock[è§£é”åº“å­˜]
    Unlock --> End1([è®¢å•å–æ¶ˆ])
    
    Complete --> AfterSale{å”®å?}
    AfterSale -->|æ˜¯| Return2[å”®åå¤„ç†]
    AfterSale -->|å¦| End2([äº¤æ˜“å®Œæˆ])
    
    Return1 --> End3([é€€è´§å®Œæˆ])
    Return2 --> End4([å”®åå®Œæˆ])
    
    style Start fill:#e8f5e9
    style Complete fill:#c8e6c9
    style End2 fill:#4caf50,color:#fff
    style Block fill:#f44336,color:#fff
    style Cancel1 fill:#ff9800,color:#fff
```

### åˆ†åº“åˆ†è¡¨ç­–ç•¥

#### è®¢å•è¡¨åˆ†åº“åˆ†è¡¨
- **åˆ†åº“**ï¼šæŒ‰ç”¨æˆ·IDå–æ¨¡åˆ† 8 ä¸ªåº“
- **åˆ†è¡¨**ï¼šæ¯ä¸ªåº“æŒ‰è®¢å•åˆ›å»ºæ—¶é—´åˆ† 12 å¼ è¡¨ï¼ˆæŒ‰æœˆï¼‰
- **è·¯ç”±è§„åˆ™**ï¼š`db = userId % 8`, `table = month % 12`

```sql
-- ç¤ºä¾‹ï¼šè®¢å•è¡¨åˆ†è¡¨
order_0, order_1, order_2, ..., order_11 (12å¼ è¡¨)
```

### æ ¸å¿ƒæœåŠ¡

#### 1. è®¢å•æœåŠ¡ (oms-order-service)
```java
- è®¢å•åˆ›å»º (Order Creation)
- è®¢å•æ‹†åˆ† (Order Split)
- è®¢å•åˆå¹¶ (Order Merge)
- è®¢å•éªŒè¯ (Order Validation)
- è®¢å•æŸ¥è¯¢ (Order Query)
- è®¢å•å–æ¶ˆ (Order Cancel)
```

#### 2. å±¥çº¦æœåŠ¡ (oms-fulfillment-service)
```java
- è®¢å•åˆ†é… (Order Allocation)
- åº“å­˜é”å®š (Inventory Lock)
- æ‹£è´§ç®¡ç† (Picking)
- æ‰“åŒ…ç®¡ç† (Packing)
- å‘è´§ç®¡ç† (Shipping)
- é…é€è·Ÿè¸ª (Delivery Tracking)
```

#### 3. å”®åæœåŠ¡ (oms-aftersale-service)
```java
- é€€è´§ç”³è¯· (Return Request)
- é€€æ¬¾ç”³è¯· (Refund Request)
- æ¢è´§ç”³è¯· (Exchange Request)
- å”®åå®¡æ ¸ (After-sale Approval)
- è¡¥å¿å¤„ç† (Compensation)
```

#### 4. æ”¯ä»˜æœåŠ¡ (oms-payment-service)
```java
- æ”¯ä»˜åˆ›å»º (Payment Creation)
- æ”¯ä»˜å›è°ƒ (Payment Callback)
- é€€æ¬¾å¤„ç† (Refund)
- æ”¯ä»˜æŸ¥è¯¢ (Payment Query)
```

## æ•°æ®æ¨¡å‹è®¾è®¡

### æ ¸å¿ƒè¡¨ç»“æ„

#### 1. è®¢å•ä¸»è¡¨ (order_main)
```sql
CREATE TABLE order_main_{month} (
    id BIGINT PRIMARY KEY COMMENT 'è®¢å•ID(é›ªèŠ±ç®—æ³•)',
    order_no VARCHAR(50) NOT NULL UNIQUE COMMENT 'è®¢å•å·',
    parent_order_no VARCHAR(50) COMMENT 'çˆ¶è®¢å•å·(æ‹†å•åœºæ™¯)',
    user_id BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
    channel TINYINT NOT NULL COMMENT 'è®¢å•æ¸ é“:1-PC,2-H5,3-å°ç¨‹åº,4-APP,5-ç¬¬ä¸‰æ–¹å¹³å°',
    channel_order_no VARCHAR(50) COMMENT 'æ¸ é“è®¢å•å·',
    order_type TINYINT DEFAULT 1 COMMENT 'è®¢å•ç±»å‹:1-æ™®é€šè®¢å•,2-é¢„å”®è®¢å•,3-ç§’æ€è®¢å•,4-æ‹¼å›¢è®¢å•',
    order_source TINYINT COMMENT 'è®¢å•æ¥æº:1-è‡ªè¥,2-äº¬ä¸œ,3-å¤©çŒ«,4-æ‹¼å¤šå¤š',
    total_amount DECIMAL(15,2) NOT NULL COMMENT 'è®¢å•æ€»é¢',
    discount_amount DECIMAL(15,2) DEFAULT 0 COMMENT 'ä¼˜æƒ é‡‘é¢',
    freight_amount DECIMAL(15,2) DEFAULT 0 COMMENT 'è¿è´¹',
    pay_amount DECIMAL(15,2) NOT NULL COMMENT 'å®ä»˜é‡‘é¢',
    order_status TINYINT DEFAULT 1 COMMENT 'è®¢å•çŠ¶æ€:1-å¾…ä»˜æ¬¾,2-å¾…å‘è´§,3-å¾…æ”¶è´§,4-å·²å®Œæˆ,5-å·²å–æ¶ˆ,6-å”®åä¸­',
    pay_status TINYINT DEFAULT 0 COMMENT 'æ”¯ä»˜çŠ¶æ€:0-æœªæ”¯ä»˜,1-å·²æ”¯ä»˜,2-é€€æ¬¾ä¸­,3-å·²é€€æ¬¾',
    pay_type TINYINT COMMENT 'æ”¯ä»˜æ–¹å¼:1-å¾®ä¿¡,2-æ”¯ä»˜å®,3-é“¶è”,4-ä½™é¢',
    pay_time DATETIME COMMENT 'æ”¯ä»˜æ—¶é—´',
    consignee_name VARCHAR(50) NOT NULL COMMENT 'æ”¶è´§äºº',
    consignee_mobile VARCHAR(20) NOT NULL COMMENT 'æ”¶è´§æ‰‹æœº',
    consignee_province VARCHAR(50) COMMENT 'æ”¶è´§çœä»½',
    consignee_city VARCHAR(50) COMMENT 'æ”¶è´§åŸå¸‚',
    consignee_district VARCHAR(50) COMMENT 'æ”¶è´§åŒºå¿',
    consignee_address VARCHAR(200) NOT NULL COMMENT 'æ”¶è´§è¯¦ç»†åœ°å€',
    buyer_message VARCHAR(500) COMMENT 'ä¹°å®¶ç•™è¨€',
    seller_remark VARCHAR(500) COMMENT 'å–å®¶å¤‡æ³¨',
    is_timeout TINYINT DEFAULT 0 COMMENT 'æ˜¯å¦è¶…æ—¶:0-å¦,1-æ˜¯',
    cancel_reason VARCHAR(200) COMMENT 'å–æ¶ˆåŸå› ',
    cancel_time DATETIME COMMENT 'å–æ¶ˆæ—¶é—´',
    ship_time DATETIME COMMENT 'å‘è´§æ—¶é—´',
    finish_time DATETIME COMMENT 'å®Œæˆæ—¶é—´',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_order_no (order_no),
    INDEX idx_user (user_id, create_time),
    INDEX idx_status (order_status),
    INDEX idx_create_time (create_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='è®¢å•ä¸»è¡¨';
```

#### 2. è®¢å•æ˜ç»†è¡¨ (order_detail)
```sql
CREATE TABLE order_detail_{month} (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    order_id BIGINT NOT NULL COMMENT 'è®¢å•ID',
    order_no VARCHAR(50) NOT NULL COMMENT 'è®¢å•å·',
    product_id BIGINT NOT NULL COMMENT 'å•†å“ID',
    sku_id BIGINT NOT NULL COMMENT 'SKU ID',
    product_code VARCHAR(50) COMMENT 'å•†å“ç¼–ç ',
    product_name VARCHAR(200) NOT NULL COMMENT 'å•†å“åç§°',
    sku_name VARCHAR(200) COMMENT 'SKUåç§°',
    product_image VARCHAR(500) COMMENT 'å•†å“å›¾ç‰‡',
    category_id BIGINT COMMENT 'åˆ†ç±»ID',
    brand_id BIGINT COMMENT 'å“ç‰ŒID',
    unit_price DECIMAL(10,2) NOT NULL COMMENT 'å•ä»·',
    quantity INT NOT NULL COMMENT 'æ•°é‡',
    discount_amount DECIMAL(10,2) DEFAULT 0 COMMENT 'ä¼˜æƒ é‡‘é¢',
    total_amount DECIMAL(15,2) NOT NULL COMMENT 'æ€»é‡‘é¢',
    is_gift TINYINT DEFAULT 0 COMMENT 'æ˜¯å¦èµ å“:0-å¦,1-æ˜¯',
    promotion_id BIGINT COMMENT 'ä¿ƒé”€æ´»åŠ¨ID',
    warehouse_id BIGINT COMMENT 'å‘è´§ä»“åº“ID',
    refund_status TINYINT DEFAULT 0 COMMENT 'é€€æ¬¾çŠ¶æ€:0-æ— ,1-é€€æ¬¾ä¸­,2-å·²é€€æ¬¾',
    refund_quantity INT DEFAULT 0 COMMENT 'é€€æ¬¾æ•°é‡',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_order (order_id),
    INDEX idx_order_no (order_no),
    INDEX idx_sku (sku_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='è®¢å•æ˜ç»†è¡¨';
```

#### 3. è®¢å•å±¥çº¦è¡¨ (order_fulfillment)
```sql
CREATE TABLE order_fulfillment (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    order_id BIGINT NOT NULL COMMENT 'è®¢å•ID',
    order_no VARCHAR(50) NOT NULL COMMENT 'è®¢å•å·',
    warehouse_id BIGINT NOT NULL COMMENT 'ä»“åº“ID',
    warehouse_name VARCHAR(100) COMMENT 'ä»“åº“åç§°',
    allocation_time DATETIME COMMENT 'åˆ†é…æ—¶é—´',
    lock_status TINYINT DEFAULT 0 COMMENT 'é”åº“çŠ¶æ€:0-æœªé”å®š,1-å·²é”å®š,2-å·²é‡Šæ”¾',
    lock_time DATETIME COMMENT 'é”å®šæ—¶é—´',
    pick_status TINYINT DEFAULT 0 COMMENT 'æ‹£è´§çŠ¶æ€:0-å¾…æ‹£è´§,1-æ‹£è´§ä¸­,2-å·²æ‹£è´§',
    pick_time DATETIME COMMENT 'æ‹£è´§æ—¶é—´',
    pack_status TINYINT DEFAULT 0 COMMENT 'æ‰“åŒ…çŠ¶æ€:0-å¾…æ‰“åŒ…,1-æ‰“åŒ…ä¸­,2-å·²æ‰“åŒ…',
    pack_time DATETIME COMMENT 'æ‰“åŒ…æ—¶é—´',
    ship_status TINYINT DEFAULT 0 COMMENT 'å‘è´§çŠ¶æ€:0-å¾…å‘è´§,1-å·²å‘è´§',
    ship_time DATETIME COMMENT 'å‘è´§æ—¶é—´',
    logistics_company VARCHAR(50) COMMENT 'ç‰©æµå…¬å¸',
    logistics_no VARCHAR(50) COMMENT 'ç‰©æµå•å·',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_order (order_id),
    INDEX idx_order_no (order_no),
    INDEX idx_warehouse (warehouse_id),
    INDEX idx_ship_status (ship_status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='è®¢å•å±¥çº¦è¡¨';
```

#### 4. è®¢å•çŠ¶æ€æµè½¬è¡¨ (order_status_log)
```sql
CREATE TABLE order_status_log (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    order_id BIGINT NOT NULL COMMENT 'è®¢å•ID',
    order_no VARCHAR(50) NOT NULL COMMENT 'è®¢å•å·',
    before_status TINYINT COMMENT 'å˜æ›´å‰çŠ¶æ€',
    after_status TINYINT NOT NULL COMMENT 'å˜æ›´åçŠ¶æ€',
    operator_type TINYINT COMMENT 'æ“ä½œç±»å‹:1-ç”¨æˆ·,2-ç³»ç»Ÿ,3-ç®¡ç†å‘˜',
    operator_id BIGINT COMMENT 'æ“ä½œäººID',
    operator_name VARCHAR(50) COMMENT 'æ“ä½œäºº',
    remark VARCHAR(500) COMMENT 'å¤‡æ³¨',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_order (order_id),
    INDEX idx_order_no (order_no),
    INDEX idx_create_time (create_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='è®¢å•çŠ¶æ€æµè½¬è¡¨';
```

#### 5. å”®åå•è¡¨ (aftersale_order)
```sql
CREATE TABLE aftersale_order (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    aftersale_no VARCHAR(50) NOT NULL UNIQUE COMMENT 'å”®åå•å·',
    order_id BIGINT NOT NULL COMMENT 'è®¢å•ID',
    order_no VARCHAR(50) NOT NULL COMMENT 'è®¢å•å·',
    order_detail_id BIGINT NOT NULL COMMENT 'è®¢å•æ˜ç»†ID',
    user_id BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
    aftersale_type TINYINT NOT NULL COMMENT 'å”®åç±»å‹:1-ä»…é€€æ¬¾,2-é€€è´§é€€æ¬¾,3-æ¢è´§',
    reason_type TINYINT COMMENT 'åŸå› ç±»å‹:1-è´¨é‡é—®é¢˜,2-å‘é”™è´§,3-ä¸æƒ³è¦äº†,4-å…¶ä»–',
    reason_desc VARCHAR(500) COMMENT 'åŸå› æè¿°',
    refund_amount DECIMAL(10,2) NOT NULL COMMENT 'é€€æ¬¾é‡‘é¢',
    quantity INT NOT NULL COMMENT 'æ•°é‡',
    status TINYINT DEFAULT 1 COMMENT 'çŠ¶æ€:1-å¾…å®¡æ ¸,2-å®¡æ ¸é€šè¿‡,3-å¾…é€€è´§,4-é€€è´§ä¸­,5-å·²å®Œæˆ,6-å·²æ‹’ç»,7-å·²å–æ¶ˆ',
    approve_time DATETIME COMMENT 'å®¡æ ¸æ—¶é—´',
    approver_id BIGINT COMMENT 'å®¡æ ¸äººID',
    reject_reason VARCHAR(200) COMMENT 'æ‹’ç»åŸå› ',
    return_logistics_company VARCHAR(50) COMMENT 'é€€è´§ç‰©æµå…¬å¸',
    return_logistics_no VARCHAR(50) COMMENT 'é€€è´§ç‰©æµå•å·',
    receive_time DATETIME COMMENT 'æ”¶è´§æ—¶é—´',
    refund_time DATETIME COMMENT 'é€€æ¬¾æ—¶é—´',
    finish_time DATETIME COMMENT 'å®Œæˆæ—¶é—´',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_aftersale_no (aftersale_no),
    INDEX idx_order (order_id),
    INDEX idx_user (user_id),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='å”®åå•è¡¨';
```

#### 6. æ”¯ä»˜å•è¡¨ (payment_order)
```sql
CREATE TABLE payment_order (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    payment_no VARCHAR(50) NOT NULL UNIQUE COMMENT 'æ”¯ä»˜å•å·',
    order_no VARCHAR(50) NOT NULL COMMENT 'è®¢å•å·',
    user_id BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
    pay_type TINYINT NOT NULL COMMENT 'æ”¯ä»˜æ–¹å¼:1-å¾®ä¿¡,2-æ”¯ä»˜å®,3-é“¶è”,4-ä½™é¢',
    pay_amount DECIMAL(15,2) NOT NULL COMMENT 'æ”¯ä»˜é‡‘é¢',
    pay_status TINYINT DEFAULT 0 COMMENT 'æ”¯ä»˜çŠ¶æ€:0-å¾…æ”¯ä»˜,1-æ”¯ä»˜ä¸­,2-æ”¯ä»˜æˆåŠŸ,3-æ”¯ä»˜å¤±è´¥,4-å·²å–æ¶ˆ',
    third_party_no VARCHAR(100) COMMENT 'ç¬¬ä¸‰æ–¹äº¤æ˜“å·',
    pay_time DATETIME COMMENT 'æ”¯ä»˜æ—¶é—´',
    notify_time DATETIME COMMENT 'å›è°ƒæ—¶é—´',
    notify_data TEXT COMMENT 'å›è°ƒæ•°æ®',
    timeout_time DATETIME COMMENT 'è¶…æ—¶æ—¶é—´',
    remark VARCHAR(500) COMMENT 'å¤‡æ³¨',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_order (order_no),
    INDEX idx_payment_no (payment_no),
    INDEX idx_user (user_id),
    INDEX idx_status (pay_status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='æ”¯ä»˜å•è¡¨';
```

## æ ¸å¿ƒä¸šåŠ¡æµç¨‹

### 1. è®¢å•åˆ›å»ºæµç¨‹

```
æäº¤è®¢å• â†’ è®¢å•éªŒè¯ â†’ è®¡ç®—ä»·æ ¼ â†’ åˆ›å»ºè®¢å• â†’ åˆ›å»ºæ”¯ä»˜å• â†’ æ”¯ä»˜
    â†“         â†“          â†“         â†“          â†“           â†“
 (å‚æ•°æ ¡éªŒ) (åº“å­˜æ ¡éªŒ)  (ä¼˜æƒ è®¡ç®—) (è®¢å•å…¥åº“)  (æ”¯ä»˜å•)    (è·³è½¬æ”¯ä»˜)
```

**å…³é”®æ­¥éª¤**ï¼š
1. æ¥æ”¶è®¢å•æ•°æ®ï¼ˆå•†å“ã€æ•°é‡ã€åœ°å€ç­‰ï¼‰
2. è®¢å•å‚æ•°éªŒè¯ï¼ˆå¿…å¡«é¡¹ã€æ ¼å¼ç­‰ï¼‰
3. åº“å­˜å¯ç”¨æ€§æ ¡éªŒ
4. ä¼˜æƒ åˆ¸/ä¿ƒé”€è®¡ç®—
5. è®¡ç®—è®¢å•é‡‘é¢ï¼ˆå•†å“é‡‘é¢ã€è¿è´¹ã€ä¼˜æƒ ï¼‰
6. åˆ›å»ºè®¢å•ï¼ˆä¸»è¡¨+æ˜ç»†è¡¨ï¼‰
7. åˆ›å»ºæ”¯ä»˜å•
8. è¿”å›æ”¯ä»˜ä¿¡æ¯
9. ç”¨æˆ·æ”¯ä»˜

### 2. è®¢å•æ”¯ä»˜æˆåŠŸæµç¨‹

```
æ”¯ä»˜å›è°ƒ â†’ éªŒè¯ç­¾å â†’ æ›´æ–°æ”¯ä»˜å• â†’ æ›´æ–°è®¢å•çŠ¶æ€ â†’ é”å®šåº“å­˜ â†’ è®¢å•åˆ†é… â†’ å‘é€MQ
    â†“         â†“          â†“            â†“            â†“         â†“
 (å¼‚æ­¥å›è°ƒ) (å®‰å…¨æ ¡éªŒ)  (æ”¯ä»˜æˆåŠŸ)    (å¾…å‘è´§)     (é”åº“å­˜)  (åˆ†é…ä»“åº“)
```

**å…³é”®æ­¥éª¤**ï¼š
1. æ¥æ”¶æ”¯ä»˜å›è°ƒï¼ˆå¾®ä¿¡/æ”¯ä»˜å®ï¼‰
2. éªŒè¯ç­¾åå’Œé‡‘é¢
3. æ›´æ–°æ”¯ä»˜å•çŠ¶æ€
4. æ›´æ–°è®¢å•çŠ¶æ€ä¸º"å¾…å‘è´§"
5. é”å®šåº“å­˜
6. è®¢å•åˆ†é…ï¼ˆå°±è¿‘ä»“åº“åˆ†é…ï¼‰
7. å‘é€è®¢å•å·²æ”¯ä»˜æ¶ˆæ¯ï¼ˆMQï¼‰
8. é€šçŸ¥ç”¨æˆ·æ”¯ä»˜æˆåŠŸ

### 3. è®¢å•å±¥çº¦æµç¨‹

```
è®¢å•åˆ†é… â†’ é”å®šåº“å­˜ â†’ ç”Ÿæˆæ‹£è´§å• â†’ æ‹£è´§ â†’ æ‰“åŒ… â†’ å‘è´§ â†’ ç‰©æµè·Ÿè¸ª â†’ ç­¾æ”¶
    â†“         â†“          â†“         â†“      â†“      â†“        â†“         â†“
 (åˆ†é…ä»“åº“) (é”åº“å­˜)   (æ‹£è´§ä»»åŠ¡)  (æ‹£è´§) (æ‰“åŒ…) (å‘è´§)   (é…é€ä¸­)   (å·²å®Œæˆ)
```

**å…³é”®æ­¥éª¤**ï¼š
1. è®¢å•åˆ†é…ï¼ˆé€‰æ‹©æœ€ä¼˜ä»“åº“ï¼‰
2. é”å®šåº“å­˜ï¼ˆæ‰£å‡å¯ç”¨åº“å­˜ï¼‰
3. ç”Ÿæˆæ‹£è´§å•
4. æ‹£è´§ï¼ˆæ‰«ç æ‹£è´§ï¼‰
5. æ‰“åŒ…ï¼ˆç§°é‡ã€æ‰“å°é¢å•ï¼‰
6. å‘è´§ï¼ˆäº¤ä»˜ç‰©æµï¼‰
7. æ¨é€ç‰©æµä¿¡æ¯
8. ç”¨æˆ·ç¡®è®¤æ”¶è´§

### 4. å”®åæµç¨‹

```
æäº¤å”®å â†’ å”®åå®¡æ ¸ â†’ é€€è´§ â†’ æ”¶è´§æ£€éªŒ â†’ é€€æ¬¾ â†’ å®Œæˆ
    â†“         â†“        â†“      â†“          â†“      â†“
 (ç”³è¯·)    (å®¡æ ¸)   (å¯„å›)  (è´¨æ£€)     (é€€æ¬¾)  (å®Œæˆ)
```

**å…³é”®æ­¥éª¤**ï¼š
1. ç”¨æˆ·æäº¤å”®åç”³è¯·
2. å®¢æœå®¡æ ¸ï¼ˆåŒæ„/æ‹’ç»ï¼‰
3. ç”¨æˆ·å¯„å›å•†å“ï¼ˆé€€è´§é€€æ¬¾ï¼‰
4. ä»“åº“æ”¶è´§æ£€éªŒ
5. å¤„ç†é€€æ¬¾
6. é‡Šæ”¾åº“å­˜
7. å®Œæˆå”®å

## æŠ€æœ¯å®ç°æ–¹æ¡ˆ

### 1. è®¢å•å·ç”Ÿæˆï¼ˆé›ªèŠ±ç®—æ³•ï¼‰

```java
@Component
public class OrderNoGenerator {
    
    @Autowired
    private SnowflakeIdWorker snowflakeIdWorker;
    
    /**
     * ç”Ÿæˆè®¢å•å·
     * æ ¼å¼ï¼šä¸šåŠ¡å‰ç¼€(2ä½) + æ—¶é—´æˆ³(10ä½) + é›ªèŠ±IDå6ä½
     */
    public String generateOrderNo() {
        long id = snowflakeIdWorker.nextId();
        String timestamp = String.valueOf(System.currentTimeMillis() / 1000);
        String suffix = String.valueOf(id % 1000000);
        
        return "OD" + timestamp + String.format("%06d", Long.parseLong(suffix));
    }
}
```

### 2. è®¢å•åˆ†åº“åˆ†è¡¨ï¼ˆShardingSphereï¼‰

```yaml
spring:
  shardingsphere:
    datasource:
      names: ds0,ds1,ds2,ds3,ds4,ds5,ds6,ds7
      ds0:
        type: com.zaxxer.hikari.HikariDataSource
        driver-class-name: com.mysql.cj.jdbc.Driver
        jdbc-url: jdbc:mysql://localhost:3306/oms_0
        username: root
        password: password
    rules:
      sharding:
        tables:
          order_main:
            actual-data-nodes: ds$->{0..7}.order_main_$->{0..11}
            database-strategy:
              standard:
                sharding-column: user_id
                sharding-algorithm-name: db-mod
            table-strategy:
              standard:
                sharding-column: create_time
                sharding-algorithm-name: table-month
            key-generate-strategy:
              column: id
              key-generator-name: snowflake
        sharding-algorithms:
          db-mod:
            type: MOD
            props:
              sharding-count: 8
          table-month:
            type: INLINE
            props:
              algorithm-expression: order_main_$->{month(create_time) % 12}
        key-generators:
          snowflake:
            type: SNOWFLAKE
```

### 3. è®¢å•åˆ›å»ºï¼ˆåˆ†å¸ƒå¼äº‹åŠ¡ - Seataï¼‰

```java
@Service
public class OrderService {
    
    @Autowired
    private OrderMapper orderMapper;
    
    @Autowired
    private InventoryServiceClient inventoryServiceClient;
    
    @Autowired
    private PaymentServiceClient paymentServiceClient;
    
    /**
     * åˆ›å»ºè®¢å•ï¼ˆåˆ†å¸ƒå¼äº‹åŠ¡ï¼‰
     */
    @GlobalTransactional(name = "create-order", rollbackFor = Exception.class)
    public OrderCreateResult createOrder(OrderCreateDTO dto) {
        // 1. éªŒè¯è®¢å•
        validateOrder(dto);
        
        // 2. æ£€æŸ¥åº“å­˜ï¼ˆè¿œç¨‹è°ƒç”¨ï¼‰
        for (OrderItemDTO item : dto.getItems()) {
            boolean available = inventoryServiceClient.checkStock(
                item.getSkuId(), 
                item.getQuantity()
            );
            if (!available) {
                throw new BusinessException("å•†å“åº“å­˜ä¸è¶³");
            }
        }
        
        // 3. è®¡ç®—ä»·æ ¼
        OrderPriceResult priceResult = calculatePrice(dto);
        
        // 4. åˆ›å»ºè®¢å•
        OrderMain order = new OrderMain();
        order.setOrderNo(orderNoGenerator.generateOrderNo());
        order.setUserId(dto.getUserId());
        order.setTotalAmount(priceResult.getTotalAmount());
        order.setPayAmount(priceResult.getPayAmount());
        order.setOrderStatus(OrderStatus.WAIT_PAY);
        // ... å…¶ä»–å­—æ®µ
        orderMapper.insert(order);
        
        // 5. åˆ›å»ºè®¢å•æ˜ç»†
        for (OrderItemDTO item : dto.getItems()) {
            OrderDetail detail = new OrderDetail();
            detail.setOrderId(order.getId());
            detail.setOrderNo(order.getOrderNo());
            detail.setSkuId(item.getSkuId());
            detail.setQuantity(item.getQuantity());
            // ... å…¶ä»–å­—æ®µ
            orderDetailMapper.insert(detail);
        }
        
        // 6. åˆ›å»ºæ”¯ä»˜å•ï¼ˆè¿œç¨‹è°ƒç”¨ï¼‰
        PaymentCreateResult paymentResult = paymentServiceClient.createPayment(
            order.getOrderNo(),
            order.getUserId(),
            order.getPayAmount(),
            dto.getPayType()
        );
        
        // 7. å‘é€è®¢å•åˆ›å»ºæ¶ˆæ¯
        sendOrderCreatedMessage(order.getOrderNo());
        
        // 8. è¿”å›ç»“æœ
        OrderCreateResult result = new OrderCreateResult();
        result.setOrderId(order.getId());
        result.setOrderNo(order.getOrderNo());
        result.setPaymentNo(paymentResult.getPaymentNo());
        result.setPayUrl(paymentResult.getPayUrl());
        
        return result;
    }
    
    /**
     * è®¡ç®—è®¢å•ä»·æ ¼
     */
    private OrderPriceResult calculatePrice(OrderCreateDTO dto) {
        BigDecimal totalAmount = BigDecimal.ZERO;
        BigDecimal discountAmount = BigDecimal.ZERO;
        
        // 1. è®¡ç®—å•†å“æ€»é¢
        for (OrderItemDTO item : dto.getItems()) {
            BigDecimal itemAmount = item.getPrice()
                .multiply(new BigDecimal(item.getQuantity()));
            totalAmount = totalAmount.add(itemAmount);
        }
        
        // 2. è®¡ç®—ä¼˜æƒ é‡‘é¢ï¼ˆä¼˜æƒ åˆ¸ã€ä¿ƒé”€ç­‰ï¼‰
        if (dto.getCouponId() != null) {
            discountAmount = calculateCouponDiscount(dto.getCouponId(), totalAmount);
        }
        
        // 3. è®¡ç®—è¿è´¹
        BigDecimal freightAmount = calculateFreight(dto);
        
        // 4. è®¡ç®—å®ä»˜é‡‘é¢
        BigDecimal payAmount = totalAmount
            .subtract(discountAmount)
            .add(freightAmount);
        
        OrderPriceResult result = new OrderPriceResult();
        result.setTotalAmount(totalAmount);
        result.setDiscountAmount(discountAmount);
        result.setFreightAmount(freightAmount);
        result.setPayAmount(payAmount);
        
        return result;
    }
}
```

### 4. æ”¯ä»˜å›è°ƒå¤„ç†ï¼ˆå¹‚ç­‰æ€§ï¼‰

```java
@Service
public class PaymentCallbackService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Autowired
    private PaymentOrderMapper paymentOrderMapper;
    
    @Autowired
    private OrderService orderService;
    
    /**
     * å¤„ç†æ”¯ä»˜å›è°ƒï¼ˆå¹‚ç­‰æ€§ï¼‰
     */
    public void handlePaymentCallback(PaymentCallbackDTO dto) {
        String paymentNo = dto.getPaymentNo();
        
        // 1. å¹‚ç­‰æ€§æ ¡éªŒï¼ˆåŸºäº Redis åˆ†å¸ƒå¼é”ï¼‰
        String lockKey = "payment:callback:" + paymentNo;
        Boolean acquired = redisTemplate.opsForValue()
            .setIfAbsent(lockKey, "1", 5, TimeUnit.MINUTES);
        
        if (!acquired) {
            log.warn("æ”¯ä»˜å›è°ƒå¤„ç†ä¸­ï¼Œå¿½ç•¥é‡å¤å›è°ƒ: {}", paymentNo);
            return;
        }
        
        try {
            // 2. æŸ¥è¯¢æ”¯ä»˜å•
            PaymentOrder payment = paymentOrderMapper.selectByPaymentNo(paymentNo);
            
            // 3. éªŒè¯æ”¯ä»˜å•çŠ¶æ€
            if (payment.getPayStatus() == PayStatus.SUCCESS) {
                log.warn("æ”¯ä»˜å•å·²å¤„ç†: {}", paymentNo);
                return;
            }
            
            // 4. éªŒè¯ç­¾åå’Œé‡‘é¢
            validateCallback(dto, payment);
            
            // 5. æ›´æ–°æ”¯ä»˜å•çŠ¶æ€
            payment.setPayStatus(PayStatus.SUCCESS);
            payment.setThirdPartyNo(dto.getThirdPartyNo());
            payment.setPayTime(new Date());
            payment.setNotifyTime(new Date());
            paymentOrderMapper.updateById(payment);
            
            // 6. å¤„ç†è®¢å•ï¼ˆæ›´æ–°çŠ¶æ€ã€é”åº“å­˜ã€åˆ†é…ç­‰ï¼‰
            orderService.handleOrderPaid(payment.getOrderNo());
            
            // 7. å‘é€æ”¯ä»˜æˆåŠŸæ¶ˆæ¯
            sendPaymentSuccessMessage(payment);
            
        } finally {
            // é‡Šæ”¾é”
            redisTemplate.delete(lockKey);
        }
    }
}
```

### 5. è®¢å•è‡ªåŠ¨åˆ†é…ï¼ˆå°±è¿‘åŸåˆ™ï¼‰

```java
@Service
public class OrderAllocationService {
    
    @Autowired
    private WarehouseService warehouseService;
    
    @Autowired
    private InventoryService inventoryService;
    
    /**
     * è®¢å•è‡ªåŠ¨åˆ†é…ä»“åº“
     */
    public Long allocateWarehouse(Long orderId) {
        OrderMain order = orderMapper.selectById(orderId);
        List<OrderDetail> details = orderDetailMapper.selectByOrderId(orderId);
        
        // 1. è·å–æ‰€æœ‰ä»“åº“
        List<Warehouse> warehouses = warehouseService.listActiveWarehouses();
        
        // 2. è§£ææ”¶è´§åœ°å€
        String province = order.getConsigneeProvince();
        String city = order.getConsigneeCity();
        
        // 3. æŒ‰ä¼˜å…ˆçº§ç­›é€‰ä»“åº“
        List<Warehouse> candidates = new ArrayList<>();
        
        // ä¼˜å…ˆçº§1ï¼šåŒåŸä»“åº“
        candidates = warehouses.stream()
            .filter(w -> w.getCity().equals(city))
            .collect(Collectors.toList());
        
        // ä¼˜å…ˆçº§2ï¼šåŒçœä»“åº“
        if (candidates.isEmpty()) {
            candidates = warehouses.stream()
                .filter(w -> w.getProvince().equals(province))
                .collect(Collectors.toList());
        }
        
        // ä¼˜å…ˆçº§3ï¼šå…¨å›½ä»“åº“
        if (candidates.isEmpty()) {
            candidates = warehouses;
        }
        
        // 4. æ£€æŸ¥åº“å­˜å¹¶é€‰æ‹©ä»“åº“
        for (Warehouse warehouse : candidates) {
            boolean allAvailable = true;
            
            for (OrderDetail detail : details) {
                int available = inventoryService.getAvailableStock(
                    warehouse.getId(),
                    detail.getSkuId()
                );
                
                if (available < detail.getQuantity()) {
                    allAvailable = false;
                    break;
                }
            }
            
            if (allAvailable) {
                return warehouse.getId();
            }
        }
        
        throw new BusinessException("æ— å¯ç”¨ä»“åº“");
    }
}
```

### 6. è®¢å•è¶…æ—¶è‡ªåŠ¨å–æ¶ˆï¼ˆå»¶æ—¶æ¶ˆæ¯ï¼‰

ä½¿ç”¨ **RocketMQ å»¶æ—¶æ¶ˆæ¯**ï¼š

```java
@Service
public class OrderTimeoutService {
    
    @Autowired
    private RocketMQTemplate rocketMQTemplate;
    
    /**
     * å‘é€è®¢å•è¶…æ—¶æ£€æŸ¥æ¶ˆæ¯
     */
    public void sendOrderTimeoutCheckMessage(String orderNo, int delayMinutes) {
        OrderTimeoutMessage message = new OrderTimeoutMessage();
        message.setOrderNo(orderNo);
        message.setSendTime(System.currentTimeMillis());
        
        // å»¶æ—¶çº§åˆ«ï¼š1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h
        // 30åˆ†é’Ÿå¯¹åº”å»¶æ—¶çº§åˆ« 16
        rocketMQTemplate.syncSend(
            "order-timeout-topic",
            MessageBuilder.withPayload(message).build(),
            3000,
            16 // å»¶æ—¶çº§åˆ«
        );
    }
}

@Component
@RocketMQMessageListener(
    topic = "order-timeout-topic",
    consumerGroup = "order-timeout-consumer"
)
public class OrderTimeoutConsumer implements RocketMQListener<OrderTimeoutMessage> {
    
    @Autowired
    private OrderService orderService;
    
    @Override
    public void onMessage(OrderTimeoutMessage message) {
        String orderNo = message.getOrderNo();
        
        // æŸ¥è¯¢è®¢å•
        OrderMain order = orderMapper.selectByOrderNo(orderNo);
        
        // å¦‚æœè®¢å•è¿˜æ˜¯å¾…æ”¯ä»˜çŠ¶æ€ï¼Œè‡ªåŠ¨å–æ¶ˆ
        if (order.getOrderStatus() == OrderStatus.WAIT_PAY) {
            orderService.autoCancelOrder(orderNo, "è¶…æ—¶æœªæ”¯ä»˜");
        }
    }
}
```

### 7. è®¢å•çŠ¶æ€æœº

```java
@Component
public class OrderStateMachine {
    
    /**
     * è®¢å•çŠ¶æ€æµè½¬æ ¡éªŒ
     */
    public boolean canTransition(OrderStatus from, OrderStatus to) {
        // å®šä¹‰çŠ¶æ€æµè½¬è§„åˆ™
        Map<OrderStatus, Set<OrderStatus>> transitions = new HashMap<>();
        
        // å¾…ä»˜æ¬¾ -> å¾…å‘è´§ã€å·²å–æ¶ˆ
        transitions.put(OrderStatus.WAIT_PAY, 
            Set.of(OrderStatus.WAIT_SHIP, OrderStatus.CANCELED));
        
        // å¾…å‘è´§ -> å¾…æ”¶è´§ã€å·²å–æ¶ˆ
        transitions.put(OrderStatus.WAIT_SHIP, 
            Set.of(OrderStatus.WAIT_RECEIVE, OrderStatus.CANCELED));
        
        // å¾…æ”¶è´§ -> å·²å®Œæˆã€å”®åä¸­
        transitions.put(OrderStatus.WAIT_RECEIVE, 
            Set.of(OrderStatus.FINISHED, OrderStatus.AFTER_SALE));
        
        // å”®åä¸­ -> å·²å®Œæˆ
        transitions.put(OrderStatus.AFTER_SALE, 
            Set.of(OrderStatus.FINISHED));
        
        Set<OrderStatus> allowedTransitions = transitions.get(from);
        return allowedTransitions != null && allowedTransitions.contains(to);
    }
    
    /**
     * æ›´æ–°è®¢å•çŠ¶æ€
     */
    @Transactional
    public void updateOrderStatus(String orderNo, OrderStatus newStatus, String remark) {
        OrderMain order = orderMapper.selectByOrderNo(orderNo);
        OrderStatus oldStatus = order.getOrderStatus();
        
        // æ ¡éªŒçŠ¶æ€æµè½¬
        if (!canTransition(oldStatus, newStatus)) {
            throw new BusinessException(
                String.format("è®¢å•çŠ¶æ€ä¸å…è®¸ä» %s å˜æ›´ä¸º %s", oldStatus, newStatus)
            );
        }
        
        // æ›´æ–°è®¢å•çŠ¶æ€
        order.setOrderStatus(newStatus);
        orderMapper.updateById(order);
        
        // è®°å½•çŠ¶æ€æµè½¬æ—¥å¿—
        OrderStatusLog log = new OrderStatusLog();
        log.setOrderId(order.getId());
        log.setOrderNo(orderNo);
        log.setBeforeStatus(oldStatus);
        log.setAfterStatus(newStatus);
        log.setRemark(remark);
        orderStatusLogMapper.insert(log);
        
        // å‘é€çŠ¶æ€å˜æ›´æ¶ˆæ¯
        sendOrderStatusChangeMessage(orderNo, oldStatus, newStatus);
    }
}
```

## API æ¥å£è®¾è®¡

### 1. è®¢å•æ¥å£

```java
@RestController
@RequestMapping("/api/oms/order")
public class OrderController {
    
    @Autowired
    private OrderService orderService;
    
    /**
     * åˆ›å»ºè®¢å•
     */
    @PostMapping("")
    public Result<OrderCreateResult> createOrder(@RequestBody @Valid OrderCreateDTO dto) {
        OrderCreateResult result = orderService.createOrder(dto);
        return Result.success(result);
    }
    
    /**
     * è®¢å•è¯¦æƒ…
     */
    @GetMapping("/{orderNo}")
    public Result<OrderDetailVO> getOrderDetail(@PathVariable String orderNo) {
        OrderDetailVO vo = orderService.getOrderDetail(orderNo);
        return Result.success(vo);
    }
    
    /**
     * è®¢å•åˆ—è¡¨
     */
    @GetMapping("/list")
    public Result<PageResult<OrderVO>> listOrders(
            @RequestParam(required = false) Integer status,
            @RequestParam(defaultValue = "1") Integer pageNum,
            @RequestParam(defaultValue = "20") Integer pageSize) {
        
        Long userId = SecurityUtils.getCurrentUserId();
        PageResult<OrderVO> result = orderService.listUserOrders(
            userId, status, pageNum, pageSize
        );
        return Result.success(result);
    }
    
    /**
     * å–æ¶ˆè®¢å•
     */
    @PostMapping("/{orderNo}/cancel")
    public Result<Void> cancelOrder(
            @PathVariable String orderNo,
            @RequestParam String reason) {
        
        orderService.cancelOrder(orderNo, reason);
        return Result.success();
    }
    
    /**
     * ç¡®è®¤æ”¶è´§
     */
    @PostMapping("/{orderNo}/confirm")
    public Result<Void> confirmReceive(@PathVariable String orderNo) {
        orderService.confirmReceive(orderNo);
        return Result.success();
    }
}
```

### 2. å”®åæ¥å£

```java
@RestController
@RequestMapping("/api/oms/aftersale")
public class AftersaleController {
    
    @Autowired
    private AftersaleService aftersaleService;
    
    /**
     * åˆ›å»ºå”®åå•
     */
    @PostMapping("")
    public Result<String> createAftersale(@RequestBody @Valid AftersaleCreateDTO dto) {
        String aftersaleNo = aftersaleService.createAftersale(dto);
        return Result.success(aftersaleNo);
    }
    
    /**
     * å”®åè¯¦æƒ…
     */
    @GetMapping("/{aftersaleNo}")
    public Result<AftersaleDetailVO> getAftersaleDetail(@PathVariable String aftersaleNo) {
        AftersaleDetailVO vo = aftersaleService.getAftersaleDetail(aftersaleNo);
        return Result.success(vo);
    }
    
    /**
     * å®¡æ ¸å”®åå•
     */
    @PostMapping("/{aftersaleNo}/approve")
    public Result<Void> approveAftersale(
            @PathVariable String aftersaleNo,
            @RequestParam Boolean approved,
            @RequestParam(required = false) String rejectReason) {
        
        aftersaleService.approveAftersale(aftersaleNo, approved, rejectReason);
        return Result.success();
    }
    
    /**
     * é€€è´§ç‰©æµ
     */
    @PostMapping("/{aftersaleNo}/logistics")
    public Result<Void> submitReturnLogistics(
            @PathVariable String aftersaleNo,
            @RequestBody @Valid ReturnLogisticsDTO dto) {
        
        aftersaleService.submitReturnLogistics(aftersaleNo, dto);
        return Result.success();
    }
}
```

## æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ

### 1. æ•°æ®åº“ä¼˜åŒ–
- **åˆ†åº“åˆ†è¡¨**ï¼šæŒ‰ç”¨æˆ·IDåˆ†åº“ï¼ŒæŒ‰æœˆä»½åˆ†è¡¨
- **è¯»å†™åˆ†ç¦»**ï¼šä¸»åº“å†™ï¼Œä»åº“è¯»
- **ç´¢å¼•ä¼˜åŒ–**ï¼šåˆç†å»ºç«‹ç´¢å¼•
- **å®šæœŸå½’æ¡£**ï¼šå½’æ¡£å†å²è®¢å•æ•°æ®

### 2. ç¼“å­˜ä¼˜åŒ–
- **è®¢å•ç¼“å­˜**ï¼šçƒ­ç‚¹è®¢å•ç¼“å­˜åˆ° Redis
- **å•†å“ä¿¡æ¯ç¼“å­˜**ï¼šå•†å“ä¿¡æ¯ã€åº“å­˜ç¼“å­˜
- **ç”¨æˆ·ä¿¡æ¯ç¼“å­˜**ï¼šç”¨æˆ·åŸºæœ¬ä¿¡æ¯ç¼“å­˜

### 3. å¼‚æ­¥åŒ–
- **æ¶ˆæ¯é˜Ÿåˆ—**ï¼šè®¢å•åˆ›å»ºã€æ”¯ä»˜æˆåŠŸç­‰äº‹ä»¶å¼‚æ­¥å¤„ç†
- **å»¶æ—¶æ¶ˆæ¯**ï¼šè®¢å•è¶…æ—¶è‡ªåŠ¨å–æ¶ˆ
- **å¼‚æ­¥é€šçŸ¥**ï¼šçŸ­ä¿¡ã€æ¨é€é€šçŸ¥å¼‚æ­¥å‘é€

### 4. é™æµé™çº§
- **æ¥å£é™æµ**ï¼šä½¿ç”¨ Sentinel é™æµ
- **æœåŠ¡é™çº§**ï¼šéæ ¸å¿ƒåŠŸèƒ½é™çº§
- **ç†”æ–­ä¿æŠ¤**ï¼šä¾èµ–æœåŠ¡ç†”æ–­

### 5. ç§’æ€ä¼˜åŒ–
- **Redis é¢„æ‰£åº“å­˜**ï¼šå‡å°‘æ•°æ®åº“å‹åŠ›
- **é˜Ÿåˆ—å‰Šå³°**ï¼šæ¶ˆæ¯é˜Ÿåˆ—å‰Šå³°
- **é™æµ**ï¼šæ¥å£é™æµ
- **ç¼“å­˜é¢„çƒ­**ï¼šæå‰åŠ è½½æ•°æ®åˆ°ç¼“å­˜

## æ€»ç»“

OMS è®¢å•ç®¡ç†ç³»ç»Ÿçš„æ ¸å¿ƒåœ¨äºï¼š
1. **é«˜å¹¶å‘å¤„ç†**ï¼šæ”¯æŒå¤§ä¿ƒã€ç§’æ€ç­‰é«˜å¹¶å‘åœºæ™¯
2. **æ•°æ®ä¸€è‡´æ€§**ï¼šç¡®ä¿è®¢å•æ•°æ®çš„å¼ºä¸€è‡´æ€§
3. **å¯é æ€§**ï¼šä¿è¯è®¢å•ä¸ä¸¢å¤±ã€ä¸é‡å¤
4. **å®æ—¶æ€§**ï¼šè®¢å•çŠ¶æ€å®æ—¶æ›´æ–°
5. **å¯æ‰©å±•æ€§**ï¼šæ”¯æŒå¤šæ¸ é“ã€å¤šä»“åº“æ‰©å±•

æœ¬è®¾è®¡æ–¹æ¡ˆåŸºäº Spring Cloud å¾®æœåŠ¡æ¶æ„ï¼Œé‡‡ç”¨åˆ†åº“åˆ†è¡¨ã€ç¼“å­˜ã€æ¶ˆæ¯é˜Ÿåˆ—ç­‰æŠ€æœ¯ï¼Œå¯æ»¡è¶³ç”µå•†å¹³å°çš„è®¢å•ç®¡ç†éœ€æ±‚ã€‚

