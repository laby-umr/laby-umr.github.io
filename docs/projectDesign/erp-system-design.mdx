---
sidebar_position: 3
title: ERP ä¼ä¸šèµ„æºè§„åˆ’ç³»ç»Ÿè®¾è®¡
description: åŸºäº Spring Cloud çš„ä¼ä¸šèµ„æºè§„åˆ’ç³»ç»Ÿå®Œæ•´è®¾è®¡æ–¹æ¡ˆ
tags: [ERP, ä¼ä¸šç®¡ç†, Spring Cloud, å¾®æœåŠ¡, ç³»ç»Ÿè®¾è®¡]
---

# ERP ä¼ä¸šèµ„æºè§„åˆ’ç³»ç»Ÿè®¾è®¡

## ä¸€ã€ç³»ç»Ÿæ¦‚è¿°

### 1.1 ç³»ç»Ÿç®€ä»‹

ERPï¼ˆEnterprise Resource Planningï¼‰ä¼ä¸šèµ„æºè§„åˆ’ç³»ç»Ÿæ˜¯ä¸€ä¸ªé›†æˆåŒ–çš„ä¼ä¸šç®¡ç†ç³»ç»Ÿï¼Œæ•´åˆä¼ä¸šçš„è´¢åŠ¡ã€é‡‡è´­ã€ç”Ÿäº§ã€é”€å”®ã€åº“å­˜ã€äººåŠ›èµ„æºç­‰æ ¸å¿ƒä¸šåŠ¡æµç¨‹ï¼Œå®ç°ä¼ä¸šèµ„æºçš„ä¼˜åŒ–é…ç½®å’Œé«˜æ•ˆåˆ©ç”¨ã€‚

### 1.2 æ ¸å¿ƒä»·å€¼

| ä»·å€¼ç‚¹ | è¯´æ˜ | é¢„æœŸæ•ˆæœ |
|--------|------|----------|
| ğŸ¯ **æµç¨‹æ•´åˆ** | æ‰“é€šä¼ä¸šå…¨ä¸šåŠ¡æµç¨‹ | æµç¨‹æ•ˆç‡æå‡ 50% |
| ğŸ“Š **æ•°æ®ç»Ÿä¸€** | å»ºç«‹ç»Ÿä¸€æ•°æ®ä¸­å¿ƒ | æ•°æ®å‡†ç¡®ç‡ 99.5% |
| ğŸ”„ **èµ„æºä¼˜åŒ–** | ä¼˜åŒ–èµ„æºé…ç½® | èµ„æºåˆ©ç”¨ç‡æå‡ 40% |
| ğŸ“ˆ **å†³ç­–æ”¯æŒ** | å®æ—¶æ•°æ®åˆ†æ | å†³ç­–æ•ˆç‡æå‡ 45% |
| ğŸš€ **æˆæœ¬æ§åˆ¶** | ç²¾ç»†åŒ–æˆæœ¬ç®¡ç† | æˆæœ¬é™ä½ 30% |

### 1.3 ä¸šåŠ¡éœ€æ±‚

#### æ ¸å¿ƒåŠŸèƒ½æ¨¡å—
- **è´¢åŠ¡ç®¡ç†**ï¼šæ€»è´¦ã€åº”æ”¶åº”ä»˜ã€æˆæœ¬æ ¸ç®—ã€èµ„äº§ç®¡ç†
- **é‡‡è´­ç®¡ç†**ï¼šé‡‡è´­ç”³è¯·ã€é‡‡è´­è®¢å•ã€ä¾›åº”å•†ç®¡ç†ã€åˆ°è´§éªŒæ”¶
- **é”€å”®ç®¡ç†**ï¼šé”€å”®è®¢å•ã€é”€å”®å‡ºåº“ã€å®¢æˆ·ç®¡ç†ã€é”€å”®åˆ†æ
- **åº“å­˜ç®¡ç†**ï¼šåº“å­˜ç®¡ç†ã€å‡ºå…¥åº“ç®¡ç†ã€åº“å­˜ç›˜ç‚¹ã€åº“å­˜é¢„è­¦
- **ç”Ÿäº§ç®¡ç†**ï¼šç”Ÿäº§è®¡åˆ’ã€ç”Ÿäº§è®¢å•ã€ç‰©æ–™éœ€æ±‚ã€ç”Ÿäº§ç»Ÿè®¡
- **äººåŠ›èµ„æº**ï¼šå‘˜å·¥ç®¡ç†ã€è€ƒå‹¤ç®¡ç†ã€è–ªèµ„ç®¡ç†ã€ç»©æ•ˆç®¡ç†
- **åŸºç¡€æ•°æ®**ï¼šç»„ç»‡æ¶æ„ã€æƒé™ç®¡ç†ã€å‚æ•°é…ç½®

#### éåŠŸèƒ½éœ€æ±‚
- **é«˜å¯ç”¨æ€§**ï¼šç³»ç»Ÿå¯ç”¨æ€§ 99.9%
- **æ•°æ®ä¸€è‡´æ€§**ï¼šç¡®ä¿å„æ¨¡å—æ•°æ®ä¸€è‡´æ€§
- **æƒé™å®‰å…¨**ï¼šä¸¥æ ¼çš„æƒé™æ§åˆ¶ä½“ç³»
- **æ€§èƒ½è¦æ±‚**ï¼šæ”¯æŒ 2000+ å¹¶å‘ç”¨æˆ·
- **æ‰©å±•æ€§**ï¼šæ”¯æŒå¤šç»„ç»‡ã€å¤šå·¥å‚ã€å¤šå¸ç§

---

## äºŒã€ç³»ç»Ÿæ¶æ„

### 2.1 æŠ€æœ¯æ¶æ„

```mermaid
graph TB
    subgraph Client["ğŸ’» å®¢æˆ·ç«¯å±‚"]
        Web["Web ç®¡ç†ç«¯<br/>(Vue3 + Element Plus)"]
        Mobile["ç§»åŠ¨ç«¯<br/>(UniApp)"]
        MiniProgram["å°ç¨‹åº<br/>(å¾®ä¿¡/é’‰é’‰)"]
    end

    subgraph Gateway["ğŸŒ ç½‘å…³å±‚"]
        SpringGW["Spring Cloud Gateway<br/>â€¢ OAuth2 è®¤è¯<br/>â€¢ é™æµç†”æ–­<br/>â€¢ è·¯ç”±è½¬å‘"]
    end

    subgraph Business["âš™ï¸ ä¸šåŠ¡æœåŠ¡å±‚"]
        Finance["è´¢åŠ¡æœåŠ¡<br/>finance-service"]
        Purchase["é‡‡è´­æœåŠ¡<br/>purchase-service"]
        Sales["é”€å”®æœåŠ¡<br/>sales-service"]
        Inventory["åº“å­˜æœåŠ¡<br/>inventory-service"]
        Production["ç”Ÿäº§æœåŠ¡<br/>production-service"]
        HR["äººåŠ›èµ„æº<br/>hr-service"]
        Base["åŸºç¡€æœåŠ¡<br/>base-service"]
    end

    subgraph Infrastructure["ğŸ”§ åŸºç¡€è®¾æ–½å±‚"]
        subgraph Registry["æ³¨å†Œä¸­å¿ƒ"]
            Nacos["Nacos<br/>æœåŠ¡æ³¨å†Œä¸å‘ç°"]
        end
        
        subgraph Message["æ¶ˆæ¯é˜Ÿåˆ—"]
            RabbitMQ["RabbitMQ<br/>å¼‚æ­¥æ¶ˆæ¯"]
        end
        
        subgraph Job["å®šæ—¶ä»»åŠ¡"]
            XXLJob["XXL-Job<br/>ä»»åŠ¡è°ƒåº¦"]
        end
        
        subgraph Search["æœç´¢å¼•æ“"]
            ES["Elasticsearch<br/>å…¨æ–‡æ£€ç´¢"]
        end
    end

    subgraph Data["ğŸ’¾ æ•°æ®å±‚"]
        MySQL["MySQL<br/>ä¸šåŠ¡æ•°æ®"]
        PostgreSQL["PostgreSQL<br/>ä¸»æ•°æ®"]
        MongoDB["MongoDB<br/>æ—¥å¿—æ•°æ®"]
        Redis["Redis<br/>ç¼“å­˜"]
        ClickHouse["ClickHouse<br/>æ•°æ®åˆ†æ"]
        MinIO["MinIO<br/>æ–‡ä»¶å­˜å‚¨"]
    end

    %% è¿æ¥å…³ç³»
    Web --> SpringGW
    Mobile --> SpringGW
    MiniProgram --> SpringGW
    
    SpringGW --> Finance
    SpringGW --> Purchase
    SpringGW --> Sales
    SpringGW --> Inventory
    SpringGW --> Production
    SpringGW --> HR
    SpringGW --> Base
    
    Finance --> Nacos
    Purchase --> Nacos
    Sales --> Nacos
    Inventory --> Nacos
    Production --> Nacos
    HR --> Nacos
    Base --> Nacos
    
    Finance --> RabbitMQ
    Purchase --> RabbitMQ
    Sales --> RabbitMQ
    Production --> RabbitMQ
    
    Production --> XXLJob
    HR --> XXLJob
    
    Finance --> ES
    Purchase --> ES
    
    Finance --> MySQL
    Purchase --> MySQL
    Sales --> MySQL
    Inventory --> MySQL
    Production --> MySQL
    HR --> PostgreSQL
    
    Finance --> Redis
    Finance --> ClickHouse
    Base --> MinIO
    Production --> MongoDB

    %% æ ·å¼å®šä¹‰
    classDef clientStyle fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef gatewayStyle fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef serviceStyle fill:#e8f5e9,stroke:#388e3c,stroke-width:2px
    classDef infraStyle fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef dataStyle fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    
    class Web,Mobile,MiniProgram clientStyle
    class SpringGW gatewayStyle
    class Finance,Purchase,Sales,Inventory,Production,HR,Base serviceStyle
    class Nacos,RabbitMQ,XXLJob,ES infraStyle
    class MySQL,PostgreSQL,MongoDB,Redis,ClickHouse,MinIO dataStyle
```

### 2.2 é‡‡è´­åˆ°ä»˜æ¬¾æµç¨‹

```mermaid
flowchart LR
    Start([é‡‡è´­éœ€æ±‚]) --> PR[é‡‡è´­ç”³è¯·]
    PR --> Approve1{å®¡æ‰¹}
    Approve1 -->|é€šè¿‡| PO[é‡‡è´­è®¢å•]
    Approve1 -->|é©³å›| End1([ç»“æŸ])
    
    PO --> Supplier[å‘é€ä¾›åº”å•†]
    Supplier --> GR[åˆ°è´§éªŒæ”¶]
    
    GR --> QC{è´¨æ£€}
    QC -->|åˆæ ¼| Stock[å…¥åº“]
    QC -->|ä¸åˆæ ¼| Return[é€€è´§]
    
    Stock --> Invoice[æ”¶åˆ°å‘ç¥¨]
    Invoice --> AP[åº”ä»˜è´¦æ¬¾]
    AP --> Payment[ä»˜æ¬¾]
    Payment --> End2([å®Œæˆ])
    
    Return --> End3([é€€è´§å¤„ç†])
    
    style Start fill:#e8f5e9
    style End2 fill:#c8e6c9
    style Payment fill:#4caf50,color:#fff
```

### å¾®æœåŠ¡åˆ’åˆ†

#### 1. åŸºç¡€æœåŠ¡ (erp-base-service)
```java
- ç»„ç»‡ç®¡ç† (Organization)
- éƒ¨é—¨ç®¡ç† (Department)
- ç”¨æˆ·ç®¡ç† (User)
- è§’è‰²æƒé™ (Role & Permission)
- æ•°æ®å­—å…¸ (Dictionary)
- ç³»ç»Ÿå‚æ•° (System Config)
```

#### 2. è´¢åŠ¡æœåŠ¡ (erp-finance-service)
```java
- æ€»è´¦ç®¡ç† (General Ledger)
- åº”æ”¶è´¦æ¬¾ (Accounts Receivable)
- åº”ä»˜è´¦æ¬¾ (Accounts Payable)
- æˆæœ¬æ ¸ç®— (Cost Accounting)
- èµ„äº§ç®¡ç† (Asset Management)
- æŠ¥è¡¨ç®¡ç† (Financial Report)
```

#### 3. é‡‡è´­æœåŠ¡ (erp-purchase-service)
```java
- é‡‡è´­ç”³è¯· (Purchase Request)
- é‡‡è´­è®¢å• (Purchase Order)
- ä¾›åº”å•†ç®¡ç† (Supplier)
- åˆ°è´§éªŒæ”¶ (Goods Receipt)
- é‡‡è´­é€€è´§ (Purchase Return)
```

#### 4. é”€å”®æœåŠ¡ (erp-sales-service)
```java
- é”€å”®è®¢å• (Sales Order)
- é”€å”®å‡ºåº“ (Sales Delivery)
- é”€å”®é€€è´§ (Sales Return)
- å®¢æˆ·ç®¡ç† (Customer)
- ä»·æ ¼ç®¡ç† (Pricing)
- ä¿¡ç”¨ç®¡ç† (Credit Management)
```

#### 5. åº“å­˜æœåŠ¡ (erp-inventory-service)
```java
- åº“å­˜ç®¡ç† (Inventory)
- å‡ºå…¥åº“ç®¡ç† (Inbound/Outbound)
- åº“å­˜è°ƒæ‹¨ (Transfer)
- åº“å­˜ç›˜ç‚¹ (Stock Taking)
- æ‰¹æ¬¡ç®¡ç† (Batch Management)
```

#### 6. ç”Ÿäº§æœåŠ¡ (erp-production-service)
```java
- ç”Ÿäº§è®¡åˆ’ (Production Plan)
- ç”Ÿäº§è®¢å• (Production Order)
- ç‰©æ–™æ¸…å• (BOM)
- å·¥è‰ºè·¯çº¿ (Routing)
- ç”Ÿäº§é¢†æ–™ (Material Issue)
- ç”Ÿäº§å…¥åº“ (Production Receipt)
```

#### 7. äººåŠ›èµ„æºæœåŠ¡ (erp-hr-service)
```java
- å‘˜å·¥ç®¡ç† (Employee)
- è€ƒå‹¤ç®¡ç† (Attendance)
- è–ªèµ„ç®¡ç† (Payroll)
- ç»©æ•ˆç®¡ç† (Performance)
- æ‹›è˜ç®¡ç† (Recruitment)
```

## æ•°æ®æ¨¡å‹è®¾è®¡

### æ ¸å¿ƒè¡¨ç»“æ„

#### 1. ç»„ç»‡è¡¨ (organization)
```sql
CREATE TABLE organization (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    org_code VARCHAR(50) NOT NULL UNIQUE COMMENT 'ç»„ç»‡ç¼–ç ',
    org_name VARCHAR(200) NOT NULL COMMENT 'ç»„ç»‡åç§°',
    parent_id BIGINT COMMENT 'çˆ¶ç»„ç»‡ID',
    org_type TINYINT NOT NULL COMMENT 'ç»„ç»‡ç±»å‹:1-é›†å›¢,2-å…¬å¸,3-å·¥å‚,4-éƒ¨é—¨',
    level INT NOT NULL COMMENT 'å±‚çº§',
    sort_order INT DEFAULT 0 COMMENT 'æ’åº',
    contact_person VARCHAR(50) COMMENT 'è”ç³»äºº',
    contact_phone VARCHAR(20) COMMENT 'è”ç³»ç”µè¯',
    address VARCHAR(200) COMMENT 'åœ°å€',
    status TINYINT DEFAULT 1 COMMENT 'çŠ¶æ€:1-å¯ç”¨,0-ç¦ç”¨',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_parent (parent_id),
    INDEX idx_code (org_code)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç»„ç»‡è¡¨';
```

#### 2. é‡‡è´­è®¢å•è¡¨ (purchase_order)
```sql
CREATE TABLE purchase_order (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    order_no VARCHAR(50) NOT NULL UNIQUE COMMENT 'é‡‡è´­å•å·',
    org_id BIGINT NOT NULL COMMENT 'ç»„ç»‡ID',
    supplier_id BIGINT NOT NULL COMMENT 'ä¾›åº”å•†ID',
    order_date DATE NOT NULL COMMENT 'è®¢å•æ—¥æœŸ',
    expected_date DATE COMMENT 'æœŸæœ›åˆ°è´§æ—¥æœŸ',
    order_type TINYINT DEFAULT 1 COMMENT 'è®¢å•ç±»å‹:1-æ ‡å‡†é‡‡è´­,2-ç´§æ€¥é‡‡è´­,3-å§”å¤–åŠ å·¥',
    total_amount DECIMAL(15,2) NOT NULL DEFAULT 0 COMMENT 'è®¢å•æ€»é¢',
    tax_amount DECIMAL(15,2) DEFAULT 0 COMMENT 'ç¨é¢',
    discount_amount DECIMAL(15,2) DEFAULT 0 COMMENT 'æŠ˜æ‰£é‡‘é¢',
    final_amount DECIMAL(15,2) NOT NULL COMMENT 'æœ€ç»ˆé‡‘é¢',
    currency_code VARCHAR(10) DEFAULT 'CNY' COMMENT 'å¸ç§',
    payment_term VARCHAR(100) COMMENT 'ä»˜æ¬¾æ¡ä»¶',
    delivery_address VARCHAR(200) COMMENT 'æ”¶è´§åœ°å€',
    status TINYINT DEFAULT 1 COMMENT 'çŠ¶æ€:1-è‰ç¨¿,2-å¾…å®¡æ‰¹,3-å®¡æ‰¹ä¸­,4-å·²å®¡æ‰¹,5-æ‰§è¡Œä¸­,6-å·²å®Œæˆ,7-å·²å–æ¶ˆ',
    buyer_id BIGINT COMMENT 'é‡‡è´­å‘˜ID',
    approver_id BIGINT COMMENT 'å®¡æ‰¹äººID',
    approve_time DATETIME COMMENT 'å®¡æ‰¹æ—¶é—´',
    remark VARCHAR(500) COMMENT 'å¤‡æ³¨',
    create_user_id BIGINT COMMENT 'åˆ›å»ºäººID',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_order_no (order_no),
    INDEX idx_supplier (supplier_id),
    INDEX idx_status (status),
    INDEX idx_order_date (order_date)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='é‡‡è´­è®¢å•è¡¨';
```

#### 3. é‡‡è´­è®¢å•æ˜ç»†è¡¨ (purchase_order_detail)
```sql
CREATE TABLE purchase_order_detail (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    order_id BIGINT NOT NULL COMMENT 'é‡‡è´­å•ID',
    line_no INT NOT NULL COMMENT 'è¡Œå·',
    product_id BIGINT NOT NULL COMMENT 'ç‰©æ–™ID',
    product_code VARCHAR(50) NOT NULL COMMENT 'ç‰©æ–™ç¼–ç ',
    product_name VARCHAR(200) NOT NULL COMMENT 'ç‰©æ–™åç§°',
    spec VARCHAR(200) COMMENT 'è§„æ ¼',
    unit VARCHAR(20) COMMENT 'å•ä½',
    quantity DECIMAL(10,2) NOT NULL COMMENT 'æ•°é‡',
    unit_price DECIMAL(10,4) NOT NULL COMMENT 'å•ä»·',
    tax_rate DECIMAL(5,2) DEFAULT 0 COMMENT 'ç¨ç‡(%)',
    amount DECIMAL(15,2) NOT NULL COMMENT 'é‡‘é¢',
    received_quantity DECIMAL(10,2) DEFAULT 0 COMMENT 'å·²æ”¶è´§æ•°é‡',
    invoiced_quantity DECIMAL(10,2) DEFAULT 0 COMMENT 'å·²å¼€ç¥¨æ•°é‡',
    expected_date DATE COMMENT 'æœŸæœ›åˆ°è´§æ—¥æœŸ',
    warehouse_id BIGINT COMMENT 'æ”¶è´§ä»“åº“ID',
    location_id BIGINT COMMENT 'æ”¶è´§åº“ä½ID',
    remark VARCHAR(500) COMMENT 'å¤‡æ³¨',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_order (order_id),
    INDEX idx_product (product_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='é‡‡è´­è®¢å•æ˜ç»†è¡¨';
```

#### 4. é”€å”®è®¢å•è¡¨ (sales_order)
```sql
CREATE TABLE sales_order (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    order_no VARCHAR(50) NOT NULL UNIQUE COMMENT 'é”€å”®å•å·',
    org_id BIGINT NOT NULL COMMENT 'ç»„ç»‡ID',
    customer_id BIGINT NOT NULL COMMENT 'å®¢æˆ·ID',
    order_date DATE NOT NULL COMMENT 'è®¢å•æ—¥æœŸ',
    delivery_date DATE COMMENT 'è¦æ±‚äº¤è´§æ—¥æœŸ',
    order_type TINYINT DEFAULT 1 COMMENT 'è®¢å•ç±»å‹:1-æ ‡å‡†é”€å”®,2-é¢„å”®,3-æ ·å“',
    total_amount DECIMAL(15,2) NOT NULL DEFAULT 0 COMMENT 'è®¢å•æ€»é¢',
    tax_amount DECIMAL(15,2) DEFAULT 0 COMMENT 'ç¨é¢',
    discount_amount DECIMAL(15,2) DEFAULT 0 COMMENT 'æŠ˜æ‰£é‡‘é¢',
    final_amount DECIMAL(15,2) NOT NULL COMMENT 'æœ€ç»ˆé‡‘é¢',
    currency_code VARCHAR(10) DEFAULT 'CNY' COMMENT 'å¸ç§',
    payment_term VARCHAR(100) COMMENT 'ä»˜æ¬¾æ¡ä»¶',
    delivery_address VARCHAR(200) COMMENT 'äº¤è´§åœ°å€',
    contact_person VARCHAR(50) COMMENT 'è”ç³»äºº',
    contact_phone VARCHAR(20) COMMENT 'è”ç³»ç”µè¯',
    status TINYINT DEFAULT 1 COMMENT 'çŠ¶æ€:1-è‰ç¨¿,2-å¾…å®¡æ‰¹,3-å®¡æ‰¹ä¸­,4-å·²å®¡æ‰¹,5-æ‰§è¡Œä¸­,6-å·²å®Œæˆ,7-å·²å–æ¶ˆ',
    sales_person_id BIGINT COMMENT 'é”€å”®å‘˜ID',
    approver_id BIGINT COMMENT 'å®¡æ‰¹äººID',
    approve_time DATETIME COMMENT 'å®¡æ‰¹æ—¶é—´',
    remark VARCHAR(500) COMMENT 'å¤‡æ³¨',
    create_user_id BIGINT COMMENT 'åˆ›å»ºäººID',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_order_no (order_no),
    INDEX idx_customer (customer_id),
    INDEX idx_status (status),
    INDEX idx_order_date (order_date)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='é”€å”®è®¢å•è¡¨';
```

#### 5. ç”Ÿäº§è®¢å•è¡¨ (production_order)
```sql
CREATE TABLE production_order (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    order_no VARCHAR(50) NOT NULL UNIQUE COMMENT 'ç”Ÿäº§å•å·',
    org_id BIGINT NOT NULL COMMENT 'ç»„ç»‡ID',
    workshop_id BIGINT COMMENT 'è½¦é—´ID',
    product_id BIGINT NOT NULL COMMENT 'äº§å“ID',
    product_code VARCHAR(50) NOT NULL COMMENT 'äº§å“ç¼–ç ',
    product_name VARCHAR(200) NOT NULL COMMENT 'äº§å“åç§°',
    spec VARCHAR(200) COMMENT 'è§„æ ¼',
    unit VARCHAR(20) COMMENT 'å•ä½',
    plan_quantity DECIMAL(10,2) NOT NULL COMMENT 'è®¡åˆ’æ•°é‡',
    actual_quantity DECIMAL(10,2) DEFAULT 0 COMMENT 'å®é™…å®Œå·¥æ•°é‡',
    qualified_quantity DECIMAL(10,2) DEFAULT 0 COMMENT 'åˆæ ¼æ•°é‡',
    defective_quantity DECIMAL(10,2) DEFAULT 0 COMMENT 'ä¸åˆæ ¼æ•°é‡',
    bom_id BIGINT COMMENT 'BOM ID',
    routing_id BIGINT COMMENT 'å·¥è‰ºè·¯çº¿ID',
    plan_start_date DATE NOT NULL COMMENT 'è®¡åˆ’å¼€å§‹æ—¥æœŸ',
    plan_end_date DATE NOT NULL COMMENT 'è®¡åˆ’å®Œæˆæ—¥æœŸ',
    actual_start_date DATE COMMENT 'å®é™…å¼€å§‹æ—¥æœŸ',
    actual_end_date DATE COMMENT 'å®é™…å®Œæˆæ—¥æœŸ',
    source_type TINYINT COMMENT 'æ¥æºç±»å‹:1-é”€å”®è®¢å•,2-åº“å­˜è¡¥è´§,3-å…¶ä»–',
    source_no VARCHAR(50) COMMENT 'æ¥æºå•å·',
    priority TINYINT DEFAULT 0 COMMENT 'ä¼˜å…ˆçº§:0-æ™®é€š,1-é‡è¦,2-ç´§æ€¥',
    status TINYINT DEFAULT 1 COMMENT 'çŠ¶æ€:1-è®¡åˆ’,2-å·²ä¸‹è¾¾,3-ç”Ÿäº§ä¸­,4-å·²å®Œå·¥,5-å·²å…¥åº“,6-å·²å–æ¶ˆ',
    manager_id BIGINT COMMENT 'ç”Ÿäº§è´Ÿè´£äººID',
    remark VARCHAR(500) COMMENT 'å¤‡æ³¨',
    create_user_id BIGINT COMMENT 'åˆ›å»ºäººID',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_order_no (order_no),
    INDEX idx_product (product_id),
    INDEX idx_status (status),
    INDEX idx_plan_date (plan_start_date, plan_end_date)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç”Ÿäº§è®¢å•è¡¨';
```

#### 6. ç‰©æ–™æ¸…å•è¡¨ (bom)
```sql
CREATE TABLE bom (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    bom_no VARCHAR(50) NOT NULL UNIQUE COMMENT 'BOMç¼–å·',
    product_id BIGINT NOT NULL COMMENT 'äº§å“ID',
    product_code VARCHAR(50) NOT NULL COMMENT 'äº§å“ç¼–ç ',
    product_name VARCHAR(200) NOT NULL COMMENT 'äº§å“åç§°',
    version VARCHAR(20) NOT NULL COMMENT 'ç‰ˆæœ¬',
    bom_type TINYINT DEFAULT 1 COMMENT 'BOMç±»å‹:1-æ ‡å‡†BOM,2-é…ç½®BOM,3-é”€å”®BOM',
    is_current TINYINT DEFAULT 0 COMMENT 'æ˜¯å¦å½“å‰ç‰ˆæœ¬:0-å¦,1-æ˜¯',
    effective_date DATE COMMENT 'ç”Ÿæ•ˆæ—¥æœŸ',
    expire_date DATE COMMENT 'å¤±æ•ˆæ—¥æœŸ',
    status TINYINT DEFAULT 1 COMMENT 'çŠ¶æ€:1-è‰ç¨¿,2-å·²å®¡æ‰¹,3-å·²å¤±æ•ˆ',
    remark VARCHAR(500) COMMENT 'å¤‡æ³¨',
    create_user_id BIGINT COMMENT 'åˆ›å»ºäººID',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_product_version (product_id, version),
    INDEX idx_bom_no (bom_no),
    INDEX idx_product (product_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç‰©æ–™æ¸…å•è¡¨';
```

#### 7. ç‰©æ–™æ¸…å•æ˜ç»†è¡¨ (bom_detail)
```sql
CREATE TABLE bom_detail (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    bom_id BIGINT NOT NULL COMMENT 'BOM ID',
    line_no INT NOT NULL COMMENT 'è¡Œå·',
    material_id BIGINT NOT NULL COMMENT 'ç‰©æ–™ID',
    material_code VARCHAR(50) NOT NULL COMMENT 'ç‰©æ–™ç¼–ç ',
    material_name VARCHAR(200) NOT NULL COMMENT 'ç‰©æ–™åç§°',
    spec VARCHAR(200) COMMENT 'è§„æ ¼',
    unit VARCHAR(20) COMMENT 'å•ä½',
    quantity DECIMAL(10,4) NOT NULL COMMENT 'ç”¨é‡',
    loss_rate DECIMAL(5,2) DEFAULT 0 COMMENT 'æŸè€—ç‡(%)',
    is_key_material TINYINT DEFAULT 0 COMMENT 'æ˜¯å¦å…³é”®ç‰©æ–™:0-å¦,1-æ˜¯',
    substitute_group VARCHAR(20) COMMENT 'æ›¿ä»£ç»„',
    remark VARCHAR(500) COMMENT 'å¤‡æ³¨',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_bom (bom_id),
    INDEX idx_material (material_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç‰©æ–™æ¸…å•æ˜ç»†è¡¨';
```

#### 8. ä¼šè®¡ç§‘ç›®è¡¨ (account)
```sql
CREATE TABLE account (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    account_code VARCHAR(50) NOT NULL UNIQUE COMMENT 'ç§‘ç›®ç¼–ç ',
    account_name VARCHAR(200) NOT NULL COMMENT 'ç§‘ç›®åç§°',
    parent_id BIGINT COMMENT 'çˆ¶ç§‘ç›®ID',
    level INT NOT NULL COMMENT 'å±‚çº§',
    account_type TINYINT NOT NULL COMMENT 'ç§‘ç›®ç±»å‹:1-èµ„äº§,2-è´Ÿå€º,3-æƒç›Š,4-æˆæœ¬,5-æŸç›Š',
    balance_direction TINYINT NOT NULL COMMENT 'ä½™é¢æ–¹å‘:1-å€Ÿæ–¹,2-è´·æ–¹',
    is_leaf TINYINT DEFAULT 0 COMMENT 'æ˜¯å¦æœ«çº§:0-å¦,1-æ˜¯',
    is_cash TINYINT DEFAULT 0 COMMENT 'æ˜¯å¦ç°é‡‘ç§‘ç›®:0-å¦,1-æ˜¯',
    is_bank TINYINT DEFAULT 0 COMMENT 'æ˜¯å¦é“¶è¡Œç§‘ç›®:0-å¦,1-æ˜¯',
    status TINYINT DEFAULT 1 COMMENT 'çŠ¶æ€:1-å¯ç”¨,0-ç¦ç”¨',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_code (account_code),
    INDEX idx_parent (parent_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ä¼šè®¡ç§‘ç›®è¡¨';
```

#### 9. å‡­è¯è¡¨ (voucher)
```sql
CREATE TABLE voucher (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    voucher_no VARCHAR(50) NOT NULL UNIQUE COMMENT 'å‡­è¯å·',
    org_id BIGINT NOT NULL COMMENT 'ç»„ç»‡ID',
    voucher_date DATE NOT NULL COMMENT 'å‡­è¯æ—¥æœŸ',
    period VARCHAR(7) NOT NULL COMMENT 'ä¼šè®¡æœŸé—´(YYYY-MM)',
    voucher_type TINYINT DEFAULT 1 COMMENT 'å‡­è¯ç±»å‹:1-è®°è´¦å‡­è¯,2-æ”¶æ¬¾å‡­è¯,3-ä»˜æ¬¾å‡­è¯,4-è½¬è´¦å‡­è¯',
    total_debit DECIMAL(15,2) NOT NULL COMMENT 'å€Ÿæ–¹åˆè®¡',
    total_credit DECIMAL(15,2) NOT NULL COMMENT 'è´·æ–¹åˆè®¡',
    attachment_count INT DEFAULT 0 COMMENT 'é™„ä»¶æ•°é‡',
    status TINYINT DEFAULT 1 COMMENT 'çŠ¶æ€:1-è‰ç¨¿,2-å·²å®¡æ ¸,3-å·²è®°è´¦',
    maker_id BIGINT COMMENT 'åˆ¶å•äººID',
    checker_id BIGINT COMMENT 'å®¡æ ¸äººID',
    check_time DATETIME COMMENT 'å®¡æ ¸æ—¶é—´',
    poster_id BIGINT COMMENT 'è®°è´¦äººID',
    post_time DATETIME COMMENT 'è®°è´¦æ—¶é—´',
    remark VARCHAR(500) COMMENT 'å¤‡æ³¨',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_voucher_no (voucher_no),
    INDEX idx_org_period (org_id, period),
    INDEX idx_date (voucher_date)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='å‡­è¯è¡¨';
```

#### 10. å‡­è¯æ˜ç»†è¡¨ (voucher_detail)
```sql
CREATE TABLE voucher_detail (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    voucher_id BIGINT NOT NULL COMMENT 'å‡­è¯ID',
    line_no INT NOT NULL COMMENT 'è¡Œå·',
    account_id BIGINT NOT NULL COMMENT 'ç§‘ç›®ID',
    account_code VARCHAR(50) NOT NULL COMMENT 'ç§‘ç›®ç¼–ç ',
    account_name VARCHAR(200) NOT NULL COMMENT 'ç§‘ç›®åç§°',
    summary VARCHAR(500) COMMENT 'æ‘˜è¦',
    debit_amount DECIMAL(15,2) DEFAULT 0 COMMENT 'å€Ÿæ–¹é‡‘é¢',
    credit_amount DECIMAL(15,2) DEFAULT 0 COMMENT 'è´·æ–¹é‡‘é¢',
    currency_code VARCHAR(10) DEFAULT 'CNY' COMMENT 'å¸ç§',
    exchange_rate DECIMAL(10,4) DEFAULT 1 COMMENT 'æ±‡ç‡',
    auxiliary_type VARCHAR(20) COMMENT 'è¾…åŠ©æ ¸ç®—ç±»å‹',
    auxiliary_id BIGINT COMMENT 'è¾…åŠ©æ ¸ç®—ID',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_voucher (voucher_id),
    INDEX idx_account (account_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='å‡­è¯æ˜ç»†è¡¨';
```

## æ ¸å¿ƒä¸šåŠ¡æµç¨‹

### 1. é‡‡è´­åˆ°ä»˜æ¬¾æµç¨‹ (P2P)

```
é‡‡è´­ç”³è¯· â†’ é‡‡è´­è®¢å• â†’ åˆ°è´§éªŒæ”¶ â†’ é‡‡è´­å…¥åº“ â†’ é‡‡è´­å‘ç¥¨ â†’ ä»˜æ¬¾
    â†“         â†“          â†“          â†“          â†“         â†“
  (å¾…å®¡æ‰¹)  (å¾…æ‰§è¡Œ)    (å¾…éªŒæ”¶)    (å¾…å…¥åº“)   (å¾…ä»˜æ¬¾)   (å·²å®Œæˆ)
```

**å…³é”®æ­¥éª¤**ï¼š
1. åˆ›å»ºé‡‡è´­ç”³è¯·ï¼ˆéœ€æ±‚éƒ¨é—¨å‘èµ·ï¼‰
2. é‡‡è´­ç”³è¯·å®¡æ‰¹
3. åˆ›å»ºé‡‡è´­è®¢å•ï¼ˆé‡‡è´­éƒ¨é—¨ï¼‰
4. é‡‡è´­è®¢å•å®¡æ‰¹
5. åˆ°è´§éªŒæ”¶ï¼ˆè´¨æ£€éƒ¨é—¨ï¼‰
6. é‡‡è´­å…¥åº“ï¼ˆä»“åº“ï¼‰
7. é‡‡è´­å‘ç¥¨å½•å…¥ï¼ˆè´¢åŠ¡ï¼‰
8. åº”ä»˜æ¬¾ç”Ÿæˆ
9. ä»˜æ¬¾å¤„ç†
10. ç”Ÿæˆä¼šè®¡å‡­è¯

### 2. è®¢å•åˆ°æ”¶æ¬¾æµç¨‹ (O2C)

```
é”€å”®è®¢å• â†’ é”€å”®å‘è´§ â†’ é”€å”®å‡ºåº“ â†’ é”€å”®å‘ç¥¨ â†’ æ”¶æ¬¾
    â†“         â†“          â†“          â†“         â†“
  (å¾…å®¡æ‰¹)  (å¾…å‘è´§)    (å¾…å‡ºåº“)    (å¾…æ”¶æ¬¾)   (å·²å®Œæˆ)
```

**å…³é”®æ­¥éª¤**ï¼š
1. åˆ›å»ºé”€å”®è®¢å•
2. é”€å”®è®¢å•å®¡æ‰¹
3. ä¿¡ç”¨æ£€æŸ¥
4. åº“å­˜é¢„ç•™
5. é”€å”®å‘è´§
6. é”€å”®å‡ºåº“
7. é”€å”®å‘ç¥¨å¼€å…·
8. åº”æ”¶æ¬¾ç”Ÿæˆ
9. æ”¶æ¬¾å¤„ç†
10. ç”Ÿæˆä¼šè®¡å‡­è¯

### 3. ç”Ÿäº§åˆ¶é€ æµç¨‹

```
ç”Ÿäº§è®¡åˆ’ â†’ ç‰©æ–™éœ€æ±‚ â†’ ç”Ÿäº§è®¢å• â†’ ç”Ÿäº§é¢†æ–™ â†’ ç”Ÿäº§æŠ¥å·¥ â†’ å®Œå·¥å…¥åº“
    â†“         â†“          â†“          â†“          â†“          â†“
  (è®¡åˆ’)   (éœ€æ±‚åˆ†æ)  (å·²ä¸‹è¾¾)    (ç”Ÿäº§ä¸­)   (å·²æŠ¥å·¥)   (å·²å®Œå·¥)
```

**å…³é”®æ­¥éª¤**ï¼š
1. åˆ¶å®šç”Ÿäº§è®¡åˆ’ï¼ˆæ ¹æ®é”€å”®è®¢å•æˆ–åº“å­˜è¡¥è´§ï¼‰
2. MRP è¿ç®—ï¼ˆç‰©æ–™éœ€æ±‚è®¡åˆ’ï¼‰
3. ç”Ÿæˆç”Ÿäº§è®¢å•
4. ç”Ÿäº§è®¢å•ä¸‹è¾¾
5. ç”Ÿäº§é¢†æ–™ï¼ˆä»ä»“åº“é¢†å–ç‰©æ–™ï¼‰
6. ç”Ÿäº§æŠ¥å·¥ï¼ˆè®°å½•ç”Ÿäº§è¿›åº¦ï¼‰
7. è´¨æ£€ï¼ˆæˆå“æ£€éªŒï¼‰
8. å®Œå·¥å…¥åº“
9. æˆæœ¬æ ¸ç®—

### 4. æœˆæœ«ç»“è´¦æµç¨‹

```
æœŸé—´æ£€æŸ¥ â†’ æˆæœ¬æ ¸ç®— â†’ æŸç›Šç»“è½¬ â†’ å‡­è¯å®¡æ ¸ â†’ è®°è´¦ â†’ ç»“è´¦
```

**å…³é”®æ­¥éª¤**ï¼š
1. æ£€æŸ¥æœŸé—´æ•°æ®å®Œæ•´æ€§
2. æˆæœ¬æ ¸ç®—ï¼ˆææ–™æˆæœ¬ã€äººå·¥æˆæœ¬ã€åˆ¶é€ è´¹ç”¨ï¼‰
3. è‡ªåŠ¨ç”Ÿæˆç»“è½¬å‡­è¯ï¼ˆæŸç›Šç»“è½¬ã€æˆæœ¬ç»“è½¬ï¼‰
4. å‡­è¯å®¡æ ¸
5. å‡­è¯è®°è´¦
6. æœˆæœ«ç»“è´¦
7. ç”Ÿæˆè´¢åŠ¡æŠ¥è¡¨

## æŠ€æœ¯å®ç°æ–¹æ¡ˆ

### 1. å·¥ä½œæµå¼•æ“ï¼ˆå®¡æ‰¹æµç¨‹ï¼‰

ä½¿ç”¨ **Flowable** å®ç°å®¡æ‰¹æµç¨‹ï¼š

```java
@Service
public class PurchaseOrderWorkflowService {
    
    @Autowired
    private RuntimeService runtimeService;
    
    @Autowired
    private TaskService taskService;
    
    /**
     * æäº¤é‡‡è´­è®¢å•å®¡æ‰¹
     */
    public void submitForApproval(Long orderId) {
        PurchaseOrder order = purchaseOrderMapper.selectById(orderId);
        
        // å¯åŠ¨æµç¨‹å®ä¾‹
        Map<String, Object> variables = new HashMap<>();
        variables.put("orderId", orderId);
        variables.put("orderAmount", order.getFinalAmount());
        variables.put("buyerId", order.getBuyerId());
        variables.put("orgId", order.getOrgId());
        
        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(
            "purchase_order_approval",
            order.getOrderNo(),
            variables
        );
        
        // æ›´æ–°è®¢å•çŠ¶æ€
        order.setStatus(OrderStatus.PENDING_APPROVAL);
        order.setProcessInstanceId(processInstance.getId());
        purchaseOrderMapper.updateById(order);
    }
    
    /**
     * å®¡æ‰¹é‡‡è´­è®¢å•
     */
    public void approveOrder(String taskId, Long userId, boolean approved, String comment) {
        // å®Œæˆä»»åŠ¡
        Map<String, Object> variables = new HashMap<>();
        variables.put("approved", approved);
        variables.put("approverId", userId);
        variables.put("comment", comment);
        
        taskService.complete(taskId, variables);
        
        // å¦‚æœå®¡æ‰¹é€šè¿‡ï¼Œæ›´æ–°è®¢å•çŠ¶æ€
        Task task = taskService.createTaskQuery().taskId(taskId).singleResult();
        String orderId = (String) runtimeService.getVariable(
            task.getProcessInstanceId(), 
            "orderId"
        );
        
        PurchaseOrder order = purchaseOrderMapper.selectById(Long.parseLong(orderId));
        if (approved) {
            order.setStatus(OrderStatus.APPROVED);
        } else {
            order.setStatus(OrderStatus.REJECTED);
        }
        purchaseOrderMapper.updateById(order);
    }
}
```

### 2. åˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆSeataï¼‰

ä½¿ç”¨ **Seata** å¤„ç†åˆ†å¸ƒå¼äº‹åŠ¡ï¼š

```java
@Service
public class SalesOrderService {
    
    @Autowired
    private SalesOrderMapper salesOrderMapper;
    
    @Autowired
    private InventoryServiceClient inventoryServiceClient;
    
    @Autowired
    private FinanceServiceClient financeServiceClient;
    
    /**
     * åˆ›å»ºé”€å”®è®¢å•ï¼ˆåˆ†å¸ƒå¼äº‹åŠ¡ï¼‰
     */
    @GlobalTransactional(name = "create-sales-order", rollbackFor = Exception.class)
    public Long createSalesOrder(SalesOrderDTO dto) {
        // 1. åˆ›å»ºé”€å”®è®¢å•
        SalesOrder order = new SalesOrder();
        BeanUtils.copyProperties(dto, order);
        order.setOrderNo(generateOrderNo());
        order.setStatus(OrderStatus.DRAFT);
        salesOrderMapper.insert(order);
        
        // 2. åˆ›å»ºè®¢å•æ˜ç»†
        for (SalesOrderDetailDTO detailDto : dto.getDetails()) {
            SalesOrderDetail detail = new SalesOrderDetail();
            BeanUtils.copyProperties(detailDto, detail);
            detail.setOrderId(order.getId());
            salesOrderDetailMapper.insert(detail);
            
            // 3. é¢„ç•™åº“å­˜ï¼ˆè°ƒç”¨åº“å­˜æœåŠ¡ï¼‰
            inventoryServiceClient.reserveInventory(
                detailDto.getProductId(),
                detailDto.getQuantity(),
                order.getOrderNo()
            );
        }
        
        // 4. ç”Ÿæˆåº”æ”¶æ¬¾ï¼ˆè°ƒç”¨è´¢åŠ¡æœåŠ¡ï¼‰
        financeServiceClient.createReceivable(
            order.getId(),
            order.getCustomerId(),
            order.getFinalAmount()
        );
        
        return order.getId();
    }
}
```

### 3. MRP ç‰©æ–™éœ€æ±‚è®¡åˆ’

```java
@Service
public class MrpService {
    
    @Autowired
    private ProductionOrderMapper productionOrderMapper;
    
    @Autowired
    private BomService bomService;
    
    @Autowired
    private InventoryService inventoryService;
    
    /**
     * MRP è¿ç®—
     */
    public List<MaterialRequirement> calculateMrp(LocalDate startDate, LocalDate endDate) {
        // 1. è·å–ç”Ÿäº§è®¡åˆ’
        List<ProductionOrder> orders = productionOrderMapper.selectByDateRange(
            startDate, 
            endDate
        );
        
        List<MaterialRequirement> requirements = new ArrayList<>();
        
        for (ProductionOrder order : orders) {
            // 2. è·å– BOM
            List<BomDetail> bomDetails = bomService.getBomDetails(order.getBomId());
            
            for (BomDetail detail : bomDetails) {
                // 3. è®¡ç®—ç‰©æ–™éœ€æ±‚
                BigDecimal requireQty = detail.getQuantity()
                    .multiply(order.getPlanQuantity())
                    .multiply(BigDecimal.ONE.add(detail.getLossRate().divide(new BigDecimal("100"))));
                
                // 4. æŸ¥è¯¢åº“å­˜
                BigDecimal availableQty = inventoryService.getAvailableQuantity(
                    order.getOrgId(),
                    detail.getMaterialId()
                );
                
                // 5. è®¡ç®—å‡€éœ€æ±‚
                BigDecimal netRequirement = requireQty.subtract(availableQty);
                
                if (netRequirement.compareTo(BigDecimal.ZERO) > 0) {
                    MaterialRequirement requirement = new MaterialRequirement();
                    requirement.setProductionOrderNo(order.getOrderNo());
                    requirement.setMaterialId(detail.getMaterialId());
                    requirement.setMaterialCode(detail.getMaterialCode());
                    requirement.setMaterialName(detail.getMaterialName());
                    requirement.setRequireQty(requireQty);
                    requirement.setAvailableQty(availableQty);
                    requirement.setNetRequirement(netRequirement);
                    requirement.setRequireDate(order.getPlanStartDate());
                    
                    requirements.add(requirement);
                }
            }
        }
        
        return requirements;
    }
}
```

### 4. æˆæœ¬æ ¸ç®—

```java
@Service
public class CostAccountingService {
    
    /**
     * äº§å“æˆæœ¬æ ¸ç®—
     */
    @Transactional
    public void calculateProductCost(Long productionOrderId) {
        ProductionOrder order = productionOrderMapper.selectById(productionOrderId);
        
        // 1. è®¡ç®—ç›´æ¥ææ–™æˆæœ¬
        BigDecimal materialCost = calculateMaterialCost(productionOrderId);
        
        // 2. è®¡ç®—ç›´æ¥äººå·¥æˆæœ¬
        BigDecimal laborCost = calculateLaborCost(productionOrderId);
        
        // 3. è®¡ç®—åˆ¶é€ è´¹ç”¨
        BigDecimal overheadCost = calculateOverheadCost(productionOrderId);
        
        // 4. è®¡ç®—æ€»æˆæœ¬
        BigDecimal totalCost = materialCost.add(laborCost).add(overheadCost);
        
        // 5. è®¡ç®—å•ä½æˆæœ¬
        BigDecimal unitCost = totalCost.divide(
            order.getQualifiedQuantity(), 
            4, 
            RoundingMode.HALF_UP
        );
        
        // 6. ä¿å­˜æˆæœ¬æ•°æ®
        ProductionCost cost = new ProductionCost();
        cost.setProductionOrderId(productionOrderId);
        cost.setMaterialCost(materialCost);
        cost.setLaborCost(laborCost);
        cost.setOverheadCost(overheadCost);
        cost.setTotalCost(totalCost);
        cost.setUnitCost(unitCost);
        productionCostMapper.insert(cost);
        
        // 7. æ›´æ–°äº§å“æˆæœ¬
        updateProductCost(order.getProductId(), unitCost);
        
        // 8. ç”Ÿæˆæˆæœ¬å‡­è¯
        generateCostVoucher(order, cost);
    }
    
    /**
     * è®¡ç®—ææ–™æˆæœ¬
     */
    private BigDecimal calculateMaterialCost(Long productionOrderId) {
        // æŸ¥è¯¢ç”Ÿäº§é¢†æ–™è®°å½•
        List<MaterialIssue> issues = materialIssueMapper.selectByProductionOrder(
            productionOrderId
        );
        
        BigDecimal totalCost = BigDecimal.ZERO;
        for (MaterialIssue issue : issues) {
            // ç§»åŠ¨åŠ æƒå¹³å‡æ³•è®¡ç®—æˆæœ¬
            BigDecimal cost = inventoryService.getInventoryCost(
                issue.getProductId(),
                issue.getQuantity()
            );
            totalCost = totalCost.add(cost);
        }
        
        return totalCost;
    }
}
```

### 5. è´¢åŠ¡è‡ªåŠ¨è®°è´¦

```java
@Service
public class AutoVoucherService {
    
    @Autowired
    private VoucherService voucherService;
    
    /**
     * é‡‡è´­å…¥åº“è‡ªåŠ¨ç”Ÿæˆå‡­è¯
     */
    public void generatePurchaseVoucher(Long purchaseOrderId) {
        PurchaseOrder order = purchaseOrderMapper.selectById(purchaseOrderId);
        
        // å€Ÿï¼šåŸææ–™
        // å€Ÿï¼šåº”äº¤ç¨è´¹-åº”äº¤å¢å€¼ç¨(è¿›é¡¹ç¨é¢)
        // è´·ï¼šåº”ä»˜è´¦æ¬¾
        
        VoucherDTO voucher = new VoucherDTO();
        voucher.setVoucherDate(LocalDate.now());
        voucher.setVoucherType(VoucherType.ACCOUNTING);
        
        List<VoucherDetailDTO> details = new ArrayList<>();
        
        // å€Ÿæ–¹ï¼šåŸææ–™
        VoucherDetailDTO detail1 = new VoucherDetailDTO();
        detail1.setAccountCode("1403"); // åŸææ–™
        detail1.setSummary("é‡‡è´­å…¥åº“-" + order.getOrderNo());
        detail1.setDebitAmount(order.getTotalAmount());
        detail1.setCreditAmount(BigDecimal.ZERO);
        details.add(detail1);
        
        // å€Ÿæ–¹ï¼šåº”äº¤å¢å€¼ç¨
        VoucherDetailDTO detail2 = new VoucherDetailDTO();
        detail2.setAccountCode("2221001"); // åº”äº¤å¢å€¼ç¨-è¿›é¡¹ç¨é¢
        detail2.setSummary("é‡‡è´­å…¥åº“-" + order.getOrderNo());
        detail2.setDebitAmount(order.getTaxAmount());
        detail2.setCreditAmount(BigDecimal.ZERO);
        details.add(detail2);
        
        // è´·æ–¹ï¼šåº”ä»˜è´¦æ¬¾
        VoucherDetailDTO detail3 = new VoucherDetailDTO();
        detail3.setAccountCode("2202"); // åº”ä»˜è´¦æ¬¾
        detail3.setSummary("é‡‡è´­å…¥åº“-" + order.getOrderNo());
        detail3.setDebitAmount(BigDecimal.ZERO);
        detail3.setCreditAmount(order.getFinalAmount());
        detail3.setAuxiliaryType("supplier");
        detail3.setAuxiliaryId(order.getSupplierId());
        details.add(detail3);
        
        voucher.setDetails(details);
        
        voucherService.createVoucher(voucher);
    }
}
```

### 6. æ•°æ®æƒé™æ§åˆ¶

```java
@Component
public class DataScopeInterceptor implements Interceptor {
    
    @Override
    public Object intercept(Invocation invocation) throws Throwable {
        // è·å–å½“å‰ç”¨æˆ·
        Long userId = SecurityUtils.getCurrentUserId();
        User user = userService.getById(userId);
        
        // è·å–æ•°æ®æƒé™èŒƒå›´
        DataScope dataScope = user.getDataScope();
        
        // æ ¹æ®æƒé™èŒƒå›´æ·»åŠ æŸ¥è¯¢æ¡ä»¶
        if (dataScope == DataScope.ORG) {
            // åªèƒ½æŸ¥çœ‹æœ¬ç»„ç»‡æ•°æ®
            addOrgCondition(invocation, user.getOrgId());
        } else if (dataScope == DataScope.ORG_AND_CHILDREN) {
            // å¯ä»¥æŸ¥çœ‹æœ¬ç»„ç»‡åŠå­ç»„ç»‡æ•°æ®
            List<Long> orgIds = getOrgIdsIncludeChildren(user.getOrgId());
            addOrgInCondition(invocation, orgIds);
        } else if (dataScope == DataScope.SELF) {
            // åªèƒ½æŸ¥çœ‹è‡ªå·±åˆ›å»ºçš„æ•°æ®
            addCreateUserCondition(invocation, userId);
        }
        // ALL - å¯ä»¥æŸ¥çœ‹æ‰€æœ‰æ•°æ®ï¼Œä¸æ·»åŠ æ¡ä»¶
        
        return invocation.proceed();
    }
}
```

## API æ¥å£è®¾è®¡

### 1. é‡‡è´­è®¢å•æ¥å£

```java
@RestController
@RequestMapping("/api/erp/purchase/order")
public class PurchaseOrderController {
    
    @Autowired
    private PurchaseOrderService purchaseOrderService;
    
    /**
     * åˆ›å»ºé‡‡è´­è®¢å•
     */
    @PostMapping("")
    public Result<Long> createOrder(@RequestBody @Valid PurchaseOrderDTO dto) {
        Long orderId = purchaseOrderService.createOrder(dto);
        return Result.success(orderId);
    }
    
    /**
     * æäº¤å®¡æ‰¹
     */
    @PostMapping("/{orderId}/submit")
    public Result<Void> submitForApproval(@PathVariable Long orderId) {
        purchaseOrderService.submitForApproval(orderId);
        return Result.success();
    }
    
    /**
     * é‡‡è´­è®¢å•åˆ—è¡¨
     */
    @GetMapping("")
    public Result<PageResult<PurchaseOrderVO>> listOrders(
            @RequestParam(required = false) String orderNo,
            @RequestParam(required = false) Long supplierId,
            @RequestParam(required = false) Integer status,
            @RequestParam(required = false) @DateTimeFormat(pattern = "yyyy-MM-dd") LocalDate startDate,
            @RequestParam(required = false) @DateTimeFormat(pattern = "yyyy-MM-dd") LocalDate endDate,
            @RequestParam(defaultValue = "1") Integer pageNum,
            @RequestParam(defaultValue = "20") Integer pageSize) {
        
        PageResult<PurchaseOrderVO> result = purchaseOrderService.listOrders(
            orderNo, supplierId, status, startDate, endDate, pageNum, pageSize
        );
        return Result.success(result);
    }
}
```

### 2. ç”Ÿäº§è®¢å•æ¥å£

```java
@RestController
@RequestMapping("/api/erp/production/order")
public class ProductionOrderController {
    
    @Autowired
    private ProductionOrderService productionOrderService;
    
    /**
     * åˆ›å»ºç”Ÿäº§è®¢å•
     */
    @PostMapping("")
    public Result<Long> createOrder(@RequestBody @Valid ProductionOrderDTO dto) {
        Long orderId = productionOrderService.createOrder(dto);
        return Result.success(orderId);
    }
    
    /**
     * ä¸‹è¾¾ç”Ÿäº§è®¢å•
     */
    @PostMapping("/{orderId}/release")
    public Result<Void> releaseOrder(@PathVariable Long orderId) {
        productionOrderService.releaseOrder(orderId);
        return Result.success();
    }
    
    /**
     * ç”Ÿäº§æŠ¥å·¥
     */
    @PostMapping("/{orderId}/report")
    public Result<Void> reportProgress(
            @PathVariable Long orderId,
            @RequestBody @Valid ProductionReportDTO dto) {
        
        productionOrderService.reportProgress(orderId, dto);
        return Result.success();
    }
    
    /**
     * å®Œå·¥å…¥åº“
     */
    @PostMapping("/{orderId}/complete")
    public Result<Void> completeOrder(
            @PathVariable Long orderId,
            @RequestBody @Valid ProductionCompleteDTO dto) {
        
        productionOrderService.completeOrder(orderId, dto);
        return Result.success();
    }
}
```

### 3. è´¢åŠ¡å‡­è¯æ¥å£

```java
@RestController
@RequestMapping("/api/erp/finance/voucher")
public class VoucherController {
    
    @Autowired
    private VoucherService voucherService;
    
    /**
     * åˆ›å»ºå‡­è¯
     */
    @PostMapping("")
    public Result<Long> createVoucher(@RequestBody @Valid VoucherDTO dto) {
        Long voucherId = voucherService.createVoucher(dto);
        return Result.success(voucherId);
    }
    
    /**
     * å®¡æ ¸å‡­è¯
     */
    @PostMapping("/{voucherId}/check")
    public Result<Void> checkVoucher(@PathVariable Long voucherId) {
        voucherService.checkVoucher(voucherId);
        return Result.success();
    }
    
    /**
     * è®°è´¦
     */
    @PostMapping("/{voucherId}/post")
    public Result<Void> postVoucher(@PathVariable Long voucherId) {
        voucherService.postVoucher(voucherId);
        return Result.success();
    }
    
    /**
     * åè®°è´¦
     */
    @PostMapping("/{voucherId}/unpost")
    public Result<Void> unpostVoucher(@PathVariable Long voucherId) {
        voucherService.unpostVoucher(voucherId);
        return Result.success();
    }
}
```

## æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ

### 1. æ•°æ®åº“ä¼˜åŒ–
- åˆç†è®¾è®¡ç´¢å¼•
- ä½¿ç”¨åˆ†åŒºè¡¨ï¼ˆæŒ‰æœˆä»½åˆ†åŒºï¼‰
- è¯»å†™åˆ†ç¦»
- å®šæœŸå½’æ¡£å†å²æ•°æ®

### 2. ç¼“å­˜ä¼˜åŒ–
- ç¼“å­˜åŸºç¡€æ•°æ®ï¼ˆç§‘ç›®ã€ç»„ç»‡ã€ç”¨æˆ·ç­‰ï¼‰
- ç¼“å­˜æƒé™æ•°æ®
- ä½¿ç”¨æœ¬åœ°ç¼“å­˜ + Redis äºŒçº§ç¼“å­˜

### 3. æŠ¥è¡¨ä¼˜åŒ–
- ä½¿ç”¨ ClickHouse åšæ•°æ®åˆ†æ
- å®šæ—¶åŒæ­¥æ•°æ®åˆ° ClickHouse
- å¤æ‚æŠ¥è¡¨å¼‚æ­¥ç”Ÿæˆ

### 4. å¹¶å‘ä¼˜åŒ–
- ä½¿ç”¨ä¹è§‚é”å¤„ç†å¹¶å‘
- å¼‚æ­¥å¤„ç†éæ ¸å¿ƒä¸šåŠ¡

## æ€»ç»“

ERP ç³»ç»Ÿçš„æ ¸å¿ƒåœ¨äºï¼š
1. **ä¸šåŠ¡é›†æˆ**ï¼šæ‰“é€šä¼ä¸šå„ä¸ªä¸šåŠ¡ç¯èŠ‚ï¼Œå®ç°æ•°æ®å…±äº«
2. **æµç¨‹è§„èŒƒ**ï¼šé€šè¿‡ç³»ç»Ÿè§„èŒƒä¸šåŠ¡æµç¨‹ï¼Œæé«˜ç®¡ç†æ•ˆç‡
3. **æ•°æ®ä¸€è‡´æ€§**ï¼šç¡®ä¿å„æ¨¡å—æ•°æ®çš„ä¸€è‡´æ€§å’Œå‡†ç¡®æ€§
4. **æƒé™æ§åˆ¶**ï¼šä¸¥æ ¼çš„æƒé™æ§åˆ¶ä½“ç³»ï¼Œä¿éšœæ•°æ®å®‰å…¨
5. **çµæ´»æ‰©å±•**ï¼šæ”¯æŒå¤šç»„ç»‡ã€å¤šä¸šåŠ¡åœºæ™¯çš„æ‰©å±•

æœ¬è®¾è®¡æ–¹æ¡ˆåŸºäº Spring Cloud å¾®æœåŠ¡æ¶æ„ï¼Œæ¶µç›–è´¢åŠ¡ã€é‡‡è´­ã€é”€å”®ã€åº“å­˜ã€ç”Ÿäº§ã€äººåŠ›èµ„æºç­‰æ ¸å¿ƒæ¨¡å—ï¼Œå¯æ»¡è¶³ä¸­å¤§å‹ä¼ä¸šçš„ ERP éœ€æ±‚ã€‚

