---
sidebar_position: 8
title: åŸºäº OpenTwins çš„æ•°å­—å­ªç”Ÿç³»ç»Ÿè®¾è®¡
description: ä½¿ç”¨ OpenTwins å¹³å°æ„å»ºä¼ä¸šçº§æ•°å­—å­ªç”Ÿåº”ç”¨çš„å®Œæ•´æ–¹æ¡ˆ
tags: [æ•°å­—å­ªç”Ÿ, OpenTwins, Eclipse Ditto, ç³»ç»Ÿè®¾è®¡, IoT]
---

# åŸºäº OpenTwins çš„æ•°å­—å­ªç”Ÿç³»ç»Ÿè®¾è®¡

## ä¸€ã€é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®åŸºäºå¼€æºæ•°å­—å­ªç”Ÿå¹³å° **OpenTwins** æ„å»ºä¼ä¸šçº§æ•°å­—å­ªç”Ÿåº”ç”¨ã€‚OpenTwins åº•å±‚ä½¿ç”¨ Eclipse Ditto ä½œä¸ºæ•°å­—å­ªç”Ÿæ ¸å¿ƒå¼•æ“ï¼Œæä¾›å®Œæ•´çš„è®¾å¤‡ç®¡ç†ã€æ•°æ®é‡‡é›†ã€å¯è§†åŒ–å’Œåˆ†æèƒ½åŠ›ã€‚

### 1.1 ä»€ä¹ˆæ˜¯ OpenTwinsï¼Ÿ

OpenTwins æ˜¯ä¸€ä¸ªå¼€æºçš„æ•°å­—å­ªç”Ÿå¹³å°ï¼Œé›†æˆäº†ä»¥ä¸‹æ ¸å¿ƒç»„ä»¶ï¼š

- ğŸ¯ **Eclipse Ditto** - æ•°å­—å­ªç”Ÿæ ¸å¿ƒå¼•æ“
- ğŸ“Š **Grafana** - æ•°æ®å¯è§†åŒ–å’Œç›‘æ§
- ğŸ’¾ **InfluxDB** - æ—¶åºæ•°æ®å­˜å‚¨
- ğŸ“¡ **Mosquitto** - MQTT æ¶ˆæ¯ä»£ç†
- ğŸ“ˆ **Telegraf** - æ•°æ®é‡‡é›†å’Œå¤„ç†
- ğŸ—„ï¸ **MongoDB** - Things çŠ¶æ€å­˜å‚¨

### 1.2 åº”ç”¨åœºæ™¯

#### ğŸ­ æ™ºèƒ½åˆ¶é€ 
- ç”Ÿäº§è®¾å¤‡å®æ—¶ç›‘æ§
- è®¾å¤‡é¢„æµ‹æ€§ç»´æŠ¤
- ç”Ÿäº§çº¿æ•°å­—å­ªç”Ÿ
- OEEï¼ˆè®¾å¤‡ç»¼åˆæ•ˆç‡ï¼‰åˆ†æ

#### ğŸ¢ æ™ºæ…§å›­åŒº
- å›­åŒº 3D å¯è§†åŒ–ç›‘æ§
- èƒ½è€—ç›‘æµ‹å’Œä¼˜åŒ–
- ç¯å¢ƒç›‘æµ‹ï¼ˆæ¸©æ¹¿åº¦ã€ç©ºæ°”è´¨é‡ï¼‰
- è®¾å¤‡é›†ä¸­ç®¡ç†

#### âš™ï¸ è®¾å¤‡å¥åº·ç®¡ç†
- è®¾å¤‡çŠ¶æ€å®æ—¶ç›‘æ§
- æ•…éšœé¢„è­¦å’Œè¯Šæ–­
- ç»´æŠ¤è®¡åˆ’ä¼˜åŒ–
- è®¾å¤‡ç”Ÿå‘½å‘¨æœŸç®¡ç†

### 1.3 æŠ€æœ¯æ¶æ„

```mermaid
graph TB
    subgraph ä¸šåŠ¡åº”ç”¨å±‚["ğŸ“± ä¸šåŠ¡åº”ç”¨å±‚"]
        WebUI["ğŸ–¥ï¸ ç›‘æ§å¤§å±<br/>(Vue3)"]
        MobileApp["ğŸ“± ç§»åŠ¨ç«¯APP<br/>(UniApp)"]
        AdminUI["âš™ï¸ ç®¡ç†åå°<br/>(React)"]
    end

    subgraph OpenTwins["ğŸ¢ OpenTwins å¹³å°å±‚"]
        subgraph Visualization["ğŸ“Š æ•°æ®å¯è§†åŒ–"]
            Grafana["Grafana<br/>localhost:3002<br/>â€¢ å®æ—¶ç›‘æ§ä»ªè¡¨æ¿<br/>â€¢ å†å²æ•°æ®åˆ†æ<br/>â€¢ å‘Šè­¦é…ç½®"]
        end

        subgraph DigitalTwin["ğŸ¯ æ•°å­—å­ªç”Ÿå¼•æ“"]
            Ditto["Eclipse Ditto<br/>localhost:8080<br/>â€¢ Things API<br/>â€¢ Features<br/>â€¢ Messages<br/>â€¢ Policies"]
        end

        subgraph Storage["ğŸ’¾ æ•°æ®å­˜å‚¨"]
            InfluxDB["InfluxDB<br/>localhost:8086<br/>â€¢ æ—¶åºæ•°æ®<br/>â€¢ 30å¤©åŸå§‹æ•°æ®<br/>â€¢ 1å¹´èšåˆæ•°æ®"]
            MongoDB["MongoDB<br/>â€¢ Things çŠ¶æ€<br/>â€¢ æœç´¢ç´¢å¼•"]
        end

        subgraph Messaging["ğŸ“¡ æ¶ˆæ¯ä¸­é—´ä»¶"]
            Mosquitto["Mosquitto<br/>localhost:1883<br/>â€¢ è®¾å¤‡è¿æ¥<br/>â€¢ æ¶ˆæ¯è·¯ç”±<br/>â€¢ QoS ä¿è¯"]
        end
    end

    subgraph Devices["ğŸ”Œ è®¾å¤‡æ¥å…¥å±‚"]
        IoT["IoT è®¾å¤‡<br/>(MQTT)"]
        Sensors["ä¼ æ„Ÿå™¨<br/>(HTTP)"]
        PLC["PLC/SCADA<br/>(OPC UA)"]
    end

    %% è¿æ¥å…³ç³»
    WebUI --> |REST API<br/>WebSocket| Ditto
    MobileApp --> |REST API| Ditto
    AdminUI --> |REST API| Ditto
    
    WebUI -.-> |æŸ¥è¯¢æ•°æ®| Grafana
    MobileApp -.-> |æŸ¥è¯¢æ•°æ®| InfluxDB
    
    Ditto --> |å­˜å‚¨çŠ¶æ€| MongoDB
    Ditto --> |è®¢é˜…æ¶ˆæ¯| Mosquitto
    Ditto --> |å†™å…¥æ—¶åºæ•°æ®| InfluxDB
    
    Grafana --> |æŸ¥è¯¢| InfluxDB
    
    IoT --> |MQTT| Mosquitto
    Sensors --> |HTTP| Ditto
    PLC --> |OPC UA| Ditto
    
    Mosquitto --> |è½¬å‘| Ditto

    %% æ ·å¼å®šä¹‰
    classDef platformStyle fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    classDef appStyle fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef deviceStyle fill:#fff3e0,stroke:#e65100,stroke-width:2px
    
    class Grafana,Ditto,InfluxDB,MongoDB,Mosquitto platformStyle
    class WebUI,MobileApp,AdminUI appStyle
    class IoT,Sensors,PLC deviceStyle
```

### 1.4 æŠ€æœ¯æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | è¯´æ˜ |
|------|--------|------|
| è®¾å¤‡è¿æ¥æ•° | 10,000+ | åŒæ—¶åœ¨çº¿è®¾å¤‡ |
| æ•°æ®é‡‡é›†é¢‘ç‡ | 1-10 Hz | æ ¹æ®è®¾å¤‡ç±»å‹è°ƒæ•´ |
| ç«¯åˆ°ç«¯å»¶è¿Ÿ | < 1s | ä»è®¾å¤‡åˆ°å¯è§†åŒ–å±•ç¤º |
| API å“åº”æ—¶é—´ | < 200ms | Ditto HTTP API |
| æ•°æ®ä¿ç•™æœŸ | 30å¤©/1å¹´ | åŸå§‹æ•°æ®/èšåˆæ•°æ® |
| ç³»ç»Ÿå¯ç”¨æ€§ | 99.9% | å¹´åº¦ç›®æ ‡ |

---

## äºŒã€OpenTwins å¹³å°éƒ¨ç½²

### 2.1 ç¯å¢ƒå‡†å¤‡

åœ¨å¼€å§‹å¼€å‘ä¹‹å‰ï¼Œè¯·å…ˆå®Œæˆ OpenTwins å¹³å°çš„éƒ¨ç½²ã€‚è¯¦ç»†æ­¥éª¤è¯·å‚è€ƒï¼š

ğŸ‘‰ **[OpenTwins Windows æœ¬åœ°éƒ¨ç½²å®æˆ˜æŒ‡å—](../digital-twin/opentwins-windows-deployment)**

**å¿«é€Ÿæ£€æŸ¥æ¸…å•**ï¼š

```bash
# 1. æ£€æŸ¥ Minikube é›†ç¾¤çŠ¶æ€
kubectl get nodes

# 2. æ£€æŸ¥ OpenTwins æ‰€æœ‰ Pod çŠ¶æ€
kubectl get pods

# 3. ç¡®è®¤æ‰€æœ‰æœåŠ¡æ­£å¸¸è¿è¡Œ
kubectl get services

# 4. å¯åŠ¨ç«¯å£è½¬å‘
powershell -ExecutionPolicy Bypass -File .\start-opentwins-portforward.ps1
```

**è®¿é—®åœ°å€**ï¼š

| æœåŠ¡ | åœ°å€ | ç”¨é€” |
|------|------|------|
| Grafana | http://localhost:3002 | æ•°æ®å¯è§†åŒ–ï¼ˆadmin/adminï¼‰ |
| Ditto API | http://localhost:8080 | æ•°å­—å­ªç”Ÿæ ¸å¿ƒ API |
| Extended API | http://localhost:8081 | OpenTwins æ‰©å±• API |
| InfluxDB | http://localhost:8086 | æ—¶åºæ•°æ®åº“ç®¡ç† |
| MQTT | localhost:1883 | è®¾å¤‡æ¶ˆæ¯æ¥å…¥ |

### 2.2 OpenTwins ç»„ä»¶æ¶æ„

```mermaid
graph LR
    subgraph DittoCore["ğŸ¯ Ditto æ ¸å¿ƒç»„ä»¶"]
        Gateway["ditto-gateway<br/>API ç½‘å…³<br/>HTTP/WebSocket"]
        Things["ditto-things<br/>Things ç®¡ç†<br/>è®¾å¤‡çŠ¶æ€"]
        Policies["ditto-policies<br/>æƒé™ç­–ç•¥ç®¡ç†"]
        Connectivity["ditto-connectivity<br/>è¿æ¥ç®¡ç†<br/>MQTT/HTTP/AMQP"]
        Search["ditto-thingssearch<br/>æœç´¢æœåŠ¡"]
        ExtendedAPI["ditto-extended-api<br/>OpenTwins æ‰©å±•"]
    end

    subgraph DataStorage["ğŸ’¾ æ•°æ®å­˜å‚¨"]
        MongoDB["MongoDB<br/>Things çŠ¶æ€å­˜å‚¨"]
        InfluxDB["InfluxDB<br/>æ—¶åºæ•°æ®å­˜å‚¨"]
    end

    subgraph MessageQueue["ğŸ“¡ æ¶ˆæ¯ä¸­é—´ä»¶"]
        Mosquitto["Mosquitto<br/>MQTT Broker"]
    end

    subgraph Visualization["ğŸ“Š å¯è§†åŒ–ç›‘æ§"]
        Grafana["Grafana<br/>æ•°æ®å¯è§†åŒ–"]
        Telegraf["Telegraf<br/>æ•°æ®é‡‡é›†"]
    end

    %% è¿æ¥å…³ç³»
    Gateway --> Things
    Gateway --> Policies
    Connectivity --> Things
    Things --> MongoDB
    Things --> Search
    Search --> MongoDB
    Connectivity --> Mosquitto
    Telegraf --> InfluxDB
    Grafana --> InfluxDB

    classDef coreStyle fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef storageStyle fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef mqStyle fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef vizStyle fill:#e8f5e9,stroke:#388e3c,stroke-width:2px

    class Gateway,Things,Policies,Connectivity,Search,ExtendedAPI coreStyle
    class MongoDB,InfluxDB storageStyle
    class Mosquitto mqStyle
    class Grafana,Telegraf vizStyle
```

---

## ä¸‰ã€Eclipse Ditto æ ¸å¿ƒæ¦‚å¿µ

### 3.1 Things æ•°æ®æ¨¡å‹

Eclipse Ditto ä½¿ç”¨ **Thing** ä½œä¸ºæ ¸å¿ƒæ¦‚å¿µï¼Œä¸€ä¸ª Thing ä»£è¡¨ä¸€ä¸ªæ•°å­—å­ªç”Ÿå®ä½“ã€‚

**Thing çš„å®Œæ•´ç»“æ„**ï¼š

```json
{
  "thingId": "org.example:temperature-sensor-001",
  "policyId": "org.example:my-policy",
  "definition": "org.example:TemperatureSensor:1.0.0",
  "attributes": {
    "manufacturer": "Acme Inc.",
    "model": "TempSensor-2000",
    "serialNumber": "SN-12345",
    "location": {
      "building": "Building A",
      "floor": "2",
      "room": "201",
      "coordinates": {
        "latitude": 31.2304,
        "longitude": 121.4737
      }
    },
    "installDate": "2024-01-15",
    "warrantyDate": "2026-01-15"
  },
  "features": {
    "temperature": {
      "properties": {
        "value": 23.5,
        "unit": "Â°C",
        "quality": "good",
        "timestamp": "2024-01-15T10:30:00Z"
      }
    },
    "humidity": {
      "properties": {
        "value": 65.2,
        "unit": "%",
        "timestamp": "2024-01-15T10:30:00Z"
      }
    },
    "battery": {
      "properties": {
        "level": 85,
        "voltage": 3.7,
        "status": "charging"
      }
    }
  }
}
```

**å…³é”®æ¦‚å¿µè¯´æ˜**ï¼š

- **thingId**: å…¨å±€å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œæ ¼å¼ï¼š`namespace:name`
- **policyId**: å…³è”çš„æƒé™ç­–ç•¥ ID
- **definition**: Thing çš„ç±»å‹å®šä¹‰ï¼ˆå¯é€‰ï¼‰
- **attributes**: é™æ€å±æ€§ï¼ˆè®¾å¤‡å…ƒæ•°æ®ï¼Œä¸å¸¸å˜åŒ–ï¼‰
- **features**: åŠ¨æ€å±æ€§ï¼ˆä¼ æ„Ÿå™¨æ•°æ®ï¼Œç»å¸¸å˜åŒ–ï¼‰

### 3.2 Attributes vs Features

| ç‰¹æ€§ | Attributes | Features |
|------|-----------|----------|
| **ç”¨é€”** | é™æ€å…ƒæ•°æ® | åŠ¨æ€æ•°æ® |
| **æ›´æ–°é¢‘ç‡** | ä½ï¼ˆå¾ˆå°‘å˜åŒ–ï¼‰ | é«˜ï¼ˆé¢‘ç¹å˜åŒ–ï¼‰ |
| **ç¤ºä¾‹** | åˆ¶é€ å•†ã€å‹å·ã€ä½ç½® | æ¸©åº¦ã€æ¹¿åº¦ã€çŠ¶æ€ |
| **æœç´¢** | æ”¯æŒå…¨æ–‡æœç´¢ | æ”¯æŒå±æ€§æœç´¢ |
| **å…¸å‹å¤§å°** | è¾ƒå° | å¯èƒ½è¾ƒå¤§ |

### 3.3 Policy æƒé™æ¨¡å‹

Ditto ä½¿ç”¨ Policy æ¥æ§åˆ¶å¯¹ Thing çš„è®¿é—®æƒé™ã€‚

**Policy ç¤ºä¾‹**ï¼š

```json
{
  "policyId": "org.example:my-policy",
  "entries": {
    "owner": {
      "subjects": {
        "nginx:admin": {
          "type": "nginx basic auth user"
        }
      },
      "resources": {
        "thing:/": {
          "grant": ["READ", "WRITE"],
          "revoke": []
        },
        "policy:/": {
          "grant": ["READ", "WRITE"],
          "revoke": []
        },
        "message:/": {
          "grant": ["READ", "WRITE"],
          "revoke": []
        }
      }
    },
    "observer": {
      "subjects": {
        "nginx:observer": {
          "type": "nginx basic auth user"
        }
      },
      "resources": {
        "thing:/": {
          "grant": ["READ"],
          "revoke": []
        }
      }
    }
  }
}
```

---

## å››ã€Ditto HTTP API ä½¿ç”¨æŒ‡å—

### 4.1 åˆ›å»ºæ•°å­—å­ªç”Ÿ (Thing)

**API ç«¯ç‚¹**: `PUT /api/2/things/{thingId}`

```bash
# è®¾ç½® Ditto API åŸºç¡€åœ°å€
DITTO_API="http://localhost:8080/api/2"

# åˆ›å»ºä¸€ä¸ªæ¸©åº¦ä¼ æ„Ÿå™¨æ•°å­—å­ªç”Ÿ
curl -X PUT "$DITTO_API/things/org.example:temp-sensor-001" \
  -H "Content-Type: application/json" \
  -d '{
    "attributes": {
      "manufacturer": "Acme Inc.",
      "model": "TempSensor-2000",
      "location": {
        "building": "A",
        "floor": "2",
        "room": "201"
      }
    },
    "features": {
      "temperature": {
        "properties": {
          "value": 0,
          "unit": "Â°C"
        }
      },
      "humidity": {
        "properties": {
          "value": 0,
          "unit": "%"
        }
      }
    }
  }'
```

**PowerShell ç‰ˆæœ¬**ï¼š

```powershell
$dittoApi = "http://localhost:8080/api/2"
$thingId = "org.example:temp-sensor-001"

$body = @{
    attributes = @{
        manufacturer = "Acme Inc."
        model = "TempSensor-2000"
        location = @{
            building = "A"
            floor = "2"
            room = "201"
        }
    }
    features = @{
        temperature = @{
            properties = @{
                value = 0
                unit = "Â°C"
            }
        }
        humidity = @{
            properties = @{
                value = 0
                unit = "%"
            }
        }
    }
} | ConvertTo-Json -Depth 10

Invoke-RestMethod -Uri "$dittoApi/things/$thingId" `
    -Method Put `
    -ContentType "application/json" `
    -Body $body
```

### 4.2 æŸ¥è¯¢æ•°å­—å­ªç”Ÿ

**è·å–å•ä¸ª Thing**ï¼š

```bash
curl -X GET "$DITTO_API/things/org.example:temp-sensor-001"
```

**æœç´¢ Things**ï¼ˆä½¿ç”¨ RQL æŸ¥è¯¢è¯­è¨€ï¼‰ï¼š

```bash
# æŸ¥è¯¢æ‰€æœ‰ Acme åˆ¶é€ å•†çš„è®¾å¤‡
curl -X GET "$DITTO_API/search/things?filter=eq(attributes/manufacturer,\"Acme Inc.\")"

# æŸ¥è¯¢ç‰¹å®šæ¥¼å±‚çš„æ‰€æœ‰è®¾å¤‡
curl -X GET "$DITTO_API/search/things?filter=eq(attributes/location/floor,\"2\")"

# æŸ¥è¯¢æ¸©åº¦å¤§äº 25Â°C çš„è®¾å¤‡
curl -X GET "$DITTO_API/search/things?filter=gt(features/temperature/properties/value,25)"

# å¤æ‚æŸ¥è¯¢ï¼šç‰¹å®šä½ç½®ä¸”æ¸©åº¦å¼‚å¸¸
curl -X GET "$DITTO_API/search/things?filter=and(eq(attributes/location/building,\"A\"),gt(features/temperature/properties/value,30))"
```

### 4.3 æ›´æ–°è®¾å¤‡å±æ€§

**æ›´æ–°å•ä¸ª Feature å±æ€§**ï¼š

```bash
# æ›´æ–°æ¸©åº¦å€¼
curl -X PUT "$DITTO_API/things/org.example:temp-sensor-001/features/temperature/properties/value" \
  -H "Content-Type: application/json" \
  -d '25.6'

# æ›´æ–°æ¹¿åº¦å€¼
curl -X PUT "$DITTO_API/things/org.example:temp-sensor-001/features/humidity/properties/value" \
  -H "Content-Type: application/json" \
  -d '62.3'
```

**æ‰¹é‡æ›´æ–°æ•´ä¸ª Feature**ï¼š

```bash
curl -X PUT "$DITTO_API/things/org.example:temp-sensor-001/features/temperature" \
  -H "Content-Type: application/json" \
  -d '{
    "properties": {
      "value": 25.6,
      "unit": "Â°C",
      "quality": "good",
      "timestamp": "2024-01-15T10:30:00Z"
    }
  }'
```

### 4.4 åˆ é™¤æ•°å­—å­ªç”Ÿ

```bash
curl -X DELETE "$DITTO_API/things/org.example:temp-sensor-001"
```

---

## äº”ã€è®¾å¤‡æ¥å…¥å®ç°

### 5.1 MQTT è®¾å¤‡æ¥å…¥

OpenTwins ä½¿ç”¨ Mosquitto ä½œä¸º MQTT Brokerï¼Œè®¾å¤‡é€šè¿‡ MQTT åè®®ä¸ŠæŠ¥æ•°æ®ã€‚

**MQTT ä¸»é¢˜è§„èŒƒ**ï¼š

```
# Ditto æ ‡å‡†ä¸»é¢˜æ ¼å¼
{namespace}/{thingId}/things/twin/commands/modify

# ç¤ºä¾‹
org.example/temp-sensor-001/things/twin/commands/modify
```

**è®¾å¤‡ä¸ŠæŠ¥æ•°æ®ç¤ºä¾‹**ï¼ˆPythonï¼‰ï¼š

```python
import paho.mqtt.client as mqtt
import json
import time
from datetime import datetime

# MQTT é…ç½®
MQTT_BROKER = "localhost"
MQTT_PORT = 1883
THING_ID = "org.example:temp-sensor-001"
NAMESPACE = "org.example"
THING_NAME = "temp-sensor-001"

# MQTT ä¸»é¢˜
TOPIC = f"{NAMESPACE}/{THING_NAME}/things/twin/commands/modify"

def on_connect(client, userdata, flags, rc):
    print(f"Connected to MQTT Broker! Code: {rc}")

def publish_sensor_data(client, temperature, humidity):
    """å‘å¸ƒä¼ æ„Ÿå™¨æ•°æ®åˆ° Ditto"""
    
    # æ„å»º Ditto æ¶ˆæ¯
    message = {
        "topic": f"{NAMESPACE}/{THING_NAME}/things/twin/commands/modify",
        "path": "/features",
        "value": {
            "temperature": {
                "properties": {
                    "value": temperature,
                    "unit": "Â°C",
                    "timestamp": datetime.utcnow().isoformat() + "Z"
                }
            },
            "humidity": {
                "properties": {
                    "value": humidity,
                    "unit": "%",
                    "timestamp": datetime.utcnow().isoformat() + "Z"
                }
            }
        }
    }
    
    # å‘å¸ƒæ¶ˆæ¯
    result = client.publish(TOPIC, json.dumps(message))
    status = result[0]
    
    if status == 0:
        print(f"âœ“ Data sent: Temp={temperature}Â°C, Humidity={humidity}%")
    else:
        print(f"âœ— Failed to send data to topic {TOPIC}")

# åˆ›å»º MQTT å®¢æˆ·ç«¯
client = mqtt.Client()
client.on_connect = on_connect

# è¿æ¥åˆ° Broker
client.connect(MQTT_BROKER, MQTT_PORT, 60)
client.loop_start()

# æ¨¡æ‹Ÿä¼ æ„Ÿå™¨æ•°æ®ä¸ŠæŠ¥
try:
    while True:
        # æ¨¡æ‹Ÿè¯»å–ä¼ æ„Ÿå™¨æ•°æ®
        temperature = 20 + (time.time() % 10)  # 20-30Â°C
        humidity = 50 + (time.time() % 20)     # 50-70%
        
        # å‘å¸ƒæ•°æ®
        publish_sensor_data(client, round(temperature, 2), round(humidity, 2))
        
        # æ¯ 5 ç§’ä¸ŠæŠ¥ä¸€æ¬¡
        time.sleep(5)
        
except KeyboardInterrupt:
    print("\nåœæ­¢æ•°æ®ä¸ŠæŠ¥")
    client.loop_stop()
    client.disconnect()
```

### 5.2 é…ç½® Ditto MQTT è¿æ¥

éœ€è¦åœ¨ Ditto ä¸­é…ç½® MQTT è¿æ¥ï¼Œä»¥ä¾¿æ¥æ”¶è®¾å¤‡æ¶ˆæ¯ã€‚

**åˆ›å»º MQTT è¿æ¥é…ç½®**ï¼š

```bash
curl -X POST "http://localhost:8080/api/2/connections" \
  -H "Content-Type: application/json" \
  -d '{
    "id": "mqtt-connection-mosquitto",
    "connectionType": "mqtt",
    "connectionStatus": "open",
    "uri": "tcp://opentwins-mosquitto:1883",
    "sources": [{
      "addresses": ["org.example/+/things/twin/commands/modify"],
      "authorizationContext": ["nginx:ditto"],
      "qos": 1,
      "filters": []
    }],
    "targets": [{
      "address": "org.example/{{ thing:id }}/things/twin/events",
      "topics": ["_/_/things/twin/events"],
      "authorizationContext": ["nginx:ditto"],
      "qos": 1
    }]
  }'
```

### 5.3 HTTP API è®¾å¤‡æ¥å…¥

å¯¹äºä¸æ”¯æŒ MQTT çš„è®¾å¤‡ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ HTTP API ä¸ŠæŠ¥æ•°æ®ã€‚

**HTTP ä¸ŠæŠ¥ç¤ºä¾‹**ï¼ˆPythonï¼‰ï¼š

```python
import requests
import time
from datetime import datetime

DITTO_API = "http://localhost:8080/api/2"
THING_ID = "org.example:temp-sensor-002"

def create_thing():
    """åˆ›å»º Thing"""
    url = f"{DITTO_API}/things/{THING_ID}"
    data = {
        "attributes": {
            "manufacturer": "Acme Inc.",
            "model": "TempSensor-HTTP"
        },
        "features": {
            "temperature": {
                "properties": {
                    "value": 0,
                    "unit": "Â°C"
                }
            }
        }
    }
    
    response = requests.put(url, json=data)
    print(f"Thing created: {response.status_code}")

def update_temperature(value):
    """æ›´æ–°æ¸©åº¦å€¼"""
    url = f"{DITTO_API}/things/{THING_ID}/features/temperature/properties"
    data = {
        "value": value,
        "unit": "Â°C",
        "timestamp": datetime.utcnow().isoformat() + "Z"
    }
    
    response = requests.put(url, json=data)
    if response.status_code == 204:
        print(f"âœ“ Temperature updated: {value}Â°C")
    else:
        print(f"âœ— Failed: {response.status_code}")

# åˆ›å»º Thingï¼ˆé¦–æ¬¡è¿è¡Œï¼‰
# create_thing()

# æŒç»­ä¸ŠæŠ¥æ•°æ®
while True:
    temp = 20 + (time.time() % 10)
    update_temperature(round(temp, 2))
    time.sleep(5)
```

---

## å…­ã€æ•°æ®å¯è§†åŒ–å®ç°

### 6.1 Grafana æ•°æ®æºé…ç½®

1. è®¿é—® Grafana: http://localhost:3002
2. ç™»å½•ï¼ˆadmin/adminï¼‰
3. é…ç½® InfluxDB æ•°æ®æº

**æ·»åŠ  InfluxDB æ•°æ®æº**ï¼š

- **Settings** â†’ **Data Sources** â†’ **Add data source**
- é€‰æ‹© **InfluxDB**
- é…ç½®å‚æ•°ï¼š
  - **URL**: `http://opentwins-influxdb2:80`
  - **Query Language**: `Flux`
  - **Organization**: `iot`
  - **Token**: ï¼ˆä» InfluxDB è·å–ï¼‰
  - **Default Bucket**: `telegraf`

### 6.2 åˆ›å»ºç›‘æ§ä»ªè¡¨æ¿

**åˆ›å»ºæ¸©åº¦ç›‘æ§é¢æ¿**ï¼š

1. **Create** â†’ **Dashboard** â†’ **Add new panel**
2. é€‰æ‹©æ•°æ®æºï¼š**InfluxDB**
3. ç¼–å†™ Flux æŸ¥è¯¢ï¼š

```flux
from(bucket: "telegraf")
  |> range(start: -1h)
  |> filter(fn: (r) => r["_measurement"] == "temperature")
  |> filter(fn: (r) => r["device"] == "temp-sensor-001")
  |> filter(fn: (r) => r["_field"] == "value")
  |> aggregateWindow(every: 1m, fn: mean, createEmpty: false)
  |> yield(name: "mean")
```

4. é…ç½®å¯è§†åŒ–é€‰é¡¹ï¼š
   - **Panel Title**: "è®¾å¤‡æ¸©åº¦å®æ—¶ç›‘æ§"
   - **Visualization**: Time seriesï¼ˆæ—¶é—´åºåˆ—å›¾ï¼‰
   - **Unit**: Celsius (Â°C)
   - **Thresholds**: è®¾ç½®å‘Šè­¦é˜ˆå€¼ï¼ˆå¦‚ >30Â°Cï¼‰

### 6.3 å®Œæ•´ç›‘æ§å¤§å±ç¤ºä¾‹

**ä»ªè¡¨æ¿å¸ƒå±€**ï¼š

```mermaid
graph TB
    subgraph Dashboard["ğŸ“Š æ™ºèƒ½å·¥å‚æ•°å­—å­ªç”Ÿç›‘æ§å¤§å±"]
        subgraph Stats["ğŸ“ˆ ç»Ÿè®¡å¡ç‰‡"]
            Total["è®¾å¤‡æ€»æ•°<br/>156"]
            Online["åœ¨çº¿è®¾å¤‡<br/>142"]
            Offline["ç¦»çº¿è®¾å¤‡<br/>14"]
            Alarms["å‘Šè­¦æ•°é‡<br/>3"]
        end
        
        subgraph Charts["ğŸ“‰ æ•°æ®å›¾è¡¨"]
            subgraph LeftPanel["å·¦ä¾§é¢æ¿"]
                TempChart["å®æ—¶æ¸©åº¦è¶‹åŠ¿å›¾<br/>(Time Series)<br/>ğŸ“ˆ æŠ˜çº¿å›¾"]
            end
            
            subgraph RightPanel["å³ä¾§é¢æ¿"]
                StatusPie["è®¾å¤‡çŠ¶æ€åˆ†å¸ƒ<br/>(Pie Chart)<br/>ğŸ¥§ é¥¼å›¾"]
            end
        end
        
        subgraph Tables["ğŸ“‹ æ•°æ®è¡¨æ ¼"]
            subgraph LeftTable["å·¦ä¾§è¡¨æ ¼"]
                DeviceList["è®¾å¤‡åˆ—è¡¨<br/>(Table)<br/>è®¾å¤‡ID | çŠ¶æ€ | æ¸©åº¦"]
            end
            
            subgraph RightTable["å³ä¾§è¡¨æ ¼"]
                AlarmList["å‘Šè­¦åˆ—è¡¨<br/>(Table)<br/>æ—¶é—´ | è®¾å¤‡ | å‘Šè­¦å†…å®¹"]
            end
        end
    end

    classDef statsStyle fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef chartStyle fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef tableStyle fill:#fff3e0,stroke:#e65100,stroke-width:2px
    
    class Total,Online,Offline,Alarms statsStyle
    class TempChart,StatusPie chartStyle
    class DeviceList,AlarmList tableStyle
```

**åˆ›å»ºè®¾å¤‡çŠ¶æ€ç»Ÿè®¡é¢æ¿**ï¼š

```flux
from(bucket: "telegraf")
  |> range(start: -5m)
  |> filter(fn: (r) => r["_measurement"] == "device_status")
  |> last()
  |> group(columns: ["status"])
  |> count()
```

---

## ä¸ƒã€ä¸šåŠ¡åº”ç”¨å¼€å‘

### 7.1 å‰ç«¯åº”ç”¨æ¶æ„

**æŠ€æœ¯æ ˆé€‰æ‹©**ï¼š

```json
{
  "dependencies": {
    "vue": "^3.4.0",
    "vue-router": "^4.2.0",
    "pinia": "^2.1.0",
    "axios": "^1.6.0",
    "element-plus": "^2.5.0",
    "echarts": "^5.4.0",
    "mqtt": "^5.3.0",
    "@vueuse/core": "^10.7.0"
  }
}
```

**é¡¹ç›®ç»“æ„**ï¼š

```
digital-twin-web/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ api/                    # API æ¥å£
â”‚   â”‚   â”œâ”€â”€ ditto.js           # Ditto API å°è£…
â”‚   â”‚   â””â”€â”€ influxdb.js        # InfluxDB API å°è£…
â”‚   â”œâ”€â”€ components/             # å…¬å…±ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ DeviceCard.vue     # è®¾å¤‡å¡ç‰‡
â”‚   â”‚   â”œâ”€â”€ TemperatureChart.vue # æ¸©åº¦å›¾è¡¨
â”‚   â”‚   â””â”€â”€ DeviceList.vue     # è®¾å¤‡åˆ—è¡¨
â”‚   â”œâ”€â”€ views/                  # é¡µé¢
â”‚   â”‚   â”œâ”€â”€ Dashboard.vue      # ç›‘æ§å¤§å±
â”‚   â”‚   â”œâ”€â”€ DeviceManage.vue   # è®¾å¤‡ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ DataAnalysis.vue   # æ•°æ®åˆ†æ
â”‚   â”‚   â””â”€â”€ AlarmCenter.vue    # å‘Šè­¦ä¸­å¿ƒ
â”‚   â”œâ”€â”€ stores/                 # Pinia çŠ¶æ€ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ device.js          # è®¾å¤‡çŠ¶æ€
â”‚   â”‚   â””â”€â”€ mqtt.js            # MQTT è¿æ¥
â”‚   â”œâ”€â”€ utils/                  # å·¥å…·å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ request.js         # HTTP è¯·æ±‚å°è£…
â”‚   â”‚   â””â”€â”€ mqtt.js            # MQTT å·¥å…·
â”‚   â”œâ”€â”€ App.vue
â”‚   â””â”€â”€ main.js
â””â”€â”€ package.json
```

### 7.2 Ditto API å°è£…

åˆ›å»º `src/api/ditto.js`ï¼š

```javascript
import axios from 'axios'

const DITTO_BASE_URL = 'http://localhost:8080/api/2'

// åˆ›å»º axios å®ä¾‹
const dittoApi = axios.create({
  baseURL: DITTO_BASE_URL,
  timeout: 10000,
  headers: {
    'Content-Type': 'application/json'
  }
})

/**
 * Ditto API å°è£…
 */
export default {
  /**
   * è·å–æ‰€æœ‰ Things
   */
  async getAllThings() {
    const response = await dittoApi.get('/things')
    return response.data
  },

  /**
   * è·å–å•ä¸ª Thing
   */
  async getThing(thingId) {
    const response = await dittoApi.get(`/things/${thingId}`)
    return response.data
  },

  /**
   * åˆ›å»º Thing
   */
  async createThing(thingId, data) {
    const response = await dittoApi.put(`/things/${thingId}`, data)
    return response.data
  },

  /**
   * æ›´æ–° Thing å±æ€§
   */
  async updateThingAttribute(thingId, attributePath, value) {
    const response = await dittoApi.put(
      `/things/${thingId}/attributes/${attributePath}`,
      value
    )
    return response.data
  },

  /**
   * æ›´æ–° Feature å±æ€§
   */
  async updateFeatureProperty(thingId, featureId, propertyPath, value) {
    const response = await dittoApi.put(
      `/things/${thingId}/features/${featureId}/properties/${propertyPath}`,
      value
    )
    return response.data
  },

  /**
   * æœç´¢ Thingsï¼ˆRQL æŸ¥è¯¢ï¼‰
   */
  async searchThings(filter, options = {}) {
    const params = {
      filter,
      ...options  // æ”¯æŒ optionã€namespacesã€fields ç­‰å‚æ•°
    }
    const response = await dittoApi.get('/search/things', { params })
    return response.data
  },

  /**
   * åˆ é™¤ Thing
   */
  async deleteThing(thingId) {
    const response = await dittoApi.delete(`/things/${thingId}`)
    return response.data
  },

  /**
   * å‘é€æ¶ˆæ¯ç»™ Thing
   */
  async sendMessage(thingId, messageSubject, payload) {
    const response = await dittoApi.post(
      `/things/${thingId}/inbox/messages/${messageSubject}`,
      payload
    )
    return response.data
  }
}
```

### 7.3 è®¾å¤‡åˆ—è¡¨é¡µé¢å®ç°

åˆ›å»º `src/views/DeviceManage.vue`ï¼š

```vue
<template>
  <div class="device-manage">
    <el-card class="header-card">
      <div class="header-actions">
        <el-input
          v-model="searchText"
          placeholder="æœç´¢è®¾å¤‡..."
          style="width: 300px"
          clearable
          @input="handleSearch"
        >
          <template #prefix>
            <el-icon><Search /></el-icon>
          </template>
        </el-input>
        
        <el-button type="primary" @click="showCreateDialog = true">
          <el-icon><Plus /></el-icon>
          æ·»åŠ è®¾å¤‡
        </el-button>
      </div>
    </el-card>

    <el-card class="device-list-card">
      <el-table :data="filteredDevices" style="width: 100%" v-loading="loading">
        <el-table-column prop="thingId" label="è®¾å¤‡ ID" width="250" />
        
        <el-table-column label="åˆ¶é€ å•†">
          <template #default="{ row }">
            {{ row.attributes?.manufacturer || '-' }}
          </template>
        </el-table-column>
        
        <el-table-column label="å‹å·">
          <template #default="{ row }">
            {{ row.attributes?.model || '-' }}
          </template>
        </el-table-column>
        
        <el-table-column label="ä½ç½®">
          <template #default="{ row }">
            {{ formatLocation(row.attributes?.location) }}
          </template>
        </el-table-column>
        
        <el-table-column label="æ¸©åº¦">
          <template #default="{ row }">
            <span :class="getTemperatureClass(row.features?.temperature?.properties?.value)">
              {{ row.features?.temperature?.properties?.value || '-' }}
              {{ row.features?.temperature?.properties?.unit }}
            </span>
          </template>
        </el-table-column>
        
        <el-table-column label="æ¹¿åº¦">
          <template #default="{ row }">
            {{ row.features?.humidity?.properties?.value || '-' }}
            {{ row.features?.humidity?.properties?.unit }}
          </template>
        </el-table-column>
        
        <el-table-column label="æ“ä½œ" width="200">
          <template #default="{ row }">
            <el-button size="small" @click="viewDevice(row)">è¯¦æƒ…</el-button>
            <el-button size="small" type="danger" @click="deleteDevice(row)">
              åˆ é™¤
            </el-button>
          </template>
        </el-table-column>
      </el-table>
    </el-card>

    <!-- åˆ›å»ºè®¾å¤‡å¯¹è¯æ¡† -->
    <el-dialog v-model="showCreateDialog" title="æ·»åŠ è®¾å¤‡" width="600px">
      <el-form :model="newDevice" label-width="100px">
        <el-form-item label="è®¾å¤‡ ID">
          <el-input v-model="newDevice.thingId" placeholder="org.example:device-001" />
        </el-form-item>
        
        <el-form-item label="åˆ¶é€ å•†">
          <el-input v-model="newDevice.manufacturer" />
        </el-form-item>
        
        <el-form-item label="å‹å·">
          <el-input v-model="newDevice.model" />
        </el-form-item>
        
        <el-form-item label="æ¥¼æ ‹">
          <el-input v-model="newDevice.building" />
        </el-form-item>
        
        <el-form-item label="æ¥¼å±‚">
          <el-input v-model="newDevice.floor" />
        </el-form-item>
        
        <el-form-item label="æˆ¿é—´">
          <el-input v-model="newDevice.room" />
        </el-form-item>
      </el-form>
      
      <template #footer>
        <el-button @click="showCreateDialog = false">å–æ¶ˆ</el-button>
        <el-button type="primary" @click="createDevice" :loading="creating">
          åˆ›å»º
        </el-button>
      </template>
    </el-dialog>
  </div>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue'
import { ElMessage, ElMessageBox } from 'element-plus'
import { Search, Plus } from '@element-plus/icons-vue'
import dittoApi from '@/api/ditto'

const devices = ref([])
const loading = ref(false)
const searchText = ref('')
const showCreateDialog = ref(false)
const creating = ref(false)

const newDevice = ref({
  thingId: '',
  manufacturer: '',
  model: '',
  building: '',
  floor: '',
  room: ''
})

// è¿‡æ»¤åçš„è®¾å¤‡åˆ—è¡¨
const filteredDevices = computed(() => {
  if (!searchText.value) return devices.value
  
  const search = searchText.value.toLowerCase()
  return devices.value.filter(device => 
    device.thingId.toLowerCase().includes(search) ||
    device.attributes?.manufacturer?.toLowerCase().includes(search) ||
    device.attributes?.model?.toLowerCase().includes(search)
  )
})

// åŠ è½½è®¾å¤‡åˆ—è¡¨
const loadDevices = async () => {
  loading.value = true
  try {
    const response = await dittoApi.getAllThings()
    devices.value = response.items || []
  } catch (error) {
    ElMessage.error('åŠ è½½è®¾å¤‡åˆ—è¡¨å¤±è´¥')
    console.error(error)
  } finally {
    loading.value = false
  }
}

// åˆ›å»ºè®¾å¤‡
const createDevice = async () => {
  if (!newDevice.value.thingId) {
    ElMessage.warning('è¯·è¾“å…¥è®¾å¤‡ ID')
    return
  }
  
  creating.value = true
  try {
    const data = {
      attributes: {
        manufacturer: newDevice.value.manufacturer,
        model: newDevice.value.model,
        location: {
          building: newDevice.value.building,
          floor: newDevice.value.floor,
          room: newDevice.value.room
        }
      },
      features: {
        temperature: {
          properties: {
            value: 0,
            unit: 'Â°C'
          }
        },
        humidity: {
          properties: {
            value: 0,
            unit: '%'
          }
        }
      }
    }
    
    await dittoApi.createThing(newDevice.value.thingId, data)
    ElMessage.success('è®¾å¤‡åˆ›å»ºæˆåŠŸ')
    showCreateDialog.value = false
    loadDevices()
    
    // é‡ç½®è¡¨å•
    newDevice.value = {
      thingId: '',
      manufacturer: '',
      model: '',
      building: '',
      floor: '',
      room: ''
    }
  } catch (error) {
    ElMessage.error('åˆ›å»ºè®¾å¤‡å¤±è´¥')
    console.error(error)
  } finally {
    creating.value = false
  }
}

// åˆ é™¤è®¾å¤‡
const deleteDevice = async (device) => {
  try {
    await ElMessageBox.confirm(
      `ç¡®å®šè¦åˆ é™¤è®¾å¤‡ ${device.thingId} å—ï¼Ÿ`,
      'ç¡®è®¤åˆ é™¤',
      {
        confirmButtonText: 'åˆ é™¤',
        cancelButtonText: 'å–æ¶ˆ',
        type: 'warning'
      }
    )
    
    await dittoApi.deleteThing(device.thingId)
    ElMessage.success('è®¾å¤‡åˆ é™¤æˆåŠŸ')
    loadDevices()
  } catch (error) {
    if (error !== 'cancel') {
      ElMessage.error('åˆ é™¤è®¾å¤‡å¤±è´¥')
      console.error(error)
    }
  }
}

// æŸ¥çœ‹è®¾å¤‡è¯¦æƒ…
const viewDevice = (device) => {
  // è·³è½¬åˆ°è®¾å¤‡è¯¦æƒ…é¡µ
  console.log('View device:', device)
}

// æ ¼å¼åŒ–ä½ç½®
const formatLocation = (location) => {
  if (!location) return '-'
  return `${location.building || ''}-${location.floor || ''}F-${location.room || ''}`
}

// è·å–æ¸©åº¦æ ·å¼ç±»
const getTemperatureClass = (temp) => {
  if (!temp) return ''
  if (temp > 30) return 'temp-high'
  if (temp < 15) return 'temp-low'
  return 'temp-normal'
}

const handleSearch = () => {
  // æœç´¢é€»è¾‘å·²åœ¨ computed ä¸­å®ç°
}

onMounted(() => {
  loadDevices()
})
</script>

<style scoped>
.device-manage {
  padding: 20px;
}

.header-card {
  margin-bottom: 20px;
}

.header-actions {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.temp-high {
  color: #f56c6c;
  font-weight: bold;
}

.temp-low {
  color: #409eff;
  font-weight: bold;
}

.temp-normal {
  color: #67c23a;
}
</style>
```

---

## å…«ã€å®æ—¶é€šä¿¡ WebSocket

### 8.1 WebSocket è¿æ¥

Ditto æ”¯æŒé€šè¿‡ WebSocket è®¢é˜… Thing çš„å®æ—¶å˜åŒ–ã€‚

**åˆ›å»º WebSocket è¿æ¥**ï¼ˆJavaScriptï¼‰ï¼š

```javascript
// src/utils/dittoWebSocket.js
export class DittoWebSocket {
  constructor(wsUrl = 'ws://localhost:8080/ws/2') {
    this.wsUrl = wsUrl
    this.ws = null
    this.handlers = new Map()
    this.reconnectInterval = 5000
  }

  connect() {
    this.ws = new WebSocket(this.wsUrl)

    this.ws.onopen = () => {
      console.log('âœ“ WebSocket connected')
      
      // è®¢é˜…æ‰€æœ‰ Things çš„å˜åŒ–
      this.subscribe()
    }

    this.ws.onmessage = (event) => {
      try {
        const message = JSON.parse(event.data)
        this.handleMessage(message)
      } catch (error) {
        console.error('Failed to parse WebSocket message:', error)
      }
    }

    this.ws.onerror = (error) => {
      console.error('WebSocket error:', error)
    }

    this.ws.onclose = () => {
      console.log('WebSocket closed. Reconnecting...')
      setTimeout(() => this.connect(), this.reconnectInterval)
    }
  }

  subscribe(filter = null) {
    const subscribeMessage = {
      topic: 'org.example/org.example:temp-sensor-001/things/twin/commands/subscribe',
      path: '/',
      value: {
        filter: filter || 'true'
      }
    }
    
    this.send(subscribeMessage)
  }

  send(message) {
    if (this.ws && this.ws.readyState === WebSocket.OPEN) {
      this.ws.send(JSON.stringify(message))
    }
  }

  handleMessage(message) {
    console.log('WebSocket message:', message)
    
    // è§¦å‘æ³¨å†Œçš„å¤„ç†å‡½æ•°
    this.handlers.forEach(handler => handler(message))
  }

  onMessage(handler) {
    const id = Symbol()
    this.handlers.set(id, handler)
    
    return () => {
      this.handlers.delete(id)
    }
  }

  disconnect() {
    if (this.ws) {
      this.ws.close()
      this.ws = null
    }
    }
}
```

**åœ¨ Vue ç»„ä»¶ä¸­ä½¿ç”¨**ï¼š

```vue
<script setup>
import { onMounted, onUnmounted } from 'vue'
import { DittoWebSocket } from '@/utils/dittoWebSocket'

let dittoWs = null

onMounted(() => {
  dittoWs = new DittoWebSocket()
  dittoWs.connect()
  
  // è®¢é˜…æ¶ˆæ¯
  const unsubscribe = dittoWs.onMessage((message) => {
    console.log('Thing updated:', message)
    // æ›´æ–° UI
  })
  
  onUnmounted(() => {
    unsubscribe()
    dittoWs.disconnect()
  })
})
</script>
```

---

## ä¹ã€é¡¹ç›®å®æˆ˜æ¡ˆä¾‹

### 9.1 æ™ºèƒ½å·¥å‚æ¸©åº¦ç›‘æ§ç³»ç»Ÿ

**åœºæ™¯æè¿°**ï¼š
- å·¥å‚æœ‰ 100+ ä¸ªæ¸©åº¦ä¼ æ„Ÿå™¨
- éœ€è¦å®æ—¶ç›‘æ§æ‰€æœ‰è®¾å¤‡æ¸©åº¦
- æ¸©åº¦è¶…è¿‡ 30Â°C æ—¶è§¦å‘å‘Šè­¦
- æä¾›å†å²æ•°æ®åˆ†æå’Œè¶‹åŠ¿é¢„æµ‹

**å®ç°æ­¥éª¤**ï¼š

#### 1. åˆ›å»ºè®¾å¤‡æ‰¹é‡å¯¼å…¥è„šæœ¬

```python
# scripts/import_devices.py
import requests

DITTO_API = "http://localhost:8080/api/2"

# è®¾å¤‡é…ç½®
devices = [
    {"id": f"org.factory:temp-sensor-{i:03d}", 
     "building": "A", 
     "floor": str(i // 10 + 1), 
     "room": str(i % 10 + 101)} 
    for i in range(1, 101)
]

def create_device(device_id, building, floor, room):
    """åˆ›å»ºè®¾å¤‡"""
    url = f"{DITTO_API}/things/{device_id}"
    data = {
        "attributes": {
            "manufacturer": "Acme Inc.",
            "model": "TempSensor-Industrial",
            "location": {
                "building": building,
                "floor": floor,
                "room": room
            }
        },
        "features": {
            "temperature": {
                "properties": {
                    "value": 25.0,
                    "unit": "Â°C",
                    "status": "normal"
                }
            }
        }
    }
    
    response = requests.put(url, json=data)
    return response.status_code

# æ‰¹é‡åˆ›å»ºè®¾å¤‡
for device in devices:
    status = create_device(
        device["id"], 
        device["building"], 
        device["floor"], 
        device["room"]
    )
    print(f"âœ“ Created {device['id']}: {status}")
```

#### 2. è®¾å¤‡æ•°æ®æ¨¡æ‹Ÿå™¨

```python
# scripts/device_simulator.py
import paho.mqtt.client as mqtt
import json
import time
import random
from datetime import datetime

MQTT_BROKER = "localhost"
MQTT_PORT = 1883

def simulate_temperature():
    """æ¨¡æ‹Ÿæ¸©åº¦å€¼ï¼ˆæ­£æ€åˆ†å¸ƒï¼Œå¶å°”å‡ºç°å¼‚å¸¸ï¼‰"""
    if random.random() < 0.05:  # 5% æ¦‚ç‡å‡ºç°é«˜æ¸©
        return round(random.uniform(30, 35), 2)
    else:
        return round(random.gauss(25, 3), 2)  # æ­£å¸¸èŒƒå›´ 20-30Â°C

def publish_data(client, device_id):
    """å‘å¸ƒè®¾å¤‡æ•°æ®"""
    namespace, name = device_id.split(":")
    topic = f"{namespace}/{name}/things/twin/commands/modify"
    
    temperature = simulate_temperature()
    
    message = {
        "topic": f"{namespace}/{name}/things/twin/commands/modify",
        "path": "/features/temperature/properties",
        "value": {
            "value": temperature,
            "unit": "Â°C",
            "status": "high" if temperature > 30 else "normal",
            "timestamp": datetime.utcnow().isoformat() + "Z"
        }
    }
    
    client.publish(topic, json.dumps(message))
    return temperature

# MQTT å®¢æˆ·ç«¯
client = mqtt.Client()
client.connect(MQTT_BROKER, MQTT_PORT, 60)
client.loop_start()

# æ¨¡æ‹Ÿ 100 ä¸ªè®¾å¤‡
devices = [f"org.factory:temp-sensor-{i:03d}" for i in range(1, 101)]

print("å¼€å§‹æ¨¡æ‹Ÿè®¾å¤‡æ•°æ®ä¸ŠæŠ¥...")
try:
    while True:
        for device_id in devices:
            temp = publish_data(client, device_id)
            print(f"ğŸ“¡ {device_id}: {temp}Â°C")
        
        time.sleep(60)  # æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡
        
except KeyboardInterrupt:
    print("\nåœæ­¢æ¨¡æ‹Ÿ")
    client.loop_stop()
    client.disconnect()
```

### 9.2 æ•°æ®åˆ†æä»ªè¡¨æ¿

**Grafana ä»ªè¡¨æ¿é…ç½®**ï¼š

1. **æ¸©åº¦åˆ†å¸ƒçƒ­åŠ›å›¾**

```flux
from(bucket: "telegraf")
  |> range(start: -1h)
  |> filter(fn: (r) => r["_measurement"] == "temperature")
  |> filter(fn: (r) => r["_field"] == "value")
  |> aggregateWindow(every: 5m, fn: mean)
```

2. **å¼‚å¸¸è®¾å¤‡åˆ—è¡¨**

```flux
from(bucket: "telegraf")
  |> range(start: -5m)
  |> filter(fn: (r) => r["_measurement"] == "temperature")
  |> filter(fn: (r) => r["_field"] == "value")
  |> filter(fn: (r) => r._value > 30.0)
  |> last()
```

3. **æ¸©åº¦è¶‹åŠ¿é¢„æµ‹**ï¼ˆä½¿ç”¨ Holt-Winters ç®—æ³•ï¼‰

```flux
from(bucket: "telegraf")
  |> range(start: -7d)
  |> filter(fn: (r) => r["_measurement"] == "temperature")
  |> aggregateWindow(every: 1h, fn: mean)
  |> holtWinters(n: 24, interval: 1h)
```

---

## åã€æœ€ä½³å®è·µ

### 10.1 Thing ID å‘½åè§„èŒƒ

**æ¨èæ ¼å¼**ï¼š`{namespace}:{resource-type}-{identifier}`

```
org.factory:temp-sensor-001
org.factory:pump-motor-A12
com.warehouse:conveyor-belt-B03
```

**é¿å…**ï¼š
- âŒ è¿‡é•¿çš„ IDï¼š`org.company.department.factory.building-a.floor-2.room-201.temp-sensor-001`
- âŒ ç‰¹æ®Šå­—ç¬¦ï¼š`sensor#001`ã€`device@abc`
- âŒ ä¸­æ–‡å­—ç¬¦ï¼š`æ¸©åº¦ä¼ æ„Ÿå™¨-001`

### 10.2 æ•°æ®æ›´æ–°ç­–ç•¥

**é«˜é¢‘æ•°æ®ï¼ˆ> 1 Hzï¼‰**ï¼š
```javascript
// ä½¿ç”¨æ‰¹é‡æ›´æ–°å‡å°‘ API è°ƒç”¨
const batchUpdate = {
  "temperature": { "properties": { "value": 25.5 } },
  "humidity": { "properties": { "value": 65.2 } },
  "pressure": { "properties": { "value": 101.3 } }
}

await dittoApi.put(`/things/${thingId}/features`, batchUpdate)
```

**ä½é¢‘æ•°æ®ï¼ˆ< 1 æ¬¡/åˆ†é’Ÿï¼‰**ï¼š
```javascript
// å•ç‹¬æ›´æ–°æ¯ä¸ªå±æ€§
await dittoApi.put(
  `/things/${thingId}/features/battery/properties/level`,
  85
)
```

### 10.3 æƒé™ç®¡ç†

**ä¸ºä¸åŒè§’è‰²åˆ›å»º Policy**ï¼š

```json
{
  "policyId": "org.factory:device-policy",
  "entries": {
    "admin": {
      "subjects": {
        "nginx:admin": { "type": "admin" }
      },
      "resources": {
        "thing:/": { "grant": ["READ", "WRITE"], "revoke": [] },
        "policy:/": { "grant": ["READ", "WRITE"], "revoke": [] },
        "message:/": { "grant": ["READ", "WRITE"], "revoke": [] }
      }
    },
    "operator": {
      "subjects": {
        "nginx:operator": { "type": "operator" }
      },
      "resources": {
        "thing:/": { "grant": ["READ", "WRITE"], "revoke": [] },
        "policy:/": { "grant": ["READ"], "revoke": ["WRITE"] },
        "message:/": { "grant": ["READ", "WRITE"], "revoke": [] }
      }
    },
    "viewer": {
      "subjects": {
        "nginx:viewer": { "type": "viewer" }
      },
      "resources": {
        "thing:/": { "grant": ["READ"], "revoke": ["WRITE"] },
        "policy:/": { "grant": [], "revoke": ["READ", "WRITE"] },
        "message:/": { "grant": ["READ"], "revoke": ["WRITE"] }
      }
        }
    }
}
```

### 10.4 æ€§èƒ½ä¼˜åŒ–

**1. ä½¿ç”¨æœç´¢ API ä»£æ›¿è½®è¯¢**

âŒ **ä¸æ¨è**ï¼ˆè½®è¯¢æ‰€æœ‰è®¾å¤‡ï¼‰ï¼š
```javascript
setInterval(async () => {
  const things = await dittoApi.getAllThings()
  // å¤„ç†æ•°æ®...
}, 5000)
```

âœ… **æ¨è**ï¼ˆä½¿ç”¨ WebSocket è®¢é˜…ï¼‰ï¼š
```javascript
const ws = new DittoWebSocket()
ws.onMessage((message) => {
  // å®æ—¶å¤„ç†å˜åŒ–
})
```

**2. æ‰¹é‡æ“ä½œ**

```javascript
// æ‰¹é‡åˆ é™¤
const thingIds = ['org.example:device-001', 'org.example:device-002']
await Promise.all(thingIds.map(id => dittoApi.deleteThing(id)))
```

**3. åˆ†é¡µæŸ¥è¯¢**

```javascript
// ä½¿ç”¨ option å‚æ•°è¿›è¡Œåˆ†é¡µ
const page1 = await dittoApi.searchThings('eq(attributes/manufacturer,"Acme")', {
  option: 'size(50),cursor(0)'
})
```

---

## åä¸€ã€æ•…éšœæ’æŸ¥

### 11.1 å¸¸è§é—®é¢˜

**é—®é¢˜ 1ï¼šæ— æ³•åˆ›å»º Thing**

```
HTTP 400 Bad Request: Thing ID must match pattern namespace:name
```

**è§£å†³æ–¹æ¡ˆ**ï¼šæ£€æŸ¥ Thing ID æ ¼å¼ï¼Œå¿…é¡»åŒ…å«å‘½åç©ºé—´å’Œåç§°ï¼Œç”¨å†’å·åˆ†éš”ã€‚

```javascript
// âŒ é”™è¯¯
"my-device"

// âœ… æ­£ç¡®
"org.example:my-device"
```

**é—®é¢˜ 2ï¼šMQTT æ¶ˆæ¯æœªç”Ÿæ•ˆ**

**æ’æŸ¥æ­¥éª¤**ï¼š
1. æ£€æŸ¥ MQTT è¿æ¥æ˜¯å¦é…ç½®
2. éªŒè¯ä¸»é¢˜æ ¼å¼
3. æŸ¥çœ‹ Ditto connectivity æ—¥å¿—

```bash
# æŸ¥çœ‹ connectivity æœåŠ¡æ—¥å¿—
kubectl logs -f opentwins-ditto-connectivity-xxx
```

**é—®é¢˜ 3ï¼šWebSocket è¿æ¥å¤±è´¥**

**è§£å†³æ–¹æ¡ˆ**ï¼šæ£€æŸ¥ç«¯å£è½¬å‘æ˜¯å¦æ­£å¸¸

```bash
# é‡æ–°å¯åŠ¨ç«¯å£è½¬å‘
kubectl port-forward svc/opentwins-ditto-nginx 8080:8080
```

### 11.2 ç›‘æ§å’Œæ—¥å¿—

**æŸ¥çœ‹ OpenTwins ç»„ä»¶æ—¥å¿—**ï¼š

```bash
# æŸ¥çœ‹æ‰€æœ‰ Pod
kubectl get pods

# æŸ¥çœ‹ç‰¹å®šæœåŠ¡æ—¥å¿—
kubectl logs -f opentwins-ditto-gateway-xxx
kubectl logs -f opentwins-ditto-things-xxx
kubectl logs -f opentwins-influxdb2-0

# æŸ¥çœ‹æœ€è¿‘çš„äº‹ä»¶
kubectl get events --sort-by='.lastTimestamp'
```

---

## åäºŒã€æ€»ç»“ä¸å±•æœ›

### 12.1 é¡¹ç›®æ€»ç»“

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»äº†åŸºäº OpenTwins å¹³å°æ„å»ºæ•°å­—å­ªç”Ÿåº”ç”¨çš„å®Œæ•´æµç¨‹ï¼š

âœ… **å¹³å°éƒ¨ç½²**ï¼šOpenTwins åœ¨ Windows æœ¬åœ°ç¯å¢ƒçš„å®‰è£…å’Œé…ç½®
âœ… **æ ¸å¿ƒæ¦‚å¿µ**ï¼šEclipse Ditto çš„ Thingsã€Featuresã€Policies æ•°æ®æ¨¡å‹
âœ… **API ä½¿ç”¨**ï¼šå®Œæ•´çš„ Ditto HTTP API æ“ä½œç¤ºä¾‹
âœ… **è®¾å¤‡æ¥å…¥**ï¼šMQTT å’Œ HTTP ä¸¤ç§è®¾å¤‡æ¥å…¥æ–¹å¼
âœ… **æ•°æ®å¯è§†åŒ–**ï¼šGrafana ç›‘æ§ä»ªè¡¨æ¿é…ç½®
âœ… **åº”ç”¨å¼€å‘**ï¼šVue3 å‰ç«¯åº”ç”¨å¼€å‘å®è·µ
âœ… **å®æ—¶é€šä¿¡**ï¼šWebSocket å®æ—¶æ•°æ®è®¢é˜…
âœ… **æœ€ä½³å®è·µ**ï¼šå‘½åè§„èŒƒã€æ€§èƒ½ä¼˜åŒ–ã€æƒé™ç®¡ç†

### 12.2 æŠ€æœ¯ä¼˜åŠ¿

ä½¿ç”¨ OpenTwins çš„ä¼˜åŠ¿ï¼š

| ä¼˜åŠ¿ | è¯´æ˜ |
|------|------|
| ğŸš€ **å¿«é€Ÿéƒ¨ç½²** | ä¸€é”®éƒ¨ç½²å®Œæ•´æ•°å­—å­ªç”Ÿå¹³å° |
| ğŸ¯ **æ ‡å‡†åŒ–** | åŸºäº Eclipse Dittoï¼Œç¬¦åˆå·¥ä¸šæ ‡å‡† |
| ğŸ’° **æˆæœ¬ä½** | å¼€æºå…è´¹ï¼Œæ— æˆæƒè´¹ç”¨ |
| ğŸ”§ **æ˜“æ‰©å±•** | å¾®æœåŠ¡æ¶æ„ï¼Œæ”¯æŒæ°´å¹³æ‰©å±• |
| ğŸ“Š **å¯è§†åŒ–** | å†…ç½® Grafanaï¼Œå¼€ç®±å³ç”¨ |
| ğŸ”’ **å®‰å…¨æ€§** | å®Œå–„çš„æƒé™æ§åˆ¶æœºåˆ¶ |

### 12.3 ä¸‹ä¸€æ­¥è®¡åˆ’

**åŠŸèƒ½æ‰©å±•**ï¼š

1. **3D å¯è§†åŒ–**
   - é›†æˆ Three.js å®ç° 3D åœºæ™¯
   - è®¾å¤‡åœ¨ 3D ç©ºé—´ä¸­çš„å®æ—¶å®šä½
   - ç‚¹å‡»è®¾å¤‡æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯

2. **AI é¢„æµ‹**
   - è®¾å¤‡æ•…éšœé¢„æµ‹æ¨¡å‹
   - æ¸©åº¦è¶‹åŠ¿é¢„æµ‹
   - å¼‚å¸¸æ£€æµ‹ç®—æ³•

3. **å‘Šè­¦ç³»ç»Ÿ**
   - å¤šçº§å‘Šè­¦è§„åˆ™
   - çŸ­ä¿¡/é‚®ä»¶é€šçŸ¥
   - å‘Šè­¦å‡çº§æœºåˆ¶

4. **ç§»åŠ¨ç«¯åº”ç”¨**
   - UniApp è·¨å¹³å°å¼€å‘
   - å®æ—¶æ¨é€é€šçŸ¥
   - ç¦»çº¿æ•°æ®ç¼“å­˜

**ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²**ï¼š

1. **Kubernetes é›†ç¾¤**
   - ä½¿ç”¨ç”Ÿäº§çº§ Kubernetes é›†ç¾¤
   - é…ç½®é«˜å¯ç”¨æ€§
   - è®¾ç½®èµ„æºé™åˆ¶

2. **ç›‘æ§å’Œè¿ç»´**
   - Prometheus + Grafana ç›‘æ§
   - ELK æ—¥å¿—æ”¶é›†
   - è‡ªåŠ¨å¤‡ä»½å’Œæ¢å¤

3. **å®‰å…¨åŠ å›º**
   - HTTPS/TLS åŠ å¯†
   - OAuth2 è®¤è¯
   - API è®¿é—®é™æµ

### 12.4 å‚è€ƒèµ„æº

**å®˜æ–¹æ–‡æ¡£**ï¼š
- [OpenTwins å®˜ç½‘](https://ertis-research.github.io/opentwins/)
- [Eclipse Ditto æ–‡æ¡£](https://www.eclipse.org/ditto/)
- [InfluxDB æ–‡æ¡£](https://docs.influxdata.com/)
- [Grafana æ–‡æ¡£](https://grafana.com/docs/)

**ç¤¾åŒºèµ„æº**ï¼š
- [Ditto GitHub](https://github.com/eclipse-ditto/ditto)
- [OpenTwins GitHub](https://github.com/ertis-research/opentwins)
- [Ditto ä¸­æ–‡ç¤¾åŒº](https://gitee.com/eclipse-ditto)

**å­¦ä¹ è·¯å¾„**ï¼š
1. å®Œæˆ OpenTwins æœ¬åœ°éƒ¨ç½²
2. å­¦ä¹  Ditto Things æ•°æ®æ¨¡å‹
3. å¼€å‘ç®€å•çš„è®¾å¤‡æ¥å…¥ç¨‹åº
4. åˆ›å»º Grafana ç›‘æ§ä»ªè¡¨æ¿
5. å¼€å‘ Vue å‰ç«¯åº”ç”¨
6. é›†æˆå®æ—¶ WebSocket é€šä¿¡
7. éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼š1.0.0
**æœ€åæ›´æ–°**ï¼š2025-01-15
**ä½œè€…**ï¼šLaby
**è®¸å¯è¯**ï¼šMIT

**ç›¸å…³æ–‡æ¡£**ï¼š
- [OpenTwins Windows æœ¬åœ°éƒ¨ç½²å®æˆ˜æŒ‡å—](../digital-twin/opentwins-windows-deployment)
- [OpenTwins Linux ç¦»çº¿éƒ¨ç½²æŒ‡å—](../digital-twin/opentwins-linux-offline-deployment)
- [æ•°å­—å­ªç”ŸæŠ€æœ¯æ¦‚è¿°](../digital-twin/digital-twin-intro)

---

ğŸ‰ **æ­å–œï¼** æ‚¨å·²ç»æŒæ¡äº†åŸºäº OpenTwins æ„å»ºæ•°å­—å­ªç”Ÿåº”ç”¨çš„å…¨éƒ¨çŸ¥è¯†ã€‚ç°åœ¨å¼€å§‹åŠ¨æ‰‹å®è·µå§ï¼
