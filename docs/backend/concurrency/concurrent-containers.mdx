---
sidebar_position: 6
title: "Javaå¹¶å‘å®¹å™¨è¯¦è§£"
description: "å…¨é¢ä»‹ç»Javaå¹¶å‘å®¹å™¨ã€çº¿ç¨‹å®‰å…¨é›†åˆã€æ€§èƒ½ä¼˜åŒ–ä¸æœ€ä½³å®è·µ"
authors: [Laby]
last_update:
  date: 2025-01-07
  author: Laby
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import TOCInline from '@theme/TOCInline';

# Java å¹¶å‘å®¹å™¨è¯¦è§£

Javaå¹¶å‘åŒ…æä¾›äº†å¤šç§çº¿ç¨‹å®‰å…¨çš„å®¹å™¨ç±»ï¼Œè¿™äº›å®¹å™¨ä¸“é—¨ä¸ºå¤šçº¿ç¨‹ç¯å¢ƒè®¾è®¡ï¼Œæä¾›äº†æ¯”ä½¿ç”¨synchronizedæ›´é«˜æ•ˆçš„å¹¶å‘è®¿é—®æœºåˆ¶ã€‚æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»å„ç§å¹¶å‘å®¹å™¨çš„ä½¿ç”¨æ–¹æ³•å’Œæœ€ä½³å®è·µã€‚

:::info æœ¬æ–‡å†…å®¹æ¦‚è§ˆ
<TOCInline toc={toc} />
:::

:::tip æ ¸å¿ƒä»·å€¼
**å¹¶å‘å®¹å™¨ = çº¿ç¨‹å®‰å…¨æ€§ + é«˜æ€§èƒ½è®¿é—® + ä½ç«äº‰è®¾è®¡ + åŠŸèƒ½æ‰©å±• + ä¾¿æ·API**
- ğŸ›¡ï¸ **çº¿ç¨‹å®‰å…¨**ï¼šæ— éœ€é¢å¤–åŒæ­¥ï¼Œå…é™¤å¹¶å‘é”™è¯¯å›°æ‰°
- âš¡ **é«˜æ€§èƒ½**ï¼šé‡‡ç”¨åˆ†æ®µé”ã€æ— é”ç®—æ³•ç­‰ç°ä»£å¹¶å‘æŠ€æœ¯
- ğŸ”„ **ä¸€è‡´æ€§æ¨¡å‹**ï¼šæä¾›æ¸…æ™°çš„ä¸€è‡´æ€§ä¿è¯
- ğŸš€ **æ‰©å±•æ€§å¼º**ï¼šè‰¯å¥½åº”å¯¹é«˜å¹¶å‘è´Ÿè½½åœºæ™¯
- ğŸ”§ **åŠŸèƒ½ä¸°å¯Œ**ï¼šæä¾›é˜»å¡ã€è¶…æ—¶ç­‰ç‰¹æ€§æ»¡è¶³å¤šæ ·éœ€æ±‚
:::

## 1. å¹¶å‘å®¹å™¨æ¦‚è¿°

### 1.1 ä»€ä¹ˆæ˜¯å¹¶å‘å®¹å™¨ï¼Ÿ

```mermaid
graph TD
    A[å¹¶å‘å®¹å™¨] --> B[å¹¶å‘Map]
    A --> C[å¹¶å‘List/Set]
    A --> D[é˜Ÿåˆ—]
    B --> B1[ConcurrentHashMap]
    B --> B2[ConcurrentSkipListMap]
    C --> C1[CopyOnWriteArrayList]
    C --> C2[CopyOnWriteArraySet]
    C --> C3[ConcurrentSkipListSet]
    D --> D1[é˜»å¡é˜Ÿåˆ—]
    D --> D2[éé˜»å¡é˜Ÿåˆ—]
    D1 --> E1[ArrayBlockingQueue]
    D1 --> E2[LinkedBlockingQueue]
    D1 --> E3[PriorityBlockingQueue]
    D2 --> F1[ConcurrentLinkedQueue]
    D2 --> F2[ConcurrentLinkedDeque]
```

:::tip æ ¸å¿ƒæ¦‚å¿µ
å¹¶å‘å®¹å™¨æ˜¯Javaå¹¶å‘åŒ…ä¸­æä¾›çš„çº¿ç¨‹å®‰å…¨é›†åˆç±»ï¼Œå®ƒä»¬é€šè¿‡ä¸åŒçš„å¹¶å‘æ§åˆ¶æœºåˆ¶ï¼ˆå¦‚åˆ†æ®µé”ã€CASæ“ä½œã€è¯»å†™é”ç­‰ï¼‰å®ç°çº¿ç¨‹å®‰å…¨ï¼Œé¿å…äº†ä½¿ç”¨synchronizedçš„æ€§èƒ½å¼€é”€ã€‚
:::

### 1.2 å¹¶å‘å®¹å™¨ä¸ä¼ ç»ŸåŒæ­¥å®¹å™¨å¯¹æ¯”

<div className="card">
<div className="card__body">

| ç‰¹æ€§ | ä¼ ç»ŸåŒæ­¥å®¹å™¨ | å¹¶å‘å®¹å™¨ |
|------|------------|----------|
| **å®ç°æ–¹å¼** | `Collections.synchronizedXxx` | `java.util.concurrent` åŒ… |
| **åŒæ­¥æœºåˆ¶** | æ–¹æ³•çº§synchronizedé” | åˆ†æ®µé”ã€CASã€è¯»å†™åˆ†ç¦»ç­‰ |
| **é”ç²’åº¦** | ç²—ç²’åº¦ï¼ˆæ•´ä¸ªå®¹å™¨ï¼‰ | ç»†ç²’åº¦ï¼ˆéƒ¨åˆ†æ•°æ®ï¼‰ |
| **æ€§èƒ½** | é«˜å¹¶å‘ä¸‹æ€§èƒ½è¾ƒå·® | é«˜å¹¶å‘ä¸‹æ€§èƒ½æ›´å¥½ |
| **è¿­ä»£å™¨** | fail-fastæœºåˆ¶ | å¼±ä¸€è‡´æ€§æˆ–å¿«ç…§è¿­ä»£ |
| **é˜»å¡æ“ä½œ** | ä¸æ”¯æŒ | éƒ¨åˆ†å®¹å™¨æ”¯æŒ |
| **åŸå­å¤åˆæ“ä½œ** | éœ€è¦é¢å¤–åŒæ­¥ | éƒ¨åˆ†å®¹å™¨åŸç”Ÿæ”¯æŒ |

</div>
</div>

### 1.3 å¹¶å‘å®¹å™¨åˆ†ç±»

<Tabs>
  <TabItem value="map" label="å¹¶å‘Map" default>
  <div className="card">
  <div className="card__header">
  <h4>å¹¶å‘Mapå®ç°ç±»</h4>
  </div>
  <div className="card__body">
  <ul>
  <li><strong>ConcurrentHashMap</strong>ï¼šåˆ†æ®µé”å®ç°çš„é«˜æ€§èƒ½çº¿ç¨‹å®‰å…¨å“ˆå¸Œè¡¨</li>
  <li><strong>ConcurrentSkipListMap</strong>ï¼šåŸºäºè·³è¡¨çš„æœ‰åºå¹¶å‘Mapï¼Œé€‚åˆé«˜å¹¶å‘è¯»å–</li>
  </ul>
  </div>
  </div>

  ```java
  // åˆ›å»ºå¹¶å‘Map
  Map<String, Integer> concurrentMap = new ConcurrentHashMap<>();
  // çº¿ç¨‹å®‰å…¨æ“ä½œ
  concurrentMap.put("one", 1);
  concurrentMap.putIfAbsent("two", 2); // åŸå­æ€§çš„"å¦‚æœä¸å­˜åœ¨åˆ™æ”¾å…¥"
  // å¤åˆæ“ä½œ
  concurrentMap.compute("three", (k, v) -> (v == null) ? 3 : v + 1);
  ```
  </TabItem>
  <TabItem value="list" label="å¹¶å‘List/Set">
  <div className="card">
  <div className="card__header">
  <h4>å¹¶å‘List/Setå®ç°ç±»</h4>
  </div>
  <div className="card__body">
  <ul>
  <li><strong>CopyOnWriteArrayList</strong>ï¼šå†™æ—¶å¤åˆ¶çš„Listå®ç°ï¼Œè¯»å¤šå†™å°‘åœºæ™¯çš„ç†æƒ³é€‰æ‹©</li>
  <li><strong>CopyOnWriteArraySet</strong>ï¼šåŸºäºCopyOnWriteArrayListçš„Setå®ç°</li>
  <li><strong>ConcurrentSkipListSet</strong>ï¼šåŸºäºè·³è¡¨çš„æœ‰åºå¹¶å‘Set</li>
  </ul>
  </div>
  </div>

  ```java
  // åˆ›å»ºå¹¶å‘List
  List<String> concurrentList = new CopyOnWriteArrayList<>();
  // å®‰å…¨çš„å¹¶å‘ä¿®æ”¹
  concurrentList.add("item1");
  // éå†æ—¶ä¸ä¼šæŠ›å‡ºConcurrentModificationException
  for (String item : concurrentList) {
      System.out.println(item);
      concurrentList.add("newItem"); // åœ¨éå†æ—¶ä¿®æ”¹æ˜¯å®‰å…¨çš„
  }
  ```
  </TabItem>
  <TabItem value="queue" label="å¹¶å‘é˜Ÿåˆ—">
  <div className="card">
  <div className="card__header">
  <h4>å¹¶å‘é˜Ÿåˆ—å®ç°ç±»</h4>
  </div>
  <div className="card__body">
  <h5>é˜»å¡é˜Ÿåˆ—</h5>
  <ul>
  <li><strong>ArrayBlockingQueue</strong>ï¼šåŸºäºæ•°ç»„çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—</li>
  <li><strong>LinkedBlockingQueue</strong>ï¼šåŸºäºé“¾è¡¨çš„å¯é€‰æœ‰ç•Œé˜»å¡é˜Ÿåˆ—</li>
  <li><strong>PriorityBlockingQueue</strong>ï¼šæ”¯æŒä¼˜å…ˆçº§çš„æ— ç•Œé˜»å¡é˜Ÿåˆ—</li>
  <li><strong>DelayQueue</strong>ï¼šå»¶è¿Ÿå…ƒç´ é˜Ÿåˆ—ï¼Œå…ƒç´ åˆ°æœŸæ‰èƒ½è¢«å–å‡º</li>
  <li><strong>SynchronousQueue</strong>ï¼šæ²¡æœ‰å†…éƒ¨å®¹é‡çš„é˜»å¡é˜Ÿåˆ—ï¼Œç›´æ¥ä¼ é€’</li>
  </ul>
  <h5>éé˜»å¡é˜Ÿåˆ—</h5>
  <ul>
  <li><strong>ConcurrentLinkedQueue</strong>ï¼šåŸºäºé“¾è¡¨çš„æ— ç•Œéé˜»å¡é˜Ÿåˆ—</li>
  <li><strong>ConcurrentLinkedDeque</strong>ï¼šåŸºäºé“¾è¡¨çš„æ— ç•Œéé˜»å¡åŒç«¯é˜Ÿåˆ—</li>
  </ul>
  </div>
  </div>
  
  ```java
  // åˆ›å»ºé˜»å¡é˜Ÿåˆ—
  BlockingQueue<Task> taskQueue = new LinkedBlockingQueue<>(100);
  
  // ç”Ÿäº§è€… - å¯ä»¥é˜»å¡
  try {
      taskQueue.put(new Task()); // å¦‚æœé˜Ÿåˆ—æ»¡ï¼Œä¼šé˜»å¡
  } catch (InterruptedException e) {
      Thread.currentThread().interrupt();
  }
  
  // æ¶ˆè´¹è€… - å¯ä»¥é˜»å¡
  try {
      Task task = taskQueue.take(); // å¦‚æœé˜Ÿåˆ—ç©ºï¼Œä¼šé˜»å¡
      processTask(task);
  } catch (InterruptedException e) {
      Thread.currentThread().interrupt();
  }
  ```
  </TabItem>
</Tabs>

## 2. ConcurrentHashMapè¯¦è§£

### 2.1 ConcurrentHashMap åŸç†

<details>
<summary><strong>å†…éƒ¨ç»“æ„ä¸å·¥ä½œåŸç†</strong></summary>

```mermaid
graph TD
    A[ConcurrentHashMap] --> B[åˆ†æ®µé”è®¾è®¡<br>JDK 7]
    A --> C[å†…éƒ¨æ”¹è¿›<br>JDK 8+]
    
    B --> D[Segmentæ•°ç»„]
    D --> E[æ¯ä¸ªSegmentåŒ…å«<br>ä¸€ä¸ªHashEntryæ•°ç»„]
    D --> F[æ¯ä¸ªSegmentæœ‰ç‹¬ç«‹é”]
    
    C --> G[Nodeæ•°ç»„]
    G --> H[CAS + synchronized]
    G --> I[çº¢é»‘æ ‘ä¼˜åŒ–<br>é“¾è¡¨é•¿åº¦ > 8]
    
    subgraph "å¹¶å‘æ§åˆ¶"
      H --> J[æ“ä½œåŸå­æ€§]
      H --> K[èŠ‚ç‚¹çº§åˆ«é”å®š]
    end
```

**JDK 7å®ç°**ï¼š
- ä½¿ç”¨åˆ†æ®µé”(Segment)æœºåˆ¶ï¼Œå°†æ•°æ®åˆ†ä¸ºå¤šä¸ªæ®µ
- æ¯ä¸ªæ®µç‹¬ç«‹åŠ é”ï¼Œå‡å°‘é”ç«äº‰
- Segmentç»§æ‰¿è‡ªReentrantLock

**JDK 8+å®ç°**ï¼š
- ç§»é™¤Segmentæ¦‚å¿µï¼Œé‡‡ç”¨Nodeæ•°ç»„+é“¾è¡¨+çº¢é»‘æ ‘ç»“æ„
- ä½¿ç”¨CASæ“ä½œå’Œsynchronizedå®ç°æ›´ç»†ç²’åº¦é”
- å½“é“¾è¡¨é•¿åº¦è¶…è¿‡é˜ˆå€¼(8)æ—¶è½¬æ¢ä¸ºçº¢é»‘æ ‘ï¼Œæå‡æ€§èƒ½
- å¯¹æ¡¶(bucket)çº§åˆ«åŠ é”ï¼Œè¿›ä¸€æ­¥å‡å°‘é”ç«äº‰

</details>

### 2.2 åŸºæœ¬ç”¨æ³•

<Tabs>
  <TabItem value="creation" label="åˆ›å»ºä¸åŸºæœ¬æ“ä½œ" default>
  ```java
  import java.util.concurrent.ConcurrentHashMap;
  
  // åˆ›å»ºConcurrentHashMap
  ConcurrentHashMap<String, Integer> map = new ConcurrentHashMap<>();
  
  // æ·»åŠ å…ƒç´ 
  map.put("apple", 10);
  map.put("banana", 20);
  
  // è·å–å…ƒç´ 
  int appleCount = map.get("apple"); // 10
  
  // åŸå­æ€§çš„"å¦‚æœä¸å­˜åœ¨åˆ™æ·»åŠ "
  map.putIfAbsent("orange", 15); // æ·»åŠ æˆåŠŸï¼Œè¿”å›null
  map.putIfAbsent("apple", 25);  // æ·»åŠ å¤±è´¥ï¼Œè¿”å›10
  
  // ç§»é™¤å…ƒç´ 
  map.remove("banana"); // è¿”å›20
  
  // åŸå­æ€§çš„"å¦‚æœå€¼åŒ¹é…åˆ™ç§»é™¤"
  boolean removed = map.remove("apple", 10); // è¿”å›trueï¼Œç§»é™¤æˆåŠŸ
  ```
  </TabItem>
  <TabItem value="atomic" label="åŸå­æ“ä½œ">
  ```java
  // åŸå­æ€§çš„æ›¿æ¢æ“ä½œ
  map.replace("orange", 15, 25); // ä»…å½“å½“å‰å€¼ä¸º15æ—¶ï¼Œæ›¿æ¢ä¸º25
  
  // è®¡ç®—API - åŸå­æ€§çš„åŸºäºå½“å‰å€¼è®¡ç®—æ–°å€¼
  map.compute("apple", (key, value) -> 
      (value == null) ? 100 : value + 50); // å¦‚æœä¸å­˜åœ¨ï¼Œè®¾ä¸º100ï¼›å¦åˆ™å¢åŠ 50
  
  // ä»…å½“é”®å­˜åœ¨æ—¶è®¡ç®—
  map.computeIfPresent("orange", (key, value) -> value * 2);
  
  // ä»…å½“é”®ä¸å­˜åœ¨æ—¶è®¡ç®—
  map.computeIfAbsent("grape", key -> 30);
  
  // åˆå¹¶æ“ä½œ - ç»“åˆç°æœ‰å€¼å’Œç»™å®šå€¼ç”Ÿæˆæ–°å€¼
  map.merge("apple", 10, (oldValue, value) -> oldValue + value);
  ```
  </TabItem>
  <TabItem value="bulk" label="æ‰¹é‡æ“ä½œ">
  ```java
  // æ‰¹é‡æ·»åŠ 
  ConcurrentHashMap<String, Integer> fruitPrices = new ConcurrentHashMap<>();
  fruitPrices.put("apple", 100);
  fruitPrices.put("banana", 80);
  
  map.putAll(fruitPrices);
  
  // éå† - å¼±ä¸€è‡´æ€§
  map.forEach((key, value) -> 
      System.out.println(key + ": " + value));
  
  // ä½¿ç”¨é”®å€¼è®¡ç®—å€¼
  map.forEach(2, (key, value) -> 
      key + "=" + value, // è½¬æ¢å‡½æ•°
      results -> System.out.println("å¤„ç†ç»“æœ: " + results) // ç»“æœå¤„ç†
  );
  
  // è§„çº¦æ“ä½œ
  Integer sum = map.reduce(2, 
      (key, value) -> value, // è½¬æ¢å‡½æ•°
      (v1, v2) -> v1 + v2    // è§„çº¦å‡½æ•°
  );
  ```
  </TabItem>
</Tabs>

### 2.3 æ€§èƒ½ç‰¹æ€§ä¸æœ€ä½³å®è·µ

<Tabs>
  <TabItem value="perf" label="æ€§èƒ½ç‰¹æ€§" default>
  <div className="card">
  <div className="card__body">
  
  **ConcurrentHashMapçš„æ€§èƒ½ç‰¹ç‚¹ï¼š**
  
  1. **è¯»æ“ä½œå®Œå…¨å¹¶è¡Œ**ï¼šå¤šçº¿ç¨‹å¯ä»¥åŒæ—¶è¯»å–ï¼Œæ— é˜»å¡
  2. **å†™æ“ä½œå±€éƒ¨é”å®š**ï¼šä»…é”å®šéœ€è¦ä¿®æ”¹çš„éƒ¨åˆ†ï¼Œå…è®¸å…¶ä»–éƒ¨åˆ†å¹¶å‘è®¿é—®
  3. **å¼±ä¸€è‡´æ€§è¿­ä»£å™¨**ï¼šè¿­ä»£æ—¶ä¸ä¼šæŠ›å‡ºConcurrentModificationExceptionï¼Œä½†å¯èƒ½ä¸åæ˜ æœ€æ–°ä¿®æ”¹
  4. **é«˜åº¦ä¼˜åŒ–çš„å¹¶å‘è®¿é—®**ï¼šä½¿ç”¨å†…éƒ¨ä¼˜åŒ–å‡å°‘é”ç«äº‰
  5. **è°ƒæ•´å¤§å°æ“ä½œå¹¶å‘åŒ–**ï¼šå¤šä¸ªçº¿ç¨‹å¯åŒæ—¶å‚ä¸æ‰©å®¹è¿‡ç¨‹
  
  </div>
  </div>
  </TabItem>
  
  <TabItem value="practice" label="æœ€ä½³å®è·µ">
  ```java
  // 1. é¿å…å¯¹ConcurrentHashMapè¿›è¡ŒåŒæ­¥åŒ…è£…ï¼ˆæ²¡æœ‰å¿…è¦ä¸”æŸå®³æ€§èƒ½ï¼‰
  Map<String, String> map = new ConcurrentHashMap<>();
  // é”™è¯¯ï¼šä¸è¦è¿™æ ·åš
  Map<String, String> syncMap = Collections.synchronizedMap(map);
  
  // 2. ä½¿ç”¨åŸå­æ“ä½œæ›¿ä»£"æ£€æŸ¥åæ‰§è¡Œ"æ¨¡å¼
  // ä¸å¥½ï¼šéåŸå­çš„æ£€æŸ¥å†æ›´æ–°
  if (!map.containsKey("key")) {
      map.put("key", "value");
  }
  // å¥½ï¼šä½¿ç”¨åŸå­æ“ä½œ
  map.putIfAbsent("key", "value");
  
  // 3. åˆ©ç”¨ConcurrentHashMapæä¾›çš„åŸå­å¤åˆæ“ä½œ
  map.compute("counter", (k, v) -> (v == null) ? 1 : Integer.parseInt(v) + 1);
  
  // 4. åˆç†è®¾ç½®åˆå§‹å®¹é‡ï¼Œé¿å…é¢‘ç¹æ‰©å®¹
  // é¢„è®¡å…ƒç´ æ•°é‡ä¸º500ï¼Œè´Ÿè½½å› å­é»˜è®¤0.75
  int initialCapacity = (int) (500 / 0.75) + 1;
  Map<String, Object> optimizedMap = new ConcurrentHashMap<>(initialCapacity);
  ```
  </TabItem>
  
  <TabItem value="avoid" label="å¸¸è§é™·é˜±">
  ```java
  ConcurrentHashMap<String, List<String>> mapOfLists = new ConcurrentHashMap<>();
  
  // é™·é˜±1: è™½ç„¶ConcurrentHashMapæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†å…¶ä¸­çš„å€¼å¯èƒ½ä¸æ˜¯
  mapOfLists.putIfAbsent("cities", new ArrayList<>()); // ArrayListä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„
  // æ­£ç¡®åšæ³•ï¼šä½¿ç”¨çº¿ç¨‹å®‰å…¨çš„é›†åˆä½œä¸ºå€¼
  mapOfLists.putIfAbsent("cities", new CopyOnWriteArrayList<>());
  
  // é™·é˜±2: å¤åˆæ“ä½œä»éœ€åŸå­æ–¹æ³•ä¿æŠ¤
  // ä¸å®‰å…¨ï¼š
  if (mapOfLists.containsKey("cities")) {
      mapOfLists.get("cities").add("New York"); // ä¸æ˜¯åŸå­æ“ä½œ
  }
  
  // å®‰å…¨ï¼šä½¿ç”¨åŸå­æ€§computeæ“ä½œ
  mapOfLists.compute("cities", (k, v) -> {
      List<String> cities = (v == null) ? new CopyOnWriteArrayList<>() : v;
      cities.add("New York");
      return cities;
  });
  
  // é™·é˜±3: è¿­ä»£å™¨çš„å¼±ä¸€è‡´æ€§å¯èƒ½çœ‹ä¸åˆ°æœ€æ–°ä¿®æ”¹
  // è¿­ä»£å¼€å§‹åçš„ä¿®æ”¹å¯èƒ½ä¸ä¼šåæ˜ åœ¨å½“å‰è¿­ä»£è¿‡ç¨‹ä¸­
  ```
  </TabItem>
</Tabs>

## 3. CopyOnWriteArrayList è¯¦è§£

### 3.1 å†™æ—¶å¤åˆ¶æœºåˆ¶

<details>
<summary><strong>CopyOnWriteArrayListå·¥ä½œåŸç†</strong></summary>

```mermaid
sequenceDiagram
    participant Client1 as çº¿ç¨‹1(è¯»)
    participant Client2 as çº¿ç¨‹2(å†™)
    participant List as CopyOnWriteArrayList
    
    Client1->>List: å¼€å§‹è¯»å–å…ƒç´ 
    Client1->>List: è·å–æ•°ç»„å¼•ç”¨A
    Client2->>List: è¯·æ±‚æ·»åŠ å…ƒç´ 
    Client2->>List: è·å–ç‹¬å é”
    Client2->>List: å¤åˆ¶æ•°ç»„Aåˆ°æ–°æ•°ç»„B
    Client2->>List: åœ¨æ•°ç»„Bä¸Šæ·»åŠ å…ƒç´ 
    Client2->>List: å°†æ•°ç»„å¼•ç”¨æ›´æ–°ä¸ºB
    Client2->>List: é‡Šæ”¾é”
    Client1->>List: ç»§ç»­è¯»å–æ•°ç»„A(åŸå§‹è§†å›¾)
    Note over Client1,List: çº¿ç¨‹1çœ‹ä¸åˆ°çº¿ç¨‹2çš„ä¿®æ”¹
```

**CopyOnWriteArrayListçš„æ ¸å¿ƒç‰¹æ€§**ï¼š
1. **å†™æ—¶å¤åˆ¶**ï¼šæ¯æ¬¡ä¿®æ”¹æ“ä½œéƒ½ä¼šåˆ›å»ºåº•å±‚æ•°ç»„çš„æ–°å‰¯æœ¬
2. **è¯»æ“ä½œæ— é”**ï¼šè¯»å–æ“ä½œä¸éœ€è¦åŠ é”ï¼Œæä¾›äº†æœ€å¤§ç¨‹åº¦çš„å¹¶å‘è¯»å–æ€§èƒ½
3. **å†™æ“ä½œåŒæ­¥**ï¼šå†™æ“ä½œéœ€è¦è·å–ç‹¬å é”ï¼Œä¸€æ¬¡åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹
4. **é€‚ç”¨åœºæ™¯**ï¼šè¯»å¤šå†™å°‘çš„åœºæ™¯ï¼Œå†™æ“ä½œé¢‘ç¹çš„åœºæ™¯æ€§èƒ½è¾ƒå·®
5. **å†…å­˜å¼€é”€**ï¼šæ¯æ¬¡ä¿®æ”¹éƒ½åˆ›å»ºæ–°æ•°ç»„ï¼Œå¯èƒ½å¯¼è‡´GCå‹åŠ›å’Œå†…å­˜ä½¿ç”¨å¢åŠ 

</details>

### 3.2 åŸºæœ¬ç”¨æ³•

<Tabs>
  <TabItem value="basic" label="åŸºæœ¬æ“ä½œ" default>
  ```java
  import java.util.concurrent.CopyOnWriteArrayList;
  
  // åˆ›å»ºCopyOnWriteArrayList
  List<String> cowList = new CopyOnWriteArrayList<>();
  
  // æ·»åŠ å…ƒç´ 
  cowList.add("Java");
  cowList.add("Python");
  cowList.addAll(Arrays.asList("Go", "Rust"));
  
  // è·å–å…ƒç´ 
  String language = cowList.get(0); // "Java"
  
  // è¿­ä»£ - å®‰å…¨ï¼Œä¸ä¼šæŠ›å‡ºConcurrentModificationException
  for (String lang : cowList) {
      System.out.println(lang);
      // å³ä½¿æ­¤å¤„ä¿®æ”¹cowListï¼Œè¿­ä»£å™¨ä»ç„¶åŸºäºåŸå§‹å¿«ç…§
      cowList.add("æ–°è¯­è¨€"); // ä¸ä¼šå½±å“å½“å‰è¿­ä»£
  }
  
  // ä¿®æ”¹å…ƒç´ 
  cowList.set(1, "Python 3");
  
  // åˆ é™¤å…ƒç´ 
  cowList.remove("Go");
  cowList.remove(0); // åˆ é™¤ç¬¬ä¸€ä¸ªå…ƒç´ 
  ```
  </TabItem>
  <TabItem value="thread" label="å¤šçº¿ç¨‹åœºæ™¯">
  ```java
  CopyOnWriteArrayList<String> safeList = new CopyOnWriteArrayList<>();
  
  // å¤šçº¿ç¨‹æ·»åŠ å…ƒç´ 
  ExecutorService executor = Executors.newFixedThreadPool(10);
  
  for (int i = 0; i < 100; i++) {
      final int index = i;
      executor.submit(() -> {
          safeList.add("Item " + index);
      });
  }
  
  executor.shutdown();
  try {
      executor.awaitTermination(5, TimeUnit.SECONDS);
  } catch (InterruptedException e) {
      Thread.currentThread().interrupt();
  }
  
  // çº¿ç¨‹å®‰å…¨çš„è¿­ä»£
  for (String item : safeList) {
      System.out.println(item);
  }
  ```
  </TabItem>
  <TabItem value="iterator" label="å¿«ç…§è¿­ä»£å™¨">
  ```java
  CopyOnWriteArrayList<Integer> numbers = new CopyOnWriteArrayList<>(
      Arrays.asList(1, 2, 3, 4, 5));
  
  // è·å–è¿­ä»£å™¨ - å®ƒåæ˜ å½“å‰çš„å¿«ç…§
  Iterator<Integer> iterator = numbers.iterator();
  
  // åœ¨è·å–è¿­ä»£å™¨åä¿®æ”¹åˆ—è¡¨
  numbers.add(6);
  numbers.remove(0);
  
  // è¿­ä»£å™¨ä»ç„¶åæ˜ åŸå§‹çŠ¶æ€
  while (iterator.hasNext()) {
      Integer num = iterator.next();
      System.out.print(num + " "); // è¾“å‡º 1 2 3 4 5
      
      // æ³¨æ„ï¼šCopyOnWriteArrayListçš„è¿­ä»£å™¨ä¸æ”¯æŒä¿®æ”¹æ“ä½œ
      // iterator.remove(); // å°†æŠ›å‡ºUnsupportedOperationException
  }
  
  System.out.println();
  // æ–°è¿­ä»£å™¨ä¼šåæ˜ æœ€æ–°çŠ¶æ€
  for (Integer num : numbers) {
      System.out.print(num + " "); // è¾“å‡º 2 3 4 5 6
  }
  ```
  </TabItem>
</Tabs>

### 3.3 é€‚ç”¨åœºæ™¯ä¸æœ€ä½³å®è·µ

<div className="code-with-callout">

```java
// åœºæ™¯ï¼šäº‹ä»¶ç›‘å¬å™¨åˆ—è¡¨
public class EventManager {
    // ä½¿ç”¨CopyOnWriteArrayListå­˜å‚¨ç›‘å¬å™¨ - éå¸¸é€‚åˆç›‘å¬å™¨æ¨¡å¼
    private final List<EventListener> listeners = new CopyOnWriteArrayList<>();
    
    // æ·»åŠ ç›‘å¬å™¨ - å†™æ“ä½œï¼Œç›¸å¯¹ä¸é¢‘ç¹
    public void addListener(EventListener listener) {
        listeners.add(listener);
    }
    
    // ç§»é™¤ç›‘å¬å™¨ - å†™æ“ä½œï¼Œç›¸å¯¹ä¸é¢‘ç¹
    public void removeListener(EventListener listener) {
        listeners.remove(listener);
    }
    
    // è§¦å‘äº‹ä»¶ - è¯»æ“ä½œï¼Œé¢‘ç¹æ‰§è¡Œ
    public void fireEvent(Event event) {
        // å®‰å…¨è¿­ä»£ï¼Œå³ä½¿æœ‰çº¿ç¨‹åŒæ—¶æ·»åŠ /ç§»é™¤ç›‘å¬å™¨
        for (EventListener listener : listeners) {
            listener.onEvent(event);
        }
    }
}
```

:::warning æ€§èƒ½æ³¨æ„äº‹é¡¹
CopyOnWriteArrayList é€‚ç”¨äºè¯»æ“ä½œè¿œå¤šäºå†™æ“ä½œçš„åœºæ™¯ã€‚å¯¹äºé¢‘ç¹å†™å…¥çš„åœºæ™¯ï¼Œå®ƒçš„æ€§èƒ½ä¼šæ˜¾è‘—ä¸‹é™ï¼Œå› ä¸ºï¼š
1. æ¯æ¬¡å†™æ“ä½œéƒ½ä¼šå¤åˆ¶æ•´ä¸ªåº•å±‚æ•°ç»„
2. å†™æ“ä½œéœ€è¦è·å–ç‹¬å é”ï¼Œå¯¼è‡´å†™æ“ä½œä¸²è¡ŒåŒ–
3. å†…å­˜ä½¿ç”¨ç‡é«˜ï¼Œå¯èƒ½å¢åŠ GCå‹åŠ›

åœ¨å…ƒç´ æ•°é‡è¾ƒå¤§ä¸”ä¿®æ”¹é¢‘ç¹çš„åœºæ™¯ï¼Œåº”è€ƒè™‘ä½¿ç”¨å…¶ä»–å¹¶å‘å®¹å™¨ã€‚
:::

</div>

## 4. é˜»å¡é˜Ÿåˆ—

### 4.1 BlockingQueue æ¥å£

<details>
<summary><strong>é˜»å¡é˜Ÿåˆ—çš„æ ¸å¿ƒæ“ä½œå¯¹æ¯”</strong></summary>

| æ“ä½œç±»å‹ | æŠ›å‡ºå¼‚å¸¸ | è¿”å›ç‰¹æ®Šå€¼ | é˜»å¡ | è¶…æ—¶ |
|---------|---------|----------|------|------|
| **æ’å…¥** | add(e) | offer(e) | put(e) | offer(e, time, unit) |
| **ç§»é™¤** | remove() | poll() | take() | poll(time, unit) |
| **æ£€æŸ¥** | element() | peek() | ä¸é€‚ç”¨ | ä¸é€‚ç”¨ |

**æ“ä½œè¡Œä¸ºè¯´æ˜**ï¼š
- **æŠ›å‡ºå¼‚å¸¸**ï¼šé˜Ÿåˆ—æ»¡/ç©ºæ—¶æŠ›å‡ºå¼‚å¸¸
- **è¿”å›ç‰¹æ®Šå€¼**ï¼šé˜Ÿåˆ—æ»¡è¿”å›falseï¼Œé˜Ÿåˆ—ç©ºè¿”å›null
- **é˜»å¡**ï¼šé˜Ÿåˆ—æ»¡/ç©ºæ—¶é˜»å¡ç­‰å¾…
- **è¶…æ—¶**ï¼šé˜»å¡æŒ‡å®šæ—¶é—´åä»æ— æ³•æ“ä½œåˆ™è¿”å›ç‰¹æ®Šå€¼

</details>

```mermaid
flowchart TD
    A[BlockingQueue] --> B[æœ‰ç•Œé˜Ÿåˆ—]
    A --> C[æ— ç•Œé˜Ÿåˆ—]
    
    B --> D[ArrayBlockingQueue<br>å›ºå®šå¤§å°]
    B --> E[LinkedBlockingQueue<br>å¯è®¾ç½®å®¹é‡]
    B --> F[SynchronousQueue<br>é›¶å®¹é‡]
    B --> G[DelayQueue<br>å»¶è¿Ÿè·å–]
    
    C --> H[PriorityBlockingQueue<br>ä¼˜å…ˆçº§æ’åº]
    C --> I[LinkedTransferQueue<br>ä¼ è¾“åŠŸèƒ½å¢å¼º]
    
    D --> J[åŸºäºæ•°ç»„å®ç°]
    E --> K[åŸºäºé“¾è¡¨å®ç°]
    F --> L[ç›´æ¥ä¼ é€’æ¨¡å¼]
    G --> M[å»¶è¿Ÿåˆ°æœŸæœºåˆ¶]
    H --> N[è‡ªç„¶æ’åºæˆ–æ¯”è¾ƒå™¨]
    I --> O[transferåŠŸèƒ½]
```

<Tabs>
  <TabItem value="basic_usage" label="åŸºæœ¬ç”¨æ³•" default>
  ```java
  import java.util.concurrent.*;
  
  public class BlockingQueueExample {
      public static void main(String[] args) throws InterruptedException {
          // åˆ›å»ºæœ‰ç•Œé˜»å¡é˜Ÿåˆ— - å®¹é‡ä¸º5
          BlockingQueue<String> queue = new ArrayBlockingQueue<>(5);
          
          // æ·»åŠ å…ƒç´  - å¤šç§æ–¹å¼
          queue.add("å…ƒç´ 1");        // æˆåŠŸæ·»åŠ ï¼Œé˜Ÿåˆ—æœªæ»¡
          queue.offer("å…ƒç´ 2");      // æˆåŠŸæ·»åŠ ï¼Œè¿”å›true
          queue.put("å…ƒç´ 3");        // æ·»åŠ å…ƒç´ ï¼Œå¯èƒ½é˜»å¡
          queue.offer("å…ƒç´ 4", 1, TimeUnit.SECONDS); // æ·»åŠ å…ƒç´ ï¼Œæœ€å¤šç­‰å¾…1ç§’
          
          // æ£€ç´¢å…ƒç´ ä½†ä¸ç§»é™¤
          String peek = queue.peek();  // æŸ¥çœ‹é˜Ÿé¦–å…ƒç´ 
          System.out.println("é˜Ÿé¦–å…ƒç´ : " + peek);
          
          // ç§»é™¤å…ƒç´  - å¤šç§æ–¹å¼
          String item1 = queue.remove();  // ç§»é™¤å¹¶è¿”å›é˜Ÿé¦–å…ƒç´ ï¼Œé˜Ÿåˆ—ä¸ºç©ºæ—¶æŠ›å¼‚å¸¸
          String item2 = queue.poll();    // ç§»é™¤å¹¶è¿”å›é˜Ÿé¦–å…ƒç´ ï¼Œé˜Ÿåˆ—ä¸ºç©ºæ—¶è¿”å›null
          String item3 = queue.take();    // ç§»é™¤å¹¶è¿”å›é˜Ÿé¦–å…ƒç´ ï¼Œé˜Ÿåˆ—ä¸ºç©ºæ—¶é˜»å¡
          String item4 = queue.poll(1, TimeUnit.SECONDS); // ç§»é™¤å…ƒç´ ï¼Œæœ€å¤šç­‰å¾…1ç§’
          
          System.out.println("å·²ç§»é™¤: " + item1 + ", " + item2 + ", " + item3 + ", " + item4);
          
          // æ£€æŸ¥é˜Ÿåˆ—çŠ¶æ€
          System.out.println("é˜Ÿåˆ—æ˜¯å¦ä¸ºç©º: " + queue.isEmpty());
          System.out.println("é˜Ÿåˆ—å…ƒç´ æ•°é‡: " + queue.size());
          System.out.println("é˜Ÿåˆ—æ˜¯å¦åŒ…å«'å…ƒç´ 1': " + queue.contains("å…ƒç´ 1"));
      }
  }
  ```
  </TabItem>
  <TabItem value="producer_consumer" label="ç”Ÿäº§è€…-æ¶ˆè´¹è€…">
  ```java
  import java.util.concurrent.*;
  import java.util.concurrent.atomic.AtomicInteger;
  
  public class ProducerConsumerExample {
      public static void main(String[] args) {
          // åˆ›å»ºæœ‰ç•Œé˜»å¡é˜Ÿåˆ—
          BlockingQueue<Integer> queue = new ArrayBlockingQueue<>(10);
          
          // åˆ›å»ºç”Ÿäº§è€…çº¿ç¨‹
          Thread producer = new Thread(new Producer(queue));
          
          // åˆ›å»ºæ¶ˆè´¹è€…çº¿ç¨‹
          Thread consumer = new Thread(new Consumer(queue));
          
          // å¯åŠ¨çº¿ç¨‹
          producer.start();
          consumer.start();
      }
      
      // ç”Ÿäº§è€…ç±»
      static class Producer implements Runnable {
          private final BlockingQueue<Integer> queue;
          private final AtomicInteger counter = new AtomicInteger();
          
          public Producer(BlockingQueue<Integer> queue) {
              this.queue = queue;
          }
          
          @Override
          public void run() {
              try {
                  while (!Thread.currentThread().isInterrupted()) {
                      int num = counter.incrementAndGet();
                      // ä½¿ç”¨putæ–¹æ³•ï¼Œå¦‚æœé˜Ÿåˆ—æ»¡åˆ™é˜»å¡
                      queue.put(num);
                      System.out.println("ç”Ÿäº§: " + num);
                      TimeUnit.MILLISECONDS.sleep(100); // ç”Ÿäº§é€Ÿç‡æ§åˆ¶
                  }
              } catch (InterruptedException e) {
                  Thread.currentThread().interrupt();
              }
          }
      }
      
      // æ¶ˆè´¹è€…ç±»
      static class Consumer implements Runnable {
          private final BlockingQueue<Integer> queue;
          
          public Consumer(BlockingQueue<Integer> queue) {
              this.queue = queue;
          }
          
          @Override
          public void run() {
              try {
                  while (!Thread.currentThread().isInterrupted()) {
                      // ä½¿ç”¨takeæ–¹æ³•ï¼Œå¦‚æœé˜Ÿåˆ—ç©ºåˆ™é˜»å¡
                      Integer value = queue.take();
                      System.out.println("æ¶ˆè´¹: " + value);
                      TimeUnit.MILLISECONDS.sleep(200); // æ¶ˆè´¹é€Ÿç‡æ§åˆ¶
                  }
              } catch (InterruptedException e) {
                  Thread.currentThread().interrupt();
              }
          }
      }
  }
  ```
  </TabItem>
  <TabItem value="priority_queue" label="ä¼˜å…ˆçº§é˜Ÿåˆ—">
  ```java
  import java.util.concurrent.*;
  import java.util.Comparator;
  
  public class PriorityBlockingQueueExample {
      public static void main(String[] args) throws InterruptedException {
          // åˆ›å»ºä¼˜å…ˆçº§é˜»å¡é˜Ÿåˆ—ï¼Œä½¿ç”¨è‡ªå®šä¹‰æ¯”è¾ƒå™¨
          BlockingQueue<Task> priorityQueue = new PriorityBlockingQueue<>(
              11, Comparator.comparingInt(Task::getPriority).reversed());
          
          // æ·»åŠ ä¸åŒä¼˜å…ˆçº§çš„ä»»åŠ¡
          priorityQueue.put(new Task(5, "æ™®é€šä»»åŠ¡"));
          priorityQueue.put(new Task(1, "ä½ä¼˜å…ˆçº§ä»»åŠ¡"));
          priorityQueue.put(new Task(10, "é«˜ä¼˜å…ˆçº§ä»»åŠ¡"));
          priorityQueue.put(new Task(7, "ä¸­é«˜ä¼˜å…ˆçº§ä»»åŠ¡"));
          priorityQueue.put(new Task(3, "ä¸­ä½ä¼˜å…ˆçº§ä»»åŠ¡"));
          
          System.out.println("ä»»åŠ¡å°†æŒ‰ä¼˜å…ˆçº§é¡ºåºæ‰§è¡Œï¼ˆé«˜åˆ°ä½ï¼‰:");
          
          // å–å‡ºå¹¶å¤„ç†æ‰€æœ‰ä»»åŠ¡ï¼ˆä¼šæŒ‰ä¼˜å…ˆçº§é¡ºåºå–å‡ºï¼‰
          while (!priorityQueue.isEmpty()) {
              Task task = priorityQueue.take();
              System.out.println("æ‰§è¡Œ: " + task);
              // æ¨¡æ‹Ÿä»»åŠ¡æ‰§è¡Œ
              TimeUnit.MILLISECONDS.sleep(100);
          }
      }
      
      // å¸¦ä¼˜å…ˆçº§çš„ä»»åŠ¡ç±»
      static class Task {
          private final int priority;
          private final String name;
          
          public Task(int priority, String name) {
              this.priority = priority;
              this.name = name;
          }
          
          public int getPriority() {
              return priority;
          }
          
          @Override
          public String toString() {
              return name + " (ä¼˜å…ˆçº§: " + priority + ")";
          }
      }
  }
  ```
  </TabItem>
</Tabs>

### 4.2 ArrayBlockingQueue

<div className="card">
<div className="card__header">
<h4>ArrayBlockingQueueç‰¹ç‚¹</h4>
</div>
<div className="card__body">

**æ ¸å¿ƒç‰¹æ€§**ï¼š
- åŸºäºæ•°ç»„å®ç°çš„**æœ‰ç•Œ**é˜»å¡é˜Ÿåˆ—
- åˆ›å»ºæ—¶å¿…é¡»æŒ‡å®šå®¹é‡
- æŒ‰ç…§FIFO(å…ˆè¿›å…ˆå‡º)åŸåˆ™å¯¹å…ƒç´ è¿›è¡Œæ’åº
- ä½¿ç”¨å•ä¸€çš„é”æ¥æ§åˆ¶å¯¹é˜Ÿåˆ—çš„è®¿é—®
- æ”¯æŒå…¬å¹³ç­–ç•¥

**é€‚ç”¨åœºæ™¯**ï¼š
- æ˜ç¡®çŸ¥é“é˜Ÿåˆ—å¤§å°ä¸Šé™çš„åœºæ™¯
- éœ€è¦FIFOé¡ºåºçš„åœºæ™¯
- ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…é€Ÿåº¦ç›¸è¿‘çš„æƒ…å†µ
- éœ€è¦é™åˆ¶ç³»ç»Ÿèµ„æºä½¿ç”¨çš„æƒ…å†µ

</div>
</div>

```mermaid
sequenceDiagram
    participant Producer as ç”Ÿäº§è€…
    participant ABQ as ArrayBlockingQueue
    participant Consumer as æ¶ˆè´¹è€…
    
    note over ABQ: åˆå§‹çŠ¶æ€: [_, _, _] (ç©ºé˜Ÿåˆ—ï¼Œå®¹é‡3)
    
    Producer->>ABQ: put("A")
    note over ABQ: ["A", _, _]
    Producer->>ABQ: put("B")
    note over ABQ: ["A", "B", _]
    
    Consumer->>ABQ: take()
    ABQ-->>Consumer: è¿”å› "A"
    note over ABQ: [_, "B", _]
    
    Producer->>ABQ: put("C")
    note over ABQ: ["C", "B", _]
    Producer->>ABQ: put("D")
    note over ABQ: ["C", "B", "D"]
    
    Producer->>+ABQ: put("E") (é˜Ÿåˆ—å·²æ»¡)
    note over Producer,ABQ: ç”Ÿäº§è€…é˜»å¡...
    
    Consumer->>ABQ: take()
    ABQ-->>Consumer: è¿”å› "B"
    ABQ-->>-Producer: é˜»å¡ç»“æŸ
    
    Producer->>ABQ: put("E")å®Œæˆ
    note over ABQ: ["C", "E", "D"]
```

### 4.3 LinkedBlockingQueue

<div className="card">
<div className="card__header">
<h4>LinkedBlockingQueueç‰¹ç‚¹</h4>
</div>
<div className="card__body">

**æ ¸å¿ƒç‰¹æ€§**ï¼š
- åŸºäºé“¾è¡¨å®ç°çš„å¯é€‰æœ‰ç•Œé˜»å¡é˜Ÿåˆ—
- é»˜è®¤å®¹é‡ä¸º`Integer.MAX_VALUE`ï¼ˆå¯è§†ä¸ºæ— ç•Œï¼‰
- å¯ä»¥æŒ‡å®šå®¹é‡ä½¿å…¶æˆä¸ºæœ‰ç•Œé˜Ÿåˆ—
- ä½¿ç”¨ä¸¤ä¸ªé”ï¼ˆtakeLockå’ŒputLockï¼‰åˆ†åˆ«æ§åˆ¶å…¥é˜Ÿå’Œå‡ºé˜Ÿæ“ä½œ
- ç›¸æ¯”ArrayBlockingQueueï¼Œå¹¶å‘æ€§èƒ½æ›´å¥½

**é€‚ç”¨åœºæ™¯**ï¼š
- ä¸ç¡®å®šé˜Ÿåˆ—å¤§å°ä¸Šé™çš„åœºæ™¯
- ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…é€Ÿåº¦å·®å¼‚è¾ƒå¤§çš„åœºæ™¯
- éœ€è¦æ›´é«˜å¹¶å‘ååé‡çš„åœºæ™¯

</div>
</div>

```java
// åˆ›å»ºæ— ç•ŒLinkedBlockingQueue
BlockingQueue<String> unboundedQueue = new LinkedBlockingQueue<>();

// åˆ›å»ºæœ‰ç•ŒLinkedBlockingQueueï¼ˆå®¹é‡1000ï¼‰
BlockingQueue<String> boundedQueue = new LinkedBlockingQueue<>(1000);

// ä¸¤ä¸ªç‹¬ç«‹çš„é”æé«˜å¹¶å‘æ€§
// putLockæ§åˆ¶å…¥é˜Ÿ
// takeLockæ§åˆ¶å‡ºé˜Ÿ
// ä¸¤ä¸ªæ“ä½œå¯ä»¥å¹¶å‘æ‰§è¡Œ
```

### 4.4 DelayQueue

<div className="card">
<div className="card__header">
<h4>DelayQueueç‰¹ç‚¹</h4>
</div>
<div className="card__body">

**æ ¸å¿ƒç‰¹æ€§**ï¼š
- æ— ç•Œé˜»å¡å»¶è¿Ÿé˜Ÿåˆ—
- å…ƒç´ åªæœ‰åœ¨å…¶æŒ‡å®šçš„å»¶è¿Ÿæ—¶é—´åˆ°æœŸåæ‰èƒ½è¢«å–å‡º
- é˜Ÿåˆ—å¤´éƒ¨æ˜¯å»¶è¿Ÿæœ€å…ˆåˆ°æœŸçš„å…ƒç´ 
- å…ƒç´ å¿…é¡»å®ç°`Delayed`æ¥å£
- å¦‚æœæ²¡æœ‰å…ƒç´ åˆ°æœŸï¼Œtake()æ–¹æ³•ä¼šé˜»å¡

**é€‚ç”¨åœºæ™¯**ï¼š
- å®šæ—¶ä»»åŠ¡è°ƒåº¦
- ç¼“å­˜è¿‡æœŸç­–ç•¥å®ç°
- è¯·æ±‚è¶…æ—¶å¤„ç†
- é™æµç®—æ³•å®ç°

</div>
</div>

<Tabs>
  <TabItem value="delay_queue_basic" label="åŸºæœ¬ç”¨æ³•" default>
  ```java
  import java.util.concurrent.*;
  
  public class DelayQueueExample {
      public static void main(String[] args) throws InterruptedException {
          // åˆ›å»ºDelayQueue
          DelayQueue<DelayedTask> delayQueue = new DelayQueue<>();
          
          // æ·»åŠ å»¶è¿Ÿä»»åŠ¡ï¼ˆå½“å‰æ—¶é—´ + æŒ‡å®šå»¶è¿Ÿï¼‰
          long now = System.currentTimeMillis();
          delayQueue.put(new DelayedTask("Task1", now + 2000)); // å»¶è¿Ÿ2ç§’
          delayQueue.put(new DelayedTask("Task2", now + 5000)); // å»¶è¿Ÿ5ç§’
          delayQueue.put(new DelayedTask("Task3", now + 1000)); // å»¶è¿Ÿ1ç§’
          delayQueue.put(new DelayedTask("Task4", now + 3000)); // å»¶è¿Ÿ3ç§’
          
          System.out.println("æ‰€æœ‰ä»»åŠ¡å·²æ·»åŠ åˆ°é˜Ÿåˆ—");
          
          // æŒ‰å»¶è¿Ÿæ—¶é—´é¡ºåºå–å‡ºä»»åŠ¡æ‰§è¡Œ
          while (!delayQueue.isEmpty()) {
              // take() ä¼šä¸€ç›´é˜»å¡ç›´åˆ°æœ‰å¯ç”¨å…ƒç´ 
              DelayedTask task = delayQueue.take();
              System.out.println(System.currentTimeMillis() - now + 
                  "ms åæ‰§è¡Œ: " + task);
          }
      }
      
      // å®ç°Delayedæ¥å£çš„ä»»åŠ¡ç±»
      static class DelayedTask implements Delayed {
          private final String name;
          private final long executeTime;
          
          public DelayedTask(String name, long executeTime) {
              this.name = name;
              this.executeTime = executeTime;
          }
          
          @Override
          public long getDelay(TimeUnit unit) {
              // è¿”å›å‰©ä½™å»¶è¿Ÿæ—¶é—´
              return unit.convert(executeTime - System.currentTimeMillis(), 
                  TimeUnit.MILLISECONDS);
          }
          
          @Override
          public int compareTo(Delayed other) {
              // æ¯”è¾ƒå‰©ä½™å»¶è¿Ÿæ—¶é—´
              if (other == this) {
                  return 0;
              }
              
              if (other instanceof DelayedTask) {
                  DelayedTask otherTask = (DelayedTask) other;
                  return Long.compare(this.executeTime, otherTask.executeTime);
              }
              
              return Long.compare(this.getDelay(TimeUnit.MILLISECONDS), 
                  other.getDelay(TimeUnit.MILLISECONDS));
          }
          
          @Override
          public String toString() {
              return name;
          }
      }
  }
  ```
  </TabItem>
  <TabItem value="cache_implementation" label="ç¼“å­˜å®ç°">
  ```java
  import java.util.concurrent.*;
  import java.util.Map;
  import java.util.HashMap;
  
  /**
   * ä½¿ç”¨DelayQueueå®ç°ç®€å•çš„ç¼“å­˜è¿‡æœŸç­–ç•¥
   */
  public class DelayQueueCache<K, V> {
      // å­˜å‚¨ç¼“å­˜å†…å®¹
      private final Map<K, V> cache = new ConcurrentHashMap<>();
      // å­˜å‚¨è¿‡æœŸæ¡ç›®
      private final DelayQueue<DelayedItem<K>> expirationQueue = new DelayQueue<>();
      
      /**
       * æ·»åŠ ç¼“å­˜é¡¹ï¼Œå¹¶è®¾ç½®è¿‡æœŸæ—¶é—´
       */
      public void put(K key, V value, long expiryTimeMillis) {
          // ç§»é™¤å·²æœ‰çš„ç›¸åŒkeyçš„è¿‡æœŸé¡¹
          removeIfExists(key);
          
          // æ·»åŠ åˆ°ç¼“å­˜
          cache.put(key, value);
          
          // æ·»åŠ è¿‡æœŸæ¡ç›®åˆ°å»¶è¿Ÿé˜Ÿåˆ—
          expirationQueue.put(new DelayedItem<>(key, expiryTimeMillis));
      }
      
      /**
       * è·å–ç¼“å­˜é¡¹ï¼Œå¦‚æœå·²è¿‡æœŸåˆ™è¿”å›null
       */
      public V get(K key) {
          // å¦‚æœç¼“å­˜ä¸­ä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å›null
          if (!cache.containsKey(key)) {
              return null;
          }
          
          // å¦‚æœå·²è¿‡æœŸï¼Œè¿”å›null
          if (isExpired(key)) {
              cache.remove(key);
              return null;
          }
          
          return cache.get(key);
      }
      
      /**
       * æ£€æŸ¥æ˜¯å¦å·²è¿‡æœŸ
       */
      private boolean isExpired(K key) {
          // éå†æ‰€æœ‰å·²è¿‡æœŸçš„æ¡ç›®å¹¶åˆ é™¤
          DelayedItem<K> delayedItem = expirationQueue.peek();
          while (delayedItem != null && delayedItem.getDelay(TimeUnit.MILLISECONDS) <= 0) {
              expirationQueue.poll(); // ç§»é™¤è¿‡æœŸæ¡ç›®
              cache.remove(delayedItem.getKey()); // ä»ç¼“å­˜ä¸­åˆ é™¤
              
              // å¦‚æœè¿™å°±æ˜¯æˆ‘ä»¬è¦æ‰¾çš„keyï¼Œè¯´æ˜å·²è¿‡æœŸ
              if (delayedItem.getKey().equals(key)) {
                  return true;
              }
              
              delayedItem = expirationQueue.peek();
          }
          
          return false;
      }
      
      /**
       * ç§»é™¤ç°æœ‰çš„è¿‡æœŸé¡¹
       */
      private void removeIfExists(K key) {
          // å…ˆä»ç¼“å­˜ä¸­ç§»é™¤
          cache.remove(key);
          
          // å°è¯•ä»è¿‡æœŸé˜Ÿåˆ—ä¸­ç§»é™¤
          // æ³¨æ„ï¼šDelayQueueæ— æ³•é€šè¿‡é”®ç›´æ¥åˆ é™¤å…ƒç´ ï¼Œéœ€è¦åˆ›å»ºä¸“é—¨çš„ç§»é™¤çº¿ç¨‹
          // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”ç”¨ä¸­å¯ä»¥ä½¿ç”¨æ›´é«˜æ•ˆçš„æ–¹æ³•
      }
      
      /**
       * æ¸…ç©ºè¿‡æœŸç¼“å­˜çš„ä»»åŠ¡
       */
      public void startExpiryProcessor() {
          Thread processor = new Thread(() -> {
              while (!Thread.currentThread().isInterrupted()) {
                  try {
                      // å–å‡ºå¹¶ç§»é™¤ä¸€ä¸ªè¿‡æœŸå…ƒç´ ï¼ˆå¦‚æœæ²¡æœ‰è¿‡æœŸå…ƒç´ ï¼Œä¼šé˜»å¡ï¼‰
                      DelayedItem<K> expiredItem = expirationQueue.take();
                      // ä»ç¼“å­˜ä¸­åˆ é™¤
                      cache.remove(expiredItem.getKey());
                      System.out.println("è¿‡æœŸç§»é™¤: " + expiredItem.getKey());
                  } catch (InterruptedException e) {
                      Thread.currentThread().interrupt();
                  }
              }
          });
          
          // è®¾ç½®ä¸ºå®ˆæŠ¤çº¿ç¨‹
          processor.setDaemon(true);
          processor.start();
      }
      
      /**
       * Delayedå®ç°ç±»ï¼Œç”¨äºç¼“å­˜è¿‡æœŸ
       */
      static class DelayedItem<T> implements Delayed {
          private final T key;
          private final long expiryTime;
          
          public DelayedItem(T key, long delayMillis) {
              this.key = key;
              this.expiryTime = System.currentTimeMillis() + delayMillis;
          }
          
          public T getKey() {
              return key;
          }
          
          @Override
          public long getDelay(TimeUnit unit) {
              return unit.convert(expiryTime - System.currentTimeMillis(), 
                  TimeUnit.MILLISECONDS);
          }
          
          @Override
          public int compareTo(Delayed other) {
              if (other == this) {
                  return 0;
              }
              
              long diff = getDelay(TimeUnit.MILLISECONDS) - 
                  other.getDelay(TimeUnit.MILLISECONDS);
              return Long.compare(diff, 0);
          }
      }
      
      // ç¤ºä¾‹ç”¨æ³•
      public static void main(String[] args) throws InterruptedException {
          DelayQueueCache<String, String> cache = new DelayQueueCache<>();
          
          // å¯åŠ¨è¿‡æœŸå¤„ç†å™¨
          cache.startExpiryProcessor();
          
          // æ·»åŠ ç¼“å­˜é¡¹
          cache.put("key1", "value1", 2000);  // 2ç§’åè¿‡æœŸ
          cache.put("key2", "value2", 5000);  // 5ç§’åè¿‡æœŸ
          cache.put("key3", "value3", 1000);  // 1ç§’åè¿‡æœŸ
          
          // è¯»å–ç¼“å­˜
          System.out.println("key1: " + cache.get("key1"));
          System.out.println("key2: " + cache.get("key2"));
          System.out.println("key3: " + cache.get("key3"));
          
          // ç­‰å¾…ä¸€æ®µæ—¶é—´åå†æ¬¡è¯»å–
          Thread.sleep(3000);
          System.out.println("3ç§’å...");
          System.out.println("key1: " + cache.get("key1"));  // å·²è¿‡æœŸ
          System.out.println("key2: " + cache.get("key2"));  // æœªè¿‡æœŸ
          System.out.println("key3: " + cache.get("key3"));  // å·²è¿‡æœŸ
          
          // å†æ¬¡ç­‰å¾…
          Thread.sleep(3000);
          System.out.println("å†è¿‡3ç§’å...");
          System.out.println("key2: " + cache.get("key2"));  // å·²è¿‡æœŸ
      }
  }
  ```
  </TabItem>
</Tabs>

### 4.5 SynchronousQueue

<div className="card">
<div className="card__header">
<h4>SynchronousQueueç‰¹ç‚¹</h4>
</div>
<div className="card__body">

**æ ¸å¿ƒç‰¹æ€§**ï¼š
- ç‰¹æ®Šçš„é˜»å¡é˜Ÿåˆ—ï¼Œå†…éƒ¨å®¹é‡ä¸ºé›¶
- ä¸å­˜å‚¨å…ƒç´ ï¼Œæ¯ä¸ªæ’å…¥æ“ä½œå¿…é¡»ç­‰å¾…å¯¹åº”çš„ç§»é™¤æ“ä½œ
- ç›´æ¥ä»ç”Ÿäº§è€…ä¼ é€’ç»™æ¶ˆè´¹è€…("ç›´é€šè½¦"é˜Ÿåˆ—)
- æ”¯æŒå…¬å¹³å’Œéå…¬å¹³ä¸¤ç§æ¨¡å¼
- é€‚ç”¨äº"äº¤æ¥"åœºæ™¯

**é€‚ç”¨åœºæ™¯**ï¼š
- éœ€è¦å³æ—¶äº¤ä»˜ä»»åŠ¡çš„åœºæ™¯
- ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…éœ€è¦"æ‰‹é€’æ‰‹"äº¤æ¥çš„åœºæ™¯
- Executors.newCachedThreadPool()ä½¿ç”¨SynchronousQueueä½œä¸ºå·¥ä½œé˜Ÿåˆ—

</div>
</div>

```mermaid
sequenceDiagram
    participant Producer as ç”Ÿäº§è€…
    participant SQ as SynchronousQueue
    participant Consumer as æ¶ˆè´¹è€…
    
    note over SQ: å†…éƒ¨å®¹é‡ä¸º0
    
    Producer->>+SQ: put("A")
    note over Producer: é˜»å¡ç­‰å¾…æ¶ˆè´¹è€…
    
    Consumer->>SQ: take()
    SQ-->>Consumer: è¿”å› "A"
    SQ-->>-Producer: putæ“ä½œå®Œæˆ
    
    Consumer->>+SQ: take() (æ²¡æœ‰å…ƒç´ å¯å–)
    note over Consumer: é˜»å¡ç­‰å¾…ç”Ÿäº§è€…
    
    Producer->>SQ: put("B")
    SQ-->>-Consumer: è¿”å› "B"
    SQ-->>Producer: putæ“ä½œå®Œæˆ
    
    note over SQ: æ¯æ¬¡putå¿…é¡»ç­‰å¾…take
    note over SQ: æ¯æ¬¡takeå¿…é¡»ç­‰å¾…put
```

```java
// SynchronousQueueç¤ºä¾‹
public class SynchronousQueueExample {
    public static void main(String[] args) {
        // åˆ›å»ºSynchronousQueue (é»˜è®¤éå…¬å¹³æ¨¡å¼)
        BlockingQueue<String> syncQueue = new SynchronousQueue<>();
        // ä¹Ÿå¯ä»¥æŒ‡å®šä¸ºå…¬å¹³æ¨¡å¼: new SynchronousQueue<>(true);
        
        // æ¶ˆè´¹è€…çº¿ç¨‹
        new Thread(() -> {
            try {
                // æ¨¡æ‹Ÿæ¶ˆè´¹è€…å»¶è¿Ÿ
                Thread.sleep(2000);
                
                // å–å…ƒç´ 
                System.out.println("æ¶ˆè´¹è€…å‡†å¤‡å–å…ƒç´ : " + System.currentTimeMillis());
                String item = syncQueue.take();
                System.out.println("æ¶ˆè´¹è€…å·²å–åˆ°å…ƒç´ : " + item + " - " + System.currentTimeMillis());
                
                // å†æ¬¡å–å…ƒç´ 
                Thread.sleep(2000);
                System.out.println("æ¶ˆè´¹è€…å†æ¬¡å‡†å¤‡å–å…ƒç´ : " + System.currentTimeMillis());
                item = syncQueue.take();
                System.out.println("æ¶ˆè´¹è€…å·²å–åˆ°å…ƒç´ : " + item + " - " + System.currentTimeMillis());
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
        }).start();
        
        // ç”Ÿäº§è€…çº¿ç¨‹
        new Thread(() -> {
            try {
                // å­˜å…¥å…ƒç´ 
                System.out.println("ç”Ÿäº§è€…å‡†å¤‡æ”¾å…¥å…ƒç´ : " + System.currentTimeMillis());
                syncQueue.put("å…ƒç´ A");
                System.out.println("ç”Ÿäº§è€…å·²æ”¾å…¥å…ƒç´ A - " + System.currentTimeMillis());
                
                // å†æ¬¡å­˜å…¥å…ƒç´ 
                System.out.println("ç”Ÿäº§è€…å‡†å¤‡æ”¾å…¥å…ƒç´ : " + System.currentTimeMillis());
                syncQueue.put("å…ƒç´ B");
                System.out.println("ç”Ÿäº§è€…å·²æ”¾å…¥å…ƒç´ B - " + System.currentTimeMillis());
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
        }).start();
    }
}
```

## 5. ConcurrentLinkedQueueè¯¦è§£

### 5.1 ConcurrentLinkedQueue åŸºæœ¬æ¦‚å¿µ

ConcurrentLinkedQueueæ˜¯ä¸€ä¸ªæ— ç•Œçº¿ç¨‹å®‰å…¨çš„é˜Ÿåˆ—ï¼ŒåŸºäºé“¾è¡¨å®ç°ã€‚

```java title="ConcurrentLinkedQueueåŸºæœ¬ç”¨æ³•ç¤ºä¾‹"
import java.util.concurrent.ConcurrentLinkedQueue;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;

public class ConcurrentLinkedQueueExamples {
    
    /**
     * ConcurrentLinkedQueueåŸºæœ¬ç”¨æ³•
     */
    public static class BasicUsage {
        public static void main(String[] args) {
            ConcurrentLinkedQueue<String> queue = new ConcurrentLinkedQueue<>();
            ExecutorService executor = Executors.newFixedThreadPool(4);
            
            System.out.println("=== ConcurrentLinkedQueueåŸºæœ¬ç”¨æ³• ===");
            
            // å¤šä¸ªç”Ÿäº§è€…
            for (int i = 0; i < 2; i++) {
                final int producerId = i;
                executor.submit(() -> {
                    for (int j = 0; j < 5; j++) {
                        String item = "Producer" + producerId + "-Item" + j;
                        queue.offer(item);
                        System.out.println("ç”Ÿäº§è€…" + producerId + "æ”¾å…¥: " + item);
                        try {
                            Thread.sleep(200);
                        } catch (InterruptedException e) {
                            Thread.currentThread().interrupt();
                        }
                    }
                });
            }
            
            // å¤šä¸ªæ¶ˆè´¹è€…
            for (int i = 0; i < 2; i++) {
                final int consumerId = i;
                executor.submit(() -> {
                    for (int j = 0; j < 5; j++) {
                        String item = queue.poll();
                        if (item != null) {
                            System.out.println("æ¶ˆè´¹è€…" + consumerId + "å–å‡º: " + item);
                        }
                        try {
                            Thread.sleep(300);
                        } catch (InterruptedException e) {
                            Thread.currentThread().interrupt();
                        }
                    }
                });
            }
            
            executor.shutdown();
        }
    }
    
    /**
     * ConcurrentLinkedQueueå®é™…åº”ç”¨åœºæ™¯
     */
    public static class PracticalApplications {
        
        /**
         * æ¶ˆæ¯é˜Ÿåˆ—å®ç°
         */
        public static class MessageQueue {
            private final ConcurrentLinkedQueue<Message> queue = new ConcurrentLinkedQueue<>();
            
            public void sendMessage(Message message) {
                queue.offer(message);
            }
            
            public Message receiveMessage() {
                return queue.poll();
            }
            
            public boolean isEmpty() {
                return queue.isEmpty();
            }
            
            public int size() {
                return queue.size();
            }
            
            static class Message {
                private final String id;
                private final String content;
                private final long timestamp;
                
                public Message(String id, String content) {
                    this.id = id;
                    this.content = content;
                    this.timestamp = System.currentTimeMillis();
                }
                
                @Override
                public String toString() {
                    return "Message{id='" + id + "', content='" + content + "', timestamp=" + timestamp + "}";
                }
            }
        }
    }
}
```

## 6. å…¶ä»–å¹¶å‘å®¹å™¨

### 6.1 ConcurrentSkipListMap

```java title="ConcurrentSkipListMapåŸºæœ¬ç”¨æ³•ç¤ºä¾‹"
import java.util.concurrent.ConcurrentSkipListMap;

public class ConcurrentSkipListMapExamples {
    
    /**
     * ConcurrentSkipListMapåŸºæœ¬ç”¨æ³•
     */
    public static class BasicUsage {
        public static void main(String[] args) {
            ConcurrentSkipListMap<String, Integer> map = new ConcurrentSkipListMap<>();
            
            System.out.println("=== ConcurrentSkipListMapåŸºæœ¬ç”¨æ³• ===");
            
            // æ·»åŠ å…ƒç´ ï¼ˆè‡ªåŠ¨æ’åºï¼‰
            map.put("zebra", 1);
            map.put("apple", 2);
            map.put("banana", 3);
            map.put("cat", 4);
            
            System.out.println("æ’åºåçš„Map:");
            map.forEach((key, value) -> System.out.println(key + " = " + value));
            
            // è·å–ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªå…ƒç´ 
            System.out.println("ç¬¬ä¸€ä¸ªå…ƒç´ : " + map.firstKey());
            System.out.println("æœ€åä¸€ä¸ªå…ƒç´ : " + map.lastKey());
            
            // è·å–å­Map
            System.out.println("aåˆ°cä¹‹é—´çš„å…ƒç´ :");
            map.subMap("a", "d").forEach((key, value) -> 
                System.out.println(key + " = " + value));
        }
    }
}
```

### 6.2 ConcurrentSkipListSet

```java title="ConcurrentSkipListSetåŸºæœ¬ç”¨æ³•ç¤ºä¾‹"
import java.util.concurrent.ConcurrentSkipListSet;

public class ConcurrentSkipListSetExamples {
    
    /**
     * ConcurrentSkipListSetåŸºæœ¬ç”¨æ³•
     */
    public static class BasicUsage {
        public static void main(String[] args) {
            ConcurrentSkipListSet<String> set = new ConcurrentSkipListSet<>();
            
            System.out.println("=== ConcurrentSkipListSetåŸºæœ¬ç”¨æ³• ===");
            
            // æ·»åŠ å…ƒç´ ï¼ˆè‡ªåŠ¨æ’åºï¼‰
            set.add("zebra");
            set.add("apple");
            set.add("banana");
            set.add("cat");
            
            System.out.println("æ’åºåçš„Set:");
            set.forEach(System.out::println);
            
            // è·å–ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªå…ƒç´ 
            System.out.println("ç¬¬ä¸€ä¸ªå…ƒç´ : " + set.first());
            System.out.println("æœ€åä¸€ä¸ªå…ƒç´ : " + set.last());
            
            // è·å–å­Set
            System.out.println("aåˆ°cä¹‹é—´çš„å…ƒç´ :");
            set.subSet("a", "d").forEach(System.out::println);
        }
    }
}
```

## 7. æ€§èƒ½æ¯”è¾ƒ

### 7.1 ä¸åŒå®¹å™¨çš„æ€§èƒ½ç‰¹ç‚¹

```java title="å®¹å™¨æ€§èƒ½æ¯”è¾ƒç¤ºä¾‹"
import java.util.*;
import java.util.concurrent.*;

public class ContainerPerformanceComparison {
    
    /**
     * å®¹å™¨æ€§èƒ½æ¯”è¾ƒ
     */
    public static void main(String[] args) {
        System.out.println("=== å®¹å™¨æ€§èƒ½æ¯”è¾ƒ ===");
        
        // HashMap vs ConcurrentHashMap
        System.out.println("=== HashMap vs ConcurrentHashMap ===");
        
        // HashMapï¼ˆéçº¿ç¨‹å®‰å…¨ï¼‰
        Map<String, Integer> hashMap = new HashMap<>();
        long start = System.currentTimeMillis();
        for (int i = 0; i < 100000; i++) {
            hashMap.put("key" + i, i);
        }
        System.out.println("HashMapå†™å…¥æ—¶é—´: " + (System.currentTimeMillis() - start) + "ms");
        
        // ConcurrentHashMapï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰
        Map<String, Integer> concurrentHashMap = new ConcurrentHashMap<>();
        start = System.currentTimeMillis();
        for (int i = 0; i < 100000; i++) {
            concurrentHashMap.put("key" + i, i);
        }
        System.out.println("ConcurrentHashMapå†™å…¥æ—¶é—´: " + (System.currentTimeMillis() - start) + "ms");
        
        // ArrayList vs CopyOnWriteArrayList
        System.out.println("\n=== ArrayList vs CopyOnWriteArrayList ===");
        
        // ArrayListï¼ˆéçº¿ç¨‹å®‰å…¨ï¼‰
        List<String> arrayList = new ArrayList<>();
        start = System.currentTimeMillis();
        for (int i = 0; i < 10000; i++) {
            arrayList.add("item" + i);
        }
        System.out.println("ArrayListå†™å…¥æ—¶é—´: " + (System.currentTimeMillis() - start) + "ms");
        
        // CopyOnWriteArrayListï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰
        List<String> copyOnWriteArrayList = new CopyOnWriteArrayList<>();
        start = System.currentTimeMillis();
        for (int i = 0; i < 10000; i++) {
            copyOnWriteArrayList.add("item" + i);
        }
        System.out.println("CopyOnWriteArrayListå†™å…¥æ—¶é—´: " + (System.currentTimeMillis() - start) + "ms");
    }
}
```

## 8. æœ€ä½³å®è·µ

### 8.1 é€‰æ‹©åˆé€‚çš„å®¹å™¨

```java title="å®¹å™¨é€‰æ‹©æŒ‡å—ç¤ºä¾‹"
public class ContainerSelectionGuide {
    
    /**
     * å®¹å™¨é€‰æ‹©æŒ‡å—
     */
    public static void selectionGuide() {
        System.out.println("=== å¹¶å‘å®¹å™¨é€‰æ‹©æŒ‡å— ===");
        
        // é«˜å¹¶å‘è¯»å†™ - ä½¿ç”¨ConcurrentHashMap
        System.out.println("1. é«˜å¹¶å‘è¯»å†™ -> ConcurrentHashMap");
        System.out.println("   é€‚ç”¨åœºæ™¯ï¼šç¼“å­˜ã€è®¡æ•°å™¨ã€é…ç½®ç®¡ç†");
        
        // è¯»å¤šå†™å°‘ - ä½¿ç”¨CopyOnWriteArrayList
        System.out.println("2. è¯»å¤šå†™å°‘ -> CopyOnWriteArrayList");
        System.out.println("   é€‚ç”¨åœºæ™¯ï¼šç›‘å¬å™¨åˆ—è¡¨ã€é…ç½®åˆ—è¡¨");
        
        // ç”Ÿäº§è€…æ¶ˆè´¹è€… - ä½¿ç”¨BlockingQueue
        System.out.println("3. ç”Ÿäº§è€…æ¶ˆè´¹è€… -> BlockingQueue");
        System.out.println("   é€‚ç”¨åœºæ™¯ï¼šä»»åŠ¡é˜Ÿåˆ—ã€æ¶ˆæ¯é˜Ÿåˆ—");
        
        // éœ€è¦æ’åº - ä½¿ç”¨ConcurrentSkipListMap
        System.out.println("4. éœ€è¦æ’åº -> ConcurrentSkipListMap");
        System.out.println("   é€‚ç”¨åœºæ™¯ï¼šæœ‰åºç¼“å­˜ã€æ’è¡Œæ¦œ");
        
        // ç®€å•åŒæ­¥ - ä½¿ç”¨Collections.synchronizedXXX()
        System.out.println("5. ç®€å•åŒæ­¥ -> Collections.synchronizedXXX()");
        System.out.println("   é€‚ç”¨åœºæ™¯ï¼šä½å¹¶å‘åœºæ™¯");
    }
    
    // é«˜å¹¶å‘è¯»å†™ - ä½¿ç”¨ConcurrentHashMap
    public static <K, V> Map<K, V> createHighConcurrencyMap() {
        return new ConcurrentHashMap<>();
    }
    
    // è¯»å¤šå†™å°‘ - ä½¿ç”¨CopyOnWriteArrayList
    public static <T> List<T> createReadHeavyList() {
        return new CopyOnWriteArrayList<>();
    }
    
    // ç”Ÿäº§è€…æ¶ˆè´¹è€… - ä½¿ç”¨BlockingQueue
    public static <T> BlockingQueue<T> createProducerConsumerQueue() {
        return new LinkedBlockingQueue<>();
    }
    
    // éœ€è¦æ’åº - ä½¿ç”¨ConcurrentSkipListMap
    public static <K extends Comparable<K>, V> Map<K, V> createSortedMap() {
        return new ConcurrentSkipListMap<>();
    }
}
```

### 8.2 é¿å…å¸¸è§é™·é˜±

```java title="å¸¸è§é™·é˜±ç¤ºä¾‹"
public class CommonPitfalls {
    
    /**
     * é¿å…å¸¸è§é™·é˜±
     */
    public static void avoidPitfalls() {
        System.out.println("=== é¿å…å¸¸è§é™·é˜± ===");
        
        // é”™è¯¯ï¼šåœ¨è¿­ä»£æ—¶ä¿®æ”¹é›†åˆ
        System.out.println("1. é¿å…åœ¨è¿­ä»£æ—¶ä¿®æ”¹é›†åˆ");
        List<String> list = new CopyOnWriteArrayList<>();
        list.add("a");
        list.add("b");
        list.add("c");
        
        // è¿™æ ·æ˜¯å®‰å…¨çš„ï¼Œå› ä¸ºCopyOnWriteArrayListåœ¨è¿­ä»£æ—¶åˆ›å»ºå‰¯æœ¬
        for (String item : list) {
            list.add("new"); // ä¸ä¼šå½±å“å½“å‰è¿­ä»£
        }
        
        // æ­£ç¡®ï¼šä½¿ç”¨åŸå­æ“ä½œ
        System.out.println("2. ä½¿ç”¨åŸå­æ“ä½œ");
        ConcurrentHashMap<String, Integer> map = new ConcurrentHashMap<>();
        
        // ä½¿ç”¨åŸå­æ“ä½œè€Œä¸æ˜¯æ£€æŸ¥ç„¶åè®¾ç½®
        map.computeIfAbsent("key", k -> 1);
        
        // è€Œä¸æ˜¯
        // if (!map.containsKey("key")) {
        //     map.put("key", 1);
        // }
        
        // æ­£ç¡®ï¼šé¿å…è¿‡åº¦åŒæ­¥
        System.out.println("3. é¿å…è¿‡åº¦åŒæ­¥");
        // ä½¿ç”¨å¹¶å‘å®¹å™¨è€Œä¸æ˜¯æ‰‹åŠ¨åŒæ­¥
        Map<String, String> safeMap = new ConcurrentHashMap<>();
        // è€Œä¸æ˜¯
        // Map<String, String> unsafeMap = Collections.synchronizedMap(new HashMap<>());
    }
}
```

## 9. é¢è¯•é¢˜

### 9.1 åŸºç¡€æ¦‚å¿µ

**Q: ConcurrentHashMapå’ŒHashtableæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ**

**A:**
- **Hashtable**ï¼šä½¿ç”¨synchronizedå…³é”®å­—ï¼Œé”ç²’åº¦å¤§ï¼Œæ€§èƒ½è¾ƒå·®
- **ConcurrentHashMap**ï¼šä½¿ç”¨åˆ†æ®µé”ï¼Œé”ç²’åº¦å°ï¼Œæ€§èƒ½æ›´å¥½
- **Hashtable**ï¼šä¸å…è®¸nullé”®å€¼ï¼ŒConcurrentHashMapå…è®¸nullå€¼
- **ConcurrentHashMap**ï¼šè¿­ä»£å™¨æ˜¯å¼±ä¸€è‡´æ€§çš„

**Q: CopyOnWriteArrayListé€‚ç”¨äºä»€ä¹ˆåœºæ™¯ï¼Ÿ**

**A:**
- è¯»å¤šå†™å°‘çš„åœºæ™¯
- ç›‘å¬å™¨åˆ—è¡¨ç­‰éœ€è¦é¢‘ç¹éå†ä½†å¾ˆå°‘ä¿®æ”¹çš„åœºæ™¯
- å†™æ“ä½œä¼šåˆ›å»ºæ–°å‰¯æœ¬ï¼Œå†…å­˜å¼€é”€è¾ƒå¤§
- è¿­ä»£å™¨ä¸ä¼šæŠ›å‡ºConcurrentModificationException

### 9.2 æ€§èƒ½ç›¸å…³

**Q: BlockingQueueçš„å‡ ç§å®ç°æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ**

**A:**
- **ArrayBlockingQueue**ï¼šæœ‰ç•Œé˜Ÿåˆ—ï¼ŒåŸºäºæ•°ç»„
- **LinkedBlockingQueue**ï¼šæœ‰ç•Œæˆ–æ— ç•Œé˜Ÿåˆ—ï¼ŒåŸºäºé“¾è¡¨
- **PriorityBlockingQueue**ï¼šæ— ç•Œä¼˜å…ˆçº§é˜Ÿåˆ—
- **SynchronousQueue**ï¼šä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—

**Q: å¦‚ä½•é€‰æ‹©åˆé€‚çš„å¹¶å‘å®¹å™¨ï¼Ÿ**

**A:**
- é«˜å¹¶å‘è¯»å†™ï¼šConcurrentHashMap
- è¯»å¤šå†™å°‘ï¼šCopyOnWriteArrayList
- ç”Ÿäº§è€…æ¶ˆè´¹è€…ï¼šBlockingQueue
- éœ€è¦æ’åºï¼šConcurrentSkipListMap
- ç®€å•åŒæ­¥ï¼šCollections.synchronizedXXX()

### 9.3 å®é™…åº”ç”¨

**Q: ConcurrentHashMapçš„size()æ–¹æ³•æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ**

**A:**
- éå†æ‰€æœ‰æ®µï¼Œç´¯åŠ æ¯ä¸ªæ®µçš„å…ƒç´ æ•°é‡
- ç”±äºå¹¶å‘ä¿®æ”¹ï¼Œsize()è¿”å›çš„æ˜¯è¿‘ä¼¼å€¼
- å¦‚æœéœ€è¦ç²¾ç¡®å€¼ï¼Œå¯ä»¥ä½¿ç”¨mappingCount()æ–¹æ³•
- åœ¨é«˜å¹¶å‘ç¯å¢ƒä¸‹ï¼Œsize()çš„æ€§èƒ½å¯èƒ½ä¸å¦‚é¢„æœŸ

**Q: å¦‚ä½•é¿å…å¹¶å‘å®¹å™¨çš„å¸¸è§é—®é¢˜ï¼Ÿ**

**A:**
- ä½¿ç”¨åŸå­æ“ä½œè€Œä¸æ˜¯æ£€æŸ¥ç„¶åè®¾ç½®
- é¿å…åœ¨è¿­ä»£æ—¶ä¿®æ”¹é›†åˆï¼ˆé™¤äº†CopyOnWriteArrayListï¼‰
- åˆç†é€‰æ‹©å®¹å™¨ç±»å‹
- æ³¨æ„å†…å­˜å¼€é”€

## 10. æ€»ç»“

Javaå¹¶å‘å®¹å™¨ä¸ºå¤šçº¿ç¨‹ç¼–ç¨‹æä¾›äº†å¼ºå¤§è€Œé«˜æ•ˆçš„æ”¯æŒã€‚

### 10.1 å…³é”®è¦ç‚¹

1. **å®¹å™¨ç‰¹æ€§**ï¼šConcurrentHashMapã€CopyOnWriteArrayListã€BlockingQueueç­‰
2. **æ€§èƒ½ç‰¹ç‚¹**ï¼šä¸åŒå®¹å™¨é€‚ç”¨äºä¸åŒåœºæ™¯
3. **é€‰æ‹©åŸåˆ™**ï¼šæ ¹æ®è¯»å†™æ¯”ä¾‹ã€å¹¶å‘ç¨‹åº¦ã€åŠŸèƒ½éœ€æ±‚é€‰æ‹©
4. **æœ€ä½³å®è·µ**ï¼šé¿å…å¸¸è§é™·é˜±ï¼Œåˆç†ä½¿ç”¨

### 10.2 é€‰æ‹©å»ºè®®

| åœºæ™¯ | æ¨èå®¹å™¨ | åŸå›  |
|------|----------|------|
| **é«˜å¹¶å‘è¯»å†™** | ConcurrentHashMap | åˆ†æ®µé”ï¼Œæ€§èƒ½å¥½ |
| **è¯»å¤šå†™å°‘** | CopyOnWriteArrayList | å†™æ—¶å¤åˆ¶ï¼Œè¯»æ€§èƒ½å¥½ |
| **ç”Ÿäº§è€…æ¶ˆè´¹è€…** | BlockingQueue | é˜»å¡æ“ä½œï¼Œçº¿ç¨‹å®‰å…¨ |
| **éœ€è¦æ’åº** | ConcurrentSkipListMap | è‡ªåŠ¨æ’åºï¼Œå¹¶å‘å®‰å…¨ |
| **ç®€å•åŒæ­¥** | Collections.synchronizedXXX() | ç®€å•æ˜“ç”¨ |

### 10.3 å­¦ä¹ å»ºè®®

1. **ç†è§£åŸç†**ï¼šæ·±å…¥ç†è§£å„ç§å®¹å™¨çš„å®ç°åŸç†
2. **æ€§èƒ½æµ‹è¯•**ï¼šå¯¹æ¯”ä¸åŒå®¹å™¨çš„æ€§èƒ½å·®å¼‚
3. **åœºæ™¯åº”ç”¨**ï¼šåœ¨å®é™…é¡¹ç›®ä¸­åº”ç”¨åˆé€‚çš„å®¹å™¨
4. **æŒç»­å­¦ä¹ **ï¼šå…³æ³¨æ–°çš„å¹¶å‘å®¹å™¨æŠ€æœ¯

é€šè¿‡æ·±å…¥ç†è§£å’Œç†Ÿç»ƒè¿ç”¨è¿™äº›å¹¶å‘å®¹å™¨ï¼Œæˆ‘ä»¬èƒ½å¤Ÿæ„å»ºå‡ºæ›´åŠ é«˜æ•ˆã€å¥å£®å’Œå¯ç»´æŠ¤çš„Javaå¹¶å‘åº”ç”¨ç¨‹åºã€‚ 