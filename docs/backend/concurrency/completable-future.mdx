---
sidebar_position: 9
title: "Javaå¼‚æ­¥ç¼–ç¨‹ä¸CompletableFutureè¯¦è§£"
description: "å…¨é¢ä»‹ç»Javaå¼‚æ­¥ç¼–ç¨‹ã€CompletableFuture APIã€å¼‚æ­¥ä»»åŠ¡ç»„åˆä¸æœ€ä½³å®è·µ"
authors: [Laby]
last_update:
  date: 2025-01-07
  author: Laby
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import TOCInline from '@theme/TOCInline';

# Java å¼‚æ­¥ç¼–ç¨‹ä¸ CompletableFuture è¯¦è§£

CompletableFutureæ˜¯Java 8å¼•å…¥çš„å¼‚æ­¥ç¼–ç¨‹å·¥å…·ï¼Œå®ƒå®ç°äº†Futureæ¥å£ï¼Œå¹¶æä¾›äº†ä¸°å¯Œçš„APIæ¥æ”¯æŒå¼‚æ­¥ç¼–ç¨‹ã€å‡½æ•°å¼ç¼–ç¨‹å’Œå“åº”å¼ç¼–ç¨‹ã€‚æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»CompletableFutureçš„ä½¿ç”¨æ–¹æ³•å’Œæœ€ä½³å®è·µã€‚

:::info æœ¬æ–‡å†…å®¹æ¦‚è§ˆ
<TOCInline toc={toc} />
:::

:::tip æ ¸å¿ƒä»·å€¼
**CompletableFuture = å¼‚æ­¥ç¼–ç¨‹ + å‡½æ•°å¼æ¥å£ + ä»»åŠ¡ç¼–æ’ + å¼‚å¸¸å¤„ç†**
- ğŸš€ **é«˜æ€§èƒ½**ï¼šæ— éœ€é˜»å¡ç­‰å¾…ç»“æœï¼Œæé«˜ç¨‹åºååé‡
- ğŸ§© **ç»„åˆèƒ½åŠ›**ï¼šæ”¯æŒå¤æ‚çš„å¼‚æ­¥ä»»åŠ¡ç¼–æ’å’Œç»„åˆ
- âš¡ **å“åº”æ€§**ï¼šæé«˜åº”ç”¨ç¨‹åºçš„å“åº”æ€§å’Œç”¨æˆ·ä½“éªŒ
- ğŸ›¡ï¸ **å¥å£®æ€§**ï¼šå†…ç½®å¼‚å¸¸å¤„ç†å’Œè¶…æ—¶æ§åˆ¶æœºåˆ¶
- ğŸ”„ **æµå¼API**ï¼šæ”¯æŒå‡½æ•°å¼ç¼–ç¨‹å’Œé“¾å¼è°ƒç”¨
:::

## 1. å¼‚æ­¥ç¼–ç¨‹æ¦‚è¿°

### 1.1 ä¸ºä»€ä¹ˆéœ€è¦å¼‚æ­¥ç¼–ç¨‹ï¼Ÿ

```mermaid
graph LR
    A[åŒæ­¥ç¼–ç¨‹<br>é˜»å¡ç­‰å¾…] --> B[ä½å“åº”æ€§]
    A --> C[èµ„æºæµªè´¹]
    A --> D[é¡ºåºæ‰§è¡Œ]
    
    E[å¼‚æ­¥ç¼–ç¨‹<br>éé˜»å¡] --> F[é«˜å“åº”æ€§]
    E --> G[èµ„æºå……åˆ†åˆ©ç”¨]
    E --> H[å¹¶è¡Œæ‰§è¡Œ]
    
    style A fill:#ffcccc,stroke:#333
    style E fill:#ccffcc,stroke:#333
```

:::tip æ ¸å¿ƒæ¦‚å¿µ
å¼‚æ­¥ç¼–ç¨‹æ˜¯ä¸€ç§ç¼–ç¨‹èŒƒå¼ï¼Œå…è®¸ç¨‹åºåœ¨ç­‰å¾…æŸä¸ªæ“ä½œå®Œæˆæ—¶ç»§ç»­æ‰§è¡Œå…¶ä»–ä»»åŠ¡ï¼Œä»è€Œæé«˜ç¨‹åºçš„å“åº”æ€§å’Œååé‡ã€‚
:::

### 1.2 åŒæ­¥ vs å¼‚æ­¥

<div className="card">
<div className="card__header">
<h4>åŒæ­¥ä¸å¼‚æ­¥ç¼–ç¨‹å¯¹æ¯”</h4>
</div>
<div className="card__body">

| ç‰¹æ€§ | åŒæ­¥ç¼–ç¨‹ | å¼‚æ­¥ç¼–ç¨‹ |
|------|----------|----------|
| **æ‰§è¡Œæ–¹å¼** | é¡ºåºæ‰§è¡Œï¼Œé˜»å¡ç­‰å¾… | å¹¶å‘æ‰§è¡Œï¼Œéé˜»å¡ |
| **å“åº”æ€§** | ä½ï¼Œå®¹æ˜“é˜»å¡ | é«˜ï¼Œä¿æŒå“åº” |
| **èµ„æºåˆ©ç”¨** | æ•ˆç‡ä½ï¼Œèµ„æºæµªè´¹ | æ•ˆç‡é«˜ï¼Œèµ„æºå……åˆ†åˆ©ç”¨ |
| **ç¼–ç¨‹å¤æ‚åº¦** | ç®€å•ç›´è§‚ | ç›¸å¯¹å¤æ‚ |
| **è°ƒè¯•éš¾åº¦** | å®¹æ˜“è°ƒè¯• | è°ƒè¯•å›°éš¾ |

</div>
</div>

### 1.3 å¼‚æ­¥ç¼–ç¨‹çš„ä¼˜åŠ¿

<Tabs>
  <TabItem value="sync_code" label="åŒæ­¥ä»£ç " default>
  ```java
  /**
   * åŒæ­¥æ‰§è¡Œç¤ºä¾‹
   */
  public static class SynchronousExample {
      public static void main(String[] args) {
          long start = System.currentTimeMillis();
          
          // åŒæ­¥æ‰§è¡Œï¼Œæ¯ä¸ªä»»åŠ¡éœ€è¦1ç§’
          String result1 = doTask1(); // é˜»å¡1ç§’
          String result2 = doTask2(); // é˜»å¡1ç§’
          String result3 = doTask3(); // é˜»å¡1ç§’
          
          // æ€»è€—æ—¶3ç§’
          System.out.println("ç»“æœ: " + result1 + ", " + result2 + ", " + result3);
          System.out.println("æ€»è€—æ—¶: " + (System.currentTimeMillis() - start) + "ms");
      }
      
      private static String doTask1() {
          try {
              Thread.sleep(1000); // æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ
          } catch (InterruptedException e) {
              Thread.currentThread().interrupt();
          }
          return "Task1å®Œæˆ";
      }
      
      private static String doTask2() {
          try {
              Thread.sleep(1000); // æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ
          } catch (InterruptedException e) {
              Thread.currentThread().interrupt();
          }
          return "Task2å®Œæˆ";
      }
      
      private static String doTask3() {
          try {
              Thread.sleep(1000); // æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ
          } catch (InterruptedException e) {
              Thread.currentThread().interrupt();
          }
          return "Task3å®Œæˆ";
      }
  }
  ```
  
  **åŒæ­¥ä»£ç ç‰¹ç‚¹ï¼š**
  - é¡ºåºæ‰§è¡Œï¼Œå‰ä¸€ä¸ªä»»åŠ¡å®Œæˆåæ‰ä¼šæ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡
  - çº¿ç¨‹ä¼šé˜»å¡ç­‰å¾…æ¯ä¸ªä»»åŠ¡å®Œæˆ
  - æ€»è€—æ—¶æ˜¯æ‰€æœ‰ä»»åŠ¡è€—æ—¶çš„æ€»å’Œ
  - ä»»åŠ¡ä¹‹é—´æœ‰æ˜ç¡®çš„æ‰§è¡Œé¡ºåº
  - ä»£ç ç®€å•ç›´è§‚ï¼Œå®¹æ˜“ç†è§£å’Œè°ƒè¯•
  
  </TabItem>
  <TabItem value="async_code" label="å¼‚æ­¥ä»£ç ">
  ```java
  import java.util.concurrent.CompletableFuture;
  
  /**
   * å¼‚æ­¥æ‰§è¡Œç¤ºä¾‹
   */
  public static class AsynchronousExample {
      public static void main(String[] args) {
          long start = System.currentTimeMillis();
          
          // å¼‚æ­¥æ‰§è¡Œï¼Œæ‰€æœ‰ä»»åŠ¡å¹¶è¡Œè¿è¡Œ
          CompletableFuture<String> future1 = CompletableFuture.supplyAsync(() -> doTask1());
          CompletableFuture<String> future2 = CompletableFuture.supplyAsync(() -> doTask2());
          CompletableFuture<String> future3 = CompletableFuture.supplyAsync(() -> doTask3());
          
          // ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
          CompletableFuture<Void> allFutures = CompletableFuture.allOf(future1, future2, future3);
          
          // å½“æ‰€æœ‰ä»»åŠ¡å®Œæˆåå¤„ç†ç»“æœ
          allFutures.thenRun(() -> {
              try {
                  String result1 = future1.get(); // æ­¤æ—¶å·²å®Œæˆï¼Œä¸ä¼šé˜»å¡
                  String result2 = future2.get();
                  String result3 = future3.get();
                  
                  System.out.println("ç»“æœ: " + result1 + ", " + result2 + ", " + result3);
                  System.out.println("æ€»è€—æ—¶: " + (System.currentTimeMillis() - start) + "ms");
              } catch (Exception e) {
                  e.printStackTrace();
              }
          });
          
          // ç­‰å¾…å®Œæˆ
          allFutures.join();
      }
      
      // ä»»åŠ¡æ–¹æ³•åŒä¸Š
      private static String doTask1() { /* åŒä¸Š */ return "Task1å®Œæˆ"; }
      private static String doTask2() { /* åŒä¸Š */ return "Task2å®Œæˆ"; }
      private static String doTask3() { /* åŒä¸Š */ return "Task3å®Œæˆ"; }
  }
  ```
  
  **å¼‚æ­¥ä»£ç ç‰¹ç‚¹ï¼š**
  - å¹¶è¡Œæ‰§è¡Œï¼Œæ‰€æœ‰ä»»åŠ¡åŒæ—¶å¯åŠ¨
  - ä¸»çº¿ç¨‹ä¸ä¼šé˜»å¡ï¼Œå¯ä»¥æ‰§è¡Œå…¶ä»–æ“ä½œ
  - æ€»è€—æ—¶æ¥è¿‘æœ€é•¿ä»»åŠ¡çš„è€—æ—¶
  - ä»»åŠ¡ä¹‹é—´çš„æ‰§è¡Œé¡ºåºä¸ç¡®å®š
  - ä½¿ç”¨å›è°ƒå¤„ç†å®Œæˆçš„ä»»åŠ¡
  
  </TabItem>
  <TabItem value="performance_comparison" label="æ€§èƒ½å¯¹æ¯”">
  <div className="card">
  <div className="card__body">
  
  **åŒæ­¥ä¸å¼‚æ­¥æ‰§è¡Œæ€§èƒ½å¯¹æ¯”ï¼š**
  
  å‡è®¾æœ‰10ä¸ªç›¸äº’ç‹¬ç«‹çš„ä»»åŠ¡ï¼Œæ¯ä¸ªä»»åŠ¡æ‰§è¡Œæ—¶é—´ä¸º1ç§’ï¼š
  
  | æ‰§è¡Œæ–¹å¼ | æ‰§è¡Œæ—¶é—´ | CPUåˆ©ç”¨ç‡ | å†…å­˜å ç”¨ | çº¿ç¨‹æ•° |
  |---------|---------|----------|---------|--------|
  | **åŒæ­¥æ‰§è¡Œ** | 10ç§’ | ä½ | ä½ | 1 |
  | **å¼‚æ­¥æ‰§è¡Œ** | 1ç§’å·¦å³ | é«˜ | ç•¥é«˜ | å¤šä¸ª |
  
  **å¼‚æ­¥ç¼–ç¨‹çš„ä¸»è¦ä¼˜åŠ¿ï¼š**
  
  1. **æ€§èƒ½æå‡**ï¼šå¹¶è¡Œå¤„ç†å¤šä¸ªä»»åŠ¡ï¼Œæ€»ä½“è€—æ—¶å‡å°‘
  2. **èµ„æºåˆ©ç”¨**ï¼šå……åˆ†åˆ©ç”¨ç³»ç»Ÿèµ„æºï¼Œæé«˜ååé‡
  3. **å“åº”æ€§**ï¼šä¸é˜»å¡ä¸»çº¿ç¨‹ï¼Œä¿æŒUIå“åº”æˆ–å¿«é€Ÿå“åº”è¯·æ±‚
  4. **å¯æ‰©å±•æ€§**ï¼šæ›´å®¹æ˜“å¤„ç†å¤§é‡å¹¶å‘æ“ä½œ
  
  **é€‚ç”¨åœºæ™¯ï¼š**
  - ç½‘ç»œè¯·æ±‚
  - æ–‡ä»¶I/Oæ“ä½œ
  - å¤šAPIè°ƒç”¨
  - å¤æ‚è®¡ç®—ä»»åŠ¡
  - éœ€è¦ä¿æŒUIå“åº”çš„åº”ç”¨
  
  </div>
  </div>
  </TabItem>
</Tabs>

### 1.4 Javaä¸­çš„å¼‚æ­¥ç¼–ç¨‹æ¨¡å‹

```mermaid
timeline
    title Javaå¼‚æ­¥ç¼–ç¨‹æ¼”è¿›
    1.0 : åŸå§‹Threadç±»
    1.5 : Executoræ¡†æ¶
    1.5 : Futureæ¥å£
    5.0 : ExecutorService
    5.0 : Callableå’ŒFuture
    7.0 : ForkJoinPool
    8.0 : CompletableFuture
    9.0 : å¢å¼ºCompletableFuture
```

<div className="card">
<div className="card__header">
<h4>Javaå¼‚æ­¥ç¼–ç¨‹æ¨¡å‹æ¼”è¿›</h4>
</div>
<div className="card__body">

| ç‰ˆæœ¬ | ç‰¹æ€§ | ä¼˜ç¼ºç‚¹ |
|------|------|--------|
| **Java 1.0** | Threadç±» | ç›´æ¥æ“ä½œçº¿ç¨‹ï¼Œçµæ´»ä½†å¤æ‚ |
| **Java 1.5** | Executoræ¡†æ¶ | çº¿ç¨‹æ± ç®¡ç†ï¼Œç®€åŒ–çº¿ç¨‹åˆ›å»º |
| **Java 1.5** | Futureæ¥å£ | å¼‚æ­¥ç»“æœå°è£…ï¼Œä½†åŠŸèƒ½æœ‰é™ |
| **Java 5** | ExecutorService | æä¾›æ›´å®Œæ•´çš„çº¿ç¨‹æ± ç®¡ç† |
| **Java 5** | Callableå’ŒFuture | æ”¯æŒæœ‰è¿”å›å€¼çš„ä»»åŠ¡ |
| **Java 7** | ForkJoinPool | æ”¯æŒå·¥ä½œçªƒå–ç®—æ³•ï¼Œé€‚åˆé€’å½’ä»»åŠ¡ |
| **Java 8** | CompletableFuture | æ”¯æŒå‡½æ•°å¼ã€é“¾å¼å¼‚æ­¥ç¼–ç¨‹ |
| **Java 9+** | å¢å¼ºCompletableFuture | æ·»åŠ è¶…æ—¶æ§åˆ¶ç­‰æ–°åŠŸèƒ½ |

**ä»Futureåˆ°CompletableFutureçš„æå‡:**
- Futureåªèƒ½é€šè¿‡é˜»å¡çš„get()è·å–ç»“æœ
- Futureæ— æ³•é“¾å¼ç»„åˆå¤šä¸ªå¼‚æ­¥æ“ä½œ
- Futureç¼ºä¹å¼‚å¸¸å¤„ç†æœºåˆ¶
- CompletableFutureè§£å†³äº†ä¸Šè¿°æ‰€æœ‰é—®é¢˜

</div>
</div>

## 2. CompletableFuture API è¯¦è§£

### 2.1 åˆ›å»º CompletableFuture

```mermaid
graph TD
    A[åˆ›å»ºCompletableFuture] --> B["è¿”å›å€¼çš„å¼‚æ­¥ä»»åŠ¡<br>supplyAsync()"]
    A --> C["æ— è¿”å›å€¼çš„å¼‚æ­¥ä»»åŠ¡<br>runAsync()"]
    A --> D["å·²å®Œæˆçš„Future<br>completedFuture()"]
    A --> E["æ‰‹åŠ¨å®Œæˆ<br>complete()"]
    
    B --> B1["supplyAsync(() -> result)"]
    C --> C1["runAsync(() -> void)"]
    D --> D1["completedFuture(value)"]
    E --> E1["new CompletableFuture()"]
    
    style A fill:#f9f,stroke:#333,stroke-width:2px
    style B,C,D,E fill:#cff,stroke:#333
```

<Tabs>
  <TabItem value="creation_methods" label="åˆ›å»ºæ–¹æ³•" default>
  ```java
  import java.util.concurrent.CompletableFuture;
  import java.util.concurrent.ExecutorService;
  import java.util.concurrent.Executors;
  
  public class CompletableFutureCreation {
      public static void main(String[] args) throws Exception {
          // 1. ä½¿ç”¨supplyAsyncåˆ›å»ºæœ‰è¿”å›å€¼çš„å¼‚æ­¥ä»»åŠ¡
          CompletableFuture<String> future1 = CompletableFuture.supplyAsync(() -> {
              // å¼‚æ­¥æ‰§è¡Œçš„ä»£ç 
              try {
                  Thread.sleep(1000);
              } catch (InterruptedException e) {
                  Thread.currentThread().interrupt();
              }
              return "å¼‚æ­¥ä»»åŠ¡ç»“æœ";
          });
          
          // 2. ä½¿ç”¨runAsyncåˆ›å»ºæ— è¿”å›å€¼çš„å¼‚æ­¥ä»»åŠ¡
          CompletableFuture<Void> future2 = CompletableFuture.runAsync(() -> {
              // å¼‚æ­¥æ‰§è¡Œçš„ä»£ç ï¼Œæ— è¿”å›å€¼
              try {
                  Thread.sleep(1000);
              } catch (InterruptedException e) {
                  Thread.currentThread().interrupt();
              }
              System.out.println("å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œå®Œæˆ");
          });
          
          // 3. ä½¿ç”¨è‡ªå®šä¹‰çº¿ç¨‹æ± 
          ExecutorService executor = Executors.newFixedThreadPool(3);
          CompletableFuture<String> future3 = CompletableFuture.supplyAsync(() -> {
              return "ä½¿ç”¨è‡ªå®šä¹‰çº¿ç¨‹æ± ";
          }, executor);
          
          // 4. æ‰‹åŠ¨å®ŒæˆFuture
          CompletableFuture<String> future4 = new CompletableFuture<>();
          new Thread(() -> {
              try {
                  Thread.sleep(1000);
                  future4.complete("æ‰‹åŠ¨å®Œæˆçš„ç»“æœ");  // æ­£å¸¸å®Œæˆ
                  // æˆ–è€…å¼‚å¸¸å®Œæˆ
                  // future4.completeExceptionally(new RuntimeException("å‡ºé”™äº†"));
              } catch (InterruptedException e) {
                  Thread.currentThread().interrupt();
                  future4.completeExceptionally(e);  // å¼‚å¸¸å®Œæˆ
              }
          }).start();
          
          // 5. ä½¿ç”¨completedFutureåˆ›å»ºå·²å®Œæˆçš„Future
          CompletableFuture<String> future5 = CompletableFuture.completedFuture("ç«‹å³å®Œæˆçš„ç»“æœ");
          
          // è·å–ç»“æœå¹¶æ‰“å°
          System.out.println("Future1ç»“æœ: " + future1.get());
          future2.get(); // ç­‰å¾…å®Œæˆ
          System.out.println("Future3ç»“æœ: " + future3.get());
          System.out.println("Future4ç»“æœ: " + future4.get());
          System.out.println("Future5ç»“æœ: " + future5.get());
          
          // å…³é—­çº¿ç¨‹æ± 
          executor.shutdown();
      }
  }
  ```
  </TabItem>
  <TabItem value="creation_comparison" label="åˆ›å»ºæ–¹å¼å¯¹æ¯”">
  <div className="card">
  <div className="card__body">
  
  **ä¸åŒåˆ›å»ºæ–¹å¼å¯¹æ¯”ï¼š**
  
  | åˆ›å»ºæ–¹å¼ | è¿”å›å€¼ | æ‰§è¡Œçº¿ç¨‹æ±  | ä½¿ç”¨åœºæ™¯ | ç¤ºä¾‹ |
  |---------|-------|-----------|---------|------|
  | **supplyAsync()** | æœ‰ | ForkJoinPool.commonPool() | éœ€è¦è¿”å›ç»“æœçš„ä»»åŠ¡ | `supplyAsync(() -> "result")` |
  | **supplyAsync(executor)** | æœ‰ | è‡ªå®šä¹‰çº¿ç¨‹æ±  | å®šåˆ¶çº¿ç¨‹æ± ç­–ç•¥ | `supplyAsync(() -> "result", myExecutor)` |
  | **runAsync()** | æ—  | ForkJoinPool.commonPool() | ä¸éœ€è¦è¿”å›ç»“æœçš„ä»»åŠ¡ | `runAsync(() -> { doWork(); })` |
  | **runAsync(executor)** | æ—  | è‡ªå®šä¹‰çº¿ç¨‹æ±  | å®šåˆ¶çº¿ç¨‹æ± çš„æ— è¿”å›å€¼ä»»åŠ¡ | `runAsync(() -> { doWork(); }, myExecutor)` |
  | **completedFuture()** | æœ‰ | ä¸ä½¿ç”¨çº¿ç¨‹æ±  | æä¾›é»˜è®¤å€¼æˆ–å·²çŸ¥ç»“æœ | `completedFuture("default")` |
  | **new CompletableFuture()** | å–å†³äºcompleteæ—¶æä¾›çš„å€¼ | ä¸ä½¿ç”¨çº¿ç¨‹æ±  | æ‰‹åŠ¨æ§åˆ¶å®Œæˆæ—¶æœº | `future.complete("result")` |
  
  **é€‰æ‹©æŒ‡å—ï¼š**
  1. æœ‰è¿”å›å€¼ä½¿ç”¨`supplyAsync()`ï¼Œæ— è¿”å›å€¼ä½¿ç”¨`runAsync()`
  2. é«˜å¹¶å‘åœºæ™¯å»ºè®®ä½¿ç”¨è‡ªå®šä¹‰çº¿ç¨‹æ± 
  3. å·²çŸ¥ç»“æœæ—¶ç›´æ¥ä½¿ç”¨`completedFuture()`
  4. éœ€è¦ç²¾ç¡®æ§åˆ¶å®Œæˆæ—¶æœºæ—¶ä½¿ç”¨æ‰‹åŠ¨å®Œæˆæ–¹å¼
  
  </div>
  </div>
  </TabItem>
  <TabItem value="executor_strategies" label="çº¿ç¨‹æ± ç­–ç•¥">
  ```java
  import java.util.concurrent.ExecutorService;
  import java.util.concurrent.Executors;
  
  /**
   * ä¸åŒåœºæ™¯ä¸‹çš„çº¿ç¨‹æ± ç­–ç•¥
   */
  public static class ThreadPoolStrategies {
      // CPUå¯†é›†å‹ä»»åŠ¡çš„çº¿ç¨‹æ± 
      public static ExecutorService cpuIntensivePool() {
          int processors = Runtime.getRuntime().availableProcessors();
          return Executors.newFixedThreadPool(processors);
      }
      
      // IOå¯†é›†å‹ä»»åŠ¡çš„çº¿ç¨‹æ± 
      public static ExecutorService ioIntensivePool() {
          int processors = Runtime.getRuntime().availableProcessors();
          return Executors.newFixedThreadPool(processors * 2);
      }
      
      // å®šæ—¶ä»»åŠ¡çš„çº¿ç¨‹æ± 
      public static ExecutorService scheduledPool() {
          return Executors.newScheduledThreadPool(5);
      }
      
      // ä½¿ç”¨ç¤ºä¾‹
      public static void main(String[] args) {
          ExecutorService cpuPool = cpuIntensivePool();
          ExecutorService ioPool = ioIntensivePool();
          
          // CPUå¯†é›†å‹ä»»åŠ¡
          CompletableFuture<Integer> cpuTask = CompletableFuture.supplyAsync(() -> {
              // è®¡ç®—å¯†é›†å‹ä»»åŠ¡
              return performComplexCalculation();
          }, cpuPool);
          
          // IOå¯†é›†å‹ä»»åŠ¡
          CompletableFuture<String> ioTask = CompletableFuture.supplyAsync(() -> {
              // IOå¯†é›†å‹ä»»åŠ¡
              return fetchDataFromNetwork();
          }, ioPool);
          
          // ä¸è¦å¿˜è®°å…³é—­çº¿ç¨‹æ± 
          cpuPool.shutdown();
          ioPool.shutdown();
      }
      
      private static int performComplexCalculation() {
          // æ¨¡æ‹Ÿå¤æ‚è®¡ç®—
          return 42;
      }
      
      private static String fetchDataFromNetwork() {
          // æ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚
          return "data";
      }
  }
  ```
  </TabItem>
</Tabs>

### 2.2 é“¾å¼è°ƒç”¨

```mermaid
graph LR
    A[CompletableFuture] --> B["thenApply(Function)"]
    B --> C["thenAccept(Consumer)"]
    C --> D["thenRun(Runnable)"]
    
    A --> E["thenApplyAsync(Function)"]
    E --> F["thenAcceptAsync(Consumer)"]
    F --> G["thenRunAsync(Runnable)"]
    
    A --> H["thenCompose(Function)"]
    
    style A fill:#f9f,stroke:#333,stroke-width:2px
    style B,C,D fill:#bbf,stroke:#333
    style E,F,G fill:#fbf,stroke:#333
    style H fill:#ff9,stroke:#333
    
    classDef transform fill:#bbf,stroke:#333
    classDef consume fill:#fbf,stroke:#333
    classDef compose fill:#ff9,stroke:#333
```

<div className="card">
<div className="card__header">
<h4>CompletableFutureå¸¸ç”¨é“¾å¼æ–¹æ³•</h4>
</div>
<div className="card__body">

**æ•°æ®è½¬æ¢æ–¹æ³•ï¼š**
- `thenApply(Function)` - è½¬æ¢ç»“æœå¹¶è¿”å›æ–°å€¼
- `thenApplyAsync(Function)` - å¼‚æ­¥çº¿ç¨‹ä¸­è½¬æ¢

**ç»“æœæ¶ˆè´¹æ–¹æ³•ï¼š**
- `thenAccept(Consumer)` - æ¶ˆè´¹ç»“æœä½†ä¸è¿”å›æ–°å€¼
- `thenRun(Runnable)` - å®Œæˆåæ‰§è¡Œæ“ä½œï¼Œä¸ä½¿ç”¨ç»“æœ

**ç»„åˆæ–¹æ³•ï¼š**
- `thenCompose(Function)` - é“¾æ¥ä¸¤ä¸ªCompletableFuture
- `thenCombine(CompletableFuture, BiFunction)` - ç»„åˆä¸¤ä¸ªFutureçš„ç»“æœ

**æ‰§è¡Œçº¿ç¨‹é€‰æ‹©ï¼š**
- ä¸å¸¦Asyncåç¼€çš„æ–¹æ³• - ä½¿ç”¨ä¸Šä¸€é˜¶æ®µçš„çº¿ç¨‹æ‰§è¡Œ
- å¸¦Asyncåç¼€çš„æ–¹æ³• - ä½¿ç”¨ForkJoinPoolæˆ–æŒ‡å®šçº¿ç¨‹æ± 

</div>
</div>

<Tabs>
  <TabItem value="basic_chaining" label="åŸºæœ¬é“¾å¼è°ƒç”¨" default>
  ```java
  import java.util.concurrent.CompletableFuture;
  
  /**
   * CompletableFutureé“¾å¼è°ƒç”¨ç¤ºä¾‹
   */
  public static void main(String[] args) throws Exception {
      // åˆ›å»ºå¹¶é“¾å¼è°ƒç”¨CompletableFuture
      CompletableFuture<String> future = CompletableFuture
          .supplyAsync(() -> "Hello") // è¿”å›Hello
          .thenApply(s -> s + " World") // è½¬æ¢ç»“æœä¸º"Hello World"
          .thenApply(s -> s + "!") // è½¬æ¢ç»“æœä¸º"Hello World!"
          .thenApply(String::toUpperCase); // è½¬æ¢ä¸ºå¤§å†™
      
      // è·å–æœ€ç»ˆç»“æœ
      String result = future.get();
      System.out.println("é“¾å¼è°ƒç”¨ç»“æœ: " + result); // è¾“å‡º: HELLO WORLD!
      
      // æ¼”ç¤ºthenAcceptå’ŒthenRun
      CompletableFuture.supplyAsync(() -> "CompletableFuture")
          .thenApply(s -> s + " is awesome")
          .thenAccept(s -> System.out.println("æ¶ˆè´¹ç»“æœ: " + s)) // æ¶ˆè´¹ç»“æœ
          .thenRun(() -> System.out.println("å¤„ç†å®Œæˆ")); // æœ€åæ‰§è¡Œ
  }
  ```
  </TabItem>
  <TabItem value="async_chaining" label="å¼‚æ­¥é“¾å¼è°ƒç”¨">
  ```java
  import java.util.concurrent.CompletableFuture;
  import java.util.concurrent.ExecutorService;
  import java.util.concurrent.Executors;
  
  /**
   * å¼‚æ­¥é“¾å¼è°ƒç”¨ç¤ºä¾‹
   */
  public static void main(String[] args) throws Exception {
      // åˆ›å»ºè‡ªå®šä¹‰çº¿ç¨‹æ± 
      ExecutorService executor = Executors.newFixedThreadPool(3);
      
      // å¼‚æ­¥é“¾å¼è°ƒç”¨
      CompletableFuture<String> asyncFuture = CompletableFuture
          .supplyAsync(() -> {
              System.out.println("ç¬¬ä¸€æ­¥ï¼š" + Thread.currentThread().getName());
              return "ç¬¬ä¸€æ­¥";
          }, executor)
          .thenApplyAsync(s -> {
              System.out.println("ç¬¬äºŒæ­¥ï¼š" + Thread.currentThread().getName());
              return s + " -> ç¬¬äºŒæ­¥";
          }, executor)
          .thenApplyAsync(s -> {
              System.out.println("ç¬¬ä¸‰æ­¥ï¼š" + Thread.currentThread().getName());
              return s + " -> ç¬¬ä¸‰æ­¥";
          }, executor);
      
      // è·å–æœ€ç»ˆç»“æœ
      String result = asyncFuture.get();
      System.out.println("å¼‚æ­¥é“¾å¼è°ƒç”¨ç»“æœ: " + result);
      
      // å…³é—­çº¿ç¨‹æ± 
      executor.shutdown();
  }
  ```
  </TabItem>
  <TabItem value="method_comparison" label="æ–¹æ³•å¯¹æ¯”">
  <div className="card">
  <div className="card__body">
  
  | æ–¹æ³•ç±»åˆ« | æ–¹æ³•å | å…¥å‚ | å‡ºå‚ | å¸¸ç”¨åœºæ™¯ |
  |---------|--------|------|------|---------|
  | **è½¬æ¢ç±»** | thenApply | Function | CompletableFuture | å°†ç»“æœè½¬æ¢ä¸ºæ–°ç±»å‹ |
  | **è½¬æ¢ç±»** | thenApplyAsync | Function | CompletableFuture | å¼‚æ­¥çº¿ç¨‹ä¸­è½¬æ¢ç»“æœ |
  | **æ¶ˆè´¹ç±»** | thenAccept | Consumer | CompletableFuture | ä½¿ç”¨ç»“æœä½†ä¸éœ€è¦è¿”å›å€¼ |
  | **æ¶ˆè´¹ç±»** | thenAcceptAsync | Consumer | CompletableFuture | å¼‚æ­¥æ¶ˆè´¹ç»“æœ |
  | **æ‰§è¡Œç±»** | thenRun | Runnable | CompletableFuture | å®Œæˆåæ‰§è¡Œï¼Œä¸ä½¿ç”¨ç»“æœ |
  | **æ‰§è¡Œç±»** | thenRunAsync | Runnable | CompletableFuture | å¼‚æ­¥æ‰§è¡Œåç»­æ“ä½œ |
  | **ç»„åˆç±»** | thenCompose | Function | CompletableFuture | é“¾æ¥ä¸¤ä¸ªFuture |
  | **ç»„åˆç±»** | thenCombine | CompletableFuture, BiFunction | CompletableFuture | ç»„åˆä¸¤ä¸ªFutureç»“æœ |
  
  **ä»£ç ç¤ºä¾‹ï¼š**
  
  ```java
  // thenApply - è½¬æ¢ç»“æœ
  CompletableFuture<Integer> future1 = 
      CompletableFuture.supplyAsync(() -> "42")
          .thenApply(Integer::parseInt);
          
  // thenAccept - æ¶ˆè´¹ç»“æœ
  CompletableFuture<Void> future2 = 
      CompletableFuture.supplyAsync(() -> "Hello")
          .thenAccept(System.out::println);
          
  // thenRun - å®Œæˆåæ‰§è¡Œ
  CompletableFuture<Void> future3 = 
      CompletableFuture.supplyAsync(() -> "Hello")
          .thenRun(() -> System.out.println("å®Œæˆ"));
          
  // thenCompose - é“¾æ¥å¦ä¸€ä¸ªFuture
  CompletableFuture<String> future4 = 
      CompletableFuture.supplyAsync(() -> "Hello")
          .thenCompose(s -> CompletableFuture.supplyAsync(() -> s + " World"));
  ```
  
  </div>
  </div>
  </TabItem>
</Tabs>

### 2.3 ç»„åˆå¤šä¸ª Future

```java title="CompletableFutureç»„åˆç¤ºä¾‹"
public class CompletableFutureCombination {
    
    /**
     * ç»„åˆå¤šä¸ªFuture
     */
    public static void main(String[] args) {
        System.out.println("=== CompletableFutureç»„åˆ ===");
        
        // 1. thenCombine - ç»„åˆä¸¤ä¸ªFutureçš„ç»“æœ
        CompletableFuture<String> future1 = CompletableFuture.supplyAsync(() -> "Hello");
        CompletableFuture<String> future2 = CompletableFuture.supplyAsync(() -> "World");
        
        CompletableFuture<String> combined = future1.thenCombine(future2, (result1, result2) -> 
            result1 + " " + result2);
        
        try {
            System.out.println("ç»„åˆç»“æœ: " + combined.get());
        } catch (Exception e) {
            e.printStackTrace();
        }
        
        // 2. thenCompose - é“¾å¼ç»„åˆ
        CompletableFuture<String> composed = future1.thenCompose(result -> 
            CompletableFuture.supplyAsync(() -> result + " è¢«å¤„ç†"));
        
        try {
            System.out.println("é“¾å¼ç»„åˆç»“æœ: " + composed.get());
        } catch (Exception e) {
            e.printStackTrace();
        }
        
        // 3. allOf - ç­‰å¾…æ‰€æœ‰Futureå®Œæˆ
        CompletableFuture<String> task1 = CompletableFuture.supplyAsync(() -> "ä»»åŠ¡1");
        CompletableFuture<String> task2 = CompletableFuture.supplyAsync(() -> "ä»»åŠ¡2");
        CompletableFuture<String> task3 = CompletableFuture.supplyAsync(() -> "ä»»åŠ¡3");
        
        CompletableFuture<Void> allTasks = CompletableFuture.allOf(task1, task2, task3);
        
        allTasks.thenRun(() -> {
            try {
                System.out.println("æ‰€æœ‰ä»»åŠ¡å®Œæˆ: " + task1.get() + ", " + task2.get() + ", " + task3.get());
            } catch (Exception e) {
                e.printStackTrace();
            }
        });
        
        allTasks.join();
        
        // 4. anyOf - ç­‰å¾…ä»»æ„ä¸€ä¸ªFutureå®Œæˆ
        CompletableFuture<String> fastTask = CompletableFuture.supplyAsync(() -> {
            try {
                Thread.sleep(500);
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
            return "å¿«é€Ÿä»»åŠ¡";
        });
        
        CompletableFuture<String> slowTask = CompletableFuture.supplyAsync(() -> {
            try {
                Thread.sleep(2000);
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
            return "æ…¢é€Ÿä»»åŠ¡";
        });
        
        CompletableFuture<Object> anyTask = CompletableFuture.anyOf(fastTask, slowTask);
        try {
            System.out.println("ç¬¬ä¸€ä¸ªå®Œæˆçš„ä»»åŠ¡: " + anyTask.get());
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

### 2.4 å¼‚å¸¸å¤„ç†

```java title="CompletableFutureå¼‚å¸¸å¤„ç†ç¤ºä¾‹"
public class CompletableFutureExceptionHandling {
    
    /**
     * å¼‚å¸¸å¤„ç†ç¤ºä¾‹
     */
    public static void main(String[] args) {
        System.out.println("=== CompletableFutureå¼‚å¸¸å¤„ç† ===");
        
        // 1. exceptionally - å¤„ç†å¼‚å¸¸å¹¶è¿”å›é»˜è®¤å€¼
        CompletableFuture<String> future1 = CompletableFuture.supplyAsync(() -> {
            if (Math.random() > 0.5) {
                throw new RuntimeException("éšæœºå¼‚å¸¸");
            }
            return "æˆåŠŸç»“æœ";
        }).exceptionally(throwable -> {
            System.out.println("æ•è·å¼‚å¸¸: " + throwable.getMessage());
            return "é»˜è®¤å€¼";
        });
        
        try {
            System.out.println("Future1ç»“æœ: " + future1.get());
        } catch (Exception e) {
            e.printStackTrace();
        }
        
        // 2. handle - å¤„ç†æˆåŠŸå’Œå¼‚å¸¸æƒ…å†µ
        CompletableFuture<String> future2 = CompletableFuture.supplyAsync(() -> {
            if (Math.random() > 0.5) {
                throw new RuntimeException("éšæœºå¼‚å¸¸");
            }
            return "æˆåŠŸç»“æœ";
        }).handle((result, throwable) -> {
            if (throwable != null) {
                System.out.println("å¤„ç†å¼‚å¸¸: " + throwable.getMessage());
                return "å¼‚å¸¸æ—¶çš„é»˜è®¤å€¼";
            } else {
                return result + " å¤„ç†æˆåŠŸ";
            }
        });
        
        try {
            System.out.println("Future2ç»“æœ: " + future2.get());
        } catch (Exception e) {
            e.printStackTrace();
        }
        
        // 3. whenComplete - æ— è®ºæˆåŠŸå¤±è´¥éƒ½æ‰§è¡Œ
        CompletableFuture<String> future3 = CompletableFuture.supplyAsync(() -> {
            if (Math.random() > 0.5) {
                throw new RuntimeException("éšæœºå¼‚å¸¸");
            }
            return "æˆåŠŸç»“æœ";
        }).whenComplete((result, throwable) -> {
            if (throwable != null) {
                System.out.println("ä»»åŠ¡å¤±è´¥: " + throwable.getMessage());
            } else {
                System.out.println("ä»»åŠ¡æˆåŠŸ: " + result);
            }
        });
        
        try {
            future3.get();
        } catch (Exception e) {
            System.out.println("Future3æŠ›å‡ºå¼‚å¸¸: " + e.getMessage());
        }
    }
}
```

## 3. å®é™…åº”ç”¨åœºæ™¯

### 3.1 å¹¶è¡Œæ•°æ®å¤„ç†

```java title="å¹¶è¡Œæ•°æ®å¤„ç†ç¤ºä¾‹"
import java.util.Arrays;
import java.util.List;
import java.util.stream.Collectors;

public class ParallelDataProcessing {
    
    /**
     * å¹¶è¡Œæ•°æ®å¤„ç†
     */
    public static void main(String[] args) {
        System.out.println("=== å¹¶è¡Œæ•°æ®å¤„ç† ===");
        
        List<String> data = Arrays.asList("æ•°æ®1", "æ•°æ®2", "æ•°æ®3", "æ•°æ®4", "æ•°æ®5");
        
        // å¹¶è¡Œå¤„ç†æ•°æ®
        List<CompletableFuture<String>> futures = data.stream()
            .map(item -> CompletableFuture.supplyAsync(() -> processData(item)))
            .collect(Collectors.toList());
        
        // ç­‰å¾…æ‰€æœ‰å¤„ç†å®Œæˆ
        CompletableFuture<Void> allFutures = CompletableFuture.allOf(
            futures.toArray(new CompletableFuture[0]));
        
        allFutures.thenRun(() -> {
            List<String> results = futures.stream()
                .map(CompletableFuture::join)
                .collect(Collectors.toList());
            
            System.out.println("å¤„ç†ç»“æœ: " + results);
        });
        
        allFutures.join();
    }
    
    private static String processData(String data) {
        try {
            Thread.sleep(1000); // æ¨¡æ‹Ÿå¤„ç†æ—¶é—´
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
        return data + " å·²å¤„ç†";
    }
}
```

### 3.2 å¼‚æ­¥APIè°ƒç”¨

```java title="å¼‚æ­¥APIè°ƒç”¨ç¤ºä¾‹"
public class AsyncApiCall {
    
    /**
     * å¼‚æ­¥APIè°ƒç”¨
     */
    public static void main(String[] args) {
        System.out.println("=== å¼‚æ­¥APIè°ƒç”¨ ===");
        
        // æ¨¡æ‹Ÿå¼‚æ­¥APIè°ƒç”¨
        CompletableFuture<User> userFuture = getUserAsync(1L);
        CompletableFuture<Order> orderFuture = getOrderAsync(1L);
        CompletableFuture<Product> productFuture = getProductAsync(1L);
        
        // ç»„åˆå¤šä¸ªAPIè°ƒç”¨ç»“æœ
        CompletableFuture<UserOrderInfo> combinedFuture = userFuture
            .thenCombine(orderFuture, (user, order) -> new UserOrderInfo(user, order))
            .thenCombine(productFuture, (userOrder, product) -> {
                userOrder.setProduct(product);
                return userOrder;
            });
        
        try {
            UserOrderInfo result = combinedFuture.get();
            System.out.println("ç»„åˆç»“æœ: " + result);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    private static CompletableFuture<User> getUserAsync(Long userId) {
        return CompletableFuture.supplyAsync(() -> {
            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
            return new User(userId, "ç”¨æˆ·" + userId);
        });
    }
    
    private static CompletableFuture<Order> getOrderAsync(Long orderId) {
        return CompletableFuture.supplyAsync(() -> {
            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
            return new Order(orderId, "è®¢å•" + orderId);
        });
    }
    
    private static CompletableFuture<Product> getProductAsync(Long productId) {
        return CompletableFuture.supplyAsync(() -> {
            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
            return new Product(productId, "äº§å“" + productId);
        });
    }
    
    static class User {
        private Long id;
        private String name;
        
        public User(Long id, String name) {
            this.id = id;
            this.name = name;
        }
        
        @Override
        public String toString() {
            return "User{id=" + id + ", name='" + name + "'}";
        }
    }
    
    static class Order {
        private Long id;
        private String name;
        
        public Order(Long id, String name) {
            this.id = id;
            this.name = name;
        }
        
        @Override
        public String toString() {
            return "Order{id=" + id + ", name='" + name + "'}";
        }
    }
    
    static class Product {
        private Long id;
        private String name;
        
        public Product(Long id, String name) {
            this.id = id;
            this.name = name;
        }
        
        @Override
        public String toString() {
            return "Product{id=" + id + ", name='" + name + "'}";
        }
    }
    
    static class UserOrderInfo {
        private User user;
        private Order order;
        private Product product;
        
        public UserOrderInfo(User user, Order order) {
            this.user = user;
            this.order = order;
        }
        
        public void setProduct(Product product) {
            this.product = product;
        }
        
        @Override
        public String toString() {
            return "UserOrderInfo{user=" + user + ", order=" + order + ", product=" + product + "}";
        }
    }
}
```

### 3.3 è¶…æ—¶æ§åˆ¶

```java title="è¶…æ—¶æ§åˆ¶ç¤ºä¾‹"
import java.util.concurrent.TimeUnit;
import java.util.concurrent.TimeoutException;

public class CompletableFutureTimeout {
    
    /**
     * è¶…æ—¶æ§åˆ¶
     */
    public static void main(String[] args) {
        System.out.println("=== è¶…æ—¶æ§åˆ¶ ===");
        
        // åˆ›å»ºå¯èƒ½è¶…æ—¶çš„ä»»åŠ¡
        CompletableFuture<String> slowTask = CompletableFuture.supplyAsync(() -> {
            try {
                Thread.sleep(3000); // 3ç§’
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
            return "æ…¢ä»»åŠ¡å®Œæˆ";
        });
        
        // æ·»åŠ è¶…æ—¶æ§åˆ¶
        CompletableFuture<String> timeoutTask = slowTask
            .orTimeout(2, TimeUnit.SECONDS) // 2ç§’è¶…æ—¶
            .exceptionally(throwable -> {
                if (throwable instanceof TimeoutException) {
                    return "ä»»åŠ¡è¶…æ—¶";
                }
                return "å…¶ä»–å¼‚å¸¸: " + throwable.getMessage();
            });
        
        try {
            String result = timeoutTask.get();
            System.out.println("ç»“æœ: " + result);
        } catch (Exception e) {
            e.printStackTrace();
        }
        
        // ä½¿ç”¨completeOnTimeoutè®¾ç½®è¶…æ—¶æ—¶çš„é»˜è®¤å€¼
        CompletableFuture<String> defaultTimeoutTask = CompletableFuture.supplyAsync(() -> {
            try {
                Thread.sleep(3000);
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
            return "æ…¢ä»»åŠ¡å®Œæˆ";
        }).completeOnTimeout("è¶…æ—¶é»˜è®¤å€¼", 2, TimeUnit.SECONDS);
        
        try {
            String result = defaultTimeoutTask.get();
            System.out.println("è¶…æ—¶é»˜è®¤å€¼ç»“æœ: " + result);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

## 4. æ€§èƒ½ä¼˜åŒ–

### 4.1 ä½¿ç”¨è‡ªå®šä¹‰çº¿ç¨‹æ± 

```java title="è‡ªå®šä¹‰çº¿ç¨‹æ± ç¤ºä¾‹"
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.concurrent.ThreadPoolExecutor;

public class CompletableFutureOptimization {
    
    /**
     * ä½¿ç”¨è‡ªå®šä¹‰çº¿ç¨‹æ± 
     */
    public static void main(String[] args) {
        System.out.println("=== è‡ªå®šä¹‰çº¿ç¨‹æ± ä¼˜åŒ– ===");
        
        // åˆ›å»ºä¸“ç”¨çº¿ç¨‹æ± 
        ExecutorService executor = Executors.newFixedThreadPool(10);
        
        // ä½¿ç”¨è‡ªå®šä¹‰çº¿ç¨‹æ± 
        CompletableFuture<String> future = CompletableFuture
            .supplyAsync(() -> "ä»»åŠ¡1", executor)
            .thenApplyAsync(s -> s + " å¤„ç†", executor)
            .thenApplyAsync(s -> s + " å®Œæˆ", executor);
        
        try {
            System.out.println("ç»“æœ: " + future.get());
        } catch (Exception e) {
            e.printStackTrace();
        }
        
        executor.shutdown();
    }
    
    /**
     * çº¿ç¨‹æ± é…ç½®å»ºè®®
     */
    public static class ThreadPoolConfig {
        
        // CPUå¯†é›†å‹ä»»åŠ¡
        public static ExecutorService createCpuIntensivePool() {
            int processors = Runtime.getRuntime().availableProcessors();
            return Executors.newFixedThreadPool(processors + 1);
        }
        
        // I/Oå¯†é›†å‹ä»»åŠ¡
        public static ExecutorService createIoIntensivePool() {
            int processors = Runtime.getRuntime().availableProcessors();
            return Executors.newFixedThreadPool(processors * 2);
        }
        
        // æ··åˆå‹ä»»åŠ¡
        public static ExecutorService createMixedPool() {
            int processors = Runtime.getRuntime().availableProcessors();
            return Executors.newFixedThreadPool(processors * 3);
        }
    }
}
```

### 4.2 é¿å…é˜»å¡æ“ä½œ

```java title="é¿å…é˜»å¡æ“ä½œç¤ºä¾‹"
public class NonBlockingOperations {
    
    /**
     * é¿å…é˜»å¡æ“ä½œ
     */
    public static void main(String[] args) {
        System.out.println("=== é¿å…é˜»å¡æ“ä½œ ===");
        
        // é¿å…åœ¨å¼‚æ­¥ä»»åŠ¡ä¸­ä½¿ç”¨é˜»å¡æ“ä½œ
        CompletableFuture<String> future = CompletableFuture
            .supplyAsync(() -> "æ•°æ®")
            .thenApplyAsync(data -> processData(data)) // å¼‚æ­¥å¤„ç†
            .thenAcceptAsync(result -> System.out.println("å¤„ç†ç»“æœ: " + result)); // å¼‚æ­¥æ¶ˆè´¹
        
        // ç­‰å¾…å®Œæˆ
        future.join();
    }
    
    private static String processData(String data) {
        // æ¨¡æ‹Ÿæ•°æ®å¤„ç†
        return data + " å·²å¤„ç†";
    }
    
    /**
     * æ­£ç¡®çš„å¼‚æ­¥å¤„ç†æ–¹å¼
     */
    public static class CorrectAsyncProcessing {
        
        public static CompletableFuture<String> processAsync(String input) {
            return CompletableFuture.supplyAsync(() -> {
                // å¼‚æ­¥å¤„ç†é€»è¾‘
                return input + " å¼‚æ­¥å¤„ç†";
            });
        }
        
        public static CompletableFuture<String> processWithTimeout(String input, long timeout) {
            return CompletableFuture.supplyAsync(() -> {
                // å¼‚æ­¥å¤„ç†é€»è¾‘
                return input + " å¼‚æ­¥å¤„ç†";
            }).orTimeout(timeout, TimeUnit.SECONDS);
        }
    }
}
```

## 5. æœ€ä½³å®è·µ

### 5.1 å¼‚å¸¸å¤„ç†æœ€ä½³å®è·µ

```java title="å¼‚å¸¸å¤„ç†æœ€ä½³å®è·µç¤ºä¾‹"
public class ExceptionHandlingBestPractices {
    
    /**
     * å¼‚å¸¸å¤„ç†æœ€ä½³å®è·µ
     */
    public static void main(String[] args) {
        System.out.println("=== å¼‚å¸¸å¤„ç†æœ€ä½³å®è·µ ===");
        
        // 1. ä½¿ç”¨exceptionallyå¤„ç†ç‰¹å®šå¼‚å¸¸
        CompletableFuture<String> future1 = CompletableFuture
            .supplyAsync(() -> {
                if (Math.random() > 0.5) {
                    throw new RuntimeException("ä¸šåŠ¡å¼‚å¸¸");
                }
                return "æˆåŠŸ";
            })
            .exceptionally(throwable -> {
                if (throwable instanceof RuntimeException) {
                    return "å¤„ç†ä¸šåŠ¡å¼‚å¸¸: " + throwable.getMessage();
                }
                return "å¤„ç†å…¶ä»–å¼‚å¸¸: " + throwable.getMessage();
            });
        
        // 2. ä½¿ç”¨handleå¤„ç†æ‰€æœ‰æƒ…å†µ
        CompletableFuture<String> future2 = CompletableFuture
            .supplyAsync(() -> {
                if (Math.random() > 0.5) {
                    throw new RuntimeException("ä¸šåŠ¡å¼‚å¸¸");
                }
                return "æˆåŠŸ";
            })
            .handle((result, throwable) -> {
                if (throwable != null) {
                    return "å¼‚å¸¸å¤„ç†: " + throwable.getMessage();
                }
                return "æˆåŠŸå¤„ç†: " + result;
            });
        
        // 3. ä½¿ç”¨whenCompleteè®°å½•æ—¥å¿—
        CompletableFuture<String> future3 = CompletableFuture
            .supplyAsync(() -> {
                if (Math.random() > 0.5) {
                    throw new RuntimeException("ä¸šåŠ¡å¼‚å¸¸");
                }
                return "æˆåŠŸ";
            })
            .whenComplete((result, throwable) -> {
                if (throwable != null) {
                    System.out.println("ä»»åŠ¡å¤±è´¥ï¼Œè®°å½•æ—¥å¿—: " + throwable.getMessage());
                } else {
                    System.out.println("ä»»åŠ¡æˆåŠŸï¼Œè®°å½•æ—¥å¿—: " + result);
                }
            });
        
        try {
            System.out.println("Future1: " + future1.get());
            System.out.println("Future2: " + future2.get());
            future3.get();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

### 5.2 èµ„æºç®¡ç†æœ€ä½³å®è·µ

```java title="èµ„æºç®¡ç†æœ€ä½³å®è·µç¤ºä¾‹"
public class ResourceManagementBestPractices {
    
    /**
     * èµ„æºç®¡ç†æœ€ä½³å®è·µ
     */
    public static void main(String[] args) {
        System.out.println("=== èµ„æºç®¡ç†æœ€ä½³å®è·µ ===");
        
        ExecutorService executor = Executors.newFixedThreadPool(5);
        
        try {
            // ä½¿ç”¨try-with-resourcesç®¡ç†èµ„æº
            CompletableFuture<String> future = CompletableFuture
                .supplyAsync(() -> "ä»»åŠ¡", executor)
                .thenApplyAsync(result -> result + " å¤„ç†", executor);
            
            String result = future.get();
            System.out.println("ç»“æœ: " + result);
            
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            // ç¡®ä¿çº¿ç¨‹æ± å…³é—­
            executor.shutdown();
            try {
                if (!executor.awaitTermination(60, TimeUnit.SECONDS)) {
                    executor.shutdownNow();
                }
            } catch (InterruptedException e) {
                executor.shutdownNow();
                Thread.currentThread().interrupt();
            }
        }
    }
    
    /**
     * è‡ªåŠ¨èµ„æºç®¡ç†
     */
    public static class AutoResourceManager {
        
        public static <T> CompletableFuture<T> withExecutor(
                Function<ExecutorService, CompletableFuture<T>> task,
                int poolSize) {
            
            ExecutorService executor = Executors.newFixedThreadPool(poolSize);
            
            return task.apply(executor)
                .whenComplete((result, throwable) -> {
                    executor.shutdown();
                    try {
                        if (!executor.awaitTermination(60, TimeUnit.SECONDS)) {
                            executor.shutdownNow();
                        }
                    } catch (InterruptedException e) {
                        executor.shutdownNow();
                        Thread.currentThread().interrupt();
                    }
                });
        }
    }
}
```

## 6. é¢è¯•é¢˜

### 6.1 åŸºç¡€æ¦‚å¿µ

**Q: CompletableFutureå’ŒFutureæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ**

**A:**
- **Future**ï¼šåªèƒ½é€šè¿‡get()æ–¹æ³•è·å–ç»“æœï¼Œä¼šé˜»å¡
- **CompletableFuture**ï¼šæ”¯æŒé“¾å¼è°ƒç”¨å’Œå¼‚æ­¥å¤„ç†
- **CompletableFuture**ï¼šæä¾›äº†ä¸°å¯Œçš„APIæ¥å¤„ç†å¼‚æ­¥æ“ä½œ
- **CompletableFuture**ï¼šæ”¯æŒå¼‚å¸¸å¤„ç†å’Œè¶…æ—¶æ§åˆ¶

**Q: thenApplyå’ŒthenApplyAsyncæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ**

**A:**
- **thenApply**ï¼šåœ¨è°ƒç”¨çº¿ç¨‹ä¸­æ‰§è¡Œ
- **thenApplyAsync**ï¼šåœ¨ForkJoinPool.commonPool()ä¸­æ‰§è¡Œ
- **thenApplyAsync**ï¼šå¯ä»¥æŒ‡å®šè‡ªå®šä¹‰çº¿ç¨‹æ± 
- **thenApplyAsync**ï¼šæ›´é€‚åˆCPUå¯†é›†å‹ä»»åŠ¡

### 6.2 å¼‚å¸¸å¤„ç†

**Q: å¦‚ä½•å¤„ç†CompletableFutureä¸­çš„å¼‚å¸¸ï¼Ÿ**

**A:**
- ä½¿ç”¨exceptionally()å¤„ç†å¼‚å¸¸å¹¶è¿”å›é»˜è®¤å€¼
- ä½¿ç”¨handle()åŒæ—¶å¤„ç†æˆåŠŸå’Œå¼‚å¸¸æƒ…å†µ
- ä½¿ç”¨whenComplete()æ— è®ºæˆåŠŸå¤±è´¥éƒ½æ‰§è¡Œ
- ä½¿ç”¨completeExceptionally()æ‰‹åŠ¨å®Œæˆå¼‚å¸¸

**Q: CompletableFuture.allOfå’ŒanyOfæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ**

**A:**
- **allOf**ï¼šç­‰å¾…æ‰€æœ‰Futureå®Œæˆ
- **anyOf**ï¼šç­‰å¾…ä»»æ„ä¸€ä¸ªFutureå®Œæˆ
- **allOf**ï¼šè¿”å›Voidç±»å‹
- **anyOf**ï¼šè¿”å›Objectç±»å‹ï¼ˆç¬¬ä¸€ä¸ªå®Œæˆçš„Futureçš„ç»“æœï¼‰

### 6.3 æ€§èƒ½ä¼˜åŒ–

**Q: å¦‚ä½•å®ç°CompletableFutureçš„è¶…æ—¶æ§åˆ¶ï¼Ÿ**

**A:**
- ä½¿ç”¨orTimeout()æ–¹æ³•è®¾ç½®è¶…æ—¶æ—¶é—´
- ä½¿ç”¨completeOnTimeout()è®¾ç½®è¶…æ—¶æ—¶çš„é»˜è®¤å€¼
- ä½¿ç”¨get()æ–¹æ³•çš„è¶…æ—¶ç‰ˆæœ¬
- ç»“åˆTimeræˆ–ScheduledExecutorServiceå®ç°è‡ªå®šä¹‰è¶…æ—¶

**Q: å¦‚ä½•é€‰æ‹©åˆé€‚çš„çº¿ç¨‹æ± ï¼Ÿ**

**A:**
- **CPUå¯†é›†å‹**ï¼šçº¿ç¨‹æ•° = CPUæ ¸å¿ƒæ•° + 1
- **I/Oå¯†é›†å‹**ï¼šçº¿ç¨‹æ•° = CPUæ ¸å¿ƒæ•° Ã— 2
- **æ··åˆå‹**ï¼šçº¿ç¨‹æ•° = CPUæ ¸å¿ƒæ•° Ã— 3
- æ ¹æ®å®é™…ä¸šåŠ¡åœºæ™¯è°ƒæ•´

### 6.4 å®é™…åº”ç”¨

**Q: CompletableFutureåœ¨å¾®æœåŠ¡æ¶æ„ä¸­çš„åº”ç”¨ï¼Ÿ**

**A:**
- å¹¶è¡Œè°ƒç”¨å¤šä¸ªå¾®æœåŠ¡
- å¼‚æ­¥å¤„ç†ç”¨æˆ·è¯·æ±‚
- å®ç°ç†”æ–­å’Œé™çº§
- æé«˜ç³»ç»Ÿå“åº”æ€§

**Q: å¦‚ä½•é¿å…CompletableFutureä¸­çš„å¸¸è§é™·é˜±ï¼Ÿ**

**A:**
- åŠæ—¶å¤„ç†å¼‚å¸¸
- æ­£ç¡®ç®¡ç†çº¿ç¨‹æ± èµ„æº
- é¿å…åœ¨å¼‚æ­¥ä»»åŠ¡ä¸­ä½¿ç”¨é˜»å¡æ“ä½œ
- åˆç†è®¾ç½®è¶…æ—¶æ—¶é—´

## 7. æ€»ç»“

CompletableFutureä¸ºJavaå¼‚æ­¥ç¼–ç¨‹æä¾›äº†å¼ºå¤§è€Œçµæ´»çš„æ”¯æŒã€‚

### 7.1 å…³é”®è¦ç‚¹

1. **å¼‚æ­¥ç¼–ç¨‹ä¼˜åŠ¿**ï¼šæé«˜å“åº”æ€§ã€å……åˆ†åˆ©ç”¨èµ„æº
2. **APIä¸°å¯Œæ€§**ï¼šæ”¯æŒé“¾å¼è°ƒç”¨ã€ç»„åˆã€å¼‚å¸¸å¤„ç†
3. **æ€§èƒ½ä¼˜åŒ–**ï¼šä½¿ç”¨è‡ªå®šä¹‰çº¿ç¨‹æ± ã€é¿å…é˜»å¡æ“ä½œ
4. **æœ€ä½³å®è·µ**ï¼šæ­£ç¡®å¼‚å¸¸å¤„ç†ã€èµ„æºç®¡ç†

### 7.2 ä½¿ç”¨å»ºè®®

| åœºæ™¯ | æ¨èæ–¹å¼ | åŸå›  |
|------|----------|------|
| **ç®€å•å¼‚æ­¥ä»»åŠ¡** | supplyAsync/runAsync | ç®€å•æ˜“ç”¨ |
| **å¤æ‚å¼‚æ­¥æµç¨‹** | é“¾å¼è°ƒç”¨ | ä»£ç æ¸…æ™° |
| **å¤šä¸ªä»»åŠ¡ç»„åˆ** | allOf/anyOf | çµæ´»æ§åˆ¶ |
| **å¼‚å¸¸å¤„ç†** | exceptionally/handle | ä¼˜é›…å¤„ç† |
| **è¶…æ—¶æ§åˆ¶** | orTimeout | é˜²æ­¢é˜»å¡ |

### 7.3 å­¦ä¹ å»ºè®®

1. **ç†è§£åŸç†**ï¼šæ·±å…¥ç†è§£å¼‚æ­¥ç¼–ç¨‹çš„å·¥ä½œåŸç†
2. **å®è·µéªŒè¯**ï¼šé€šè¿‡ç¼–å†™ä»£ç éªŒè¯ä¸åŒAPIçš„æ•ˆæœ
3. **æ€§èƒ½æµ‹è¯•**ï¼šå¯¹æ¯”ä¸åŒå®ç°æ–¹å¼çš„æ€§èƒ½å·®å¼‚
4. **åœºæ™¯åº”ç”¨**ï¼šåœ¨å®é™…é¡¹ç›®ä¸­åº”ç”¨å¼‚æ­¥ç¼–ç¨‹

é€šè¿‡æ·±å…¥ç†è§£å’Œç†Ÿç»ƒè¿ç”¨CompletableFutureï¼Œæˆ‘ä»¬èƒ½å¤Ÿæ„å»ºå‡ºæ›´åŠ é«˜æ•ˆã€å¥å£®å’Œå¯ç»´æŠ¤çš„Javaå¼‚æ­¥åº”ç”¨ç¨‹åºã€‚ 