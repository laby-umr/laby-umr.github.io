---
sidebar_position: 6
title: "Javaé”æœºåˆ¶è¯¦è§£"
description: "å…¨é¢ä»‹ç»Javaé”æœºåˆ¶ã€synchronizedã€Lockæ¥å£ã€è¯»å†™é”ä¸æœ€ä½³å®è·µ"
authors: [Laby]
last_update:
  date: 2025-01-07
  author: Laby
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import TOCInline from '@theme/TOCInline';

# Java é”æœºåˆ¶è¯¦è§£

é”æ˜¯Javaå¹¶å‘ç¼–ç¨‹ä¸­å®ç°çº¿ç¨‹åŒæ­¥çš„æ ¸å¿ƒæœºåˆ¶ï¼Œç†è§£å„ç§é”çš„ç‰¹æ€§å’Œä½¿ç”¨åœºæ™¯å¯¹äºæ„å»ºé«˜æ€§èƒ½çš„å¹¶å‘åº”ç”¨è‡³å…³é‡è¦ã€‚æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»Javaä¸­çš„å„ç§é”æœºåˆ¶ã€‚

:::info æœ¬æ–‡å†…å®¹æ¦‚è§ˆ
<TOCInline toc={toc} />
:::

:::tip æ ¸å¿ƒä»·å€¼
**Javaé”æœºåˆ¶ = çº¿ç¨‹åŒæ­¥ + èµ„æºä¿æŠ¤ + æ‰§è¡Œé¡ºåºæ§åˆ¶ + å†…å­˜å¯è§æ€§**
- ğŸ”’ **åŒæ­¥è®¿é—®**ï¼šç¡®ä¿å…±äº«èµ„æºçš„äº’æ–¥è®¿é—®
- ğŸ›¡ï¸ **æ•°æ®ä¿æŠ¤**ï¼šé¿å…æ•°æ®ç«äº‰å’ŒçŠ¶æ€ä¸ä¸€è‡´
- âš¡ **é«˜æ€§èƒ½**ï¼šé€šè¿‡ä¸åŒé”ç­–ç•¥ä¼˜åŒ–å¹¶å‘æ€§èƒ½
- ğŸ”„ **æ‰§è¡Œæ§åˆ¶**ï¼šç®¡ç†çº¿ç¨‹çš„æ‰§è¡Œé¡ºåºå’Œæ—¶åºå…³ç³»
- ğŸ‘ï¸ **å¯è§æ€§**ï¼šç¡®ä¿çº¿ç¨‹é—´æ•°æ®ä¿®æ”¹çš„å¯è§æ€§
:::

## 1. é”æœºåˆ¶æ¦‚è¿°

### 1.1 ä»€ä¹ˆæ˜¯é”ï¼Ÿ

```mermaid
graph TD
    A[é”æœºåˆ¶] --> B[åŒæ­¥è®¿é—®]
    A --> C[äº’æ–¥æ€§]
    A --> D[å¯è§æ€§]
    A --> E[åŸå­æ€§]
    
    B --> B1[æ§åˆ¶å¤šçº¿ç¨‹è®¿é—®å…±äº«èµ„æº]
    C --> C1[ç¡®ä¿ä¸€æ¬¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹æŒæœ‰é”]
    D --> D1[ä¿è¯çº¿ç¨‹é—´æ•°æ®ä¿®æ”¹çš„å¯è§æ€§]
    E --> E1[ç¡®ä¿æ“ä½œä¸ä¼šè¢«ä¸­æ–­]
    
    style A fill:#f9f,stroke:#333,stroke-width:2px
    style B fill:#bbf,stroke:#333
    style C fill:#bbf,stroke:#333
    style D fill:#bbf,stroke:#333
    style E fill:#bbf,stroke:#333
```

:::tip æ ¸å¿ƒæ¦‚å¿µ
é”æ˜¯ä¸€ç§åŒæ­¥æœºåˆ¶ï¼Œç”¨äºæ§åˆ¶å¤šä¸ªçº¿ç¨‹å¯¹å…±äº«èµ„æºçš„è®¿é—®ã€‚é”ç¡®ä¿åœ¨ä»»æ„æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿè®¿é—®è¢«ä¿æŠ¤çš„èµ„æºï¼Œä»è€Œä¿è¯æ•°æ®çš„ä¸€è‡´æ€§å’Œå®Œæ•´æ€§ã€‚
:::

### 1.2 é”çš„åˆ†ç±»

<div className="card">
<div className="card__body">

| åˆ†ç±»ç»´åº¦ | ç±»å‹ | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ |
|----------|------|------|----------|
| **å®ç°æ–¹å¼** | synchronized | å†…ç½®é”ï¼Œè‡ªåŠ¨ç®¡ç† | ç®€å•åŒæ­¥éœ€æ±‚ |
| | Lockæ¥å£ | æ˜¾å¼é”ï¼Œæ‰‹åŠ¨ç®¡ç† | å¤æ‚åŒæ­¥éœ€æ±‚ |
| **å…¬å¹³æ€§** | éå…¬å¹³é” | æ€§èƒ½é«˜ï¼Œä¸ä¿è¯é¡ºåº | ä¸€èˆ¬åœºæ™¯ |
| | å…¬å¹³é” | ä¿è¯FIFOé¡ºåº | éœ€è¦å…¬å¹³æ€§åœºæ™¯ |
| **å¯é‡å…¥æ€§** | å¯é‡å…¥é” | åŒä¸€çº¿ç¨‹å¯å¤šæ¬¡è·å– | é€’å½’è°ƒç”¨åœºæ™¯ |
| | ä¸å¯é‡å…¥é” | åŒä¸€çº¿ç¨‹åªèƒ½è·å–ä¸€æ¬¡ | ç®€å•åœºæ™¯ |
| **è¯»å†™ç‰¹æ€§** | ç‹¬å é” | åªå…è®¸ä¸€ä¸ªçº¿ç¨‹è®¿é—® | å†™æ“ä½œ |
| | è¯»å†™é” | å…è®¸å¤šä¸ªè¯»ï¼Œå•ä¸ªå†™ | è¯»å¤šå†™å°‘åœºæ™¯ |
| **ä¹è§‚/æ‚²è§‚** | æ‚²è§‚é” | å‡è®¾ä¼šå‘ç”Ÿå†²çªï¼Œå…ˆè·å–é” | é«˜å¹¶å‘å†™æ“ä½œ |
| | ä¹è§‚é” | å‡è®¾ä¸ä¼šå‘ç”Ÿå†²çªï¼Œæ£€æµ‹æ›´æ–° | è¯»å¤šå†™å°‘åœºæ™¯ |

</div>
</div>

<details>
<summary><strong>é”åˆ†ç±»è¯¦ç»†å›¾</strong></summary>

```mermaid
classDiagram
    class Javaé” {
        <<interface>>
    }
    
    class å®ç°æ–¹å¼ {
        å†…ç½®é”
        æ˜¾å¼é”
    }
    
    class å†…ç½®é” {
        synchronizedå…³é”®å­—
        è‡ªåŠ¨è·å–é‡Šæ”¾
        JVMå±‚é¢å®ç°
    }
    
    class æ˜¾å¼é” {
        Lockæ¥å£
        æ‰‹åŠ¨è·å–é‡Šæ”¾
        JDKå±‚é¢å®ç°
    }
    
    class å…¬å¹³æ€§ {
        å…¬å¹³é”
        éå…¬å¹³é”
    }
    
    class å…¬å¹³é” {
        FIFOé¡ºåº
        ç­‰å¾…æ—¶é—´é•¿çš„ä¼˜å…ˆè·å¾—é”
    }
    
    class éå…¬å¹³é” {
        éšæœºæˆ–å°±è¿‘åŸåˆ™
        æ€§èƒ½è¾ƒé«˜
    }
    
    class å¯é‡å…¥æ€§ {
        å¯é‡å…¥é”
        ä¸å¯é‡å…¥é”
    }
    
    class å¯é‡å…¥é” {
        åŒä¸€çº¿ç¨‹å¯é‡å¤è·å–
        é”è®¡æ•°å™¨æœºåˆ¶
    }
    
    class ä¸å¯é‡å…¥é” {
        åŒä¸€çº¿ç¨‹ä¸å¯é‡å¤è·å–
        ç®€å•å®ç°
    }
    
    class è¯»å†™ç‰¹æ€§ {
        ç‹¬å é”
        å…±äº«é”
    }
    
    class ç‹¬å é” {
        æ’ä»–é”
        åŒä¸€æ—¶åˆ»ä»…ä¸€ä¸ªçº¿ç¨‹
        ReentrantLock
    }
    
    class å…±äº«é” {
        åŒä¸€æ—¶åˆ»å¤šä¸ªçº¿ç¨‹
        ReadWriteLock
        Semaphore
    }
    
    Javaé” --> å®ç°æ–¹å¼
    å®ç°æ–¹å¼ --> å†…ç½®é”
    å®ç°æ–¹å¼ --> æ˜¾å¼é”
    Javaé” --> å…¬å¹³æ€§
    å…¬å¹³æ€§ --> å…¬å¹³é”
    å…¬å¹³æ€§ --> éå…¬å¹³é”
    Javaé” --> å¯é‡å…¥æ€§
    å¯é‡å…¥æ€§ --> å¯é‡å…¥é”
    å¯é‡å…¥æ€§ --> ä¸å¯é‡å…¥é”
    Javaé” --> è¯»å†™ç‰¹æ€§
    è¯»å†™ç‰¹æ€§ --> ç‹¬å é”
    è¯»å†™ç‰¹æ€§ --> å…±äº«é”
```

</details>

### 1.3 é”çš„æ€§èƒ½ç‰¹æ€§

<Tabs>
  <TabItem value="comparison" label="é”ç±»å‹æ€§èƒ½å¯¹æ¯”" default>
  <div className="card">
  <div className="card__body">
  
  | é”ç±»å‹ | æ€§èƒ½ | åŠŸèƒ½ | ä½¿ç”¨å¤æ‚åº¦ | æ­»é”é£é™© | æ´»è·ƒæ€§ |
  |--------|------|------|------------|----------|--------|
  | **synchronized** | ä¸­ç­‰ | åŸºç¡€åŠŸèƒ½ | ç®€å• | ä¸­ç­‰ | ä¸å¯ä¸­æ–­ |
  | **ReentrantLock** | é«˜ | ä¸°å¯Œ | ä¸­ç­‰ | ä½ï¼ˆå¯è¶…æ—¶ï¼‰ | å¯ä¸­æ–­ |
  | **ReadWriteLock** | è¯»å¤šå†™å°‘åœºæ™¯é«˜ | åˆ†ç¦»è¯»å†™ | ä¸­ç­‰ | ä¸­ç­‰ | å¯ä¸­æ–­ |
  | **StampedLock** | éå¸¸é«˜ | ä¹è§‚è¯» | å¤æ‚ | ä½ | é«˜ |
  | **ä¹è§‚é”(CAS)** | ä½ç«äº‰ä¸‹é«˜ | æ— é˜»å¡ | å¤æ‚ | æ—  | é«˜ |
  
  </div>
  </div>
  </TabItem>
  <TabItem value="metrics" label="å…³é”®æ€§èƒ½æŒ‡æ ‡">
  <div className="card">
  <div className="card__body">
  
  **é”çš„æ€§èƒ½è¡¡é‡æŒ‡æ ‡ï¼š**
  
  1. **é”ç«äº‰å¼€é”€**ï¼šå¤šä¸ªçº¿ç¨‹åŒæ—¶è¯·æ±‚é”æ—¶çš„æ€§èƒ½æŸå¤±
  2. **é”æŒæœ‰æ—¶é—´**ï¼šè·å–é”åˆ°é‡Šæ”¾é”çš„å¹³å‡æ—¶é—´
  3. **ç­‰å¾…é˜Ÿåˆ—é•¿åº¦**ï¼šç­‰å¾…è·å–é”çš„çº¿ç¨‹æ•°é‡
  4. **ä¸Šä¸‹æ–‡åˆ‡æ¢æ¬¡æ•°**ï¼šçº¿ç¨‹å› ä¸ºé”è€Œè¢«æŒ‚èµ·å’Œæ¢å¤çš„æ¬¡æ•°
  5. **å†…å­˜å¼€é”€**ï¼šé”æœºåˆ¶æ‰€éœ€çš„å†…å­˜ç©ºé—´
  6. **CPUåˆ©ç”¨ç‡**ï¼šé”å®ç°æœºåˆ¶å¯¹CPUçš„ä½¿ç”¨ç‡
  7. **å¯ä¼¸ç¼©æ€§**ï¼šéšç€çº¿ç¨‹æ•°å¢åŠ ï¼Œæ€§èƒ½çš„å˜åŒ–è¶‹åŠ¿
  
  </div>
  </div>
  </TabItem>
  <TabItem value="scenarios" label="æœ€ä½³åœºæ™¯">
  <div className="card">
  <div className="card__body">
  
  | åœºæ™¯ | æ¨èé” | åŸå›  |
  |------|--------|------|
  | **ç®€å•åŒæ­¥** | synchronized | ç®€å•æ˜“ç”¨ï¼Œè‡ªåŠ¨ç®¡ç† |
  | **éœ€è¦ä¸­æ–­/è¶…æ—¶** | ReentrantLock | æ”¯æŒlockInterruptibly()å’ŒtryLock() |
  | **è¯»å¤šå†™å°‘** | ReadWriteLock | å…è®¸å¹¶å‘è¯»ï¼Œæé«˜ååé‡ |
  | **é«˜æ€§èƒ½è¯»åœºæ™¯** | StampedLock | æ”¯æŒä¹è§‚è¯»ï¼Œæ— é”è®¿é—® |
  | **ä½ç«äº‰ç¯å¢ƒ** | CASæ“ä½œ | é¿å…çº¿ç¨‹é˜»å¡ï¼Œæ€§èƒ½é«˜ |
  | **å…¬å¹³æ€§è¦æ±‚** | ReentrantLock(true) | æ”¯æŒå…¬å¹³è°ƒåº¦ |
  | **å¯ä¸­æ–­ä»»åŠ¡** | ReentrantLock | æ”¯æŒä¸­æ–­ç­‰å¾… |
  | **é€’å½’è°ƒç”¨** | synchronized/ReentrantLock | æ”¯æŒé‡å…¥ |
  
  </div>
  </div>
  </TabItem>
</Tabs>

## 2. synchronized å…³é”®å­—

### 2.1 synchronized åŸºæœ¬ç”¨æ³•

```mermaid
graph TD
    A[synchronizedåº”ç”¨æ–¹å¼] --> B[å®ä¾‹æ–¹æ³•åŒæ­¥]
    A --> C[é™æ€æ–¹æ³•åŒæ­¥]
    A --> D[ä»£ç å—åŒæ­¥]
    
    B -->|é”å¯¹è±¡| B1[å½“å‰å¯¹è±¡this]
    C -->|é”å¯¹è±¡| C1[ç±»å¯¹è±¡ClassName.class]
    D -->|é”å¯¹è±¡| D1[æŒ‡å®šçš„å¯¹è±¡]
    
    B1 --> E[å¤šçº¿ç¨‹è®¿é—®<br>åŒä¸€å®ä¾‹çš„åŒæ­¥æ–¹æ³•]
    C1 --> F[å¤šçº¿ç¨‹è®¿é—®<br>åŒä¸€ç±»çš„é™æ€åŒæ­¥æ–¹æ³•]
    D1 --> G[ç²¾ç¡®æ§åˆ¶<br>åŒæ­¥èŒƒå›´]
```

<Tabs>
  <TabItem value="instance_method" label="å®ä¾‹æ–¹æ³•åŒæ­¥" default>
  ```java
  public class Counter {
      private int count = 0;
      
      // å®ä¾‹æ–¹æ³•åŒæ­¥ - é”æ˜¯å½“å‰å®ä¾‹(this)
      public synchronized void increment() {
          count++;
      }
      
      public synchronized int getCount() {
          return count;
      }
  }
  
  // ä½¿ç”¨æ–¹å¼
  Counter counter = new Counter();
  // å¤šä¸ªçº¿ç¨‹è°ƒç”¨åŒä¸€å®ä¾‹çš„æ–¹æ³•
  counter.increment(); // çº¿ç¨‹å®‰å…¨
  
  // æ³¨æ„: ä¸åŒå®ä¾‹ä¹‹é—´çš„æ–¹æ³•è°ƒç”¨ä¸å—å½±å“
  Counter counter1 = new Counter();
  Counter counter2 = new Counter();
  // è¿™ä¸¤ä¸ªè°ƒç”¨å¯ä»¥å¹¶å‘æ‰§è¡Œï¼Œäº’ä¸å¹²æ‰°
  counter1.increment();
  counter2.increment();
  ```
  </TabItem>
  <TabItem value="static_method" label="é™æ€æ–¹æ³•åŒæ­¥">
  ```java
  public class StaticCounter {
      private static int count = 0;
      
      // é™æ€æ–¹æ³•åŒæ­¥ - é”æ˜¯ç±»å¯¹è±¡(StaticCounter.class)
      public static synchronized void increment() {
          count++;
      }
      
      public static synchronized int getCount() {
          return count;
      }
  }
  
  // ä½¿ç”¨æ–¹å¼
  // å¤šä¸ªçº¿ç¨‹è°ƒç”¨åŒä¸€ä¸ªç±»çš„é™æ€æ–¹æ³•
  StaticCounter.increment(); // çº¿ç¨‹å®‰å…¨
  
  // æ³¨æ„: æ‰€æœ‰çº¿ç¨‹éƒ½ä¼šç«äº‰åŒä¸€ä¸ªé”(ç±»é”)ï¼Œ
  // å³ä½¿æ˜¯ä¸åŒå®ä¾‹çš„è°ƒç”¨ä¹Ÿä¼šç›¸äº’å½±å“
  new Thread(() -> StaticCounter.increment()).start();
  new Thread(() -> StaticCounter.increment()).start();
  ```
  </TabItem>
  <TabItem value="synchronized_block" label="ä»£ç å—åŒæ­¥">
  ```java
  public class BlockSynchronization {
      private int count = 0;
      private final Object lock = new Object(); // æ˜¾å¼é”å¯¹è±¡
      
      public void increment() {
          // åªåŒæ­¥å…³é”®ä»£ç å—ï¼Œä½¿ç”¨è‡ªå®šä¹‰é”å¯¹è±¡
          synchronized (lock) {
              count++;
          }
          
          // è¿™é‡Œæ˜¯éåŒæ­¥ä»£ç 
          System.out.println("Current count: " + count);
      }
      
      public void otherMethod() {
          // ä½¿ç”¨thisä½œä¸ºé”å¯¹è±¡
          synchronized (this) {
              // è¿™é‡Œçš„åŒæ­¥ä¸synchronizedå®ä¾‹æ–¹æ³•æ•ˆæœç›¸åŒ
              System.out.println("Using this as lock");
          }
          
          // ä½¿ç”¨ç±»å¯¹è±¡ä½œä¸ºé”
          synchronized (BlockSynchronization.class) {
              // è¿™é‡Œçš„åŒæ­¥ä¸synchronizedé™æ€æ–¹æ³•æ•ˆæœç›¸åŒ
              System.out.println("Using class object as lock");
          }
      }
      
      // ç‰¹å®šå¯¹è±¡é”çš„ä¼˜ç‚¹
      // 1. æ›´ç»†ç²’åº¦çš„é”æ§åˆ¶
      // 2. é¿å…é”å®šæ•´ä¸ªå¯¹è±¡
      // 3. å¯ä»¥ä½¿ç”¨å¤šä¸ªä¸åŒçš„é”å¯¹è±¡æ§åˆ¶ä¸åŒçš„èµ„æº
      
      private final Object resourceALock = new Object();
      private final Object resourceBLock = new Object();
      
      public void updateResourceA() {
          synchronized (resourceALock) {
              // æ›´æ–°èµ„æºA
          }
      }
      
      public void updateResourceB() {
          synchronized (resourceBLock) {
              // æ›´æ–°èµ„æºB
          }
      }
      // èµ„æºAå’ŒBå¯ä»¥å¹¶å‘è®¿é—®ï¼Œäº’ä¸å½±å“
  }
  ```
  </TabItem>
  <TabItem value="double_check" label="åŒé‡æ£€æŸ¥é”å®š">
  ```java
  public class Singleton {
      // volatileç¡®ä¿å¤šçº¿ç¨‹å¯è§æ€§å’Œé˜²æ­¢æŒ‡ä»¤é‡æ’åº
      private volatile static Singleton instance;
      
      private Singleton() {}
      
      public static Singleton getInstance() {
          // ç¬¬ä¸€æ¬¡æ£€æŸ¥ - ä¸éœ€è¦åŒæ­¥
          if (instance == null) {
              // åŒæ­¥å— - åªæœ‰éœ€è¦åˆ›å»ºå®ä¾‹æ—¶æ‰åŒæ­¥
              synchronized (Singleton.class) {
                  // ç¬¬äºŒæ¬¡æ£€æŸ¥ - é˜²æ­¢å¤šä¸ªçº¿ç¨‹éƒ½é€šè¿‡äº†ç¬¬ä¸€æ¬¡æ£€æŸ¥
                  if (instance == null) {
                      instance = new Singleton();
                  }
              }
          }
          return instance;
      }
      
      /* 
       * ä¸ºä»€ä¹ˆéœ€è¦volatile?
       * é˜²æ­¢æŒ‡ä»¤é‡æ’åºå¯¼è‡´çš„éƒ¨åˆ†åˆå§‹åŒ–å¯¹è±¡é—®é¢˜:
       * 1. åˆ†é…å†…å­˜ç©ºé—´
       * 2. åˆå§‹åŒ–å¯¹è±¡
       * 3. å°†å¼•ç”¨æŒ‡å‘å†…å­˜ç©ºé—´
       * 
       * å¦‚æœå‘ç”Ÿ2å’Œ3çš„é‡æ’åºï¼Œå…¶ä»–çº¿ç¨‹å¯èƒ½ä¼šçœ‹åˆ°ä¸€ä¸ªæœªå®Œå…¨åˆå§‹åŒ–çš„å¯¹è±¡
       */
  }
  ```
  </TabItem>
</Tabs>

### 2.2 synchronized çš„ç‰¹æ€§

```mermaid
stateDiagram-v2
    [*] --> è·å–é”
    è·å–é” --> æ‰§è¡ŒåŒæ­¥ä»£ç 
    æ‰§è¡ŒåŒæ­¥ä»£ç  --> é‡Šæ”¾é”: æ­£å¸¸æ‰§è¡Œå®Œæˆ
    æ‰§è¡ŒåŒæ­¥ä»£ç  --> é‡Šæ”¾é”: æŠ›å‡ºå¼‚å¸¸
    é‡Šæ”¾é” --> [*]
    
    note right of è·å–é”: åŒä¸€çº¿ç¨‹å¯é‡å…¥
    note left of é‡Šæ”¾é”: è‡ªåŠ¨é‡Šæ”¾ï¼Œä¸éœ€è¦æ˜¾å¼å¤„ç†
```

<Tabs>
  <TabItem value="reentrant" label="å¯é‡å…¥æ€§" default>
  <div className="card">
  <div className="card__body">
  
  **å¯é‡å…¥æ€§ï¼ˆReentrancyï¼‰æ˜¯æŒ‡åŒä¸€ä¸ªçº¿ç¨‹å¯ä»¥å¤šæ¬¡è·å–åŒä¸€æŠŠé”ã€‚**

  ```java
  public class ReentrantExample {
      // å¯é‡å…¥æ€§ç¤ºä¾‹
      public synchronized void outer() {
          System.out.println("Entering outer method");
          // åŒä¸€çº¿ç¨‹å¯ä»¥å†æ¬¡è·å–ç›¸åŒçš„é”
          inner();
          System.out.println("Exiting outer method");
      }
      
      public synchronized void inner() {
          System.out.println("Executing inner method");
      }
  }
  
  // æ‰§è¡Œç»“æœ:
  // Entering outer method
  // Executing inner method  <-- å¯ä»¥é‡å…¥è·å–é”
  // Exiting outer method
  ```
  
  </div>
  </div>
  </TabItem>
  <TabItem value="auto_release" label="è‡ªåŠ¨é‡Šæ”¾">
  <div className="card">
  <div className="card__body">
  
  **synchronized ä¼šåœ¨ä»¥ä¸‹æƒ…å†µè‡ªåŠ¨é‡Šæ”¾é”:**
  
  1. åŒæ­¥ä»£ç å—æ‰§è¡Œå®Œæˆ
  2. åŒæ­¥æ–¹æ³•è¿”å›
  3. åŒæ­¥ä»£ç å—/æ–¹æ³•ä¸­æŠ›å‡ºæœªæ•è·çš„å¼‚å¸¸
  
  ```java
  public synchronized void safeMethod() {
      try {
          // å¯èƒ½æŠ›å‡ºå¼‚å¸¸çš„ä»£ç 
          if (Math.random() < 0.5) {
              throw new RuntimeException("ç¤ºä¾‹å¼‚å¸¸");
          }
          System.out.println("æ“ä½œæˆåŠŸ");
      } catch (Exception e) {
          System.out.println("æ•è·åˆ°å¼‚å¸¸: " + e.getMessage());
          // å³ä½¿æŠ›å‡ºå¼‚å¸¸ï¼Œé”ä¹Ÿä¼šè¢«æ­£ç¡®é‡Šæ”¾
      }
      // æ— éœ€æ‰‹åŠ¨é‡Šæ”¾é”
  }
  ```
  
  </div>
  </div>
  </TabItem>
  <TabItem value="memory" label="å†…å­˜å¯è§æ€§">
  <div className="card">
  <div className="card__body">
  
  **synchronized ä¿è¯äº†å†…å­˜å¯è§æ€§ï¼Œç¡®ä¿ä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡çš„ä¿®æ”¹å¯¹å…¶ä»–çº¿ç¨‹å¯è§ã€‚**
  
  ```java
  public class MemoryVisibility {
      private int counter = 0;
      private boolean flag = false;
      
      public synchronized void write() {
          counter = 42;
          flag = true;
          // é€€å‡ºåŒæ­¥å—æ—¶ï¼Œä¿®æ”¹ä¼šåˆ·æ–°åˆ°ä¸»å†…å­˜
      }
      
      public synchronized void read() {
          // è¿›å…¥åŒæ­¥å—æ—¶ï¼Œä¼šä»ä¸»å†…å­˜è¯»å–æœ€æ–°å€¼
          if (flag) {
              // ä¸€å®šèƒ½çœ‹åˆ°counterçš„æœ€æ–°å€¼(42)
              System.out.println("Counter: " + counter);
          }
      }
  }
  ```
  
  **å·¥ä½œåŸç†:**
  - è·å–é”æ—¶ï¼Œæ¸…ç©ºå·¥ä½œå†…å­˜ä¸­çš„å…±äº«å˜é‡ï¼Œä»ä¸»å†…å­˜é‡æ–°åŠ è½½
  - é‡Šæ”¾é”æ—¶ï¼Œå°†å·¥ä½œå†…å­˜ä¸­çš„ä¿®æ”¹åˆ·æ–°åˆ°ä¸»å†…å­˜
  
  </div>
  </div>
  </TabItem>
  <TabItem value="atomicity" label="åŸå­æ€§">
  <div className="card">
  <div className="card__body">
  
  **synchronized ç¡®ä¿äº†å¤šä¸ªæ“ä½œä½œä¸ºä¸€ä¸ªåŸå­å•å…ƒæ‰§è¡Œï¼Œä¸ä¼šè¢«å…¶ä»–çº¿ç¨‹ä¸­æ–­ã€‚**
  
  ```java
  public class AtomicityExample {
      private int counter = 0;
      private int total = 0;
      
      // éåŸå­æ“ä½œå˜æˆäº†åŸå­æ“ä½œ
      public synchronized void increment() {
          // counter++ å®é™…ä¸Šæ˜¯ä¸‰ä¸ªæ“ä½œ:
          // 1. è¯»å–counterçš„å€¼
          // 2. åŠ 1
          // 3. å°†ç»“æœå†™å›counter
          counter++;
          total += counter;
          
          // æ•´ä¸ªæ–¹æ³•ä½œä¸ºä¸€ä¸ªåŸå­å•å…ƒï¼Œå…¶ä»–çº¿ç¨‹æ— æ³•åœ¨ä¸­é—´è§‚å¯Ÿåˆ°éƒ¨åˆ†æ›´æ–°çš„çŠ¶æ€
      }
      
      public synchronized int[] getValues() {
          // åŸå­åœ°è¿”å›å½“å‰çŠ¶æ€çš„å¿«ç…§
          return new int[] { counter, total };
      }
  }
  ```
  
  </div>
  </div>
  </TabItem>
</Tabs>

### 2.3 synchronized çš„å±€é™æ€§

<div className="card">
<div className="card__header">
<h4>synchronized å±€é™æ€§æ¦‚è§ˆ</h4>
</div>
<div className="card__body">

| å±€é™æ€§ | æè¿° | è§£å†³æ–¹æ¡ˆ |
|--------|------|----------|
| **æ— æ³•ä¸­æ–­ç­‰å¾…** | çº¿ç¨‹ç­‰å¾…é”æ—¶æ— æ³•å“åº”ä¸­æ–­ | ä½¿ç”¨ ReentrantLock.lockInterruptibly() |
| **æ— æ³•è®¾ç½®è¶…æ—¶** | æ— æ³•è®¾ç½®è·å–é”çš„è¶…æ—¶æ—¶é—´ | ä½¿ç”¨ ReentrantLock.tryLock(time, unit) |
| **æ— æ³•å®ç°å…¬å¹³æ€§** | æ— æ³•ä¿è¯FIFOé¡ºåº | ä½¿ç”¨ ReentrantLock(true) åˆ›å»ºå…¬å¹³é” |
| **æ— æ³•å®ç°è¯»å†™åˆ†ç¦»** | æ— æ³•è®©å¤šä¸ªè¯»çº¿ç¨‹å¹¶è¡Œè®¿é—® | ä½¿ç”¨ ReadWriteLock è¯»å†™é” |
| **æ— æ³•çŸ¥é“é”çŠ¶æ€** | æ— æ³•æŸ¥è¯¢é”æ˜¯å¦è¢«å ç”¨ | ä½¿ç”¨ Lock æ¥å£çš„ç›¸å…³æ–¹æ³• |

</div>
</div>

<Tabs>
  <TabItem value="non_interruptible" label="æ— æ³•ä¸­æ–­ç­‰å¾…" default>
  ```java
  import java.util.concurrent.locks.Lock;
  import java.util.concurrent.locks.ReentrantLock;
  
  public class InterruptionExample {
      private final Object syncLock = new Object();
      private final Lock interruptibleLock = new ReentrantLock();
      
      public void synchronizedMethod() {
          // synchronized ä¸å“åº”ä¸­æ–­
          synchronized (syncLock) {
              try {
                  System.out.println("è·å–synchronizedé”");
                  Thread.sleep(10000); // æŒæœ‰é”10ç§’
              } catch (InterruptedException e) {
                  System.out.println("å³ä½¿çº¿ç¨‹è¢«ä¸­æ–­ï¼Œsynchronizedä¹Ÿä¼šç»§ç»­æ‰§è¡Œåˆ°å®Œæˆ");
                  Thread.currentThread().interrupt();
              }
          }
      }
      
      public void interruptibleMethod() {
          try {
              // ReentrantLock å¯ä»¥å“åº”ä¸­æ–­
              interruptibleLock.lockInterruptibly();
              try {
                  System.out.println("è·å–å¯ä¸­æ–­é”");
                  Thread.sleep(10000); // å°è¯•æŒæœ‰é”10ç§’
              } finally {
                  interruptibleLock.unlock();
              }
          } catch (InterruptedException e) {
              System.out.println("é”ç­‰å¾…è¢«ä¸­æ–­ï¼Œå¯ä»¥æ‰§è¡Œå…¶ä»–æ“ä½œ");
          }
      }
      
      public static void main(String[] args) throws InterruptedException {
          InterruptionExample example = new InterruptionExample();
          
          // å…ˆå ç”¨é”
          Thread blocker = new Thread(() -> {
              example.synchronizedMethod();
          });
          blocker.start();
          Thread.sleep(100); // ç¡®ä¿blockerè·å¾—é”
          
          // å°è¯•è·å–é”å¹¶ä¸­æ–­
          Thread waiter = new Thread(() -> {
              try {
                  System.out.println("ç­‰å¾…é”...");
                  example.synchronizedMethod(); // è¿™é‡Œä¼šè¢«é˜»å¡
              } finally {
                  System.out.println("waiterçº¿ç¨‹ç»“æŸ");
              }
          });
          
          waiter.start();
          Thread.sleep(1000); // è®©waiterç­‰å¾…ä¸€æ®µæ—¶é—´
          
          System.out.println("å°è¯•ä¸­æ–­waiterçº¿ç¨‹");
          waiter.interrupt(); // ä¸­æ–­waiterçº¿ç¨‹
          
          // æ³¨æ„: waiterçº¿ç¨‹ä¼šä¸€ç›´ç­‰å¾…ï¼Œç›´åˆ°blockeré‡Šæ”¾é”
          // synchronizedä¸å“åº”ä¸­æ–­
      }
  }
  ```
  </TabItem>
  <TabItem value="no_timeout" label="æ— æ³•è®¾ç½®è¶…æ—¶">
  ```java
  import java.util.concurrent.TimeUnit;
  import java.util.concurrent.locks.Lock;
  import java.util.concurrent.locks.ReentrantLock;
  
  public class TimeoutExample {
      private final Object syncLock = new Object();
      private final Lock timeoutLock = new ReentrantLock();
      
      public void synchronizedMethod() {
          // synchronized æ— æ³•è®¾ç½®è¶…æ—¶
          synchronized (syncLock) {
              System.out.println("è·å–synchronizedé”");
              sleep(5000); // æŒæœ‰é”5ç§’
          }
      }
      
      public boolean timeoutMethod(long timeout) {
          try {
              // ReentrantLock æ”¯æŒè¶…æ—¶è·å–é”
              if (timeoutLock.tryLock(timeout, TimeUnit.MILLISECONDS)) {
                  try {
                      System.out.println("åœ¨è¶…æ—¶æ—¶é—´å†…è·å–åˆ°é”");
                      return true;
                  } finally {
                      timeoutLock.unlock();
                  }
              } else {
                  System.out.println("è·å–é”è¶…æ—¶");
                  return false;
              }
          } catch (InterruptedException e) {
              System.out.println("ç­‰å¾…é”æ—¶è¢«ä¸­æ–­");
              return false;
          }
      }
      
      private void sleep(long millis) {
          try {
              Thread.sleep(millis);
          } catch (InterruptedException e) {
              Thread.currentThread().interrupt();
          }
      }
  }
  ```
  </TabItem>
  <TabItem value="no_fairness" label="æ— æ³•å®ç°å…¬å¹³æ€§">
  ```java
  import java.util.concurrent.locks.Lock;
  import java.util.concurrent.locks.ReentrantLock;
  
  public class FairnessExample {
      // synchronized æ— æ³•è®¾ç½®å…¬å¹³æ€§
      private final Object syncLock = new Object();
      
      // ReentrantLock å¯ä»¥åˆ›å»ºå…¬å¹³é”
      private final Lock fairLock = new ReentrantLock(true);
      private final Lock unfairLock = new ReentrantLock(false);
      
      public void testFairness() {
          // åˆ›å»ºå¤šä¸ªçº¿ç¨‹ç«äº‰é”
          for (int i = 0; i < 5; i++) {
              final int threadId = i;
              new Thread(() -> {
                  for (int j = 0; j < 3; j++) {
                      // ä½¿ç”¨å…¬å¹³é”
                      fairLock.lock();
                      try {
                          System.out.println("çº¿ç¨‹ " + threadId + 
                              " è·å–å…¬å¹³é”ï¼Œå°è¯•æ¬¡æ•° " + j);
                          sleep(100);
                      } finally {
                          fairLock.unlock();
                      }
                  }
              }).start();
          }
      }
      
      // å…¬å¹³é”ä¸éå…¬å¹³é”çš„åŒºåˆ«:
      // 1. å…¬å¹³é”: æŒ‰ç…§FIFOé¡ºåºè·å–é”ï¼Œç­‰å¾…æ—¶é—´æœ€é•¿çš„çº¿ç¨‹ä¼˜å…ˆè·å–
      // 2. éå…¬å¹³é”: å…è®¸"æ’é˜Ÿ"ï¼Œæ–°åˆ°è¾¾çš„çº¿ç¨‹å¯èƒ½æ¯”ç­‰å¾…ä¸­çš„çº¿ç¨‹å…ˆè·å–é”
      // 3. synchronized é»˜è®¤æ˜¯éå…¬å¹³çš„ï¼Œä¸”æ— æ³•é…ç½®ä¸ºå…¬å¹³æ¨¡å¼
      
      private void sleep(long millis) {
          try {
              Thread.sleep(millis);
          } catch (InterruptedException e) {
              Thread.currentThread().interrupt();
          }
      }
  }
  ```
  </TabItem>
</Tabs>

## 3. Lock æ¥å£

### 3.1 Lock æ¥å£åŸºæœ¬ç”¨æ³•

```mermaid
classDiagram
    class Lock {
        <<interface>>
        +lock() void
        +lockInterruptibly() void
        +tryLock() boolean
        +tryLock(long, TimeUnit) boolean
        +unlock() void
        +newCondition() Condition
    }
    
    class ReentrantLock {
        -sync AbstractQueuedSynchronizer
        +ReentrantLock()
        +ReentrantLock(boolean fair)
        +isHeldByCurrentThread() boolean
        +getHoldCount() int
        +isLocked() boolean
        +isFair() boolean
        +hasQueuedThreads() boolean
        +getQueueLength() int
    }
    
    Lock <|-- ReentrantLock
```

<Tabs>
  <TabItem value="basic_lock" label="åŸºæœ¬ç”¨æ³•" default>
  ```java
  import java.util.concurrent.locks.Lock;
  import java.util.concurrent.locks.ReentrantLock;
  
  public class LockBasicExample {
      private final Lock lock = new ReentrantLock();
      private int counter = 0;
      
      public void increment() {
          // è·å–é”
          lock.lock();
          try {
              // ä¸´ç•ŒåŒº - å—é”ä¿æŠ¤çš„ä»£ç 
              counter++;
          } finally {
              // å¿…é¡»åœ¨finallyå—ä¸­é‡Šæ”¾é”
              lock.unlock();
          }
      }
      
      public int getCount() {
          lock.lock();
          try {
              return counter;
          } finally {
              lock.unlock();
          }
      }
      
      public static void main(String[] args) {
          LockBasicExample example = new LockBasicExample();
          
          // åˆ›å»ºå¤šä¸ªçº¿ç¨‹å¹¶å‘å¢åŠ è®¡æ•°å™¨
          for (int i = 0; i < 10; i++) {
              new Thread(() -> {
                  for (int j = 0; j < 1000; j++) {
                      example.increment();
                  }
              }).start();
          }
          
          // ç­‰å¾…ä¸€æ®µæ—¶é—´åæŸ¥çœ‹ç»“æœ
          try {
              Thread.sleep(1000);
          } catch (InterruptedException e) {
              Thread.currentThread().interrupt();
          }
          
          System.out.println("è®¡æ•°å™¨æœ€ç»ˆå€¼: " + example.getCount());
      }
  }
  ```
  </TabItem>
  <TabItem value="interruptible_lock" label="å¯ä¸­æ–­é”">
  ```java
  import java.util.concurrent.locks.Lock;
  import java.util.concurrent.locks.ReentrantLock;
  
  public class InterruptibleLockExample {
      private final Lock lock = new ReentrantLock();
      
      public void methodWithInterruptibleLock() {
          System.out.println(Thread.currentThread().getName() + " å°è¯•è·å–é”");
          
          try {
              // å¯ä¸­æ–­çš„è·å–é”ï¼Œå…è®¸å“åº”ä¸­æ–­
              lock.lockInterruptibly();
              try {
                  System.out.println(Thread.currentThread().getName() + " è·å–åˆ°é”");
                  // æ¨¡æ‹Ÿé•¿æ—¶é—´æ“ä½œ
                  Thread.sleep(5000);
              } finally {
                  lock.unlock();
                  System.out.println(Thread.currentThread().getName() + " é‡Šæ”¾äº†é”");
              }
          } catch (InterruptedException e) {
              System.out.println(Thread.currentThread().getName() + " åœ¨ç­‰å¾…é”çš„è¿‡ç¨‹ä¸­è¢«ä¸­æ–­");
          }
      }
      
      public static void main(String[] args) throws InterruptedException {
          InterruptibleLockExample example = new InterruptibleLockExample();
          
          // çº¿ç¨‹1å…ˆè·å–é”
          Thread t1 = new Thread(example::methodWithInterruptibleLock, "Thread-1");
          t1.start();
          Thread.sleep(100); // ç¡®ä¿çº¿ç¨‹1è·å–åˆ°é”
          
          // çº¿ç¨‹2å°è¯•è·å–å·²ç»è¢«å ç”¨çš„é”
          Thread t2 = new Thread(example::methodWithInterruptibleLock, "Thread-2");
          t2.start();
          Thread.sleep(1000); // è®©çº¿ç¨‹2ç­‰å¾…ä¸€æ®µæ—¶é—´
          
          // ä¸­æ–­çº¿ç¨‹2
          System.out.println("ä¸»çº¿ç¨‹ä¸­æ–­ Thread-2");
          t2.interrupt();
      }
  }
  ```
  </TabItem>
  <TabItem value="timeout_lock" label="è¶…æ—¶é”">
  ```java
  import java.util.concurrent.TimeUnit;
  import java.util.concurrent.locks.Lock;
  import java.util.concurrent.locks.ReentrantLock;
  
  public class TimeoutLockExample {
      private final Lock lock = new ReentrantLock();
      
      public void methodWithTimeout(long timeout, TimeUnit unit) {
          System.out.println(Thread.currentThread().getName() + 
              " å°è¯•è·å–é”ï¼Œè¶…æ—¶æ—¶é—´: " + timeout + " " + unit);
          
          try {
              // å°è¯•åœ¨æŒ‡å®šæ—¶é—´å†…è·å–é”
              boolean acquired = lock.tryLock(timeout, unit);
              if (acquired) {
                  try {
                      System.out.println(Thread.currentThread().getName() + " è·å–åˆ°é”");
                      // æ¨¡æ‹Ÿæ“ä½œ
                      Thread.sleep(unit.toMillis(timeout / 2));
                  } finally {
                      lock.unlock();
                      System.out.println(Thread.currentThread().getName() + " é‡Šæ”¾äº†é”");
                  }
              } else {
                  System.out.println(Thread.currentThread().getName() + " è·å–é”è¶…æ—¶");
                  // æ‰§è¡Œæ›¿ä»£é€»è¾‘
                  performAlternativeAction();
              }
          } catch (InterruptedException e) {
              System.out.println(Thread.currentThread().getName() + " è¢«ä¸­æ–­");
          }
      }
      
      private void performAlternativeAction() {
          System.out.println(Thread.currentThread().getName() + " æ‰§è¡Œæ›¿ä»£æ“ä½œ");
      }
      
      public static void main(String[] args) throws InterruptedException {
          TimeoutLockExample example = new TimeoutLockExample();
          
          // çº¿ç¨‹1è·å–é”å¹¶é•¿æ—¶é—´æŒæœ‰
          Thread t1 = new Thread(() -> {
              example.methodWithTimeout(10, TimeUnit.SECONDS);
          }, "Thread-1");
          
          // çº¿ç¨‹2å°è¯•è·å–é”ï¼Œä½†è®¾ç½®è¾ƒçŸ­çš„è¶…æ—¶æ—¶é—´
          Thread t2 = new Thread(() -> {
              example.methodWithTimeout(2, TimeUnit.SECONDS);
          }, "Thread-2");
          
          t1.start();
          Thread.sleep(100); // ç¡®ä¿çº¿ç¨‹1è·å–åˆ°é”
          t2.start(); // çº¿ç¨‹2å°è¯•è·å–é”ä½†ä¼šè¶…æ—¶
      }
  }
  ```
  </TabItem>
  <TabItem value="fair_lock" label="å…¬å¹³é”">
  ```java
  import java.util.concurrent.locks.Lock;
  import java.util.concurrent.locks.ReentrantLock;
  
  public class FairLockExample {
      // åˆ›å»ºå…¬å¹³é” - æŒ‰ç…§FIFOé¡ºåºè·å–
      private final Lock fairLock = new ReentrantLock(true);
      
      // åˆ›å»ºéå…¬å¹³é”(é»˜è®¤) - ä¸ä¿è¯è·å–é¡ºåº
      private final Lock unfairLock = new ReentrantLock(false);
      
      public void useFairLock(int id) {
          fairLock.lock();
          try {
              System.out.println("çº¿ç¨‹ " + id + " è·å–åˆ°å…¬å¹³é”");
              // çŸ­æš‚æŒæœ‰é”
              Thread.sleep(100);
          } catch (InterruptedException e) {
              Thread.currentThread().interrupt();
          } finally {
              fairLock.unlock();
          }
      }
      
      public void useUnfairLock(int id) {
          unfairLock.lock();
          try {
              System.out.println("çº¿ç¨‹ " + id + " è·å–åˆ°éå…¬å¹³é”");
              // çŸ­æš‚æŒæœ‰é”
              Thread.sleep(100);
          } catch (InterruptedException e) {
              Thread.currentThread().interrupt();
          } finally {
              unfairLock.unlock();
          }
      }
      
      // å…¬å¹³é”ç‰¹ç‚¹:
      // 1. æŒ‰ç…§è¯·æ±‚é”çš„é¡ºåºè·å¾—é”(FIFO)
      // 2. ç­‰å¾…æ—¶é—´é•¿çš„çº¿ç¨‹ä¼˜å…ˆè·å¾—é”
      // 3. æ€§èƒ½æ¯”éå…¬å¹³é”ç•¥ä½ï¼Œä½†é¿å…äº†"é¥¥é¥¿"é—®é¢˜
  }
  ```
  </TabItem>
</Tabs>

### 3.2 ReentrantLock é«˜çº§ç‰¹æ€§

```mermaid
classDiagram
    class ReentrantLock {
        -sync AbstractQueuedSynchronizer
        +ReentrantLock()
        +ReentrantLock(boolean fair)
        +isHeldByCurrentThread() boolean
        +getHoldCount() int
        +isLocked() boolean
        +isFair() boolean
        +hasQueuedThreads() boolean
        +getQueueLength() int
    }
    
    class Condition {
        <<interface>>
        +await() void
        +signal() void
        +signalAll() void
    }
    
    ReentrantLock --> Condition
```

<Tabs>
  <TabItem value="lock_info" label="è·å–é”ä¿¡æ¯">
  ```java
  import java.util.concurrent.locks.Lock;
  import java.util.concurrent.locks.ReentrantLock;
  
  public class LockInfoExample {
      private final ReentrantLock lock = new ReentrantLock();
      
      public void methodWithInfo() {
          lock.lock();
          try {
              System.out.println("å½“å‰çº¿ç¨‹: " + Thread.currentThread().getName());
              System.out.println("æŒæœ‰é”çš„çº¿ç¨‹: " + lock.getOwner());
              System.out.println("ç­‰å¾…é˜Ÿåˆ—é•¿åº¦: " + lock.getQueueLength());
              System.out.println("æ˜¯å¦æœ‰çº¿ç¨‹ç­‰å¾…: " + lock.hasQueuedThreads());
              System.out.println("å½“å‰çº¿ç¨‹æ˜¯å¦åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­: " + lock.hasQueuedThread(Thread.currentThread()));
          } finally {
              lock.unlock();
          }
      }
  }
  ```
  </TabItem>
  <TabItem value="condition" label="æ¡ä»¶å˜é‡">
  ```java
  import java.util.concurrent.locks.Lock;
  import java.util.concurrent.locks.ReentrantLock;
  import java.util.concurrent.locks.Condition;
  
  public class ConditionExample {
      private final ReentrantLock lock = new ReentrantLock();
      private final Condition condition = lock.newCondition();
      private boolean flag = false;
      
      public void await() {
          lock.lock();
          try {
              while (!flag) {
                  System.out.println("ç­‰å¾…æ¡ä»¶æ»¡è¶³");
                  condition.await(); // ç­‰å¾…æ¡ä»¶
              }
              System.out.println("æ¡ä»¶æ»¡è¶³ï¼Œç»§ç»­æ‰§è¡Œ");
          } catch (InterruptedException e) {
              Thread.currentThread().interrupt();
          } finally {
              lock.unlock();
          }
      }
      
      public void signal() {
          lock.lock();
          try {
              flag = true;
              System.out.println("è®¾ç½®æ¡ä»¶å¹¶é€šçŸ¥");
              condition.signal(); // é€šçŸ¥ç­‰å¾…çš„çº¿ç¨‹
          } finally {
              lock.unlock();
          }
      }
      
      public void signalAll() {
          lock.lock();
          try {
              flag = true;
              System.out.println("è®¾ç½®æ¡ä»¶å¹¶é€šçŸ¥æ‰€æœ‰ç­‰å¾…çº¿ç¨‹");
              condition.signalAll(); // é€šçŸ¥æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹
          } finally {
              lock.unlock();
          }
      }
  }
  ```
  </TabItem>
  <TabItem value="multiple_conditions" label="å¤šä¸ªæ¡ä»¶å˜é‡">
  ```java
  import java.util.concurrent.locks.Lock;
  import java.util.concurrent.locks.ReentrantLock;
  import java.util.concurrent.locks.Condition;
  import java.util.Queue;
  import java.util.LinkedList;
  
  public class MultipleConditionExample {
      private final ReentrantLock lock = new ReentrantLock();
      private final Condition notEmpty = lock.newCondition();
      private final Condition notFull = lock.newCondition();
      private final int capacity = 10;
      private int count = 0;
      private final Queue<String> queue = new LinkedList<>();
      
      public void put(String item) {
          lock.lock();
          try {
              while (queue.size() >= capacity) {
                  System.out.println("é˜Ÿåˆ—å·²æ»¡ï¼Œç­‰å¾…æ¶ˆè´¹");
                  notFull.await();
              }
              queue.offer(item);
              System.out.println("ç”Ÿäº§ä¸€ä¸ªå…ƒç´ ï¼Œå½“å‰æ•°é‡: " + count);
              notEmpty.signal(); // é€šçŸ¥æ¶ˆè´¹è€…
          } catch (InterruptedException e) {
              Thread.currentThread().interrupt();
          } finally {
              lock.unlock();
          }
      }
      
      public void take() {
          lock.lock();
          try {
              while (queue.isEmpty()) {
                  System.out.println("é˜Ÿåˆ—ä¸ºç©ºï¼Œç­‰å¾…ç”Ÿäº§");
                  notEmpty.await(); // ç­‰å¾…è€Œä¸æ˜¯å¿™ç­‰å¾…
              }
              String item = queue.poll();
              System.out.println("æ¶ˆè´¹ä¸€ä¸ªå…ƒç´ ï¼Œå½“å‰æ•°é‡: " + count);
              notFull.signal(); // é€šçŸ¥ç”Ÿäº§è€…
          } catch (InterruptedException e) {
              Thread.currentThread().interrupt();
          } finally {
              lock.unlock();
          }
      }
  }
  ```
  </TabItem>
</Tabs>

## 4. è¯»å†™é” (ReadWriteLock)

### 4.1 è¯»å†™é”åŸºæœ¬ç”¨æ³•

```mermaid
classDiagram
    class ReadWriteLock {
        <<interface>>
        +readLock() Lock
        +writeLock() Lock
    }
    
    class ReentrantReadWriteLock {
        -sync AbstractQueuedSynchronizer
        -readerLock ReadLock
        -writerLock WriteLock
        +ReentrantReadWriteLock()
        +ReentrantReadWriteLock(boolean fair)
        +getReadLockCount() int
        +isWriteLocked() boolean
        +getWriteHoldCount() int
        +getReadHoldCount() int
    }
    
    ReadWriteLock <|-- ReentrantReadWriteLock
```

<div className="card">
<div className="card__header">
<h4>è¯»å†™é”åŸç†ä¸ç‰¹æ€§</h4>
</div>
<div className="card__body">

**è¯»å†™é”å…è®¸å¹¶å‘è¯»å–ä½†äº’æ–¥å†™å…¥ï¼Œé€‚åˆè¯»å¤šå†™å°‘åœºæ™¯ï¼š**

1. **è¯»é”å…±äº«**ï¼šå¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶æŒæœ‰è¯»é”
2. **å†™é”ç‹¬å **ï¼šå†™é”æ˜¯æ’ä»–çš„ï¼Œä¸€æ¬¡åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æŒæœ‰
3. **è¯»å†™äº’æ–¥**ï¼šæŒæœ‰å†™é”æ—¶ï¼Œå…¶ä»–çº¿ç¨‹æ— æ³•è·å–è¯»é”ï¼›æŒæœ‰è¯»é”æ—¶ï¼Œå…¶ä»–çº¿ç¨‹æ— æ³•è·å–å†™é”
4. **å†™é”ä¼˜å…ˆçº§**ï¼šåœ¨ä¸€äº›å®ç°ä¸­ï¼Œå†™é”ä¼˜å…ˆçº§é«˜äºè¯»é”ï¼Œé˜²æ­¢å†™å…¥çº¿ç¨‹"é¥¥é¥¿"

**ReentrantReadWriteLockå…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š**
- å¯é‡å…¥æ€§
- å¯é€‰æ‹©å…¬å¹³/éå…¬å¹³é”
- é”é™çº§ï¼ˆå†™é”â†’è¯»é”ï¼‰æ”¯æŒ
- é”å‡çº§ï¼ˆè¯»é”â†’å†™é”ï¼‰ä¸æ”¯æŒ

</div>
</div>

<Tabs>
  <TabItem value="basic_rwlock" label="åŸºæœ¬ç”¨æ³•" default>
  ```java
  import java.util.concurrent.locks.ReadWriteLock;
  import java.util.concurrent.locks.ReentrantReadWriteLock;
  import java.util.concurrent.locks.Lock;
  
  public class ReadWriteLockBasic {
      private final ReadWriteLock rwLock = new ReentrantReadWriteLock();
      private final Lock readLock = rwLock.readLock();
      private final Lock writeLock = rwLock.writeLock();
      
      private String data = "åˆå§‹æ•°æ®";
      
      // è¯»æ“ä½œ - å…è®¸å¹¶å‘è¯»å–
      public String read() {
          readLock.lock(); // è·å–è¯»é”
          try {
              System.out.println(Thread.currentThread().getName() + " è¯»å–æ•°æ®: " + data);
              // æ¨¡æ‹Ÿè¯»å–æ“ä½œè€—æ—¶
              Thread.sleep(100);
              return data;
          } catch (InterruptedException e) {
              Thread.currentThread().interrupt();
              return null;
          } finally {
              readLock.unlock(); // é‡Šæ”¾è¯»é”
          }
      }
      
      // å†™æ“ä½œ - ç‹¬å è®¿é—®
      public void write(String newData) {
          writeLock.lock(); // è·å–å†™é”
          try {
              System.out.println(Thread.currentThread().getName() + " å†™å…¥æ•°æ®: " + newData);
              // æ¨¡æ‹Ÿå†™å…¥æ“ä½œè€—æ—¶
              Thread.sleep(200);
              data = newData;
          } catch (InterruptedException e) {
              Thread.currentThread().interrupt();
          } finally {
              writeLock.unlock(); // é‡Šæ”¾å†™é”
          }
      }
      
      public static void main(String[] args) {
          final ReadWriteLockBasic example = new ReadWriteLockBasic();
          
          // åˆ›å»ºå¤šä¸ªè¯»çº¿ç¨‹
          for (int i = 0; i < 5; i++) {
              new Thread(example::read, "Reader-" + i).start();
          }
          
          // åˆ›å»ºå†™çº¿ç¨‹
          new Thread(() -> example.write("æ–°æ•°æ®"), "Writer-1").start();
          
          // å†åˆ›å»ºè¯»çº¿ç¨‹
          for (int i = 5; i < 10; i++) {
              new Thread(example::read, "Reader-" + i).start();
          }
      }
  }
  ```
  </TabItem>
  <TabItem value="cache_implementation" label="ç¼“å­˜å®ç°">
  ```java
  import java.util.HashMap;
  import java.util.Map;
  import java.util.concurrent.locks.ReadWriteLock;
  import java.util.concurrent.locks.ReentrantReadWriteLock;
  import java.util.concurrent.locks.Lock;
  
  /**
   * ä½¿ç”¨è¯»å†™é”å®ç°çº¿ç¨‹å®‰å…¨çš„ç¼“å­˜
   */
  public class ReadWriteLockCache<K, V> {
      private final Map<K, V> cache = new HashMap<>();
      private final ReadWriteLock rwLock = new ReentrantReadWriteLock();
      private final Lock readLock = rwLock.readLock();
      private final Lock writeLock = rwLock.writeLock();
      
      /**
       * è·å–ç¼“å­˜å€¼
       * å¦‚æœç¼“å­˜æœªå‘½ä¸­ï¼Œåˆ™åŠ è½½æ•°æ®
       */
      public V get(K key) {
          V value = null;
          
          // å…ˆå°è¯•ä»ç¼“å­˜ä¸­è¯»å–ï¼Œä½¿ç”¨è¯»é”
          readLock.lock();
          try {
              value = cache.get(key);
              if (value != null) {
                  System.out.println("ç¼“å­˜å‘½ä¸­: " + key + " = " + value);
                  return value;
              }
          } finally {
              readLock.unlock();
          }
          
          // ç¼“å­˜æœªå‘½ä¸­ï¼Œéœ€è¦åŠ è½½æ•°æ®å¹¶å†™å…¥ç¼“å­˜ï¼Œä½¿ç”¨å†™é”
          writeLock.lock();
          try {
              // åŒé‡æ£€æŸ¥ï¼Œé˜²æ­¢å…¶ä»–çº¿ç¨‹å·²ç»åŠ è½½
              value = cache.get(key);
              if (value == null) {
                  // ä»æ•°æ®æºåŠ è½½æ•°æ®
                  value = loadFromDataSource(key);
                  cache.put(key, value);
                  System.out.println("ç¼“å­˜å†™å…¥: " + key + " = " + value);
              }
              return value;
          } finally {
              writeLock.unlock();
          }
      }
      
      /**
       * ç›´æ¥æ›´æ–°ç¼“å­˜
       */
      public void put(K key, V value) {
          writeLock.lock();
          try {
              cache.put(key, value);
              System.out.println("ç¼“å­˜æ›´æ–°: " + key + " = " + value);
          } finally {
              writeLock.unlock();
          }
      }
      
      /**
       * åˆ é™¤ç¼“å­˜é¡¹
       */
      public V remove(K key) {
          writeLock.lock();
          try {
              V value = cache.remove(key);
              System.out.println("ç¼“å­˜ç§»é™¤: " + key);
              return value;
          } finally {
              writeLock.unlock();
          }
      }
      
      /**
       * æ¸…ç©ºç¼“å­˜
       */
      public void clear() {
          writeLock.lock();
          try {
              cache.clear();
              System.out.println("ç¼“å­˜å·²æ¸…ç©º");
          } finally {
              writeLock.unlock();
          }
      }
      
      /**
       * è·å–ç¼“å­˜å¤§å°
       */
      public int size() {
          readLock.lock();
          try {
              return cache.size();
          } finally {
              readLock.unlock();
          }
      }
      
      /**
       * æ¨¡æ‹Ÿä»æ•°æ®æºåŠ è½½æ•°æ®
       */
      @SuppressWarnings("unchecked")
      private V loadFromDataSource(K key) {
          System.out.println("ä»æ•°æ®æºåŠ è½½æ•°æ®: " + key);
          // æ¨¡æ‹Ÿæ•°æ®æºè®¿é—®å»¶è¿Ÿ
          try {
              Thread.sleep(200);
          } catch (InterruptedException e) {
              Thread.currentThread().interrupt();
          }
          // æ¨¡æ‹Ÿæ•°æ®ï¼Œå®é™…åº”ç”¨ä¸­åº”è¯¥æ˜¯çœŸå®æ•°æ®æº
          return (V) ("Data_" + key);
      }
  }
  ```
  </TabItem>
  <TabItem value="lock_downgrade" label="é”é™çº§">
  ```java
  import java.util.concurrent.locks.ReadWriteLock;
  import java.util.concurrent.locks.ReentrantReadWriteLock;
  import java.util.concurrent.locks.Lock;
  
  /**
   * é”é™çº§ç¤ºä¾‹ - ä»å†™é”é™çº§åˆ°è¯»é”
   */
  public class LockDowngradeExample {
      private final ReadWriteLock rwLock = new ReentrantReadWriteLock();
      private final Lock readLock = rwLock.readLock();
      private final Lock writeLock = rwLock.writeLock();
      
      private int data = 0;
      private boolean updated = false;
      
      /**
       * é”é™çº§ - æ­£ç¡®ç¤ºä¾‹
       * å†™é” -> è·å–è¯»é” -> é‡Šæ”¾å†™é” -> ä½¿ç”¨è¯»é”
       */
      public void processDataWithDowngrade() {
          // é¦–å…ˆè·å–å†™é”
          writeLock.lock();
          try {
              System.out.println("è·å–å†™é”ï¼Œå‡†å¤‡æ›´æ–°æ•°æ®");
              // æ›´æ–°æ•°æ®
              data = (int)(Math.random() * 100);
              updated = true;
              
              // åœ¨é‡Šæ”¾å†™é”ä¹‹å‰ï¼Œå…ˆè·å–è¯»é”
              // è¿™æ˜¯é”é™çº§çš„å…³é”®æ­¥éª¤
              readLock.lock();
              System.out.println("è·å–è¯»é”ï¼Œè¿›è¡Œé”é™çº§");
          } finally {
              // é‡Šæ”¾å†™é”ï¼Œä½†ä»æŒæœ‰è¯»é”
              writeLock.unlock();
              System.out.println("é‡Šæ”¾å†™é”ï¼Œå®Œæˆé”é™çº§");
          }
          
          // è¿™é‡ŒåªæŒæœ‰è¯»é”ï¼Œå…¶ä»–çº¿ç¨‹å¯ä»¥è·å–è¯»é”ï¼Œä½†ä¸èƒ½è·å–å†™é”
          try {
              // ä½¿ç”¨å·²æ›´æ–°çš„æ•°æ®
              if (updated) {
                  System.out.println("ä½¿ç”¨å·²æ›´æ–°çš„æ•°æ®: " + data);
              }
          } finally {
              // æœ€åé‡Šæ”¾è¯»é”
              readLock.unlock();
              System.out.println("é‡Šæ”¾è¯»é”");
          }
      }
      
      /**
       * ä¸ºä»€ä¹ˆéœ€è¦é”é™çº§ï¼Ÿ
       * 1. ä¿è¯æ•°æ®å¯è§æ€§ - å½“çº¿ç¨‹å®Œæˆå†™æ“ä½œåï¼Œå¯èƒ½éœ€è¦è¯»å–åˆšå†™å…¥çš„æ•°æ®
       * 2. é¿å…æ•°æ®ä¸ä¸€è‡´ - å¦‚æœç›´æ¥é‡Šæ”¾å†™é”ï¼Œå…¶ä»–çº¿ç¨‹å¯èƒ½ä¿®æ”¹æ•°æ®
       * 3. æé«˜å¹¶å‘æ€§èƒ½ - é”é™çº§å…è®¸å…¶ä»–è¯»çº¿ç¨‹è®¿é—®ï¼Œæé«˜å¹¶å‘æ€§
       */
      
      /**
       * é”å‡çº§æ˜¯ä¸å…è®¸çš„
       * è¯»é” -> å†™é” ä¼šå¯¼è‡´æ­»é”
       */
      public void attemptLockUpgrade() {
          readLock.lock();
          try {
              System.out.println("è·å–è¯»é”");
              
              // å°è¯•è·å–å†™é” - è¿™ä¼šå¯¼è‡´æ­»é”
              boolean acquired = false;
              try {
                  System.out.println("å°è¯•è·å–å†™é”ï¼ˆè¿™ä¼šå¯¼è‡´æ­»é”ï¼‰");
                  
                  // tryLock()å¯ä»¥é¿å…æ­»é”ï¼Œä½†ä¼šè·å–å¤±è´¥
                  acquired = writeLock.tryLock();
                  
                  if (acquired) {
                      try {
                          System.out.println("æˆåŠŸè·å–å†™é”ï¼ˆå®é™…ä¸Šè¿™è¡Œä»£ç ä¸ä¼šæ‰§è¡Œï¼‰");
                          data = 999;
                      } finally {
                          writeLock.unlock();
                      }
                  } else {
                      System.out.println("æ— æ³•è·å–å†™é”ï¼Œå› ä¸ºå·²ç»æŒæœ‰è¯»é”");
                  }
              } finally {
                  if (acquired) {
                      writeLock.unlock();
                  }
              }
          } finally {
              readLock.unlock();
              System.out.println("é‡Šæ”¾è¯»é”");
          }
      }
      
      public static void main(String[] args) {
          LockDowngradeExample example = new LockDowngradeExample();
          
          System.out.println("=== é”é™çº§ç¤ºä¾‹ ===");
          example.processDataWithDowngrade();
          
          System.out.println("\n=== å°è¯•é”å‡çº§ç¤ºä¾‹ ===");
          example.attemptLockUpgrade();
      }
  }
  ```
  </TabItem>
</Tabs>

### 4.2 è¯»å†™é”çš„æ€§èƒ½ç‰¹æ€§

```mermaid
graph TD
    A[è¯»å†™é”æ€§èƒ½ç‰¹ç‚¹] --> B[é«˜å¹¶å‘è¯»å–]
    A --> C[å†™æ“ä½œç‹¬å ]
    A --> D[è¯»å†™äº’æ–¥]
    A --> E[å¯èƒ½å†™é¥¥é¥¿]
    
    B --> B1[å¤šä¸ªè¯»çº¿ç¨‹å¯å¹¶å‘è®¿é—®]
    C --> C1[å†™çº¿ç¨‹ç‹¬å è®¿é—®]
    D --> D1[è¯»å†™ä¸èƒ½åŒæ—¶è¿›è¡Œ]
    E --> E1[å¤§é‡è¯»çº¿ç¨‹å¯èƒ½å¯¼è‡´å†™çº¿ç¨‹ä¸€ç›´ç­‰å¾…]
    
    style A fill:#f9f,stroke:#333,stroke-width:2px
    style B fill:#bbf,stroke:#333
    style C fill:#bbf,stroke:#333
    style D fill:#bbf,stroke:#333
    style E fill:#bbf,stroke:#333
```

<Tabs>
  <TabItem value="perf_test" label="æ€§èƒ½æµ‹è¯•" default>
  ```java
  import java.util.concurrent.ExecutorService;
  import java.util.concurrent.Executors;
  import java.util.concurrent.TimeUnit;
  import java.util.concurrent.atomic.AtomicInteger;
  import java.util.concurrent.locks.ReadWriteLock;
  import java.util.concurrent.locks.ReentrantReadWriteLock;
  import java.util.concurrent.locks.Lock;
  import java.util.concurrent.locks.ReentrantLock;
  
  /**
   * è¯»å†™é”ä¸ç‹¬å é”æ€§èƒ½å¯¹æ¯”æµ‹è¯•
   */
  public class ReadWriteLockPerformanceTest {
      // æµ‹è¯•æ•°æ®
      private int sharedData = 0;
      
      // è®¡æ•°å™¨
      private final AtomicInteger readCount = new AtomicInteger(0);
      private final AtomicInteger writeCount = new AtomicInteger(0);
      
      // è¯»å†™é”
      private final ReadWriteLock readWriteLock = new ReentrantReadWriteLock();
      private final Lock readLock = readWriteLock.readLock();
      private final Lock writeLock = readWriteLock.writeLock();
      
      // ç‹¬å é”
      private final Lock exclusiveLock = new ReentrantLock();
      
      /**
       * ä½¿ç”¨è¯»å†™é”è¯»å–æ•°æ®
       */
      public int readWithReadWriteLock() {
          readLock.lock();
          try {
              // æ¨¡æ‹Ÿè¯»å–æ“ä½œ
              Thread.sleep(1);
              readCount.incrementAndGet();
              return sharedData;
          } catch (InterruptedException e) {
              Thread.currentThread().interrupt();
              return 0;
          } finally {
              readLock.unlock();
          }
      }
      
      /**
       * ä½¿ç”¨è¯»å†™é”å†™å…¥æ•°æ®
       */
      public void writeWithReadWriteLock(int value) {
          writeLock.lock();
          try {
              // æ¨¡æ‹Ÿå†™å…¥æ“ä½œ
              Thread.sleep(5);
              sharedData = value;
              writeCount.incrementAndGet();
          } catch (InterruptedException e) {
              Thread.currentThread().interrupt();
          } finally {
              writeLock.unlock();
          }
      }
      
      /**
       * ä½¿ç”¨ç‹¬å é”è¯»å–æ•°æ®
       */
      public int readWithExclusiveLock() {
          exclusiveLock.lock();
          try {
              // æ¨¡æ‹Ÿè¯»å–æ“ä½œ
              Thread.sleep(1);
              readCount.incrementAndGet();
              return sharedData;
          } catch (InterruptedException e) {
              Thread.currentThread().interrupt();
              return 0;
          } finally {
              exclusiveLock.unlock();
          }
      }
      
      /**
       * ä½¿ç”¨ç‹¬å é”å†™å…¥æ•°æ®
       */
      public void writeWithExclusiveLock(int value) {
          exclusiveLock.lock();
          try {
              // æ¨¡æ‹Ÿå†™å…¥æ“ä½œ
              Thread.sleep(5);
              sharedData = value;
              writeCount.incrementAndGet();
          } catch (InterruptedException e) {
              Thread.currentThread().interrupt();
          } finally {
              exclusiveLock.unlock();
          }
      }
      
      /**
       * æ€§èƒ½æµ‹è¯•
       */
      public void performanceTest(int threadCount, int duration, boolean useReadWriteLock) {
          System.out.println("å¼€å§‹æµ‹è¯• " + 
              (useReadWriteLock ? "ReadWriteLock" : "ReentrantLock") + 
              " çº¿ç¨‹æ•°: " + threadCount);
          
          // é‡ç½®è®¡æ•°å™¨
          readCount.set(0);
          writeCount.set(0);
          
          ExecutorService executor = Executors.newFixedThreadPool(threadCount);
          
          // å¼€å§‹æµ‹è¯•
          long startTime = System.currentTimeMillis();
          
          // æäº¤æµ‹è¯•ä»»åŠ¡
          for (int i = 0; i < threadCount; i++) {
              final int threadId = i;
              executor.submit(() -> {
                  try {
                      while (System.currentTimeMillis() - startTime < duration) {
                          // 90%çš„æ¦‚ç‡è¿›è¡Œè¯»æ“ä½œï¼Œ10%çš„æ¦‚ç‡è¿›è¡Œå†™æ“ä½œ
                          if (Math.random() < 0.9) {
                              // è¯»æ“ä½œ
                              if (useReadWriteLock) {
                                  readWithReadWriteLock();
                              } else {
                                  readWithExclusiveLock();
                              }
                          } else {
                              // å†™æ“ä½œ
                              if (useReadWriteLock) {
                                  writeWithReadWriteLock(threadId);
                              } else {
                                  writeWithExclusiveLock(threadId);
                              }
                          }
                      }
                  } catch (Exception e) {
                      e.printStackTrace();
                  }
              });
          }
          
          // ç­‰å¾…æµ‹è¯•å®Œæˆ
          executor.shutdown();
          try {
              executor.awaitTermination(duration + 1000, TimeUnit.MILLISECONDS);
          } catch (InterruptedException e) {
              Thread.currentThread().interrupt();
          }
          
          // æµ‹è¯•ç»“æœ
          long endTime = System.currentTimeMillis();
          long totalTime = endTime - startTime;
          
          System.out.println("æµ‹è¯•å®Œæˆï¼Œç”¨æ—¶: " + totalTime + "ms");
          System.out.println("è¯»æ“ä½œæ¬¡æ•°: " + readCount.get() + ", è¯»æ“ä½œæ¯ç§’: " + 
              (readCount.get() * 1000 / totalTime));
          System.out.println("å†™æ“ä½œæ¬¡æ•°: " + writeCount.get() + ", å†™æ“ä½œæ¯ç§’: " + 
              (writeCount.get() * 1000 / totalTime));
          System.out.println("æ€»æ“ä½œæ¬¡æ•°: " + (readCount.get() + writeCount.get()) + 
              ", æ€»æ“ä½œæ¯ç§’: " + ((readCount.get() + writeCount.get()) * 1000 / totalTime));
          System.out.println("--------------------------------------");
      }
      
      /**
       * ä¸»æµ‹è¯•æ–¹æ³•
       */
      public static void main(String[] args) {
          ReadWriteLockPerformanceTest test = new ReadWriteLockPerformanceTest();
          
          // æµ‹è¯•å‚æ•°
          int[] threadCounts = {4, 8, 16, 32};
          int testDuration = 5000; // æµ‹è¯•æ—¶é—´5ç§’
          
          System.out.println("===== ReadWriteLock vs ReentrantLock æ€§èƒ½æµ‹è¯• =====");
          System.out.println("è¯»å†™æ¯”ä¾‹: 90% è¯», 10% å†™");
          System.out.println("æµ‹è¯•æ—¶é—´: " + testDuration + "ms");
          System.out.println("--------------------------------------");
          
          // è¿›è¡Œæµ‹è¯•
          for (int threadCount : threadCounts) {
              // æµ‹è¯•ç‹¬å é”
              test.performanceTest(threadCount, testDuration, false);
              
              // æµ‹è¯•è¯»å†™é”
              test.performanceTest(threadCount, testDuration, true);
              
              System.out.println();
          }
      }
  }
  ```
  </TabItem>
  <TabItem value="use_cases" label="é€‚ç”¨åœºæ™¯">
  <div className="card">
  <div className="card__body">
  
  **ReadWriteLockæœ€é€‚åˆä»¥ä¸‹åœºæ™¯:**
  
  1. **è¯»å¤šå†™å°‘çš„åº”ç”¨**
     - æ•°æ®ç¼“å­˜
     - é…ç½®ç®¡ç†
     - çŠ¶æ€ç›‘æ§
  
  2. **è¯»æ“ä½œè€—æ—¶è¾ƒé•¿**
     - å¤æ‚è®¡ç®—
     - å¤§æ•°æ®é›†éå†
     - èµ„æºå¯†é›†å‹æ“ä½œ
  
  3. **ä¸é€‚åˆçš„åœºæ™¯**
     - å†™æ“ä½œé¢‘ç¹çš„åº”ç”¨
     - è¯»å†™æ“ä½œæ¬¡æ•°æ¥è¿‘çš„åœºæ™¯
     - é”æŒæœ‰æ—¶é—´éå¸¸çŸ­çš„æƒ…å†µ
  
  </div>
  </div>
  </TabItem>
  <TabItem value="comparison" label="é”ç±»å‹å¯¹æ¯”">
  <div className="card">
  <div className="card__body">
  
  | ç‰¹æ€§ | synchronized | ReentrantLock | ReadWriteLock |
  |------|------------|--------------|--------------|
  | **å¹¶å‘è¯»å–** | ä¸æ”¯æŒ | ä¸æ”¯æŒ | æ”¯æŒ |
  | **é”è·å–æ–¹å¼** | é˜»å¡å¼ | å¯ä¸­æ–­/è¶…æ—¶/é˜»å¡ | å¯ä¸­æ–­/è¶…æ—¶/é˜»å¡ |
  | **å…¬å¹³æ€§** | ä¸æ”¯æŒ | æ”¯æŒ | æ”¯æŒ |
  | **æ€§èƒ½(è¯»å¤šå†™å°‘)** | ä½ | ä¸­ | é«˜ |
  | **æ€§èƒ½(å†™å¤šè¯»å°‘)** | ä¸­ | é«˜ | ä¸­ |
  | **ç¼–ç¨‹å¤æ‚åº¦** | ä½ | ä¸­ | é«˜ |
  | **é”ç²’åº¦æ§åˆ¶** | ç²—ç²’åº¦ | ç»†ç²’åº¦ | æ›´ç»†ç²’åº¦ |
  | **é¿å…æ­»é”èƒ½åŠ›** | ä½ | é«˜ | é«˜ |
  
  </div>
  </div>
  </TabItem>
</Tabs>

## 5. é”çš„æœ€ä½³å®è·µ

### 5.1 é”çš„é€‰æ‹©ç­–ç•¥

:::tip æ ¸å¿ƒåŸåˆ™
é€‰æ‹©åˆé€‚çš„é”æœºåˆ¶éœ€è¦è€ƒè™‘ä»¥ä¸‹å› ç´ ï¼š
- **ç®€å•åœºæ™¯**ï¼šä¼˜å…ˆä½¿ç”¨synchronized
- **å¤æ‚éœ€æ±‚**ï¼šä½¿ç”¨Lockæ¥å£ï¼ˆä¸­æ–­ã€è¶…æ—¶ã€å…¬å¹³æ€§ï¼‰
- **è¯»å¤šå†™å°‘**ï¼šä½¿ç”¨è¯»å†™é”
- **æ€§èƒ½è¦æ±‚**ï¼šè€ƒè™‘æ— é”æ•°æ®ç»“æ„
:::

### 5.2 é¿å…æ­»é”

```java title="é¿å…æ­»é”ç¤ºä¾‹"
public class DeadlockPrevention {
    
    /**
     * 1. å›ºå®šé”é¡ºåº
     */
    public static class FixedLockOrder {
        private final Object lock1 = new Object();
        private final Object lock2 = new Object();
        
        public void method1() {
            synchronized (lock1) {
                synchronized (lock2) {
                    System.out.println("method1 æ‰§è¡Œ");
                }
            }
        }
        
        public void method2() {
            // ä½¿ç”¨ç›¸åŒçš„é”é¡ºåº
            synchronized (lock1) {
                synchronized (lock2) {
                    System.out.println("method2 æ‰§è¡Œ");
                }
            }
        }
    }
    
    /**
     * 2. ä½¿ç”¨è¶…æ—¶æœºåˆ¶
     */
    public static class TimeoutPrevention {
        private final ReentrantLock lock1 = new ReentrantLock();
        private final ReentrantLock lock2 = new ReentrantLock();
        
        public void method1() {
            if (lock1.tryLock()) {
                try {
                    if (lock2.tryLock(5, TimeUnit.SECONDS)) {
                        try {
                            System.out.println("method1 æ‰§è¡Œ");
                        } finally {
                            lock2.unlock();
                        }
                    } else {
                        System.out.println("method1 è·å–é”2è¶…æ—¶");
                    }
                } catch (InterruptedException e) {
                    Thread.currentThread().interrupt();
                } finally {
                    lock1.unlock();
                }
            }
        }
        
        public void method2() {
            if (lock2.tryLock()) {
                try {
                    if (lock1.tryLock(5, TimeUnit.SECONDS)) {
                        try {
                            System.out.println("method2 æ‰§è¡Œ");
                        } finally {
                            lock1.unlock();
                        }
                    } else {
                        System.out.println("method2 è·å–é”1è¶…æ—¶");
                    }
                } catch (InterruptedException e) {
                    Thread.currentThread().interrupt();
                } finally {
                    lock2.unlock();
                }
            }
        }
    }
    
    /**
     * 3. ä½¿ç”¨é”çš„å±‚æ¬¡ç»“æ„
     */
    public static class LockHierarchy {
        private final Object lock1 = new Object();
        private final Object lock2 = new Object();
        private final Object lock3 = new Object();
        
        public void method1() {
            synchronized (lock1) {
                synchronized (lock2) {
                    synchronized (lock3) {
                        System.out.println("method1 æ‰§è¡Œ");
                    }
                }
            }
        }
        
        public void method2() {
            synchronized (lock1) {
                synchronized (lock2) {
                    System.out.println("method2 æ‰§è¡Œ");
                }
            }
        }
        
        public void method3() {
            synchronized (lock1) {
                System.out.println("method3 æ‰§è¡Œ");
            }
        }
    }
}
```

### 5.3 æ€§èƒ½ä¼˜åŒ–æŠ€å·§

```java title="é”æ€§èƒ½ä¼˜åŒ–ç¤ºä¾‹"
public class LockPerformanceOptimization {
    
    /**
     * 1. å‡å°‘é”çš„ç²’åº¦
     */
    public static class FineGrainedLocking {
        private final Object[] locks = new Object[16];
        private final int[] counters = new int[16];
        
        public FineGrainedLocking() {
            for (int i = 0; i < locks.length; i++) {
                locks[i] = new Object();
            }
        }
        
        public void increment(int key) {
            int index = Math.abs(key % locks.length);
            synchronized (locks[index]) {
                counters[index]++;
            }
        }
        
        public int getTotal() {
            int total = 0;
            for (int i = 0; i < locks.length; i++) {
                synchronized (locks[i]) {
                    total += counters[i];
                }
            }
            return total;
        }
    }
    
    /**
     * 2. ä½¿ç”¨è¯»å†™é”æé«˜å¹¶å‘æ€§
     */
    public static class ReadWriteOptimization {
        private final ReadWriteLock lock = new ReentrantReadWriteLock();
        private final Lock readLock = lock.readLock();
        private final Lock writeLock = lock.writeLock();
        private final Map<String, String> data = new HashMap<>();
        
        public String get(String key) {
            readLock.lock();
            try {
                return data.get(key);
            } finally {
                readLock.unlock();
            }
        }
        
        public void put(String key, String value) {
            writeLock.lock();
            try {
                data.put(key, value);
            } finally {
                writeLock.unlock();
            }
        }
        
        public void putAll(Map<String, String> map) {
            writeLock.lock();
            try {
                data.putAll(map);
            } finally {
                writeLock.unlock();
            }
        }
    }
    
    /**
     * 3. ä½¿ç”¨æ¡ä»¶å˜é‡é¿å…å¿™ç­‰å¾…
     */
    public static class ConditionOptimization {
        private final ReentrantLock lock = new ReentrantLock();
        private final Condition notEmpty = lock.newCondition();
        private final Condition notFull = lock.newCondition();
        private final Queue<String> queue = new LinkedList<>();
        private final int capacity = 10;
        
        public void put(String item) {
            lock.lock();
            try {
                while (queue.size() >= capacity) {
                    notFull.await(); // ç­‰å¾…è€Œä¸æ˜¯å¿™ç­‰å¾…
                }
                queue.offer(item);
                notEmpty.signal();
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            } finally {
                lock.unlock();
            }
        }
        
        public String take() {
            lock.lock();
            try {
                while (queue.isEmpty()) {
                    notEmpty.await(); // ç­‰å¾…è€Œä¸æ˜¯å¿™ç­‰å¾…
                }
                String item = queue.poll();
                notFull.signal();
                return item;
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
                return null;
            } finally {
                lock.unlock();
            }
        }
    }
}
```

## 6. æ€»ç»“

Javaé”æœºåˆ¶æ˜¯å¹¶å‘ç¼–ç¨‹çš„æ ¸å¿ƒï¼ŒæŒæ¡å„ç§é”çš„ç‰¹æ€§å’Œä½¿ç”¨åœºæ™¯å¯¹äºæ„å»ºé«˜æ€§èƒ½çš„å¹¶å‘åº”ç”¨è‡³å…³é‡è¦ã€‚

### 6.1 å…³é”®è¦ç‚¹

1. **é”çš„ç±»å‹**ï¼šsynchronizedã€Lockæ¥å£ã€è¯»å†™é”
2. **é”çš„ç‰¹æ€§**ï¼šå¯é‡å…¥æ€§ã€å…¬å¹³æ€§ã€ä¸­æ–­æ€§ã€è¶…æ—¶æ€§
3. **é¿å…æ­»é”**ï¼šå›ºå®šé”é¡ºåºã€è¶…æ—¶æœºåˆ¶ã€å±‚æ¬¡ç»“æ„
4. **æ€§èƒ½ä¼˜åŒ–**ï¼šå‡å°‘é”ç²’åº¦ã€è¯»å†™åˆ†ç¦»ã€æ¡ä»¶å˜é‡

### 6.2 é€‰æ‹©å»ºè®®

| åœºæ™¯ | æ¨èé”ç±»å‹ | åŸå›  |
|------|------------|------|
| **ç®€å•åŒæ­¥** | synchronized | ç®€å•æ˜“ç”¨ï¼Œè‡ªåŠ¨ç®¡ç† |
| **å¤æ‚éœ€æ±‚** | ReentrantLock | åŠŸèƒ½ä¸°å¯Œï¼Œæ”¯æŒä¸­æ–­å’Œè¶…æ—¶ |
| **è¯»å¤šå†™å°‘** | ReadWriteLock | æé«˜å¹¶å‘æ€§èƒ½ |
| **é«˜æ€§èƒ½è¦æ±‚** | æ— é”æ•°æ®ç»“æ„ | é¿å…é”ç«äº‰ |

### 6.3 å­¦ä¹ å»ºè®®

1. **ç†è§£åŸç†**ï¼šæ·±å…¥ç†è§£å„ç§é”çš„å·¥ä½œåŸç†
2. **å®è·µéªŒè¯**ï¼šé€šè¿‡ç¼–å†™ä»£ç éªŒè¯ä¸åŒé”çš„æ•ˆæœ
3. **æ€§èƒ½æµ‹è¯•**ï¼šå¯¹æ¯”ä¸åŒé”çš„æ€§èƒ½å·®å¼‚
4. **æœ€ä½³å®è·µ**ï¼šéµå¾ªé”ä½¿ç”¨çš„æœ€ä½³å®è·µ

é€šè¿‡æ·±å…¥ç†è§£å’Œç†Ÿç»ƒè¿ç”¨è¿™äº›é”æœºåˆ¶ï¼Œæˆ‘ä»¬èƒ½å¤Ÿæ„å»ºå‡ºæ›´åŠ é«˜æ•ˆã€å¥å£®å’Œå¯ç»´æŠ¤çš„Javaå¹¶å‘åº”ç”¨ç¨‹åºã€‚ 