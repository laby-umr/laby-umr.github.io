---
sidebar_position: 8
title: JPAè¯¦è§£
description: æ·±å…¥ç†è§£JavaæŒä¹…åŒ–APIçš„æ ¸å¿ƒæ¦‚å¿µã€æœ€ä½³å®è·µä¸é«˜çº§ç‰¹æ€§
authors: [Laby]
tags: [JPA, ORMæ¡†æ¶, Hibernate, æŒä¹…åŒ–, Spring Data]
last_update:
  date: 2025-09-03
  author: Laby
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import CodeBlock from '@theme/CodeBlock';

# JPAè¯¦è§£

JPAï¼ˆJava Persistence APIï¼‰æ˜¯Java EEæ ‡å‡†ä¸­å®šä¹‰çš„ORMè§„èŒƒï¼Œä¸ºå¼€å‘è€…æä¾›äº†æŒä¹…åŒ–å¯¹è±¡ä¸å…³ç³»å‹æ•°æ®åº“ä¹‹é—´æ˜ å°„çš„æ ‡å‡†æ–¹æ³•ã€‚ä½œä¸ºä¸€å¥—è§„èŒƒè€Œéå…·ä½“å®ç°ï¼ŒJPAé€šè¿‡å„ç§æä¾›è€…ï¼ˆå¦‚Hibernateã€EclipseLinkã€OpenJPAç­‰ï¼‰å®é™…å®ç°å…¶åŠŸèƒ½ï¼Œä½¿åº”ç”¨ç¨‹åºèƒ½å¤Ÿä»¥ç»Ÿä¸€çš„æ–¹å¼è®¿é—®ä¸åŒçš„ORMæ¡†æ¶ã€‚

:::tip æ ¸å¿ƒä»·å€¼
**JPA = æ ‡å‡†åŒ–API + ORMæ˜ å°„è§„èŒƒ + JPQLæŸ¥è¯¢è¯­è¨€ + ç”Ÿå‘½å‘¨æœŸç®¡ç†**
- ğŸ”„ **æ ‡å‡†åŒ–æ¥å£**ï¼šæä¾›ç»Ÿä¸€çš„å¯¹è±¡å…³ç³»æ˜ å°„APIï¼Œå‡å°‘ç‰¹å®šORMå®ç°ä¾èµ–
- ğŸ“Š **ç®€åŒ–æ•°æ®è®¿é—®**ï¼šé€šè¿‡æ³¨è§£å’ŒXMLé…ç½®æ˜ å°„å¯¹è±¡ä¸æ•°æ®åº“è¡¨
- ğŸ” **å¼ºå¤§æŸ¥è¯¢èƒ½åŠ›**ï¼šJPQLå’ŒCriteria APIæä¾›ç±»å‹å®‰å…¨çš„æŸ¥è¯¢æ„å»º
- ğŸš€ **å¯ç§»æ¤æ€§**ï¼šåº”ç”¨ä»£ç å¯åœ¨ä¸åŒJPAå®ç°é—´è¿ç§»
:::

## 1. JPAåŸºç¡€ä¸æ¶æ„

### 1.1 JPAæ¦‚å¿µä¸å®šä½

JPAï¼ˆJava Persistence APIï¼‰æ˜¯åœ¨JDK 5.0ä¸­å¼•å…¥çš„Java EEæ ‡å‡†è§„èŒƒï¼Œæ—¨åœ¨ç®€åŒ–å’Œæ ‡å‡†åŒ–Javaåº”ç”¨ä¸­çš„å¯¹è±¡å…³ç³»æ˜ å°„ï¼ˆORMï¼‰å¼€å‘ã€‚å®ƒè§£å†³äº†Javaåº”ç”¨ç¨‹åºä¸å…³ç³»å‹æ•°æ®åº“ä¹‹é—´çš„é˜»æŠ—ä¸åŒ¹é…é—®é¢˜ï¼Œä½¿å¼€å‘è€…å¯ä»¥ä½¿ç”¨é¢å‘å¯¹è±¡çš„æ–¹å¼å¤„ç†å…³ç³»æ•°æ®ã€‚

JPAçš„ä¸»è¦ç›®æ ‡æ˜¯ï¼š
- å®šä¹‰æ ‡å‡†åŒ–çš„ORMæ¥å£ï¼Œå‡å°‘åº”ç”¨ç¨‹åºå¯¹ç‰¹å®šORMå®ç°çš„ä¾èµ–
- ç®€åŒ–æ•°æ®è®¿é—®å±‚çš„å¼€å‘ï¼Œæé«˜ä»£ç å¯ç»´æŠ¤æ€§
- æä¾›ç»Ÿä¸€çš„æŸ¥è¯¢è¯­è¨€å’Œå¯¹è±¡ç®¡ç†åŠŸèƒ½
- å®ç°åº”ç”¨ç¨‹åºåœ¨ä¸åŒæŒä¹…åŒ–æä¾›è€…ä¹‹é—´çš„å¯ç§»æ¤æ€§

#### 1.1.1 JPAä¸å…¶ä»–æŒä¹…åŒ–æŠ€æœ¯å¯¹æ¯”

| ç‰¹æ€§ | JPA | Hibernate | MyBatis | çº¯JDBC |
|------|-----|-----------|---------|--------|
| **ç±»å‹** | è§„èŒƒ | æ¡†æ¶(JPAå®ç°) | SQLæ˜ å°„æ¡†æ¶ | åº•å±‚API |
| **æŠ½è±¡çº§åˆ«** | é«˜ | é«˜ | ä¸­ | ä½ |
| **å­¦ä¹ æ›²çº¿** | ä¸­ç­‰ | é™¡å³­ | å¹³ç¼“ | ç®€å• |
| **æ ‡å‡†åŒ–ç¨‹åº¦** | æ ‡å‡†è§„èŒƒ | éµå¾ªJPAè§„èŒƒ | éæ ‡å‡† | æ ‡å‡†API |
| **SQLæ§åˆ¶** | è‡ªåŠ¨ç”Ÿæˆ | è‡ªåŠ¨ç”Ÿæˆ | æ‰‹åŠ¨ç¼–å†™ | å®Œå…¨æ‰‹åŠ¨ |
| **æ€§èƒ½æ§åˆ¶** | ä¸­ç­‰ | ä¸­ç­‰ | é«˜ | å®Œå…¨æ§åˆ¶ |
| **é…ç½®æ–¹å¼** | æ³¨è§£/XML | æ³¨è§£/XML | XML/æ³¨è§£ | ä»£ç é…ç½® |
| **å¯ç§»æ¤æ€§** | é«˜ | ä¸­ | ä½ | é«˜ |
| **é€‚ç”¨åœºæ™¯** | ä¼ä¸šåº”ç”¨ | å¤æ‚å¯¹è±¡æ¨¡å‹ | SQLä¼˜åŒ–åœºæ™¯ | åº•å±‚æ§åˆ¶ |

### 1.2 JPAæ¶æ„ä¸æ ¸å¿ƒç»„ä»¶

JPAå®šä¹‰äº†ä¸€å¥—å®Œæ•´çš„å¯¹è±¡å…³ç³»æ˜ å°„ç»„ä»¶å’ŒAPIï¼ŒåŒ…æ‹¬ï¼š

#### 1.2.1 æ ¸å¿ƒæ¥å£

:::info JPAæ ¸å¿ƒæ¥å£æ¶æ„
JPAçš„æ ¸å¿ƒæ¥å£ä½“ç³»åŒ…æ‹¬ï¼š
- **EntityManagerFactory**ï¼šåˆ›å»ºEntityManagerå®ä¾‹çš„å·¥å‚
- **EntityManager**ï¼šç®¡ç†å®ä½“ç”Ÿå‘½å‘¨æœŸçš„æ ¸å¿ƒæ¥å£
- **EntityTransaction**ï¼šæ§åˆ¶äº‹åŠ¡æ“ä½œ
- **Query**ä¸**TypedQuery**ï¼šæ‰§è¡ŒæŸ¥è¯¢æ“ä½œ
- **Persistence**ï¼šå¼•å¯¼ç±»ï¼Œåˆ›å»ºEntityManagerFactory
:::

1. **EntityManagerFactory**ï¼š
   - åˆ›å»ºEntityManagerå®ä¾‹çš„å·¥å‚
   - çº¿ç¨‹å®‰å…¨ï¼Œé€šå¸¸åœ¨åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶åˆ›å»ºä¸€æ¬¡
   - å¯¹åº”ä¸€ä¸ªæŒä¹…åŒ–å•å…ƒï¼ˆpersistence unitï¼‰
   - åˆå§‹åŒ–æˆæœ¬é«˜ï¼Œåº”è¢«ç¼“å­˜å¹¶é‡ç”¨

2. **EntityManager**ï¼š
   - JPAçš„æ ¸å¿ƒæ¥å£ï¼Œç®¡ç†å®ä½“çš„æŒä¹…åŒ–æ“ä½œ
   - ç›¸å½“äºHibernateçš„Session
   - éçº¿ç¨‹å®‰å…¨ï¼Œé€šå¸¸ä¸äº‹åŠ¡ç»‘å®š
   - æä¾›å®ä½“çš„CRUDæ“ä½œã€æŸ¥è¯¢åŠŸèƒ½å’Œäº‹åŠ¡ç®¡ç†

3. **EntityTransaction**ï¼š
   - ç®¡ç†èµ„æºå±‚äº‹åŠ¡æ“ä½œ
   - æ§åˆ¶äº‹åŠ¡çš„å¼€å§‹ã€æäº¤å’Œå›æ»š
   - ä»…åœ¨éJTAç¯å¢ƒä¸­ä½¿ç”¨

4. **Query**ä¸**TypedQuery**ï¼š
   - æ‰§è¡ŒJPQLæŸ¥è¯¢å’ŒåŸç”ŸSQLæŸ¥è¯¢
   - TypedQueryæä¾›ç±»å‹å®‰å…¨çš„æŸ¥è¯¢ç»“æœ

5. **Persistence**ï¼š
   - å¼•å¯¼ç±»ï¼Œç”¨äºè·å–EntityManagerFactory
   - è¯»å–persistence.xmlé…ç½®æ–‡ä»¶

#### 1.2.2 JPAå®ç°

JPAåªæ˜¯ä¸€å¥—è§„èŒƒï¼Œéœ€è¦å…·ä½“çš„å®ç°æ‰èƒ½ä½¿ç”¨ã€‚å¸‚åœºä¸Šä¸»è¦çš„JPAå®ç°åŒ…æ‹¬ï¼š

| å®ç° | ç»„ç»‡ | ç‰¹ç‚¹ | å¸‚åœºä»½é¢ |
|-----|-----|------|---------|
| **Hibernate** | Red Hat | æœ€æˆç†Ÿã€åŠŸèƒ½æœ€ä¸°å¯Œçš„JPAå®ç° | é«˜ |
| **EclipseLink** | Eclipse Foundation | JPAå‚è€ƒå®ç°ï¼Œæ¥è‡ªTopLink | ä¸­ |
| **OpenJPA** | Apache Software Foundation | è½»é‡çº§å®ç°ï¼Œæ‰©å±•æ€§å¥½ | ä½ |
| **DataNucleus** | DataNucleus | æ”¯æŒå¤šç§æ•°æ®å­˜å‚¨ç±»å‹ | ä½ |

#### 1.2.3 å·¥ä½œæµç¨‹

JPAçš„å…¸å‹å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š

```mermaid
flowchart TD
    A[é…ç½®persistence.xml] -->|åŠ è½½| B[åˆ›å»ºEntityManagerFactory]
    B -->|åˆ›å»º| C[è·å–EntityManager]
    C -->|å¼€å§‹| D[äº‹åŠ¡]
    D -->|æ‰§è¡Œ| E[æŒä¹…åŒ–æ“ä½œ]
    E -->|è®¿é—®| F[æ•°æ®åº“]
    D -->|æäº¤/å›æ»š| G[äº‹åŠ¡ç»“æŸ]
    G -->|å…³é—­| C
```

1. é…ç½®persistence.xmlå®šä¹‰æŒä¹…åŒ–å•å…ƒ
2. é€šè¿‡Persistenceç±»åˆ›å»ºEntityManagerFactory
3. ä»EntityManagerFactoryè·å–EntityManager
4. å¼€å§‹äº‹åŠ¡
5. æ‰§è¡ŒæŒä¹…åŒ–æ“ä½œï¼ˆCRUDï¼‰
6. æäº¤æˆ–å›æ»šäº‹åŠ¡
7. å…³é—­EntityManager

### 1.3 JPAå®ä½“ç”Ÿå‘½å‘¨æœŸ

JPAå®šä¹‰äº†å®ä½“å¯¹è±¡çš„å››ç§çŠ¶æ€ï¼Œæè¿°å®ä½“åœ¨æŒä¹…åŒ–è¿‡ç¨‹ä¸­çš„ä¸åŒé˜¶æ®µã€‚

#### 1.3.1 å®ä½“çŠ¶æ€

1. **æ–°å»ºæ€(New/Transient)**ï¼š
   - åˆšåˆ›å»ºçš„å¯¹è±¡ï¼Œæœªä¸EntityManagerå…³è”
   - æ²¡æœ‰æŒä¹…åŒ–æ ‡è¯†ç¬¦æˆ–æ•°æ®åº“è¡¨ç¤º
   - å¯¹æ­¤å¯¹è±¡çš„æ›´æ”¹ä¸ä¼šå½±å“æ•°æ®åº“

```java
// æ–°å»ºæ€å®ä½“
User user = new User();
user.setName("å¼ ä¸‰");
// æ­¤æ—¶å¯¹è±¡ä¸åœ¨EntityManagerç®¡ç†ä¸‹ï¼Œå¯¹å…¶ä¿®æ”¹ä¸ä¼šåæ˜ åˆ°æ•°æ®åº“
```

2. **æ‰˜ç®¡æ€(Managed)**ï¼š
   - ä¸å½“å‰EntityManagerä¸Šä¸‹æ–‡å…³è”çš„å®ä½“
   - æœ‰æŒä¹…åŒ–æ ‡è¯†ç¬¦ï¼Œå¯¹è±¡çŠ¶æ€è¢«EntityManagerè·Ÿè¸ª
   - å¯¹æ‰˜ç®¡æ€å®ä½“çš„æ›´æ”¹ä¼šåœ¨äº‹åŠ¡æäº¤æ—¶åŒæ­¥åˆ°æ•°æ®åº“

```java
EntityManager em = emf.createEntityManager();
EntityTransaction tx = em.getTransaction();
tx.begin();

// é€šè¿‡persist()æ–¹æ³•ä½¿å¯¹è±¡è¿›å…¥æ‰˜ç®¡æ€
em.persist(user);
// æˆ–é€šè¿‡find()æ–¹æ³•è·å–çš„å¯¹è±¡ç›´æ¥å¤„äºæ‰˜ç®¡æ€
User managedUser = em.find(User.class, 1L);

// æ‰˜ç®¡æ€å¯¹è±¡çš„ä¿®æ”¹ä¼šè¢«è‡ªåŠ¨è·Ÿè¸ª
managedUser.setEmail("zhangsan@example.com");
// ä¸éœ€è¦æ˜¾å¼updateï¼Œä¿®æ”¹ä¼šåœ¨äº‹åŠ¡æäº¤æ—¶åŒæ­¥åˆ°æ•°æ®åº“

tx.commit();
```

3. **æ¸¸ç¦»æ€(Detached)**ï¼š
   - æ›¾ç»å¤„äºæ‰˜ç®¡æ€ï¼Œä½†å½“å‰ä¸åœ¨EntityManagerç®¡ç†ä¸‹
   - æœ‰æŒä¹…åŒ–æ ‡è¯†ç¬¦ï¼Œä½†ä¿®æ”¹ä¸ä¼šåŒæ­¥åˆ°æ•°æ®åº“
   - é€šè¿‡æ˜¾å¼è°ƒç”¨merge()æ–¹æ³•å¯é‡æ–°å˜ä¸ºæ‰˜ç®¡æ€

```java
// EntityManagerå…³é—­åï¼Œæ‰˜ç®¡æ€å¯¹è±¡å˜ä¸ºæ¸¸ç¦»æ€
em.close();
// æ­¤æ—¶managedUserå·²ç»æ˜¯æ¸¸ç¦»æ€
managedUser.setPhone("13800138000");
// è¿™ä¸ªä¿®æ”¹ä¸ä¼šè¢«åŒæ­¥åˆ°æ•°æ®åº“

// é‡æ–°è·å–EntityManager
EntityManager newEm = emf.createEntityManager();
EntityTransaction newTx = newEm.getTransaction();
newTx.begin();

// å°†æ¸¸ç¦»æ€å¯¹è±¡é‡æ–°å˜ä¸ºæ‰˜ç®¡æ€
User mergedUser = newEm.merge(managedUser);
// ç°åœ¨mergedUseræ˜¯æ‰˜ç®¡æ€ï¼Œè€ŒmanagedUserä»ç„¶æ˜¯æ¸¸ç¦»æ€

newTx.commit();
newEm.close();
```

4. **ç§»é™¤æ€(Removed)**ï¼š
   - è¢«EntityManageræ ‡è®°ä¸ºå¾…åˆ é™¤çš„å®ä½“
   - äº‹åŠ¡æäº¤åå°†ä»æ•°æ®åº“ä¸­åˆ é™¤

```java
EntityManager em = emf.createEntityManager();
EntityTransaction tx = em.getTransaction();
tx.begin();

User user = em.find(User.class, 1L);
// æ ‡è®°å¯¹è±¡ä¸ºç§»é™¤æ€
em.remove(user);
// äº‹åŠ¡æäº¤åï¼Œæ•°æ®ä¼šä»æ•°æ®åº“ä¸­åˆ é™¤
tx.commit();
em.close();
```

#### 1.3.2 çŠ¶æ€è½¬æ¢

ä»¥ä¸‹æ˜¯å¯¹è±¡çŠ¶æ€è½¬æ¢çš„ä¸»è¦æ–¹æ³•ï¼š

- **æ–°å»ºæ€â†’æ‰˜ç®¡æ€**ï¼š`persist()`
- **æ‰˜ç®¡æ€â†’æ¸¸ç¦»æ€**ï¼š`clear()`, `close()`, `detach()`
- **æ¸¸ç¦»æ€â†’æ‰˜ç®¡æ€**ï¼š`merge()`
- **æ‰˜ç®¡æ€â†’ç§»é™¤æ€**ï¼š`remove()`
- **æ–°å»ºæ€/æ¸¸ç¦»æ€â†’æ‰˜ç®¡æ€**ï¼š`merge()`

:::info JPAå®ä½“ç”Ÿå‘½å‘¨æœŸ
å®ä½“ç”Ÿå‘½å‘¨æœŸçŠ¶æ€å›¾ï¼š
1. **æ–°å»ºæ€(New/Transient)** - åˆšåˆ›å»ºçš„å¯¹è±¡ï¼Œæœªä¸æŒä¹…åŒ–ä¸Šä¸‹æ–‡å…³è”
2. **æ‰˜ç®¡æ€(Managed)** - è¢«EntityManagerç®¡ç†çš„å¯¹è±¡ï¼Œè‡ªåŠ¨è·Ÿè¸ªå˜æ›´
3. **æ¸¸ç¦»æ€(Detached)** - æ›¾ç»è¢«ç®¡ç†ä½†å½“å‰ä¸åœ¨æŒä¹…åŒ–ä¸Šä¸‹æ–‡ä¸­çš„å¯¹è±¡
4. **ç§»é™¤æ€(Removed)** - è¢«æ ‡è®°ä¸ºåˆ é™¤çš„å¯¹è±¡ï¼Œäº‹åŠ¡æäº¤æ—¶å°†ä»æ•°æ®åº“ä¸­åˆ é™¤

çŠ¶æ€è½¬æ¢ç”±EntityManagerçš„æ–¹æ³•è§¦å‘ï¼Œå¦‚persist()ã€merge()ã€remove()ç­‰ã€‚
:::

### 1.4 ç¯å¢ƒæ­å»ºä¸é…ç½®

#### 1.4.1 Mavenä¾èµ–

åœ¨Mavené¡¹ç›®ä¸­æ·»åŠ JPAä¾èµ–ï¼š

```xml
<!-- JPA API -->
<dependency>
    <groupId>jakarta.persistence</groupId>
    <artifactId>jakarta.persistence-api</artifactId>
    <version>3.1.0</version>
</dependency>

<!-- Hibernateå®ç°ï¼ˆæˆ–å…¶ä»–JPAå®ç°ï¼‰ -->
<dependency>
    <groupId>org.hibernate</groupId>
    <artifactId>hibernate-core-jakarta</artifactId>
    <version>5.6.15.Final</version>
</dependency>

<!-- æ•°æ®åº“é©±åŠ¨ï¼ˆä»¥MySQLä¸ºä¾‹ï¼‰ -->
<dependency>
    <groupId>mysql</groupId>
    <artifactId>mysql-connector-java</artifactId>
    <version>8.0.30</version>
</dependency>
```

#### 1.4.2 é…ç½®persistence.xml

åˆ›å»º`src/main/resources/META-INF/persistence.xml`æ–‡ä»¶ï¼š

```xml
<persistence xmlns="https://jakarta.ee/xml/ns/persistence"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xsi:schemaLocation="https://jakarta.ee/xml/ns/persistence
                                 https://jakarta.ee/xml/ns/persistence/persistence_3_0.xsd"
             version="3.0">
    <persistence-unit name="myPersistenceUnit" transaction-type="RESOURCE_LOCAL">
        <!-- JPAæä¾›è€… -->
        <provider>org.hibernate.jpa.HibernatePersistenceProvider</provider>
        
        <!-- å®ä½“ç±» -->
        <class>com.example.entity.User</class>
        <class>com.example.entity.Order</class>
        
        <properties>
            <!-- æ•°æ®åº“è¿æ¥é…ç½® -->
            <property name="jakarta.persistence.jdbc.driver" value="com.mysql.cj.jdbc.Driver" />
            <property name="jakarta.persistence.jdbc.url" value="jdbc:mysql://localhost:3306/testdb?useSSL=false&amp;serverTimezone=UTC" />
            <property name="jakarta.persistence.jdbc.user" value="root" />
            <property name="jakarta.persistence.jdbc.password" value="password" />
            
            <!-- ç‰¹å®šäºHibernateçš„å±æ€§ -->
            <property name="hibernate.dialect" value="org.hibernate.dialect.MySQL8Dialect" />
            <property name="hibernate.show_sql" value="true" />
            <property name="hibernate.format_sql" value="true" />
            
            <!-- è‡ªåŠ¨ç”Ÿæˆæ•°æ®åº“æ¨¡å¼ -->
            <property name="hibernate.hbm2ddl.auto" value="update" />
        </properties>
    </persistence-unit>
</persistence>
```

#### 1.4.3 åˆ›å»ºEntityManager

```java
// åˆ›å»ºEntityManagerFactory
EntityManagerFactory emf = Persistence.createEntityManagerFactory("myPersistenceUnit");

// è·å–EntityManager
EntityManager em = emf.createEntityManager();

try {
    // ä½¿ç”¨EntityManageræ‰§è¡Œæ“ä½œ
    EntityTransaction tx = em.getTransaction();
    tx.begin();
    
    // æ‰§è¡ŒæŒä¹…åŒ–æ“ä½œ...
    
    tx.commit();
} catch (Exception e) {
    if (em.getTransaction().isActive()) {
        em.getTransaction().rollback();
    }
    e.printStackTrace();
} finally {
    // å…³é—­EntityManager
    em.close();
}

// åº”ç”¨å…³é—­æ—¶å…³é—­EntityManagerFactory
emf.close();
```

#### 1.4.4 ä¸»è¦é…ç½®é€‰é¡¹

| é…ç½®é¡¹ | è¯´æ˜ | ç¤ºä¾‹å€¼ |
|-------|------|-------|
| `jakarta.persistence.jdbc.driver` | JDBCé©±åŠ¨ç±» | com.mysql.cj.jdbc.Driver |
| `jakarta.persistence.jdbc.url` | æ•°æ®åº“è¿æ¥URL | jdbc:mysql://localhost:3306/testdb |
| `jakarta.persistence.jdbc.user` | æ•°æ®åº“ç”¨æˆ·å | root |
| `jakarta.persistence.jdbc.password` | æ•°æ®åº“å¯†ç  | password |
| `hibernate.dialect` | æ•°æ®åº“æ–¹è¨€ | org.hibernate.dialect.MySQL8Dialect |
| `hibernate.show_sql` | æ˜¾ç¤ºSQL | true, false |
| `hibernate.format_sql` | æ ¼å¼åŒ–SQL | true, false |
| `hibernate.hbm2ddl.auto` | è‡ªåŠ¨ç”Ÿæˆæ¨¡å¼ | create, update, validate, none |
| `hibernate.connection.pool_size` | è¿æ¥æ± å¤§å° | 5, 10, 20 |
| `jakarta.persistence.schema-generation.database.action` | æ ‡å‡†æ¨¡å¼ç”Ÿæˆé€‰é¡¹ | none, create, drop-and-create |

## 2. JPAå®ä½“æ˜ å°„

JPAæä¾›äº†ä¸°å¯Œçš„æ³¨è§£å’ŒXMLé…ç½®ï¼Œç”¨äºå°†Javaç±»æ˜ å°„åˆ°æ•°æ®åº“è¡¨ã€‚å®ä½“æ˜ å°„æ˜¯JPAçš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ã€‚

### 2.1 åŸºæœ¬æ³¨è§£æ˜ å°„

#### 2.1.1 å®ä½“ç±»å®šä¹‰

```java
import jakarta.persistence.*;
import java.time.LocalDateTime;

@Entity // å£°æ˜è¿™æ˜¯ä¸€ä¸ªå®ä½“ç±»
@Table(name = "users") // æ˜ å°„åˆ°æ•°æ®åº“ä¸­çš„è¡¨å
public class User {
    
    @Id // å£°æ˜ä¸»é”®
    @GeneratedValue(strategy = GenerationType.IDENTITY) // ä¸»é”®ç”Ÿæˆç­–ç•¥
    private Long id;
    
    @Column(name = "username", nullable = false, length = 50) // åˆ—å®šä¹‰
    private String username;
    
    @Column(name = "email", unique = true)
    private String email;
    
    @Temporal(TemporalType.TIMESTAMP) // æ—¶æ€ç±»å‹ï¼ˆJPA 2.1ä¹‹å‰çš„æ—¥æœŸç±»å‹æ˜ å°„ï¼‰
    @Column(name = "created_at")
    private java.util.Date legacyDate;
    
    // JPA 2.2+æ”¯æŒJava 8æ—¥æœŸæ—¶é—´API
    @Column(name = "registration_date")
    private LocalDateTime registrationDate;
    
    @Enumerated(EnumType.STRING) // æšä¸¾ç±»å‹æ˜ å°„
    @Column(name = "status")
    private UserStatus status;
    
    @Transient // éæŒä¹…åŒ–å­—æ®µ
    private String temporaryData;
    
    @Basic(fetch = FetchType.LAZY) // æ‡’åŠ è½½çš„åŸºæœ¬å­—æ®µ
    @Column(name = "bio", length = 5000)
    private String biography;
    
    // æ„é€ å‡½æ•°ã€Getterå’ŒSetterçœç•¥...
}

// æšä¸¾ç±»
public enum UserStatus {
    ACTIVE, INACTIVE, SUSPENDED
}
```

#### 2.1.2 ä¸»é”®ç”Ÿæˆç­–ç•¥

JPAæ”¯æŒå¤šç§ä¸»é”®ç”Ÿæˆç­–ç•¥ï¼š

```java
// è‡ªå¢é•¿ï¼ˆä¾èµ–æ•°æ®åº“çš„è‡ªå¢ç‰¹æ€§ï¼‰
@Id
@GeneratedValue(strategy = GenerationType.IDENTITY)
private Long id;

// åºåˆ—ç”Ÿæˆå™¨ï¼ˆé€‚ç”¨äºOracleç­‰æ”¯æŒåºåˆ—çš„æ•°æ®åº“ï¼‰
@Id
@GeneratedValue(strategy = GenerationType.SEQUENCE, generator = "user_seq")
@SequenceGenerator(name = "user_seq", sequenceName = "USER_SEQ", allocationSize = 1)
private Long id;

// è¡¨ç”Ÿæˆå™¨ï¼ˆç‹¬ç«‹äºç‰¹å®šæ•°æ®åº“ï¼‰
@Id
@GeneratedValue(strategy = GenerationType.TABLE, generator = "user_gen")
@TableGenerator(name = "user_gen", table = "id_generator", 
                pkColumnName = "gen_name", pkColumnValue = "user_id",
                valueColumnName = "gen_value", allocationSize = 1)
private Long id;

// è‡ªåŠ¨é€‰æ‹©ï¼ˆè®©JPAæä¾›è€…é€‰æ‹©é€‚å½“çš„ç­–ç•¥ï¼‰
@Id
@GeneratedValue(strategy = GenerationType.AUTO)
private Long id;

// UUIDç”Ÿæˆï¼ˆéœ€è¦è‡ªå®šä¹‰å®ç°ï¼‰
@Id
@Column(length = 36)
private String id;

@PrePersist
protected void onCreate() {
    if (id == null) {
        id = UUID.randomUUID().toString();
    }
}
```

#### 2.1.3 å­—æ®µæ˜ å°„

JPAæä¾›äº†å¤šç§å­—æ®µæ˜ å°„æ³¨è§£ï¼š

```java
@Entity
public class Product {
    // åŸºæœ¬ç±»å‹æ˜ å°„
    @Column(name = "product_name", nullable = false, length = 100)
    private String name;
    
    @Column(precision = 10, scale = 2) // æ•°å€¼ç²¾åº¦
    private BigDecimal price;
    
    // å¤§æ–‡æœ¬æ˜ å°„
    @Lob
    @Column(name = "description")
    private String description;
    
    // å¤§äºŒè¿›åˆ¶å¯¹è±¡
    @Lob
    @Basic(fetch = FetchType.LAZY) // æ‡’åŠ è½½
    private byte[] image;
    
    // æšä¸¾æ˜ å°„ï¼ˆæŒ‰åç§°ï¼‰
    @Enumerated(EnumType.STRING)
    private ProductCategory category;
    
    // æšä¸¾æ˜ å°„ï¼ˆæŒ‰åºå·ï¼‰
    @Enumerated(EnumType.ORDINAL)
    private ProductStatus status;
    
    // æ—¥æœŸæ—¶é—´æ˜ å°„ï¼ˆJava 8+ï¼‰
    private LocalDate releaseDate;
    private LocalDateTime lastUpdated;
    private Instant createdAt;
    
    // å†…åµŒå¯¹è±¡
    @Embedded
    private Audit audit;
}

@Embeddable
public class Audit {
    @Column(name = "created_by")
    private String createdBy;
    
    @Column(name = "created_at")
    private LocalDateTime createdAt;
    
    @Column(name = "updated_by")
    private String updatedBy;
    
    @Column(name = "updated_at")
    private LocalDateTime updatedAt;
}
```

### 2.2 å…³è”å…³ç³»æ˜ å°„

JPAæ”¯æŒå®šä¹‰å®ä½“é—´çš„å¤šç§å…³ç³»ç±»å‹ã€‚

#### 2.2.1 ä¸€å¯¹ä¸€å…³ç³»(@OneToOne)

```java
// åŸºäºå¤–é”®çš„ä¸€å¯¹ä¸€æ˜ å°„
@Entity
@Table(name = "users")
public class User {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    private String username;
    
    // ç”¨æˆ·å’Œç”¨æˆ·è¯¦æƒ…çš„ä¸€å¯¹ä¸€å…³ç³»
    @OneToOne(cascade = CascadeType.ALL, fetch = FetchType.LAZY)
    @JoinColumn(name = "profile_id")
    private UserProfile profile;
    
    // Getterså’ŒSettersçœç•¥...
}

@Entity
@Table(name = "user_profiles")
public class UserProfile {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    private String biography;
    private String avatarUrl;
    
    // åŒå‘å…³è”ï¼ˆå¯é€‰ï¼‰
    @OneToOne(mappedBy = "profile")
    private User user;
    
    // Getterså’ŒSettersçœç•¥...
}
```

#### 2.2.2 ä¸€å¯¹å¤š/å¤šå¯¹ä¸€å…³ç³»(@OneToMany/@ManyToOne)

```java
// éƒ¨é—¨ä¸å‘˜å·¥çš„ä¸€å¯¹å¤šå…³ç³»
@Entity
@Table(name = "departments")
public class Department {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    private String name;
    
    // ä¸€ä¸ªéƒ¨é—¨æœ‰å¤šä¸ªå‘˜å·¥
    @OneToMany(mappedBy = "department", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<Employee> employees = new ArrayList<>();
    
    // ä¾¿æ·æ–¹æ³•ç®¡ç†å…³ç³»
    public void addEmployee(Employee employee) {
        employees.add(employee);
        employee.setDepartment(this);
    }
    
    public void removeEmployee(Employee employee) {
        employees.remove(employee);
        employee.setDepartment(null);
    }
    
    // Getterså’ŒSettersçœç•¥...
}

@Entity
@Table(name = "employees")
public class Employee {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    private String name;
    private String position;
    
    // å¤šä¸ªå‘˜å·¥å±äºä¸€ä¸ªéƒ¨é—¨
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "department_id")
    private Department department;
    
    // Getterså’ŒSettersçœç•¥...
}
```

#### 2.2.3 å¤šå¯¹å¤šå…³ç³»(@ManyToMany)

```java
// å­¦ç”Ÿå’Œè¯¾ç¨‹çš„å¤šå¯¹å¤šå…³ç³»
@Entity
@Table(name = "students")
public class Student {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    private String name;
    
    @ManyToMany(cascade = {CascadeType.PERSIST, CascadeType.MERGE})
    @JoinTable(
        name = "student_course", 
        joinColumns = @JoinColumn(name = "student_id"),
        inverseJoinColumns = @JoinColumn(name = "course_id")
    )
    private Set<Course> courses = new HashSet<>();
    
    // ä¾¿æ·æ–¹æ³•ç®¡ç†å…³ç³»
    public void addCourse(Course course) {
        courses.add(course);
        course.getStudents().add(this);
    }
    
    public void removeCourse(Course course) {
        courses.remove(course);
        course.getStudents().remove(this);
    }
    
    // Getterså’ŒSettersçœç•¥...
}

@Entity
@Table(name = "courses")
public class Course {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    private String name;
    private int credits;
    
    @ManyToMany(mappedBy = "courses")
    private Set<Student> students = new HashSet<>();
    
    // Getterså’ŒSettersçœç•¥...
}
```

#### 2.2.4 çº§è”æ“ä½œä¸å­¤å„¿åˆ é™¤

JPAé€šè¿‡çº§è”ï¼ˆCascadeï¼‰é€‰é¡¹æ§åˆ¶å…³è”å¯¹è±¡çš„æ“ä½œä¼ æ’­ï¼š

```java
// çº§è”æ‰€æœ‰æ“ä½œï¼ˆåˆ›å»ºã€æ›´æ–°ã€åˆ é™¤ç­‰ï¼‰
@OneToMany(mappedBy = "parent", cascade = CascadeType.ALL)

// çº§è”ç‰¹å®šæ“ä½œ
@OneToMany(mappedBy = "parent", 
           cascade = {CascadeType.PERSIST, CascadeType.MERGE})

// å­¤å„¿åˆ é™¤ï¼ˆå½“å­å¯¹è±¡ä¸å†è¢«å¼•ç”¨æ—¶è‡ªåŠ¨åˆ é™¤ï¼‰
@OneToMany(mappedBy = "parent", orphanRemoval = true)
```

ä¸»è¦çš„çº§è”é€‰é¡¹ï¼š
- **CascadeType.PERSIST**ï¼šçº§è”ä¿å­˜
- **CascadeType.MERGE**ï¼šçº§è”æ›´æ–°
- **CascadeType.REMOVE**ï¼šçº§è”åˆ é™¤
- **CascadeType.REFRESH**ï¼šçº§è”åˆ·æ–°
- **CascadeType.DETACH**ï¼šçº§è”è„±ç®¡
- **CascadeType.ALL**ï¼šåŒ…å«æ‰€æœ‰çº§è”æ“ä½œ 