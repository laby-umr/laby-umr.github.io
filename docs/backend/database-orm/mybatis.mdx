---
sidebar_position: 3
title: MyBatisæ¡†æ¶è¯¦è§£
description: æ·±å…¥ç†è§£MyBatisæ ¸å¿ƒåŸç†ã€æ˜ å°„é…ç½®ä¸é«˜çº§ç‰¹æ€§åº”ç”¨
authors: [Laby]
tags: [MyBatis, ORMæ¡†æ¶, SQLæ˜ å°„, æŒä¹…å±‚, Java]
last_update:
  date: 2025-08-11
  author: Laby
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import CodeBlock from '@theme/CodeBlock';

# MyBatisæ¡†æ¶è¯¦è§£

MyBatisæ˜¯ä¸€æ¬¾ä¼˜ç§€çš„æŒä¹…å±‚æ¡†æ¶ï¼Œæ”¯æŒè‡ªå®šä¹‰SQLã€å­˜å‚¨è¿‡ç¨‹ä»¥åŠé«˜çº§æ˜ å°„ã€‚MyBatisé¿å…äº†å‡ ä¹æ‰€æœ‰çš„JDBCä»£ç å’Œæ‰‹åŠ¨è®¾ç½®å‚æ•°ä»¥åŠè·å–ç»“æœé›†ï¼Œé€šè¿‡ç®€å•çš„XMLé…ç½®æˆ–æ³¨è§£ï¼Œå°†æ¥å£ä¸SQLè¯­å¥è¿›è¡Œæ˜ å°„ï¼Œä¸“æ³¨äºSQLæœ¬èº«ï¼Œèµ‹äºˆå¼€å‘è€…æ›´å¤šçš„æ§åˆ¶æƒå’Œçµæ´»æ€§ã€‚

:::tip æ ¸å¿ƒä»·å€¼
**MyBatis = çµæ´»SQL + ç®€åŒ–JDBC + ä¼˜é›…æ˜ å°„ + åŠ¨æ€æŸ¥è¯¢**
- ğŸš€ **åŠè‡ªåŠ¨ORM**ï¼šæ‰‹å†™SQLï¼Œè‡ªåŠ¨æ˜ å°„ç»“æœé›†ï¼Œæ§åˆ¶ä¸çµæ´»å¹¶å­˜
- ğŸ¯ **åŠ¨æ€SQL**ï¼šå¼ºå¤§çš„æ¡ä»¶åˆ¤æ–­ã€å¾ªç¯ã€åˆ†æ”¯èƒ½åŠ›ï¼Œç”Ÿæˆå¤æ‚æŸ¥è¯¢
- ğŸ’¡ **ä¼˜é›…è®¾è®¡**ï¼šæ¥å£ä¸å®ç°åˆ†ç¦»ï¼Œä»…éœ€å®šä¹‰æ¥å£ï¼Œæ— éœ€å®ç°ç±»
- ğŸ”§ **å¯æ’æ‹”æ¶æ„**ï¼šæ’ä»¶æœºåˆ¶æ”¯æŒè‡ªå®šä¹‰æ‹¦æˆªå’Œå¤„ç†ï¼Œæ˜“äºæ‰©å±•
- ğŸ›¡ï¸ **ç¼“å­˜æ”¯æŒ**ï¼šä¸€çº§ç¼“å­˜ä¸äºŒçº§ç¼“å­˜ï¼Œæå‡æŸ¥è¯¢æ€§èƒ½
:::

## 1. MyBatisæ ¸å¿ƒåŸç†ä¸æ¶æ„

MyBatisæ˜¯ä¸€ä¸ªä¼˜ç§€çš„æŒä¹…å±‚æ¡†æ¶ï¼Œå…¶æ ¸å¿ƒè®¾è®¡ç†å¿µæ˜¯å°†SQLä¸ä»£ç åˆ†ç¦»ï¼ŒåŒæ—¶æä¾›ç®€å•è€Œå¼ºå¤§çš„æ˜ å°„æœºåˆ¶ã€‚ç†è§£MyBatisçš„æ¶æ„å’ŒåŸç†å¯¹äºæ­£ç¡®é«˜æ•ˆåœ°ä½¿ç”¨å®ƒè‡³å…³é‡è¦ã€‚

```mermaid
graph TD
    A[åº”ç”¨ç¨‹åº] --> B[SqlSessionFactoryBuilder]
    B -- è¯»å–é…ç½® --> C[Configuration XML]
    B -- æ„å»º --> D[SqlSessionFactory]
    D -- åˆ›å»º --> E[SqlSession]
    E -- æ‰§è¡Œ --> F[Executor]
    F -- åˆ›å»º/ä½¿ç”¨ --> G[StatementHandler]
    G -- è®¾ç½®å‚æ•° --> H[ParameterHandler]
    G -- æ‰§è¡ŒSQL --> I[æ•°æ®åº“]
    I -- è¿”å›ç»“æœ --> J[ResultSetHandler]
    J -- æ˜ å°„ç»“æœ --> E
    E -- è¿”å›æ•°æ® --> A
```

### 1.1 MyBatiså·¥ä½œåŸç†

MyBatisçš„å·¥ä½œæµç¨‹å¯ä»¥æ¦‚æ‹¬ä¸ºä»¥ä¸‹å‡ ä¸ªå…³é”®æ­¥éª¤ï¼š

<Tabs>
<TabItem value="build" label="æ„å»ºé˜¶æ®µ">

```java title="SqlSessionFactoryæ„å»ºè¿‡ç¨‹"
// 1. åˆ›å»ºSqlSessionFactoryBuilderå¯¹è±¡
SqlSessionFactoryBuilder builder = new SqlSessionFactoryBuilder();

// 2. åŠ è½½mybatis-config.xmlé…ç½®æ–‡ä»¶
InputStream inputStream = Resources.getResourceAsStream("mybatis-config.xml");

// 3. æ„å»ºSqlSessionFactoryå¯¹è±¡
SqlSessionFactory factory = builder.build(inputStream);
```

åœ¨æ„å»ºé˜¶æ®µï¼ŒMyBatisä¼šå®Œæˆä»¥ä¸‹å·¥ä½œï¼š
1. è§£æé…ç½®æ–‡ä»¶ä¸­çš„æ ‡ç­¾
2. åˆ›å»ºConfigurationå¯¹è±¡
3. åŠ è½½æ˜ å°„æ–‡ä»¶å’Œæ³¨è§£é…ç½®
4. åˆå§‹åŒ–å†…ç½®ç»„ä»¶
5. åˆ›å»ºSqlSessionFactoryå®ä¾‹

</TabItem>
<TabItem value="runtime" label="è¿è¡Œé˜¶æ®µ">

```java title="SqlSessionä½¿ç”¨è¿‡ç¨‹"
// 1. è·å–SqlSession
try (SqlSession session = factory.openSession()) {
    // 2. è·å–Mapperæ¥å£
    UserMapper mapper = session.getMapper(UserMapper.class);
    
    // 3. æ‰§è¡ŒSQL
    User user = mapper.getUserById(1);
    
    // 4. æäº¤äº‹åŠ¡
    session.commit();
}
```

åœ¨è¿è¡Œé˜¶æ®µï¼ŒMyBatisä¼šå®Œæˆä»¥ä¸‹å·¥ä½œï¼š
1. åˆ›å»ºSqlSessionå®ä¾‹
2. åˆ›å»ºExecutoræ‰§è¡Œå™¨
3. åˆ›å»ºStatementHandlerå¤„ç†SQLè¯­å¥
4. å‚æ•°æ˜ å°„å’Œè®¾ç½®
5. æ‰§è¡ŒSQLå¹¶è·å–ç»“æœ
6. ç»“æœé›†æ˜ å°„è½¬æ¢
7. è¿”å›ä¸šåŠ¡å¯¹è±¡

</TabItem>
</Tabs>

MyBatisé€šè¿‡åŠ¨æ€ä»£ç†æŠ€æœ¯å®ç°äº†åªéœ€å®šä¹‰æ¥å£è€Œæ— éœ€ç¼–å†™å®ç°ç±»çš„ä¾¿åˆ©ç‰¹æ€§ã€‚å½“æˆ‘ä»¬è°ƒç”¨Mapperæ¥å£æ–¹æ³•æ—¶ï¼ŒMyBatisä¼šæ‹¦æˆªè¯¥è°ƒç”¨ï¼Œæ‰¾åˆ°å¯¹åº”çš„SQLè¯­å¥å¹¶æ‰§è¡Œï¼Œç„¶åå°†ç»“æœæ˜ å°„ä¸ºæŒ‡å®šçš„å¯¹è±¡ã€‚

### 1.2 æ ¸å¿ƒç»„ä»¶å‰–æ

MyBatisçš„æ ¸å¿ƒç»„ä»¶æ„æˆäº†å…¶å®Œæ•´çš„åŠŸèƒ½ä½“ç³»ï¼Œæ¯ä¸ªç»„ä»¶è´Ÿè´£ç‰¹å®šçš„åŠŸèƒ½ï¼š

| æ ¸å¿ƒç»„ä»¶ | ä¸»è¦åŠŸèƒ½ | ç”Ÿå‘½å‘¨æœŸ | å…³é”®ç‰¹æ€§ |
|--------|---------|---------|---------|
| **Configuration** | å…¨å±€é…ç½®ä¿¡æ¯ | å…¨å±€å”¯ä¸€ | åŒ…å«æ‰€æœ‰é…ç½®å’Œæ˜ å°„ä¿¡æ¯ |
| **SqlSessionFactory** | åˆ›å»ºSqlSession | å…¨å±€å”¯ä¸€ | çº¿ç¨‹å®‰å…¨ï¼Œå¯é‡ç”¨ |
| **SqlSession** | æä¾›SQLæ‰§è¡Œæ–¹æ³• | è¯·æ±‚çº§åˆ« | éçº¿ç¨‹å®‰å…¨ï¼ŒçŸ­æš‚ |
| **Executor** | æ‰§è¡Œå™¨ | è¯·æ±‚çº§åˆ« | ç»´æŠ¤ç¼“å­˜ï¼Œæ‰§è¡ŒSQL |
| **StatementHandler** | å¤„ç†SQLè¯­å¥ | æ–¹æ³•çº§åˆ« | åˆ›å»ºStatementå¯¹è±¡ |
| **ParameterHandler** | å¤„ç†SQLå‚æ•° | æ–¹æ³•çº§åˆ« | è®¾ç½®é¢„ç¼–è¯‘å‚æ•° |
| **ResultSetHandler** | å¤„ç†ç»“æœé›†æ˜ å°„ | æ–¹æ³•çº§åˆ« | å°†ç»“æœé›†è½¬ä¸ºå¯¹è±¡ |
| **TypeHandler** | ç±»å‹è½¬æ¢ | å…¨å±€å¯ç”¨ | Javaä¸JDBCç±»å‹è½¬æ¢ |
| **MappedStatement** | æ˜ å°„è¯­å¥ | å…¨å±€å¯ç”¨ | å°è£…SQLå’Œæ˜ å°„ä¿¡æ¯ |

:::tip ç»„ä»¶å…³ç³»è¦ç‚¹
- **SqlSessionFactory**ï¼šå•ä¾‹æ¨¡å¼ï¼Œåº”ç”¨çº§ç”Ÿå‘½å‘¨æœŸ
- **SqlSession**ï¼šéçº¿ç¨‹å®‰å…¨ï¼Œéœ€è¦åœ¨æ–¹æ³•ä½œç”¨åŸŸå†…ä½¿ç”¨
- **Mapper**ï¼šç”±SqlSessionåˆ›å»ºçš„ä»£ç†å¯¹è±¡ï¼Œä¾èµ–äºSqlSessionç”Ÿå‘½å‘¨æœŸ
:::

### 1.3 æ‰§è¡Œæµç¨‹è¯¦è§£

MyBatisçš„æ‰§è¡Œæµç¨‹å¯ä»¥è¯¦ç»†åˆ†è§£ä¸ºä»¥ä¸‹æ­¥éª¤ï¼š

1. **åˆå§‹åŒ–é˜¶æ®µ**
   - è§£æé…ç½®æ–‡ä»¶åˆ›å»ºConfigurationå¯¹è±¡
   - åŠ è½½Mapperæ˜ å°„æ–‡ä»¶æˆ–æ³¨è§£
   - è§£æSQLè¯­å¥åˆ›å»ºMappedStatementå¯¹è±¡
   - æ„å»ºSqlSessionFactoryå®ä¾‹

2. **æ‰§è¡Œé˜¶æ®µ**
   - é€šè¿‡SqlSessionFactoryåˆ›å»ºSqlSession
   - é€šè¿‡SqlSessionè·å–Mapperä»£ç†å¯¹è±¡
   - è°ƒç”¨Mapperæ–¹æ³•æ‰§è¡ŒSQL
   - SqlSessionå°†è¯·æ±‚è½¬äº¤ç»™Executoræ‰§è¡Œå™¨
   - Executorè°ƒç”¨StatementHandlerå¤„ç†SQLè¯­å¥
   - ParameterHandlerè®¾ç½®å‚æ•°
   - æ‰§è¡ŒSQLè¯­å¥
   - ResultSetHandlerå°†ç»“æœé›†è½¬æ¢ä¸ºå¯¹è±¡
   - è¿”å›æ‰§è¡Œç»“æœç»™è°ƒç”¨è€…

<CodeBlock language="java" title="å®Œæ•´æ‰§è¡Œæµç¨‹ç¤ºä¾‹">
{`// 1. è¯»å–MyBatisé…ç½®æ–‡ä»¶
String resource = "mybatis-config.xml";
InputStream inputStream = Resources.getResourceAsStream(resource);

// 2. æ„å»ºSqlSessionFactory
SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(inputStream);

// 3. è·å–SqlSession
try (SqlSession sqlSession = sqlSessionFactory.openSession()) {
    // 4. è·å–Mapperä»£ç†å¯¹è±¡
    UserMapper mapper = sqlSession.getMapper(UserMapper.class);
    
    // 5. æ‰§è¡ŒSQL
    User user = mapper.getUserById(1);
    
    // 6. å¤„ç†ç»“æœ
    System.out.println(user);
    
    // 7. æäº¤äº‹åŠ¡
    sqlSession.commit();
}`}
</CodeBlock>

å½“è°ƒç”¨`mapper.getUserById(1)`æ—¶ï¼ŒMyBatiså†…éƒ¨ä¼šï¼š
1. é€šè¿‡åŠ¨æ€ä»£ç†æ‹¦æˆªè¯¥æ–¹æ³•è°ƒç”¨
2. æ ¹æ®æ–¹æ³•ç­¾åæ‰¾åˆ°å¯¹åº”çš„MappedStatement
3. åˆ›å»ºSqlSourceç”ŸæˆSQLè¯­å¥
4. è®¾ç½®å‚æ•°å¹¶æ‰§è¡ŒSQL
5. å°†ç»“æœé›†æ˜ å°„ä¸ºUserå¯¹è±¡
6. è¿”å›ç»“æœç»™è°ƒç”¨è€…

## 2. é…ç½®ä½“ç³»è¯¦è§£

MyBatisçš„é…ç½®ä½“ç³»æ˜¯å…¶çµæ´»æ€§å’Œå¯æ‰©å±•æ€§çš„å…³é”®ã€‚å…¨å±€é…ç½®æ–‡ä»¶æ˜¯MyBatisé…ç½®çš„å…¥å£ï¼ŒåŒ…å«äº†å¤šç§é…ç½®å…ƒç´ ï¼Œå¯ä»¥æ ¹æ®ä¸åŒç¯å¢ƒå’Œéœ€æ±‚è¿›è¡Œå®šåˆ¶ã€‚

### 2.1 å…¨å±€é…ç½®æ–‡ä»¶

MyBatiså…¨å±€é…ç½®æ–‡ä»¶ï¼ˆé€šå¸¸å‘½åä¸ºmybatis-config.xmlï¼‰ç»“æ„æ¸…æ™°ï¼Œå„å…ƒç´ æœ‰ä¸¥æ ¼çš„é¡ºåºè¦æ±‚ï¼š

```mermaid
graph TD
    A[configuration] --> B[properties]
    A --> C[settings]
    A --> D[typeAliases]
    A --> E[typeHandlers]
    A --> F[objectFactory]
    A --> G[plugins]
    A --> H[environments]
    H --> I[environment]
    I --> J[transactionManager]
    I --> K[dataSource]
    A --> L[databaseIdProvider]
    A --> M[mappers]
```

<CodeBlock language="xml" title="mybatis-config.xmlå®Œæ•´ç¤ºä¾‹">
{`<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE configuration
  PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-config.dtd">
<configuration>
  <!-- å¼•å…¥å¤–éƒ¨å±æ€§æ–‡ä»¶ -->
  <properties resource="db.properties">
    <property name="username" value="dev_user"/>
    <property name="password" value="dev_password"/>
  </properties>
  
  <!-- å…¨å±€è®¾ç½® -->
  <settings>
    <setting name="cacheEnabled" value="true"/>
    <setting name="lazyLoadingEnabled" value="true"/>
    <setting name="mapUnderscoreToCamelCase" value="true"/>
  </settings>
  
  <!-- ç±»å‹åˆ«å -->
  <typeAliases>
    <package name="com.example.model"/>
  </typeAliases>
  
  <!-- ç±»å‹å¤„ç†å™¨ -->
  <typeHandlers>
    <typeHandler handler="com.example.handler.JsonTypeHandler"/>
  </typeHandlers>
  
  <!-- æ’ä»¶ -->
  <plugins>
    <plugin interceptor="com.example.plugin.PageInterceptor">
      <property name="dialect" value="mysql"/>
    </plugin>
  </plugins>
  
  <!-- ç¯å¢ƒé…ç½® -->
  <environments default="development">
    <environment id="development">
              <transactionManager type="JDBC"/>
        <dataSource type="POOLED">
          <property name="driver" value="com.mysql.cj.jdbc.Driver"/>
          <property name="url" value="jdbc:mysql://localhost:3306/mydb"/>
          <property name="username" value="root"/>
          <property name="password" value="password"/>
      </dataSource>
    </environment>
  </environments>
  
  <!-- æ•°æ®åº“å‚å•†æ ‡è¯† -->
  <databaseIdProvider type="DB_VENDOR">
    <property name="MySQL" value="mysql"/>
    <property name="Oracle" value="oracle"/>
    <property name="SQL Server" value="sqlserver"/>
  </databaseIdProvider>
  
  <!-- æ˜ å°„å™¨ -->
  <mappers>
    <mapper resource="com/example/mapper/UserMapper.xml"/>
    <package name="com.example.mapper"/>
  </mappers>
</configuration>`}
</CodeBlock>

:::warning æ³¨æ„
é…ç½®å…ƒç´ å¿…é¡»æŒ‰ç…§ä¸Šè¿°é¡ºåºå®šä¹‰ï¼Œå¦åˆ™MyBatisä¼šæŠ›å‡ºå¼‚å¸¸ï¼
:::

### 2.2 ç¯å¢ƒä¸æ•°æ®æºé…ç½®

MyBatisæ”¯æŒå¤šç¯å¢ƒé…ç½®ï¼Œå¯ä»¥ä¸ºä¸åŒçš„å¼€å‘é˜¶æ®µï¼ˆå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ï¼‰é…ç½®ä¸åŒçš„æ•°æ®æºå’Œäº‹åŠ¡ç®¡ç†å™¨ã€‚

<Tabs>
<TabItem value="environments" label="ç¯å¢ƒé…ç½®">

```xml title="å¤šç¯å¢ƒé…ç½®"
<environments default="development">
  <!-- å¼€å‘ç¯å¢ƒ -->
  <environment id="development">
    <transactionManager type="JDBC"/>
    <dataSource type="POOLED">
      <property name="driver" value="com.mysql.cj.jdbc.Driver"/>
      <property name="url" value="jdbc:mysql://localhost:3306/dev_db"/>
      <property name="username" value="dev_user"/>
      <property name="password" value="dev_password"/>
    </dataSource>
  </environment>
  
  <!-- æµ‹è¯•ç¯å¢ƒ -->
  <environment id="test">
    <transactionManager type="JDBC"/>
    <dataSource type="POOLED">
      <property name="driver" value="com.mysql.cj.jdbc.Driver"/>
      <property name="url" value="jdbc:mysql://test-server:3306/test_db"/>
      <property name="username" value="test_user"/>
      <property name="password" value="test_password"/>
    </dataSource>
  </environment>
  
  <!-- ç”Ÿäº§ç¯å¢ƒ -->
  <environment id="production">
    <transactionManager type="MANAGED"/>
    <dataSource type="JNDI">
      <property name="data_source" value="java:comp/env/jdbc/ProductionDB"/>
    </dataSource>
  </environment>
</environments>
```

</TabItem>
<TabItem value="transaction" label="äº‹åŠ¡ç®¡ç†å™¨">

MyBatisæ”¯æŒä¸¤ç§ç±»å‹çš„äº‹åŠ¡ç®¡ç†å™¨ï¼š

1. **JDBC**ï¼šç›´æ¥ä½¿ç”¨JDBCçš„äº‹åŠ¡ç®¡ç†æœºåˆ¶ï¼Œä¾èµ–äºæ•°æ®åº“è¿æ¥çš„commitå’Œrollback
```xml
<transactionManager type="JDBC"/>
```

2. **MANAGED**ï¼šå°†äº‹åŠ¡ç®¡ç†äº¤ç»™å®¹å™¨ï¼ˆå¦‚Springæˆ–JEEå®¹å™¨ï¼‰
```xml
<transactionManager type="MANAGED">
  <property name="closeConnection" value="false"/>
</transactionManager>
```

</TabItem>
<TabItem value="datasource" label="æ•°æ®æºé…ç½®">

MyBatiså†…ç½®äº†ä¸‰ç§æ•°æ®æºç±»å‹ï¼š

1. **UNPOOLED**ï¼šä¸ä½¿ç”¨è¿æ¥æ± ï¼Œæ¯æ¬¡è¯·æ±‚æ—¶æ‰“å¼€å’Œå…³é—­è¿æ¥
```xml
<dataSource type="UNPOOLED">
  <property name="driver" value="com.mysql.cj.jdbc.Driver"/>
  <property name="url" value="jdbc:mysql://localhost:3306/mydb"/>
  <property name="username" value="root"/>
  <property name="password" value="password"/>
</dataSource>
```

2. **POOLED**ï¼šä½¿ç”¨MyBatiså†…ç½®çš„ç®€å•æ•°æ®åº“è¿æ¥æ± 
```xml
<dataSource type="POOLED">
  <property name="driver" value="com.mysql.cj.jdbc.Driver"/>
  <property name="url" value="jdbc:mysql://localhost:3306/mydb"/>
  <property name="username" value="root"/>
  <property name="password" value="password"/>
  <property name="poolMaximumActiveConnections" value="10"/>
  <property name="poolMaximumIdleConnections" value="5"/>
</dataSource>
```

3. **JNDI**ï¼šé€šè¿‡JNDIæŸ¥æ‰¾æ•°æ®æºï¼Œä¸»è¦ç”¨äºåº”ç”¨æœåŠ¡å™¨ç¯å¢ƒ
```xml
<dataSource type="JNDI">
  <property name="data_source" value="java:comp/env/jdbc/MyDataSource"/>
</dataSource>
```

</TabItem>
</Tabs>

åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œå¯ä»¥é€šè¿‡åœ¨æ„å»ºSqlSessionFactoryæ—¶æŒ‡å®šç¯å¢ƒIDæ¥é€‰æ‹©ä½¿ç”¨å“ªä¸ªç¯å¢ƒï¼š

```java
String resource = "mybatis-config.xml";
InputStream inputStream = Resources.getResourceAsStream(resource);
// ä½¿ç”¨productionç¯å¢ƒ
SqlSessionFactory factory = new SqlSessionFactoryBuilder().build(inputStream, "production");
```

### 2.3 ç±»å‹å¤„ç†å™¨ä¸åˆ«å

ç±»å‹åˆ«åå’Œç±»å‹å¤„ç†å™¨æ˜¯MyBatisç®€åŒ–ä»£ç å’Œæ‰©å±•ç±»å‹è½¬æ¢èƒ½åŠ›çš„ä¸¤ä¸ªé‡è¦æœºåˆ¶ã€‚

<Tabs>
<TabItem value="aliases" label="ç±»å‹åˆ«å">

ç±»å‹åˆ«åä¸ºJavaç±»å‹è®¾ç½®ä¸€ä¸ªç®€çŸ­çš„åå­—ï¼Œå‡å°‘å†—é•¿ç±»åçš„é‡å¤è¾“å…¥ã€‚

```xml title="ç±»å‹åˆ«åé…ç½®"
<typeAliases>
  <!-- å•ä¸ªåˆ«åå®šä¹‰ -->
  <typeAlias alias="User" type="com.example.model.User"/>
  
  <!-- æ‰¹é‡å®šä¹‰åŒ…ä¸‹æ‰€æœ‰ç±»çš„åˆ«å -->
  <package name="com.example.model"/>
</typeAliases>
```

MyBatiså†…ç½®äº†å¸¸è§Javaç±»å‹çš„åˆ«åï¼š

| åˆ«å | æ˜ å°„çš„ç±»å‹ |
|-----|-----------|
| string | String |
| long | Long |
| int | Integer |
| boolean | Boolean |
| date | Date |
| decimal | BigDecimal |
| map | Map |
| list | List |

</TabItem>
<TabItem value="handlers" label="ç±»å‹å¤„ç†å™¨">

ç±»å‹å¤„ç†å™¨ç”¨äºJavaç±»å‹ä¸JDBCç±»å‹ä¹‹é—´çš„è½¬æ¢ï¼ŒMyBatiså†…ç½®äº†å¸¸è§ç±»å‹çš„å¤„ç†å™¨ï¼Œä¹Ÿæ”¯æŒè‡ªå®šä¹‰ï¼š

```xml title="ç±»å‹å¤„ç†å™¨é…ç½®"
<typeHandlers>
  <!-- æ³¨å†Œå•ä¸ªç±»å‹å¤„ç†å™¨ -->
  <typeHandler handler="com.example.handler.JsonTypeHandler" javaType="Object" jdbcType="VARCHAR"/>
  
  <!-- æ³¨å†ŒåŒ…ä¸­æ‰€æœ‰ç±»å‹å¤„ç†å™¨ -->
  <package name="com.example.handler"/>
</typeHandlers>
```

è‡ªå®šä¹‰ç±»å‹å¤„ç†å™¨ç¤ºä¾‹ï¼š

```java title="è‡ªå®šä¹‰JSONç±»å‹å¤„ç†å™¨"
public class JsonTypeHandler<T> extends BaseTypeHandler<T> {
    private Class<T> clazz;
    private ObjectMapper objectMapper = new ObjectMapper();
    
    public JsonTypeHandler(Class<T> clazz) {
        this.clazz = clazz;
    }
    
    @Override
    public void setNonNullParameter(PreparedStatement ps, int i, T parameter, JdbcType jdbcType) throws SQLException {
        try {
            ps.setString(i, objectMapper.writeValueAsString(parameter));
        } catch (JsonProcessingException e) {
            throw new SQLException("Error converting JSON", e);
        }
    }
    
    @Override
    public T getNullableResult(ResultSet rs, String columnName) throws SQLException {
        return parseJson(rs.getString(columnName));
    }
    
    @Override
    public T getNullableResult(ResultSet rs, int columnIndex) throws SQLException {
        return parseJson(rs.getString(columnIndex));
    }
    
    @Override
    public T getNullableResult(CallableStatement cs, int columnIndex) throws SQLException {
        return parseJson(cs.getString(columnIndex));
    }
    
    private T parseJson(String json) throws SQLException {
        if (json == null) return null;
        try {
            return objectMapper.readValue(json, clazz);
        } catch (IOException e) {
            throw new SQLException("Error parsing JSON", e);
        }
    }
}
```

</TabItem>
</Tabs>

### 2.4 æ’ä»¶ä¸æ—¥å¿—é…ç½®

MyBatisæä¾›äº†å¼ºå¤§çš„æ’ä»¶æœºåˆ¶å’Œçµæ´»çš„æ—¥å¿—é…ç½®ï¼Œå¯ä»¥æ‰©å±•æ ¸å¿ƒåŠŸèƒ½å¹¶ç›‘æ§SQLæ‰§è¡Œæƒ…å†µã€‚

<Tabs>
<TabItem value="plugins" label="æ’ä»¶é…ç½®">

MyBatisæ’ä»¶æ˜¯é€šè¿‡æ‹¦æˆªå™¨æ¨¡å¼å®ç°çš„ï¼Œå¯ä»¥æ‹¦æˆªæ ¸å¿ƒç»„ä»¶çš„æ–¹æ³•è°ƒç”¨ï¼š

```xml title="æ’ä»¶é…ç½®"
<plugins>
  <!-- åˆ†é¡µæ’ä»¶ -->
  <plugin interceptor="com.github.pagehelper.PageInterceptor">
    <property name="helperDialect" value="mysql"/>
    <property name="reasonable" value="true"/>
  </plugin>
  
  <!-- SQLæ€§èƒ½ç›‘æ§æ’ä»¶ -->
  <plugin interceptor="com.example.plugin.SqlPerformanceInterceptor">
    <property name="slowSqlThreshold" value="1000"/>
  </plugin>
</plugins>
```

è‡ªå®šä¹‰æ’ä»¶éœ€è¦å®ç°Interceptoræ¥å£ï¼Œå¹¶é€šè¿‡@Interceptsæ³¨è§£æŒ‡å®šæ‹¦æˆªç‚¹ï¼š

```java title="SQLæ‰§è¡Œæ—¶é—´ç›‘æ§æ’ä»¶"
@Intercepts({
    @Signature(type = Executor.class, method = "update", args = {MappedStatement.class, Object.class}),
    @Signature(type = Executor.class, method = "query", args = {MappedStatement.class, Object.class, RowBounds.class, ResultHandler.class})
})
public class SqlPerformanceInterceptor implements Interceptor {
    private long slowSqlThreshold;
    
    @Override
    public Object intercept(Invocation invocation) throws Throwable {
        MappedStatement ms = (MappedStatement) invocation.getArgs()[0];
        Object parameter = invocation.getArgs()[1];
        
        BoundSql boundSql = ms.getBoundSql(parameter);
        String sql = boundSql.getSql();
        
        long start = System.currentTimeMillis();
        Object result = invocation.proceed();
        long end = System.currentTimeMillis();
        long time = end - start;
        
        if (time > slowSqlThreshold) {
            String logMsg = String.format("Slow SQL: %s, Time: %dms", sql, time);
            System.err.println(logMsg);
        }
        
        return result;
    }
    
    @Override
    public Object plugin(Object target) {
        return Plugin.wrap(target, this);
    }
    
    @Override
    public void setProperties(Properties properties) {
        this.slowSqlThreshold = Long.parseLong(properties.getProperty("slowSqlThreshold", "1000"));
    }
}
```

</TabItem>
<TabItem value="logging" label="æ—¥å¿—é…ç½®">

MyBatisæ”¯æŒå¤šç§æ—¥å¿—æ¡†æ¶ï¼ŒæŒ‰ç…§æŸ¥æ‰¾é¡ºåºæ’åˆ—ï¼šSLF4J â†’ Log4j2 â†’ Log4j â†’ JDK logging

```xml title="æ—¥å¿—é…ç½®"
<settings>
  <!-- æŒ‡å®šæ—¥å¿—å®ç° -->
  <setting name="logImpl" value="SLF4J"/>
  
  <!-- æ—¥å¿—å‰ç¼€ -->
  <setting name="logPrefix" value="MyBatis"/>
</settings>
```

é’ˆå¯¹ç‰¹å®šMapperæˆ–è¯­å¥çš„è¯¦ç»†æ—¥å¿—é…ç½®ï¼š

```xml title="æ—¥å¿—çº§åˆ«é…ç½® (log4j2.xml)"
<Loggers>
  <!-- ä¸ºç‰¹å®šMapperè®¾ç½®æ—¥å¿—çº§åˆ« -->
  <Logger name="com.example.mapper.UserMapper" level="TRACE"/>
  
  <!-- ä¸ºæ‰€æœ‰MyBatis SQLæ—¥å¿—è®¾ç½®çº§åˆ« -->
  <Logger name="org.apache.ibatis" level="DEBUG"/>
</Loggers>
```

é€šè¿‡è®¾ç½®æ—¥å¿—çº§åˆ«ä¸ºTRACEï¼Œå¯ä»¥çœ‹åˆ°ä»¥ä¸‹è¯¦ç»†ä¿¡æ¯ï¼š
- SQLè¯­å¥
- å‚æ•°å€¼
- è¿”å›ç»“æœ
- æ€§èƒ½ç»Ÿè®¡

</TabItem>
</Tabs>

:::tip é…ç½®æœ€ä½³å®è·µ
1. **å±æ€§å¤–éƒ¨åŒ–**ï¼šä½¿ç”¨propertiesæ–‡ä»¶å­˜å‚¨æ•°æ®åº“è¿æ¥ä¿¡æ¯
2. **çµæ´»ç¯å¢ƒé…ç½®**ï¼šä¸ºä¸åŒç¯å¢ƒï¼ˆå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ï¼‰é…ç½®ä¸åŒæ•°æ®æº
3. **å¯ç”¨é©¼å³°å‘½åæ˜ å°„**ï¼šè®¾ç½®mapUnderscoreToCamelCaseä¸ºtrue
4. **åˆç†ä½¿ç”¨ç¼“å­˜**ï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚é…ç½®äºŒçº§ç¼“å­˜
5. **é€‚å½“çš„æ—¥å¿—çº§åˆ«**ï¼šå¼€å‘ç¯å¢ƒä½¿ç”¨DEBUGçº§åˆ«ï¼Œç”Ÿäº§ç¯å¢ƒä½¿ç”¨INFOçº§åˆ«
:::

## 3. æ˜ å°„æ–‡ä»¶ä¸SQLæ„å»º

MyBatisçš„æ ¸å¿ƒåŠŸèƒ½æ˜¯å°†SQLè¯­å¥ä¸Javaæ–¹æ³•å…³è”èµ·æ¥ï¼Œæä¾›äº†XMLå’Œæ³¨è§£ä¸¤ç§æ–¹å¼æ¥å®šä¹‰SQLæ˜ å°„å…³ç³»ã€‚è¿™ç§åˆ†ç¦»å¼è®¾è®¡ä½¿å¾—SQLè¯­å¥å’ŒJavaä»£ç èƒ½å¤Ÿç‹¬ç«‹ç®¡ç†å’Œä¼˜åŒ–ã€‚

### 3.1 XMLæ˜ å°„æ–‡ä»¶è¯¦è§£

XMLæ˜ å°„æ–‡ä»¶æ˜¯MyBatisä¸­å®šä¹‰SQLè¯­å¥çš„ä¸»è¦æ–¹å¼ï¼Œæä¾›äº†ä¸°å¯Œçš„é…ç½®é€‰é¡¹å’Œçµæ´»çš„è¡¨è¾¾èƒ½åŠ›ã€‚

```mermaid
graph TD
    A[mapper] --> B[cache]
    A --> C[cache-ref]
    A --> D[resultMap]
    D --> D1[id]
    D --> D2[result]
    D --> D3[association]
    D --> D4[collection]
    A --> E[sql]
    A --> F[insert]
    A --> G[update]
    A --> H[delete]
    A --> I[select]
    I --> I1[å‚æ•°æ˜ å°„]
    I --> I2[ç»“æœæ˜ å°„]
    I --> I3[ç¼“å­˜æ§åˆ¶]
```

<CodeBlock language="xml" title="å®Œæ•´çš„XMLæ˜ å°„æ–‡ä»¶ç¤ºä¾‹">
{`<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.mapper.UserMapper">
  <!-- ç¼“å­˜é…ç½® -->
  <cache
    eviction="LRU"
    flushInterval="60000"
    size="512"
    readOnly="false"/>
  
  <!-- å¯é‡ç”¨SQLç‰‡æ®µ -->
  <sql id="Base_Column_List">
    id, username, email, phone, create_time, update_time
  </sql>
  
  <!-- ç»“æœæ˜ å°„ -->
  <resultMap id="UserResultMap" type="com.example.model.User">
    <id property="id" column="id" />
    <result property="username" column="username" />
    <result property="email" column="email" />
    <result property="phone" column="phone" />
    <result property="createTime" column="create_time" />
    <result property="updateTime" column="update_time" />
    <!-- ä¸€å¯¹ä¸€å…³è” -->
    <association property="profile" javaType="com.example.model.UserProfile">
      <id property="id" column="profile_id" />
      <result property="address" column="address" />
      <result property="avatar" column="avatar" />
    </association>
    <!-- ä¸€å¯¹å¤šå…³è” -->
    <collection property="orders" ofType="com.example.model.Order">
      <id property="id" column="order_id" />
      <result property="orderNo" column="order_no" />
      <result property="amount" column="amount" />
    </collection>
  </resultMap>
  
  <!-- æŸ¥è¯¢è¯­å¥ -->
  <select id="getUserById" resultMap="UserResultMap" parameterType="long">
    SELECT 
      u.*, 
      p.id as profile_id, 
      p.address, 
      p.avatar
    FROM user u
    LEFT JOIN user_profile p ON u.id = p.user_id
    WHERE u.id = #{id}
  </select>
  
  <!-- æ’å…¥è¯­å¥ -->
  <insert id="insertUser" parameterType="com.example.model.User" useGeneratedKeys="true" keyProperty="id">
    INSERT INTO user (username, email, phone, create_time)
    VALUES (#{username}, #{email}, #{phone}, #{createTime})
  </insert>
  
  <!-- æ›´æ–°è¯­å¥ -->
  <update id="updateUser" parameterType="com.example.model.User">
    UPDATE user
    SET username = #{username},
        email = #{email},
        phone = #{phone},
        update_time = #{updateTime}
    WHERE id = #{id}
  </update>
  
  <!-- åˆ é™¤è¯­å¥ -->
  <delete id="deleteUser" parameterType="long">
    DELETE FROM user WHERE id = #{id}
  </delete>
</mapper>`}
</CodeBlock>

<Tabs>
<TabItem value="select" label="æŸ¥è¯¢è¯­å¥">

æŸ¥è¯¢è¯­å¥æ˜¯æœ€å¸¸ç”¨çš„SQLæ“ä½œï¼ŒMyBatisæä¾›äº†ä¸°å¯Œçš„é…ç½®é€‰é¡¹ï¼š

```xml title="æŸ¥è¯¢è¯­å¥è¯¦è§£"
<select 
    id="findUserByCondition"          <!-- å”¯ä¸€æ ‡è¯†ï¼Œå¯¹åº”Mapperæ¥å£æ–¹æ³•å -->
    parameterType="map"               <!-- å‚æ•°ç±»å‹ -->
    resultType="User"                 <!-- ç»“æœç±»å‹ -->
    resultMap="UserResultMap"         <!-- ç»“æœæ˜ å°„å¼•ç”¨ -->
    flushCache="false"                <!-- æ˜¯å¦åˆ·æ–°ç¼“å­˜ -->
    useCache="true"                   <!-- æ˜¯å¦ä½¿ç”¨ç¼“å­˜ -->
    timeout="10000"                   <!-- è¶…æ—¶æ—¶é—´(æ¯«ç§’) -->
    fetchSize="100"                   <!-- ç»“æœé›†å¤§å° -->
    statementType="PREPARED"          <!-- è¯­å¥ç±»å‹(STATEMENT/PREPARED/CALLABLE) -->
    resultSetType="FORWARD_ONLY">     <!-- ç»“æœé›†ç±»å‹ -->
  SELECT 
    <include refid="Base_Column_List"/>
  FROM user
  <where>
    <if test="username != null">
      username LIKE CONCAT('%', #{username}, '%')
    </if>
    <if test="email != null">
      AND email = #{email}
    </if>
    <if test="startTime != null">
      AND create_time >= #{startTime}
    </if>
  </where>
  ORDER BY create_time DESC
  LIMIT #{offset}, #{limit}
</select>
```

</TabItem>
<TabItem value="insert" label="æ’å…¥è¯­å¥">

æ’å…¥è¯­å¥ç”¨äºå‘æ•°æ®åº“æ·»åŠ è®°å½•ï¼Œæ”¯æŒè‡ªåŠ¨ç”Ÿæˆä¸»é”®ï¼š

```xml title="æ’å…¥è¯­å¥è¯¦è§£"
<insert 
    id="insertUser"                   <!-- å”¯ä¸€æ ‡è¯† -->
    parameterType="User"              <!-- å‚æ•°ç±»å‹ -->
    flushCache="true"                 <!-- æ˜¯å¦åˆ·æ–°ç¼“å­˜ -->
    timeout="20000"                   <!-- è¶…æ—¶æ—¶é—´(æ¯«ç§’) -->
    useGeneratedKeys="true"           <!-- æ˜¯å¦ä½¿ç”¨è‡ªåŠ¨ç”Ÿæˆçš„ä¸»é”® -->
    keyProperty="id"                  <!-- è‡ªåŠ¨ç”Ÿæˆçš„ä¸»é”®èµ‹å€¼ç»™å‚æ•°å¯¹è±¡çš„å±æ€§ -->
    keyColumn="id">                   <!-- è‡ªåŠ¨ç”Ÿæˆä¸»é”®çš„åˆ—å -->
  INSERT INTO user (
    username, 
    email, 
    password,
    status,
    create_time
  ) VALUES (
    #{username},
    #{email},
    #{password},
    #{status},
    #{createTime}
  )
</insert>

<!-- æ‰¹é‡æ’å…¥ -->
<insert id="batchInsertUsers" parameterType="list">
  INSERT INTO user (username, email, password, status, create_time)
  VALUES 
  <foreach collection="list" item="user" separator=",">
    (#{user.username}, #{user.email}, #{user.password}, #{user.status}, #{user.createTime})
  </foreach>
</insert>
```

</TabItem>
<TabItem value="update" label="æ›´æ–°è¯­å¥">

æ›´æ–°è¯­å¥ç”¨äºä¿®æ”¹æ•°æ®åº“è®°å½•ï¼š

```xml title="æ›´æ–°è¯­å¥è¯¦è§£"
<update 
    id="updateUser"                   <!-- å”¯ä¸€æ ‡è¯† -->
    parameterType="User"              <!-- å‚æ•°ç±»å‹ -->
    flushCache="true"                 <!-- æ˜¯å¦åˆ·æ–°ç¼“å­˜ -->
    timeout="20000">                  <!-- è¶…æ—¶æ—¶é—´(æ¯«ç§’) -->
  UPDATE user
  <set>
    <if test="username != null">username = #{username},</if>
    <if test="email != null">email = #{email},</if>
    <if test="password != null">password = #{password},</if>
    <if test="status != null">status = #{status},</if>
    update_time = #{updateTime}
  </set>
  WHERE id = #{id}
</update>

<!-- æ‰¹é‡æ›´æ–° -->
<update id="batchUpdateStatus" parameterType="map">
  UPDATE user
  SET status = #{status}
  WHERE id IN 
  <foreach collection="ids" item="id" open="(" separator="," close=")">
    #{id}
  </foreach>
</update>
```

</TabItem>
<TabItem value="delete" label="åˆ é™¤è¯­å¥">

åˆ é™¤è¯­å¥ç”¨äºåˆ é™¤æ•°æ®åº“è®°å½•ï¼š

```xml title="åˆ é™¤è¯­å¥è¯¦è§£"
<delete 
    id="deleteUser"                   <!-- å”¯ä¸€æ ‡è¯† -->
    parameterType="long"              <!-- å‚æ•°ç±»å‹ -->
    flushCache="true"                 <!-- æ˜¯å¦åˆ·æ–°ç¼“å­˜ -->
    timeout="20000">                  <!-- è¶…æ—¶æ—¶é—´(æ¯«ç§’) -->
  DELETE FROM user
  WHERE id = #{id}
</delete>

<!-- æ‰¹é‡åˆ é™¤ -->
<delete id="batchDeleteUsers" parameterType="list">
  DELETE FROM user
  WHERE id IN
  <foreach collection="list" item="id" open="(" separator="," close=")">
    #{id}
  </foreach>
</delete>
```

</TabItem>
</Tabs>

### 3.2 æ³¨è§£æ˜ å°„æ–¹å¼

MyBatisæ”¯æŒä½¿ç”¨Javaæ³¨è§£æ¥å®šä¹‰SQLæ˜ å°„ï¼Œé€‚åˆäºç®€å•çš„SQLè¯­å¥ï¼Œä¸éœ€è¦XMLæ–‡ä»¶ã€‚

```java title="æ³¨è§£æ˜ å°„ç¤ºä¾‹"
public interface UserMapper {
    
    @Select("SELECT * FROM user WHERE id = #{id}")
    User getUserById(Long id);
    
    @Insert("INSERT INTO user (username, email, phone, create_time) " +
           "VALUES (#{username}, #{email}, #{phone}, #{createTime})")
    @Options(useGeneratedKeys = true, keyProperty = "id")
    int insertUser(User user);
    
    @Update("UPDATE user SET username = #{username}, email = #{email}, " +
           "phone = #{phone}, update_time = #{updateTime} WHERE id = #{id}")
    int updateUser(User user);
    
    @Delete("DELETE FROM user WHERE id = #{id}")
    int deleteUser(Long id);
    
    // ç»“æœæ˜ å°„
    @Select("SELECT * FROM user WHERE id = #{id}")
    @Results(id = "userResultMap", value = {
        @Result(property = "id", column = "id", id = true),
        @Result(property = "username", column = "username"),
        @Result(property = "email", column = "email"),
        @Result(property = "createTime", column = "create_time"),
        @Result(property = "updateTime", column = "update_time")
    })
    User getUserWithMapping(Long id);
    
    // ä¸€å¯¹ä¸€å…³è”
    @Select("SELECT u.*, p.id as profile_id, p.address, p.avatar FROM user u " +
           "LEFT JOIN user_profile p ON u.id = p.user_id WHERE u.id = #{id}")
    @Results({
        @Result(property = "id", column = "id", id = true),
        @Result(property = "username", column = "username"),
        @Result(property = "email", column = "email"),
        @Result(property = "profile", javaType = UserProfile.class, 
                column = "id", one = @One(select = "getProfileByUserId"))
    })
    User getUserWithProfile(Long id);
    
    @Select("SELECT * FROM user_profile WHERE user_id = #{userId}")
    UserProfile getProfileByUserId(Long userId);
    
    // ä¸€å¯¹å¤šå…³è”
    @Select("SELECT * FROM user WHERE id = #{id}")
    @Results({
        @Result(property = "id", column = "id", id = true),
        @Result(property = "username", column = "username"),
        @Result(property = "orders", javaType = List.class, 
                column = "id", many = @Many(select = "getOrdersByUserId"))
    })
    User getUserWithOrders(Long id);
    
    @Select("SELECT * FROM orders WHERE user_id = #{userId}")
    List<Order> getOrdersByUserId(Long userId);
}
```

### 3.3 ä¸¤ç§æ˜ å°„æ–¹å¼å¯¹æ¯”

XMLæ˜ å°„å’Œæ³¨è§£æ˜ å°„å„æœ‰ä¼˜ç¼ºç‚¹ï¼Œé€‰æ‹©åˆé€‚çš„æ–¹å¼å–å†³äºé¡¹ç›®éœ€æ±‚å’Œå›¢é˜Ÿåå¥½ã€‚

| ç‰¹æ€§ | XMLæ˜ å°„ | æ³¨è§£æ˜ å°„ | è¯´æ˜ |
|-----|---------|---------|------|
| **å¯è¯»æ€§** | â­â­â­â­â­ | â­â­â­ | XMLæ›´é€‚åˆå¤§å‹å¤æ‚SQL |
| **ç»´æŠ¤æ€§** | â­â­â­â­ | â­â­â­ | XMLåˆ†ç¦»SQLä¸ä»£ç ï¼Œæ›´æ˜“ç»´æŠ¤ |
| **åŠ¨æ€SQL** | â­â­â­â­â­ | â­â­ | XMLå¯¹åŠ¨æ€SQLæ”¯æŒæ›´å…¨é¢ |
| **å¤æ‚æ˜ å°„** | â­â­â­â­â­ | â­â­â­ | XMLé€‚åˆå¤æ‚ç»“æœæ˜ å°„ |
| **å¼€å‘æ•ˆç‡** | â­â­â­ | â­â­â­â­â­ | æ³¨è§£ç®€å•å¿«æ· |
| **SQLé‡ç”¨** | â­â­â­â­â­ | â­â­ | XMLå¯æå–å…¬å…±SQLç‰‡æ®µ |
| **ç¼–è¯‘æ—¶æ£€æŸ¥** | â­â­ | â­â­â­â­ | æ³¨è§£å¯åœ¨ç¼–è¯‘æ—¶æ£€æŸ¥ |
| **é€‚ç”¨åœºæ™¯** | å¤æ‚SQLï¼Œå¤šè¡¨å…³è” | ç®€å•CRUDï¼Œå•è¡¨æ“ä½œ | - |

:::tip æœ€ä½³å®è·µå»ºè®®
1. **æ··åˆä½¿ç”¨**ï¼šæ ¹æ®SQLå¤æ‚åº¦é€‰æ‹©åˆé€‚çš„æ–¹å¼
2. **ç®€å•æ“ä½œ**ï¼šå•è¡¨çš„CRUDæ“ä½œä½¿ç”¨æ³¨è§£
3. **å¤æ‚æŸ¥è¯¢**ï¼šå¤šè¡¨å…³è”ã€åŠ¨æ€æ¡ä»¶ä½¿ç”¨XML
4. **å›¢é˜Ÿç»Ÿä¸€**ï¼šé¡¹ç›®ä¸­ä¿æŒä¸€è‡´çš„é£æ ¼ï¼Œé¿å…æ··ä¹±
:::

### 3.4 SQLæ„å»ºå™¨ä½¿ç”¨

å¯¹äºä¸­ç­‰å¤æ‚åº¦çš„SQLï¼ŒMyBatisæä¾›äº†SQLæ„å»ºå™¨APIï¼Œå¯ä»¥é€šè¿‡Javaä»£ç åŠ¨æ€æ„å»ºSQLè¯­å¥ï¼Œæ¯”XMLæ›´çµæ´»ï¼Œæ¯”æ³¨è§£æ›´å¼ºå¤§ã€‚

```java title="SQLæ„å»ºå™¨ç¤ºä¾‹"
public interface UserMapper {
    
    @SelectProvider(type = UserSqlProvider.class, method = "findByCondition")
    List<User> findByCondition(UserQuery query);
    
    @InsertProvider(type = UserSqlProvider.class, method = "insert")
    @Options(useGeneratedKeys = true, keyProperty = "id")
    int insert(User user);
    
    @UpdateProvider(type = UserSqlProvider.class, method = "update")
    int update(User user);
    
    @DeleteProvider(type = UserSqlProvider.class, method = "deleteById")
    int deleteById(Long id);
}

class UserSqlProvider {
    
    public String findByCondition(UserQuery query) {
        return new SQL() {{
            SELECT("id, username, email, phone, status, create_time, update_time");
            FROM("user");
            
            if (query.getUsername() != null) {
                WHERE("username LIKE CONCAT('%', #{username}, '%')");
            }
            
            if (query.getStatus() != null) {
                WHERE("status = #{status}");
            }
            
            if (query.getStartTime() != null) {
                WHERE("create_time >= #{startTime}");
            }
            
            if (query.getEndTime() != null) {
                WHERE("create_time <= #{endTime}");
            }
            
            ORDER_BY("create_time DESC");
        }}.toString();
    }
    
    public String insert(User user) {
        return new SQL() {{
            INSERT_INTO("user");
            VALUES("username", "#{username}");
            VALUES("email", "#{email}");
            VALUES("phone", "#{phone}");
            VALUES("password", "#{password}");
            VALUES("status", "#{status}");
            VALUES("create_time", "#{createTime}");
        }}.toString();
    }
    
    public String update(User user) {
        return new SQL() {{
            UPDATE("user");
            
            if (user.getUsername() != null) {
                SET("username = #{username}");
            }
            
            if (user.getEmail() != null) {
                SET("email = #{email}");
            }
            
            if (user.getPhone() != null) {
                SET("phone = #{phone}");
            }
            
            if (user.getStatus() != null) {
                SET("status = #{status}");
            }
            
            SET("update_time = #{updateTime}");
            WHERE("id = #{id}");
        }}.toString();
    }
    
    public String deleteById(Long id) {
        return new SQL() {{
            DELETE_FROM("user");
            WHERE("id = #{id}");
        }}.toString();
    }
}
```

SQLæ„å»ºå™¨APIçš„ä¸»è¦ä¼˜åŠ¿ï¼š

1. **ç±»å‹å®‰å…¨**ï¼šä½¿ç”¨Javaä»£ç æ„å»ºSQLï¼Œå¯ä»¥åœ¨ç¼–è¯‘æ—¶æ£€æŸ¥
2. **ä»£ç é‡ç”¨**ï¼šå¯ä»¥å°è£…å¸¸ç”¨çš„SQLç‰‡æ®µä¸ºæ–¹æ³•
3. **çµæ´»åŠ¨æ€**ï¼šæ¯”æ³¨è§£æ›´çµæ´»ï¼Œæ¯”XMLæ›´ç›´è§‚
4. **æ˜“äºè°ƒè¯•**ï¼šå¯ä»¥åœ¨æ„å»ºè¿‡ç¨‹ä¸­æ·»åŠ æ—¥å¿—æˆ–æ–­ç‚¹

SQLæ„å»ºå™¨çš„æ–¹æ³•åˆ—è¡¨ï¼š

- `SELECT(String)`: æ·»åŠ åˆ—åˆ°SELECTå­å¥
- `SELECT_DISTINCT(String)`: æ·»åŠ DISTINCTåˆ—åˆ°SELECTå­å¥
- `FROM(String)`: æ·»åŠ è¡¨åˆ°FROMå­å¥
- `JOIN(String)`: æ·»åŠ JOINå­å¥
- `INNER_JOIN(String)`: æ·»åŠ INNER JOINå­å¥
- `LEFT_OUTER_JOIN(String)`: æ·»åŠ LEFT OUTER JOINå­å¥
- `RIGHT_OUTER_JOIN(String)`: æ·»åŠ RIGHT OUTER JOINå­å¥
- `WHERE(String)`: æ·»åŠ WHEREæ¡ä»¶
- `OR()`: æ·»åŠ ORè¿æ¥ç¬¦
- `AND()`: æ·»åŠ ANDè¿æ¥ç¬¦
- `GROUP_BY(String)`: æ·»åŠ GROUP BYå­å¥
- `HAVING(String)`: æ·»åŠ HAVINGæ¡ä»¶
- `ORDER_BY(String)`: æ·»åŠ ORDER BYå­å¥
- `INSERT_INTO(String)`: è®¾ç½®INSERTç›®æ ‡è¡¨
- `VALUES(String, String)`: æ·»åŠ INSERTå€¼
- `UPDATE(String)`: è®¾ç½®UPDATEç›®æ ‡è¡¨
- `SET(String)`: æ·»åŠ SETå­å¥
- `DELETE_FROM(String)`: è®¾ç½®DELETEç›®æ ‡è¡¨

## 4. åŠ¨æ€SQLä¸å¤æ‚æŸ¥è¯¢

åŠ¨æ€SQLæ˜¯MyBatisæœ€å¼ºå¤§çš„ç‰¹æ€§ä¹‹ä¸€ï¼Œå…è®¸æ ¹æ®å‚æ•°æ¡ä»¶åŠ¨æ€ç”Ÿæˆä¸åŒçš„SQLè¯­å¥ï¼Œæå¤§åœ°ç®€åŒ–äº†å¤æ‚æŸ¥è¯¢çš„æ„å»ºè¿‡ç¨‹ã€‚

```mermaid
graph LR
    A[åŠ¨æ€SQLæ ‡ç­¾] --> B[if]
    A --> C[choose/when/otherwise]
    A --> D[where]
    A --> E[set]
    A --> F[trim]
    A --> G[foreach]
    A --> H[bind]
```

### 4.1 æ¡ä»¶æŸ¥è¯¢æ„å»º

æ¡ä»¶æŸ¥è¯¢æ˜¯æœ€å¸¸è§çš„åŠ¨æ€SQLåœºæ™¯ï¼ŒMyBatisæä¾›äº†å¤šç§æ ‡ç­¾æ¥å¤„ç†æ¡ä»¶é€»è¾‘ã€‚

<Tabs>
<TabItem value="if" label="ifæ ‡ç­¾">

`if`æ ‡ç­¾æ˜¯æœ€åŸºæœ¬çš„æ¡ä»¶æ ‡ç­¾ï¼Œæ ¹æ®æµ‹è¯•æ¡ä»¶å†³å®šæ˜¯å¦åŒ…å«æ ‡ç­¾ä½“å†…çš„SQLç‰‡æ®µï¼š

```xml title="ifæ ‡ç­¾ç¤ºä¾‹"
<select id="findUsers" resultType="User">
  SELECT * FROM user
  WHERE 1=1
  <if test="username != null and username != ''">
    AND username LIKE CONCAT('%', #{username}, '%')
  </if>
  <if test="status != null">
    AND status = #{status}
  </if>
  <if test="startDate != null">
    AND create_time >= #{startDate}
  </if>
  <if test="endDate != null">
    AND create_time <= #{endDate}
  </if>
</select>
```

</TabItem>
<TabItem value="where" label="whereæ ‡ç­¾">

`where`æ ‡ç­¾ä¼šæ™ºèƒ½å¤„ç†æ¡ä»¶è¯­å¥ï¼Œè‡ªåŠ¨æ·»åŠ WHEREå…³é”®å­—ï¼Œå¹¶å»é™¤å¤šä½™çš„AND/ORå‰ç¼€ï¼š

```xml title="whereæ ‡ç­¾ç¤ºä¾‹"
<select id="findUsers" resultType="User">
  SELECT * FROM user
  <where>
    <if test="username != null and username != ''">
      username LIKE CONCAT('%', #{username}, '%')
    </if>
    <if test="status != null">
      AND status = #{status}
    </if>
    <if test="startDate != null">
      AND create_time >= #{startDate}
    </if>
    <if test="endDate != null">
      AND create_time <= #{endDate}
    </if>
  </where>
</select>
```

</TabItem>
<TabItem value="choose" label="chooseæ ‡ç­¾">

`choose`æ ‡ç­¾ç±»ä¼¼äºJavaä¸­çš„switchè¯­å¥ï¼Œæä¾›å¤šä¸ªæ¡ä»¶ä¸­é€‰æ‹©ä¸€ä¸ªçš„èƒ½åŠ›ï¼š

```xml title="chooseæ ‡ç­¾ç¤ºä¾‹"
<select id="findUsersBySort" resultType="User">
  SELECT * FROM user
  <where>
    <if test="status != null">
      status = #{status}
    </if>
  </where>
  <choose>
    <when test="sortBy == 'username'">
      ORDER BY username
    </when>
    <when test="sortBy == 'createTime'">
      ORDER BY create_time
    </when>
    <otherwise>
      ORDER BY id
    </otherwise>
  </choose>
</select>
```

</TabItem>
<TabItem value="trim" label="trimæ ‡ç­¾">

`trim`æ ‡ç­¾æä¾›äº†æ›´çµæ´»çš„å‰ç¼€/åç¼€å¤„ç†èƒ½åŠ›ï¼š

```xml title="trimæ ‡ç­¾ç¤ºä¾‹"
<select id="findUsers" resultType="User">
  SELECT * FROM user
  <trim prefix="WHERE" prefixOverrides="AND|OR">
    <if test="username != null and username != ''">
      AND username LIKE CONCAT('%', #{username}, '%')
    </if>
    <if test="status != null">
      AND status = #{status}
    </if>
  </trim>
</select>
```

</TabItem>
</Tabs>

OGNLè¡¨è¾¾å¼æ˜¯MyBatisåŠ¨æ€SQLçš„æ ¸å¿ƒï¼Œç”¨äºæ¡ä»¶æµ‹è¯•å’Œå‚æ•°è®¿é—®ï¼š

| OGNLè¡¨è¾¾å¼ | æè¿° | ç¤ºä¾‹ |
|-----------|------|------|
| å±æ€§è®¿é—® | è®¿é—®JavaBeanå±æ€§ | `username != null` |
| åµŒå¥—å±æ€§ | è®¿é—®åµŒå¥—å±æ€§ | `user.address.city == 'Beijing'` |
| é›†åˆè®¿é—® | è®¿é—®List/Mapå…ƒç´  | `users[0].name == 'admin'` |
| æ–¹æ³•è°ƒç”¨ | è°ƒç”¨å¯¹è±¡æ–¹æ³• | `username.length() > 5` |
| é™æ€æ–¹æ³• | è°ƒç”¨é™æ€æ–¹æ³• | `@java.lang.Math@max(id1, id2)` |
| é€»è¾‘è¿ç®—ç¬¦ | é€»è¾‘ç»„åˆ | `age > 18 and age < 60` |
| ä¸‰å…ƒè¿ç®—ç¬¦ | æ¡ä»¶é€‰æ‹© | `isVip ? price*0.8 : price` |

### 4.2 å¾ªç¯ä¸æ‰¹é‡æ“ä½œ

`foreach`æ ‡ç­¾æ˜¯å¤„ç†é›†åˆå‚æ•°çš„å¼ºå¤§å·¥å…·ï¼Œé€‚ç”¨äºINæ¡ä»¶ã€æ‰¹é‡æ’å…¥ç­‰åœºæ™¯ã€‚

<Tabs>
<TabItem value="in" label="INæ¡ä»¶æŸ¥è¯¢">

```xml title="INæ¡ä»¶æŸ¥è¯¢"
<select id="findUsersByIds" resultType="User">
  SELECT * FROM user
  WHERE id IN
  <foreach collection="list" item="id" open="(" separator="," close=")">
    #{id}
  </foreach>
</select>
```

</TabItem>
<TabItem value="batch-insert" label="æ‰¹é‡æ’å…¥">

```xml title="æ‰¹é‡æ’å…¥"
<insert id="batchInsert" parameterType="list">
  INSERT INTO user (username, email, status, create_time)
  VALUES
  <foreach collection="list" item="user" separator=",">
    (#{user.username}, #{user.email}, #{user.status}, #{user.createTime})
  </foreach>
</insert>
```

</TabItem>
<TabItem value="batch-update" label="æ‰¹é‡æ›´æ–°">

```xml title="æ‰¹é‡æ›´æ–°"
<update id="batchUpdate" parameterType="list">
  <foreach collection="list" item="item" separator=";">
    UPDATE user
    <set>
      username = #{item.username},
      email = #{item.email},
      update_time = #{item.updateTime}
    </set>
    WHERE id = #{item.id}
  </foreach>
</update>
```

</TabItem>
<TabItem value="complex-param" label="å¤æ‚å‚æ•°å¤„ç†">

```xml title="å¤æ‚å‚æ•°å¤„ç†"
<select id="findUsersByFilter" resultType="User">
  SELECT * FROM user
  <where>
    <if test="filter.nameList != null and filter.nameList.size() > 0">
      username IN
      <foreach collection="filter.nameList" item="name" open="(" separator="," close=")">
        #{name}
      </foreach>
    </if>
    <if test="filter.statusMap != null and filter.statusMap.size() > 0">
      AND
      <foreach collection="filter.statusMap" index="key" item="value" open="(" separator="OR" close=")">
        (${key} = #{value})
      </foreach>
    </if>
  </where>
</select>
```

</TabItem>
</Tabs>

foreachæ ‡ç­¾çš„å±æ€§è§£æï¼š

- `collection`: è¦è¿­ä»£çš„é›†åˆåç§°ï¼ˆlistã€arrayã€mapç­‰ï¼‰
- `item`: å½“å‰è¿­ä»£çš„å…ƒç´ 
- `index`: å½“å‰è¿­ä»£çš„ç´¢å¼•ï¼ˆListï¼‰æˆ–é”®ï¼ˆMapï¼‰
- `open`: æ‹¼æ¥å¼€å§‹çš„å­—ç¬¦ä¸²
- `close`: æ‹¼æ¥ç»“æŸçš„å­—ç¬¦ä¸²
- `separator`: å…ƒç´ ä¹‹é—´çš„åˆ†éš”ç¬¦

### 4.3 åŠ¨æ€è¡¨åä¸åˆ—å

åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œéœ€è¦åŠ¨æ€æŒ‡å®šè¡¨åæˆ–åˆ—åï¼ŒMyBatisä¹Ÿæä¾›äº†ç›¸åº”çš„è§£å†³æ–¹æ¡ˆã€‚

:::warning æ³¨æ„
åŠ¨æ€è¡¨åå’Œåˆ—åä½¿ç”¨`${}`è¯­æ³•ï¼Œä¼šæœ‰SQLæ³¨å…¥é£é™©ï¼Œå¿…é¡»ç¡®ä¿å‚æ•°æ¥æºå®‰å…¨å¯æ§ï¼
:::

<Tabs>
<TabItem value="table" label="åŠ¨æ€è¡¨å">

```xml title="åŠ¨æ€è¡¨å"
<select id="selectFromTable" resultType="map">
  SELECT * FROM ${tableName} WHERE id = #{id}
</select>
```

```java
// ä½¿ç”¨ç¤ºä¾‹
Map<String, Object> data = mapper.selectFromTable("user_20230101", 1001);
```

</TabItem>
<TabItem value="column" label="åŠ¨æ€åˆ—å">

```xml title="åŠ¨æ€åˆ—å"
<select id="getUserSortedBy" resultType="User">
  SELECT * FROM user ORDER BY ${columnName} ${order}
</select>
```

```java
// ä½¿ç”¨ç¤ºä¾‹ - å¿…é¡»ç¡®ä¿å‚æ•°å€¼å®‰å…¨
List<User> users = mapper.getUserSortedBy("create_time", "DESC");
```

</TabItem>
<TabItem value="safe-approach" label="å®‰å…¨å¤„ç†æ–¹å¼">

å¯¹äºåŠ¨æ€è¡¨åå’Œåˆ—åï¼Œå»ºè®®ä½¿ç”¨ç™½åå•æ–¹å¼ä¿è¯å®‰å…¨ï¼š

```java title="å®‰å…¨å¤„ç†ç¤ºä¾‹"
public List<User> getUserSortedBy(String columnName, String order) {
    // åˆ—åç™½åå•
    Set<String> allowedColumns = new HashSet<>(Arrays.asList(
        "id", "username", "email", "create_time", "update_time"));
        
    // æ’åºæ–¹å¼ç™½åå•
    Set<String> allowedOrders = new HashSet<>(Arrays.asList("ASC", "DESC"));
    
    // å®‰å…¨æ£€æŸ¥
    if (!allowedColumns.contains(columnName)) {
        columnName = "id"; // é»˜è®¤å€¼
    }
    
    if (!allowedOrders.contains(order.toUpperCase())) {
        order = "ASC"; // é»˜è®¤å€¼
    }
    
    return mapper.getUserSortedBy(columnName, order);
}
```

</TabItem>
<TabItem value="advanced-scenarios" label="é«˜çº§åœºæ™¯">

å¯¹äºæ›´å¤æ‚çš„åŠ¨æ€SQLéœ€æ±‚ï¼Œå¯ä»¥ä½¿ç”¨SQLæ„å»ºå™¨æˆ–è‡ªå®šä¹‰SQLæä¾›è€…ï¼š

```java title="é«˜çº§åŠ¨æ€SQL"
@SelectProvider(type = DynamicQueryProvider.class, method = "buildQuery")
<T> List<T> executeCustomQuery(@Param("table") String table, 
                             @Param("columns") String[] columns,
                             @Param("conditions") Map<String, Object> conditions,
                             @Param("resultType") Class<T> resultType);

public class DynamicQueryProvider {
    public String buildQuery(@Param("table") String table, 
                           @Param("columns") String[] columns,
                           @Param("conditions") Map<String, Object> conditions) {
        // å®‰å…¨æ£€æŸ¥
        validateTable(table);
        validateColumns(columns);
        
        SQL sql = new SQL();
        
        // æ„å»ºæŸ¥è¯¢åˆ—
        if (columns != null && columns.length > 0) {
            for (String column : columns) {
                sql.SELECT(column);
            }
        } else {
            sql.SELECT("*");
        }
        
        // æ·»åŠ è¡¨å
        sql.FROM(table);
        
        // æ·»åŠ æ¡ä»¶
        if (conditions != null && !conditions.isEmpty()) {
            for (Map.Entry<String, Object> entry : conditions.entrySet()) {
                if (entry.getValue() != null) {
                    sql.WHERE(entry.getKey() + " = #{conditions." + entry.getKey() + "}");
                }
            }
        }
        
        return sql.toString();
    }
    
    private void validateTable(String table) {
        // è¡¨åç™½åå•æ£€æŸ¥
        Set<String> allowedTables = new HashSet<>(Arrays.asList(
            "user", "order", "product", "category"));
        if (!allowedTables.contains(table)) {
            throw new IllegalArgumentException("Invalid table name: " + table);
        }
    }
    
    private void validateColumns(String[] columns) {
        // åˆ—åç™½åå•æ£€æŸ¥
        if (columns == null) return;
        
        Set<String> allowedColumns = new HashSet<>(Arrays.asList(
            "id", "name", "price", "create_time", "update_time"));
        for (String column : columns) {
            if (!allowedColumns.contains(column)) {
                throw new IllegalArgumentException("Invalid column name: " + column);
            }
        }
    }
}
```

</TabItem>
</Tabs>

### 4.4 å¤šæ•°æ®åº“æ”¯æŒ

MyBatisæä¾›äº†DatabaseIdProvideræœºåˆ¶ï¼Œå¯ä»¥æ ¹æ®ä¸åŒæ•°æ®åº“ç±»å‹é€‰æ‹©ä¸åŒçš„SQLè¯­å¥ï¼Œå®ç°è·¨æ•°æ®åº“å…¼å®¹ã€‚

é¦–å…ˆåœ¨é…ç½®æ–‡ä»¶ä¸­å®šä¹‰æ•°æ®åº“å‚å•†æ ‡è¯†ï¼š

```xml title="mybatis-config.xml"
<databaseIdProvider type="DB_VENDOR">
  <property name="MySQL" value="mysql"/>
  <property name="Oracle" value="oracle"/>
  <property name="SQL Server" value="sqlserver"/>
  <property name="PostgreSQL" value="postgresql"/>
</databaseIdProvider>
```

ç„¶ååœ¨Mapper XMLä¸­ä½¿ç”¨databaseIdå±æ€§åŒºåˆ†ä¸åŒæ•°æ®åº“çš„SQLï¼š

```xml title="å¤šæ•°æ®åº“æ”¯æŒç¤ºä¾‹"
<!-- MySQLç‰ˆæœ¬ -->
<select id="findUsers" resultType="User" databaseId="mysql">
  SELECT * FROM user
  <where>
    <if test="createDate != null">
      AND DATE(create_time) = #{createDate}
    </if>
  </where>
  LIMIT #{offset}, #{limit}
</select>

<!-- Oracleç‰ˆæœ¬ -->
<select id="findUsers" resultType="User" databaseId="oracle">
  SELECT * FROM 
  (
    SELECT ROWNUM rn, u.* FROM user u
    <where>
      <if test="createDate != null">
        AND TRUNC(create_time) = #{createDate}
      </if>
    </where>
    WHERE ROWNUM &lt;= #{offset} + #{limit}
  )
  WHERE rn > #{offset}
</select>

<!-- SQL Serverç‰ˆæœ¬ -->
<select id="findUsers" resultType="User" databaseId="sqlserver">
  SELECT * FROM user
  <where>
    <if test="createDate != null">
      AND CONVERT(date, create_time) = #{createDate}
    </if>
  </where>
  ORDER BY id
  OFFSET #{offset} ROWS FETCH NEXT #{limit} ROWS ONLY
</select>
```

é’ˆå¯¹ä¸åŒæ•°æ®åº“çš„ä¸»è¦å·®å¼‚å¤„ç†ï¼š

| åŠŸèƒ½ | MySQL | Oracle | SQL Server | PostgreSQL |
|-----|-------|--------|------------|------------|
| **åˆ†é¡µæŸ¥è¯¢** | `LIMIT offset, limit` | `ROWNUM` æˆ– `ROW_NUMBER()` | `OFFSET-FETCH` | `LIMIT-OFFSET` |
| **æ—¥æœŸå¤„ç†** | `DATE(field)` | `TRUNC(field)` | `CONVERT(date, field)` | `field::date` |
| **å­—ç¬¦ä¸²è¿æ¥** | `CONCAT()` | `\|\|` | `+` æˆ– `CONCAT()` | `\|\|` |
| **è‡ªå¢ä¸»é”®** | `AUTO_INCREMENT` | `SEQUENCE` | `IDENTITY` | `SERIAL` |
| **æ‰¹é‡æ’å…¥** | å¤šå€¼è¯­æ³• | è”åˆæŸ¥è¯¢ | è¡¨å˜é‡ | å¤šå€¼è¯­æ³• |
| **NULLæ’åº** | `IS NULL DESC` | `NULLS LAST` | `CASE WHEN` | `NULLS LAST` |

:::tip æ•°æ®åº“å…¼å®¹æœ€ä½³å®è·µ
1. **æŠ½è±¡å…¬å…±SQL**ï¼šå°†å…±åŒéƒ¨åˆ†æå–ä¸ºSQLç‰‡æ®µ
2. **æ•°æ®åº“ç‰ˆæœ¬æ£€æµ‹**ï¼šæ ¹æ®databaseIdé€‰æ‹©é€‚å½“çš„SQL
3. **å°è£…ç‰¹æ®Šå¤„ç†**ï¼šå°†æ•°æ®åº“ç‰¹å®šåŠŸèƒ½å°è£…åˆ°è¾…åŠ©æ–¹æ³•
4. **åˆ†é¡µæ’ä»¶**ï¼šä½¿ç”¨PageHelperç­‰æ’ä»¶ç»Ÿä¸€åˆ†é¡µå¤„ç†
5. **æ–¹è¨€é…ç½®**ï¼šé€šè¿‡é…ç½®æ–‡ä»¶ç®¡ç†ä¸åŒæ•°æ®åº“æ–¹è¨€
:::

## 5. ç»“æœæ˜ å°„ä¸å…³è”æŸ¥è¯¢

ç»“æœæ˜ å°„æ˜¯MyBatisçš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ï¼Œå®ƒè´Ÿè´£å°†æŸ¥è¯¢ç»“æœé›†è½¬æ¢ä¸ºJavaå¯¹è±¡ï¼Œå¤„ç†å±æ€§åä¸åˆ—åçš„æ˜ å°„å…³ç³»ï¼Œä»¥åŠç®¡ç†å¤æ‚çš„å…³è”å¯¹è±¡æ˜ å°„ã€‚

```mermaid
graph TD
    A[ResultMap] --> B[idå±æ€§æ˜ å°„]
    A --> C[æ™®é€šå±æ€§æ˜ å°„]
    A --> D[å…³è”å¯¹è±¡æ˜ å°„]
    A --> E[é›†åˆæ˜ å°„]
    A --> F[é‰´åˆ«å™¨æ˜ å°„]
    
    D --> D1[åµŒå¥—ç»“æœæ˜ å°„]
    D --> D2[åµŒå¥—æŸ¥è¯¢]
    
    E --> E1[åµŒå¥—ç»“æœæ˜ å°„]
    E --> E2[åµŒå¥—æŸ¥è¯¢]
    
    F --> F1[æ¡ä»¶åˆ¤æ–­]
    F1 --> F2[ä¸åŒæ˜ å°„ç­–ç•¥]
```

### 5.1 åŸºç¡€ç»“æœæ˜ å°„

åŸºç¡€ç»“æœæ˜ å°„å¤„ç†ç®€å•çš„åˆ—ååˆ°å±æ€§åçš„æ˜ å°„ï¼ŒMyBatisæä¾›äº†è‡ªåŠ¨æ˜ å°„å’Œæ‰‹åŠ¨é…ç½®ä¸¤ç§æ–¹å¼ã€‚

<Tabs>
<TabItem value="auto" label="è‡ªåŠ¨æ˜ å°„">

å½“Javaå±æ€§åä¸æ•°æ®åº“åˆ—ååŒ¹é…æˆ–ç¬¦åˆé©¼å³°å‘½åè½¬æ¢è§„åˆ™æ—¶ï¼ŒMyBatiså¯ä»¥è‡ªåŠ¨æ˜ å°„ï¼š

```xml title="è‡ªåŠ¨æ˜ å°„ç¤ºä¾‹"
<!-- å¯ç”¨é©¼å³°å‘½åè½¬æ¢ (mybatis-config.xml) -->
<settings>
  <setting name="mapUnderscoreToCamelCase" value="true"/>
</settings>

<!-- ä½¿ç”¨è‡ªåŠ¨æ˜ å°„ -->
<select id="getUser" resultType="com.example.model.User">
  SELECT 
    id,
    username,
    email,
    phone,
    create_time,  <!-- ä¼šè‡ªåŠ¨æ˜ å°„åˆ°createTimeå±æ€§ -->
    update_time   <!-- ä¼šè‡ªåŠ¨æ˜ å°„åˆ°updateTimeå±æ€§ -->
  FROM user
  WHERE id = #{id}
</select>
```

```java title="å¯¹åº”å®ä½“ç±»"
public class User {
    private Long id;
    private String username;
    private String email;
    private String phone;
    private Date createTime;  // å¯¹åº”create_timeåˆ—
    private Date updateTime;  // å¯¹åº”update_timeåˆ—
    
    // getterå’Œsetter
}
```

</TabItem>
<TabItem value="manual" label="æ‰‹åŠ¨æ˜ å°„">

å½“åˆ—åä¸å±æ€§åä¸åŒ¹é…æˆ–éœ€è¦ç‰¹æ®Šå¤„ç†æ—¶ï¼Œå¯ä»¥ä½¿ç”¨resultMapè¿›è¡Œæ‰‹åŠ¨æ˜ å°„ï¼š

```xml title="æ‰‹åŠ¨æ˜ å°„ç¤ºä¾‹"
<!-- å®šä¹‰ç»“æœæ˜ å°„ -->
<resultMap id="UserResultMap" type="com.example.model.User">
  <id property="id" column="user_id" />  <!-- ä¸»é”®æ˜ å°„ -->
  <result property="username" column="user_name" />  <!-- æ™®é€šå±æ€§æ˜ å°„ -->
  <result property="email" column="user_email" />
  <result property="phoneNumber" column="phone" />
  <result property="createTime" column="gmt_create" />
  <result property="updateTime" column="gmt_modified" />
</resultMap>

<!-- ä½¿ç”¨ç»“æœæ˜ å°„ -->
<select id="getUser" resultMap="UserResultMap">
  SELECT 
    user_id,
    user_name,
    user_email,
    phone,
    gmt_create,
    gmt_modified
  FROM t_user
  WHERE user_id = #{id}
</select>
```

</TabItem>
</Tabs>

#### resultMapå±æ€§è¯¦è§£

| å±æ€§ | æè¿° | ç”¨æ³•ç¤ºä¾‹ |
|-----|-----|---------|
| **id** | ä¸»é”®æ˜ å°„ï¼Œç”¨äºåŒºåˆ†ç›¸åŒIDçš„å¯¹è±¡ | `<id property="id" column="user_id"/>` |
| **result** | æ™®é€šå±æ€§æ˜ å°„ | `<result property="username" column="user_name"/>` |
| **constructor** | ä½¿ç”¨æ„é€ å‡½æ•°æ³¨å…¥å±æ€§ | `<constructor><idArg/><arg/></constructor>` |
| **association** | ä¸€å¯¹ä¸€å…³è”æ˜ å°„ | `<association property="profile" javaType="UserProfile"/>` |
| **collection** | ä¸€å¯¹å¤šå…³è”æ˜ å°„ | `<collection property="orders" ofType="Order"/>` |
| **discriminator** | é‰´åˆ«å™¨æ˜ å°„ï¼Œæ ¹æ®åˆ—å€¼é€‰æ‹©æ˜ å°„æ–¹å¼ | `<discriminator javaType="int" column="type"/>` |

#### ç±»å‹è½¬æ¢

MyBatisä¼šè‡ªåŠ¨å¤„ç†Javaç±»å‹ä¸æ•°æ®åº“ç±»å‹ä¹‹é—´çš„è½¬æ¢ï¼Œä¹Ÿå¯ä»¥é€šè¿‡typeHandleræŒ‡å®šè‡ªå®šä¹‰ç±»å‹å¤„ç†ï¼š

```xml title="ç±»å‹å¤„ç†å™¨ç¤ºä¾‹"
<resultMap id="UserMap" type="User">
  <id property="id" column="id"/>
  <result property="createdAt" column="created_at" 
          typeHandler="com.example.handler.LocalDateTimeHandler"/>
  <result property="status" column="status" 
          typeHandler="org.apache.ibatis.type.EnumOrdinalTypeHandler"/>
  <result property="settings" column="settings" 
          typeHandler="com.example.handler.JsonTypeHandler"/>
</resultMap>
```

### 5.2 ä¸€å¯¹ä¸€å…³è”æŸ¥è¯¢

MyBatisæä¾›äº†å¼ºå¤§çš„ä¸€å¯¹ä¸€å…³è”æŸ¥è¯¢èƒ½åŠ›ï¼Œæ”¯æŒåµŒå¥—ç»“æœå’ŒåµŒå¥—æŸ¥è¯¢ä¸¤ç§æ–¹å¼ã€‚

<Tabs>
<TabItem value="nested-result" label="åµŒå¥—ç»“æœæ˜ å°„">

åµŒå¥—ç»“æœæ˜ å°„é€šè¿‡ä¸€æ¬¡SQLæŸ¥è¯¢è·å–ä¸»å¯¹è±¡å’Œå…³è”å¯¹è±¡çš„æ‰€æœ‰æ•°æ®ï¼š

```xml title="åµŒå¥—ç»“æœæ˜ å°„ç¤ºä¾‹"
<resultMap id="UserWithProfileMap" type="User">
  <id property="id" column="user_id"/>
  <result property="username" column="username"/>
  <result property="email" column="email"/>
  
  <!-- åµŒå¥—ç»“æœæ˜ å°„ - ä¸€å¯¹ä¸€å…³è” -->
  <association property="profile" javaType="UserProfile">
    <id property="id" column="profile_id"/>
    <result property="address" column="address"/>
    <result property="phone" column="phone"/>
    <result property="avatar" column="avatar"/>
  </association>
</resultMap>

<select id="getUserWithProfile" resultMap="UserWithProfileMap">
  SELECT 
    u.id as user_id,
    u.username,
    u.email,
    p.id as profile_id,
    p.address,
    p.phone,
    p.avatar
  FROM user u
  LEFT JOIN user_profile p ON u.id = p.user_id
  WHERE u.id = #{id}
</select>
```

</TabItem>
<TabItem value="nested-query" label="åµŒå¥—æŸ¥è¯¢">

åµŒå¥—æŸ¥è¯¢é€šè¿‡æ‰§è¡Œé¢å¤–çš„SQLè¯­å¥æ¥åŠ è½½å…³è”å¯¹è±¡ï¼š

```xml title="åµŒå¥—æŸ¥è¯¢ç¤ºä¾‹"
<resultMap id="UserMap" type="User">
  <id property="id" column="id"/>
  <result property="username" column="username"/>
  <result property="email" column="email"/>
  
  <!-- åµŒå¥—æŸ¥è¯¢ - ä¸€å¯¹ä¸€å…³è” -->
  <association property="profile" 
               column="id" 
               select="getProfileByUserId"
               fetchType="lazy"/>
</resultMap>

<select id="getUser" resultMap="UserMap">
  SELECT id, username, email FROM user WHERE id = #{id}
</select>

<select id="getProfileByUserId" resultType="UserProfile">
  SELECT id, address, phone, avatar 
  FROM user_profile
  WHERE user_id = #{userId}
</select>
```

</TabItem>
<TabItem value="composite-key" label="å¤åˆä¸»é”®å…³è”">

å¤„ç†å¤åˆä¸»é”®å…³è”çš„æƒ…å†µï¼š

```xml title="å¤åˆä¸»é”®å…³è”ç¤ºä¾‹"
<resultMap id="OrderResultMap" type="Order">
  <id property="id" column="order_id"/>
  <result property="orderNo" column="order_no"/>
  <result property="createTime" column="create_time"/>
  
  <!-- å¤åˆä¸»é”®å…³è” -->
  <association property="shippingAddress" javaType="Address">
    <id property="orderId" column="order_id"/>
    <id property="type" column="address_type"/>
    <result property="street" column="street"/>
    <result property="city" column="city"/>
    <result property="country" column="country"/>
    <result property="zipCode" column="zip_code"/>
  </association>
</resultMap>

<select id="getOrderWithAddress" resultMap="OrderResultMap">
  SELECT
    o.id as order_id,
    o.order_no,
    o.create_time,
    a.type as address_type,
    a.street,
    a.city,
    a.country,
    a.zip_code
  FROM orders o
  LEFT JOIN address a ON o.id = a.order_id AND a.type = 'SHIPPING'
  WHERE o.id = #{id}
</select>
```

</TabItem>
<TabItem value="auto-mapping" label="è‡ªåŠ¨æ˜ å°„ç»„åˆ">

ç»“åˆè‡ªåŠ¨æ˜ å°„å’Œæ‰‹åŠ¨æ˜ å°„çš„æ··åˆä½¿ç”¨ï¼š

```xml title="è‡ªåŠ¨æ˜ å°„ç»„åˆç¤ºä¾‹"
<resultMap id="UserWithProfileMap" type="User" autoMapping="true">
  <id property="id" column="id"/>
  <!-- å…¶ä»–Userå±æ€§è‡ªåŠ¨æ˜ å°„ -->
  
  <association property="profile" javaType="UserProfile" autoMapping="true">
    <id property="id" column="profile_id"/>
    <!-- å…¶ä»–Profileå±æ€§è‡ªåŠ¨æ˜ å°„ï¼Œå‰ç¼€ç›¸åŒ -->
  </association>
</resultMap>

<select id="getUserWithProfile" resultMap="UserWithProfileMap">
  SELECT 
    u.id,
    u.username,
    u.email,
    u.create_time,
    p.id AS profile_id,
    p.address AS profile_address,
    p.phone AS profile_phone
  FROM user u
  LEFT JOIN user_profile p ON u.id = p.user_id
  WHERE u.id = #{id}
</select>
```

</TabItem>
</Tabs>

### 5.3 ä¸€å¯¹å¤šå…³è”æŸ¥è¯¢

ä¸€å¯¹å¤šå…³è”å¤„ç†ä¸€ä¸ªå¯¹è±¡å…³è”å¤šä¸ªå­å¯¹è±¡çš„æƒ…å†µï¼Œä¾‹å¦‚ç”¨æˆ·æ‹¥æœ‰å¤šä¸ªè®¢å•ã€‚

<Tabs>
<TabItem value="nested-result" label="åµŒå¥—ç»“æœæ˜ å°„">

åµŒå¥—ç»“æœæ˜ å°„æ–¹å¼åŠ è½½ä¸€å¯¹å¤šå…³è”ï¼š

```xml title="ä¸€å¯¹å¤šåµŒå¥—ç»“æœæ˜ å°„"
<resultMap id="UserWithOrdersMap" type="User">
  <id property="id" column="user_id"/>
  <result property="username" column="username"/>
  <result property="email" column="email"/>
  
  <!-- ä¸€å¯¹å¤šå…³è” -->
  <collection property="orders" ofType="Order">
    <id property="id" column="order_id"/>
    <result property="orderNo" column="order_no"/>
    <result property="amount" column="amount"/>
    <result property="createTime" column="order_create_time"/>
    <result property="status" column="order_status"/>
  </collection>
</resultMap>

<select id="getUserWithOrders" resultMap="UserWithOrdersMap">
  SELECT 
    u.id as user_id,
    u.username,
    u.email,
    o.id as order_id,
    o.order_no,
    o.amount,
    o.create_time as order_create_time,
    o.status as order_status
  FROM user u
  LEFT JOIN orders o ON u.id = o.user_id
  WHERE u.id = #{id}
  ORDER BY o.create_time DESC
</select>
```

</TabItem>
<TabItem value="nested-query" label="åµŒå¥—æŸ¥è¯¢">

åµŒå¥—æŸ¥è¯¢æ–¹å¼åŠ è½½ä¸€å¯¹å¤šå…³è”ï¼š

```xml title="ä¸€å¯¹å¤šåµŒå¥—æŸ¥è¯¢"
<resultMap id="UserMap" type="User">
  <id property="id" column="id"/>
  <result property="username" column="username"/>
  <result property="email" column="email"/>
  
  <!-- ä¸€å¯¹å¤šåµŒå¥—æŸ¥è¯¢ -->
  <collection property="orders" 
              column="id" 
              select="getOrdersByUserId"
              fetchType="lazy"/>
</resultMap>

<select id="getUser" resultMap="UserMap">
  SELECT id, username, email FROM user WHERE id = #{id}
</select>

<select id="getOrdersByUserId" resultType="Order">
  SELECT id, order_no, amount, create_time, status
  FROM orders
  WHERE user_id = #{userId}
  ORDER BY create_time DESC
</select>
```

</TabItem>
<TabItem value="multi-level" label="å¤šçº§åµŒå¥—">

å¤„ç†å¤šçº§åµŒå¥—å…³è”çš„æƒ…å†µï¼š

```xml title="å¤šçº§åµŒå¥—å…³è”"
<resultMap id="UserWithOrdersAndItemsMap" type="User">
  <id property="id" column="user_id"/>
  <result property="username" column="username"/>
  
  <!-- ä¸€çº§åµŒå¥—ï¼šç”¨æˆ·çš„è®¢å• -->
  <collection property="orders" ofType="Order">
    <id property="id" column="order_id"/>
    <result property="orderNo" column="order_no"/>
    <result property="amount" column="amount"/>
    
    <!-- äºŒçº§åµŒå¥—ï¼šè®¢å•çš„å•†å“é¡¹ -->
    <collection property="items" ofType="OrderItem">
      <id property="id" column="item_id"/>
      <result property="productId" column="product_id"/>
      <result property="quantity" column="quantity"/>
      <result property="price" column="price"/>
      
      <!-- ä¸‰çº§åµŒå¥—ï¼šå•†å“ä¿¡æ¯ -->
      <association property="product" javaType="Product">
        <id property="id" column="product_id"/>
        <result property="name" column="product_name"/>
        <result property="image" column="product_image"/>
      </association>
    </collection>
  </collection>
</resultMap>

<select id="getUserWithOrdersAndItems" resultMap="UserWithOrdersAndItemsMap">
  SELECT 
    u.id as user_id,
    u.username,
    o.id as order_id,
    o.order_no,
    o.amount,
    i.id as item_id,
    i.product_id,
    i.quantity,
    i.price,
    p.name as product_name,
    p.image as product_image
  FROM user u
  LEFT JOIN orders o ON u.id = o.user_id
  LEFT JOIN order_item i ON o.id = i.order_id
  LEFT JOIN product p ON i.product_id = p.id
  WHERE u.id = #{id}
  ORDER BY o.create_time DESC, i.id ASC
</select>
```

</TabItem>
</Tabs>

:::warning æ€§èƒ½æ³¨æ„äº‹é¡¹
1. **N+1é—®é¢˜**ï¼šåµŒå¥—æŸ¥è¯¢å¯èƒ½å¯¼è‡´å¤§é‡é¢å¤–æŸ¥è¯¢ï¼Œé™ä½æ€§èƒ½
2. **å»¶è¿ŸåŠ è½½**ï¼šé€‚å½“ä½¿ç”¨fetchType="lazy"å¯ä»¥æŒ‰éœ€åŠ è½½å…³è”å¯¹è±¡
3. **ç»“æœé›†è¿‡å¤§**ï¼šå¤æ‚åµŒå¥—ç»“æœæ˜ å°„å¯èƒ½è¿”å›å¤§é‡å†—ä½™æ•°æ®
4. **å†…å­˜æ¶ˆè€—**ï¼šå¤šçº§åµŒå¥—æ˜ å°„ä¼šæ¶ˆè€—æ›´å¤šå†…å­˜èµ„æº
:::

### 5.4 é‰´åˆ«å™¨æ˜ å°„

é‰´åˆ«å™¨æ˜ å°„å…è®¸æ ¹æ®æŸåˆ—çš„å€¼æ¥å†³å®šå¦‚ä½•æ˜ å°„ç»“æœé›†ï¼Œç±»ä¼¼äºJavaä¸­çš„switchè¯­å¥ã€‚

<Tabs>
<TabItem value="basic" label="åŸºç¡€ç”¨æ³•">

æ ¹æ®ç±»å‹å­—æ®µé€‰æ‹©ä¸åŒçš„æ˜ å°„æ–¹å¼ï¼š

```xml title="é‰´åˆ«å™¨åŸºç¡€ç”¨æ³•"
<resultMap id="VehicleResultMap" type="Vehicle">
  <id property="id" column="id"/>
  <result property="name" column="name"/>
  <result property="price" column="price"/>
  
  <!-- æ ¹æ®vehicle_typeåˆ—å€¼ç¡®å®šæ˜ å°„æ–¹å¼ -->
  <discriminator javaType="int" column="vehicle_type">
    <case value="1" resultType="Car">
      <result property="engineType" column="engine_type"/>
      <result property="doors" column="doors"/>
    </case>
    <case value="2" resultType="Motorcycle">
      <result property="engineCapacity" column="engine_capacity"/>
      <result property="hasSideCar" column="has_side_car"/>
    </case>
    <case value="3" resultType="Bicycle">
      <result property="frameType" column="frame_type"/>
      <result property="gears" column="gears"/>
    </case>
  </discriminator>
</resultMap>

<select id="getVehicleById" resultMap="VehicleResultMap">
  SELECT 
    id, name, price, vehicle_type,
    engine_type, doors, engine_capacity,
    has_side_car, frame_type, gears
  FROM vehicle
  WHERE id = #{id}
</select>
```

</TabItem>
<TabItem value="nested-maps" label="åµŒå¥—æ˜ å°„">

é‰´åˆ«å™¨ç»“åˆåµŒå¥—æ˜ å°„çš„å¤æ‚ç”¨æ³•ï¼š

```xml title="é‰´åˆ«å™¨åµŒå¥—æ˜ å°„"
<resultMap id="PaymentResultMap" type="Payment">
  <id property="id" column="payment_id"/>
  <result property="amount" column="amount"/>
  <result property="paymentDate" column="payment_date"/>
  
  <!-- æ ¹æ®æ”¯ä»˜æ–¹å¼ç¡®å®šæ˜ å°„æ–¹å¼ -->
  <discriminator javaType="string" column="payment_type">
    <case value="CREDIT_CARD" resultMap="CreditCardPaymentMap"/>
    <case value="PAYPAL" resultMap="PayPalPaymentMap"/>
    <case value="BANK_TRANSFER" resultMap="BankTransferPaymentMap"/>
    <case value="CASH" resultMap="CashPaymentMap"/>
  </discriminator>
</resultMap>

<!-- ä¿¡ç”¨å¡æ”¯ä»˜æ˜ å°„ -->
<resultMap id="CreditCardPaymentMap" type="CreditCardPayment" extends="PaymentResultMap">
  <result property="cardNumber" column="card_number"/>
  <result property="expiryDate" column="expiry_date"/>
  <result property="cardType" column="card_type"/>
</resultMap>

<!-- PayPalæ”¯ä»˜æ˜ å°„ -->
<resultMap id="PayPalPaymentMap" type="PayPalPayment" extends="PaymentResultMap">
  <result property="emailAddress" column="email_address"/>
  <result property="accountId" column="account_id"/>
</resultMap>

<!-- é“¶è¡Œè½¬è´¦æ˜ å°„ -->
<resultMap id="BankTransferPaymentMap" type="BankTransferPayment" extends="PaymentResultMap">
  <result property="bankName" column="bank_name"/>
  <result property="accountNumber" column="account_number"/>
  <result property="referenceNumber" column="reference_number"/>
</resultMap>

<!-- ç°é‡‘æ”¯ä»˜æ˜ å°„ -->
<resultMap id="CashPaymentMap" type="CashPayment" extends="PaymentResultMap">
  <result property="receiptNumber" column="receipt_number"/>
</resultMap>
```

</TabItem>
<TabItem value="custom-type" label="è‡ªå®šä¹‰ç±»å‹æ˜ å°„">

é‰´åˆ«å™¨ç»“åˆç±»å‹å¤„ç†å™¨çš„é«˜çº§ç”¨æ³•ï¼š

```xml title="è‡ªå®šä¹‰ç±»å‹æ˜ å°„"
<resultMap id="ProductResultMap" type="Product">
  <id property="id" column="id"/>
  <result property="name" column="name"/>
  <result property="price" column="price"/>
  <result property="categoryId" column="category_id"/>
  
  <!-- æ ¹æ®äº§å“ç±»å‹å†³å®šå¦‚ä½•å¤„ç†attributeså­—æ®µ -->
  <discriminator javaType="string" column="product_type">
    <case value="ELECTRONIC" resultType="ElectronicProduct">
      <result property="attributes" column="attributes" 
              typeHandler="com.example.handler.ElectronicAttributesHandler"/>
    </case>
    <case value="CLOTHING" resultType="ClothingProduct">
      <result property="attributes" column="attributes" 
              typeHandler="com.example.handler.ClothingAttributesHandler"/>
    </case>
    <case value="FOOD" resultType="FoodProduct">
      <result property="attributes" column="attributes" 
              typeHandler="com.example.handler.FoodAttributesHandler"/>
      <result property="expiryDate" column="expiry_date"/>
    </case>
  </discriminator>
</resultMap>
```

</TabItem>
</Tabs>

é‰´åˆ«å™¨æ˜ å°„çš„ä¸»è¦é€‚ç”¨åœºæ™¯ï¼š

1. **ç»§æ‰¿å…³ç³»æ˜ å°„**ï¼šå¤„ç†ä¸åŒå­ç±»çš„å·®å¼‚åŒ–å­—æ®µ
2. **å¤šæ€å¯¹è±¡å¤„ç†**ï¼šæ ¹æ®ç±»å‹å­—æ®µè¿”å›ä¸åŒç±»å‹çš„å¯¹è±¡
3. **æ¡ä»¶å­—æ®µæ˜ å°„**ï¼šæ ¹æ®çŠ¶æ€å†³å®šå¦‚ä½•å¤„ç†æŸäº›å­—æ®µ
4. **å¤æ‚ä¸šåŠ¡é€»è¾‘**ï¼šæ ¹æ®ä¸šåŠ¡è§„åˆ™é€‰æ‹©ä¸åŒçš„æ˜ å°„ç­–ç•¥

:::tip ç»“æœæ˜ å°„æœ€ä½³å®è·µ
1. **ä¼˜å…ˆä½¿ç”¨è‡ªåŠ¨æ˜ å°„**ï¼šå½“åˆ—åç¬¦åˆå‘½åè§„åˆ™æ—¶ï¼Œå¯ç”¨è‡ªåŠ¨æ˜ å°„
2. **ç»„åˆä½¿ç”¨ç­–ç•¥**ï¼šæ ¹æ®å¤æ‚åº¦é€‰æ‹©åˆé€‚çš„æ˜ å°„æ–¹å¼
3. **å»¶è¿ŸåŠ è½½**ï¼šä½¿ç”¨fetchType="lazy"é¿å…ä¸å¿…è¦çš„æ•°æ®åŠ è½½
4. **ç»“æœç¼“å­˜**ï¼šä¸ºå¤æ‚æŸ¥è¯¢å¯ç”¨ç¼“å­˜ï¼Œæé«˜æ€§èƒ½
5. **é¢„åŠ è½½å…³è”**ï¼šå¯¹äºç»å¸¸ä¸€èµ·ä½¿ç”¨çš„å…³è”æ•°æ®ï¼Œä½¿ç”¨åµŒå¥—ç»“æœæ˜ å°„
:::

## 6. ç¼“å­˜æœºåˆ¶ä¸æ€§èƒ½ä¼˜åŒ–

MyBatisæä¾›äº†å®Œå–„çš„ç¼“å­˜æœºåˆ¶ï¼Œé€šè¿‡åˆç†ä½¿ç”¨ç¼“å­˜ï¼Œå¯ä»¥æ˜¾è‘—æå‡æŸ¥è¯¢æ€§èƒ½ï¼Œå‡å°‘æ•°æ®åº“è®¿é—®æ¬¡æ•°ã€‚MyBatisçš„ç¼“å­˜åˆ†ä¸ºä¸€çº§ç¼“å­˜å’ŒäºŒçº§ç¼“å­˜ä¸¤ä¸ªå±‚æ¬¡ã€‚

```mermaid
graph TD
    A[MyBatisç¼“å­˜ä½“ç³»] --> B[ä¸€çº§ç¼“å­˜]
    A --> C[äºŒçº§ç¼“å­˜]
    
    B --> B1[SqlSessionçº§åˆ«]
    B --> B2[é»˜è®¤å¯ç”¨]
    B --> B3[ç”Ÿå‘½å‘¨æœŸçŸ­]
    
    C --> C1[Mapperçº§åˆ«]
    C --> C2[éœ€æ‰‹åŠ¨å¯ç”¨]
    C --> C3[è·¨SqlSession]
    C --> C4[å¯è‡ªå®šä¹‰å®ç°]
```

### 6.1 ä¸€çº§ç¼“å­˜æœºåˆ¶

ä¸€çº§ç¼“å­˜æ˜¯SqlSessionçº§åˆ«çš„ç¼“å­˜ï¼Œé»˜è®¤å¯ç”¨ï¼Œç”Ÿå‘½å‘¨æœŸä»…é™äºå•ä¸ªSqlSessionã€‚

<Tabs>
<TabItem value="basic" label="åŸºæœ¬åŸç†">

ä¸€çº§ç¼“å­˜çš„å·¥ä½œåŸç†ï¼š

1. **ä½œç”¨èŒƒå›´**ï¼šSqlSessionçº§åˆ«ï¼ŒåŒä¸€ä¸ªSqlSessionä¸­çš„ç›¸åŒæŸ¥è¯¢ä¼šä½¿ç”¨ç¼“å­˜
2. **ç¼“å­˜é”®**ï¼šåŸºäºStatement ID + SQL + å‚æ•°å€¼ + RowBoundsè®¡ç®—
3. **è‡ªåŠ¨ç®¡ç†**ï¼šé»˜è®¤å¼€å¯ï¼Œæ— éœ€é¢å¤–é…ç½®
4. **ç”Ÿå‘½å‘¨æœŸ**ï¼šSqlSessionå…³é—­åç¼“å­˜å¤±æ•ˆ

```java title="ä¸€çº§ç¼“å­˜ç¤ºä¾‹"
// è·å–SqlSession
try (SqlSession session = sqlSessionFactory.openSession()) {
    UserMapper mapper = session.getMapper(UserMapper.class);
    
    // ç¬¬ä¸€æ¬¡æŸ¥è¯¢ï¼Œè®¿é—®æ•°æ®åº“
    User user1 = mapper.getUserById(1001L);
    
    // ç¬¬äºŒæ¬¡æŸ¥è¯¢ï¼Œä½¿ç”¨ä¸€çº§ç¼“å­˜
    User user2 = mapper.getUserById(1001L);
    
    // user1å’Œuser2æ˜¯åŒä¸€ä¸ªå¯¹è±¡å¼•ç”¨
    System.out.println(user1 == user2);  // true
}
```

</TabItem>
<TabItem value="clear" label="æ¸…é™¤ç¼“å­˜">

ä¸€çº§ç¼“å­˜åœ¨ä»¥ä¸‹æƒ…å†µä¼šè¢«æ¸…é™¤ï¼š

1. è°ƒç”¨`SqlSession.clearCache()`æ–¹æ³•
2. æ‰§è¡ŒUPDATEã€INSERTã€DELETEç­‰ä¿®æ”¹æ“ä½œ
3. è°ƒç”¨å¸¦æœ‰`flushCache=true`å±æ€§çš„æŸ¥è¯¢
4. SqlSessionæ‰§è¡Œæäº¤æˆ–å›æ»šæ“ä½œ
5. SqlSessionå…³é—­

```java title="æ¸…é™¤ä¸€çº§ç¼“å­˜"
try (SqlSession session = sqlSessionFactory.openSession()) {
    UserMapper mapper = session.getMapper(UserMapper.class);
    
    // ç¬¬ä¸€æ¬¡æŸ¥è¯¢
    User user1 = mapper.getUserById(1001L);
    
    // æ¸…é™¤ä¸€çº§ç¼“å­˜
    session.clearCache();
    
    // ç¬¬äºŒæ¬¡æŸ¥è¯¢ï¼Œä¼šå†æ¬¡è®¿é—®æ•°æ®åº“
    User user2 = mapper.getUserById(1001L);
    
    // user1å’Œuser2ä¸æ˜¯åŒä¸€ä¸ªå¯¹è±¡
    System.out.println(user1 == user2);  // false
}
```

```xml title="æŸ¥è¯¢è¯­å¥é…ç½®æ¸…é™¤ç¼“å­˜"
<!-- flushCache=trueä¼šæ¸…é™¤ä¸€çº§ç¼“å­˜å’ŒäºŒçº§ç¼“å­˜ -->
<select id="getUserByEmail" resultType="User" flushCache="true">
  SELECT * FROM user WHERE email = #{email}
</select>
```

</TabItem>
<TabItem value="config" label="é…ç½®é€‰é¡¹">

ä¸€çº§ç¼“å­˜çš„é…ç½®é€‰é¡¹ï¼š

```xml title="mybatis-config.xml"
<settings>
  <!-- è®¾ç½®ä¸€çº§ç¼“å­˜çš„ä½œç”¨èŒƒå›´:
       SESSION (é»˜è®¤): åŒä¸€ä¸ªSqlSessionå†…æœ‰æ•ˆ
       STATEMENT: è¯­å¥çº§åˆ«ï¼Œç›¸å½“äºç¦ç”¨ä¸€çº§ç¼“å­˜
  -->
  <setting name="localCacheScope" value="SESSION"/>
</settings>
```

å½“`localCacheScope`è®¾ä¸º`STATEMENT`æ—¶ï¼Œä¸€çº§ç¼“å­˜ä»…å¯¹å•ä¸ªè¯­å¥æœ‰æ•ˆï¼Œæ¯æ¬¡æŸ¥è¯¢å®Œæˆåéƒ½ä¼šæ¸…ç©ºç¼“å­˜ï¼Œç›¸å½“äºç¦ç”¨äº†ä¸€çº§ç¼“å­˜ã€‚

</TabItem>
<TabItem value="considerations" label="ä½¿ç”¨è€ƒé‡">

ä¸€çº§ç¼“å­˜ä½¿ç”¨æ³¨æ„äº‹é¡¹ï¼š

1. **é€‚ç”¨åœºæ™¯**ï¼šé€‚ç”¨äºå•ä¸ªæ–¹æ³•å†…å¤šæ¬¡æŸ¥è¯¢ç›¸åŒæ•°æ®çš„åœºæ™¯
2. **äº‹åŠ¡éš”ç¦»**ï¼šä¸€çº§ç¼“å­˜ä¸è·¨SqlSessionï¼Œä¸ä¼šæœ‰æ•°æ®ä¸€è‡´æ€§é—®é¢˜
3. **å¯¹è±¡ä¸€è‡´æ€§**ï¼šåŒä¸€SqlSessionå†…ç›¸åŒæŸ¥è¯¢è¿”å›çš„æ˜¯åŒä¸€ä¸ªå¯¹è±¡å¼•ç”¨
4. **æ€§èƒ½å½±å“**ï¼šé€šå¸¸æœ‰åŠ©äºå‡å°‘é‡å¤æŸ¥è¯¢ï¼Œä½†å¯¹æ•´ä½“æ€§èƒ½å½±å“æœ‰é™
5. **å®‰å…¨å…³æ³¨ç‚¹**ï¼šåœ¨å¹¶å‘ç¯å¢ƒä¸­ï¼Œå¦‚æœå…±äº«SqlSessionå¯èƒ½å¯¼è‡´æ•°æ®æ··ä¹±

```java title="ä¸€çº§ç¼“å­˜æ³¨æ„äº‹é¡¹ç¤ºä¾‹"
// æ­£ç¡®ä½¿ç”¨æ–¹å¼ - æ¯ä¸ªçº¿ç¨‹ç‹¬ç«‹çš„SqlSession
@Service
public class UserService {
    @Autowired
    private SqlSessionFactory sqlSessionFactory;
    
    public User getUserById(Long id) {
        try (SqlSession session = sqlSessionFactory.openSession()) {
            UserMapper mapper = session.getMapper(UserMapper.class);
            return mapper.getUserById(id);
        }
    }
    
    // åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­ä½¿ç”¨ä¸€çº§ç¼“å­˜
    public void processUserData(Long id) {
        try (SqlSession session = sqlSessionFactory.openSession()) {
            UserMapper mapper = session.getMapper(UserMapper.class);
            
            // ç¬¬ä¸€æ¬¡æŸ¥è¯¢
            User user = mapper.getUserById(id);
            // å¤„ç†ç”¨æˆ·æ•°æ®...
            
            // ç¬¬äºŒæ¬¡æŸ¥è¯¢åˆ©ç”¨ä¸€çº§ç¼“å­˜
            User sameUser = mapper.getUserById(id);
            // ç»§ç»­å¤„ç†...
            
            session.commit();
        }
    }
}
```

</TabItem>
</Tabs>

### 6.2 äºŒçº§ç¼“å­˜é…ç½®

äºŒçº§ç¼“å­˜æ˜¯Mapperçº§åˆ«çš„ç¼“å­˜ï¼Œå¯ä»¥è·¨è¶Šå¤šä¸ªSqlSessionå…±äº«ï¼Œéœ€è¦æ‰‹åŠ¨å¯ç”¨ã€‚

<Tabs>
<TabItem value="config" label="åŸºæœ¬é…ç½®">

å¯ç”¨äºŒçº§ç¼“å­˜çš„æ­¥éª¤ï¼š

1. å…¨å±€é…ç½®æ–‡ä»¶ä¸­å¯ç”¨ç¼“å­˜

```xml title="mybatis-config.xml"
<settings>
  <setting name="cacheEnabled" value="true"/>  <!-- é»˜è®¤å°±æ˜¯true -->
</settings>
```

2. åœ¨Mapper XMLä¸­é…ç½®ç¼“å­˜

```xml title="UserMapper.xml"
<mapper namespace="com.example.mapper.UserMapper">
  <!-- å¯ç”¨è¯¥å‘½åç©ºé—´çš„äºŒçº§ç¼“å­˜ -->
  <cache 
    eviction="LRU"           <!-- ç¼“å­˜æ·˜æ±°ç­–ç•¥ï¼šLRU/FIFO/SOFT/WEAK -->
    flushInterval="60000"    <!-- åˆ·æ–°é—´éš”(æ¯«ç§’)ï¼Œä¸è®¾ç½®åˆ™ä¸è‡ªåŠ¨åˆ·æ–° -->
    size="512"               <!-- ç¼“å­˜å¯¹è±¡æ•°é‡ä¸Šé™ -->
    readOnly="false"/>       <!-- falseå…è®¸ä¿®æ”¹å¯¹è±¡ï¼Œä½†éœ€è¦å¯åºåˆ—åŒ– -->
    
  <!-- æ˜ å°„è¯­å¥... -->
</mapper>
```

3. ç¡®ä¿å®ä½“ç±»å®ç°Serializableæ¥å£

```java title="å¯åºåˆ—åŒ–å®ä½“ç±»"
public class User implements Serializable {
    private static final long serialVersionUID = 1L;
    
    private Long id;
    private String username;
    // å…¶ä»–å±æ€§...
}
```

</TabItem>
<TabItem value="control" label="ç¼“å­˜æ§åˆ¶">

æ§åˆ¶å•ä¸ªè¯­å¥çš„ç¼“å­˜è¡Œä¸ºï¼š

```xml title="ç¼“å­˜æ§åˆ¶å±æ€§"
<!-- ä½¿ç”¨ç¼“å­˜ï¼ˆé»˜è®¤å€¼ä¸ºtrueï¼‰ -->
<select id="getUserById" resultType="User" useCache="true">
  SELECT * FROM user WHERE id = #{id}
</select>

<!-- ç¦ç”¨ç¼“å­˜ -->
<select id="getUserForUpdate" resultType="User" useCache="false">
  SELECT * FROM user WHERE id = #{id}
</select>

<!-- æ¸…é™¤ç¼“å­˜ï¼ˆé»˜è®¤å¯¹ä¿®æ”¹æ“ä½œä¸ºtrueï¼ŒæŸ¥è¯¢ä¸ºfalseï¼‰ -->
<select id="getUserByEmail" resultType="User" flushCache="true">
  SELECT * FROM user WHERE email = #{email}
</select>

<update id="updateUser" flushCache="true">
  UPDATE user SET username = #{username} WHERE id = #{id}
</update>
```

äºŒçº§ç¼“å­˜çš„ä½œç”¨èŒƒå›´æ˜¯namespaceçº§åˆ«çš„ï¼Œå¦‚æœè¦åœ¨å¤šä¸ªMapperä¹‹é—´å…±äº«ç¼“å­˜ï¼Œå¯ä»¥ä½¿ç”¨`<cache-ref>`ï¼š

```xml title="ç¼“å­˜å¼•ç”¨"
<mapper namespace="com.example.mapper.OrderMapper">
  <!-- å¼•ç”¨UserMapperçš„ç¼“å­˜é…ç½® -->
  <cache-ref namespace="com.example.mapper.UserMapper"/>
  
  <!-- æ˜ å°„è¯­å¥... -->
</mapper>
```

</TabItem>
<TabItem value="eviction" label="æ·˜æ±°ç­–ç•¥">

MyBatisäºŒçº§ç¼“å­˜æ”¯æŒå››ç§æ·˜æ±°ç­–ç•¥ï¼š

1. **LRU** (Least Recently Used)ï¼šæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼Œç§»é™¤æœ€é•¿æ—¶é—´æœªä½¿ç”¨çš„å¯¹è±¡ï¼Œé»˜è®¤å€¼
2. **FIFO** (First In First Out)ï¼šå…ˆè¿›å…ˆå‡ºï¼ŒæŒ‰å¯¹è±¡è¿›å…¥ç¼“å­˜çš„é¡ºåºç§»é™¤
3. **SOFT**ï¼šè½¯å¼•ç”¨ï¼ŒåŸºäºåƒåœ¾å›æ”¶å™¨çš„çŠ¶æ€å’Œè½¯å¼•ç”¨è§„åˆ™ç§»é™¤å¯¹è±¡
4. **WEAK**ï¼šå¼±å¼•ç”¨ï¼Œæ›´ç§¯æåœ°åŸºäºåƒåœ¾å›æ”¶å™¨å’Œå¼±å¼•ç”¨è§„åˆ™ç§»é™¤å¯¹è±¡

```xml title="ä¸åŒæ·˜æ±°ç­–ç•¥ç¤ºä¾‹"
<!-- LRUæ·˜æ±°ç­–ç•¥ -->
<cache eviction="LRU" size="1024"/>

<!-- FIFOæ·˜æ±°ç­–ç•¥ -->
<cache eviction="FIFO" size="1024"/>

<!-- åŸºäºè½¯å¼•ç”¨ - å†…å­˜ä¸è¶³æ—¶å›æ”¶ -->
<cache eviction="SOFT"/>

<!-- åŸºäºå¼±å¼•ç”¨ - ä¸‹æ¬¡GCæ—¶ç«‹å³å›æ”¶ -->
<cache eviction="WEAK"/>
```

</TabItem>
<TabItem value="annotations" label="æ³¨è§£é…ç½®">

ä½¿ç”¨æ³¨è§£æ–¹å¼é…ç½®äºŒçº§ç¼“å­˜ï¼š

```java title="æ³¨è§£é…ç½®ç¼“å­˜"
@CacheNamespace(
    eviction = FifoCache.class,
    flushInterval = 60000,
    size = 512,
    readWrite = false
)
public interface UserMapper {
    
    @Select("SELECT * FROM user WHERE id = #{id}")
    @Options(useCache = true)
    User getUserById(Long id);
    
    @Update("UPDATE user SET username = #{username} WHERE id = #{id}")
    @Options(flushCache = Options.FlushCachePolicy.TRUE)
    int updateUser(User user);
}

// ç¼“å­˜å¼•ç”¨
@CacheNamespaceRef(UserMapper.class)
public interface OrderMapper {
    // ...
}
```

</TabItem>
</Tabs>

### 6.3 è‡ªå®šä¹‰ç¼“å­˜å®ç°

MyBatisæ”¯æŒè‡ªå®šä¹‰ç¼“å­˜å®ç°ï¼Œå¯ä»¥é›†æˆç¬¬ä¸‰æ–¹ç¼“å­˜ï¼Œå¦‚Redisã€Ehcacheç­‰ã€‚

<Tabs>
<TabItem value="custom" label="è‡ªå®šä¹‰ç¼“å­˜">

è‡ªå®šä¹‰ç¼“å­˜éœ€è¦å®ç°MyBatisçš„`Cache`æ¥å£ï¼š

```java title="è‡ªå®šä¹‰ç¼“å­˜å®ç°"
package com.example.cache;

import org.apache.ibatis.cache.Cache;

public class CustomCache implements Cache {
    private final String id;
    private final Map<Object, Object> cache = new ConcurrentHashMap<>();
    
    public CustomCache(String id) {
        this.id = id;
    }
    
    @Override
    public String getId() {
        return id;
    }
    
    @Override
    public void putObject(Object key, Object value) {
        cache.put(key, value);
    }
    
    @Override
    public Object getObject(Object key) {
        return cache.get(key);
    }
    
    @Override
    public Object removeObject(Object key) {
        return cache.remove(key);
    }
    
    @Override
    public void clear() {
        cache.clear();
    }
    
    @Override
    public int getSize() {
        return cache.size();
    }
}
```

åœ¨Mapperä¸­ä½¿ç”¨è‡ªå®šä¹‰ç¼“å­˜ï¼š

```xml title="ä½¿ç”¨è‡ªå®šä¹‰ç¼“å­˜"
<mapper namespace="com.example.mapper.UserMapper">
  <cache type="com.example.cache.CustomCache">
    <property name="cacheType" value="LRU"/>
    <property name="maxSize" value="1000"/>
  </cache>
  
  <!-- æ˜ å°„è¯­å¥... -->
</mapper>
```

</TabItem>
<TabItem value="redis" label="Redisç¼“å­˜é›†æˆ">

é›†æˆRedisä½œä¸ºMyBatisçš„äºŒçº§ç¼“å­˜ï¼š

1. æ·»åŠ ä¾èµ–

```xml title="pom.xml"
<dependency>
    <groupId>org.mybatis.caches</groupId>
    <artifactId>mybatis-redis</artifactId>
    <version>1.0.0-beta2</version>
</dependency>
```

2. é…ç½®Redisè¿æ¥å±æ€§

```properties title="redis.properties"
redis.host=localhost
redis.port=6379
redis.connectionTimeout=5000
redis.password=
redis.database=0
```

3. åœ¨Mapperä¸­ä½¿ç”¨Redisç¼“å­˜

```xml title="ä½¿ç”¨Redisç¼“å­˜"
<mapper namespace="com.example.mapper.UserMapper">
  <cache type="org.mybatis.caches.redis.RedisCache">
    <property name="timeToLive" value="3600000"/> <!-- ç¼“å­˜è¿‡æœŸæ—¶é—´(æ¯«ç§’) -->
    <property name="configurationPropertiesFile" value="redis.properties"/>
  </cache>
  
  <!-- æ˜ å°„è¯­å¥... -->
</mapper>
```

4. è‡ªå®šä¹‰Redisç¼“å­˜å®ç°

```java title="è‡ªå®šä¹‰Redisç¼“å­˜"
public class CustomRedisCache implements Cache {
    private final String id;
    private static JedisPool jedisPool;
    
    // åˆå§‹åŒ–Redisè¿æ¥æ± 
    static {
        JedisPoolConfig config = new JedisPoolConfig();
        config.setMaxTotal(100);
        config.setMaxIdle(20);
        jedisPool = new JedisPool(config, "localhost", 6379);
    }
    
    public CustomRedisCache(String id) {
        this.id = id;
    }
    
    @Override
    public String getId() {
        return this.id;
    }
    
    @Override
    public void putObject(Object key, Object value) {
        try (Jedis jedis = jedisPool.getResource()) {
            jedis.set(serializeKey(key), SerializeUtil.serialize(value));
            jedis.expire(serializeKey(key), 3600); // 1å°æ—¶è¿‡æœŸ
        }
    }
    
    @Override
    public Object getObject(Object key) {
        try (Jedis jedis = jedisPool.getResource()) {
            byte[] value = jedis.get(serializeKey(key));
            return value != null ? SerializeUtil.unserialize(value) : null;
        }
    }
    
    @Override
    public Object removeObject(Object key) {
        try (Jedis jedis = jedisPool.getResource()) {
            return jedis.del(serializeKey(key));
        }
    }
    
    @Override
    public void clear() {
        try (Jedis jedis = jedisPool.getResource()) {
            jedis.flushDB();
        }
    }
    
    @Override
    public int getSize() {
        try (Jedis jedis = jedisPool.getResource()) {
            return jedis.dbSize().intValue();
        }
    }
    
    private byte[] serializeKey(Object key) {
        if (key instanceof String) {
            return (this.id + ":" + key).getBytes();
        }
        return (this.id + ":" + key.hashCode()).getBytes();
    }
}
```

</TabItem>
<TabItem value="spring" label="Springé›†æˆ">

åœ¨Springç¯å¢ƒä¸­ä½¿ç”¨MyBatisç¼“å­˜ï¼š

```java title="Spring MyBatisé…ç½®"
@Configuration
@MapperScan("com.example.mapper")
public class MyBatisConfig {
    
    @Bean
    public SqlSessionFactory sqlSessionFactory(DataSource dataSource) throws Exception {
        SqlSessionFactoryBean factoryBean = new SqlSessionFactoryBean();
        factoryBean.setDataSource(dataSource);
        
        // è®¾ç½®MyBatisé…ç½®
        org.apache.ibatis.session.Configuration configuration = new org.apache.ibatis.session.Configuration();
        configuration.setCacheEnabled(true); // å¯ç”¨äºŒçº§ç¼“å­˜
        configuration.setLocalCacheScope(LocalCacheScope.SESSION); // è®¾ç½®ä¸€çº§ç¼“å­˜ä½œç”¨åŸŸ
        factoryBean.setConfiguration(configuration);
        
        return factoryBean.getObject();
    }
    
    // é…ç½®äº‹åŠ¡ç®¡ç†å™¨
    @Bean
    public DataSourceTransactionManager transactionManager(DataSource dataSource) {
        return new DataSourceTransactionManager(dataSource);
    }
}

// Serviceå±‚é…ç½®
@Service
@Transactional
public class UserService {
    @Autowired
    private UserMapper userMapper;
    
    // åœ¨äº‹åŠ¡ä¸­ï¼ŒåŒä¸€ä¸ªSqlSessionä¼šè¢«é‡ç”¨
    // ä¸€çº§ç¼“å­˜åœ¨æ•´ä¸ªäº‹åŠ¡ä¸­æœ‰æ•ˆ
    public User getUserById(Long id) {
        return userMapper.getUserById(id);
    }
}
```

</TabItem>
</Tabs>

### 6.4 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

é™¤äº†ç¼“å­˜ï¼ŒMyBatisè¿˜æœ‰å¤šç§æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ï¼Œå¯ä»¥æ˜¾è‘—æé«˜ç³»ç»Ÿæ€§èƒ½ã€‚

<Tabs>
<TabItem value="strategies" label="é€šç”¨ç­–ç•¥">

å¸¸è§çš„MyBatisæ€§èƒ½ä¼˜åŒ–ç­–ç•¥ï¼š

1. **SQLä¼˜åŒ–**
   - ä»…æŸ¥è¯¢å¿…è¦çš„åˆ—ï¼Œé¿å…SELECT *
   - åˆç†ä½¿ç”¨ç´¢å¼•
   - ä¼˜åŒ–JOINæ“ä½œå’Œå­æŸ¥è¯¢
   - åˆ†é¡µæŸ¥è¯¢å¤§æ•°æ®é›†

2. **å‚æ•°å¤„ç†**
   - ä½¿ç”¨æ‰¹é‡æ“ä½œå‡å°‘æ•°æ®åº“äº¤äº’
   - åˆç†è®¾ç½®PreparedStatementçš„å‚æ•°
   - å¯¹äºINæ¡ä»¶ï¼Œé™åˆ¶å‚æ•°æ•°é‡

3. **ç»“æœæ˜ å°„**
   - ä½¿ç”¨ResultMapé¿å…é‡å¤å®šä¹‰åˆ—æ˜ å°„
   - åˆç†é…ç½®å»¶è¿ŸåŠ è½½
   - é¿å…å¤æ‚çš„åµŒå¥—æŸ¥è¯¢

4. **é…ç½®ä¼˜åŒ–**
   - ä½¿ç”¨è¿æ¥æ± ç®¡ç†æ•°æ®åº“è¿æ¥
   - ä¼˜åŒ–æ—¥å¿—é…ç½®ï¼Œç”Ÿäº§ç¯å¢ƒå…³é—­è¯¦ç»†æ—¥å¿—
   - é€‚å½“è®¾ç½®ç¼“å­˜å¤§å°å’Œåˆ·æ–°é—´éš”

```xml title="SQLä¼˜åŒ–ç¤ºä¾‹"
<!-- é¿å…SELECT * -->
<select id="getUsers" resultType="User">
  SELECT id, username, email FROM user
  WHERE status = #{status}
  LIMIT #{offset}, #{limit}
</select>

<!-- ä½¿ç”¨æ‰¹é‡æ“ä½œ -->
<insert id="batchInsert" parameterType="list">
  INSERT INTO user (username, email, status)
  VALUES
  <foreach collection="list" item="user" separator=",">
    (#{user.username}, #{user.email}, #{user.status})
  </foreach>
</insert>
```

</TabItem>
<TabItem value="lazy-loading" label="å»¶è¿ŸåŠ è½½">

MyBatisçš„å»¶è¿ŸåŠ è½½å¯ä»¥æ˜¾è‘—æé«˜æ€§èƒ½ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†å¤æ‚å¯¹è±¡å…³ç³»æ—¶ï¼š

```xml title="å»¶è¿ŸåŠ è½½é…ç½®"
<!-- å…¨å±€é…ç½® -->
<settings>
  <setting name="lazyLoadingEnabled" value="true"/>
  <setting name="aggressiveLazyLoading" value="false"/>
  <setting name="lazyLoadTriggerMethods" value="equals,clone,hashCode"/>
</settings>

<!-- ç‰¹å®šå…³è”çš„å»¶è¿ŸåŠ è½½é…ç½® -->
<resultMap id="UserMap" type="User">
  <id property="id" column="id"/>
  <result property="username" column="username"/>
  
  <!-- å»¶è¿ŸåŠ è½½ç”¨æˆ·è®¢å• -->
  <collection property="orders" 
              select="getOrdersByUserId" 
              column="id" 
              fetchType="lazy"/>
</resultMap>

<!-- è¦†ç›–å…¨å±€é…ç½®ï¼Œä¸ä½¿ç”¨å»¶è¿ŸåŠ è½½ -->
<resultMap id="UserProfileMap" type="User">
  <id property="id" column="id"/>
  <association property="profile" 
               select="getProfileByUserId" 
               column="id" 
               fetchType="eager"/>
</resultMap>
```

</TabItem>
<TabItem value="pagination" label="åˆ†é¡µä¼˜åŒ–">

å¤„ç†å¤§æ•°æ®é›†æ—¶ï¼Œåˆ†é¡µæŸ¥è¯¢æ˜¯é‡è¦çš„ä¼˜åŒ–æ‰‹æ®µï¼š

1. ä½¿ç”¨MyBatiså†…ç½®çš„RowBoundsï¼ˆå†…å­˜åˆ†é¡µï¼‰

```java title="RowBoundsåˆ†é¡µ"
// ä¸å»ºè®®ç”¨äºå¤§æ•°æ®é‡åœºæ™¯
public List<User> getUsersByPage(int offset, int limit) {
    return sqlSession.selectList("getUserList", null, new RowBounds(offset, limit));
}
```

2. ä½¿ç”¨ç‰©ç†åˆ†é¡µï¼ˆæ¨èï¼‰

```xml title="SQLåˆ†é¡µæŸ¥è¯¢"
<select id="getUsersByPage" resultType="User">
  SELECT * FROM user
  ORDER BY id
  LIMIT #{offset}, #{limit}
</select>
```

3. ä½¿ç”¨PageHelperæ’ä»¶ï¼ˆæ¨èï¼‰

```xml title="pom.xmlä¾èµ–"
<dependency>
    <groupId>com.github.pagehelper</groupId>
    <artifactId>pagehelper</artifactId>
    <version>5.2.0</version>
</dependency>
```

```java title="PageHelperç”¨æ³•"
// åœ¨æŸ¥è¯¢å‰è®¾ç½®åˆ†é¡µå‚æ•°
PageHelper.startPage(pageNum, pageSize);
List<User> users = userMapper.getAllUsers();

// è·å–åˆ†é¡µä¿¡æ¯
PageInfo<User> pageInfo = new PageInfo<>(users);
```

</TabItem>
<TabItem value="batch" label="æ‰¹é‡å¤„ç†">

æ‰¹é‡æ“ä½œå¯ä»¥æ˜¾è‘—æé«˜å¤§é‡æ•°æ®å¤„ç†çš„æ€§èƒ½ï¼š

1. ä½¿ç”¨foreachè¿›è¡Œæ‰¹é‡æ’å…¥

```xml title="æ‰¹é‡æ’å…¥"
<insert id="batchInsert" parameterType="list">
  INSERT INTO user (username, email, status)
  VALUES
  <foreach collection="list" item="user" separator=",">
    (#{user.username}, #{user.email}, #{user.status})
  </foreach>
</insert>
```

2. ä½¿ç”¨JDBCæ‰¹å¤„ç†

```java title="JDBCæ‰¹å¤„ç†"
@Update({"<script>",
         "UPDATE user",
         "<set>",
         "status = #{status}",
         "</set>",
         "WHERE id IN",
         "<foreach collection='ids' item='id' open='(' separator=',' close=')'>",
         "#{id}",
         "</foreach>",
         "</script>"})
@Options(useGeneratedKeys = false, flushCache = Options.FlushCachePolicy.TRUE, 
         statementType = StatementType.PREPARED)
void batchUpdateUserStatus(@Param("ids") List<Long> ids, @Param("status") int status);

// åœ¨Springé…ç½®ä¸­å¯ç”¨æ‰¹å¤„ç†
@Bean
public SqlSessionFactory sqlSessionFactory(DataSource dataSource) throws Exception {
    SqlSessionFactoryBean factoryBean = new SqlSessionFactoryBean();
    factoryBean.setDataSource(dataSource);
    
    // å…ˆæ„å»ºSqlSessionFactory
    SqlSessionFactory factory = factoryBean.getObject();
    // å†é…ç½®ExecutorType
    factory.getConfiguration().setDefaultExecutorType(ExecutorType.BATCH);
    
    return factory;
}

// ä½¿ç”¨æ‰¹å¤„ç†æ‰§è¡Œå™¨
public void batchUpdateUsers(List<User> users) {
    try (SqlSession sqlSession = sqlSessionFactory.openSession(ExecutorType.BATCH)) {
        UserMapper mapper = sqlSession.getMapper(UserMapper.class);
        
        for (User user : users) {
            mapper.updateUser(user);
        }
        
        // æ‰¹é‡æäº¤
        sqlSession.flushStatements();
        sqlSession.commit();
    }
}
```

</TabItem>
</Tabs>

:::warning æ€§èƒ½ä¼˜åŒ–æ³¨æ„äº‹é¡¹
1. **åˆç†ä½¿ç”¨ç¼“å­˜**ï¼šç¼“å­˜ä¸æ˜¯ä¸‡èƒ½çš„ï¼Œéœ€è¦è€ƒè™‘æ•°æ®ä¸€è‡´æ€§
2. **é¿å…è¿‡åº¦ä¼˜åŒ–**ï¼šå…ˆæ‰¾å‡ºçœŸæ­£çš„æ€§èƒ½ç“¶é¢ˆï¼Œå†æœ‰é’ˆå¯¹æ€§åœ°ä¼˜åŒ–
3. **ç›‘æ§ä¸æµ‹è¯•**ï¼šå¼•å…¥æ€§èƒ½ç›‘æ§ï¼ŒéªŒè¯ä¼˜åŒ–æ•ˆæœ
4. **å†…å­˜æ¶ˆè€—**ï¼šç¼“å­˜ä¼šå¢åŠ å†…å­˜ä½¿ç”¨ï¼Œéœ€è¦å¹³è¡¡é…ç½®
5. **å®šæœŸç»´æŠ¤**ï¼šæ¸…ç†ä¸å¿…è¦çš„ç¼“å­˜ï¼Œæ‰§è¡Œå¿…è¦çš„æ•°æ®åº“ä¼˜åŒ–
:::

:::tip MyBatisæ€§èƒ½ä¼˜åŒ–æ¸…å•
1. **ä½¿ç”¨äºŒçº§ç¼“å­˜**ï¼šä¸ºé¢‘ç¹æŸ¥è¯¢ä¸”å¾ˆå°‘æ›´æ–°çš„æ•°æ®é…ç½®ç¼“å­˜
2. **å»¶è¿ŸåŠ è½½**ï¼šåªåœ¨éœ€è¦æ—¶åŠ è½½å¤æ‚å…³è”å¯¹è±¡
3. **æ‰¹é‡æ“ä½œ**ï¼šå‡å°‘æ•°æ®åº“å¾€è¿”æ¬¡æ•°
4. **åˆ†é¡µæŸ¥è¯¢**ï¼šé¿å…ä¸€æ¬¡æ€§åŠ è½½å¤§é‡æ•°æ®
5. **SQLä¼˜åŒ–**ï¼šç¼–å†™é«˜æ•ˆSQLï¼Œå–„ç”¨ç´¢å¼•
6. **ç»“æœé›†å¤„ç†**ï¼šåªæŸ¥è¯¢å¿…è¦çš„å­—æ®µ
7. **è¿æ¥æ± é…ç½®**ï¼šä¼˜åŒ–æ•°æ®åº“è¿æ¥æ± å‚æ•°
8. **é¿å…N+1é—®é¢˜**ï¼šä½¿ç”¨å…³è”æŸ¥è¯¢æ›¿ä»£å¤šæ¬¡å•ç‹¬æŸ¥è¯¢
:::

## 7. æ’ä»¶å¼€å‘ä¸å®šåˆ¶æ‰©å±•

MyBatisæä¾›äº†å¼ºå¤§çš„æ’ä»¶æœºåˆ¶ï¼Œå¯ä»¥åœ¨SQLæ‰§è¡Œçš„å…³é”®èŠ‚ç‚¹è¿›è¡Œæ‹¦æˆªå¹¶æ·»åŠ è‡ªå®šä¹‰è¡Œä¸ºã€‚æ’ä»¶æœºåˆ¶æ˜¯MyBatisçµæ´»æ€§å’Œå¯æ‰©å±•æ€§çš„é‡è¦ä½“ç°ã€‚

```mermaid
graph TD
    A[MyBatisæ’ä»¶æœºåˆ¶] --> B[æ‹¦æˆªç‚¹]
    B --> B1[Executor]
    B --> B2[ParameterHandler]
    B --> B3[ResultSetHandler]
    B --> B4[StatementHandler]
    
    A --> C[æ‹¦æˆªæ–¹æ³•]
    C --> C1[updateæ–¹æ³•]
    C --> C2[queryæ–¹æ³•]
    C --> C3[flushStatementsæ–¹æ³•]
    C --> C4[commit/rollbackæ–¹æ³•]
    C --> C5[getParameterObjectæ–¹æ³•]
    C --> C6[setParametersæ–¹æ³•]
    C --> C7[prepareæ–¹æ³•]
    C --> C8[handleResultSetsæ–¹æ³•]
    
    A --> D[è´£ä»»é“¾æ¨¡å¼]
    D --> D1[å¤šæ’ä»¶é¡ºåºæ‰§è¡Œ]
    D --> D2[å±‚å±‚ä»£ç†å¯¹è±¡]
```

### 7.1 æ’ä»¶æœºåˆ¶åŸç†

MyBatisæ’ä»¶åŸºäºåŠ¨æ€ä»£ç†å’Œè´£ä»»é“¾æ¨¡å¼è®¾è®¡ï¼Œé€šè¿‡æ‹¦æˆªæ ¸å¿ƒç»„ä»¶çš„æ–¹æ³•è°ƒç”¨å®ç°åŠŸèƒ½æ‰©å±•ã€‚

<Tabs>
<TabItem value="intercept-points" label="æ‹¦æˆªç‚¹">

MyBatisæä¾›äº†å››ä¸ªæ‹¦æˆªç‚¹ï¼Œå¯¹åº”æ ¸å¿ƒç»„ä»¶çš„ä¸åŒå¤„ç†é˜¶æ®µï¼š

1. **Executor**ï¼šè´Ÿè´£æ‰§è¡ŒSQLçš„æ ¸å¿ƒç»„ä»¶ï¼ŒåŒ…æ‹¬åˆ›å»ºStatementã€å‚æ•°è®¾ç½®ã€æ‰§è¡ŒSQLã€å¤„ç†ç»“æœç­‰
   - `update`: æ‰§è¡Œæ’å…¥/æ›´æ–°/åˆ é™¤æ“ä½œ
   - `query`: æ‰§è¡ŒæŸ¥è¯¢æ“ä½œ
   - `flushStatements`: åˆ·æ–°è¯­å¥
   - `commit`: æäº¤äº‹åŠ¡
   - `rollback`: å›æ»šäº‹åŠ¡
   - `getTransaction`: è·å–äº‹åŠ¡
   - `close`: å…³é—­executor
   - `isClosed`: æ£€æŸ¥executoræ˜¯å¦å…³é—­

2. **StatementHandler**ï¼šè´Ÿè´£å¤„ç†JDBC Statementçš„ç»„ä»¶
   - `prepare`: å‡†å¤‡Statement
   - `parameterize`: è®¾ç½®å‚æ•°
   - `batch`: æ‰¹å¤„ç†
   - `update`: æ‰§è¡Œæ›´æ–°
   - `query`: æ‰§è¡ŒæŸ¥è¯¢

3. **ParameterHandler**ï¼šè´Ÿè´£å¤„ç†SQLå‚æ•°çš„ç»„ä»¶
   - `getParameterObject`: è·å–å‚æ•°å¯¹è±¡
   - `setParameters`: è®¾ç½®å‚æ•°

4. **ResultSetHandler**ï¼šè´Ÿè´£å¤„ç†æŸ¥è¯¢ç»“æœé›†çš„ç»„ä»¶
   - `handleResultSets`: å¤„ç†ç»“æœé›†
   - `handleOutputParameters`: å¤„ç†è¾“å‡ºå‚æ•°

```java title="æ‹¦æˆªç‚¹æ³¨è§£ç¤ºä¾‹"
@Intercepts({
    // æ‹¦æˆªExecutorçš„updateæ–¹æ³•
    @Signature(
        type = Executor.class,
        method = "update",
        args = {MappedStatement.class, Object.class}
    ),
    // æ‹¦æˆªExecutorçš„queryæ–¹æ³•
    @Signature(
        type = Executor.class,
        method = "query",
        args = {MappedStatement.class, Object.class, RowBounds.class, ResultHandler.class}
    ),
    // æ‹¦æˆªStatementHandlerçš„prepareæ–¹æ³•
    @Signature(
        type = StatementHandler.class,
        method = "prepare",
        args = {Connection.class, Integer.class}
    )
})
public class ExamplePlugin implements Interceptor {
    // å®ç°æ‹¦æˆªé€»è¾‘...
}
```

</TabItem>
<TabItem value="proxy-mechanism" label="ä»£ç†æœºåˆ¶">

MyBatisæ’ä»¶ä½¿ç”¨JDKåŠ¨æ€ä»£ç†å®ç°æ–¹æ³•æ‹¦æˆªï¼š

1. **æ’ä»¶æ³¨å†Œ**ï¼šåœ¨MyBatisåˆå§‹åŒ–æ—¶ï¼Œé€šè¿‡`InterceptorChain`æ³¨å†Œæ‰€æœ‰æ’ä»¶
2. **åˆ›å»ºä»£ç†**ï¼šä¸ºæ¯ä¸ªç›®æ ‡å¯¹è±¡åˆ›å»ºä»£ç†ï¼Œä»£ç†ä¼šæ‹¦æˆªç‰¹å®šæ–¹æ³•è°ƒç”¨
3. **è´£ä»»é“¾æ‰§è¡Œ**ï¼šæŒ‰ç…§æ’ä»¶æ³¨å†Œé¡ºåºä¾æ¬¡æ‰§è¡Œæ‹¦æˆªå™¨é“¾ä¸­çš„æ’ä»¶
4. **å‚æ•°è®¿é—®**ï¼šé€šè¿‡`Invocation`å¯¹è±¡è®¿é—®è¢«æ‹¦æˆªæ–¹æ³•çš„å‚æ•°å’Œç›®æ ‡å¯¹è±¡
5. **æ§åˆ¶æµç¨‹**ï¼šæ’ä»¶å¯ä»¥ä¿®æ”¹å‚æ•°ã€æ‰§è¡Œé¢å¤–é€»è¾‘ã€ä¿®æ”¹è¿”å›ç»“æœï¼Œç”šè‡³ä¸æ‰§è¡ŒåŸæ–¹æ³•

```java title="æ’ä»¶æ‰§è¡Œæµç¨‹"
// åˆå§‹åŒ–æ’ä»¶é“¾
InterceptorChain interceptorChain = new InterceptorChain();
interceptorChain.addInterceptor(new LoggingPlugin());
interceptorChain.addInterceptor(new PaginationPlugin());
interceptorChain.addInterceptor(new PerformancePlugin());

// åˆ›å»ºä»£ç†å¯¹è±¡
Executor target = new SimpleExecutor();
Executor proxy = (Executor) interceptorChain.pluginAll(target);

// æ‰§è¡Œæ–¹æ³•æ—¶ï¼Œä¼šè§¦å‘æ’ä»¶é“¾
// 3. PerformancePlugin.intercept()
//   2. PaginationPlugin.intercept()
//     1. LoggingPlugin.intercept()
//       target.query() // åŸæ–¹æ³•æ‰§è¡Œ
//     1. è¿”å›ç»“æœ
//   2. è¿”å›ç»“æœ
// 3. è¿”å›ç»“æœ
proxy.query(...);
```

</TabItem>
<TabItem value="plugin-annotation" label="æ’ä»¶æ³¨è§£">

`@Intercepts`å’Œ`@Signature`æ³¨è§£ç”¨äºå£°æ˜æ‹¦æˆªç‚¹ï¼š

```java title="æ’ä»¶æ³¨è§£è¯¦è§£"
@Documented
@Retention(RetentionPolicy.RUNTIME)
@Target(ElementType.TYPE)
public @interface Intercepts {
  Signature[] value();
}

@Documented
@Retention(RetentionPolicy.RUNTIME)
@Target({})
public @interface Signature {
  Class<?> type();  // æ‹¦æˆªçš„æ¥å£ç±»å‹
  String method();  // æ‹¦æˆªçš„æ–¹æ³•å
  Class<?>[] args();  // æ‹¦æˆªçš„æ–¹æ³•å‚æ•°ç±»å‹
}
```

æ‹¦æˆªç‚¹çš„å®Œæ•´åŒ¹é…è§„åˆ™ï¼š
1. è¢«æ‹¦æˆªå¯¹è±¡å¿…é¡»æ˜¯`@Signature.type`æŒ‡å®šçš„ç±»å‹
2. è¢«æ‹¦æˆªæ–¹æ³•å¿…é¡»æ˜¯`@Signature.method`æŒ‡å®šçš„æ–¹æ³•å
3. è¢«æ‹¦æˆªæ–¹æ³•çš„å‚æ•°å¿…é¡»ä¸`@Signature.args`æŒ‡å®šçš„å‚æ•°ç±»å‹åˆ—è¡¨ä¸€è‡´

</TabItem>
<TabItem value="plugin-loading" label="æ’ä»¶åŠ è½½">

MyBatisåŠ è½½å’Œåˆå§‹åŒ–æ’ä»¶çš„è¿‡ç¨‹ï¼š

1. **é…ç½®è§£æ**ï¼šè§£æ`mybatis-config.xml`ä¸­çš„`plugins`èŠ‚ç‚¹
2. **å®ä¾‹åŒ–æ’ä»¶**ï¼šæ ¹æ®é…ç½®åˆ›å»ºæ’ä»¶å®ä¾‹ï¼Œå¹¶è®¾ç½®å±æ€§
3. **æ³¨å†Œæ’ä»¶**ï¼šå°†æ’ä»¶æ·»åŠ åˆ°`InterceptorChain`ä¸­
4. **åŒ…è£…ç›®æ ‡å¯¹è±¡**ï¼šåœ¨åˆ›å»ºæ ¸å¿ƒç»„ä»¶æ—¶ï¼Œé€šè¿‡`InterceptorChain.pluginAll()`æ–¹æ³•åŒ…è£…ç›®æ ‡å¯¹è±¡

```xml title="æ’ä»¶é…ç½®"
<plugins>
  <plugin interceptor="com.example.plugin.LoggingPlugin">
    <property name="level" value="DEBUG"/>
  </plugin>
  <plugin interceptor="com.example.plugin.PaginationPlugin">
    <property name="dialect" value="mysql"/>
  </plugin>
</plugins>
```

```java title="æ’ä»¶åŠ è½½è¿‡ç¨‹"
// 1. é…ç½®è§£æ
List<InterceptorConfig> interceptorConfigs = parseConfig(root.evalNode("plugins"));

// 2. å®ä¾‹åŒ–æ’ä»¶
for (InterceptorConfig config : interceptorConfigs) {
    Interceptor interceptor = (Interceptor) resolveClass(config.getInterceptorClass()).newInstance();
    interceptor.setProperties(config.getProperties());
    
    // 3. æ³¨å†Œæ’ä»¶
    configuration.addInterceptor(interceptor);
}

// 4. åŒ…è£…ç›®æ ‡å¯¹è±¡ï¼ˆç¤ºä¾‹ï¼šåˆ›å»ºExecutorï¼‰
public Executor newExecutor(Transaction transaction, ExecutorType executorType) {
    Executor executor;
    if (ExecutorType.BATCH == executorType) {
        executor = new BatchExecutor(this, transaction);
    } else if (ExecutorType.REUSE == executorType) {
        executor = new ReuseExecutor(this, transaction);
    } else {
        executor = new SimpleExecutor(this, transaction);
    }
    
    // åŒ…è£…Executor
    return (Executor) interceptorChain.pluginAll(executor);
}
```

</TabItem>
</Tabs>

### 7.2 è‡ªå®šä¹‰æ’ä»¶å¼€å‘

å¼€å‘MyBatisæ’ä»¶éœ€è¦å®ç°`Interceptor`æ¥å£ï¼Œé€šè¿‡æ‹¦æˆªç‚¹è¿›è¡ŒåŠŸèƒ½æ‰©å±•ã€‚ä»¥ä¸‹æ˜¯å¸¸è§çš„æ’ä»¶å¼€å‘åœºæ™¯ã€‚

<Tabs>
<TabItem value="basic" label="æ’ä»¶åŸºæœ¬ç»“æ„">

å®ç°ä¸€ä¸ªMyBatisæ’ä»¶éœ€è¦å®Œæˆä»¥ä¸‹æ­¥éª¤ï¼š

1. å®ç°`org.apache.ibatis.plugin.Interceptor`æ¥å£
2. ä½¿ç”¨`@Intercepts`å’Œ`@Signature`æ³¨è§£å®šä¹‰æ‹¦æˆªç‚¹
3. åœ¨`intercept()`æ–¹æ³•ä¸­å®ç°æ‹¦æˆªé€»è¾‘
4. åœ¨`plugin()`æ–¹æ³•ä¸­åŒ…è£…ç›®æ ‡å¯¹è±¡
5. å®ç°`setProperties()`æ–¹æ³•å¤„ç†æ’ä»¶é…ç½®å±æ€§

```java title="æ’ä»¶åŸºæœ¬ç»“æ„"
@Intercepts({
    @Signature(
        type = Executor.class,
        method = "update",
        args = {MappedStatement.class, Object.class}
    )
})
public class ExamplePlugin implements Interceptor {
    
    private Properties properties = new Properties();
    
    @Override
    public Object intercept(Invocation invocation) throws Throwable {
        // åœ¨æ–¹æ³•æ‰§è¡Œå‰æ·»åŠ é€»è¾‘
        Object target = invocation.getTarget(); // ç›®æ ‡å¯¹è±¡
        Method method = invocation.getMethod(); // è¢«æ‹¦æˆªçš„æ–¹æ³•
        Object[] args = invocation.getArgs();   // æ–¹æ³•å‚æ•°
        
        // æ‰§è¡ŒåŸæ–¹æ³•
        Object result = invocation.proceed();
        
        // åœ¨æ–¹æ³•æ‰§è¡Œåæ·»åŠ é€»è¾‘
        
        return result;
    }
    
    @Override
    public Object plugin(Object target) {
        // åŒ…è£…ç›®æ ‡å¯¹è±¡ä¸ºä»£ç†å¯¹è±¡
        return Plugin.wrap(target, this);
    }
    
    @Override
    public void setProperties(Properties properties) {
        // è®¾ç½®æ’ä»¶å±æ€§
        this.properties = properties;
    }
}
```

</TabItem>
<TabItem value="sql-logger" label="SQLæ—¥å¿—æ’ä»¶">

å®ç°ä¸€ä¸ªSQLæ—¥å¿—è®°å½•æ’ä»¶ï¼Œè®°å½•SQLæ‰§è¡Œæ—¶é—´å’Œå‚æ•°ï¼š

```java title="SQLæ—¥å¿—æ’ä»¶"
@Intercepts({
    @Signature(
        type = StatementHandler.class,
        method = "query",
        args = {Statement.class, ResultHandler.class}
    ),
    @Signature(
        type = StatementHandler.class,
        method = "update",
        args = {Statement.class}
    )
})
public class SqlLoggerPlugin implements Interceptor {
    
    private static final Logger logger = LoggerFactory.getLogger(SqlLoggerPlugin.class);
    private boolean showSql = true;
    private boolean showParams = true;
    private boolean showTime = true;
    
    @Override
    public Object intercept(Invocation invocation) throws Throwable {
        StatementHandler handler = (StatementHandler) invocation.getTarget();
        long startTime = System.currentTimeMillis();
        
        try {
            // æ‰§è¡ŒSQL
            Object result = invocation.proceed();
            
            // è®°å½•æ—¥å¿—
            if (showSql || showParams || showTime) {
                BoundSql boundSql = handler.getBoundSql();
                String sql = boundSql.getSql().replaceAll("\\s+", " ");
                Object parameterObject = boundSql.getParameterObject();
                long elapsed = System.currentTimeMillis() - startTime;
                
                StringBuilder logBuilder = new StringBuilder();
                if (showSql) {
                    logBuilder.append("SQL: ").append(sql);
                }
                
                if (showParams) {
                    logBuilder.append("\nParameters: ").append(parameterObject);
                }
                
                if (showTime) {
                    logBuilder.append("\nExecution Time: ").append(elapsed).append("ms");
                }
                
                logger.debug(logBuilder.toString());
            }
            
            return result;
        } catch (Throwable e) {
            long elapsed = System.currentTimeMillis() - startTime;
            logger.error("SQL execution error, Time: {}ms", elapsed, e);
            throw e;
        }
    }
    
    @Override
    public Object plugin(Object target) {
        return Plugin.wrap(target, this);
    }
    
    @Override
    public void setProperties(Properties properties) {
        this.showSql = Boolean.parseBoolean(properties.getProperty("showSql", "true"));
        this.showParams = Boolean.parseBoolean(properties.getProperty("showParams", "true"));
        this.showTime = Boolean.parseBoolean(properties.getProperty("showTime", "true"));
    }
}
```

é…ç½®SQLæ—¥å¿—æ’ä»¶ï¼š

```xml title="æ’ä»¶é…ç½®"
<plugin interceptor="com.example.plugin.SqlLoggerPlugin">
  <property name="showSql" value="true"/>
  <property name="showParams" value="true"/>
  <property name="showTime" value="true"/>
</plugin>
```

</TabItem>
<TabItem value="param-encrypt" label="å‚æ•°åŠ å¯†æ’ä»¶">

å®ç°ä¸€ä¸ªå‚æ•°åŠ å¯†æ’ä»¶ï¼Œè‡ªåŠ¨å¯¹æŒ‡å®šå‚æ•°è¿›è¡ŒåŠ å¯†ï¼š

```java title="å‚æ•°åŠ å¯†æ’ä»¶"
@Intercepts({
    @Signature(
        type = ParameterHandler.class,
        method = "setParameters",
        args = {PreparedStatement.class}
    )
})
public class ParameterEncryptPlugin implements Interceptor {
    
    private Set<String> encryptFields = new HashSet<>();
    private EncryptionService encryptionService;
    
    @Override
    public Object intercept(Invocation invocation) throws Throwable {
        ParameterHandler handler = (ParameterHandler) invocation.getTarget();
        
        // è·å–å‚æ•°å¯¹è±¡
        Field parameterObjectField = handler.getClass().getDeclaredField("parameterObject");
        parameterObjectField.setAccessible(true);
        Object parameterObject = parameterObjectField.get(handler);
        
        // åŠ å¯†å‚æ•°
        if (parameterObject != null) {
            if (parameterObject instanceof Map) {
                // å¤„ç†Mapå‚æ•°
                Map<String, Object> paramMap = (Map<String, Object>) parameterObject;
                for (String field : encryptFields) {
                    if (paramMap.containsKey(field) && paramMap.get(field) != null) {
                        String value = paramMap.get(field).toString();
                        paramMap.put(field, encryptionService.encrypt(value));
                    }
                }
            } else {
                // å¤„ç†JavaBeanå‚æ•°
                for (String field : encryptFields) {
                    try {
                        PropertyDescriptor descriptor = new PropertyDescriptor(field, parameterObject.getClass());
                        Method getter = descriptor.getReadMethod();
                        Method setter = descriptor.getWriteMethod();
                        
                        if (getter != null && setter != null) {
                            Object value = getter.invoke(parameterObject);
                            if (value != null && value instanceof String) {
                                setter.invoke(parameterObject, encryptionService.encrypt((String) value));
                            }
                        }
                    } catch (Exception e) {
                        // å¿½ç•¥ä¸å­˜åœ¨çš„å±æ€§
                    }
                }
            }
        }
        
        // æ‰§è¡ŒåŸæ–¹æ³•
        return invocation.proceed();
    }
    
    @Override
    public Object plugin(Object target) {
        return Plugin.wrap(target, this);
    }
    
    @Override
    public void setProperties(Properties properties) {
        String fields = properties.getProperty("encryptFields", "");
        for (String field : fields.split(",")) {
            field = field.trim();
            if (!field.isEmpty()) {
                encryptFields.add(field);
            }
        }
        
        // å®é™…é¡¹ç›®ä¸­åº”ä½¿ç”¨ä¾èµ–æ³¨å…¥
        encryptionService = new AESEncryptionService();
    }
}

// åŠ å¯†æœåŠ¡æ¥å£å’Œå®ç°
interface EncryptionService {
    String encrypt(String data);
    String decrypt(String encryptedData);
}

class AESEncryptionService implements EncryptionService {
    private static final String KEY = "1234567890abcdef";
    
    @Override
    public String encrypt(String data) {
        // AESåŠ å¯†å®ç°...
        return "ENCRYPTED:" + data;
    }
    
    @Override
    public String decrypt(String encryptedData) {
        // AESè§£å¯†å®ç°...
        return encryptedData.substring("ENCRYPTED:".length());
    }
}
```

é…ç½®å‚æ•°åŠ å¯†æ’ä»¶ï¼š

```xml title="æ’ä»¶é…ç½®"
<plugin interceptor="com.example.plugin.ParameterEncryptPlugin">
  <property name="encryptFields" value="password,creditCard,idNumber"/>
</plugin>
```

</TabItem>
</Tabs>

### 7.3 åˆ†é¡µæ’ä»¶å®ç°

åˆ†é¡µæ˜¯åº”ç”¨ä¸­å¸¸è§çš„éœ€æ±‚ï¼Œé€šè¿‡æ’ä»¶æœºåˆ¶å¯ä»¥å®ç°ç»Ÿä¸€çš„åˆ†é¡µåŠŸèƒ½ï¼Œé¿å…æ‰‹åŠ¨ç¼–å†™åˆ†é¡µä»£ç ã€‚

<Tabs>
<TabItem value="custom" label="è‡ªå®šä¹‰åˆ†é¡µæ’ä»¶">

å®ç°ä¸€ä¸ªåŸºç¡€çš„åˆ†é¡µæ’ä»¶ï¼š

```java title="è‡ªå®šä¹‰åˆ†é¡µæ’ä»¶"
@Intercepts({
    @Signature(
        type = Executor.class,
        method = "query",
        args = {MappedStatement.class, Object.class, RowBounds.class, ResultHandler.class}
    )
})
public class PaginationPlugin implements Interceptor {
    
    private String databaseType;
    
    @Override
    public Object intercept(Invocation invocation) throws Throwable {
        Object[] args = invocation.getArgs();
        MappedStatement ms = (MappedStatement) args[0];
        Object parameterObject = args[1];
        RowBounds rowBounds = (RowBounds) args[2];
        
        // åˆ¤æ–­æ˜¯å¦éœ€è¦åˆ†é¡µ
        if (rowBounds == null || rowBounds == RowBounds.DEFAULT) {
            // ä¸éœ€è¦åˆ†é¡µï¼Œæ‰§è¡ŒåŸæ–¹æ³•
            return invocation.proceed();
        }
        
        // è·å–åŸå§‹SQL
        BoundSql boundSql = ms.getBoundSql(parameterObject);
        String sql = boundSql.getSql().trim();
        
        // æ„å»ºåˆ†é¡µSQL
        String pageSql = buildPageSql(sql, rowBounds);
        
        // åˆ›å»ºæ–°çš„BoundSql
        BoundSql newBoundSql = copyBoundSql(ms, boundSql, pageSql);
        
        // åˆ›å»ºæ–°çš„MappedStatement
        MappedStatement newMs = copyMappedStatement(ms, newBoundSql);
        
        // æ¸…é™¤RowBoundsï¼Œé¿å…MyBatiså†…å­˜åˆ†é¡µ
        args[0] = newMs;
        args[2] = RowBounds.DEFAULT;
        
        // æ‰§è¡Œåˆ†é¡µæŸ¥è¯¢
        return invocation.proceed();
    }
    
    /**
     * æ ¹æ®æ•°æ®åº“ç±»å‹æ„å»ºåˆ†é¡µSQL
     */
    private String buildPageSql(String sql, RowBounds rowBounds) {
        int offset = rowBounds.getOffset();
        int limit = rowBounds.getLimit();
        
        StringBuilder pageSql = new StringBuilder(sql.length() + 100);
        
        if ("mysql".equalsIgnoreCase(databaseType)) {
            pageSql.append(sql)
                   .append(" LIMIT ")
                   .append(offset)
                   .append(", ")
                   .append(limit);
        } else if ("oracle".equalsIgnoreCase(databaseType)) {
            pageSql.append("SELECT * FROM ( ")
                   .append("SELECT TMP.*, ROWNUM ROW_ID FROM ( ")
                   .append(sql)
                   .append(" ) TMP WHERE ROWNUM <= ")
                   .append(offset + limit)
                   .append(" ) WHERE ROW_ID > ")
                   .append(offset);
        } else if ("sqlserver".equalsIgnoreCase(databaseType)) {
            // SQL Server 2012+
            pageSql.append(sql)
                   .append(" OFFSET ")
                   .append(offset)
                   .append(" ROWS FETCH NEXT ")
                   .append(limit)
                   .append(" ROWS ONLY");
        } else {
            // é»˜è®¤ä½¿ç”¨MySQLè¯­æ³•
            pageSql.append(sql)
                   .append(" LIMIT ")
                   .append(offset)
                   .append(", ")
                   .append(limit);
        }
        
        return pageSql.toString();
    }
    
    /**
     * åˆ›å»ºæ–°çš„BoundSql
     */
    private BoundSql copyBoundSql(MappedStatement ms, BoundSql boundSql, String sql) {
        // å¤åˆ¶BoundSqlçš„å®ç°...
        // å®é™…ä»£ç éœ€è¦å¤åˆ¶boundSqlçš„æ‰€æœ‰å±æ€§å’Œå‚æ•°æ˜ å°„
        
        return new BoundSql(
            ms.getConfiguration(),
            sql,
            boundSql.getParameterMappings(),
            boundSql.getParameterObject()
        );
    }
    
    /**
     * åˆ›å»ºæ–°çš„MappedStatement
     */
    private MappedStatement copyMappedStatement(MappedStatement ms, BoundSql boundSql) {
        // å¤åˆ¶MappedStatementçš„å®ç°...
        // å®é™…ä»£ç éœ€è¦ä½¿ç”¨MappedStatement.Builderæ¥æ„å»ºæ–°çš„MappedStatement
        
        return new MappedStatement.Builder(
            ms.getConfiguration(),
            ms.getId(),
            new StaticSqlSource(ms.getConfiguration(), boundSql.getSql(), boundSql.getParameterMappings()),
            ms.getSqlCommandType()
        ).cache(ms.getCache())
         .fetchSize(ms.getFetchSize())
         .flushCacheRequired(ms.isFlushCacheRequired())
         .useCache(ms.isUseCache())
         .resultMaps(ms.getResultMaps())
         .resultSetType(ms.getResultSetType())
         .statementType(ms.getStatementType())
         .timeout(ms.getTimeout())
         .parameterMap(ms.getParameterMap())
         .build();
    }
    
    @Override
    public Object plugin(Object target) {
        return Plugin.wrap(target, this);
    }
    
    @Override
    public void setProperties(Properties properties) {
        this.databaseType = properties.getProperty("databaseType", "mysql");
    }
}
```

é…ç½®åˆ†é¡µæ’ä»¶ï¼š

```xml title="æ’ä»¶é…ç½®"
<plugin interceptor="com.example.plugin.PaginationPlugin">
  <property name="databaseType" value="mysql"/>
</plugin>
```

ä½¿ç”¨åˆ†é¡µæ’ä»¶ï¼š

```java title="åˆ†é¡µæŸ¥è¯¢"
// åˆ›å»ºåˆ†é¡µå‚æ•°ï¼ˆoffset, limitï¼‰
RowBounds rowBounds = new RowBounds(20, 10); // ä»ç¬¬21æ¡å¼€å§‹ï¼Œè·å–10æ¡

// æ‰§è¡Œåˆ†é¡µæŸ¥è¯¢
List<User> users = sqlSession.selectList("getUserList", parameter, rowBounds);
```

</TabItem>
<TabItem value="pagehelper" label="PageHelperæ’ä»¶">

PageHelperæ˜¯MyBatisæœ€æµè¡Œçš„åˆ†é¡µæ’ä»¶ï¼Œæä¾›äº†æ›´åŠ ç®€ä¾¿çš„åˆ†é¡µAPIï¼š

1. æ·»åŠ PageHelperä¾èµ–

```xml title="pom.xml"
<dependency>
    <groupId>com.github.pagehelper</groupId>
    <artifactId>pagehelper</artifactId>
    <version>5.2.0</version>
</dependency>
```

2. é…ç½®PageHelperæ’ä»¶

```xml title="mybatis-config.xml"
<plugins>
  <plugin interceptor="com.github.pagehelper.PageInterceptor">
    <property name="helperDialect" value="mysql"/>
    <property name="reasonable" value="true"/>
    <property name="supportMethodsArguments" value="true"/>
  </plugin>
</plugins>
```

æˆ–è€…åœ¨Spring Bootä¸­é…ç½®ï¼š

```java title="MyBatisConfig.java"
@Configuration
public class MyBatisConfig {
    @Bean
    public PageInterceptor pageInterceptor() {
        PageInterceptor pageInterceptor = new PageInterceptor();
        Properties properties = new Properties();
        properties.setProperty("helperDialect", "mysql");
        properties.setProperty("reasonable", "true");
        properties.setProperty("supportMethodsArguments", "true");
        pageInterceptor.setProperties(properties);
        return pageInterceptor;
    }
}
```

3. ä½¿ç”¨PageHelperè¿›è¡Œåˆ†é¡µ

```java title="åˆ†é¡µæŸ¥è¯¢"
// æ–¹å¼1ï¼šä½¿ç”¨PageHelper.startPageå¼€å§‹åˆ†é¡µ
PageHelper.startPage(1, 10);  // ç¬¬1é¡µï¼Œæ¯é¡µ10æ¡
List<User> users = userMapper.getAllUsers();

// è·å–åˆ†é¡µä¿¡æ¯
PageInfo<User> pageInfo = new PageInfo<>(users);
System.out.println("æ€»è®°å½•æ•°: " + pageInfo.getTotal());
System.out.println("æ€»é¡µæ•°: " + pageInfo.getPages());
System.out.println("å½“å‰é¡µ: " + pageInfo.getPageNum());
System.out.println("æ¯é¡µè®°å½•æ•°: " + pageInfo.getPageSize());

// æ–¹å¼2ï¼šä½¿ç”¨PageHelper.offsetPageæŒ‡å®šåç§»é‡å’Œé™åˆ¶æ•°
PageHelper.offsetPage(20, 10);  // åç§»20æ¡ï¼Œé™åˆ¶10æ¡
List<User> users = userMapper.getAllUsers();
```

</TabItem>
</Tabs>

### 7.4 æ€§èƒ½ç›‘æ§æ’ä»¶

é€šè¿‡æ’ä»¶æœºåˆ¶å¯ä»¥å®ç°SQLæ€§èƒ½ç›‘æ§å’Œç»Ÿè®¡åŠŸèƒ½ï¼Œå¸®åŠ©è¯†åˆ«å’Œä¼˜åŒ–æ…¢æŸ¥è¯¢ã€‚

<Tabs>
<TabItem value="sql-stats" label="SQLæ€§èƒ½ç›‘æ§">

å®ç°ä¸€ä¸ªç›‘æ§SQLæ‰§è¡Œæ—¶é—´çš„æ’ä»¶ï¼š

```java title="SQLæ€§èƒ½ç›‘æ§æ’ä»¶"
@Intercepts({
    @Signature(
        type = Executor.class,
        method = "update",
        args = {MappedStatement.class, Object.class}
    ),
    @Signature(
        type = Executor.class,
        method = "query",
        args = {MappedStatement.class, Object.class, RowBounds.class, ResultHandler.class}
    )
})
public class SqlPerformancePlugin implements Interceptor {
    
    private static final Logger logger = LoggerFactory.getLogger(SqlPerformancePlugin.class);
    private long slowSqlThreshold = 1000; // æ…¢æŸ¥è¯¢é˜ˆå€¼ï¼Œå•ä½æ¯«ç§’
    
    // è®°å½•SQLæ‰§è¡Œç»Ÿè®¡ä¿¡æ¯
    private final ConcurrentHashMap<String, SqlStats> sqlStatsMap = new ConcurrentHashMap<>();
    
    @Override
    public Object intercept(Invocation invocation) throws Throwable {
        MappedStatement ms = (MappedStatement) invocation.getArgs()[0];
        Object parameter = invocation.getArgs()[1];
        
        String sqlId = ms.getId();
        BoundSql boundSql = ms.getBoundSql(parameter);
        String sql = boundSql.getSql();
        
        long startTime = System.currentTimeMillis();
        Object result = null;
        boolean success = false;
        
        try {
            // æ‰§è¡ŒSQL
            result = invocation.proceed();
            success = true;
            return result;
        } catch (Throwable e) {
            throw e;
        } finally {
            long endTime = System.currentTimeMillis();
            long costTime = endTime - startTime;
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            updateStats(sqlId, costTime, success);
            
            // è®°å½•æ…¢æŸ¥è¯¢
            if (costTime > slowSqlThreshold) {
                logger.warn("Slow SQL detected: {} ms, SQL ID: {}, SQL: {}", costTime, sqlId, getSqlWithParams(boundSql));
            }
        }
    }
    
    private void updateStats(String sqlId, long costTime, boolean success) {
        SqlStats stats = sqlStatsMap.computeIfAbsent(sqlId, k -> new SqlStats());
        
        stats.incrementCount();
        stats.addExecutionTime(costTime);
        
        if (costTime > stats.getMaxTime()) {
            stats.setMaxTime(costTime);
        }
        
        if (costTime < stats.getMinTime() || stats.getMinTime() == 0) {
            stats.setMinTime(costTime);
        }
        
        if (!success) {
            stats.incrementErrorCount();
        }
    }
    
    private String getSqlWithParams(BoundSql boundSql) {
        // è·å–SQLè¯­å¥å’Œå‚æ•°çš„å®ç°
        // å®é™…ä»£ç éœ€è¦è§£æå‚æ•°æ˜ å°„å’Œå‚æ•°å¯¹è±¡
        
        return boundSql.getSql();
    }
    
    /**
     * è·å–SQLç»Ÿè®¡ä¿¡æ¯
     */
    public Map<String, SqlStats> getSqlStats() {
        return new HashMap<>(sqlStatsMap);
    }
    
    /**
     * é‡ç½®ç»Ÿè®¡ä¿¡æ¯
     */
    public void resetStats() {
        sqlStatsMap.clear();
    }
    
    @Override
    public Object plugin(Object target) {
        return Plugin.wrap(target, this);
    }
    
    @Override
    public void setProperties(Properties properties) {
        String threshold = properties.getProperty("slowSqlThreshold");
        if (threshold != null) {
            this.slowSqlThreshold = Long.parseLong(threshold);
        }
    }
    
    /**
     * SQLç»Ÿè®¡ä¿¡æ¯ç±»
     */
    public static class SqlStats {
        private final AtomicLong count = new AtomicLong(0);
        private final AtomicLong totalTime = new AtomicLong(0);
        private final AtomicLong errorCount = new AtomicLong(0);
        private volatile long minTime = 0;
        private volatile long maxTime = 0;
        
        public void incrementCount() {
            count.incrementAndGet();
        }
        
        public void addExecutionTime(long time) {
            totalTime.addAndGet(time);
        }
        
        public void incrementErrorCount() {
            errorCount.incrementAndGet();
        }
        
        public long getCount() {
            return count.get();
        }
        
        public long getTotalTime() {
            return totalTime.get();
        }
        
        public long getErrorCount() {
            return errorCount.get();
        }
        
        public double getAverageTime() {
            long countVal = count.get();
            return countVal == 0 ? 0 : (double) totalTime.get() / countVal;
        }
        
        public long getMinTime() {
            return minTime;
        }
        
        public void setMinTime(long minTime) {
            this.minTime = minTime;
        }
        
        public long getMaxTime() {
            return maxTime;
        }
        
        public void setMaxTime(long maxTime) {
            this.maxTime = maxTime;
        }
    }
}
```

é…ç½®æ€§èƒ½ç›‘æ§æ’ä»¶ï¼š

```xml title="æ’ä»¶é…ç½®"
<plugin interceptor="com.example.plugin.SqlPerformancePlugin">
  <property name="slowSqlThreshold" value="1000"/>
</plugin>
```

ä½¿ç”¨ç›‘æ§æ’ä»¶æ”¶é›†çš„ç»Ÿè®¡ä¿¡æ¯ï¼š

```java title="è·å–æ€§èƒ½ç»Ÿè®¡æ•°æ®"
@RestController
@RequestMapping("/admin/monitoring")
public class MonitoringController {
    
    @Autowired
    private SqlPerformancePlugin sqlPerformancePlugin;
    
    @GetMapping("/sql-stats")
    public Map<String, SqlStats> getSqlStats() {
        return sqlPerformancePlugin.getSqlStats();
    }
    
    @PostMapping("/reset-stats")
    public ResponseEntity<Void> resetStats() {
        sqlPerformancePlugin.resetStats();
        return ResponseEntity.ok().build();
    }
}
```

</TabItem>
<TabItem value="p6spy" label="P6Spyé›†æˆ">

P6Spyæ˜¯ä¸€ä¸ªSQLç›‘æ§æ¡†æ¶ï¼Œå¯ä»¥ä¸MyBatisç»“åˆä½¿ç”¨ï¼š

1. æ·»åŠ P6Spyä¾èµ–

```xml title="pom.xml"
<dependency>
    <groupId>p6spy</groupId>
    <artifactId>p6spy</artifactId>
    <version>3.9.1</version>
</dependency>
```

2. é…ç½®P6Spyæ•°æ®æº

```java title="æ•°æ®æºé…ç½®"
@Configuration
public class DataSourceConfig {
    
    @Bean
    @Primary
    public DataSource dataSource() {
        // åŸå§‹æ•°æ®æº
        HikariDataSource dataSource = new HikariDataSource();
        dataSource.setJdbcUrl("jdbc:mysql://localhost:3306/mydb");
        dataSource.setUsername("root");
        dataSource.setPassword("password");
        
        // åŒ…è£…ä¸ºP6Spyæ•°æ®æº
        return new P6DataSource(dataSource);
    }
}
```

3. é…ç½®P6Spy (spy.properties)

```properties title="spy.properties"
# ä½¿ç”¨è‡ªå®šä¹‰çš„æ—¥å¿—æ ¼å¼
appender=com.p6spy.engine.spy.appender.Slf4JLogger
logMessageFormat=com.p6spy.engine.spy.appender.CustomLineFormat
customLogMessageFormat=%(currentTime)|%(executionTime)|%(category)|%(sqlSingleLine)

# è®¾ç½®æ‰§è¡Œæ—¶é—´è®°å½•é˜ˆå€¼ï¼ˆæ¯«ç§’ï¼‰
executionThreshold=1000

# è®¾ç½®æ—¥æœŸæ ¼å¼
dateformat=yyyy-MM-dd HH:mm:ss

# å¯ç”¨/ç¦ç”¨æ¨¡å—
excludecategories=info,debug,result,resultset

# æ’é™¤ç‰¹å®šSQLè¯­å¥
exclude=SELECT NOW()
```

4. è‡ªå®šä¹‰P6Spyç›‘å¬å™¨

```java title="è‡ªå®šä¹‰P6Spyäº‹ä»¶ç›‘å¬å™¨"
public class CustomP6SpyListener extends JdbcEventListener {
    
    private static final Logger logger = LoggerFactory.getLogger(CustomP6SpyListener.class);
    private ThreadLocal<Long> startTimeThreadLocal = new ThreadLocal<>();
    
    @Override
    public void onBeforeAnyExecute(StatementInformation statementInformation) {
        startTimeThreadLocal.set(System.currentTimeMillis());
    }
    
    @Override
    public void onAfterAnyExecute(StatementInformation statementInformation, long timeElapsedNanos, SQLException e) {
        Long startTime = startTimeThreadLocal.get();
        if (startTime != null) {
            long executionTime = System.currentTimeMillis() - startTime;
            startTimeThreadLocal.remove();
            
            if (executionTime > 1000) {  // å¤§äº1ç§’çš„æŸ¥è¯¢
                String sql = statementInformation.getSqlWithValues();
                logger.warn("Slow SQL detected: {} ms, SQL: {}", executionTime, sql);
            }
        }
    }
}
```

5. æ³¨å†Œè‡ªå®šä¹‰ç›‘å¬å™¨

```java title="P6Spyç›‘å¬å™¨æ³¨å†Œ"
@PostConstruct
public void initP6Spy() {
    P6SpyOptions.getActiveInstance().setJdbcEventListenerFactory(() -> new CustomP6SpyListener());
}
```

</TabItem>
</Tabs>

:::tip æ’ä»¶å¼€å‘æœ€ä½³å®è·µ
1. **ä¸“æ³¨å•ä¸€åŠŸèƒ½**ï¼šæ¯ä¸ªæ’ä»¶åªåšä¸€ä»¶äº‹ï¼Œä¾¿äºç»´æŠ¤å’Œç»„åˆ
2. **æ€§èƒ½è€ƒè™‘**ï¼šæ’ä»¶ä¼šå½±å“SQLæ‰§è¡Œæ€§èƒ½ï¼Œåº”å°½é‡å‡å°‘å¼€é”€
3. **å¼‚å¸¸å¤„ç†**ï¼šç¡®ä¿åœ¨å¼‚å¸¸æƒ…å†µä¸‹æ­£ç¡®ä¼ é€’å¼‚å¸¸ï¼Œä¸å¹²æ‰°æ­£å¸¸æµç¨‹
4. **çº¿ç¨‹å®‰å…¨**ï¼šå¤šçº¿ç¨‹ç¯å¢ƒä¸‹æ’ä»¶éœ€è¦æ³¨æ„çº¿ç¨‹å®‰å…¨
5. **æ’ä»¶é¡ºåº**ï¼šå¤šä¸ªæ’ä»¶åŒæ—¶ä½¿ç”¨æ—¶ï¼Œæ³¨æ„é…ç½®é¡ºåºï¼ˆå…ˆé…ç½®çš„åæ‰§è¡Œï¼‰
6. **å¯é…ç½®æ€§**ï¼šæä¾›è¶³å¤Ÿçš„é…ç½®é€‰é¡¹ï¼Œé€‚åº”ä¸åŒåœºæ™¯
7. **ä¼˜å…ˆä½¿ç”¨ç°æˆæ’ä»¶**ï¼šå¯¹äºå¸¸è§åŠŸèƒ½ï¼Œä¼˜å…ˆä½¿ç”¨æˆç†Ÿçš„ç¤¾åŒºæ’ä»¶
:::

## 8. MyBatiså®æˆ˜åº”ç”¨åœºæ™¯

MyBatisåœ¨å®é™…é¡¹ç›®ä¸­æœ‰ç€å¹¿æ³›çš„åº”ç”¨ï¼Œä»ç®€å•çš„CRUDæ“ä½œåˆ°å¤æ‚çš„å¤šè¡¨æŸ¥è¯¢ã€å­˜å‚¨è¿‡ç¨‹è°ƒç”¨ã€æ‰¹é‡å¤„ç†ç­‰åœºæ™¯éƒ½èƒ½å¾ˆå¥½åœ°æ”¯æŒã€‚æœ¬èŠ‚å°†å±•ç¤ºMyBatisåœ¨å„ç§å®æˆ˜åœºæ™¯ä¸­çš„åº”ç”¨ã€‚

### 8.1 å¤šè¡¨å¤æ‚æŸ¥è¯¢

åœ¨å®é™…ä¸šåŠ¡ä¸­ï¼Œç»å¸¸éœ€è¦è¿›è¡Œå¤šè¡¨å…³è”æŸ¥è¯¢ï¼ŒMyBatisæä¾›äº†å¤šç§æ–¹å¼å¤„ç†å¤æ‚æŸ¥è¯¢ã€‚

<Tabs>
<TabItem value="joins" label="å¤šè¡¨JOINæŸ¥è¯¢">

ä½¿ç”¨JOINè¿›è¡Œå¤šè¡¨å…³è”æŸ¥è¯¢ï¼š

```xml title="å¤šè¡¨JOINæŸ¥è¯¢"
<select id="getOrderDetails" resultMap="OrderDetailMap">
  SELECT 
    o.id AS order_id,
    o.order_no,
    o.create_time,
    o.status,
    o.total_amount,
    u.id AS user_id,
    u.username,
    u.email,
    p.id AS product_id,
    p.name AS product_name,
    p.price,
    oi.quantity,
    oi.subtotal
  FROM orders o
  LEFT JOIN user u ON o.user_id = u.id
  LEFT JOIN order_item oi ON o.id = oi.order_id
  LEFT JOIN product p ON oi.product_id = p.id
  WHERE o.id = #{orderId}
</select>

<resultMap id="OrderDetailMap" type="OrderDetail">
  <id property="orderId" column="order_id"/>
  <result property="orderNo" column="order_no"/>
  <result property="createTime" column="create_time"/>
  <result property="status" column="status"/>
  <result property="totalAmount" column="total_amount"/>
  
  <association property="user" javaType="User">
    <id property="id" column="user_id"/>
    <result property="username" column="username"/>
    <result property="email" column="email"/>
  </association>
  
  <collection property="items" ofType="OrderItemDetail">
    <id property="productId" column="product_id"/>
    <result property="productName" column="product_name"/>
    <result property="price" column="price"/>
    <result property="quantity" column="quantity"/>
    <result property="subtotal" column="subtotal"/>
  </collection>
</resultMap>
```

</TabItem>
<TabItem value="sub-queries" label="å­æŸ¥è¯¢">

ä½¿ç”¨å­æŸ¥è¯¢å¤„ç†å¤æ‚æŸ¥è¯¢éœ€æ±‚ï¼š

```xml title="å­æŸ¥è¯¢ç¤ºä¾‹"
<select id="getHighValueCustomers" resultType="User">
  SELECT u.* FROM user u
  WHERE u.id IN (
    SELECT DISTINCT o.user_id
    FROM orders o
    WHERE o.total_amount > #{minAmount}
    AND o.create_time BETWEEN #{startDate} AND #{endDate}
    GROUP BY o.user_id
    HAVING SUM(o.total_amount) > #{totalSpending}
  )
  ORDER BY u.created_time DESC
</select>
```

</TabItem>
<TabItem value="nested" label="åµŒå¥—æŸ¥è¯¢">

ä½¿ç”¨åµŒå¥—æŸ¥è¯¢åˆ†æ­¥è·å–å…³è”æ•°æ®ï¼š

```xml title="åµŒå¥—æŸ¥è¯¢ç¤ºä¾‹"
<!-- è·å–è®¢å•ä¸»ä¿¡æ¯ -->
<select id="getOrderById" resultMap="OrderMap">
  SELECT id, order_no, user_id, status, total_amount, create_time
  FROM orders
  WHERE id = #{id}
</select>

<resultMap id="OrderMap" type="Order">
  <id property="id" column="id"/>
  <result property="orderNo" column="order_no"/>
  <result property="status" column="status"/>
  <result property="totalAmount" column="total_amount"/>
  <result property="createTime" column="create_time"/>
  
  <!-- å…³è”ç”¨æˆ·ä¿¡æ¯ -->
  <association property="user" column="user_id"
               select="getUserById" fetchType="eager"/>
  
  <!-- å…³è”è®¢å•é¡¹ -->
  <collection property="items" column="id"
              select="getOrderItemsByOrderId" fetchType="lazy"/>
</resultMap>

<!-- è·å–ç”¨æˆ·ä¿¡æ¯ -->
<select id="getUserById" resultType="User">
  SELECT id, username, email, phone
  FROM user
  WHERE id = #{userId}
</select>

<!-- è·å–è®¢å•é¡¹ -->
<select id="getOrderItemsByOrderId" resultMap="OrderItemMap">
  SELECT 
    oi.id, oi.order_id, oi.product_id, 
    oi.quantity, oi.price, oi.subtotal,
    p.name as product_name, p.image as product_image
  FROM order_item oi
  LEFT JOIN product p ON oi.product_id = p.id
  WHERE oi.order_id = #{orderId}
</select>

<resultMap id="OrderItemMap" type="OrderItem">
  <id property="id" column="id"/>
  <result property="orderId" column="order_id"/>
  <result property="productId" column="product_id"/>
  <result property="quantity" column="quantity"/>
  <result property="price" column="price"/>
  <result property="subtotal" column="subtotal"/>
  
  <association property="product" javaType="Product">
    <id property="id" column="product_id"/>
    <result property="name" column="product_name"/>
    <result property="image" column="product_image"/>
  </association>
</resultMap>
```

</TabItem>
<TabItem value="complex" label="å¤æ‚æ¡ä»¶æŸ¥è¯¢">

å®ç°åŒ…å«å¤šæ¡ä»¶ã€åˆ†ç»„ã€æ’åºã€èšåˆç­‰å¤æ‚æŸ¥è¯¢ï¼š

```xml title="å¤æ‚æ¡ä»¶æŸ¥è¯¢"
<select id="searchProducts" resultType="ProductVO">
  SELECT 
    p.id, 
    p.name, 
    p.price,
    p.stock,
    c.name as category_name,
    b.name as brand_name,
    ROUND(AVG(r.rating), 1) as avg_rating,
    COUNT(r.id) as review_count
  FROM product p
  LEFT JOIN category c ON p.category_id = c.id
  LEFT JOIN brand b ON p.brand_id = b.id
  LEFT JOIN review r ON p.id = r.product_id
  <where>
    <if test="keyword != null and keyword != ''">
      AND (
        p.name LIKE CONCAT('%', #{keyword}, '%')
        OR p.description LIKE CONCAT('%', #{keyword}, '%')
      )
    </if>
    <if test="categoryIds != null and categoryIds.size() > 0">
      AND p.category_id IN
      <foreach collection="categoryIds" item="catId" open="(" separator="," close=")">
        #{catId}
      </foreach>
    </if>
    <if test="brandIds != null and brandIds.size() > 0">
      AND p.brand_id IN
      <foreach collection="brandIds" item="brandId" open="(" separator="," close=")">
        #{brandId}
      </foreach>
    </if>
    <if test="minPrice != null">
      AND p.price >= #{minPrice}
    </if>
    <if test="maxPrice != null">
      AND p.price <= #{maxPrice}
    </if>
    <if test="inStock != null and inStock == true">
      AND p.stock > 0
    </if>
    <if test="minRating != null">
      HAVING AVG(r.rating) >= #{minRating}
    </if>
  </where>
  GROUP BY p.id, p.name, p.price, p.stock, c.name, b.name
  <choose>
    <when test="sortBy == 'price' and sortDir == 'asc'">
      ORDER BY p.price ASC
    </when>
    <when test="sortBy == 'price' and sortDir == 'desc'">
      ORDER BY p.price DESC
    </when>
    <when test="sortBy == 'rating'">
      ORDER BY avg_rating DESC, review_count DESC
    </when>
    <when test="sortBy == 'newest'">
      ORDER BY p.create_time DESC
    </when>
    <otherwise>
      ORDER BY 
      CASE WHEN p.is_featured = 1 THEN 0 ELSE 1 END,
      p.sort_order
    </otherwise>
  </choose>
  LIMIT #{offset}, #{limit}
</select>
```

</TabItem>
</Tabs>

### 8.2 å­˜å‚¨è¿‡ç¨‹è°ƒç”¨

MyBatisæ”¯æŒè°ƒç”¨æ•°æ®åº“å­˜å‚¨è¿‡ç¨‹ï¼Œä¸ºç‰¹å®šåœºæ™¯æä¾›é«˜æ•ˆçš„å¤„ç†èƒ½åŠ›ã€‚

<Tabs>
<TabItem value="basic" label="åŸºæœ¬è°ƒç”¨">

è°ƒç”¨ä¸å¸¦å‚æ•°çš„ç®€å•å­˜å‚¨è¿‡ç¨‹ï¼š

```xml title="ç®€å•å­˜å‚¨è¿‡ç¨‹è°ƒç”¨"
<select id="callGetSystemDate" statementType="CALLABLE" resultType="Date">
  {call get_system_date()}
</select>
```

è°ƒç”¨å¸¦è¾“å…¥å‚æ•°çš„å­˜å‚¨è¿‡ç¨‹ï¼š

```xml title="å¸¦è¾“å…¥å‚æ•°çš„å­˜å‚¨è¿‡ç¨‹"
<select id="getUserOrders" parameterType="int" statementType="CALLABLE" resultMap="OrderMap">
  {call get_user_orders(#{userId,jdbcType=INTEGER})}
</select>
```

</TabItem>
<TabItem value="in-out" label="è¾“å…¥è¾“å‡ºå‚æ•°">

è°ƒç”¨å¸¦è¾“å…¥è¾“å‡ºå‚æ•°çš„å­˜å‚¨è¿‡ç¨‹ï¼š

```xml title="å¸¦è¾“å…¥è¾“å‡ºå‚æ•°çš„å­˜å‚¨è¿‡ç¨‹"
<parameterMap id="processOrderParam" type="map">
  <parameter property="orderId" mode="IN" jdbcType="INTEGER"/>
  <parameter property="status" mode="IN" jdbcType="VARCHAR"/>
  <parameter property="result" mode="OUT" jdbcType="INTEGER"/>
  <parameter property="message" mode="OUT" jdbcType="VARCHAR"/>
</parameterMap>

<update id="processOrder" parameterMap="processOrderParam" statementType="CALLABLE">
  {call process_order(?, ?, ?, ?)}
</update>
```

Javaä»£ç è°ƒç”¨å¸¦è¾“å‡ºå‚æ•°çš„å­˜å‚¨è¿‡ç¨‹ï¼š

```java title="è°ƒç”¨å¸¦è¾“å‡ºå‚æ•°çš„å­˜å‚¨è¿‡ç¨‹"
public String processOrder(Long orderId, String status) {
    Map<String, Object> params = new HashMap<>();
    params.put("orderId", orderId);
    params.put("status", status);
    params.put("result", null);  // è¾“å‡ºå‚æ•°
    params.put("message", null); // è¾“å‡ºå‚æ•°
    
    orderMapper.processOrder(params);
    
    Integer result = (Integer) params.get("result");
    String message = (String) params.get("message");
    
    if (result == 1) {
        return "å¤„ç†æˆåŠŸ: " + message;
    } else {
        return "å¤„ç†å¤±è´¥: " + message;
    }
}
```

</TabItem>
<TabItem value="cursor" label="æ¸¸æ ‡ç»“æœ">

å¤„ç†è¿”å›æ¸¸æ ‡çš„å­˜å‚¨è¿‡ç¨‹ï¼š

```xml title="è¿”å›æ¸¸æ ‡çš„å­˜å‚¨è¿‡ç¨‹"
<resultMap id="ProductMap" type="Product">
  <id property="id" column="id"/>
  <result property="name" column="name"/>
  <result property="price" column="price"/>
  <result property="stock" column="stock"/>
</resultMap>

<parameterMap id="categoryProductsParam" type="map">
  <parameter property="categoryId" mode="IN" jdbcType="INTEGER"/>
  <parameter property="productCursor" mode="OUT" jdbcType="CURSOR" resultMap="ProductMap"/>
</parameterMap>

<select id="getCategoryProducts" parameterMap="categoryProductsParam" statementType="CALLABLE">
  {call get_category_products(?, ?)}
</select>
```

Javaä»£ç å¤„ç†æ¸¸æ ‡ç»“æœï¼š

```java title="å¤„ç†æ¸¸æ ‡ç»“æœ"
public List<Product> getCategoryProducts(Integer categoryId) {
    Map<String, Object> params = new HashMap<>();
    params.put("categoryId", categoryId);
    params.put("productCursor", null); // è¾“å‡ºå‚æ•°-æ¸¸æ ‡
    
    orderMapper.getCategoryProducts(params);
    
    // å¤„ç†æ¸¸æ ‡ç»“æœ
    List<Product> products = new ArrayList<>();
    try (Cursor<Product> cursor = (Cursor<Product>) params.get("productCursor")) {
        cursor.forEach(products::add);
    }
    
    return products;
}
```

</TabItem>
<TabItem value="batch" label="æ‰¹å¤„ç†å­˜å‚¨è¿‡ç¨‹">

ä½¿ç”¨æ‰¹å¤„ç†æ–¹å¼è°ƒç”¨å­˜å‚¨è¿‡ç¨‹å¤„ç†å¤§é‡æ•°æ®ï¼š

```java title="æ‰¹å¤„ç†å­˜å‚¨è¿‡ç¨‹"
@Transactional
public void batchProcessOrders(List<Order> orders) {
    try (SqlSession sqlSession = sqlSessionFactory.openSession(ExecutorType.BATCH)) {
        OrderMapper mapper = sqlSession.getMapper(OrderMapper.class);
        
        for (Order order : orders) {
            Map<String, Object> params = new HashMap<>();
            params.put("orderId", order.getId());
            params.put("status", order.getStatus());
            params.put("result", null);
            params.put("message", null);
            
            mapper.processOrder(params);
        }
        
        // æäº¤æ‰¹å¤„ç†
        sqlSession.flushStatements();
        sqlSession.commit();
    }
}
```

</TabItem>
</Tabs>

### 8.3 æ‰¹é‡æ•°æ®å¤„ç†

åœ¨å¤„ç†å¤§é‡æ•°æ®æ—¶ï¼Œæ‰¹é‡æ“ä½œå¯ä»¥æ˜¾è‘—æé«˜æ€§èƒ½ï¼Œå‡å°‘æ•°æ®åº“äº¤äº’æ¬¡æ•°ã€‚

<Tabs>
<TabItem value="batch-insert" label="æ‰¹é‡æ’å…¥">

ä½¿ç”¨`foreach`å®ç°æ‰¹é‡æ’å…¥ï¼š

```xml title="æ‰¹é‡æ’å…¥"
<insert id="batchInsertUsers" parameterType="list">
  INSERT INTO user (username, email, password, status, create_time)
  VALUES
  <foreach collection="list" item="user" separator=",">
    (
      #{user.username},
      #{user.email},
      #{user.password},
      #{user.status},
      #{user.createTime}
    )
  </foreach>
</insert>
```

</TabItem>
<TabItem value="batch-update" label="æ‰¹é‡æ›´æ–°">

æ‰¹é‡æ›´æ–°æœ‰ä¸¤ç§å¸¸è§æ–¹å¼ï¼š

1. ä½¿ç”¨`case when`è¯­æ³•ï¼š

```xml title="æ‰¹é‡æ›´æ–°-CASE WHENæ–¹å¼"
<update id="batchUpdateUserStatus" parameterType="map">
  UPDATE user
  SET status = 
  <foreach collection="userStatusList" item="item" open="CASE id" close="END">
    WHEN #{item.userId} THEN #{item.status}
  </foreach>
  WHERE id IN
  <foreach collection="userStatusList" item="item" open="(" separator="," close=")">
    #{item.userId}
  </foreach>
</update>
```

2. ä½¿ç”¨å¤šè¯­å¥æ‰§è¡Œï¼š

```xml title="æ‰¹é‡æ›´æ–°-å¤šè¯­å¥æ–¹å¼"
<update id="batchUpdateUsers" parameterType="list">
  <foreach collection="list" item="user" separator=";">
    UPDATE user
    <set>
      <if test="user.username != null">username = #{user.username},</if>
      <if test="user.email != null">email = #{user.email},</if>
      <if test="user.status != null">status = #{user.status},</if>
      update_time = #{user.updateTime}
    </set>
    WHERE id = #{user.id}
  </foreach>
</update>
```

æ³¨æ„ï¼šå¤šè¯­å¥æ‰§è¡Œéœ€è¦åœ¨JDBCè¿æ¥URLä¸­å¯ç”¨ï¼š
```
jdbc:mysql://localhost:3306/mydb?allowMultiQueries=true
```

</TabItem>
<TabItem value="batch-executor" label="æ‰¹å¤„ç†æ‰§è¡Œå™¨">

ä½¿ç”¨MyBatisçš„æ‰¹å¤„ç†æ‰§è¡Œå™¨ï¼š

```java title="æ‰¹å¤„ç†æ‰§è¡Œå™¨"
@Service
public class UserService {
    
    @Autowired
    private SqlSessionFactory sqlSessionFactory;
    
    @Transactional
    public void batchUpdateUsers(List<User> users) {
        try (SqlSession sqlSession = sqlSessionFactory.openSession(ExecutorType.BATCH)) {
            UserMapper mapper = sqlSession.getMapper(UserMapper.class);
            
            for (int i = 0; i < users.size(); i++) {
                mapper.updateUser(users.get(i));
                
                // æ¯500æ¡æäº¤ä¸€æ¬¡ï¼Œé¿å…æ‰¹é‡è¿‡å¤§
                if (i > 0 && i % 500 == 0) {
                    sqlSession.flushStatements();
                }
            }
            
            // æœ€åæäº¤å‰©ä½™çš„
            sqlSession.flushStatements();
        }
    }
}
```

</TabItem>
<TabItem value="optimize" label="æ‰¹é‡å¤„ç†ä¼˜åŒ–">

æ‰¹é‡å¤„ç†çš„å‡ ç§ä¼˜åŒ–ç­–ç•¥ï¼š

1. åˆ†æ‰¹å¤„ç†å¤§é‡æ•°æ®ï¼š

```java title="åˆ†æ‰¹å¤„ç†"
public void processMassiveData(List<User> allUsers) {
    int batchSize = 1000;
    int totalUsers = allUsers.size();
    
    for (int i = 0; i < totalUsers; i += batchSize) {
        int endIndex = Math.min(i + batchSize, totalUsers);
        List<User> userBatch = allUsers.subList(i, endIndex);
        
        // å¤„ç†å½“å‰æ‰¹æ¬¡
        batchUpdateUsers(userBatch);
        
        // æ¸…ç†èµ„æºï¼Œé¿å…å†…å­˜æº¢å‡º
        System.gc();
    }
}
```

2. ä½¿ç”¨å¤šçº¿ç¨‹å¹¶è¡Œå¤„ç†ï¼š

```java title="å¤šçº¿ç¨‹æ‰¹é‡å¤„ç†"
public void parallelProcessData(List<User> allUsers) {
    int batchSize = 1000;
    int totalUsers = allUsers.size();
    int processors = Runtime.getRuntime().availableProcessors();
    
    // åˆ›å»ºçº¿ç¨‹æ± 
    ExecutorService executorService = Executors.newFixedThreadPool(processors);
    CountDownLatch latch = new CountDownLatch(totalUsers / batchSize + (totalUsers % batchSize > 0 ? 1 : 0));
    
    for (int i = 0; i < totalUsers; i += batchSize) {
        int startIndex = i;
        int endIndex = Math.min(i + batchSize, totalUsers);
        
        executorService.submit(() -> {
            try {
                List<User> userBatch = allUsers.subList(startIndex, endIndex);
                batchUpdateUsers(userBatch);
            } finally {
                latch.countDown();
            }
        });
    }
    
    try {
        latch.await(); // ç­‰å¾…æ‰€æœ‰æ‰¹æ¬¡å¤„ç†å®Œæˆ
    } catch (InterruptedException e) {
        Thread.currentThread().interrupt();
    } finally {
        executorService.shutdown();
    }
}
```

</TabItem>
</Tabs>

### 8.4 åŠ¨æ€æƒé™SQL

åœ¨ä¼ä¸šåº”ç”¨ä¸­ï¼Œæ•°æ®æƒé™æ§åˆ¶æ˜¯ä¸€ä¸ªå¸¸è§éœ€æ±‚ï¼ŒMyBatisçš„åŠ¨æ€SQLç‰¹æ€§å¯ä»¥å¾ˆå¥½åœ°å®ç°åŸºäºç”¨æˆ·è§’è‰²å’Œæƒé™çš„åŠ¨æ€æŸ¥è¯¢ã€‚

<Tabs>
<TabItem value="dept-permission" label="éƒ¨é—¨æ•°æ®æƒé™">

å®ç°åŸºäºç”¨æˆ·éƒ¨é—¨çš„æ•°æ®æƒé™æ§åˆ¶ï¼š

```xml title="éƒ¨é—¨æ•°æ®æƒé™SQL"
<select id="getUserList" resultType="User">
  SELECT u.* FROM sys_user u
  LEFT JOIN sys_dept d ON u.dept_id = d.id
  <where>
    <!-- æ ¹æ®ç”¨æˆ·æƒé™ç±»å‹åŠ¨æ€ç”ŸæˆSQL -->
    <choose>
      <!-- å…¨éƒ¨æ•°æ®æƒé™ -->
      <when test="user.dataScope == 'ALL'">
      </when>
      
      <!-- æœ¬éƒ¨é—¨åŠä»¥ä¸‹æ•°æ®æƒé™ -->
      <when test="user.dataScope == 'DEPT_AND_CHILD'">
        AND (d.id = #{user.deptId} OR d.parent_ids LIKE CONCAT('%,', #{user.deptId}, ',%'))
      </when>
      
      <!-- æœ¬éƒ¨é—¨æ•°æ®æƒé™ -->
      <when test="user.dataScope == 'DEPT'">
        AND d.id = #{user.deptId}
      </when>
      
      <!-- ä»…ä¸ªäººæ•°æ®æƒé™ -->
      <when test="user.dataScope == 'SELF'">
        AND u.create_by = #{user.userId}
      </when>
      
      <!-- è‡ªå®šä¹‰æ•°æ®æƒé™ -->
      <when test="user.dataScope == 'CUSTOM' and user.deptIds != null and user.deptIds.size() > 0">
        AND d.id IN
        <foreach collection="user.deptIds" item="deptId" open="(" separator="," close=")">
          #{deptId}
        </foreach>
      </when>
      
      <!-- é»˜è®¤æ— æƒé™ -->
      <otherwise>
        AND 1=2
      </otherwise>
    </choose>
    
    <!-- å…¶ä»–æŸ¥è¯¢æ¡ä»¶ -->
    <if test="username != null and username != ''">
      AND u.username LIKE CONCAT('%', #{username}, '%')
    </if>
    <if test="status != null">
      AND u.status = #{status}
    </if>
  </where>
  ORDER BY u.create_time DESC
</select>
```

</TabItem>
<TabItem value="interceptor" label="æƒé™æ‹¦æˆªå™¨">

ä½¿ç”¨MyBatisæ’ä»¶å®ç°è‡ªåŠ¨åŒ–çš„æƒé™æ§åˆ¶ï¼š

```java title="æƒé™æ‹¦æˆªå™¨"
@Intercepts({
    @Signature(
        type = StatementHandler.class,
        method = "prepare",
        args = {Connection.class, Integer.class}
    )
})
public class DataPermissionInterceptor implements Interceptor {
    
    @Override
    public Object intercept(Invocation invocation) throws Throwable {
        StatementHandler handler = (StatementHandler) invocation.getTarget();
        MetaObject metaObject = SystemMetaObject.forObject(handler);
        
        // è·å–SQLä¿¡æ¯
        MappedStatement mappedStatement = (MappedStatement) metaObject.getValue("delegate.mappedStatement");
        String id = mappedStatement.getId();
        
        // åˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡Œæ•°æ®æƒé™æ§åˆ¶
        if (!isDataPermissionEnabled(id)) {
            return invocation.proceed();
        }
        
        // è·å–å½“å‰ç”¨æˆ·æƒé™ä¿¡æ¯
        LoginUser loginUser = getLoginUser();
        if (loginUser == null) {
            return invocation.proceed();
        }
        
        // è·å–åŸå§‹SQL
        BoundSql boundSql = handler.getBoundSql();
        String originalSql = boundSql.getSql();
        
        // æ„å»ºæ•°æ®æƒé™SQL
        String permissionSql = buildPermissionSql(originalSql, loginUser);
        
        // æ›¿æ¢åŸå§‹SQL
        metaObject.setValue("delegate.boundSql.sql", permissionSql);
        
        return invocation.proceed();
    }
    
    /**
     * æ„å»ºæ•°æ®æƒé™SQL
     */
    private String buildPermissionSql(String originalSql, LoginUser loginUser) {
        // è§£æSQLï¼Œæ‰¾åˆ°é€‚åˆæ³¨å…¥æƒé™æ¡ä»¶çš„ä½ç½®
        
        // æ ¹æ®ç”¨æˆ·æƒé™ç±»å‹æ„å»ºä¸åŒçš„æƒé™æ¡ä»¶
        StringBuilder permissionBuilder = new StringBuilder();
        
        if ("ALL".equals(loginUser.getDataScope())) {
            // å…¨éƒ¨æ•°æ®æƒé™ï¼Œä¸åšå¤„ç†
            return originalSql;
        } else if ("DEPT_AND_CHILD".equals(loginUser.getDataScope())) {
            // æœ¬éƒ¨é—¨åŠä»¥ä¸‹æ•°æ®æƒé™
            permissionBuilder.append(" AND (d.id = '")
                            .append(loginUser.getDeptId())
                            .append("' OR d.parent_ids LIKE '%,")
                            .append(loginUser.getDeptId())
                            .append(",%')");
        } else if ("DEPT".equals(loginUser.getDataScope())) {
            // æœ¬éƒ¨é—¨æ•°æ®æƒé™
            permissionBuilder.append(" AND d.id = '")
                            .append(loginUser.getDeptId())
                            .append("'");
        } else if ("SELF".equals(loginUser.getDataScope())) {
            // ä»…ä¸ªäººæ•°æ®æƒé™
            permissionBuilder.append(" AND u.create_by = '")
                            .append(loginUser.getUserId())
                            .append("'");
        } else if ("CUSTOM".equals(loginUser.getDataScope()) && 
                   loginUser.getDeptIds() != null && !loginUser.getDeptIds().isEmpty()) {
            // è‡ªå®šä¹‰æ•°æ®æƒé™
            permissionBuilder.append(" AND d.id IN (");
            for (int i = 0; i < loginUser.getDeptIds().size(); i++) {
                if (i > 0) {
                    permissionBuilder.append(",");
                }
                permissionBuilder.append("'").append(loginUser.getDeptIds().get(i)).append("'");
            }
            permissionBuilder.append(")");
        } else {
            // é»˜è®¤æ— æƒé™
            permissionBuilder.append(" AND 1=2");
        }
        
        // æ³¨å…¥æƒé™æ¡ä»¶åˆ°SQL
        int whereIndex = originalSql.toUpperCase().indexOf(" WHERE ");
        if (whereIndex > 0) {
            // SQLä¸­å·²æœ‰WHEREå­å¥
            return originalSql.substring(0, whereIndex + 7) + 
                   "(" + originalSql.substring(whereIndex + 7) + ")" + 
                   permissionBuilder.toString();
        } else {
            // SQLä¸­æ²¡æœ‰WHEREå­å¥
            int orderByIndex = originalSql.toUpperCase().indexOf(" ORDER BY ");
            if (orderByIndex > 0) {
                return originalSql.substring(0, orderByIndex) + 
                       " WHERE " + permissionBuilder.toString().substring(5) + 
                       originalSql.substring(orderByIndex);
            } else {
                return originalSql + " WHERE " + permissionBuilder.toString().substring(5);
            }
        }
    }
    
    /**
     * åˆ¤æ–­æ˜¯å¦å¯ç”¨æ•°æ®æƒé™
     */
    private boolean isDataPermissionEnabled(String statementId) {
        // å¯ä»¥é€šè¿‡æ³¨è§£æˆ–é…ç½®åˆ¤æ–­æ˜¯å¦éœ€è¦æ•°æ®æƒé™æ§åˆ¶
        return statementId.contains("getUserList") || 
               statementId.contains("getEmployeeList") ||
               statementId.contains("getOrderList");
    }
    
    /**
     * è·å–å½“å‰ç™»å½•ç”¨æˆ·
     */
    private LoginUser getLoginUser() {
        // ä»Spring Securityæˆ–ThreadLocalä¸­è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
        return SecurityUtils.getLoginUser();
    }
    
    @Override
    public Object plugin(Object target) {
        return Plugin.wrap(target, this);
    }
    
    @Override
    public void setProperties(Properties properties) {
    }
}
```

</TabItem>
<TabItem value="role-based" label="è§’è‰²æƒé™æ§åˆ¶">

åŸºäºç”¨æˆ·è§’è‰²çš„åŠ¨æ€SQLæƒé™æ§åˆ¶ï¼š

```xml title="åŸºäºè§’è‰²çš„åŠ¨æ€SQL"
<select id="getMenuList" resultType="Menu">
  SELECT
    m.id, m.parent_id, m.name, m.path, m.component, m.visible, m.status
  FROM
    sys_menu m
  LEFT JOIN
    sys_role_menu rm ON m.id = rm.menu_id
  <where>
    <!-- ç®¡ç†å‘˜æ˜¾ç¤ºæ‰€æœ‰èœå• -->
    <if test="user.roles.contains('ROLE_ADMIN')">
      AND m.status = 0
    </if>
    <!-- éç®¡ç†å‘˜åªæ˜¾ç¤ºæœ‰æƒé™çš„èœå• -->
    <if test="!user.roles.contains('ROLE_ADMIN')">
      AND rm.role_id IN
      <foreach collection="user.roleIds" item="roleId" open="(" separator="," close=")">
        #{roleId}
      </foreach>
      AND m.status = 0
    </if>
  </where>
  ORDER BY m.parent_id, m.order_num
</select>
```

</TabItem>
<TabItem value="field-permission" label="å­—æ®µçº§æƒé™">

å®ç°å­—æ®µçº§çš„æƒé™æ§åˆ¶ï¼š

```xml title="å­—æ®µçº§æƒé™æ§åˆ¶"
<select id="getUserInfo" resultType="map">
  SELECT 
    u.id,
    u.username,
    u.email,
    <!-- æ ¹æ®æƒé™æ§åˆ¶æ•æ„Ÿå­—æ®µæ˜¾ç¤º -->
    <if test="hasPermission('user:view:phone')">
      u.phone,
    </if>
    <if test="hasPermission('user:view:idcard')">
      u.id_card,
    </if>
    <if test="hasPermission('user:view:salary')">
      u.salary,
    </if>
    u.status,
    u.create_time
  FROM
    sys_user u
  WHERE
    u.id = #{userId}
</select>
```

è‡ªå®šä¹‰æƒé™åˆ¤æ–­æ–¹æ³•ï¼š

```java title="è‡ªå®šä¹‰æƒé™åˆ¤æ–­æ–¹æ³•"
@Component
public class SecurityFunction {
    
    @Autowired
    private PermissionService permissionService;
    
    /**
     * åˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰æŒ‡å®šæƒé™
     */
    public boolean hasPermission(String permission) {
        return permissionService.hasPermission(permission);
    }
}

// æ³¨å†Œè‡ªå®šä¹‰æ–¹æ³•åˆ°MyBatisé…ç½®
@Configuration
public class MyBatisConfig {
    
    @Autowired
    private SecurityFunction securityFunction;
    
    @PostConstruct
    public void init() {
        // å°†æƒé™åˆ¤æ–­æ–¹æ³•æ³¨å†Œä¸ºMyBatisçš„æ–¹æ³•å¼•ç”¨
        Configuration configuration = sqlSessionFactory.getConfiguration();
        configuration.getTypeHandlerRegistry()
            .setDefaultEnumTypeHandler(EnumOrdinalTypeHandler.class);
        
        // æ³¨å†Œè‡ªå®šä¹‰æ–¹æ³•
        configuration.getLanguageRegistry()
            .getDefaultDriverConfig()
            .getLanguageDriver()
            .createParameterHandler(null, null, null)
            .setParameter(null, "hasPermission", 
                (key, val) -> securityFunction.hasPermission(String.valueOf(val)));
    }
}
```

</TabItem>
</Tabs>

## 9. æ€»ç»“ä¸æœ€ä½³å®è·µ

ç»è¿‡å‰é¢ç« èŠ‚çš„å­¦ä¹ ï¼Œæˆ‘ä»¬å·²ç»å…¨é¢äº†è§£äº†MyBatisçš„å„ä¸ªæ–¹é¢ã€‚åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œä¸ºäº†æ›´å¥½åœ°ä½¿ç”¨MyBatisï¼Œéœ€è¦éµå¾ªä¸€äº›æœ€ä½³å®è·µå’Œè§„èŒƒï¼Œä»¥ç¡®ä¿ä»£ç è´¨é‡å’Œç³»ç»Ÿæ€§èƒ½ã€‚

### 9.1 MyBatisä½¿ç”¨è§„èŒƒ

åˆ¶å®šåˆç†çš„MyBatisä½¿ç”¨è§„èŒƒå¯ä»¥æé«˜ä»£ç è´¨é‡ã€å¯ç»´æŠ¤æ€§å’Œæ€§èƒ½ã€‚

<Tabs>
<TabItem value="naming" label="å‘½åè§„èŒƒ">

è‰¯å¥½çš„å‘½åè§„èŒƒæœ‰åŠ©äºæé«˜ä»£ç å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ï¼š

1. **å‘½åç©ºé—´(namespace)**ï¼šä½¿ç”¨å®Œæ•´çš„åŒ…å+ç±»åï¼Œä¿æŒä¸Mapperæ¥å£ä¸€è‡´
   ```xml
   <mapper namespace="com.example.mapper.UserMapper">
   ```

2. **SQLè¯­å¥ID**ï¼šä½¿ç”¨æœ‰æ„ä¹‰çš„åç§°ï¼ŒåŠ¨è¯+åè¯å½¢å¼ï¼Œä¸Mapperæ¥å£æ–¹æ³•åä¸€è‡´
   ```xml
   <select id="getUserById">...</select>
   <insert id="insertUser">...</insert>
   <update id="updateUserStatus">...</update>
   <delete id="deleteUserBatch">...</delete>
   ```

3. **å‚æ•°åç§°**ï¼šä½¿ç”¨æœ‰æ„ä¹‰çš„å‚æ•°åï¼Œä¸ä¸šåŠ¡å®ä½“å±æ€§åä¿æŒä¸€è‡´
   ```xml
   #{userId}, #{userName}, #{startTime}, #{endTime}
   ```

4. **ç»“æœæ˜ å°„ID**ï¼šä½¿ç”¨Entityå+Result/Mapåç¼€
   ```xml
   <resultMap id="UserResultMap" type="User">...</resultMap>
   <resultMap id="OrderDetailMap" type="OrderDetail">...</resultMap>
   ```

5. **SQLç‰‡æ®µID**ï¼šä½¿ç”¨åŠŸèƒ½æè¿°+Fragment/Column/Whereåç¼€
   ```xml
   <sql id="BaseColumnList">...</sql>
   <sql id="CommonWhereFragment">...</sql>
   ```

</TabItem>
<TabItem value="code-structure" label="ä»£ç ç»„ç»‡">

è‰¯å¥½çš„ä»£ç ç»„ç»‡ç»“æ„æœ‰åŠ©äºé¡¹ç›®ç®¡ç†å’Œå›¢é˜Ÿåä½œï¼š

1. **æ¥å£ä¸å®ç°åˆ†ç¦»**
   - Mapperæ¥å£ï¼š`src/main/java/com/example/mapper/`
   - XMLæ˜ å°„æ–‡ä»¶ï¼š`src/main/resources/mapper/`

2. **æ¨¡å—åŒ–ç»„ç»‡**
   - æŒ‰ä¸šåŠ¡æ¨¡å—ç»„ç»‡Mapperæ–‡ä»¶
   - å¤§å‹é¡¹ç›®å¯ä»¥æŒ‰å­æ¨¡å—è¿›ä¸€æ­¥æ‹†åˆ†

3. **å…¬å…±SQLæå–**
   - æå–å…¬å…±åˆ—ååˆ—è¡¨ï¼š
     ```xml
     <sql id="Base_Column_List">id, name, email, phone, status, create_time, update_time</sql>
     ```
   
   - æå–å…¬å…±WHEREæ¡ä»¶ï¼š
     ```xml
     <sql id="Common_Where_Clause">
       <where>
         <if test="status != null">AND status = #{status}</if>
         <if test="startDate != null">AND create_time >= #{startDate}</if>
       </where>
     </sql>
     ```

   - åœ¨SQLè¯­å¥ä¸­å¼•ç”¨ï¼š
     ```xml
     <select id="selectUsers" resultMap="UserResultMap">
       SELECT <include refid="Base_Column_List" />
       FROM user
       <include refid="Common_Where_Clause" />
     </select>
     ```

4. **åˆç†æ‹†åˆ†æ–‡ä»¶**
   - å•è¡¨æ“ä½œä¸€ä¸ªMapperæ–‡ä»¶
   - å¤æ‚æŸ¥è¯¢å¯ä»¥å•ç‹¬åˆ›å»ºMapperæ–‡ä»¶
   - é¿å…è¿‡å¤§çš„XMLæ–‡ä»¶ï¼Œå»ºè®®ä¸è¶…è¿‡1000è¡Œ

</TabItem>
<TabItem value="sql-practices" label="SQLç¼–å†™è§„èŒƒ">

ä¼˜è´¨çš„SQLç¼–å†™è§„èŒƒå¯ä»¥æé«˜å¯è¯»æ€§å’Œæ€§èƒ½ï¼š

1. **SQLæ ¼å¼åŒ–**
   - å…³é”®å­—å¤§å†™ï¼ˆSELECT, FROM, WHERE, ANDç­‰ï¼‰
   - åˆç†ä½¿ç”¨ç¼©è¿›å’Œæ¢è¡Œ
   - å­å¥åˆ†è¡Œç¼–å†™ï¼Œå¢å¼ºå¯è¯»æ€§

   ```xml
   <select id="getOrderSummary" resultType="OrderSummary">
     SELECT
       o.id,
       o.order_no,
       o.create_time,
       SUM(oi.price * oi.quantity) AS total_amount,
       COUNT(oi.id) AS item_count
     FROM
       orders o
     LEFT JOIN
       order_item oi ON o.id = oi.order_id
     WHERE
       o.status = #{status}
       AND o.create_time BETWEEN #{startDate} AND #{endDate}
     GROUP BY
       o.id, o.order_no, o.create_time
     ORDER BY
       o.create_time DESC
   </select>
   ```

2. **SQLä¼˜åŒ–åŸåˆ™**
   - åªæŸ¥è¯¢å¿…è¦çš„åˆ—ï¼Œé¿å…`SELECT *`
   - åˆç†ä½¿ç”¨ç´¢å¼•
   - é¿å…åœ¨WHEREå­å¥ä¸­å¯¹å­—æ®µè¿›è¡Œå‡½æ•°æ“ä½œ
   - åˆç†ä½¿ç”¨JOINï¼Œé¿å…è¿‡å¤šè¡¨å…³è”
   - é€‚å½“æ·»åŠ SQLæ³¨é‡Šï¼Œè¯´æ˜å¤æ‚æŸ¥è¯¢çš„ç›®çš„

3. **åŠ¨æ€SQLç¼–å†™**
   - ä¼˜å…ˆä½¿ç”¨`<where>`è€Œé`WHERE 1=1`
   - åˆç†ä½¿ç”¨`<choose>`, `<when>`, `<otherwise>`å¤„ç†äº’æ–¥æ¡ä»¶
   - ä½¿ç”¨`<set>`æ›¿ä»£æ‰‹åŠ¨æ‹¼æ¥SETå­å¥å’Œé€—å·
   - æ‰¹é‡æ“ä½œä½¿ç”¨`<foreach>`æ ‡ç­¾

</TabItem>
<TabItem value="security" label="å®‰å…¨è§„èŒƒ">

å®‰å…¨è§„èŒƒå¯ä»¥é˜²æ­¢SQLæ³¨å…¥å’Œæ•°æ®æ³„éœ²ï¼š

1. **é˜²æ­¢SQLæ³¨å…¥**
   - ä½¿ç”¨`#{}`å‚æ•°ç»‘å®šï¼Œé¿å…`${}`æ‹¼æ¥ï¼ˆé™¤éå¿…è¦ï¼‰
   - å¿…é¡»ä½¿ç”¨`${}`æ—¶ï¼ˆå¦‚è¡¨åã€åˆ—åï¼‰ï¼Œè¿›è¡Œä¸¥æ ¼æ ¡éªŒæˆ–ç™½åå•è¿‡æ»¤
   - æ•æ„Ÿæ“ä½œæ·»åŠ æƒé™éªŒè¯

   ```xml
   <!-- å®‰å…¨çš„å†™æ³• -->
   <select id="getUserByUsername" resultType="User">
     SELECT * FROM user WHERE username = #{username}
   </select>
   
   <!-- ä¸å®‰å…¨çš„å†™æ³•ï¼Œå¯èƒ½å¯¼è‡´SQLæ³¨å…¥ -->
   <select id="getUserByUsername" resultType="User">
     SELECT * FROM user WHERE username = '${username}'
   </select>
   ```

2. **æ•æ„Ÿæ•°æ®å¤„ç†**
   - æ•æ„Ÿä¿¡æ¯ï¼ˆå¯†ç ã€è¯ä»¶å·ç­‰ï¼‰ä¸ç›´æ¥è¿”å›
   - ä½¿ç”¨åŠ å¯†/è„±æ•å¤„ç†æ•æ„Ÿæ•°æ®
   - æ—¥å¿—ä¸­é¿å…æ‰“å°æ•æ„Ÿä¿¡æ¯

3. **æƒé™æ§åˆ¶**
   - å®ç°æ•°æ®è¡Œçº§æƒé™
   - å­—æ®µçº§åˆ«æƒé™æ§åˆ¶
   - æ“ä½œæƒé™éªŒè¯

</TabItem>
</Tabs>

### 9.2 å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ

åœ¨ä½¿ç”¨MyBatisè¿‡ç¨‹ä¸­ï¼Œç»å¸¸ä¼šé‡åˆ°ä¸€äº›å¸¸è§é—®é¢˜ï¼Œè¿™é‡Œæä¾›ä¸€äº›è§£å†³æ–¹æ¡ˆã€‚

<Tabs>
<TabItem value="n-plus-1" label="#1 é—®é¢˜">

N+1æŸ¥è¯¢é—®é¢˜æ˜¯MyBatisä¸­æœ€å¸¸è§çš„æ€§èƒ½é—®é¢˜ä¹‹ä¸€ï¼š

**é—®é¢˜æè¿°**ï¼šå½“æŸ¥è¯¢ä¸€ä¸ªåˆ—è¡¨æ•°æ®ï¼Œç„¶åéå†åˆ—è¡¨æŸ¥è¯¢å…³è”æ•°æ®æ—¶ï¼Œä¼šäº§ç”ŸN+1æ¬¡æŸ¥è¯¢ã€‚

```java
// äº§ç”ŸN+1æŸ¥è¯¢çš„ä»£ç 
List<User> users = userMapper.getAllUsers(); // 1æ¬¡æŸ¥è¯¢
for (User user : users) {
    List<Order> orders = orderMapper.getOrdersByUserId(user.getId()); // Næ¬¡æŸ¥è¯¢
    user.setOrders(orders);
}
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. **ä½¿ç”¨åµŒå¥—ç»“æœæ˜ å°„**ï¼ˆæ¨èï¼‰
   ```xml
   <select id="getUsersWithOrders" resultMap="UserWithOrdersMap">
     SELECT u.*, o.* FROM user u LEFT JOIN orders o ON u.id = o.user_id
   </select>
   ```

2. **ä½¿ç”¨å»¶è¿ŸåŠ è½½**ï¼ˆé€‚ç”¨äºå…³è”æ•°æ®ä½¿ç”¨ç‡ä½çš„åœºæ™¯ï¼‰
   ```xml
   <!-- é…ç½®å¯ç”¨å»¶è¿ŸåŠ è½½ -->
   <setting name="lazyLoadingEnabled" value="true"/>
   <setting name="aggressiveLazyLoading" value="false"/>
   
   <resultMap id="userMap" type="User">
     <id property="id" column="id"/>
     <result property="name" column="name"/>
     <collection property="orders" select="getOrdersByUserId" column="id" fetchType="lazy"/>
   </resultMap>
   ```

3. **ä½¿ç”¨æ‰¹é‡æŸ¥è¯¢**
   ```java
   // å…ˆè·å–ç”¨æˆ·åˆ—è¡¨
   List<User> users = userMapper.getAllUsers();
   
   // æå–æ‰€æœ‰ç”¨æˆ·ID
   List<Long> userIds = users.stream().map(User::getId).collect(Collectors.toList());
   
   // æ‰¹é‡æŸ¥è¯¢è®¢å•
   Map<Long, List<Order>> orderMap = orderMapper.getOrdersByUserIds(userIds).stream()
       .collect(Collectors.groupingBy(Order::getUserId));
   
   // è®¾ç½®è®¢å•æ•°æ®
   users.forEach(user -> user.setOrders(orderMap.getOrDefault(user.getId(), Collections.emptyList())));
   ```

</TabItem>
<TabItem value="type-handling" label="ç±»å‹å¤„ç†">

å¤„ç†Javaç±»å‹ä¸æ•°æ®åº“ç±»å‹çš„æ˜ å°„é—®é¢˜ï¼š

**é—®é¢˜æè¿°**ï¼šç‰¹æ®Šç±»å‹ï¼ˆå¦‚æšä¸¾ã€JSONã€æ—¥æœŸæ—¶é—´ç­‰ï¼‰åœ¨Javaä¸æ•°æ®åº“ä¹‹é—´çš„è½¬æ¢ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. **æšä¸¾ç±»å‹å¤„ç†**
   ```java
   // æšä¸¾å®šä¹‰
   public enum UserStatus {
       ACTIVE(1, "æ´»è·ƒ"),
       INACTIVE(0, "éæ´»è·ƒ"),
       LOCKED(-1, "é”å®š");
       
       private final int value;
       private final String desc;
       
       UserStatus(int value, String desc) {
           this.value = value;
           this.desc = desc;
       }
       
       public int getValue() {
           return value;
       }
       
       public String getDesc() {
           return desc;
       }
       
       public static UserStatus fromValue(int value) {
           for (UserStatus status : values()) {
               if (status.value == value) {
                   return status;
               }
           }
           throw new IllegalArgumentException("Invalid status value: " + value);
       }
   }
   
   // è‡ªå®šä¹‰TypeHandler
   public class UserStatusTypeHandler extends BaseTypeHandler<UserStatus> {
       @Override
       public void setNonNullParameter(PreparedStatement ps, int i, UserStatus parameter, JdbcType jdbcType) throws SQLException {
           ps.setInt(i, parameter.getValue());
       }
       
       @Override
       public UserStatus getNullableResult(ResultSet rs, String columnName) throws SQLException {
           int value = rs.getInt(columnName);
           return rs.wasNull() ? null : UserStatus.fromValue(value);
       }
       
       @Override
       public UserStatus getNullableResult(ResultSet rs, int columnIndex) throws SQLException {
           int value = rs.getInt(columnIndex);
           return rs.wasNull() ? null : UserStatus.fromValue(value);
       }
       
       @Override
       public UserStatus getNullableResult(CallableStatement cs, int columnIndex) throws SQLException {
           int value = cs.getInt(columnIndex);
           return cs.wasNull() ? null : UserStatus.fromValue(value);
       }
   }
   ```

2. **JSONç±»å‹å¤„ç†**
   ```java
   public class JsonTypeHandler<T> extends BaseTypeHandler<T> {
       private final Class<T> clazz;
       private static final ObjectMapper MAPPER = new ObjectMapper();
       
       public JsonTypeHandler(Class<T> clazz) {
           this.clazz = clazz;
       }
       
       @Override
       public void setNonNullParameter(PreparedStatement ps, int i, T parameter, JdbcType jdbcType) throws SQLException {
           try {
               ps.setString(i, MAPPER.writeValueAsString(parameter));
           } catch (JsonProcessingException e) {
               throw new SQLException("Error converting object to JSON", e);
           }
       }
       
       @Override
       public T getNullableResult(ResultSet rs, String columnName) throws SQLException {
           return parseJSON(rs.getString(columnName));
       }
       
       @Override
       public T getNullableResult(ResultSet rs, int columnIndex) throws SQLException {
           return parseJSON(rs.getString(columnIndex));
       }
       
       @Override
       public T getNullableResult(CallableStatement cs, int columnIndex) throws SQLException {
           return parseJSON(cs.getString(columnIndex));
       }
       
       private T parseJSON(String json) throws SQLException {
           if (json == null) return null;
           try {
               return MAPPER.readValue(json, clazz);
           } catch (IOException e) {
               throw new SQLException("Error parsing JSON", e);
           }
       }
   }
   ```

3. **LocalDateTimeç±»å‹å¤„ç†**
   ```java
   public class LocalDateTimeTypeHandler extends BaseTypeHandler<LocalDateTime> {
       @Override
       public void setNonNullParameter(PreparedStatement ps, int i, LocalDateTime parameter, JdbcType jdbcType) throws SQLException {
           ps.setTimestamp(i, Timestamp.valueOf(parameter));
       }
       
       @Override
       public LocalDateTime getNullableResult(ResultSet rs, String columnName) throws SQLException {
           Timestamp timestamp = rs.getTimestamp(columnName);
           return timestamp != null ? timestamp.toLocalDateTime() : null;
       }
       
       @Override
       public LocalDateTime getNullableResult(ResultSet rs, int columnIndex) throws SQLException {
           Timestamp timestamp = rs.getTimestamp(columnIndex);
           return timestamp != null ? timestamp.toLocalDateTime() : null;
       }
       
       @Override
       public LocalDateTime getNullableResult(CallableStatement cs, int columnIndex) throws SQLException {
           Timestamp timestamp = cs.getTimestamp(columnIndex);
           return timestamp != null ? timestamp.toLocalDateTime() : null;
       }
   }
   ```

</TabItem>
<TabItem value="performance" label="æ€§èƒ½ä¼˜åŒ–">

è§£å†³MyBatiså¸¸è§æ€§èƒ½é—®é¢˜ï¼š

1. **ä¸€çº§ç¼“å­˜é—®é¢˜**ï¼šä¸€çº§ç¼“å­˜å¯èƒ½å¯¼è‡´è„è¯»

   **è§£å†³æ–¹æ¡ˆ**ï¼š
   - è°ƒæ•´ç¼“å­˜çº§åˆ«ä¸ºSTATEMENT
     ```xml
     <setting name="localCacheScope" value="STATEMENT"/>
     ```
   - æ‰‹åŠ¨æ¸…é™¤ç¼“å­˜
     ```java
     sqlSession.clearCache();
     ```

2. **äºŒçº§ç¼“å­˜é—®é¢˜**ï¼šäºŒçº§ç¼“å­˜å¯èƒ½å¯¼è‡´æ•°æ®ä¸€è‡´æ€§é—®é¢˜

   **è§£å†³æ–¹æ¡ˆ**ï¼š
   - åˆç†è®¾ç½®åˆ·æ–°é—´éš”
     ```xml
     <cache flushInterval="60000"/>
     ```
   - é’ˆå¯¹å†™æ“ä½œé¢‘ç¹çš„è¡¨ç¦ç”¨äºŒçº§ç¼“å­˜
   - ä½¿ç”¨è‡ªå®šä¹‰ç¼“å­˜ï¼ˆå¦‚Redisï¼‰æ›¿ä»£é»˜è®¤äºŒçº§ç¼“å­˜

3. **å¤§æ•°æ®é‡åˆ†é¡µé—®é¢˜**ï¼šæ™®é€šLIMITåˆ†é¡µåœ¨æ•°æ®é‡å¤§æ—¶æ€§èƒ½ä¸‹é™

   **è§£å†³æ–¹æ¡ˆ**ï¼š
   - ä½¿ç”¨ä¸»é”®åˆ†é¡µ
     ```xml
     <select id="getPagedUsers">
       SELECT * FROM user
       WHERE id > #{lastId}
       ORDER BY id ASC
       LIMIT #{pageSize}
     </select>
     ```
   - ä½¿ç”¨è¦†ç›–ç´¢å¼•
     ```xml
     <select id="getPagedUserIds">
       SELECT id FROM user
       WHERE status = #{status}
       ORDER BY create_time DESC
       LIMIT #{offset}, #{limit}
     </select>
     
     <select id="getUsersByIds">
       SELECT * FROM user
       WHERE id IN
       <foreach collection="ids" item="id" open="(" close=")" separator=",">
         #{id}
       </foreach>
     </select>
     ```

4. **å¤æ‚æ¡ä»¶æŸ¥è¯¢ä¼˜åŒ–**

   **è§£å†³æ–¹æ¡ˆ**ï¼š
   - ä½¿ç”¨å­æŸ¥è¯¢ä»£æ›¿å¤šè¡¨JOIN
   - åˆç†ä½¿ç”¨ç´¢å¼•
   - æŸ¥è¯¢æ¡ä»¶æå‰è¿‡æ»¤ï¼Œå‡å°‘JOINè¡¨çš„æ•°æ®é‡
   - ä½¿ç”¨EXISTSä»£æ›¿INé€‚ç”¨äºå¤–è¡¨å°å†…è¡¨å¤§çš„æƒ…å†µ

</TabItem>
<TabItem value="spring-integration" label="Springé›†æˆé—®é¢˜">

è§£å†³ä¸Springé›†æˆæ—¶çš„å¸¸è§é—®é¢˜ï¼š

1. **äº‹åŠ¡ç®¡ç†é—®é¢˜**

   **é—®é¢˜**ï¼šäº‹åŠ¡æœªç”Ÿæ•ˆæˆ–å‡ºç°å¼‚å¸¸å›æ»šä¸å®Œæ•´

   **è§£å†³æ–¹æ¡ˆ**ï¼š
   - ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„äº‹åŠ¡ç®¡ç†å™¨
     ```java
     @Bean
     public PlatformTransactionManager transactionManager(DataSource dataSource) {
         return new DataSourceTransactionManager(dataSource);
     }
     ```
   - è®¾ç½®æ­£ç¡®çš„äº‹åŠ¡ä¼ æ’­ç‰¹æ€§
     ```java
     @Transactional(propagation = Propagation.REQUIRED, rollbackFor = Exception.class)
     ```
   - é¿å…è‡ªè°ƒç”¨å¯¼è‡´äº‹åŠ¡å¤±æ•ˆ
     ```java
     // é”™è¯¯æ–¹å¼ - äº‹åŠ¡ä¸ä¼šç”Ÿæ•ˆ
     @Service
     public class UserService {
         public void createUser() {
             // ä»£ç ...
             this.updateRelatedData(); // è°ƒç”¨åŒç±»ä¸­çš„@Transactionalæ–¹æ³•
         }
         
         @Transactional
         public void updateRelatedData() {
             // äº‹åŠ¡ä¸ä¼šç”Ÿæ•ˆ
         }
     }
     
     // æ­£ç¡®æ–¹å¼
     @Service
     public class UserService {
         @Autowired
         private UserService self; // æ³¨å…¥è‡ªèº«ä»£ç†
         
         public void createUser() {
             // ä»£ç ...
             self.updateRelatedData(); // é€šè¿‡ä»£ç†è°ƒç”¨
         }
         
         @Transactional
         public void updateRelatedData() {
             // äº‹åŠ¡ç”Ÿæ•ˆ
         }
     }
     ```

2. **å¤šæ•°æ®æºé…ç½®é—®é¢˜**

   **è§£å†³æ–¹æ¡ˆ**ï¼š
   ```java
   @Configuration
   public class DataSourceConfig {
       
       @Bean
       @ConfigurationProperties("spring.datasource.primary")
       public DataSourceProperties primaryDataSourceProperties() {
           return new DataSourceProperties();
       }
       
       @Bean
       @ConfigurationProperties("spring.datasource.secondary")
       public DataSourceProperties secondaryDataSourceProperties() {
           return new DataSourceProperties();
       }
       
       @Bean
       @Primary
       public DataSource primaryDataSource() {
           return primaryDataSourceProperties().initializeDataSourceBuilder().build();
       }
       
       @Bean
       public DataSource secondaryDataSource() {
           return secondaryDataSourceProperties().initializeDataSourceBuilder().build();
       }
       
       @Bean
       @Primary
       public SqlSessionFactory primarySqlSessionFactory() throws Exception {
           SqlSessionFactoryBean factoryBean = new SqlSessionFactoryBean();
           factoryBean.setDataSource(primaryDataSource());
           factoryBean.setMapperLocations(new PathMatchingResourcePatternResolver()
               .getResources("classpath:mapper/primary/**/*.xml"));
           return factoryBean.getObject();
       }
       
       @Bean
       public SqlSessionFactory secondarySqlSessionFactory() throws Exception {
           SqlSessionFactoryBean factoryBean = new SqlSessionFactoryBean();
           factoryBean.setDataSource(secondaryDataSource());
           factoryBean.setMapperLocations(new PathMatchingResourcePatternResolver()
               .getResources("classpath:mapper/secondary/**/*.xml"));
           return factoryBean.getObject();
       }
       
       @Bean
       @Primary
       public SqlSessionTemplate primarySqlSessionTemplate() throws Exception {
           return new SqlSessionTemplate(primarySqlSessionFactory());
       }
       
       @Bean
       public SqlSessionTemplate secondarySqlSessionTemplate() throws Exception {
           return new SqlSessionTemplate(secondarySqlSessionFactory());
       }
   }
   
   @Configuration
   @MapperScan(basePackages = "com.example.mapper.primary", sqlSessionTemplateRef = "primarySqlSessionTemplate")
   public class PrimaryDbConfig {
   }
   
   @Configuration
   @MapperScan(basePackages = "com.example.mapper.secondary", sqlSessionTemplateRef = "secondarySqlSessionTemplate")
   public class SecondaryDbConfig {
   }
   ```

</TabItem>
</Tabs>

### 9.3 MyBatisæŠ€æœ¯æ ˆæ‰©å±•

MyBatisç”Ÿæ€ç³»ç»Ÿéå¸¸ä¸°å¯Œï¼Œæœ‰å¤šç§æ‰©å±•å’Œå·¥å…·å¯ä»¥ç®€åŒ–å¼€å‘ï¼Œæé«˜æ•ˆç‡ã€‚

<Tabs>
<TabItem value="mybatis-plus" label="MyBatis-Plus">

[MyBatis-Plus](https://baomidou.com/)æ˜¯åŸºäºMyBatisçš„å¢å¼ºå·¥å…·ï¼Œç®€åŒ–äº†å¼€å‘ï¼Œæä¾›äº†æ›´å¤šå¼ºå¤§çš„åŠŸèƒ½ã€‚

**ä¸»è¦ç‰¹æ€§**ï¼š

1. **é€šç”¨CRUD**ï¼šæ— éœ€ç¼–å†™SQLå³å¯å®ç°åŸºæœ¬CRUDæ“ä½œ
   ```java
   @Mapper
   public interface UserMapper extends BaseMapper<User> {
       // å·²å†…ç½®é€šç”¨CRUDæ–¹æ³•
       // insert, deleteById, updateById, selectById, selectListç­‰
   }
   
   // ä½¿ç”¨ç¤ºä¾‹
   userMapper.insert(user);
   userMapper.selectById(1);
   userMapper.deleteById(1);
   ```

2. **æ¡ä»¶æ„é€ å™¨**ï¼šå¼ºå¤§çš„æŸ¥è¯¢æ¡ä»¶æ„é€ 
   ```java
   // æŸ¥è¯¢æ¡ä»¶æ„é€ 
   LambdaQueryWrapper<User> queryWrapper = new LambdaQueryWrapper<>();
   queryWrapper
       .eq(User::getStatus, 1)
       .like(User::getUsername, "å¼ ")
       .between(User::getCreateTime, startDate, endDate)
       .orderByDesc(User::getCreateTime);
   
   List<User> users = userMapper.selectList(queryWrapper);
   ```

3. **åˆ†é¡µæ’ä»¶**ï¼šç®€åŒ–åˆ†é¡µæŸ¥è¯¢
   ```java
   // é…ç½®
   @Bean
   public MybatisPlusInterceptor mybatisPlusInterceptor() {
       MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
       interceptor.addInnerInterceptor(new PaginationInnerInterceptor(DbType.MYSQL));
       return interceptor;
   }
   
   // ä½¿ç”¨
   Page<User> page = new Page<>(1, 10);
   Page<User> resultPage = userMapper.selectPage(page, queryWrapper);
   
   // è·å–åˆ†é¡µä¿¡æ¯
   long total = resultPage.getTotal();
   long pages = resultPage.getPages();
   List<User> records = resultPage.getRecords();
   ```

4. **è‡ªåŠ¨å¡«å……**ï¼šè‡ªåŠ¨å¤„ç†åˆ›å»ºæ—¶é—´ã€æ›´æ–°æ—¶é—´ç­‰å­—æ®µ
   ```java
   @TableField(fill = FieldFill.INSERT)
   private LocalDateTime createTime;
   
   @TableField(fill = FieldFill.INSERT_UPDATE)
   private LocalDateTime updateTime;
   
   // å…ƒæ•°æ®å¤„ç†å™¨
   @Component
   public class MyMetaObjectHandler implements MetaObjectHandler {
       @Override
       public void insertFill(MetaObject metaObject) {
           this.strictInsertFill(metaObject, "createTime", LocalDateTime.class, LocalDateTime.now());
           this.strictInsertFill(metaObject, "updateTime", LocalDateTime.class, LocalDateTime.now());
       }
       
       @Override
       public void updateFill(MetaObject metaObject) {
           this.strictUpdateFill(metaObject, "updateTime", LocalDateTime.class, LocalDateTime.now());
       }
   }
   ```

5. **ä»£ç ç”Ÿæˆå™¨**ï¼šå¿«é€Ÿç”ŸæˆEntityã€Mapperã€Serviceã€Controller
   ```java
   // ä»£ç ç”Ÿæˆç¤ºä¾‹
   AutoGenerator generator = new AutoGenerator();
   
   // æ•°æ®æºé…ç½®
   generator.setDataSource(dataSourceConfig);
   
   // å…¨å±€é…ç½®
   generator.setGlobalConfig(globalConfig);
   
   // åŒ…é…ç½®
   generator.setPackageInfo(packageConfig);
   
   // ç­–ç•¥é…ç½®
   generator.setStrategy(strategyConfig);
   
   // æ‰§è¡Œ
   generator.execute();
   ```

6. **ä¹è§‚é”æ’ä»¶**ï¼šæ”¯æŒä¹è§‚é”æœºåˆ¶
   ```java
   @Version
   private Integer version;
   
   // é…ç½®ä¹è§‚é”æ’ä»¶
   @Bean
   public MybatisPlusInterceptor mybatisPlusInterceptor() {
       MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
       interceptor.addInnerInterceptor(new OptimisticLockerInnerInterceptor());
       return interceptor;
   }
   ```

</TabItem>
<TabItem value="tk-mapper" label="é€šç”¨Mapper">

[é€šç”¨Mapper](https://github.com/abel533/Mapper)æ˜¯ä¸€ä¸ªMyBatisçš„å¢å¼ºå·¥å…·ï¼Œæä¾›é€šç”¨çš„CRUDæ“ä½œã€‚

**ä¸»è¦ç‰¹æ€§**ï¼š

1. **åŸºç¡€CRUD**ï¼šæä¾›é€šç”¨çš„CRUDæ“ä½œ
   ```java
   @Mapper
   public interface UserMapper extends tk.mybatis.mapper.common.Mapper<User> {
       // å·²å†…ç½®é€šç”¨æ–¹æ³•
   }
   
   // ä½¿ç”¨
   userMapper.insert(user);
   userMapper.selectByPrimaryKey(1);
   userMapper.updateByPrimaryKey(user);
   userMapper.delete(user);
   ```

2. **æ¡ä»¶æŸ¥è¯¢**ï¼šExampleæŸ¥è¯¢æ¡ä»¶
   ```java
   Example example = new Example(User.class);
   example.createCriteria()
       .andEqualTo("status", 1)
       .andLike("username", "%å¼ %")
       .andBetween("createTime", startDate, endDate);
   
   example.orderBy("createTime").desc();
   
   List<User> users = userMapper.selectByExample(example);
   ```

3. **ç‰¹æ®Šæ“ä½œ**ï¼šæä¾›å¤šç§ç‰¹æ®Šæ“ä½œæ¥å£
   ```java
   // ç»„åˆæ¥å£
   public interface UserMapper extends 
       Mapper<User>,               // åŸºç¡€CRUD
       IdsMapper<User>,            // æ ¹æ®ä¸»é”®æ‰¹é‡æ“ä½œ
       ConditionMapper<User>,      // æ¡ä»¶æŸ¥è¯¢
       ExampleMapper<User>,        // ExampleæŸ¥è¯¢
       RowBoundsMapper<User> {     // åˆ†é¡µæŸ¥è¯¢
   }
   
   // æ‰¹é‡æ“ä½œ
   List<Integer> ids = Arrays.asList(1, 2, 3);
   userMapper.deleteByIds(StringUtils.join(ids, ","));
   
   // æ¡ä»¶æŸ¥è¯¢
   User condition = new User();
   condition.setStatus(1);
   List<User> users = userMapper.selectByCondition(condition);
   ```

</TabItem>
<TabItem value="pagehelper" label="PageHelper">

[PageHelper](https://github.com/pagehelper/Mybatis-PageHelper)æ˜¯MyBatisçš„åˆ†é¡µæ’ä»¶ï¼Œç®€åŒ–åˆ†é¡µæŸ¥è¯¢æ“ä½œã€‚

**ä¸»è¦ç‰¹æ€§**ï¼š

1. **ç®€å•é…ç½®**
   ```java
   @Configuration
   public class MybatisConfig {
       @Bean
       public PageInterceptor pageInterceptor() {
           PageInterceptor pageInterceptor = new PageInterceptor();
           Properties properties = new Properties();
           properties.setProperty("reasonable", "true");
           properties.setProperty("helperDialect", "mysql");
           pageInterceptor.setProperties(properties);
           return pageInterceptor;
       }
   }
   ```

2. **å¼€å§‹åˆ†é¡µ**
   ```java
   // æ–¹æ³•ä¸€ï¼šä½¿ç”¨PageHelper.startPage
   PageHelper.startPage(pageNum, pageSize);
   List<User> users = userMapper.selectUsers(condition);
   
   // æ–¹æ³•äºŒï¼šä½¿ç”¨PageHelper.offsetPage
   PageHelper.offsetPage(offset, limit);
   List<User> users = userMapper.selectUsers(condition);
   ```

3. **è·å–åˆ†é¡µä¿¡æ¯**
   ```java
   // æ–¹æ³•ä¸€ï¼šä½¿ç”¨PageInfoåŒ…è£…
   PageInfo<User> pageInfo = new PageInfo<>(users);
   
   // è·å–åˆ†é¡µä¿¡æ¯
   long total = pageInfo.getTotal();
   int pages = pageInfo.getPages();
   List<User> list = pageInfo.getList();
   
   // æ–¹æ³•äºŒï¼šä½¿ç”¨Pageå¯¹è±¡
   Page<User> page = (Page<User>) users;
   long total = page.getTotal();
   int pages = page.getPages();
   ```

4. **æ’åº**
   ```java
   // åˆ†é¡µå¹¶æ’åº
   PageHelper.startPage(pageNum, pageSize, "create_time desc");
   
   // æˆ–è€…
   PageHelper.startPage(pageNum, pageSize);
   PageHelper.orderBy("create_time desc");
   ```

5. **åˆç†åŒ–**
   ```java
   // è®¾ç½®reasonableä¸ºtrueï¼Œå½“é¡µæ•°è¶…è¿‡æ€»é¡µæ•°æ—¶ï¼Œè‡ªåŠ¨æŸ¥è¯¢æœ€åä¸€é¡µ
   PageHelper.startPage(pageNum, pageSize, true);
   ```

</TabItem>
<TabItem value="dynamic-datasource" label="åŠ¨æ€æ•°æ®æº">

[dynamic-datasource](https://github.com/baomidou/dynamic-datasource-spring-boot-starter)æ˜¯ä¸€ä¸ªæ”¯æŒå¤šæ•°æ®æºåŠ¨æ€åˆ‡æ¢çš„ç»„ä»¶ã€‚

**ä¸»è¦ç‰¹æ€§**ï¼š

1. **é…ç½®å¤šæ•°æ®æº**
   ```yml
   spring:
     datasource:
       dynamic:
         primary: master
         strict: false
         datasource:
           master:
             url: jdbc:mysql://localhost:3306/master
             username: root
             password: root
             driver-class-name: com.mysql.cj.jdbc.Driver
           slave_1:
             url: jdbc:mysql://localhost:3307/slave
             username: root
             password: root
             driver-class-name: com.mysql.cj.jdbc.Driver
           slave_2:
             url: jdbc:mysql://localhost:3308/slave
             username: root
             password: root
             driver-class-name: com.mysql.cj.jdbc.Driver
   ```

2. **ä½¿ç”¨æ³¨è§£åˆ‡æ¢æ•°æ®æº**
   ```java
   @DS("slave_1")
   @Service
   public class UserServiceImpl implements UserService {
       @Autowired
       private UserMapper userMapper;
       
       @Override
       public List<User> listUsers() {
           return userMapper.selectList(null);
       }
       
       @DS("slave_2")
       @Override
       public User getUserById(Long id) {
           return userMapper.selectById(id);
       }
       
       @DS("master")
       @Override
       public boolean updateUser(User user) {
           return userMapper.updateById(user) > 0;
       }
   }
   ```

3. **åˆ†ç»„ç­–ç•¥**
   ```java
   // é…ç½®
   @Bean
   public DynamicDataSourceProvider dynamicDataSourceProvider() {
       Map<String, DataSourceProperty> dataSourcePropertiesMap = new HashMap<>();
       // ä¸»åº“
       dataSourcePropertiesMap.put("master", masterDataSourceProperty());
       // ä»åº“ç»„
       dataSourcePropertiesMap.put("slave_1", slave1DataSourceProperty());
       dataSourcePropertiesMap.put("slave_2", slave2DataSourceProperty());
       return new YmlDynamicDataSourceProvider(dataSourcePropertiesMap);
   }
   
   @Bean
   public DynamicDataSourceStrategy loadBalanceDynamicDataSourceStrategy() {
       return new LoadBalanceDynamicDataSourceStrategy();
   }
   
   // ä½¿ç”¨
   @DS("slave") // slaveç»„ï¼Œä¼šè‡ªåŠ¨åœ¨slave_1å’Œslave_2ä¸­è´Ÿè½½å‡è¡¡
   public List<User> listUsers() {
       return userMapper.selectList(null);
   }
   ```

4. **äº‹åŠ¡æ”¯æŒ**
   ```java
   @DS("master")
   @Transactional
   public void createUser(User user) {
       userMapper.insert(user);
       // åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œæ•°æ®æºä¿æŒä¸€è‡´
       userRoleMapper.insertUserRole(user.getId(), roleId);
   }
   ```

</TabItem>
</Tabs>

:::tip MyBatisæœ€ä½³å®è·µæ€»ç»“
1. **å‘½åè§„èŒƒ**ï¼šä¿æŒSQL IDä¸Mapperæ¥å£æ–¹æ³•åä¸€è‡´ï¼Œä½¿ç”¨æœ‰æ„ä¹‰çš„å‘½å
2. **æ¨¡å—åŒ–**ï¼šæŒ‰ä¸šåŠ¡æ¨¡å—ç»„ç»‡ä»£ç ï¼Œæå–å…¬å…±SQLç‰‡æ®µ
3. **SQLä¼˜åŒ–**ï¼šåªæŸ¥è¯¢å¿…è¦çš„åˆ—ï¼Œåˆç†ä½¿ç”¨ç´¢å¼•ï¼Œé¿å…è¿‡å¤šJOIN
4. **å®‰å…¨é˜²æŠ¤**ï¼šä½¿ç”¨å‚æ•°ç»‘å®šé˜²æ­¢SQLæ³¨å…¥ï¼Œæ•æ„Ÿæ•°æ®åŠ å¯†å¤„ç†
5. **æ€§èƒ½ä¼˜åŒ–**ï¼šåˆç†ä½¿ç”¨ç¼“å­˜ï¼Œé¿å…N+1æŸ¥è¯¢ï¼Œæ‰¹é‡å¤„ç†å¤§é‡æ•°æ®
6. **é›†æˆæ‰©å±•**ï¼šæ ¹æ®éœ€æ±‚é€‰æ‹©åˆé€‚çš„MyBatisæ‰©å±•å·¥å…·
7. **é¢å‘æ¥å£**ï¼šéµå¾ªé¢å‘æ¥å£ç¼–ç¨‹åŸåˆ™ï¼Œé™ä½ä»£ç è€¦åˆåº¦
8. **å•ä¸€èŒè´£**ï¼šæ¯ä¸ªMapperæ¥å£ä¸“æ³¨äºå•ä¸€å®ä½“çš„æ“ä½œ
9. **æµ‹è¯•è¦†ç›–**ï¼šç¼–å†™å•å…ƒæµ‹è¯•ï¼Œç¡®ä¿SQLè¯­å¥æ­£ç¡®
10. **ç‰ˆæœ¬ç®¡ç†**ï¼šä½¿ç”¨æ•°æ®åº“ç‰ˆæœ¬ç®¡ç†å·¥å…·ï¼ˆå¦‚Flywayã€Liquibaseï¼‰ç®¡ç†æ•°æ®åº“å˜æ›´
:::

## 10. é¢è¯•é¢˜ç²¾é€‰

MyBatisæ˜¯Javaé¢è¯•ä¸­å¸¸è§çš„æŒä¹…å±‚æ¡†æ¶è¯é¢˜ï¼Œä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§é¢è¯•é¢˜åŠå…¶è¯¦ç»†è§£ç­”ã€‚

### 10.1 åŸºç¡€åŸç†é¢è¯•é¢˜

<Tabs>
<TabItem value="principle" label="æ ¸å¿ƒåŸç†">

**Q: MyBatisçš„æ ¸å¿ƒå·¥ä½œåŸç†æ˜¯ä»€ä¹ˆï¼Ÿ**

A: MyBatisçš„æ ¸å¿ƒå·¥ä½œåŸç†å¯ä»¥æ¦‚æ‹¬ä¸ºï¼š

1. **é…ç½®è§£æé˜¶æ®µ**ï¼š
   - è¯»å–XMLé…ç½®æ–‡ä»¶æˆ–æ³¨è§£é…ç½®
   - åˆ›å»ºConfigurationå¯¹è±¡ï¼ŒåŒ…å«æ‰€æœ‰é…ç½®ä¿¡æ¯
   - è§£ææ˜ å°„æ–‡ä»¶ï¼Œåˆ›å»ºMappedStatementå¯¹è±¡

2. **åˆå§‹åŒ–é˜¶æ®µ**ï¼š
   - åˆ›å»ºSqlSessionFactoryå®ä¾‹
   - æ³¨å†Œæ‰€æœ‰Mapperæ¥å£

3. **æ‰§è¡Œé˜¶æ®µ**ï¼š
   - é€šè¿‡SqlSessionFactoryåˆ›å»ºSqlSession
   - é€šè¿‡åŠ¨æ€ä»£ç†åˆ›å»ºMapperæ¥å£å®ç°ç±»
   - æ‰§è¡ŒSQLï¼Œæ˜ å°„ç»“æœ

è¿™ä¸ªè¿‡ç¨‹çš„æ ¸å¿ƒæ˜¯é€šè¿‡åŠ¨æ€ä»£ç†å°†æ¥å£æ–¹æ³•è°ƒç”¨è½¬æ¢ä¸ºSQLæ‰§è¡Œï¼Œå†å°†ç»“æœé›†æ˜ å°„ä¸ºJavaå¯¹è±¡ã€‚

**Q: SqlSessionå’ŒSqlSessionFactoryçš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ**

A: 
- **SqlSessionFactory**ï¼š
  - è´Ÿè´£åˆ›å»ºSqlSessionå®ä¾‹
  - çº¿ç¨‹å®‰å…¨ï¼Œå¯ä¾›å¤šä¸ªçº¿ç¨‹å…±äº«
  - å…¨å±€å”¯ä¸€ï¼Œåº”ç”¨çº§ç”Ÿå‘½å‘¨æœŸ
  - ç±»ä¼¼äºæ•°æ®åº“è¿æ¥æ± ï¼Œæ˜¯ä¸€ä¸ªé‡é‡çº§å¯¹è±¡

- **SqlSession**ï¼š
  - æä¾›æ‰§è¡ŒSQLçš„API
  - éçº¿ç¨‹å®‰å…¨ï¼Œä¸èƒ½åœ¨å¤šçº¿ç¨‹ä¸­å…±äº«
  - ä¼šè¯çº§ç”Ÿå‘½å‘¨æœŸï¼Œä½¿ç”¨åéœ€å…³é—­
  - ç±»ä¼¼äºæ•°æ®åº“è¿æ¥ï¼Œæ˜¯ä¸€ä¸ªè½»é‡çº§å¯¹è±¡

**Q: MyBatisçš„å·¥ä½œæµç¨‹æ˜¯æ€æ ·çš„ï¼Ÿ**

A: MyBatiså®Œæ•´å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š

1. è¯»å–é…ç½®æ–‡ä»¶ï¼Œåˆ›å»ºSqlSessionFactoryBuilderå¯¹è±¡
2. SqlSessionFactoryBuilderè§£æé…ç½®ï¼Œåˆ›å»ºSqlSessionFactoryå¯¹è±¡
3. ä»SqlSessionFactoryè·å–SqlSession
4. é€šè¿‡SqlSessionè·å–Mapperæ¥å£çš„ä»£ç†å®ç°
5. é€šè¿‡Mapperæ¥å£è°ƒç”¨æ–¹æ³•
6. SqlSessionå°†è¯·æ±‚è½¬å‘ç»™Executor
7. Executoré€šè¿‡StatementHandleråˆ›å»ºStatementå¯¹è±¡
8. ParameterHandlerè®¾ç½®å‚æ•°
9. Statementæ‰§è¡ŒSQL
10. ResultSetHandlerå¤„ç†ç»“æœé›†ï¼Œè½¬æ¢ä¸ºJavaå¯¹è±¡
11. è¿”å›ç»“æœï¼Œå…³é—­SqlSession

</TabItem>
<TabItem value="comparison" label="æ¡†æ¶å¯¹æ¯”">

**Q: MyBatisä¸Hibernateæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ**

A: MyBatiså’ŒHibernateçš„ä¸»è¦åŒºåˆ«ï¼š

| ç‰¹æ€§ | MyBatis | Hibernate |
|-----|---------|-----------|
| **çº§åˆ«** | åŠè‡ªåŠ¨ORM | å…¨è‡ªåŠ¨ORM |
| **SQLæ§åˆ¶** | æ‰‹å†™SQLï¼Œçµæ´»æ€§é«˜ | è‡ªåŠ¨ç”ŸæˆSQLï¼Œæ§åˆ¶æ€§ä½ |
| **å­¦ä¹ æ›²çº¿** | è¾ƒä½ï¼Œæ¥è¿‘JDBC | è¾ƒé«˜ï¼Œæ¦‚å¿µè¾ƒå¤š |
| **æ€§èƒ½** | è¾ƒé«˜ï¼ˆç›´æ¥SQLä¼˜åŒ–ï¼‰ | è¾ƒä½ï¼ˆè‡ªåŠ¨ç”ŸæˆSQLï¼‰ |
| **å¼€å‘æ•ˆç‡** | éœ€ç¼–å†™SQLï¼Œæ•ˆç‡è¾ƒä½ | æ— éœ€ç¼–å†™SQLï¼Œæ•ˆç‡é«˜ |
| **é€‚ç”¨åœºæ™¯** | å¤æ‚SQLæŸ¥è¯¢ï¼Œæ€§èƒ½è¦æ±‚é«˜ | ç®€å•CRUDï¼Œå¿«é€Ÿå¼€å‘ |
| **æ˜ å°„å¤æ‚åº¦** | çµæ´»ï¼Œæ”¯æŒå¤æ‚æ˜ å°„ | å®Œå–„ï¼Œæ”¯æŒå¤æ‚å…³è” |
| **ç¼“å­˜æœºåˆ¶** | ç®€å•çš„ä¸€äºŒçº§ç¼“å­˜ | å¤æ‚çš„å¤šçº§ç¼“å­˜ |

**Q: MyBatisç›¸æ¯”JDBCæœ‰ä»€ä¹ˆä¼˜åŠ¿ï¼Ÿ**

A: MyBatisç›¸æ¯”JDBCçš„ä¼˜åŠ¿ï¼š

1. **ä»£ç é‡å‡å°‘**ï¼šæ— éœ€æ‰‹åŠ¨ç®¡ç†è¿æ¥ã€è®¾ç½®å‚æ•°ã€å¤„ç†ç»“æœé›†
2. **å‚æ•°æ˜ å°„**ï¼šè‡ªåŠ¨å°†Javaå¯¹è±¡æ˜ å°„ä¸ºSQLå‚æ•°
3. **ç»“æœæ˜ å°„**ï¼šè‡ªåŠ¨å°†ç»“æœé›†æ˜ å°„ä¸ºJavaå¯¹è±¡
4. **SQLåˆ†ç¦»**ï¼šSQLä¸ä»£ç åˆ†ç¦»ï¼Œä¾¿äºç»´æŠ¤
5. **åŠ¨æ€SQL**ï¼šæ”¯æŒæ¡ä»¶åˆ¤æ–­ã€å¾ªç¯ç­‰åŠ¨æ€SQLæ„å»º
6. **ç¼“å­˜æœºåˆ¶**ï¼šå†…ç½®ä¸€äºŒçº§ç¼“å­˜ï¼Œæå‡æ€§èƒ½
7. **äº‹åŠ¡ç®¡ç†**ï¼šç®€åŒ–äº‹åŠ¡ç®¡ç†
8. **æ’ä»¶æœºåˆ¶**ï¼šæ”¯æŒæ’ä»¶æ‰©å±•
9. **æ—¥å¿—æ”¯æŒ**ï¼šè¯¦ç»†çš„æ—¥å¿—è®°å½•

**Q: MyBatiså’ŒJPAå„æœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹ï¼Ÿ**

A: MyBatiså’ŒJPAçš„ä¼˜ç¼ºç‚¹ï¼š

**MyBatisä¼˜ç‚¹**ï¼š
- SQLæ§åˆ¶çµæ´»ï¼Œå¯ä¼˜åŒ–å¤æ‚æŸ¥è¯¢
- å­¦ä¹ æˆæœ¬ä½ï¼Œæ¥è¿‘åŸç”ŸSQL
- æ€§èƒ½å¯æ§ï¼Œä¾¿äºè°ƒä¼˜
- é€‚åˆå¤æ‚ä¸šåŠ¡å’ŒæŠ¥è¡¨æŸ¥è¯¢

**MyBatisç¼ºç‚¹**ï¼š
- éœ€è¦æ‰‹å†™SQLï¼Œå¼€å‘æ•ˆç‡ä½
- æ•°æ®åº“ç§»æ¤æ€§è¾ƒå·®
- å¯¹è±¡å…³ç³»æ˜ å°„åŠŸèƒ½ç®€å•

**JPAä¼˜ç‚¹**ï¼š
- æ— éœ€ç¼–å†™SQLï¼Œæé«˜å¼€å‘æ•ˆç‡
- æ•°æ®åº“æ— å…³æ€§å¥½ï¼Œä¾¿äºåˆ‡æ¢æ•°æ®åº“
- ä¸°å¯Œçš„å¯¹è±¡å…³ç³»æ˜ å°„
- æ ‡å‡†åŒ–è§„èŒƒï¼Œå­¦ä¹ ä¸€æ¬¡å¯ç”¨å¤šå¤„

**JPAç¼ºç‚¹**ï¼š
- å¤æ‚æŸ¥è¯¢éš¾ä»¥ä¼˜åŒ–
- å­¦ä¹ æ›²çº¿é™¡å³­
- å¯¹æ•°æ®åº“ç‰¹æ€§æ”¯æŒæœ‰é™
- æ€§èƒ½è°ƒä¼˜å›°éš¾

</TabItem>
</Tabs>

### 10.2 é…ç½®ä¸æ˜ å°„é¢è¯•é¢˜

<Tabs>
<TabItem value="config" label="é…ç½®é—®é¢˜">

**Q: #{}å’Œ${}çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ**

A: è¿™ä¸¤ç§ç¬¦å·ç”¨äºSQLå‚æ•°ä¼ é€’ï¼Œä½†æœ‰æœ¬è´¨åŒºåˆ«ï¼š

- **#{}**ï¼š
  - å‚æ•°å ä½ç¬¦ï¼Œä½¿ç”¨PreparedStatement
  - ä¼šè‡ªåŠ¨æ·»åŠ å¼•å·ï¼ˆå¦‚å­—ç¬¦ä¸²ï¼‰
  - é˜²æ­¢SQLæ³¨å…¥
  - æ”¯æŒç±»å‹è½¬æ¢
  - ä¾‹ï¼š`WHERE id = #{id}` â†’ `WHERE id = ?`

- **${}**ï¼š
  - æ–‡æœ¬æ›¿æ¢ï¼Œç›´æ¥æ‹¼æ¥SQL
  - ä¸ä¼šæ·»åŠ å¼•å·
  - å­˜åœ¨SQLæ³¨å…¥é£é™©
  - ä¸æ”¯æŒç±»å‹è½¬æ¢
  - ä¾‹ï¼š`ORDER BY ${column}` â†’ `ORDER BY column_name`

**ä½•æ—¶ä½¿ç”¨${}**ï¼š
- åŠ¨æ€è¡¨åï¼š`FROM ${tableName}`
- åŠ¨æ€åˆ—åï¼š`ORDER BY ${columnName}`
- åŠ¨æ€SQLç‰‡æ®µï¼š`${sqlFragment}`

**å®‰å…¨å»ºè®®**ï¼šå°½é‡ä½¿ç”¨#{}ï¼Œå¿…é¡»ä½¿ç”¨${}æ—¶è¦è¿›è¡Œä¸¥æ ¼å‚æ•°æ ¡éªŒã€‚

**Q: MyBatisçš„é…ç½®æ–‡ä»¶ä¸­æœ‰å“ªäº›é‡è¦å…ƒç´ ï¼Ÿ**

A: MyBatisé…ç½®æ–‡ä»¶çš„é‡è¦å…ƒç´ ï¼ˆæŒ‰é¡ºåºï¼‰ï¼š

1. **properties**ï¼šå®šä¹‰å¯é‡ç”¨çš„å±æ€§
2. **settings**ï¼šä¿®æ”¹MyBatisè¡Œä¸ºçš„é‡è¦è®¾ç½®
3. **typeAliases**ï¼šä¸ºJavaç±»å‹è®¾ç½®åˆ«å
4. **typeHandlers**ï¼šç±»å‹å¤„ç†å™¨ï¼Œå¤„ç†Javaä¸JDBCç±»å‹è½¬æ¢
5. **objectFactory**ï¼šåˆ›å»ºç»“æœå¯¹è±¡çš„å·¥å‚
6. **plugins**ï¼šæ’ä»¶æ‹¦æˆªå™¨
7. **environments**ï¼šç¯å¢ƒé…ç½®
   - environmentï¼šç‰¹å®šç¯å¢ƒé…ç½®
   - transactionManagerï¼šäº‹åŠ¡ç®¡ç†å™¨é…ç½®
   - dataSourceï¼šæ•°æ®æºé…ç½®
8. **databaseIdProvider**ï¼šæ•°æ®åº“å‚å•†æ ‡è¯†
9. **mappers**ï¼šæ˜ å°„å™¨é…ç½®

**Q: MyBatisçš„å¸¸ç”¨è®¾ç½®æœ‰å“ªäº›ï¼Ÿ**

A: å¸¸ç”¨è®¾ç½®ï¼š

1. **cacheEnabled**ï¼šæ˜¯å¦å¯ç”¨ç¼“å­˜ï¼ˆé»˜è®¤trueï¼‰
2. **lazyLoadingEnabled**ï¼šæ˜¯å¦å¼€å¯å»¶è¿ŸåŠ è½½ï¼ˆé»˜è®¤falseï¼‰
3. **aggressiveLazyLoading**ï¼šæ˜¯å¦ç§¯æåŠ è½½å¯¹è±¡æ‰€æœ‰å±æ€§ï¼ˆé»˜è®¤falseï¼‰
4. **multipleResultSetsEnabled**ï¼šæ˜¯å¦å…è®¸å•ä¸€è¯­å¥è¿”å›å¤šç»“æœé›†ï¼ˆé»˜è®¤trueï¼‰
5. **useColumnLabel**ï¼šä½¿ç”¨åˆ—æ ‡ç­¾ä»£æ›¿åˆ—åï¼ˆé»˜è®¤trueï¼‰
6. **useGeneratedKeys**ï¼šä½¿ç”¨JDBCçš„getGeneratedKeysï¼ˆé»˜è®¤falseï¼‰
7. **autoMappingBehavior**ï¼šè‡ªåŠ¨æ˜ å°„ç»“æœé›†ï¼ˆNONE/PARTIAL/FULLï¼‰
8. **defaultExecutorType**ï¼šé»˜è®¤æ‰§è¡Œå™¨ç±»å‹ï¼ˆSIMPLE/REUSE/BATCHï¼‰
9. **mapUnderscoreToCamelCase**ï¼šä¸‹åˆ’çº¿è½¬é©¼å³°å‘½åï¼ˆé»˜è®¤falseï¼‰
10. **localCacheScope**ï¼šæœ¬åœ°ç¼“å­˜ä½œç”¨åŸŸï¼ˆSESSION/STATEMENTï¼‰
11. **jdbcTypeForNull**ï¼šNULLå€¼çš„JDBCç±»å‹ï¼ˆé»˜è®¤OTHERï¼‰
12. **logImpl**ï¼šæŒ‡å®šæ—¥å¿—å®ç°ï¼ˆSLF4J/LOG4J/LOG4J2ç­‰ï¼‰

</TabItem>
<TabItem value="mapping" label="æ˜ å°„é—®é¢˜">

**Q: MyBatisæ˜ å°„æ–‡ä»¶ä¸­å¸¸ç”¨å…ƒç´ æœ‰å“ªäº›ï¼Ÿ**

A: å¸¸ç”¨å…ƒç´ ï¼š

1. **resultMap**ï¼šç»“æœæ˜ å°„å®šä¹‰
2. **sql**ï¼šå¯é‡ç”¨çš„SQLç‰‡æ®µ
3. **insert**ï¼šæ’å…¥è¯­å¥
4. **update**ï¼šæ›´æ–°è¯­å¥
5. **delete**ï¼šåˆ é™¤è¯­å¥
6. **select**ï¼šæŸ¥è¯¢è¯­å¥

æ¯ç§å…ƒç´ éƒ½æœ‰ä¸°å¯Œçš„å±æ€§å’Œå­å…ƒç´ ï¼Œä¾‹å¦‚ï¼š

```xml
<select id="getUser" 
        parameterType="int" 
        resultType="User" 
        flushCache="false" 
        useCache="true" 
        timeout="10000" 
        fetchSize="256" 
        statementType="PREPARED">
  SELECT * FROM user WHERE id = #{id}
</select>
```

**Q: resultTypeå’ŒresultMapçš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ**

A: ä¸¤è€…éƒ½ç”¨äºæŒ‡å®šæŸ¥è¯¢ç»“æœçš„æ˜ å°„æ–¹å¼ï¼š

- **resultType**ï¼š
  - æŒ‡å®šè¿”å›ç»“æœçš„Javaç±»å‹
  - è¦æ±‚åˆ—åå’Œå±æ€§åç›¸åŒï¼ˆæˆ–é…ç½®é©¼å³°æ˜ å°„ï¼‰
  - ç®€å•æ˜ å°„çš„é¦–é€‰æ–¹å¼
  - ä¾‹ï¼š`resultType="com.example.User"`

- **resultMap**ï¼š
  - è‡ªå®šä¹‰ç»“æœæ˜ å°„è§„åˆ™
  - å¤„ç†åˆ—åå’Œå±æ€§åä¸åŒ¹é…æƒ…å†µ
  - å¤„ç†å¤æ‚å…³è”å…³ç³»ï¼ˆä¸€å¯¹ä¸€ã€ä¸€å¯¹å¤šç­‰ï¼‰
  - ä¾‹ï¼š`resultMap="UserResultMap"`

**Q: MyBatiså¦‚ä½•å®ç°ä¸€å¯¹ä¸€å’Œä¸€å¯¹å¤šå…³è”æŸ¥è¯¢ï¼Ÿ**

A: MyBatisæä¾›äº†ä¸¤ç§å®ç°å…³è”æŸ¥è¯¢çš„æ–¹å¼ï¼š

1. **åµŒå¥—ç»“æœæ˜ å°„**ï¼ˆå•æ¬¡æŸ¥è¯¢ï¼‰ï¼š
   ```xml
   <!-- ä¸€å¯¹ä¸€å…³è” -->
   <resultMap id="userWithProfile" type="User">
     <id property="id" column="id"/>
     <result property="username" column="username"/>
     <association property="profile" javaType="Profile">
       <id property="id" column="profile_id"/>
       <result property="address" column="address"/>
     </association>
   </resultMap>
   
   <!-- ä¸€å¯¹å¤šå…³è” -->
   <resultMap id="userWithOrders" type="User">
     <id property="id" column="id"/>
     <result property="username" column="username"/>
     <collection property="orders" ofType="Order">
       <id property="id" column="order_id"/>
       <result property="amount" column="amount"/>
     </collection>
   </resultMap>
   ```

2. **åµŒå¥—æŸ¥è¯¢**ï¼ˆå¤šæ¬¡æŸ¥è¯¢ï¼‰ï¼š
   ```xml
   <!-- ä¸€å¯¹ä¸€å…³è” -->
   <resultMap id="userWithProfile" type="User">
     <id property="id" column="id"/>
     <result property="username" column="username"/>
     <association property="profile" 
                  column="id" 
                  select="getProfileByUserId"/>
   </resultMap>
   
   <!-- ä¸€å¯¹å¤šå…³è” -->
   <resultMap id="userWithOrders" type="User">
     <id property="id" column="id"/>
     <result property="username" column="username"/>
     <collection property="orders" 
                 column="id" 
                 select="getOrdersByUserId"/>
   </resultMap>
   ```

</TabItem>
</Tabs>

### 10.3 ç¼“å­˜ä¸æ€§èƒ½é¢è¯•é¢˜

<Tabs>
<TabItem value="cache" label="ç¼“å­˜é—®é¢˜">

**Q: MyBatisçš„ç¼“å­˜æœºåˆ¶æ˜¯æ€æ ·çš„ï¼Ÿ**

A: MyBatisæœ‰ä¸¤çº§ç¼“å­˜æœºåˆ¶ï¼š

1. **ä¸€çº§ç¼“å­˜**ï¼š
   - SqlSessionçº§åˆ«çš„ç¼“å­˜
   - é»˜è®¤å¼€å¯ï¼Œæ— æ³•å…³é—­
   - ä½œç”¨èŒƒå›´ï¼šåŒä¸€SqlSessionå†…
   - ç”Ÿå‘½å‘¨æœŸï¼šSqlSessionå…³é—­æ—¶ç»“æŸ
   - æ¸…é™¤æ¡ä»¶ï¼š
     - æ‰§è¡ŒUPDATEã€INSERTã€DELETEæ“ä½œ
     - è°ƒç”¨clearCache()æ–¹æ³•
     - è°ƒç”¨close()æ–¹æ³•
     - äº‹åŠ¡æäº¤æˆ–å›æ»šæ“ä½œ

2. **äºŒçº§ç¼“å­˜**ï¼š
   - Mapperçº§åˆ«çš„ç¼“å­˜ï¼ˆnamespaceï¼‰
   - é»˜è®¤å…³é—­ï¼Œéœ€æ‰‹åŠ¨é…ç½®
   - ä½œç”¨èŒƒå›´ï¼šåŒä¸€namespaceå†…çš„æ‰€æœ‰SqlSessionå…±äº«
   - ç”Ÿå‘½å‘¨æœŸï¼šåº”ç”¨è¿è¡ŒæœŸé—´
   - å¯ç”¨æ–¹å¼ï¼š
     ```xml
     <!-- å…¨å±€é…ç½® -->
     <setting name="cacheEnabled" value="true"/>
     
     <!-- Mapperé…ç½® -->
     <cache 
       eviction="LRU" 
       flushInterval="60000" 
       size="512" 
       readOnly="false"/>
     ```

**Q: ä»€ä¹ˆæƒ…å†µä¸‹ä¸åº”ä½¿ç”¨äºŒçº§ç¼“å­˜ï¼Ÿ**

A: ä»¥ä¸‹æƒ…å†µä¸é€‚åˆä½¿ç”¨äºŒçº§ç¼“å­˜ï¼š

1. å†™æ“ä½œé¢‘ç¹çš„åœºæ™¯
2. å¤šè¡¨å…³è”æŸ¥è¯¢ï¼ˆå¯èƒ½å¯¼è‡´è„æ•°æ®ï¼‰
3. åˆ†å¸ƒå¼ç³»ç»Ÿï¼ˆç¼“å­˜ä¸ä¸€è‡´ï¼‰
4. éœ€è¦å®æ—¶æ•°æ®çš„åœºæ™¯
5. å¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚é«˜çš„ä¸šåŠ¡
6. è¡¨ä¹‹é—´å­˜åœ¨å¤æ‚å…³è”å…³ç³»

åœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œå»ºè®®ä½¿ç”¨Redisç­‰å¤–éƒ¨ç¼“å­˜ä»£æ›¿MyBatiså†…ç½®çš„äºŒçº§ç¼“å­˜ã€‚

**Q: MyBatisçš„ä¸€çº§ç¼“å­˜ä¸ºä»€ä¹ˆä¼šå‡ºç°è„è¯»ï¼Ÿå¦‚ä½•é¿å…ï¼Ÿ**

A: ä¸€çº§ç¼“å­˜å¯èƒ½å¯¼è‡´è„è¯»çš„åŸå› ï¼š

1. åŒä¸€SqlSessionå†…ï¼Œä¸¤æ¬¡æŸ¥è¯¢ä¹‹é—´æ•°æ®è¢«å…¶ä»–ä¼šè¯ä¿®æ”¹
2. ç¼“å­˜ä¸­çš„å¯¹è±¡è¢«ç¨‹åºä¿®æ”¹ï¼Œä½†æœªåŒæ­¥åˆ°æ•°æ®åº“

é¿å…ä¸€çº§ç¼“å­˜è„è¯»çš„æ–¹æ³•ï¼š

1. è°ƒæ•´ç¼“å­˜çº§åˆ«ä¸ºSTATEMENTï¼š
   ```xml
   <setting name="localCacheScope" value="STATEMENT"/>
   ```
2. å…³é”®æŸ¥è¯¢å‰æ¸…ç©ºç¼“å­˜ï¼š
   ```java
   sqlSession.clearCache();
   ```
3. é¿å…å…±äº«SqlSession
4. æ•æ„ŸæŸ¥è¯¢ä½¿ç”¨flushCache="true"ï¼š
   ```xml
   <select id="getUser" flushCache="true">
     SELECT * FROM user WHERE id = #{id}
   </select>
   ```

</TabItem>
<TabItem value="performance" label="æ€§èƒ½é—®é¢˜">

**Q: å¦‚ä½•ä¼˜åŒ–MyBatisçš„æ€§èƒ½ï¼Ÿ**

A: MyBatisæ€§èƒ½ä¼˜åŒ–ç­–ç•¥ï¼š

1. **åˆç†ä½¿ç”¨ç¼“å­˜**ï¼š
   - é…ç½®äºŒçº§ç¼“å­˜
   - ä½¿ç”¨è‡ªå®šä¹‰ç¼“å­˜å¦‚Redis
   - é¿å…é¢‘ç¹åˆ·æ–°ç¼“å­˜

2. **SQLä¼˜åŒ–**ï¼š
   - åªæŸ¥è¯¢å¿…è¦çš„åˆ—
   - æ·»åŠ åˆé€‚çš„ç´¢å¼•
   - é¿å…SELECT *
   - åˆ†é¡µæŸ¥è¯¢å¤§æ•°æ®é›†

3. **å»¶è¿ŸåŠ è½½**ï¼š
   ```xml
   <setting name="lazyLoadingEnabled" value="true"/>
   <setting name="aggressiveLazyLoading" value="false"/>
   ```

4. **æ‰¹é‡æ“ä½œ**ï¼š
   - ä½¿ç”¨æ‰¹å¤„ç†æ‰§è¡Œå™¨
     ```java
     SqlSession session = sqlSessionFactory.openSession(ExecutorType.BATCH);
     ```
   - ä½¿ç”¨æ‰¹é‡æ’å…¥
     ```xml
     <insert id="batchInsert">
       INSERT INTO table (col1, col2) VALUES 
       <foreach collection="list" item="item" separator=",">
         (#{item.col1}, #{item.col2})
       </foreach>
     </insert>
     ```

5. **ç»“æœé›†å¤„ç†**ï¼š
   - é™åˆ¶ç»“æœé›†å¤§å°
   - ä½¿ç”¨æµå¼æŸ¥è¯¢å¤„ç†å¤§ç»“æœé›†
   - åˆç†è®¾ç½®fetchSize

6. **é¿å…N+1é—®é¢˜**ï¼š
   - ä½¿ç”¨åµŒå¥—ç»“æœæ˜ å°„ä»£æ›¿åµŒå¥—æŸ¥è¯¢
   - ä½¿ç”¨JOINä»£æ›¿å¤šæ¬¡å•ç‹¬æŸ¥è¯¢

7. **ä½¿ç”¨æ’ä»¶**ï¼š
   - åˆ†é¡µæ’ä»¶å¦‚PageHelper
   - æ€§èƒ½ç›‘æ§æ’ä»¶

**Q: ä»€ä¹ˆæ˜¯MyBatisä¸­çš„N+1é—®é¢˜ï¼Ÿå¦‚ä½•è§£å†³ï¼Ÿ**

A: N+1é—®é¢˜æ˜¯æŒ‡ï¼š

æŸ¥è¯¢Næ¡ä¸»è®°å½•ï¼Œç„¶åé’ˆå¯¹æ¯æ¡ä¸»è®°å½•å†æŸ¥è¯¢å…³è”è®°å½•ï¼Œæ€»å…±äº§ç”ŸN+1æ¬¡æŸ¥è¯¢ã€‚

```java
// N+1é—®é¢˜ç¤ºä¾‹
List<User> users = userMapper.getAllUsers(); // 1æ¬¡æŸ¥è¯¢
for (User user : users) {
    List<Order> orders = orderMapper.getOrdersByUserId(user.getId()); // Næ¬¡æŸ¥è¯¢
    user.setOrders(orders);
}
```

è§£å†³N+1é—®é¢˜çš„æ–¹æ³•ï¼š

1. **ä½¿ç”¨åµŒå¥—ç»“æœæ˜ å°„**ï¼ˆæ¨èï¼‰ï¼š
   ```xml
   <select id="getUsersWithOrders" resultMap="userOrderMap">
     SELECT u.*, o.*
     FROM user u
     LEFT JOIN orders o ON u.id = o.user_id
   </select>
   
   <resultMap id="userOrderMap" type="User">
     <id property="id" column="id"/>
     <result property="name" column="name"/>
     <collection property="orders" ofType="Order">
       <id property="id" column="order_id"/>
       <result property="amount" column="amount"/>
     </collection>
   </resultMap>
   ```

2. **å»¶è¿ŸåŠ è½½**ï¼ˆé€‚ç”¨äºå…³è”æ•°æ®ä½¿ç”¨ç‡ä½çš„åœºæ™¯ï¼‰ï¼š
   ```xml
   <setting name="lazyLoadingEnabled" value="true"/>
   <setting name="aggressiveLazyLoading" value="false"/>
   
   <resultMap id="userMap" type="User">
     <id property="id" column="id"/>
     <result property="name" column="name"/>
     <collection property="orders" 
                 select="getOrdersByUserId" 
                 column="id" 
                 fetchType="lazy"/>
   </resultMap>
   ```

3. **æ‰¹é‡æŸ¥è¯¢**ï¼š
   ```java
   // å…ˆè·å–ç”¨æˆ·åˆ—è¡¨
   List<User> users = userMapper.getAllUsers();
   
   // æå–æ‰€æœ‰ç”¨æˆ·ID
   List<Long> userIds = users.stream()
                            .map(User::getId)
                            .collect(Collectors.toList());
   
   // ä¸€æ¬¡æŸ¥è¯¢æ‰€æœ‰è®¢å•
   List<Order> allOrders = orderMapper.getOrdersByUserIds(userIds);
   
   // æŒ‰ç”¨æˆ·IDåˆ†ç»„
   Map<Long, List<Order>> orderMap = allOrders.stream()
                                            .collect(Collectors.groupingBy(Order::getUserId));
   
   // è®¾ç½®è®¢å•åˆ°ç”¨æˆ·å¯¹è±¡
   users.forEach(user -> user.setOrders(
       orderMap.getOrDefault(user.getId(), Collections.emptyList())
   ));
   ```

</TabItem>
</Tabs>

### 10.4 æ’ä»¶ä¸æ‰©å±•é¢è¯•é¢˜

<Tabs>
<TabItem value="plugin" label="æ’ä»¶æœºåˆ¶">

**Q: MyBatisçš„æ’ä»¶æœºåˆ¶æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ**

A: MyBatisæ’ä»¶æœºåˆ¶åŸºäºæ‹¦æˆªå™¨æ¨¡å¼å’Œè´£ä»»é“¾æ¨¡å¼ï¼š

1. **åŸç†**ï¼šä½¿ç”¨JDKåŠ¨æ€ä»£ç†ï¼Œåœ¨å››å¤§æ ¸å¿ƒå¯¹è±¡çš„æ–¹æ³•è°ƒç”¨å‰åè¿›è¡Œæ‹¦æˆª
2. **æ‹¦æˆªç‚¹**ï¼š
   - Executorï¼šæ‰§è¡Œå™¨ï¼Œè´Ÿè´£SQLæ‰§è¡Œ
   - ParameterHandlerï¼šå‚æ•°å¤„ç†å™¨
   - ResultSetHandlerï¼šç»“æœé›†å¤„ç†å™¨
   - StatementHandlerï¼šè¯­å¥å¤„ç†å™¨

3. **å®ç°æ­¥éª¤**ï¼š
   - å®ç°Interceptoræ¥å£
   - ä½¿ç”¨@Interceptså’Œ@Signatureæ³¨è§£å®šä¹‰æ‹¦æˆªç‚¹
   - å®ç°interceptæ–¹æ³•å¤„ç†æ‹¦æˆªé€»è¾‘
   - åœ¨é…ç½®æ–‡ä»¶ä¸­æ³¨å†Œæ’ä»¶

4. **å·¥ä½œæµç¨‹**ï¼š
   - åœ¨MyBatisåˆå§‹åŒ–æ—¶ï¼Œè§£ææ’ä»¶é…ç½®
   - åˆ›å»ºæ‹¦æˆªå™¨é“¾InterceptorChain
   - å½“åˆ›å»ºå››å¤§æ ¸å¿ƒå¯¹è±¡æ—¶ï¼Œè°ƒç”¨InterceptorChain.pluginAll()åŒ…è£…å¯¹è±¡
   - æ‰§è¡Œç›®æ ‡æ–¹æ³•æ—¶ï¼ŒæŒ‰æ’ä»¶æ³¨å†Œé¡ºåºé€†åºæ‰§è¡Œæ‹¦æˆªå™¨

**Q: å¦‚ä½•å¼€å‘ä¸€ä¸ªè‡ªå®šä¹‰MyBatisæ’ä»¶ï¼Ÿ**

A: å¼€å‘è‡ªå®šä¹‰æ’ä»¶çš„æ­¥éª¤ï¼š

1. **å®šä¹‰æ’ä»¶ç±»**ï¼š
```java
@Intercepts({
    @Signature(
        type = Executor.class,
        method = "update",
        args = {MappedStatement.class, Object.class}
    ),
    @Signature(
        type = Executor.class,
        method = "query",
        args = {MappedStatement.class, Object.class, RowBounds.class, ResultHandler.class}
    )
})
public class ExamplePlugin implements Interceptor {
    
    private Properties properties;
    
    @Override
    public Object intercept(Invocation invocation) throws Throwable {
        // æ‰§è¡Œå‰å¤„ç†
        Object target = invocation.getTarget(); // è¢«ä»£ç†å¯¹è±¡
        Method method = invocation.getMethod(); // è¢«æ‹¦æˆªæ–¹æ³•
        Object[] args = invocation.getArgs();   // æ–¹æ³•å‚æ•°
        
        // æ‰§è¡ŒåŸæ–¹æ³•
        Object result = invocation.proceed();
        
        // æ‰§è¡Œåå¤„ç†
        
        return result;
    }
    
    @Override
    public Object plugin(Object target) {
        // åŒ…è£…ç›®æ ‡å¯¹è±¡
        return Plugin.wrap(target, this);
    }
    
    @Override
    public void setProperties(Properties properties) {
        // è®¾ç½®æ’ä»¶å±æ€§
        this.properties = properties;
    }
}
```

2. **æ³¨å†Œæ’ä»¶**ï¼š
```xml
<plugins>
  <plugin interceptor="com.example.plugin.ExamplePlugin">
    <property name="someProperty" value="100"/>
  </plugin>
</plugins>
```

**Q: ä¸ºä»€ä¹ˆMyBatisçš„æ’ä»¶åªèƒ½æ‹¦æˆªè¿™å››ç§æ¥å£ï¼Ÿ**

A: MyBatisåªå…è®¸æ‹¦æˆªè¿™å››ä¸ªæ¥å£æ˜¯åŸºäºä»¥ä¸‹è€ƒè™‘ï¼š

1. **æ¶æ„è®¾è®¡**ï¼šè¿™å››ä¸ªæ¥å£æ˜¯MyBatisæ‰§è¡ŒSQLçš„æ ¸å¿ƒç»„ä»¶ï¼Œè¦†ç›–äº†SQLæ‰§è¡Œçš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸ
2. **å®‰å…¨æ€§**ï¼šé™åˆ¶æ‹¦æˆªç‚¹å‡å°‘å¯¹æ ¸å¿ƒåŠŸèƒ½çš„å¹²æ‰°
3. **å¯æ§æ€§**ï¼šé¿å…è¿‡åº¦çš„æ‰©å±•å¯¼è‡´æ¡†æ¶è¡Œä¸ºä¸å¯é¢„æµ‹
4. **æ€§èƒ½è€ƒè™‘**ï¼šå‡å°‘ä»£ç†å±‚çº§ï¼Œé™ä½æ€§èƒ½å¼€é”€

è¿™å››ä¸ªæ¥å£è¶³ä»¥æ»¡è¶³å¤§å¤šæ•°æ‰©å±•éœ€æ±‚ï¼š
- Executorï¼šæ•´ä½“SQLæ‰§è¡Œè¿‡ç¨‹ï¼ˆç¼“å­˜ã€äº‹åŠ¡ç­‰ï¼‰
- StatementHandlerï¼šSQLè¯­å¥å¤„ç†ï¼ˆé¢„å¤„ç†ã€æ‰§è¡Œï¼‰
- ParameterHandlerï¼šå‚æ•°è®¾ç½®ï¼ˆç±»å‹è½¬æ¢ã€å‚æ•°æ˜ å°„ï¼‰
- ResultSetHandlerï¼šç»“æœé›†å¤„ç†ï¼ˆç»“æœæ˜ å°„ã€å¯¹è±¡åˆ›å»ºï¼‰

å¦‚éœ€æ›´æ·±å±‚æ¬¡çš„å®šåˆ¶ï¼Œå¯ä»¥é€šè¿‡ç»§æ‰¿æˆ–ä¿®æ”¹MyBatisæºç å®ç°ã€‚

</TabItem>
<TabItem value="extensions" label="å¸¸ç”¨æ‰©å±•">

**Q: å¸¸ç”¨çš„MyBatisæ‰©å±•æœ‰å“ªäº›ï¼Ÿ**

A: å¸¸ç”¨çš„MyBatisæ‰©å±•ï¼š

1. **MyBatis-Plus**ï¼š
   - å¢å¼ºçš„CRUDæ“ä½œ
   - æ¡ä»¶æ„é€ å™¨
   - åˆ†é¡µæ’ä»¶
   - ä»£ç ç”Ÿæˆå™¨
   - ä¹è§‚é”æ’ä»¶
   - å­—æ®µè‡ªåŠ¨å¡«å……

2. **PageHelper**ï¼š
   - å¼ºå¤§çš„åˆ†é¡µæ’ä»¶
   - å¤šæ•°æ®åº“æ”¯æŒ
   - ç®€å•çš„API
   - çµæ´»çš„åˆ†é¡µå‚æ•°

3. **é€šç”¨Mapper**ï¼š
   - é€šç”¨çš„CRUDæ–¹æ³•
   - ExampleæŸ¥è¯¢æ¡ä»¶
   - æ‰¹é‡æ“ä½œæ”¯æŒ
   - çµæ´»çš„æ¡ä»¶æŸ¥è¯¢

4. **MyBatis-Spring**ï¼š
   - é›†æˆSpringäº‹åŠ¡ç®¡ç†
   - è‡ªåŠ¨Mapperæ‰«æ
   - SqlSessionç®¡ç†
   - ä¾èµ–æ³¨å…¥æ”¯æŒ

5. **MyBatis-Dynamic-SQL**ï¼š
   - ç±»å‹å®‰å…¨çš„SQLæ„å»º
   - åŠ¨æ€æ¡ä»¶æ”¯æŒ
   - é¿å…ç¡¬ç¼–ç SQL

**Q: åˆ†é¡µæ’ä»¶PageHelperçš„å·¥ä½œåŸç†æ˜¯ä»€ä¹ˆï¼Ÿ**

A: PageHelperåˆ†é¡µæ’ä»¶çš„å·¥ä½œåŸç†ï¼š

1. **æ‹¦æˆªæ‰§è¡Œå™¨**ï¼šæ‹¦æˆªExecutorçš„queryæ–¹æ³•
2. **è·å–åˆ†é¡µå‚æ•°**ï¼šä»ThreadLocalä¸­è·å–Pageå¯¹è±¡
3. **è§£æåŸSQL**ï¼šä½¿ç”¨JSqlParserè§£æSQL
4. **æ„é€ åˆ†é¡µSQL**ï¼šæ ¹æ®æ•°æ®åº“ç±»å‹æ·»åŠ åˆ†é¡µè¯­æ³•
5. **æ‰§è¡Œåˆ†é¡µæŸ¥è¯¢**ï¼šå…ˆæ‰§è¡ŒcountæŸ¥è¯¢è·å–æ€»æ•°ï¼Œå†æ‰§è¡Œåˆ†é¡µæŸ¥è¯¢
6. **è®¾ç½®åˆ†é¡µç»“æœ**ï¼šå°†åˆ†é¡µä¿¡æ¯è®¾ç½®åˆ°Pageå¯¹è±¡

å·¥ä½œæµç¨‹ç¤ºæ„ï¼š
```
è°ƒç”¨PageHelper.startPage() â†’ åˆ›å»ºPageå¯¹è±¡å¹¶å­˜å…¥ThreadLocal â†’
æ‰§è¡ŒæŸ¥è¯¢æ–¹æ³• â†’ æ’ä»¶æ‹¦æˆª â†’ æ„å»ºåˆ†é¡µSQL â†’ 
æ‰§è¡ŒcountæŸ¥è¯¢ â†’ æ‰§è¡Œåˆ†é¡µæŸ¥è¯¢ â†’ è¿”å›ç»“æœ â†’
æ¸…é™¤ThreadLocal
```

**Q: å¦‚ä½•å®ç°è‡ªå®šä¹‰çš„ç»“æœé›†å¤„ç†ï¼Ÿ**

A: è‡ªå®šä¹‰ç»“æœé›†å¤„ç†æœ‰ä»¥ä¸‹æ–¹å¼ï¼š

1. **è‡ªå®šä¹‰TypeHandler**ï¼š
```java
public class JsonTypeHandler<T> extends BaseTypeHandler<T> {
    private Class<T> clazz;
    private ObjectMapper objectMapper = new ObjectMapper();
    
    public JsonTypeHandler(Class<T> clazz) {
        this.clazz = clazz;
    }
    
    @Override
    public void setNonNullParameter(PreparedStatement ps, int i, T parameter, JdbcType jdbcType) throws SQLException {
        // å®ç°å‚æ•°è®¾ç½®é€»è¾‘
    }
    
    @Override
    public T getNullableResult(ResultSet rs, String columnName) throws SQLException {
        // å®ç°ç»“æœè·å–é€»è¾‘
    }
    
    // å…¶ä»–æ–¹æ³•å®ç°...
}

// æ³¨å†ŒTypeHandler
<typeHandlers>
  <typeHandler handler="com.example.JsonTypeHandler" javaType="com.example.Config" jdbcType="VARCHAR"/>
</typeHandlers>
```

2. **è‡ªå®šä¹‰ResultHandler**ï¼š
```java
public class CustomResultHandler implements ResultHandler<User> {
    private List<User> users = new ArrayList<>();
    
    @Override
    public void handleResult(ResultContext<? extends User> resultContext) {
        User user = resultContext.getResultObject();
        // è‡ªå®šä¹‰å¤„ç†é€»è¾‘
        users.add(user);
        
        // å¯ä»¥æå‰åœæ­¢ç»“æœé›†å¤„ç†
        if (users.size() >= 100) {
            resultContext.stop();
        }
    }
    
    public List<User> getUsers() {
        return users;
    }
}

// ä½¿ç”¨è‡ªå®šä¹‰ResultHandler
CustomResultHandler handler = new CustomResultHandler();
sqlSession.select("getUserList", params, handler);
List<User> users = handler.getUsers();
```

3. **æ‹¦æˆªResultSetHandler**ï¼š
```java
@Intercepts({
    @Signature(
        type = ResultSetHandler.class,
        method = "handleResultSets",
        args = {Statement.class}
    )
})
public class ResultSetInterceptor implements Interceptor {
    @Override
    public Object intercept(Invocation invocation) throws Throwable {
        // æ‹¦æˆªç»“æœé›†å¤„ç†è¿‡ç¨‹
        Statement stmt = (Statement) invocation.getArgs()[0];
        
        // æ‰§è¡ŒåŸæ–¹æ³•
        Object result = invocation.proceed();
        
        // å¤„ç†ç»“æœ
        if (result instanceof List) {
            List<?> list = (List<?>) result;
            // å¯¹ç»“æœè¿›è¡Œåå¤„ç†
        }
        
        return result;
    }
    
    // å…¶ä»–æ–¹æ³•å®ç°...
}
```

</TabItem>
</Tabs>

:::tip é¢è¯•æŠ€å·§
1. **ç†è§£åŸç†**ï¼šæ·±å…¥ç†è§£MyBatisçš„æ ¸å¿ƒåŸç†å’Œæ‰§è¡Œæµç¨‹
2. **å¯¹æ¯”æ¡†æ¶**ï¼šäº†è§£MyBatisä¸å…¶ä»–ORMæ¡†æ¶çš„åŒºåˆ«å’Œé€‚ç”¨åœºæ™¯
3. **æ€§èƒ½ä¼˜åŒ–**ï¼šæŒæ¡å¸¸è§çš„æ€§èƒ½é—®é¢˜å’Œä¼˜åŒ–æ–¹æ³•
4. **å®è·µæ¡ˆä¾‹**ï¼šå‡†å¤‡å®é™…é¡¹ç›®ä¸­çš„ä½¿ç”¨æ¡ˆä¾‹å’Œé—®é¢˜è§£å†³æ–¹æ¡ˆ
5. **æºç åˆ†æ**ï¼šå¯¹å…³é”®ç»„ä»¶çš„æºç æœ‰åŸºæœ¬äº†è§£
6. **æ‰©å±•æœºåˆ¶**ï¼šç†Ÿæ‚‰æ’ä»¶æœºåˆ¶å’Œå¸¸ç”¨æ‰©å±•
:::