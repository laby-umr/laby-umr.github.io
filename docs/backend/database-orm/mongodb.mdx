---
sidebar_position: 6
title: MongoDBè¯¦è§£
description: æ·±å…¥ç†è§£MongoDBæ ¸å¿ƒç‰¹æ€§ã€æ¶æ„è®¾è®¡ä¸Spring Booté›†æˆ
authors: [Laby]
tags: [MongoDB, NoSQL, æ–‡æ¡£æ•°æ®åº“, åˆ†å¸ƒå¼æ•°æ®åº“, Spring Data]
last_update:
  date: 2025-09-02
  author: Laby
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import CodeBlock from '@theme/CodeBlock';

# MongoDBè¯¦è§£

MongoDBæ˜¯ä¸€æ¬¾é¢†å…ˆçš„å¼€æºNoSQLæ–‡æ¡£æ•°æ®åº“ï¼Œä»¥å…¶çµæ´»çš„æ–‡æ¡£æ¨¡å‹ã€å¼ºå¤§çš„æŸ¥è¯¢åŠŸèƒ½å’Œå“è¶Šçš„å¯æ‰©å±•æ€§è‘—ç§°ã€‚ä½œä¸ºç°ä»£åº”ç”¨å¼€å‘çš„ä¼˜é€‰æ•°æ®å­˜å‚¨æ–¹æ¡ˆï¼ŒMongoDBèƒ½å¤Ÿè½»æ¾å¤„ç†æµ·é‡æ•°æ®å¹¶æ”¯æŒåˆ†å¸ƒå¼æ¶æ„ï¼Œé€‚åˆæ•æ·å¼€å‘å’Œå¾®æœåŠ¡ä½“ç³»ç»“æ„ã€‚

:::tip æ ¸å¿ƒä»·å€¼
**MongoDB = æ–‡æ¡£æ¨¡å‹ + çµæ´»æ‰©å±• + é«˜å¯ç”¨æ€§ + ä¸°å¯Œçš„æŸ¥è¯¢è¯­è¨€**
- ğŸ“„ **æ–‡æ¡£æ•°æ®æ¨¡å‹**ï¼šçµæ´»çš„JSON(BSON)æ ¼å¼ï¼Œæ— éœ€é¢„å®šä¹‰æ¨¡å¼
- ğŸš€ **é«˜æ€§èƒ½**ï¼šå†…å­˜æ˜ å°„å­˜å‚¨å¼•æ“ã€ç´¢å¼•æ”¯æŒã€èšåˆæ¡†æ¶
- ğŸ”„ **æ¨ªå‘æ‰©å±•**ï¼šåŸç”Ÿåˆ†ç‰‡æ”¯æŒï¼Œè½»æ¾å®ç°æ•°æ®åº“é›†ç¾¤
- ğŸ’¼ **ä¼ä¸šçº§åŠŸèƒ½**ï¼šå¤åˆ¶é›†ã€äº‹åŠ¡æ”¯æŒã€å®‰å…¨è®¤è¯
- ğŸ” **å¼ºå¤§çš„æŸ¥è¯¢**ï¼šä¸°å¯Œçš„æŸ¥è¯¢è¯­è¨€å’Œèšåˆç®¡é“
:::

æœ¬æ–‡å°†æ·±å…¥æ¢è®¨MongoDBçš„æ ¸å¿ƒæ¦‚å¿µã€é«˜çº§ç‰¹æ€§åŠå…¶åœ¨Spring Bootåº”ç”¨ä¸­çš„æœ€ä½³å®è·µï¼Œå¸®åŠ©å¼€å‘è€…æ„å»ºé«˜æ€§èƒ½ã€å¯é çš„ç°ä»£åº”ç”¨ç¨‹åºã€‚

## 1. MongoDBåŸºç¡€ä¸æ ¸å¿ƒæ¦‚å¿µ

MongoDBä»¥å…¶çµæ´»æ€§å’Œå¯æ‰©å±•æ€§æ”¹å˜äº†ä¼ ç»Ÿçš„æ•°æ®å­˜å‚¨æ€ç»´æ–¹å¼ï¼Œæ‘’å¼ƒäº†å…³ç³»å‹æ•°æ®åº“çš„è¡¨ç»“æ„è®¾è®¡ï¼Œè½¬è€Œé‡‡ç”¨æ–‡æ¡£æ¨¡å‹ã€‚æ·±å…¥ç†è§£å…¶åŸºæœ¬æ¦‚å¿µæ˜¯é«˜æ•ˆä½¿ç”¨MongoDBçš„å‰æã€‚

### 1.1 MongoDBæ¶æ„æ¦‚è§ˆ

MongoDBçš„æ•´ä½“æ¶æ„ç”±ä»¥ä¸‹æ ¸å¿ƒç»„ä»¶æ„æˆï¼š

![MongoDBæ¶æ„](https://www.mongodb.com/assets/images/resource-center/icons/icon-architecture-300x163.png)

1. **MongoDBæœåŠ¡å™¨**ï¼šæ ¸å¿ƒæ•°æ®åº“æœåŠ¡
2. **å­˜å‚¨å¼•æ“**ï¼šè´Ÿè´£æ•°æ®æŒä¹…åŒ–ï¼Œé»˜è®¤ä¸ºWiredTiger
3. **å¤åˆ¶é›†**ï¼šæä¾›æ•°æ®å†—ä½™å’Œé«˜å¯ç”¨æ€§
4. **åˆ†ç‰‡é›†ç¾¤**ï¼šå®ç°æ°´å¹³æ‰©å±•ï¼Œå¤„ç†å¤§æ•°æ®é‡
5. **MongoDBå®¢æˆ·ç«¯**ï¼šåº”ç”¨ç¨‹åºé€šè¿‡é©±åŠ¨ç¨‹åºè¿æ¥æ•°æ®åº“

#### 1.1.1 åŸºæœ¬æœ¯è¯­å¯¹æ¯”

MongoDBä¸å…³ç³»å‹æ•°æ®åº“åœ¨æ¦‚å¿µä¸Šæœ‰è®¸å¤šå¯¹åº”å…³ç³»ï¼š

| å…³ç³»å‹æ•°æ®åº“ | MongoDB |
|------------|---------|
| æ•°æ®åº“(Database) | æ•°æ®åº“(Database) |
| è¡¨(Table) | é›†åˆ(Collection) |
| è¡Œ(Row) | æ–‡æ¡£(Document) |
| åˆ—(Column) | å­—æ®µ(Field) |
| ä¸»é”®(Primary Key) | ObjectId(_id) |
| ç´¢å¼•(Index) | ç´¢å¼•(Index) |
| è¿æ¥(Join) | å¼•ç”¨æˆ–åµŒå…¥ |
| è§†å›¾(View) | è§†å›¾(View) |

### 1.2 æ–‡æ¡£æ¨¡å‹è¯¦è§£

MongoDBçš„æ ¸å¿ƒæ˜¯æ–‡æ¡£æ¨¡å‹ï¼Œå®ƒä»¥BSON(Binary JSON)æ ¼å¼å­˜å‚¨æ•°æ®ã€‚

#### 1.2.1 BSONæ ¼å¼

BSONæ‰©å±•äº†JSONæ ¼å¼ï¼Œå¢åŠ äº†é¢å¤–çš„æ•°æ®ç±»å‹æ”¯æŒï¼ˆå¦‚æ—¥æœŸã€äºŒè¿›åˆ¶æ•°æ®ã€æ­£åˆ™è¡¨è¾¾å¼ç­‰ï¼‰ï¼š

```javascript
{
  "_id": ObjectId("507f1f77bcf86cd799439011"),
  "name": "å¼ ä¸‰",
  "age": 30,
  "email": "zhangsan@example.com",
  "created_at": ISODate("2023-01-15T09:30:00Z"),
  "tags": ["vip", "active"],
  "address": {
    "city": "åŒ—äº¬",
    "street": "ä¸­å…³æ‘å¤§è¡—",
    "zip": "100080"
  },
  "orders": [
    { "product": "æ‰‹æœº", "price": 4999 },
    { "product": "è€³æœº", "price": 999 }
  ]
}
```

#### 1.2.2 æ–‡æ¡£å¤§å°é™åˆ¶

- å•ä¸ªæ–‡æ¡£æœ€å¤§ä¸è¶…è¿‡16MB
- å¯¹äºå¤§å‹æ–‡æ¡£ï¼Œå¯ä»¥ä½¿ç”¨GridFSå­˜å‚¨

#### 1.2.3 _idå­—æ®µ

æ¯ä¸ªæ–‡æ¡£å¿…é¡»æœ‰ä¸€ä¸ª`_id`å­—æ®µä½œä¸ºä¸»é”®ï¼š
- é»˜è®¤ä¸ºObjectIdç±»å‹ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
- å¯è‡ªå®šä¹‰ä¸ºä»»ä½•å”¯ä¸€å€¼
- ä¸å¯å˜ä¸”å¿…é¡»å”¯ä¸€

### 1.3 æ•°æ®åº“æ“ä½œåŸºç¡€

#### 1.3.1 åˆ›å»ºæ•°æ®åº“å’Œé›†åˆ

```javascript
// åˆ‡æ¢åˆ°æŒ‡å®šæ•°æ®åº“ï¼ˆä¸å­˜åœ¨åˆ™éšå¼åˆ›å»ºï¼‰
use mydb

// åˆ›å»ºé›†åˆï¼ˆæ˜¾å¼åˆ›å»ºï¼Œå¯æŒ‡å®šé€‰é¡¹ï¼‰
db.createCollection("users", {
  validator: {
    $jsonSchema: {
      bsonType: "object",
      required: ["name", "email"],
      properties: {
        name: { bsonType: "string" },
        email: { bsonType: "string", pattern: "^.+@.+$" }
      }
    }
  }
})

// éšå¼åˆ›å»ºé›†åˆï¼ˆæ’å…¥æ–‡æ¡£æ—¶è‡ªåŠ¨åˆ›å»ºï¼‰
db.products.insertOne({
  name: "æ™ºèƒ½æ‰‹æœº",
  price: 4999,
  stock: 200
})
```

#### 1.3.2 åŸºæœ¬CRUDæ“ä½œ

```javascript
// æ’å…¥æ–‡æ¡£
db.users.insertOne({
  name: "æå››",
  age: 28,
  email: "lisi@example.com"
})

// æ‰¹é‡æ’å…¥
db.users.insertMany([
  { name: "ç‹äº”", age: 35, email: "wangwu@example.com" },
  { name: "èµµå…­", age: 42, email: "zhaoliu@example.com" }
])

// æŸ¥è¯¢æ–‡æ¡£
db.users.find({ age: { $gt: 30 } })

// æ›´æ–°æ–‡æ¡£
db.users.updateOne(
  { name: "æå››" },
  { $set: { age: 29 }, $currentDate: { lastModified: true } }
)

// åˆ é™¤æ–‡æ¡£
db.users.deleteOne({ name: "èµµå…­" })
```

#### 1.3.3 æŸ¥è¯¢æ“ä½œç¬¦

MongoDBæä¾›ä¸°å¯Œçš„æŸ¥è¯¢æ“ä½œç¬¦ï¼š

```javascript
// æ¯”è¾ƒæ“ä½œç¬¦
db.products.find({ price: { $lt: 1000 } })  // å°äº
db.products.find({ price: { $gt: 1000, $lt: 5000 } })  // åŒºé—´æŸ¥è¯¢

// é€»è¾‘æ“ä½œç¬¦
db.users.find({ $or: [{ age: { $lt: 25 } }, { age: { $gt: 50 } }] })

// å…ƒç´ æ“ä½œç¬¦
db.users.find({ age: { $exists: true } })  // å­˜åœ¨å­—æ®µ
db.users.find({ score: { $type: "number" } })  // ç±»å‹åŒ¹é…

// æ•°ç»„æ“ä½œç¬¦
db.posts.find({ tags: { $all: ["mongodb", "nosql"] } })  // åŒ…å«æ‰€æœ‰æŒ‡å®šå…ƒç´ 
db.posts.find({ tags: { $size: 3 } })  // æ•°ç»„é•¿åº¦åŒ¹é…
```

### 1.4 ç´¢å¼•ä¸æ€§èƒ½

#### 1.4.1 ç´¢å¼•ç±»å‹

MongoDBæ”¯æŒå¤šç§ç´¢å¼•ç±»å‹ï¼š

```javascript
// å•å­—æ®µç´¢å¼•
db.users.createIndex({ email: 1 })  // 1è¡¨ç¤ºå‡åºï¼Œ-1è¡¨ç¤ºé™åº

// å¤åˆç´¢å¼•
db.products.createIndex({ category: 1, price: -1 })

// å¤šé”®ç´¢å¼•ï¼ˆæ•°ç»„å­—æ®µï¼‰
db.posts.createIndex({ tags: 1 })

// åœ°ç†ç©ºé—´ç´¢å¼•
db.places.createIndex({ location: "2dsphere" })

// æ–‡æœ¬ç´¢å¼•ï¼ˆå…¨æ–‡æœç´¢ï¼‰
db.articles.createIndex({ title: "text", content: "text" })

// å“ˆå¸Œç´¢å¼•
db.users.createIndex({ username: "hashed" })
```

#### 1.4.2 ç´¢å¼•å±æ€§

ç´¢å¼•å¯ä»¥é…ç½®å¤šç§å±æ€§ï¼š

```javascript
// å”¯ä¸€ç´¢å¼•
db.users.createIndex({ email: 1 }, { unique: true })

// ç¨€ç–ç´¢å¼•ï¼ˆåªç´¢å¼•åŒ…å«è¯¥å­—æ®µçš„æ–‡æ¡£ï¼‰
db.users.createIndex({ mobile: 1 }, { sparse: true })

// TTLç´¢å¼•ï¼ˆè‡ªåŠ¨è¿‡æœŸï¼‰
db.sessions.createIndex(
  { lastActive: 1 },
  { expireAfterSeconds: 3600 }  // ä¸€å°æ—¶åè¿‡æœŸ
)

// éƒ¨åˆ†ç´¢å¼•ï¼ˆæ¡ä»¶ç´¢å¼•ï¼‰
db.products.createIndex(
  { price: 1 },
  { partialFilterExpression: { quantity: { $gt: 0 } } }
)
```

#### 1.4.3 æŸ¥çœ‹å’Œç®¡ç†ç´¢å¼•

```javascript
// æŸ¥çœ‹é›†åˆçš„æ‰€æœ‰ç´¢å¼•
db.users.getIndexes()

// åˆ é™¤ç‰¹å®šç´¢å¼•
db.users.dropIndex("email_1")

// åˆ é™¤æ‰€æœ‰ç´¢å¼•ï¼ˆé™¤_idå¤–ï¼‰
db.users.dropIndexes()
```

### 1.5 èšåˆæ¡†æ¶

MongoDBçš„èšåˆæ¡†æ¶æä¾›å¼ºå¤§çš„æ•°æ®å¤„ç†èƒ½åŠ›ï¼Œå¯è¿›è¡Œå¤æ‚çš„åˆ†ç»„ã€è¿‡æ»¤å’Œè½¬æ¢æ“ä½œã€‚

#### 1.5.1 åŸºæœ¬èšåˆç®¡é“

```javascript
db.orders.aggregate([
  // ç­›é€‰é˜¶æ®µ
  { $match: { status: "completed" } },
  
  // åˆ†ç»„é˜¶æ®µ
  { $group: {
      _id: "$customer_id",
      totalAmount: { $sum: "$amount" },
      count: { $sum: 1 }
  }},
  
  // æ’åºé˜¶æ®µ
  { $sort: { totalAmount: -1 } },
  
  // é™åˆ¶é˜¶æ®µ
  { $limit: 10 }
])
```

#### 1.5.2 å¸¸ç”¨èšåˆæ“ä½œç¬¦

```javascript
// æŠ•å½±æ“ä½œç¬¦
db.users.aggregate([
  { $project: {
      _id: 0,
      name: 1,
      firstLetter: { $substr: ["$name", 0, 1] }
  }}
])

// å±•å¼€æ•°ç»„
db.products.aggregate([
  { $unwind: "$categories" }
])

// æŸ¥æ‰¾æ“ä½œï¼ˆç±»ä¼¼å…³ç³»å‹æ•°æ®åº“çš„JOINï¼‰
db.orders.aggregate([
  { $lookup: {
      from: "users",
      localField: "user_id",
      foreignField: "_id",
      as: "user_info"
  }}
])
```

#### 1.5.3 èšåˆè¡¨è¾¾å¼

```javascript
// æ¡ä»¶è¡¨è¾¾å¼
db.products.aggregate([
  { $project: {
      name: 1,
      price: 1,
      priceCategory: {
        $switch: {
          branches: [
            { case: { $lt: ["$price", 100] }, then: "ä¾¿å®œ" },
            { case: { $lt: ["$price", 500] }, then: "é€‚ä¸­" }
          ],
          default: "æ˜‚è´µ"
        }
      }
  }}
])

// æ—¥æœŸæ“ä½œ
db.orders.aggregate([
  { $project: {
      year: { $year: "$created_at" },
      month: { $month: "$created_at" },
      day: { $dayOfMonth: "$created_at" }
  }}
])
```

## 2. MongoDBé«˜çº§æ•°æ®å»ºæ¨¡

MongoDBçš„æ–‡æ¡£æ¨¡å‹æä¾›äº†æå¤§çš„è®¾è®¡çµæ´»æ€§ï¼Œä½†ä¼˜ç§€çš„æ•°æ®æ¨¡å‹è®¾è®¡å¯¹æ€§èƒ½å’Œå¯ç»´æŠ¤æ€§è‡³å…³é‡è¦ã€‚

### 2.1 æ•°æ®å»ºæ¨¡ç­–ç•¥

#### 2.1.1 åµŒå…¥å¼æ–‡æ¡£ vs. å¼•ç”¨å…³ç³»

MongoDBæä¾›ä¸¤ç§ä¸»è¦çš„å…³ç³»å¤„ç†æ–¹å¼ï¼š

**åµŒå…¥å¼æ–‡æ¡£ï¼ˆåè§„èŒƒåŒ–ï¼‰**ï¼š
```javascript
// åµŒå…¥å¼æ–‡æ¡£ç¤ºä¾‹ - ç”¨æˆ·åŠå…¶åœ°å€
{
  "_id": ObjectId("..."),
  "name": "å¼ ä¸‰",
  "email": "zhangsan@example.com",
  "addresses": [
    {
      "type": "home",
      "street": "ä¸­å…³æ‘å¤§è¡—1å·",
      "city": "åŒ—äº¬",
      "zip": "100080"
    },
    {
      "type": "work",
      "street": "é‡‘èå¤§è¡—2å·",
      "city": "åŒ—äº¬",
      "zip": "100033"
    }
  ]
}
```

**å¼•ç”¨å…³ç³»ï¼ˆè§„èŒƒåŒ–ï¼‰**ï¼š
```javascript
// ç”¨æˆ·é›†åˆ
{
  "_id": ObjectId("user1"),
  "name": "å¼ ä¸‰",
  "email": "zhangsan@example.com"
}

// åœ°å€é›†åˆ
{
  "_id": ObjectId("addr1"),
  "user_id": ObjectId("user1"),
  "type": "home",
  "street": "ä¸­å…³æ‘å¤§è¡—1å·",
  "city": "åŒ—äº¬",
  "zip": "100080"
}
{
  "_id": ObjectId("addr2"),
  "user_id": ObjectId("user1"),
  "type": "work",
  "street": "é‡‘èå¤§è¡—2å·",
  "city": "åŒ—äº¬",
  "zip": "100033"
}
```

**é€‰æ‹©æ ‡å‡†**ï¼š
- åµŒå…¥å¼é€‚ç”¨äºï¼š
  - ä¸€å¯¹ä¸€æˆ–ä¸€å¯¹å°‘é‡å…³ç³»
  - å­æ–‡æ¡£æ˜¯ä¸»æ–‡æ¡£çš„ç»„æˆéƒ¨åˆ†
  - å­æ–‡æ¡£ä¸å•ç‹¬è®¿é—®
  - æ–‡æ¡£æ€»å¤§å°åœ¨16MBä»¥å†…

- å¼•ç”¨é€‚ç”¨äºï¼š
  - ä¸€å¯¹å¤šæˆ–å¤šå¯¹å¤šå…³ç³»
  - å­æ•°æ®éœ€è¦å•ç‹¬æŸ¥è¯¢
  - æ–‡æ¡£é¢‘ç¹å˜åŒ–
  - æ–‡æ¡£å¤§å°æ¥è¿‘æˆ–è¶…è¿‡16MBé™åˆ¶

#### 2.1.2 æ¨¡å¼è®¾è®¡æ¨¡å¼

**ç›®å½•æ¨¡å¼**ï¼šé€‚ç”¨äºäº§å“ç›®å½•ç­‰å±‚æ¬¡ç»“æ„
```javascript
// äº§å“ç›®å½•ç»“æ„
{
  "_id": ObjectId("..."),
  "name": "ç”µå­äº§å“",
  "path": ",ç”µå­äº§å“,",
  "parent_id": null,
  "level": 1
}

{
  "_id": ObjectId("..."),
  "name": "æ‰‹æœº",
  "path": ",ç”µå­äº§å“,æ‰‹æœº,",
  "parent_id": ObjectId("..."),
  "level": 2
}
```

**å¤šæ€æ¨¡å¼**ï¼šé€‚ç”¨äºå­˜å‚¨ç›¸ä¼¼ä½†ä¸å®Œå…¨ç›¸åŒçš„æ•°æ®
```javascript
{
  "_id": ObjectId("..."),
  "type": "book",
  "title": "MongoDBå®æˆ˜",
  "author": "å¼ ä¸‰",
  "isbn": "978-1-4842-1182-3"
}

{
  "_id": ObjectId("..."),
  "type": "movie",
  "title": "æ˜Ÿé™…ç©¿è¶Š",
  "director": "å…‹é‡Œæ–¯æ‰˜å¼—Â·è¯ºå…°",
  "duration": 169
}
```

**ç‰ˆæœ¬æ§åˆ¶æ¨¡å¼**ï¼šè¿½è¸ªæ–‡æ¡£å†å²å˜æ›´
```javascript
// å½“å‰ç‰ˆæœ¬
{
  "_id": ObjectId("..."),
  "title": "MongoDBæŒ‡å—",
  "content": "æœ€æ–°å†…å®¹...",
  "version": 3,
  "is_current": true
}

// å†å²ç‰ˆæœ¬
{
  "_id": ObjectId("..."),
  "title": "MongoDBå…¥é—¨",
  "content": "æ—§ç‰ˆå†…å®¹...",
  "version": 2,
  "is_current": false,
  "current_id": ObjectId("...") // æŒ‡å‘å½“å‰ç‰ˆæœ¬
}
```

### 2.2 å¤æ‚å…³ç³»å»ºæ¨¡ç¤ºä¾‹

#### 2.2.1 ç”µå­å•†åŠ¡ç³»ç»Ÿå»ºæ¨¡

ç”µå­å•†åŠ¡ç³»ç»ŸåŒ…å«ç”¨æˆ·ã€äº§å“ã€è®¢å•ç­‰æ ¸å¿ƒå¯¹è±¡ï¼Œå…³ç³»è¾ƒä¸ºå¤æ‚ã€‚

**ç”¨æˆ·é›†åˆ**ï¼š
```javascript
{
  "_id": ObjectId("user1"),
  "name": "ç‹å°æ˜",
  "email": "wang@example.com",
  "shipping_addresses": [
    {
      "address_id": "addr1",
      "street": "ä¸­å…³æ‘å¤§è¡—1å·",
      "city": "åŒ—äº¬",
      "is_default": true
    }
  ],
  "payment_methods": [
    {
      "type": "credit_card",
      "last4": "1234",
      "expires": "04/25",
      "is_default": true
    }
  ]
}
```

**äº§å“é›†åˆ**ï¼š
```javascript
{
  "_id": ObjectId("prod1"),
  "name": "iPhone 13",
  "description": "Appleæœ€æ–°æ™ºèƒ½æ‰‹æœº",
  "price": 5999,
  "stock": 100,
  "category": "æ‰‹æœº",
  "attributes": {
    "color": ["é»‘è‰²", "ç™½è‰²", "è“è‰²"],
    "storage": ["128GB", "256GB", "512GB"]
  },
  "images": [
    "iphone13_main.jpg",
    "iphone13_back.jpg"
  ],
  "ratings": {
    "average": 4.8,
    "count": 245
  }
}
```

**è®¢å•é›†åˆ**ï¼š
```javascript
{
  "_id": ObjectId("order1"),
  "user_id": ObjectId("user1"),
  "status": "shipped",
  "created_at": ISODate("2023-06-15T10:30:00Z"),
  "shipping_address": {
    "street": "ä¸­å…³æ‘å¤§è¡—1å·",
    "city": "åŒ—äº¬"
  },
  "payment": {
    "method": "credit_card",
    "last4": "1234",
    "amount": 6598,
    "status": "paid"
  },
  "items": [
    {
      "product_id": ObjectId("prod1"),
      "name": "iPhone 13",
      "price": 5999,
      "quantity": 1,
      "attributes": {
        "color": "é»‘è‰²",
        "storage": "128GB"
      }
    },
    {
      "product_id": ObjectId("prod2"),
      "name": "æ‰‹æœºä¿æŠ¤å£³",
      "price": 599,
      "quantity": 1
    }
  ],
  "shipping": {
    "method": "express",
    "fee": 0,
    "tracking_number": "SF1234567890"
  },
  "total": 6598
}
```

**è¯„è®ºé›†åˆ**ï¼š
```javascript
{
  "_id": ObjectId("review1"),
  "product_id": ObjectId("prod1"),
  "user_id": ObjectId("user1"),
  "user_name": "ç‹å°æ˜", // å†—ä½™å­˜å‚¨
  "rating": 5,
  "title": "éå¸¸å¥½ç”¨çš„æ‰‹æœº",
  "content": "å±å¹•æ¸…æ™°ï¼Œæ€§èƒ½å¼ºåŠ²...",
  "created_at": ISODate("2023-06-20T14:25:00Z"),
  "helpful_votes": 12
}
```

#### 2.2.2 ç¤¾äº¤ç½‘ç»œå»ºæ¨¡

ç¤¾äº¤ç½‘ç»œåŒ…å«ç”¨æˆ·ã€å…³ç³»ç½‘ç»œã€å¸–å­å’Œäº’åŠ¨ç­‰å…ƒç´ ã€‚

**ç”¨æˆ·é›†åˆ**ï¼š
```javascript
{
  "_id": ObjectId("user1"),
  "username": "zhang_san",
  "name": "å¼ ä¸‰",
  "email": "zhangsan@example.com",
  "profile": {
    "avatar": "zhang_san.jpg",
    "bio": "çƒ­çˆ±æŠ€æœ¯ä¸åˆ›æ–°",
    "location": "åŒ—äº¬"
  },
  "stats": {
    "followers_count": 1250,
    "following_count": 350,
    "posts_count": 142
  },
  "preferences": {
    "privacy": "public",
    "notifications": {
      "likes": true,
      "comments": true,
      "follows": true
    }
  },
  "created_at": ISODate("2020-01-15")
}
```

**å…³ç³»é›†åˆ**ï¼š
```javascript
{
  "_id": ObjectId("..."),
  "follower": ObjectId("user2"),
  "following": ObjectId("user1"),
  "status": "active", // active, blocked, muted
  "created_at": ISODate("2023-05-20")
}
```

**å¸–å­é›†åˆ**ï¼š
```javascript
{
  "_id": ObjectId("post1"),
  "user_id": ObjectId("user1"),
  "user_info": {
    "username": "zhang_san",
    "name": "å¼ ä¸‰",
    "avatar": "zhang_san.jpg"
  },
  "content": "ä»Šå¤©å­¦ä¹ äº†MongoDBçš„é«˜çº§æ•°æ®å»ºæ¨¡",
  "media": [
    {
      "type": "image",
      "url": "mongodb_diagram.jpg",
      "width": 1200,
      "height": 800
    }
  ],
  "tags": ["æŠ€æœ¯", "æ•°æ®åº“", "MongoDB"],
  "location": {
    "name": "åŒ—äº¬ç§‘æŠ€å›­",
    "coordinates": [116.3, 40.0]
  },
  "stats": {
    "likes": 45,
    "comments": 12,
    "shares": 5
  },
  "created_at": ISODate("2023-06-25T09:15:00Z")
}
```

**äº’åŠ¨é›†åˆ**ï¼š
```javascript
{
  "_id": ObjectId("..."),
  "type": "comment", // comment, like, share
  "post_id": ObjectId("post1"),
  "user_id": ObjectId("user3"),
  "user_info": {
    "username": "li_si",
    "name": "æå››",
    "avatar": "li_si.jpg"
  },
  "content": "éå¸¸å®ç”¨çš„æ–‡ç« ï¼",
  "created_at": ISODate("2023-06-25T10:30:00Z")
}
```

### 2.3 æ¨¡å¼éªŒè¯

MongoDB 3.6+æ”¯æŒJSON SchemaéªŒè¯ï¼Œå¯ä»¥ç¡®ä¿æ•°æ®ç¬¦åˆé¢„å®šä¹‰çš„ç»“æ„å’Œè§„åˆ™ã€‚

```javascript
db.createCollection("products", {
  validator: {
    $jsonSchema: {
      bsonType: "object",
      required: ["name", "price", "category"],
      properties: {
        name: {
          bsonType: "string",
          description: "å¿…é¡»æ˜¯å­—ç¬¦ä¸²ä¸”ä¸å¯ä¸ºç©º"
        },
        price: {
          bsonType: "number",
          minimum: 0,
          description: "å¿…é¡»æ˜¯éè´Ÿæ•°"
        },
        stock: {
          bsonType: "int",
          minimum: 0,
          description: "å¿…é¡»æ˜¯éè´Ÿæ•´æ•°"
        },
        category: {
          bsonType: "string",
          enum: ["ç”µå­äº§å“", "å®¶å±…", "æœè£…", "é£Ÿå“"],
          description: "å¿…é¡»æ˜¯æŒ‡å®šç±»åˆ«ä¹‹ä¸€"
        },
        tags: {
          bsonType: "array",
          items: {
            bsonType: "string"
          }
        }
      }
    }
  },
  validationLevel: "moderate", // strict, moderate, off
  validationAction: "error" // error, warn
})
```

### 2.4 æ•°æ®ä¸€è‡´æ€§ä¸äº‹åŠ¡

#### 2.4.1 åŸå­æ€§æ“ä½œ

MongoDBä¿è¯å•æ–‡æ¡£æ“ä½œçš„åŸå­æ€§ï¼š

```javascript
// æ›´æ–°æ–‡æ¡£ä¸­çš„ç‰¹å®šå­—æ®µï¼ˆåŸå­æ€§æ“ä½œï¼‰
db.inventory.updateOne(
  { _id: "prod1", "quantity": { $gt: 0 } },
  { 
    $inc: { quantity: -1 },
    $push: { orders: { order_id: "12345", date: new Date() } }
  }
)
```

#### 2.4.2 å¤šæ–‡æ¡£äº‹åŠ¡

MongoDB 4.0+æ”¯æŒå¤šæ–‡æ¡£äº‹åŠ¡ï¼š

```javascript
// å¯åŠ¨ä¼šè¯å’Œäº‹åŠ¡
const session = db.getMongo().startSession();
session.startTransaction();

try {
  // æ‰£å‡åº“å­˜
  db.products.updateOne(
    { _id: productId, stock: { $gte: quantity } },
    { $inc: { stock: -quantity } },
    { session }
  );
  
  // åˆ›å»ºè®¢å•
  db.orders.insertOne({
    user_id: userId,
    product_id: productId,
    quantity: quantity,
    total: price * quantity,
    status: "created",
    created_at: new Date()
  }, { session });
  
  // æäº¤äº‹åŠ¡
  session.commitTransaction();
} catch (error) {
  // å›æ»šäº‹åŠ¡
  session.abortTransaction();
  throw error;
} finally {
  // ç»“æŸä¼šè¯
  session.endSession();
}
```

#### 2.4.3 åŒå†™å…³æ³¨

å¯¹äºå…³é”®æ•°æ®ï¼Œå¯ä»¥è®¾ç½®å†™å…¥å…³æ³¨çº§åˆ«ï¼š

```javascript
db.orders.insertOne(
  { /* è®¢å•æ•°æ® */ },
  { writeConcern: { w: "majority", j: true, wtimeout: 5000 } }
)
```

å†™å…¥å…³æ³¨é€‰é¡¹ï¼š
- `w`ï¼šå†™å…¥ç¡®è®¤çº§åˆ«ï¼ˆ1ã€majorityã€æ ‡ç­¾åç§°ï¼‰
- `j`ï¼šç­‰å¾…å†™å…¥æ—¥å¿—
- `wtimeout`ï¼šå†™å…¥è¶…æ—¶æ—¶é—´

## 3. MongoDBé«˜çº§ç‰¹æ€§ä¸ä¼ä¸šåŠŸèƒ½

éšç€MongoDBçš„å‘å±•ï¼Œå®ƒå·²ä»ç®€å•çš„æ–‡æ¡£æ•°æ®åº“æ¼”å˜ä¸ºåŠŸèƒ½å…¨é¢çš„æ•°æ®å¹³å°ï¼Œæä¾›äº†ä¸°å¯Œçš„ä¼ä¸šçº§åŠŸèƒ½æ¥æ»¡è¶³å¤§è§„æ¨¡åº”ç”¨çš„éœ€æ±‚ã€‚

### 3.1 å¤åˆ¶é›†

å¤åˆ¶é›†æ˜¯MongoDBå®ç°é«˜å¯ç”¨æ€§çš„å…³é”®æœºåˆ¶ï¼Œé€šè¿‡å¤šä¸ªèŠ‚ç‚¹çš„æ•°æ®å†—ä½™ç¡®ä¿ç³»ç»Ÿå¯é æ€§ã€‚

#### 3.1.1 å¤åˆ¶é›†æ¶æ„

ä¸€ä¸ªå…¸å‹çš„MongoDBå¤åˆ¶é›†åŒ…å«ï¼š
- ä¸€ä¸ª**ä¸»èŠ‚ç‚¹**(Primary)ï¼šå¤„ç†æ‰€æœ‰å†™æ“ä½œ
- å¤šä¸ª**ä»èŠ‚ç‚¹**(Secondary)ï¼šå¤åˆ¶ä¸»èŠ‚ç‚¹æ•°æ®ï¼Œå¯å¤„ç†è¯»æ“ä½œ
- å¯é€‰çš„**ä»²è£èŠ‚ç‚¹**(Arbiter)ï¼šå‚ä¸é€‰ä¸¾ä½†ä¸å­˜å‚¨æ•°æ®

![MongoDBå¤åˆ¶é›†æ¶æ„](https://docs.mongodb.com/manual/images/replica-set-read-write-operations-primary.bakedsvg.svg)

#### 3.1.2 å¤åˆ¶é›†é…ç½®

**åŸºç¡€é…ç½®ç¤ºä¾‹**ï¼š

1. å‡†å¤‡é…ç½®æ–‡ä»¶(mongod.conf)ï¼š
```yaml
replication:
  replSetName: "rs0"
net:
  bindIp: localhost
  port: 27017
storage:
  dbPath: "/var/lib/mongodb"
```

2. å¯åŠ¨å¤šä¸ªMongoDBå®ä¾‹ï¼š
```bash
mongod --config mongod.conf --port 27017
mongod --config mongod.conf --port 27018 --dbpath /var/lib/mongodb-2
mongod --config mongod.conf --port 27019 --dbpath /var/lib/mongodb-3
```

3. åˆå§‹åŒ–å¤åˆ¶é›†ï¼š
```javascript
// è¿æ¥åˆ°å…¶ä¸­ä¸€ä¸ªå®ä¾‹
mongo --port 27017

// åˆå§‹åŒ–å¤åˆ¶é›†
rs.initiate({
  _id: "rs0",
  members: [
    { _id: 0, host: "localhost:27017" },
    { _id: 1, host: "localhost:27018" },
    { _id: 2, host: "localhost:27019" }
  ]
})
```

4. å¤åˆ¶é›†çŠ¶æ€æ£€æŸ¥ï¼š
```javascript
rs.status()  // æŸ¥çœ‹å¤åˆ¶é›†çŠ¶æ€
rs.isMaster()  // æ£€æŸ¥æ˜¯å¦ä¸ºä¸»èŠ‚ç‚¹
```

#### 3.1.3 å¤åˆ¶é›†è¯»å†™åˆ†ç¦»

å¯ä»¥é€šè¿‡è¯»åå¥½è®¾ç½®å®ç°è¯»å†™åˆ†ç¦»ï¼š

```javascript
// é»˜è®¤ä»ä¸»èŠ‚ç‚¹è¯»å–
db.collection.find().readPref("primary")

// ä»æ¬¡è¦èŠ‚ç‚¹è¯»å–
db.collection.find().readPref("secondary")

// å°±è¿‘åŸåˆ™
db.collection.find().readPref("nearest")
```

åœ¨é©±åŠ¨ç¨‹åºä¸­é…ç½®è¯»åå¥½ï¼š

```javascript
// MongoDB Node.jsé©±åŠ¨ç¤ºä¾‹
const client = new MongoClient(uri, {
  readPreference: 'secondary',
  readPreferenceTags: [
    { datacenter: 'east' },
    { datacenter: 'west' }
  ]
});
```

### 3.2 åˆ†ç‰‡é›†ç¾¤

å½“æ•°æ®é‡å’Œå¤„ç†éœ€æ±‚è¶…å‡ºå•å°æœåŠ¡å™¨èƒ½åŠ›æ—¶ï¼Œåˆ†ç‰‡é›†ç¾¤å…è®¸MongoDBæ°´å¹³æ‰©å±•ä»¥æ”¯æŒå¤§å‹åº”ç”¨ã€‚

#### 3.2.1 åˆ†ç‰‡é›†ç¾¤æ¶æ„

MongoDBåˆ†ç‰‡é›†ç¾¤ç”±ä»¥ä¸‹ç»„ä»¶ç»„æˆï¼š
- **åˆ†ç‰‡**(Shard)ï¼šæ¯ä¸ªåˆ†ç‰‡æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å¤åˆ¶é›†
- **é…ç½®æœåŠ¡å™¨**(Config Server)ï¼šå­˜å‚¨é›†ç¾¤å…ƒæ•°æ®çš„å¤åˆ¶é›†
- **è·¯ç”±æœåŠ¡**(mongos)ï¼šå°†å®¢æˆ·ç«¯è¯·æ±‚è·¯ç”±åˆ°ç›¸åº”åˆ†ç‰‡

![MongoDBåˆ†ç‰‡é›†ç¾¤æ¶æ„](https://docs.mongodb.com/manual/images/sharded-cluster-production-architecture.bakedsvg.svg)

#### 3.2.2 åˆ†ç‰‡ç­–ç•¥

MongoDBæ”¯æŒä¸¤ç§ä¸»è¦åˆ†ç‰‡ç­–ç•¥ï¼š

**èŒƒå›´åˆ†ç‰‡**ï¼šåŸºäºç‰‡é”®å€¼çš„è¿ç»­èŒƒå›´åˆ’åˆ†æ•°æ®
```javascript
sh.shardCollection("mydatabase.orders", { order_date: 1 })
```

**å“ˆå¸Œåˆ†ç‰‡**ï¼šåŸºäºç‰‡é”®å€¼çš„å“ˆå¸Œç»“æœå‡åŒ€åˆ†å¸ƒæ•°æ®
```javascript
sh.shardCollection("mydatabase.users", { user_id: "hashed" })
```

#### 3.2.3 åˆ†ç‰‡é”®é€‰æ‹©

é€‰æ‹©è‰¯å¥½çš„åˆ†ç‰‡é”®å¯¹æ€§èƒ½è‡³å…³é‡è¦ï¼š
- **é«˜åŸºæ•°**ï¼šå–å€¼èŒƒå›´å¹¿ï¼Œå¦‚UUIDæˆ–æ—¶é—´æˆ³
- **åˆ†å¸ƒå‡åŒ€**ï¼šé¿å…æ•°æ®å€¾æ–œ
- **éå•è°ƒå¢é•¿**ï¼šé¿å…å†™å…¥çƒ­ç‚¹
- **å¸¸ç”¨äºæŸ¥è¯¢**ï¼šå‡å°‘è·¨åˆ†ç‰‡æŸ¥è¯¢

```javascript
// å¤åˆåˆ†ç‰‡é”®ç¤ºä¾‹
sh.shardCollection("mydatabase.products", { category: 1, product_id: 1 })
```

#### 3.2.4 åŒºåŸŸåˆ†ç‰‡

åŒºåŸŸåˆ†ç‰‡å…è®¸æŒ‰åœ°ç†ä½ç½®æˆ–å…¶ä»–æ¡ä»¶å°†æ•°æ®åˆ†å¸ƒåˆ°ç‰¹å®šåˆ†ç‰‡ï¼š

```javascript
// å®šä¹‰åŒºåŸŸ
sh.addShardToZone("shard0", "us-east")
sh.addShardToZone("shard1", "us-west")
sh.addShardToZone("shard2", "europe")

// ä¸ºåŒºåŸŸè®¾ç½®èŒƒå›´
sh.updateZoneKeyRange(
  "mydatabase.users",
  { country: "US", state: "NY" },
  { country: "US", state: "PA" },
  "us-east"
)
```

### 3.3 é«˜çº§æŸ¥è¯¢åŠŸèƒ½

MongoDBæä¾›å¤šç§é«˜çº§æŸ¥è¯¢åŠŸèƒ½ï¼Œç”¨äºå¤æ‚çš„æ•°æ®å¤„ç†å’Œåˆ†æã€‚

#### 3.3.1 Change Streams

Change Streamså…è®¸åº”ç”¨ç¨‹åºç›‘å¬æ•°æ®åº“å˜æ›´ï¼š

```javascript
const changeStream = db.collection('inventory').watch();

changeStream.on('change', (change) => {
  console.log('Detected change:', change);
  // æ ¹æ®å˜æ›´ç±»å‹è¿›è¡Œå¤„ç†
  if (change.operationType === 'insert') {
    // å¤„ç†æ–°æ’å…¥çš„æ–‡æ¡£
  } else if (change.operationType === 'update') {
    // å¤„ç†æ›´æ–°æ“ä½œ
  }
});
```

Change Streamså¯ç”¨äºå®ç°ï¼š
- ç¼“å­˜å¤±æ•ˆ
- å®æ—¶åˆ†æ
- äº‹ä»¶é©±åŠ¨æ¶æ„
- è·¨ç³»ç»Ÿæ•°æ®åŒæ­¥

#### 3.3.2 åœ°ç†ç©ºé—´æŸ¥è¯¢

MongoDBæä¾›å¼ºå¤§çš„åœ°ç†ç©ºé—´ç´¢å¼•å’ŒæŸ¥è¯¢åŠŸèƒ½ï¼š

```javascript
// åˆ›å»º2dsphereç´¢å¼•
db.places.createIndex({ location: "2dsphere" })

// é™„è¿‘æŸ¥è¯¢
db.places.find({
  location: {
    $near: {
      $geometry: {
        type: "Point",
        coordinates: [121.4737, 31.2304]  // ä¸Šæµ·åæ ‡
      },
      $maxDistance: 5000  // 5å…¬é‡Œå†…
    }
  }
})

// åœ°ç†è¾¹ç•Œæ¡†æŸ¥è¯¢
db.places.find({
  location: {
    $geoWithin: {
      $geometry: {
        type: "Polygon",
        coordinates: [[
          [120.0, 30.0], [122.0, 30.0],
          [122.0, 32.0], [120.0, 32.0],
          [120.0, 30.0]
        ]]
      }
    }
  }
})
```

#### 3.3.3 å…¨æ–‡æœç´¢

MongoDBçš„æ–‡æœ¬æœç´¢åŠŸèƒ½æ”¯æŒå¤šè¯­è¨€å…¨æ–‡æ£€ç´¢ï¼š

```javascript
// åˆ›å»ºæ–‡æœ¬ç´¢å¼•
db.articles.createIndex({ title: "text", content: "text" })

// åŸºæœ¬å…¨æ–‡æœç´¢
db.articles.find({ $text: { $search: "mongodb nosql æ•°æ®åº“" } })

// ä½¿ç”¨æƒé‡å’Œè¯„åˆ†
db.articles.find(
  { $text: { $search: "mongodb nosql æ•°æ®åº“" } },
  { score: { $meta: "textScore" } }
).sort({ score: { $meta: "textScore" } })
```

é…ç½®æ–‡æœ¬ç´¢å¼•æƒé‡ï¼š

```javascript
// æ ‡é¢˜æƒé‡é«˜äºå†…å®¹
db.articles.createIndex(
  { title: "text", content: "text" },
  { weights: { title: 10, content: 5 } }
)
```

#### 3.3.4 å›¾è¡¨æŸ¥è¯¢

MongoDB 4.0+å¼•å…¥äº†$graphLookupï¼Œæ”¯æŒå›¾è¡¨æ•°æ®çš„é€’å½’æŸ¥è¯¢ï¼š

```javascript
// æŸ¥è¯¢å‘˜å·¥çš„æ‰€æœ‰ä¸Šçº§ç®¡ç†å±‚
db.employees.aggregate([
  { $match: { name: "å¼ ä¸‰" } },
  {
    $graphLookup: {
      from: "employees",
      startWith: "$manager_id",
      connectFromField: "manager_id",
      connectToField: "_id",
      as: "management_chain",
      maxDepth: 5,
      depthField: "level"
    }
  }
])
```

### 3.4 å®‰å…¨æ€§ä¸å®¡è®¡

MongoDBæä¾›å…¨é¢çš„å®‰å…¨æ§åˆ¶æœºåˆ¶ï¼Œä¿æŠ¤æ•°æ®å…å—æœªæˆæƒè®¿é—®ã€‚

#### 3.4.1 è®¤è¯ä¸æˆæƒ

**å¯ç”¨è®¤è¯**ï¼š
```yaml
# mongod.conf
security:
  authorization: enabled
```

**åˆ›å»ºç®¡ç†å‘˜ç”¨æˆ·**ï¼š
```javascript
use admin
db.createUser({
  user: "adminUser",
  pwd: "securePassword",
  roles: [{ role: "userAdminAnyDatabase", db: "admin" }]
})
```

**åˆ›å»ºåº”ç”¨ç”¨æˆ·**ï¼š
```javascript
use mydb
db.createUser({
  user: "appUser",
  pwd: "appPassword",
  roles: [
    { role: "readWrite", db: "mydb" },
    { role: "read", db: "reporting" }
  ]
})
```

**å†…ç½®è§’è‰²**ï¼š
- æ•°æ®åº“ç”¨æˆ·ï¼š`read`, `readWrite`
- æ•°æ®åº“ç®¡ç†ï¼š`dbAdmin`, `dbOwner`
- é›†ç¾¤ç®¡ç†ï¼š`clusterAdmin`, `clusterManager`
- å¤‡ä»½æ¢å¤ï¼š`backup`, `restore`
- è¶…çº§ç”¨æˆ·ï¼š`root`

**è‡ªå®šä¹‰è§’è‰²**ï¼š
```javascript
db.createRole({
  role: "reportingRole",
  privileges: [
    {
      resource: { db: "reporting", collection: "" },
      actions: ["find"]
    }
  ],
  roles: []
})
```

#### 3.4.2 TLS/SSLåŠ å¯†

é…ç½®MongoDBä½¿ç”¨TLS/SSLåŠ å¯†è¿æ¥ï¼š

```yaml
# mongod.conf
net:
  ssl:
    mode: requireSSL
    PEMKeyFile: /path/to/mongodb.pem
    CAFile: /path/to/ca.pem
```

#### 3.4.3 å­—æ®µçº§åŠ å¯†

MongoDB 4.2+æ”¯æŒå®¢æˆ·ç«¯å­—æ®µçº§åŠ å¯†ï¼š

```javascript
// åˆ›å»ºåŠ å¯†é›†åˆ
db.createCollection("patients", {
  validator: {
    $jsonSchema: {
      bsonType: "object",
      properties: {
        name: {
          encrypt: {
            bsonType: "string",
            algorithm: "AEAD_AES_256_CBC_HMAC_SHA_512-Deterministic"
          }
        },
        ssn: {
          encrypt: {
            bsonType: "string",
            algorithm: "AEAD_AES_256_CBC_HMAC_SHA_512-Deterministic"
          }
        },
        bloodType: {
          encrypt: {
            bsonType: "string",
            algorithm: "AEAD_AES_256_CBC_HMAC_SHA_512-Random"
          }
        },
        medicalRecords: {
          encrypt: {
            bsonType: "object",
            algorithm: "AEAD_AES_256_CBC_HMAC_SHA_512-Random"
          }
        }
      }
    }
  }
})
```

#### 3.4.4 å®¡è®¡

MongoDB Enterpriseç‰ˆæ”¯æŒå®¡è®¡åŠŸèƒ½ï¼š

```yaml
# mongod.conf
auditLog:
  destination: file
  format: JSON
  path: /var/log/mongodb/audit.json
  filter: '{ atype: { $in: ["authenticate", "createUser", "dropUser"] } }'
```

### 3.5 æ€§èƒ½ä¼˜åŒ–ä¸ç›‘æ§

é«˜æ•ˆè¿ç»´MongoDBéœ€è¦æŒç»­ç›‘æ§å’Œä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½ã€‚

#### 3.5.1 æŸ¥è¯¢ä¼˜åŒ–

ä½¿ç”¨`explain()`åˆ†ææŸ¥è¯¢æ‰§è¡Œè®¡åˆ’ï¼š

```javascript
// åŸºæœ¬æ‰§è¡Œè®¡åˆ’
db.users.find({ age: { $gt: 30 } }).explain()

// è¯¦ç»†æ‰§è¡Œä¿¡æ¯
db.users.find({ age: { $gt: 30 } }).explain("executionStats")

// æ‰€æœ‰æ‰§è¡Œè®¡åˆ’
db.users.find({ age: { $gt: 30 } }).explain("allPlansExecution")
```

æŸ¥è¯¢ä¼˜åŒ–æŠ€å·§ï¼š
- ä½¿ç”¨`hint()`å¼ºåˆ¶ä½¿ç”¨ç‰¹å®šç´¢å¼•
- é€‚å½“æŠ•å½±ä»…è¿”å›å¿…è¦å­—æ®µ
- ä½¿ç”¨é€‚å½“çš„ç´¢å¼•è¦†ç›–æŸ¥è¯¢
- é¿å…æ­£åˆ™è¡¨è¾¾å¼å‰ç¼€é€šé…ç¬¦

#### 3.5.2 ç´¢å¼•ä¼˜åŒ–

ä¼˜åŒ–ç´¢å¼•ç­–ç•¥ï¼š
- åˆ›å»ºæ”¯æŒæŸ¥è¯¢çš„ç´¢å¼•
- é¿å…åˆ›å»ºå†—ä½™ç´¢å¼•
- å®šæœŸæ£€æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…å†µ
- åœ¨åå°åˆ›å»ºå¤§å‹ç´¢å¼•

```javascript
// æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨ç»Ÿè®¡
db.users.aggregate([{ $indexStats: {} }])

// æŸ¥æ‰¾æœªä½¿ç”¨çš„ç´¢å¼•
db.adminCommand({ serverStatus: 1 }).metrics.commands

// åœ¨åå°åˆ›å»ºç´¢å¼•
db.users.createIndex({ email: 1 }, { background: true })
```

#### 3.5.3 MongoDB Compass

MongoDB Compassæ˜¯å®˜æ–¹GUIå·¥å…·ï¼Œæä¾›ï¼š
- æ•°æ®å¯è§†åŒ–
- æ€§èƒ½åˆ†æ
- ç´¢å¼•å»ºè®®
- èšåˆç®¡é“æ„å»º
- æ¨¡å¼å¯è§†åŒ–

#### 3.5.4 MongoDB Atlasç›‘æ§

MongoDB Atlasäº‘æœåŠ¡æä¾›ï¼š
- å®æ—¶æ€§èƒ½ç›‘æ§
- è‡ªåŠ¨åŒ–è­¦æŠ¥
- æŸ¥è¯¢æ€§èƒ½åˆ†æ
- å®¹é‡è§„åˆ’
- å®æ—¶æ—¥å¿—æŸ¥çœ‹

## 4. Spring Bootä¸MongoDBé›†æˆæœ€ä½³å®è·µ

Spring Bootæä¾›äº†ä¸°å¯Œçš„å·¥å…·å’ŒæŠ½è±¡ï¼Œä½¿MongoDBé›†æˆå˜å¾—ç®€å•è€Œå¼ºå¤§ã€‚

### 4.1 é…ç½®MongoDBè¿æ¥

#### 4.1.1 æ·»åŠ ä¾èµ–

åœ¨`pom.xml`ä¸­æ·»åŠ å¿…è¦ä¾èµ–ï¼š

```xml
<!-- Spring Data MongoDB -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-mongodb</artifactId>
</dependency>

<!-- å¯é€‰ï¼šLombokç®€åŒ–ä»£ç  -->
<dependency>
    <groupId>org.projectlombok</groupId>
    <artifactId>lombok</artifactId>
    <optional>true</optional>
</dependency>
```

#### 4.1.2 é…ç½®è¿æ¥

åœ¨`application.yml`ä¸­é…ç½®MongoDBè¿æ¥ï¼š

**å•æœºè¿æ¥**ï¼š
```yaml
spring:
  data:
    mongodb:
      uri: mongodb://username:password@localhost:27017/database
```

**å¤åˆ¶é›†è¿æ¥**ï¼š
```yaml
spring:
  data:
    mongodb:
      uri: mongodb://user:password@server1:27017,server2:27017,server3:27017/database?replicaSet=rs0&authSource=admin
```

**é«˜çº§é…ç½®**ï¼š
```yaml
spring:
  data:
    mongodb:
      uri: mongodb://user:password@localhost:27017/database
      auto-index-creation: true
      field-naming-strategy: org.springframework.data.mapping.model.SnakeCaseFieldNamingStrategy
      grid-fs-database: files
      authentication-database: admin
      uuid-representation: standard
      connection-pool:
        max-connection-life-time: 30000
        max-idle-time: 60000
        max-size: 100
        min-size: 10
```

### 4.2 å®šä¹‰æ–‡æ¡£æ˜ å°„

#### 4.2.1 åŸºæœ¬æ–‡æ¡£æ˜ å°„

ä½¿ç”¨`@Document`æ³¨è§£å°†Javaç±»æ˜ å°„åˆ°MongoDBé›†åˆï¼š

```java
import org.springframework.data.mongodb.core.mapping.Document;
import org.springframework.data.annotation.Id;
import lombok.Data;
import java.time.LocalDateTime;
import java.util.List;

@Data
@Document(collection = "products")
public class Product {
    @Id
    private String id;
    
    private String name;
    private String description;
    private double price;
    private int stock;
    
    private List<String> categories;
    
    @Field("tech_specs")
    private Map<String, String> technicalSpecifications;
    
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
}
```

#### 4.2.2 ç´¢å¼•é…ç½®

ä½¿ç”¨`@Indexed`æ³¨è§£å®šä¹‰ç´¢å¼•ï¼š

```java
@Document(collection = "users")
public class User {
    @Id
    private String id;
    
    @Indexed(unique = true)
    private String email;
    
    @Indexed
    private String lastName;
    
    @TextIndexed
    private String bio;
    
    @Indexed(direction = IndexDirection.DESCENDING)
    private LocalDateTime createdAt;
    
    @CompoundIndex(name = "location_idx", def = "{'address.city': 1, 'address.country': 1}")
    private Address address;
}
```

#### 4.2.3 åµŒå…¥å¼æ–‡æ¡£

è¡¨ç¤ºåµŒå…¥å¼æ–‡æ¡£ç»“æ„ï¼š

```java
@Data
public class Address {
    private String street;
    private String city;
    private String state;
    private String zipCode;
    private String country;
    
    @GeoSpatialIndexed(type = GeoSpatialIndexType.GEO_2DSPHERE)
    private GeoJsonPoint location;
}
```

#### 4.2.4 DBRefå¼•ç”¨

ä½¿ç”¨`@DBRef`è¡¨ç¤ºæ–‡æ¡£å¼•ç”¨ï¼š

```java
@Document(collection = "orders")
public class Order {
    @Id
    private String id;
    
    @DBRef
    private User customer;
    
    private List<OrderItem> items;
    
    private double totalAmount;
    private String status;
    private LocalDateTime orderDate;
}

@Data
public class OrderItem {
    @DBRef(lazy = true)
    private Product product;
    
    private int quantity;
    private double price;
}
```

### 4.3 ä½¿ç”¨Spring Data MongoDB Repository

#### 4.3.1 åŸºæœ¬Repositoryæ¥å£

åˆ›å»ºç»§æ‰¿`MongoRepository`çš„æ¥å£ï¼š

```java
import org.springframework.data.mongodb.repository.MongoRepository;

public interface ProductRepository extends MongoRepository<Product, String> {
    // è‡ªåŠ¨å®ç°å¸¸ç”¨CRUDæ“ä½œ
}
```

#### 4.3.2 è‡ªå®šä¹‰æŸ¥è¯¢æ–¹æ³•

åŸºäºæ–¹æ³•åå®šä¹‰æŸ¥è¯¢ï¼š

```java
public interface ProductRepository extends MongoRepository<Product, String> {
    // æŸ¥æ‰¾ç‰¹å®šä»·æ ¼èŒƒå›´å†…çš„äº§å“
    List<Product> findByPriceBetween(double minPrice, double maxPrice);
    
    // æŸ¥æ‰¾ç‰¹å®šç±»åˆ«çš„äº§å“ï¼Œå¹¶æŒ‰ä»·æ ¼æ’åº
    List<Product> findByCategoriesContainingOrderByPriceAsc(String category);
    
    // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æŸ¥æ‰¾åç§°åŒ¹é…çš„äº§å“
    List<Product> findByNameRegex(String nameRegex);
    
    // ç»Ÿè®¡åº“å­˜ä½äºæŒ‡å®šå€¼çš„äº§å“æ•°é‡
    long countByStockLessThan(int threshold);
    
    // æŸ¥æ‰¾æŸä¸ªæ—¥æœŸä¹‹ååˆ›å»ºçš„äº§å“
    List<Product> findByCreatedAtAfter(LocalDateTime date);
}
```

#### 4.3.3 ä½¿ç”¨@Queryæ³¨è§£

ä½¿ç”¨MongoDBåŸç”ŸæŸ¥è¯¢è¯­æ³•ï¼š

```java
public interface UserRepository extends MongoRepository<User, String> {
    // ä½¿ç”¨JSONæŸ¥è¯¢
    @Query("{ 'age': { $gte: ?0, $lte: ?1 } }")
    List<User> findUsersInAgeRange(int minAge, int maxAge);
    
    // å­—æ®µæŠ•å½±
    @Query(value = "{ 'status': ?0 }", fields = "{ 'name': 1, 'email': 1 }")
    List<User> findActiveUsersWithProjection(String status);
    
    // æ›´æ–°æŸ¥è¯¢
    @Query("{ 'email': ?0 }")
    @Update("{ '$set': { 'status': ?1, 'lastLoginDate': ?2 } }")
    void updateUserStatus(String email, String status, LocalDateTime lastLogin);
    
    // èšåˆç®¡é“
    @Aggregation("{ $match: { 'department': ?0 } }, "
               + "{ $group: { '_id': '$jobTitle', 'avgSalary': { $avg: '$salary' } } }, "
               + "{ $sort: { 'avgSalary': -1 } }")
    List<Document> getAverageSalaryByJobTitle(String department);
}
```

#### 4.3.4 åˆ†é¡µä¸æ’åº

å®ç°åˆ†é¡µæŸ¥è¯¢ï¼š

```java
@GetMapping("/products")
public Page<Product> getProducts(
    @RequestParam(defaultValue = "0") int page,
    @RequestParam(defaultValue = "10") int size,
    @RequestParam(defaultValue = "name") String sortBy
) {
    Pageable pageable = PageRequest.of(page, size, Sort.by(sortBy));
    return productRepository.findAll(pageable);
}

// è‡ªå®šä¹‰åˆ†é¡µæ–¹æ³•
Page<Product> findByCategoryAndPriceGreaterThan(
    String category, double price, Pageable pageable);
```

### 4.4 ä½¿ç”¨MongoTemplateè¿›è¡Œé«˜çº§æ“ä½œ

å¯¹äºæ›´å¤æ‚çš„æ“ä½œï¼Œ`MongoTemplate`æä¾›äº†ç›´æ¥è®¿é—®MongoDBçš„èƒ½åŠ›ï¼š

```java
@Service
public class ProductService {
    private final MongoTemplate mongoTemplate;
    
    public ProductService(MongoTemplate mongoTemplate) {
        this.mongoTemplate = mongoTemplate;
    }
    
    // ä½¿ç”¨criteriaæ„å»ºåŠ¨æ€æŸ¥è¯¢
    public List<Product> findProductsByDynamicCriteria(String name, 
                                                      List<String> categories, 
                                                      Double minPrice, 
                                                      Double maxPrice) {
        Criteria criteria = new Criteria();
        
        List<Criteria> filters = new ArrayList<>();
        
        if (name != null) {
            filters.add(Criteria.where("name").regex(name, "i"));
        }
        
        if (categories != null && !categories.isEmpty()) {
            filters.add(Criteria.where("categories").in(categories));
        }
        
        if (minPrice != null && maxPrice != null) {
            filters.add(Criteria.where("price").gte(minPrice).lte(maxPrice));
        } else if (minPrice != null) {
            filters.add(Criteria.where("price").gte(minPrice));
        } else if (maxPrice != null) {
            filters.add(Criteria.where("price").lte(maxPrice));
        }
        
        if (!filters.isEmpty()) {
            criteria = new Criteria().andOperator(
                filters.toArray(new Criteria[0]));
        }
        
        Query query = new Query(criteria);
        return mongoTemplate.find(query, Product.class);
    }
    
    // ä½¿ç”¨æ›´æ–°æ“ä½œç¬¦
    public long updateProductPrices(String category, double percentage) {
        Query query = new Query(Criteria.where("categories").is(category));
        Update update = new Update().multiply("price", 1 + (percentage / 100));
        UpdateResult result = mongoTemplate.updateMulti(query, update, Product.class);
        return result.getModifiedCount();
    }
    
    // æ‰§è¡Œèšåˆæ“ä½œ
    public List<CategoryStat> getProductStatsByCategory() {
        TypedAggregation<Product> aggregation = Aggregation.newAggregation(
            Product.class,
            Aggregation.unwind("categories"),
            Aggregation.group("categories")
                .count().as("count")
                .avg("price").as("averagePrice")
                .max("price").as("maxPrice"),
            Aggregation.sort(Sort.Direction.DESC, "count")
        );
        
        AggregationResults<CategoryStat> results = 
            mongoTemplate.aggregate(aggregation, CategoryStat.class);
        
        return results.getMappedResults();
    }
    
    // åœ°ç†ç©ºé—´æŸ¥è¯¢
    public List<Store> findNearbyStores(double latitude, double longitude, double maxDistance) {
        Point location = new Point(longitude, latitude);
        Query query = new Query(
            Criteria.where("location").nearSphere(location)
                .maxDistance(maxDistance / 6378.1) // è½¬æ¢ä¸ºå¼§åº¦
        );
        return mongoTemplate.find(query, Store.class);
    }
    
    // æ‰¹é‡æ“ä½œ
    public void bulkUpsertProducts(List<Product> products) {
        BulkOperations bulkOps = mongoTemplate.bulkOps(
            BulkOperations.BulkMode.UNORDERED, Product.class);
        
        for (Product product : products) {
            Query query = new Query(Criteria.where("sku").is(product.getSku()));
            Update update = getProductUpdateDefinition(product);
            bulkOps.upsert(query, update);
        }
        
        BulkWriteResult result = bulkOps.execute();
        System.out.println("Inserted: " + result.getInsertedCount());
        System.out.println("Modified: " + result.getModifiedCount());
    }
    
    private Update getProductUpdateDefinition(Product product) {
        Update update = new Update();
        // è®¾ç½®æ‰€æœ‰äº§å“å­—æ®µ...
        update.set("name", product.getName());
        update.set("price", product.getPrice());
        // ...å…¶ä»–å­—æ®µ
        update.set("updatedAt", LocalDateTime.now());
        return update;
    }
}
```

### 4.5 äº‹åŠ¡ç®¡ç†

MongoDB 4.0+æ”¯æŒå¤šæ–‡æ¡£äº‹åŠ¡ï¼ŒSpring Data MongoDBæä¾›äº†äº‹åŠ¡æ”¯æŒï¼š

#### 4.5.1 é…ç½®äº‹åŠ¡ç®¡ç†å™¨

```java
@Configuration
public class MongoConfig extends AbstractMongoClientConfiguration {
    
    @Override
    protected String getDatabaseName() {
        return "mydatabase";
    }
    
    @Bean
    MongoTransactionManager transactionManager(MongoDatabaseFactory dbFactory) {
        return new MongoTransactionManager(dbFactory);
    }
}
```

#### 4.5.2 ä½¿ç”¨å£°æ˜å¼äº‹åŠ¡

```java
@Service
public class OrderService {
    
    private final OrderRepository orderRepository;
    private final ProductRepository productRepository;
    private final CustomerRepository customerRepository;
    
    // æ„é€ å‡½æ•°æ³¨å…¥...
    
    @Transactional
    public Order createOrder(OrderRequest request) {
        // æ£€æŸ¥å®¢æˆ·æ˜¯å¦å­˜åœ¨
        Customer customer = customerRepository.findById(request.getCustomerId())
            .orElseThrow(() -> new EntityNotFoundException("Customer not found"));
            
        // æ£€æŸ¥å¹¶æ›´æ–°äº§å“åº“å­˜
        List<OrderItem> items = new ArrayList<>();
        for (OrderItemRequest itemReq : request.getItems()) {
            Product product = productRepository.findById(itemReq.getProductId())
                .orElseThrow(() -> new EntityNotFoundException("Product not found"));
                
            if (product.getStock() < itemReq.getQuantity()) {
                throw new InsufficientStockException("Not enough stock for product: " + product.getName());
            }
            
            // å‡å°‘åº“å­˜
            product.setStock(product.getStock() - itemReq.getQuantity());
            productRepository.save(product);
            
            // åˆ›å»ºè®¢å•é¡¹
            OrderItem item = new OrderItem();
            item.setProduct(product);
            item.setQuantity(itemReq.getQuantity());
            item.setPrice(product.getPrice());
            items.add(item);
        }
        
        // åˆ›å»ºè®¢å•
        Order order = new Order();
        order.setCustomer(customer);
        order.setItems(items);
        order.setStatus("CREATED");
        order.setOrderDate(LocalDateTime.now());
        order.setTotalAmount(calculateTotalAmount(items));
        
        return orderRepository.save(order);
    }
    
    private double calculateTotalAmount(List<OrderItem> items) {
        return items.stream()
            .mapToDouble(item -> item.getPrice() * item.getQuantity())
            .sum();
    }
}
```

#### 4.5.3 ç¼–ç¨‹å¼äº‹åŠ¡

```java
@Service
public class InventoryService {
    
    private final MongoTemplate mongoTemplate;
    private final TransactionTemplate transactionTemplate;
    
    public InventoryService(MongoTemplate mongoTemplate, 
                           PlatformTransactionManager transactionManager) {
        this.mongoTemplate = mongoTemplate;
        this.transactionTemplate = new TransactionTemplate(transactionManager);
    }
    
    public boolean transferStock(String fromProductId, String toProductId, int quantity) {
        return transactionTemplate.execute(status -> {
            try {
                // ä»æºäº§å“å‡å°‘åº“å­˜
                Query fromQuery = new Query(Criteria.where("_id").is(fromProductId)
                    .and("stock").gte(quantity));
                Update fromUpdate = new Update().inc("stock", -quantity);
                UpdateResult fromResult = mongoTemplate.updateFirst(
                    fromQuery, fromUpdate, Product.class);
                
                if (fromResult.getModifiedCount() == 0) {
                    status.setRollbackOnly();
                    return false;
                }
                
                // å‘ç›®æ ‡äº§å“å¢åŠ åº“å­˜
                Query toQuery = new Query(Criteria.where("_id").is(toProductId));
                Update toUpdate = new Update().inc("stock", quantity);
                mongoTemplate.updateFirst(toQuery, toUpdate, Product.class);
                
                return true;
            } catch (Exception e) {
                status.setRollbackOnly();
                throw e;
            }
        });
    }
}
``` 

## 5. MongoDBæ€§èƒ½ä¼˜åŒ–

MongoDBæ€§èƒ½ä¼˜åŒ–æ˜¯ä¸€ä¸ªå¤šå±‚æ¬¡çš„å·¥ç¨‹ï¼Œæ¶‰åŠä»ç¡¬ä»¶é…ç½®åˆ°åº”ç”¨è®¾è®¡çš„å„ä¸ªç¯èŠ‚ã€‚æœ¬èŠ‚å°†å…¨é¢ä»‹ç»MongoDBæ€§èƒ½ä¼˜åŒ–çš„å…³é”®ç­–ç•¥å’Œæœ€ä½³å®è·µã€‚

### 5.1 ç¡¬ä»¶ä¸ç³»ç»Ÿä¼˜åŒ–

MongoDBæ€§èƒ½åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šå—åˆ°åº•å±‚ç¡¬ä»¶å’Œæ“ä½œç³»ç»Ÿçš„å½±å“ã€‚

#### 5.1.1 ç¡¬ä»¶é€‰æ‹©

- **å­˜å‚¨ç±»å‹**ï¼šä½¿ç”¨SSD/NVMeæ›¿ä»£HDDï¼Œå°¤å…¶æ˜¯å¯¹äºé¢‘ç¹å†™å…¥å’Œéšæœºè¯»å–åœºæ™¯
- **å†…å­˜å®¹é‡**ï¼šMongoDBåˆ©ç”¨å†…å­˜æ˜ å°„æ–‡ä»¶æœºåˆ¶ï¼Œç†æƒ³æƒ…å†µä¸‹å·¥ä½œé›†åº”å®Œå…¨é€‚åˆRAM
- **CPU**ï¼šå¤šæ ¸CPUæœ‰åˆ©äºå¹¶å‘æ“ä½œå’Œèšåˆæ¡†æ¶çš„å¹¶è¡Œæ‰§è¡Œ
- **ç½‘ç»œ**ï¼šä½¿ç”¨è‡³å°‘åƒå…†ç½‘ç»œï¼Œå¯¹åˆ†ç‰‡é›†ç¾¤å°¤ä¸ºé‡è¦

#### 5.1.2 æ“ä½œç³»ç»Ÿé…ç½®

**Linuxç³»ç»Ÿä¼˜åŒ–**ï¼š

```bash
# æ–‡ä»¶æè¿°ç¬¦é™åˆ¶ï¼ˆå¯¹è¿æ¥æ•°é‡å¾ˆé‡è¦ï¼‰
sudo sysctl -w fs.file-max=100000
sudo sysctl -w fs.nr_open=100000

# ç¦ç”¨é€æ˜å¤§é¡µé¢ï¼ˆæå…¶é‡è¦ï¼‰
echo never > /sys/kernel/mm/transparent_hugepage/enabled
echo never > /sys/kernel/mm/transparent_hugepage/defrag

# readaheadè®¾ç½®ï¼ˆé€‚ç”¨äºSSDï¼‰
sudo blockdev --setra 32 /dev/sda

# å¢åŠ vm.swappinessï¼ˆå‡å°‘swapä½¿ç”¨ï¼‰
sudo sysctl -w vm.swappiness=1
```

å°†è¿™äº›è®¾ç½®æ·»åŠ åˆ°`/etc/sysctl.conf`ä¸­ä½¿å…¶æ°¸ä¹…ç”Ÿæ•ˆã€‚

### 5.2 MongoDBå®ä¾‹ä¼˜åŒ–

#### 5.2.1 å…³é”®é…ç½®å‚æ•°

**WiredTigerå­˜å‚¨å¼•æ“ä¼˜åŒ–**ï¼š

```yaml
storage:
  wiredTiger:
    engineConfig:
      cacheSizeGB: 4  # é»˜è®¤æ˜¯ç‰©ç†å†…å­˜çš„ä¸€åŠ
      journalCompressor: snappy  # æ—¥å¿—å‹ç¼©ç®—æ³•
    collectionConfig:
      blockCompressor: snappy  # æ•°æ®å‹ç¼©ç®—æ³•
    indexConfig:
      prefixCompression: true  # ç´¢å¼•å‰ç¼€å‹ç¼©
```

**è¿æ¥ä¸ç½‘ç»œè®¾ç½®**ï¼š

```yaml
net:
  maxIncomingConnections: 2000  # æœ€å¤§è¿æ¥æ•°
  port: 27017
  bindIp: localhost,192.168.1.100  # ç»‘å®šå¤šä¸ªIP
```

**æ“ä½œé™åˆ¶**ï¼š

```yaml
operationProfiling:
  mode: slowOp  # æ…¢æŸ¥è¯¢è®°å½•æ¨¡å¼
  slowOpThresholdMs: 100  # æ…¢æŸ¥è¯¢é˜ˆå€¼(æ¯«ç§’)
```

#### 5.2.2 åˆ†æä¸è°ƒä¼˜å·¥å…·

- **mongostat**ï¼šç›‘æ§å®ä¾‹æ•´ä½“æ€§èƒ½
- **mongotop**ï¼šè¯†åˆ«é›†åˆçº§åˆ«çš„è¯»å†™æ´»åŠ¨
- **MongoDB Compass**ï¼šå¯è§†åŒ–åˆ†æå·¥å…·
- **Database Profiler**ï¼šè¯¦ç»†åˆ†ææ…¢æŸ¥è¯¢

```javascript
// å¯ç”¨æ•°æ®åº“åˆ†æå™¨
db.setProfilingLevel(1, { slowms: 100 })

// æŸ¥è¯¢æ…¢æ“ä½œ
db.system.profile.find({ millis: { $gt: 100 } }).sort({ ts: -1 })
```

### 5.3 æ•°æ®æ¨¡å‹ä¸ç´¢å¼•ä¼˜åŒ–

MongoDBçš„æ€§èƒ½å¾ˆå¤§ç¨‹åº¦ä¸Šå–å†³äºæ•°æ®æ¨¡å‹è®¾è®¡å’Œç´¢å¼•ç­–ç•¥ã€‚

#### 5.3.1 æ•°æ®æ¨¡å‹ä¼˜åŒ–

**æ–‡æ¡£ç»“æ„ä¼˜åŒ–**ï¼š

- **æŒ‰è®¿é—®æ¨¡å¼è®¾è®¡**ï¼šå¸¸ä¸€èµ·è®¿é—®çš„æ•°æ®åº”æ”¾åœ¨ä¸€èµ·
- **é¿å…è¿‡å¤§æ–‡æ¡£**ï¼šæ¥è¿‘16MBé™åˆ¶çš„æ–‡æ¡£ä¼šå½±å“æ€§èƒ½
- **é¿å…ä¸æ–­å¢é•¿çš„æ•°ç»„**ï¼šå¤§å‹æ•°ç»„å¯èƒ½å¯¼è‡´æ–‡æ¡£å¤§å°ä¸æ–­å¢é•¿
- **æ§åˆ¶åµŒå¥—æ·±åº¦**ï¼šæ·±åº¦åµŒå¥—æ–‡æ¡£å¢åŠ æŸ¥è¯¢å¤æ‚åº¦

```javascript
// æœ‰æ•ˆçš„åµŒå…¥å¼æ–‡æ¡£è®¾è®¡
{
  "_id": ObjectId("..."),
  "order_id": "ORD123456",
  "customer": {  // åµŒå…¥å¸¸ç”¨ä¿¡æ¯
    "id": "CUST789",
    "name": "æå››",
    "contact": "+86123456789"
  },
  "items": [  // æ§åˆ¶æ•°ç»„å¤§å°
    {
      "product_id": "PROD001",
      "name": "å•†å“A",
      "quantity": 2,
      "price": 299
    },
    // é€šå¸¸ä¸è¶…è¿‡100ä¸ªå…ƒç´ 
  ]
}
```

#### 5.3.2 é«˜æ•ˆç´¢å¼•ç­–ç•¥

**ç´¢å¼•ä¼˜åŒ–åŸåˆ™**ï¼š

1. **è¦†ç›–æŸ¥è¯¢ç´¢å¼•**ï¼šä½¿ç”¨åŒ…å«æ‰€æœ‰æŸ¥è¯¢å­—æ®µçš„ç´¢å¼•
2. **é«˜é€‰æ‹©æ€§å‰ç¼€**ï¼šåœ¨å¤åˆç´¢å¼•ä¸­ï¼Œå°†é«˜é€‰æ‹©æ€§å­—æ®µæ”¾åœ¨å‰é¢
3. **é€‚å½“çš„ç´¢å¼•åŸºæ•°**ï¼šé¿å…åœ¨ä½åŸºæ•°å­—æ®µä¸Šåˆ›å»ºå•å­—æ®µç´¢å¼•
4. **ç´¢å¼•äº¤é›†**ï¼šåˆ©ç”¨MongoDBçš„ç´¢å¼•äº¤é›†åŠŸèƒ½
5. **é¿å…è¿‡å¤šç´¢å¼•**ï¼šæ¯ä¸ªç´¢å¼•éƒ½å¢åŠ å†™å…¥å¼€é”€

```javascript
// åˆ›å»ºæ”¯æŒå¤šç§æŸ¥è¯¢çš„å¤åˆç´¢å¼•
db.orders.createIndex({ customer_id: 1, order_date: -1, status: 1 })

// é«˜æ•ˆå¤„ç†æ’åºçš„ç´¢å¼•
db.products.createIndex({ category: 1, price: -1 })

// ä½¿ç”¨hintå¼ºåˆ¶ä½¿ç”¨ç‰¹å®šç´¢å¼•ï¼ˆæµ‹è¯•æ€§èƒ½æ—¶ä½¿ç”¨ï¼‰
db.orders.find({ customer_id: "C1001", status: "PENDING" })
  .hint({ customer_id: 1, order_date: -1, status: 1 })
```

#### 5.3.3 å®šæœŸç´¢å¼•ç»´æŠ¤

```javascript
// æ£€æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…å†µ
db.collection.aggregate([{ $indexStats: {} }])

// æŸ¥æ‰¾æœªä½¿ç”¨çš„ç´¢å¼•
db.collection.aggregate([
  { $indexStats: {} },
  { $match: { accesses: { $elemMatch: { count: 0 } } } }
])

// åˆ é™¤æœªä½¿ç”¨çš„ç´¢å¼•
db.collection.dropIndex("unused_index_name")
```

### 5.4 æŸ¥è¯¢ä¼˜åŒ–æŠ€æœ¯

#### 5.4.1 æŸ¥è¯¢åˆ†æä¸ä¼˜åŒ–

ä½¿ç”¨`explain()`æ˜¯ä¼˜åŒ–æŸ¥è¯¢çš„å…³é”®å·¥å…·ï¼š

```javascript
// åˆ†ææŸ¥è¯¢è®¡åˆ’
db.orders.find({ status: "COMPLETED", order_date: { $gt: ISODate("2023-01-01") } })
  .sort({ total_amount: -1 })
  .explain("executionStats")
```

å…³æ³¨ä»¥ä¸‹æ‰§è¡Œè®¡åˆ’ä¿¡æ¯ï¼š
- **COLLSCAN vs. IXSCAN**ï¼šå…¨è¡¨æ‰«ævsç´¢å¼•æ‰«æ
- **indexBounds**ï¼šç´¢å¼•ä½¿ç”¨èŒƒå›´
- **nReturned vs. totalKeysExamined**ï¼šè¿”å›æ–‡æ¡£æ•°vsæ£€æŸ¥çš„ç´¢å¼•é”®æ•°
- **executionTimeMillis**ï¼šæ‰§è¡Œæ—¶é—´

#### 5.4.2 æŠ•å½±ä¼˜åŒ–

ä»…æŸ¥è¯¢éœ€è¦çš„å­—æ®µå¯ä»¥æ˜¾è‘—æé«˜æ€§èƒ½ï¼š

```javascript
// ä¸å¥½çš„åšæ³•ï¼šè¿”å›æ‰€æœ‰å­—æ®µ
db.products.find({ category: "electronics" })

// å¥½çš„åšæ³•ï¼šåªè¿”å›éœ€è¦çš„å­—æ®µ
db.products.find(
  { category: "electronics" }, 
  { name: 1, price: 1, stock: 1, _id: 0 }
)
```

#### 5.4.3 æ‰¹é‡æ“ä½œä¼˜åŒ–

```javascript
// å•æ¡æ’å…¥ï¼ˆæ•ˆç‡ä½ï¼‰
for (let i = 0; i < 10000; i++) {
  db.items.insertOne({ value: i });
}

// æ‰¹é‡æ’å…¥ï¼ˆæ•ˆç‡é«˜ï¼‰
const items = [];
for (let i = 0; i < 10000; i++) {
  items.push({ value: i });
}
db.items.insertMany(items, { ordered: false });
```

#### 5.4.4 è¯»å–åˆ†ç¦»ä¸æŸ¥è¯¢è·¯ç”±

ä½¿ç”¨è¯»åå¥½è®¾ç½®å¯ä»¥ä¼˜åŒ–è¯»å–æ€§èƒ½ï¼š

```javascript
// åœ¨Node.jsé©±åŠ¨ä¸­é…ç½®
const client = new MongoClient(uri, {
  readPreference: 'secondaryPreferred',
  // å…¶ä»–é€‰é¡¹...
});

// é’ˆå¯¹å…·ä½“æ“ä½œè®¾ç½®
db.collection('orders').find().readPref('secondary');
```

### 5.5 é«˜çº§æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

#### 5.5.1 æ•°æ®åˆ†ç‰‡ç­–ç•¥

æœ‰æ•ˆçš„åˆ†ç‰‡ç­–ç•¥å¯¹å¤§è§„æ¨¡éƒ¨ç½²è‡³å…³é‡è¦ï¼š

```javascript
// é€‰æ‹©æ­£ç¡®çš„åˆ†ç‰‡é”®
// 1. å¯¹äºå†™å…¥å¯†é›†å‹å·¥ä½œè´Ÿè½½:
sh.shardCollection("database.logs", { timestamp: 1 }) // æ—¶é—´æˆ³åˆ†ç‰‡

// 2. å¯¹äºè¯»å–å¯†é›†å‹å·¥ä½œè´Ÿè½½:
sh.shardCollection("database.users", { country: 1, user_id: 1 }) // å¤åˆåˆ†ç‰‡é”®

// 3. å‡åŒ€åˆ†å¸ƒçš„å“ˆå¸Œåˆ†ç‰‡
sh.shardCollection("database.messages", { _id: "hashed" }) // é¿å…çƒ­ç‚¹
```

#### 5.5.2 æ•°æ®å‹ç¼©ä¸å½’æ¡£

å¤„ç†å†å²æ•°æ®çš„ç­–ç•¥ï¼š

```javascript
// æ—¶é—´åºåˆ—æ•°æ®å½’æ¡£ç¤ºä¾‹
// 1. åˆ›å»ºæŒ‰æœˆå½’æ¡£é›†åˆ
db.createCollection("logs_archive_202301")

// 2. å¤åˆ¶ä¸€æœˆæ•°æ®åˆ°å½’æ¡£é›†åˆ
db.logs.aggregate([
  { $match: { timestamp: { $gte: ISODate("2023-01-01"), $lt: ISODate("2023-02-01") } } },
  { $out: "logs_archive_202301" }
])

// 3. åˆ é™¤åŸé›†åˆä¸­çš„å½’æ¡£æ•°æ®
db.logs.deleteMany({ timestamp: { $gte: ISODate("2023-01-01"), $lt: ISODate("2023-02-01") } })
```

#### 5.5.3 ç¼“å­˜ç­–ç•¥

```javascript
// åˆ›å»ºTTLç´¢å¼•ç”¨äºç¼“å­˜é›†åˆ
db.cache.createIndex({ "createdAt": 1 }, { expireAfterSeconds: 3600 }) // ä¸€å°æ—¶åè¿‡æœŸ

// ç‰©åŒ–è§†å›¾å®ç°
db.createView("active_users_view", "users", [
  { $match: { status: "active" } },
  { $project: { name: 1, email: 1, last_login: 1 } }
])
```

#### 5.5.4 Change Streamsä¸å®æ—¶ç›‘æ§

```javascript
// ç›‘æ§é›†åˆå˜åŒ–è¿›è¡Œç¼“å­˜å¤±æ•ˆ
const changeStream = db.products.watch();
changeStream.on('change', (change) => {
  if (change.operationType === 'update' || change.operationType === 'replace') {
    // æ¸…é™¤ç¼“å­˜
    cache.del(`product:${change.documentKey._id}`);
  }
});
```

### 5.6 æ€§èƒ½æµ‹è¯•ä¸åŸºå‡†

ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§æ“ä½œçš„æ€§èƒ½åŸºå‡†æ¯”è¾ƒï¼š

| æ“ä½œç±»å‹ | ä¼˜åŒ–å‰(ms) | ä¼˜åŒ–å(ms) | æ”¹è¿› |
|---------|-----------|-----------|------|
| å¤§å‹é›†åˆç‚¹æŸ¥è¯¢ | 120 | 5 | åˆ›å»ºäº†ç²¾ç¡®ç´¢å¼• |
| åˆ†é¡µæŸ¥è¯¢(è·³è¿‡1000æ¡) | 350 | 30 | ä½¿ç”¨æ¸¸æ ‡åˆ†é¡µä»£æ›¿skip |
| å¤æ‚èšåˆæ“ä½œ | 1200 | 300 | åˆ›å»ºç‰©åŒ–è§†å›¾é¢„è®¡ç®— |
| æ‰¹é‡æ’å…¥(10000æ¡) | 5000 | 800 | ä½¿ç”¨æ‰¹å¤„ç†å’Œunorderedæ’å…¥ |

### 5.7 ç›‘æ§ä¸é¢„è­¦

æœ‰æ•ˆçš„ç›‘æ§æ˜¯æ€§èƒ½ä¼˜åŒ–çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼š

1. **å…³é”®æŒ‡æ ‡ç›‘æ§**ï¼š
   - æ“ä½œå»¶è¿Ÿ
   - è¿æ¥æ•°
   - é”ç­‰å¾…
   - å†…å­˜ä½¿ç”¨
   - æŸ¥è¯¢ç‡

2. **ç›‘æ§å·¥å…·**ï¼š
   - MongoDB Atlasç›‘æ§
   - Prometheus + Grafana
   - mongostatå’Œmongotop
   - æ—¥å¿—åˆ†æ

3. **é¢„è­¦æœºåˆ¶**ï¼š
   - å“åº”æ—¶é—´è¶…é˜ˆå€¼è­¦æŠ¥
   - è¿æ¥æ•°æ¥è¿‘æœ€å¤§å€¼è­¦æŠ¥
   - ç£ç›˜ç©ºé—´ä¸è¶³è­¦æŠ¥
   - å¤åˆ¶é›†å»¶è¿Ÿè­¦æŠ¥

## 6. æœ€ä½³å®è·µä¸è®¾è®¡æ¨¡å¼

### 6.1 MongoDBæ¶æ„è®¾è®¡æœ€ä½³å®è·µ

#### 6.1.1 é«˜å¯ç”¨æ€§è®¾è®¡

**å¤åˆ¶é›†æœ€ä½³å®è·µ**ï¼š
- ä½¿ç”¨è‡³å°‘3ä¸ªèŠ‚ç‚¹çš„å¤åˆ¶é›†ï¼ˆ2ä¸ªæ•°æ®èŠ‚ç‚¹+1ä¸ªä»²è£èŠ‚ç‚¹ï¼‰
- åœ¨ä¸åŒæœåŠ¡å™¨/æœºæ¶/æ•°æ®ä¸­å¿ƒéƒ¨ç½²èŠ‚ç‚¹
- é…ç½®é€‚å½“çš„å†™å…¥å…³æ³¨çº§åˆ«(w: "majority")
- å®æ–½é€‚å½“çš„å¿ƒè·³è¶…æ—¶è®¾ç½®

```javascript
// åˆ›å»ºå¤åˆ¶é›†ç¤ºä¾‹é…ç½®
rs.initiate({
  _id: "rs0",
  members: [
    { _id: 0, host: "server1:27017", priority: 2 },  // ä¼˜å…ˆæˆä¸ºä¸»èŠ‚ç‚¹
    { _id: 1, host: "server2:27017", priority: 1 },
    { _id: 2, host: "server3:27017", priority: 1 }
  ],
  settings: {
    heartbeatTimeoutSecs: 10,
    electionTimeoutMillis: 10000
  }
})
```

**åˆ†ç‰‡é›†ç¾¤æœ€ä½³å®è·µ**ï¼š
- æ¯ä¸ªåˆ†ç‰‡ä½¿ç”¨ç‹¬ç«‹å¤åˆ¶é›†
- é…ç½®æœåŠ¡å™¨ä½¿ç”¨ç‹¬ç«‹å¤åˆ¶é›†
- éƒ¨ç½²å¤šä¸ªmongoså®ä¾‹ä½œä¸ºè·¯ç”±æœåŠ¡
- é€‰æ‹©åˆé€‚çš„åˆ†ç‰‡é”®
- å®šæœŸå‡è¡¡æ•°æ®åˆ†å¸ƒ

#### 6.1.2 å¤‡ä»½ä¸æ¢å¤ç­–ç•¥

**å¤‡ä»½é€‰é¡¹**ï¼š

1. **mongodump/mongorestore**ï¼š
```bash
# å…¨é‡å¤‡ä»½
mongodump --uri="mongodb://user:password@localhost:27017/mydatabase" --out=/backup/mongodb/$(date +"%Y-%m-%d")

# æ¢å¤
mongorestore --uri="mongodb://user:password@localhost:27017/" --dir=/backup/mongodb/2023-05-15
```

2. **æ–‡ä»¶ç³»ç»Ÿå¿«ç…§**ï¼š
   - é…ç½®å­˜å‚¨ç³»ç»Ÿæ”¯æŒä¸€è‡´æ€§å¿«ç…§
   - ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿæˆ–äº‘æœåŠ¡æä¾›çš„å¿«ç…§åŠŸèƒ½

3. **oplogå¤‡ä»½**ï¼š
```bash
# å¤‡ä»½oplogç”¨äºæ—¶é—´ç‚¹æ¢å¤
mongodump --uri="mongodb://user:password@localhost:27017/local" --collection=oplog.rs --out=/backup/oplog/$(date +"%Y-%m-%d")
```

**æ¢å¤è®¡åˆ’**ï¼š
- åˆ¶å®šæ˜ç¡®çš„RTO(æ¢å¤æ—¶é—´ç›®æ ‡)å’ŒRPO(æ¢å¤ç‚¹ç›®æ ‡)
- å®šæœŸæµ‹è¯•å¤‡ä»½æœ‰æ•ˆæ€§
- è®°å½•æ¢å¤æ­¥éª¤å¹¶è¿›è¡Œæ¼”ç»ƒ

#### 6.1.3 å®‰å…¨æœ€ä½³å®è·µ

**å®‰å…¨åŸºç¡€**ï¼š
- å¯ç”¨èº«ä»½éªŒè¯å’Œæˆæƒ
- ä½¿ç”¨å¼ºå¯†ç å’Œæœ€å°æƒé™åŸåˆ™
- å¯ç”¨TLS/SSLåŠ å¯†
- å®æ–½ç½‘ç»œéš”ç¦»å’Œé˜²ç«å¢™ä¿æŠ¤

**é«˜çº§å®‰å…¨æªæ–½**ï¼š
- å®æ–½LDAPæˆ–Kerberosé›†æˆ
- é…ç½®å­—æ®µçº§åŠ å¯†ä¿æŠ¤æ•æ„Ÿæ•°æ®
- å¯ç”¨å®¡è®¡åŠŸèƒ½è®°å½•å…³é”®æ“ä½œ
- å®šæœŸå®‰å…¨æ‰«æå’Œæ›´æ–°

```javascript
// åˆ›å»ºåªè¯»ç”¨æˆ·ç¤ºä¾‹
use reporting
db.createUser({
  user: "reporting_user",
  pwd: "strong_password_here",
  roles: [
    { role: "read", db: "reporting" },
    { role: "readAnyDatabase", db: "admin" }
  ],
  authenticationRestrictions: [
    { clientSource: ["192.168.1.0/24"] }  // IPé™åˆ¶
  ]
})
```

### 6.2 å¸¸è§åº”ç”¨åœºæ™¯æ¨¡å¼

#### 6.2.1 ç‰©è”ç½‘æ•°æ®ç®¡ç†

IoTåº”ç”¨é€šå¸¸äº§ç”Ÿå¤§é‡æ—¶åºæ•°æ®ï¼š

```javascript
// ä½¿ç”¨æ—¶é—´åºåˆ—é›†åˆï¼ˆMongoDB 5.0+ï¼‰
db.createCollection("device_readings", {
  timeseries: {
    timeField: "timestamp",
    metaField: "device_id",
    granularity: "minutes"
  }
})

// æ’å…¥ä¼ æ„Ÿå™¨æ•°æ®
db.device_readings.insertOne({
  timestamp: ISODate("2023-06-01T10:15:30Z"),
  device_id: "thermostat-1",
  temperature: 22.5,
  humidity: 45,
  battery: 87
})
```

**IoTæ•°æ®ç®¡ç†æœ€ä½³å®è·µ**ï¼š
- ä½¿ç”¨åˆ†ç‰‡æŒ‰è®¾å¤‡IDæˆ–æ—¶é—´èŒƒå›´åˆ†å¸ƒæ•°æ®
- å®æ–½TTLç´¢å¼•æˆ–å½’æ¡£ç­–ç•¥ç®¡ç†æ•°æ®ç”Ÿå‘½å‘¨æœŸ
- ä½¿ç”¨é¢„èšåˆé™ä½å®æ—¶åˆ†ææˆæœ¬
- è€ƒè™‘å‹ç¼©å­˜å‚¨å‡å°‘ç©ºé—´å ç”¨

#### 6.2.2 å®æ—¶åˆ†æç³»ç»Ÿ

ä½¿ç”¨MongoDBè¿›è¡Œå®æ—¶åˆ†æï¼š

```javascript
// ä½¿ç”¨Change Streamsè·Ÿè¸ªå®æ—¶å˜åŒ–
const pipeline = [
  { $match: { "operationType": { $in: ["insert", "update", "replace"] } } },
  { $match: { "fullDocument.important_flag": true } }
];

const changeStream = db.collection('events').watch(pipeline);
changeStream.on('change', (change) => {
  // å¤„ç†é‡è¦äº‹ä»¶ï¼Œæ›´æ–°ä»ªè¡¨æ¿ç­‰
  updateDashboard(change.fullDocument);
});
```

**å®æ—¶åˆ†ææœ€ä½³å®è·µ**ï¼š
- åˆ›å»ºé’ˆå¯¹åˆ†ææŸ¥è¯¢çš„ä¸“ç”¨è§†å›¾å’Œç´¢å¼•
- ä½¿ç”¨ç‰©åŒ–è§†å›¾é¢„è®¡ç®—å¸¸ç”¨èšåˆ
- åˆ©ç”¨è¯»å–åå¥½ä»æ¬¡è¦èŠ‚ç‚¹è¯»å–é™ä½ä¸»èŠ‚ç‚¹è´Ÿæ‹…
- ç»“åˆå†…å­˜æ•°æ®åº“æˆ–æµå¤„ç†ç³»ç»Ÿå¤„ç†æç«¯å®æ—¶éœ€æ±‚

#### 6.2.3 å†…å®¹ç®¡ç†ç³»ç»Ÿ

MongoDBé€‚åˆå­˜å‚¨å’Œç®¡ç†å„ç§å†…å®¹ï¼š

```javascript
// å†…å®¹æ–‡æ¡£ç¤ºä¾‹
db.articles.insertOne({
  title: "MongoDBæœ€ä½³å®è·µ",
  slug: "mongodb-best-practices",
  content: "æ­£æ–‡å†…å®¹...",
  author: ObjectId("author_id"),
  status: "published",
  categories: ["database", "nosql", "performance"],
  tags: ["mongodb", "optimization", "schema-design"],
  created_at: ISODate("2023-06-01T09:00:00Z"),
  updated_at: ISODate("2023-06-05T14:30:00Z"),
  comments: [
    {
      user: ObjectId("user_id"),
      text: "éå¸¸æœ‰å¸®åŠ©çš„æ–‡ç« !",
      created_at: ISODate("2023-06-02T10:15:00Z")
    }
  ],
  metadata: {
    views: 1250,
    likes: 42,
    reading_time: 8  // åˆ†é’Ÿ
  }
})

// åˆ›å»ºå…¨æ–‡ç´¢å¼•æ”¯æŒæœç´¢
db.articles.createIndex(
  { title: "text", content: "text", tags: "text" },
  { weights: { title: 10, content: 5, tags: 3 } }
)
```

**CMSæœ€ä½³å®è·µ**ï¼š
- ä½¿ç”¨GridFSå­˜å‚¨å¤§å‹æ–‡ä»¶å’Œåª’ä½“
- å®æ–½ç‰ˆæœ¬æ§åˆ¶æ¨¡å¼è·Ÿè¸ªå†…å®¹ä¿®æ”¹
- åˆ›å»ºå¤åˆç´¢å¼•æ”¯æŒå¸¸è§è¿‡æ»¤å’Œæ’åº
- ä½¿ç”¨æŠ•å½±é™åˆ¶è¿”å›ç‰¹å®šå­—æ®µæé«˜æ€§èƒ½

#### 6.2.4 ç§»åŠ¨åº”ç”¨åç«¯

ä¸ºç§»åŠ¨åº”ç”¨è®¾è®¡MongoDBåç«¯ï¼š

```javascript
// ç”¨æˆ·æ¨¡å¼ç¤ºä¾‹
const userSchema = {
  username: String,
  email: String,
  profile: {
    name: String,
    avatar: String,
    preferences: Object
  },
  devices: [
    {
      device_id: String,
      platform: String,  // "ios", "android"
      push_token: String,
      last_login: Date
    }
  ],
  status: String,
  created_at: Date
};

// æ•°æ®åŒæ­¥è®¾è®¡
db.user_data.updateOne(
  { user_id: "user123", last_sync: { $lt: ISODate("2023-06-01T10:00:00Z") } },
  { 
    $set: { 
      "sync_status": "pending",
      "last_sync_attempt": new Date()
    } 
  }
);
```

**ç§»åŠ¨åº”ç”¨æœ€ä½³å®è·µ**ï¼š
- å®æ–½æœ‰æ•ˆçš„åŒæ­¥æœºåˆ¶å¤„ç†ç¦»çº¿æ“ä½œ
- ä½¿ç”¨TTLç´¢å¼•ç®¡ç†ä¸´æ—¶æ•°æ®ï¼ˆå¦‚ä¼šè¯ï¼‰
- åˆ›å»ºé’ˆå¯¹åœ°ç†ä½ç½®çš„ç´¢å¼•æ”¯æŒåŸºäºä½ç½®çš„åŠŸèƒ½
- ä¼˜åŒ–æŸ¥è¯¢å‡å°‘ç½‘ç»œæµé‡å’Œç”µæ± æ¶ˆè€—

### 6.3 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

#### 6.3.1 æ•°æ®ä¸€è‡´æ€§æŒ‘æˆ˜

**é—®é¢˜**ï¼šMongoDBçš„åˆ†å¸ƒå¼ç‰¹æ€§å¸¦æ¥ä¸€è‡´æ€§æŒ‘æˆ˜ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ä½¿ç”¨é€‚å½“çš„å†™å…¥å…³æ³¨å’Œè¯»å–åå¥½
- å®æ–½ä¹è§‚å¹¶å‘æ§åˆ¶
- ä½¿ç”¨å¤šæ–‡æ¡£äº‹åŠ¡å¤„ç†å…³é”®æ“ä½œ
- è€ƒè™‘åœ¨åº”ç”¨å±‚å®ç°è¡¥å¿æœºåˆ¶

```javascript
// é«˜ä¸€è‡´æ€§æ“ä½œé…ç½®
db.accounts.updateOne(
  { _id: accountId, balance: { $gte: amount } },
  { $inc: { balance: -amount } },
  { writeConcern: { w: "majority", j: true } }
);
```

#### 6.3.2 æ€§èƒ½ä¸‹é™æ’æŸ¥

**é—®é¢˜**ï¼šéšç€æ•°æ®å¢é•¿ï¼ŒæŸ¥è¯¢æ€§èƒ½å¯èƒ½ä¸‹é™ã€‚

**æ’æŸ¥æ­¥éª¤**ï¼š
1. ä½¿ç”¨`explain()`åˆ†ææ…¢æŸ¥è¯¢
2. æ£€æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…å†µå’Œè¦†ç›–èŒƒå›´
3. è¯„ä¼°å·¥ä½œé›†å¤§å°ä¸å¯ç”¨å†…å­˜
4. åˆ†æç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ
5. æ£€æŸ¥ç½‘ç»œå»¶è¿Ÿå’Œè¿æ¥é—®é¢˜

**è§£å†³æ–¹æ¡ˆ**ï¼š
- åˆ›å»ºæˆ–è°ƒæ•´ç´¢å¼•
- ä¼˜åŒ–æŸ¥è¯¢æ¨¡å¼
- å¢åŠ ç³»ç»Ÿèµ„æº
- è€ƒè™‘åˆ†ç‰‡æˆ–å½’æ¡£æ•°æ®

#### 6.3.3 æ‰©å±•æ€§é—®é¢˜

**é—®é¢˜**ï¼šåº”ç”¨å¢é•¿å¯¼è‡´æ•°æ®åº“å‹åŠ›å¢åŠ ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
- **å‚ç›´æ‰©å±•**ï¼šå¢åŠ å•æœºèµ„æºï¼ˆå†…å­˜ã€CPUã€å­˜å‚¨ï¼‰
- **æ°´å¹³æ‰©å±•**ï¼šå®æ–½åˆ†ç‰‡é›†ç¾¤
- **åŠŸèƒ½åˆ†è§£**ï¼šå°†ä¸åŒæ•°æ®é›†åˆ†æ•£åˆ°ä¸åŒå®ä¾‹
- **è¯»å†™åˆ†ç¦»**ï¼šé…ç½®è¯»å–åå¥½ä»æ¬¡è¦èŠ‚ç‚¹è¯»å–

```javascript
// å®æ–½è¯»å†™åˆ†ç¦»
// å†™æ“ä½œä½¿ç”¨é»˜è®¤é…ç½®
db.orders.insertOne({ ... });

// è¯»æ“ä½œä½¿ç”¨secondaryPreferred
db.orders.find({ status: "pending" }).readPref("secondaryPreferred");
```

#### 6.3.4 è¿ç§»ä¸ç‰ˆæœ¬å‡çº§

**é—®é¢˜**ï¼šæ•°æ®åº“è¿ç§»å’Œç‰ˆæœ¬å‡çº§å­˜åœ¨é£é™©ã€‚

**æœ€ä½³å®è·µ**ï¼š
- åˆ¶å®šè¯¦ç»†çš„è¿ç§»è®¡åˆ’å’Œå›æ»šç­–ç•¥
- åœ¨æµ‹è¯•ç¯å¢ƒå®Œæ•´éªŒè¯å‡çº§æµç¨‹
- ä½¿ç”¨æ»šåŠ¨å‡çº§å‡å°‘åœæœºæ—¶é—´
- ç›‘æ§æ•´ä¸ªè¿‡ç¨‹çš„ç³»ç»Ÿå¥åº·çŠ¶æ€
- ä¿ç•™è¶³å¤Ÿçš„å¤‡ä»½ä»¥é˜²æ„å¤–

```bash
# æ»šåŠ¨å‡çº§å¤åˆ¶é›†ç¤ºä¾‹ï¼ˆæ¯æ¬¡ä¸€ä¸ªèŠ‚ç‚¹ï¼‰
# 1. å‡çº§æ¬¡è¦èŠ‚ç‚¹
ssh secondary1
sudo systemctl stop mongod
sudo apt update && sudo apt install -y mongodb-org
sudo systemctl start mongod

# 2. ç­‰å¾…åŒæ­¥å®Œæˆåç»§ç»­å…¶ä»–èŠ‚ç‚¹...
```

### 6.4 MongoDBä¸å…¶ä»–æŠ€æœ¯çš„é›†æˆ

#### 6.4.1 MongoDBä¸æ¶ˆæ¯é˜Ÿåˆ—é›†æˆ

å°†MongoDBä¸Kafkaæˆ–RabbitMQé›†æˆå¯ä»¥åˆ›å»ºå¼ºå¤§çš„æ•°æ®ç®¡é“ï¼š

```javascript
// Kafka Consumerå°†æ¶ˆæ¯å†™å…¥MongoDB
kafkaConsumer.on('message', async (message) => {
  try {
    const data = JSON.parse(message.value);
    // æ•°æ®éªŒè¯å’Œè½¬æ¢
    const result = await db.collection('incoming_data').insertOne({
      ...data,
      kafka_offset: message.offset,
      processed_at: new Date()
    });
    // æäº¤åç§»é‡
    kafkaConsumer.commitMessage(message);
  } catch (error) {
    // é”™è¯¯å¤„ç†
    errorLogger.error(`Failed to process message: ${error.message}`);
  }
});
```

**æœ€ä½³å®è·µ**ï¼š
- å®æ–½å¹‚ç­‰æ€§æ“ä½œé¿å…é‡å¤å¤„ç†
- ä½¿ç”¨æ‰¹é‡å†™å…¥æé«˜æ€§èƒ½
- åˆ›å»ºé€‚å½“çš„ç´¢å¼•æ”¯æŒæŸ¥è¯¢æ¨¡å¼
- è€ƒè™‘ä½¿ç”¨Change Streamsè§¦å‘ä¸‹æ¸¸å¤„ç†

#### 6.4.2 MongoDBä¸æœç´¢å¼•æ“é›†æˆ

MongoDBå¯ä»¥ä¸Elasticsearchç­‰æœç´¢å¼•æ“ååŒå·¥ä½œï¼š

```javascript
// MongoDB Change Streamè§¦å‘Elasticsearchç´¢å¼•æ›´æ–°
const changeStream = db.collection('products').watch();

changeStream.on('change', async (change) => {
  if (change.operationType === 'insert' || change.operationType === 'update') {
    // è½¬æ¢ä¸ºæœç´¢å¼•æ“æ–‡æ¡£
    const searchDoc = transformToSearchDocument(change.fullDocument);
    
    // æ›´æ–°æœç´¢å¼•æ“
    await elasticClient.index({
      index: 'products',
      id: change.fullDocument._id.toString(),
      body: searchDoc
    });
  } else if (change.operationType === 'delete') {
    // ä»æœç´¢å¼•æ“ä¸­åˆ é™¤
    await elasticClient.delete({
      index: 'products',
      id: change.documentKey._id.toString()
    });
  }
});
```

#### 6.4.3 MongoDBä¸ç¼“å­˜ç³»ç»Ÿé›†æˆ

å°†MongoDBä¸Redisç­‰ç¼“å­˜ç³»ç»Ÿç»“åˆä½¿ç”¨ï¼š

```javascript
// ä½¿ç”¨ç¼“å­˜-ç©¿é€ç­–ç•¥
async function getProductById(id) {
  // æ£€æŸ¥ç¼“å­˜
  const cachedProduct = await redisClient.get(`product:${id}`);
  if (cachedProduct) {
    return JSON.parse(cachedProduct);
  }
  
  // ç¼“å­˜æœªå‘½ä¸­ï¼Œä»MongoDBè·å–
  const product = await db.collection('products').findOne({ _id: ObjectId(id) });
  
  if (product) {
    // å­˜å‚¨åˆ°ç¼“å­˜ï¼ˆè®¾ç½®30åˆ†é’Ÿè¿‡æœŸï¼‰
    await redisClient.setex(`product:${id}`, 1800, JSON.stringify(product));
  }
  
  return product;
}
```

### 6.5 æœªæ¥è¶‹åŠ¿ä¸æŠ€æœ¯å±•æœ›

MongoDBæŒç»­å‘å±•ï¼Œä»¥ä¸‹æ˜¯å€¼å¾—å…³æ³¨çš„è¶‹åŠ¿ï¼š

#### 6.5.1 åˆ†å¸ƒå¼å¤šæ–‡æ¡£ACIDäº‹åŠ¡

MongoDB 4.0+æ”¯æŒå¤šæ–‡æ¡£äº‹åŠ¡ï¼Œä½¿å…¶èƒ½å¤Ÿå¤„ç†æ›´å¤æ‚çš„äº‹åŠ¡æ€§å·¥ä½œè´Ÿè½½ï¼š

```javascript
// ä½¿ç”¨äº‹åŠ¡å®ç°è´¦æˆ·è½¬è´¦
const session = client.startSession();
session.startTransaction();

try {
  await db.collection('accounts').updateOne(
    { _id: fromAccount, balance: { $gte: amount } },
    { $inc: { balance: -amount } },
    { session }
  );
  
  await db.collection('accounts').updateOne(
    { _id: toAccount },
    { $inc: { balance: amount } },
    { session }
  );
  
  await db.collection('transfers').insertOne(
    {
      from: fromAccount,
      to: toAccount,
      amount: amount,
      date: new Date()
    },
    { session }
  );
  
  await session.commitTransaction();
} catch (error) {
  await session.abortTransaction();
  throw error;
} finally {
  session.endSession();
}
```

#### 6.5.2 äº‘åŸç”Ÿå’Œæ— æœåŠ¡å™¨æ•°æ®åº“

MongoDB Atlas serverlessæä¾›äº†è‡ªåŠ¨ç¼©æ”¾çš„äº‘åŸç”Ÿæ•°æ®åº“ä½“éªŒï¼Œæ— éœ€ç®¡ç†åŸºç¡€è®¾æ–½ã€‚

#### 6.5.3 AI/MLä¸MongoDB

MongoDBä¸æœºå™¨å­¦ä¹ é›†æˆæ—¥ç›Šç´§å¯†ï¼š

- ä½¿ç”¨MongoDBå­˜å‚¨è®­ç»ƒæ•°æ®å’Œæ¨¡å‹ç»“æœ
- åˆ©ç”¨èšåˆæ¡†æ¶è¿›è¡Œç‰¹å¾å·¥ç¨‹
- ä½¿ç”¨Atlas Data Lakeåˆ†æå¤§è§„æ¨¡æ•°æ®
- ç»“åˆå‘é‡æœç´¢æ”¯æŒAIåº”ç”¨åœºæ™¯

#### 6.5.4 å®æ—¶åä½œåº”ç”¨

MongoDBç»“åˆChange Streamséå¸¸é€‚åˆæ„å»ºå®æ—¶åä½œåº”ç”¨ï¼š

```javascript
// æœåŠ¡å™¨ç«¯ç›‘æ§æ–‡æ¡£å˜åŒ–å¹¶å¹¿æ’­
const changeStream = db.collection('shared_documents').watch();

changeStream.on('change', (change) => {
  // é€šè¿‡WebSocketå¹¿æ’­å˜åŒ–
  const roomId = change.fullDocument.room_id;
  io.to(roomId).emit('document_updated', {
    documentId: change.fullDocument._id,
    updatedFields: change.updateDescription?.updatedFields,
    operationType: change.operationType
  });
});
```

é€šè¿‡æŒæ¡è¿™äº›æœ€ä½³å®è·µå’Œè®¾è®¡æ¨¡å¼ï¼Œæ‚¨å¯ä»¥å……åˆ†å‘æŒ¥MongoDBçš„æ½œåŠ›ï¼Œæ„å»ºé«˜æ€§èƒ½ã€å¯æ‰©å±•ä¸”å¯é çš„åº”ç”¨ç³»ç»Ÿã€‚ 