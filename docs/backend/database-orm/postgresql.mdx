---
sidebar_position: 5
title: PostgreSQLè¯¦è§£
description: æ·±å…¥ç†è§£PostgreSQLæ ¸å¿ƒç‰¹æ€§ã€ä¼˜åŒ–æŠ€å·§ä¸Spring Booté›†æˆ
authors: [Laby]
tags: [PostgreSQL, å…³ç³»å‹æ•°æ®åº“, JSONB, åœ°ç†ä¿¡æ¯, å…¨æ–‡æœç´¢]
last_update:
  date: 2025-09-01
  author: Laby
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import CodeBlock from '@theme/CodeBlock';

# PostgreSQLè¯¦è§£

PostgreSQLæ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„å¼€æºå¯¹è±¡å…³ç³»å‹æ•°æ®åº“ç³»ç»Ÿï¼Œå…·æœ‰è¶…è¿‡30å¹´çš„ç§¯æå¼€å‘å†å²ï¼Œä»¥å…¶å¯é æ€§ã€ç¨³å®šæ€§ã€ä¸°å¯Œçš„åŠŸèƒ½å’Œé«˜åº¦çš„å¯æ‰©å±•æ€§è‘—ç§°äºä¸–ã€‚ä½œä¸ºä¼ä¸šçº§æ•°æ®åº“çš„ç»ä½³é€‰æ‹©ï¼ŒPostgreSQLåœ¨æ•°æ®å®Œæ•´æ€§ã€å¤æ‚æŸ¥è¯¢ã€ç©ºé—´æ•°æ®å¤„ç†å’ŒNoSQLèƒ½åŠ›ç­‰æ–¹é¢è¡¨ç°å“è¶Šã€‚

:::tip æ ¸å¿ƒä»·å€¼
**PostgreSQL = å¼ºå¤§ç‰¹æ€§ + é«˜åº¦å¯é æ€§ + å¼€æºè‡ªç”± + å“è¶Šæ‰©å±•æ€§**
- ğŸ” **ä¸°å¯Œçš„æ•°æ®ç±»å‹**ï¼šæ”¯æŒJSON(B)ã€æ•°ç»„ã€åœ°ç†ä¿¡æ¯ç­‰å¤šæ ·åŒ–æ•°æ®
- ğŸ›¡ï¸ **å¼ºå¤§çš„å®‰å…¨æœºåˆ¶**ï¼šè¡Œçº§å®‰å…¨ç­–ç•¥ã€ç»†ç²’åº¦è®¿é—®æ§åˆ¶
- ğŸš€ **å‡ºè‰²çš„æ€§èƒ½**ï¼šé«˜æ•ˆç´¢å¼•ã€å¹¶è¡ŒæŸ¥è¯¢ã€ç‰©åŒ–è§†å›¾
- ğŸ§© **æ‰©å±•ç”Ÿæ€ç³»ç»Ÿ**ï¼šPostGISã€TimescaleDBç­‰ä¸°å¯Œæ’ä»¶
- ğŸ’¼ **ä¼ä¸šçº§ç‰¹æ€§**ï¼šäº‹åŠ¡å®Œæ•´æ€§ã€é«˜å¯ç”¨æ€§ã€é€»è¾‘å¤åˆ¶
:::

æœ¬æ–‡å°†æ·±å…¥æ¢è®¨PostgreSQLçš„é«˜çº§ç‰¹æ€§åŠå…¶åœ¨Spring Bootåº”ç”¨ä¸­çš„æœ€ä½³å®è·µï¼Œå¸®åŠ©å¼€å‘è€…å……åˆ†å‘æŒ¥è¿™ä¸€å¼ºå¤§æ•°æ®åº“çš„æ½œåŠ›ã€‚

## 1. PostgreSQLåŸºç¡€ä¸æ ¸å¿ƒæ¦‚å¿µ

PostgreSQLä¸ä»…æ˜¯ä¸€ä¸ªå…³ç³»å‹æ•°æ®åº“ï¼Œæ›´æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ•°æ®å¹³å°ï¼Œæä¾›äº†ä¸°å¯Œçš„åŠŸèƒ½å’Œçµæ´»çš„æ‰©å±•æœºåˆ¶ã€‚åœ¨æ·±å…¥é«˜çº§ç‰¹æ€§å‰ï¼Œè®©æˆ‘ä»¬å…ˆäº†è§£å…¶æ ¸å¿ƒæ¦‚å¿µå’ŒåŸºç¡€æ¶æ„ã€‚

### 1.1 PostgreSQLæ¶æ„æ¦‚è§ˆ

PostgreSQLé‡‡ç”¨å®¢æˆ·ç«¯/æœåŠ¡å™¨æ¶æ„ï¼Œä¸»è¦ç”±ä»¥ä¸‹æ ¸å¿ƒç»„ä»¶æ„æˆï¼š

![PostgreSQLæ¶æ„å›¾](https://postgresql.org/media/img/about/press/elephant.png)

1. **Postmasterè¿›ç¨‹**ï¼šä¸»æœåŠ¡è¿›ç¨‹ï¼Œè´Ÿè´£å¯åŠ¨å’Œç›‘æ§å…¶ä»–è¿›ç¨‹
2. **Backendè¿›ç¨‹**ï¼šå¤„ç†å®¢æˆ·ç«¯è¿æ¥å’ŒæŸ¥è¯¢æ‰§è¡Œ
3. **Backgroundè¿›ç¨‹**ï¼šæ‰§è¡Œå„ç§åå°ä»»åŠ¡ï¼Œå¦‚è‡ªåŠ¨æ¸…ç†ã€é¢„å†™æ—¥å¿—ç­‰
4. **å…±äº«å†…å­˜**ï¼šç”¨äºç¼“å­˜æ•°æ®å’Œå…ƒæ•°æ®ï¼Œæé«˜è®¿é—®é€Ÿåº¦

PostgreSQLçš„æ•°æ®å­˜å‚¨åŸºäº**è¡¨ç©ºé—´**æ¦‚å¿µï¼Œç‰©ç†ä¸Šç”±å¤šä¸ªæ–‡ä»¶ç»„æˆï¼Œé€»è¾‘ä¸ŠåŒ…å«æ•°æ®è¡¨ã€ç´¢å¼•ã€åºåˆ—ç­‰å¯¹è±¡ã€‚

### 1.2 PostgreSQLä¸å…¶ä»–å…³ç³»å‹æ•°æ®åº“çš„å¯¹æ¯”

| ç‰¹æ€§ | PostgreSQL | MySQL | Oracle |
|------|------------|-------|--------|
| **å¼€æºè®¸å¯** | è‡ªç”±å¼€æº | GPLï¼ˆä¼ä¸šç‰ˆä¸å¼€æºï¼‰ | å•†ä¸šè®¸å¯ |
| **JSONæ”¯æŒ** | åŸç”Ÿæ”¯æŒJSONB | æœ‰é™æ”¯æŒ | 12cåæ”¯æŒ |
| **æ‰©å±•æ€§** | ä¸°å¯Œçš„æ‰©å±•ç³»ç»Ÿ | æœ‰é™çš„æ’ä»¶ç³»ç»Ÿ | å¼ºå¤§ä½†ä¸“æœ‰ |
| **æ•°æ®ç±»å‹** | æå…¶ä¸°å¯Œ | åŸºç¡€ç±»å‹ | ä¸°å¯Œ |
| **å…¨æ–‡æœç´¢** | å†…ç½®æ”¯æŒ | åŸºç¡€æ”¯æŒ | éœ€é¢å¤–ç»„ä»¶ |
| **åœ°ç†ä¿¡æ¯** | PostGISæ‰©å±• | åŸºç¡€æ”¯æŒ | ç©ºé—´æ•°æ®é€‰é¡¹ |
| **æ•°æ®å®Œæ•´æ€§** | å®Œæ•´ACIDæ”¯æŒ | å–å†³äºå­˜å‚¨å¼•æ“ | å®Œæ•´æ”¯æŒ |
| **é«˜å¯ç”¨æ€§** | å†…ç½®æµå¤åˆ¶ | ä¸»ä»å¤åˆ¶ | é«˜çº§HAé€‰é¡¹ |

### 1.3 PostgreSQLç‰ˆæœ¬æ¼”è¿›

PostgreSQLç¤¾åŒºæ¯å¹´å‘å¸ƒä¸€ä¸ªä¸»è¦ç‰ˆæœ¬ï¼Œå‘½åæ–¹å¼ä¸ºä¸»ç‰ˆæœ¬å·+å°ç‰ˆæœ¬å·ï¼ˆä¾‹å¦‚14.5ï¼‰ã€‚ä»¥ä¸‹æ˜¯è¿‘æœŸä¸»è¦ç‰ˆæœ¬çš„å…³é”®ç‰¹æ€§ï¼š

- **PostgreSQL 16**ï¼ˆ2023å¹´ï¼‰ï¼šå¹¶è¡ŒæŸ¥è¯¢å¢å¼ºã€é€»è¾‘å¤åˆ¶æ”¹è¿›ã€æ€§èƒ½ä¼˜åŒ–
- **PostgreSQL 15**ï¼ˆ2022å¹´ï¼‰ï¼šæ€§èƒ½æå‡ã€MERGEå‘½ä»¤ã€é€»è¾‘å¤åˆ¶å¢å¼º
- **PostgreSQL 14**ï¼ˆ2021å¹´ï¼‰ï¼šB-treeç´¢å¼•æ€§èƒ½ä¼˜åŒ–ã€JSONæŸ¥è¯¢æ”¹è¿›
- **PostgreSQL 13**ï¼ˆ2020å¹´ï¼‰ï¼šç´¢å¼•å»é‡ã€å¢é‡æ’åºã€åˆ†åŒºè¡¨å¢å¼º
- **PostgreSQL 12**ï¼ˆ2019å¹´ï¼‰ï¼šç‰©åŒ–è§†å›¾æ”¹è¿›ã€JSONè·¯å¾„æŸ¥è¯¢ã€CTEä¼˜åŒ–

### 1.4 å®‰è£…ä¸åŸºæœ¬é…ç½®

#### 1.4.1 å®‰è£…PostgreSQL

**åœ¨Ubuntu/Debianç³»ç»Ÿä¸Š**ï¼š

```bash
# æ·»åŠ PostgreSQLå®˜æ–¹ä»“åº“
sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
sudo apt-get update

# å®‰è£…PostgreSQL 14
sudo apt-get install postgresql-14 postgresql-contrib-14
```

**åœ¨CentOS/RHELç³»ç»Ÿä¸Š**ï¼š

```bash
# å®‰è£…PostgreSQLä»“åº“
sudo dnf install -y https://download.postgresql.org/pub/repos/yum/reporpms/EL-8-x86_64/pgdg-redhat-repo-latest.noarch.rpm

# å®‰è£…PostgreSQL 14
sudo dnf install -y postgresql14-server postgresql14-contrib
sudo /usr/pgsql-14/bin/postgresql-14-setup initdb
sudo systemctl enable postgresql-14
sudo systemctl start postgresql-14
```

**ä½¿ç”¨Docker**ï¼š

```bash
# æ‹‰å–å®˜æ–¹é•œåƒ
docker pull postgres:14

# è¿è¡ŒPostgreSQLå®¹å™¨
docker run --name postgres -e POSTGRES_PASSWORD=mysecretpassword -d -p 5432:5432 postgres:14
```

#### 1.4.2 åŸºç¡€é…ç½®

PostgreSQLçš„ä¸»è¦é…ç½®æ–‡ä»¶æ˜¯`postgresql.conf`å’Œ`pg_hba.conf`ï¼š

- **postgresql.conf**ï¼šæ•°æ®åº“å‚æ•°é…ç½®
- **pg_hba.conf**ï¼šå®¢æˆ·ç«¯è®¤è¯é…ç½®

é‡è¦é…ç½®å‚æ•°ï¼š

```
# å†…å­˜é…ç½®
shared_buffers = 256MB          # å»ºè®®ä¸ºç³»ç»Ÿå†…å­˜çš„1/4
work_mem = 16MB                 # å¤æ‚æŸ¥è¯¢çš„å·¥ä½œå†…å­˜
maintenance_work_mem = 64MB     # ç»´æŠ¤æ“ä½œçš„å†…å­˜

# è¿æ¥è®¾ç½®
max_connections = 100           # æœ€å¤§å¹¶å‘è¿æ¥æ•°
superuser_reserved_connections = 3 # ä¸ºè¶…çº§ç”¨æˆ·ä¿ç•™çš„è¿æ¥æ•°

# é¢„å†™æ—¥å¿—è®¾ç½®
wal_level = replica            # WALçº§åˆ«ï¼Œæ”¯æŒå¤åˆ¶
max_wal_size = 1GB             # WALæ–‡ä»¶æœ€å¤§å¤§å°
min_wal_size = 80MB            # WALæ–‡ä»¶æœ€å°å¤§å°

# æ€§èƒ½ä¼˜åŒ–
effective_cache_size = 768MB    # æ“ä½œç³»ç»Ÿç¼“å­˜çš„ä¼°è®¡å€¼ï¼Œå»ºè®®ä¸ºç³»ç»Ÿå†…å­˜çš„ä¸€åŠ
```

## 2. PostgreSQLæ ¸å¿ƒç‰¹æ€§ä¸é«˜çº§åŠŸèƒ½

PostgreSQLçš„ä¸ä¼—ä¸åŒä¹‹å¤„åœ¨äºå…¶å¼ºå¤§çš„ä¼ä¸šçº§ç‰¹æ€§å’Œçµæ´»çš„æ‰©å±•æ€§ï¼Œè¿™ä½¿å…¶æˆä¸ºä¼—å¤šå¤æ‚åº”ç”¨çš„ç†æƒ³é€‰æ‹©ã€‚

### 2.1 ä¸°å¯Œçš„æ•°æ®ç±»å‹

PostgreSQLæä¾›äº†æœ€ä¸ºä¸°å¯Œçš„å†…ç½®æ•°æ®ç±»å‹æ”¯æŒï¼š

#### 2.1.1 åŸºç¡€æ•°æ®ç±»å‹

- **æ•°å€¼ç±»å‹**ï¼šinteger, smallint, bigint, numeric(ç²¾ç¡®)ï¼Œreal, double precision(æµ®ç‚¹)
- **å­—ç¬¦ç±»å‹**ï¼šchar(n), varchar(n), text
- **å¸ƒå°”ç±»å‹**ï¼šboolean
- **æ—¥æœŸæ—¶é—´**ï¼šdate, time, timestamp, interval
- **äºŒè¿›åˆ¶**ï¼šbytea
- **è´§å¸ç±»å‹**ï¼šmoney
- **UUID**ï¼šuuid

#### 2.1.2 é«˜çº§æ•°æ®ç±»å‹

- **JSON/JSONB**ï¼šå­˜å‚¨å’Œå¤„ç†JSONæ•°æ®
- **æ•°ç»„**ï¼šä»»æ„åŸºæœ¬ç±»å‹çš„æ•°ç»„
- **Rangeç±»å‹**ï¼šåŒºé—´æ•°æ®ï¼Œå¦‚æ—¥æœŸåŒºé—´ã€æ•°å€¼åŒºé—´
- **ç½‘ç»œåœ°å€**ï¼šinet, cidr, macaddr
- **å‡ ä½•ç±»å‹**ï¼špoint, line, lseg, box, path, polygon, circle
- **è‡ªå®šä¹‰ç±»å‹**ï¼šé€šè¿‡CREATE TYPEåˆ›å»º

#### 2.1.3 JSONBç¤ºä¾‹

JSONBæ˜¯PostgreSQLçš„äºŒè¿›åˆ¶JSONæ ¼å¼ï¼Œæä¾›æ›´é«˜æ•ˆçš„å­˜å‚¨å’Œç´¢å¼•ï¼š

```sql
CREATE TABLE products (
  id SERIAL PRIMARY KEY,
  name TEXT NOT NULL,
  attributes JSONB
);

-- æ’å…¥JSONBæ•°æ®
INSERT INTO products (name, attributes) 
VALUES ('Laptop', '{"brand": "ThinkPad", "model": "X1 Carbon", "specs": {"cpu": "i7", "ram": 16, "storage": 512}}');

-- ä½¿ç”¨JSONæ“ä½œç¬¦æŸ¥è¯¢
SELECT * FROM products WHERE attributes @> '{"brand": "ThinkPad"}';

-- åˆ›å»ºGINç´¢å¼•åŠ é€ŸJSONBæŸ¥è¯¢
CREATE INDEX idx_products_attributes ON products USING GIN (attributes);

-- ä½¿ç”¨JSONè·¯å¾„æå–æ•°æ®
SELECT id, name, attributes->'brand' AS brand, attributes->'specs'->>'cpu' AS cpu
FROM products;
```

#### 2.1.4 æ•°ç»„ç±»å‹ç¤ºä¾‹

```sql
CREATE TABLE survey_responses (
  id SERIAL PRIMARY KEY,
  user_id INTEGER NOT NULL,
  answers TEXT[]
);

-- æ’å…¥æ•°ç»„æ•°æ®
INSERT INTO survey_responses (user_id, answers) 
VALUES (1, ARRAY['Yes', 'No', 'Maybe', 'Yes']);

-- æ•°ç»„æŸ¥è¯¢
SELECT * FROM survey_responses WHERE answers[2] = 'No';

-- æ•°ç»„åŒ…å«
SELECT * FROM survey_responses WHERE 'Yes' = ANY(answers);

-- æ•°ç»„æ“ä½œ
SELECT id, array_length(answers, 1) AS answer_count 
FROM survey_responses;
```

### 2.2 äº‹åŠ¡å’Œå¹¶å‘æ§åˆ¶

PostgreSQLæä¾›äº†å®Œæ•´çš„ACIDäº‹åŠ¡æ”¯æŒå’Œå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶(MVCC)ã€‚

#### 2.2.1 äº‹åŠ¡éš”ç¦»çº§åˆ«

PostgreSQLæ”¯æŒå››ç§äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼š

| éš”ç¦»çº§åˆ« | è„è¯» | ä¸å¯é‡å¤è¯» | å¹»è¯» | ä¸²è¡ŒåŒ–å¼‚å¸¸ |
|---------|------|-----------|------|----------|
| Read Uncommitted | ä¸å¯èƒ½* | å¯èƒ½ | å¯èƒ½ | å¯èƒ½ |
| Read Committed | ä¸å¯èƒ½ | å¯èƒ½ | å¯èƒ½ | å¯èƒ½ |
| Repeatable Read | ä¸å¯èƒ½ | ä¸å¯èƒ½ | ä¸å¯èƒ½** | å¯èƒ½ |
| Serializable | ä¸å¯èƒ½ | ä¸å¯èƒ½ | ä¸å¯èƒ½ | ä¸å¯èƒ½ |

*PostgreSQLå°†Read Uncommittedè§†ä¸ºRead Committed
**PostgreSQLçš„Repeatable Readé˜»æ­¢äº†å¹»è¯»ï¼Œè¿™ä¸åŒäºæ ‡å‡†SQL

```sql
-- è®¾ç½®äº‹åŠ¡éš”ç¦»çº§åˆ«
BEGIN;
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;
-- æ‰§è¡Œæ“ä½œ
COMMIT;
```

#### 2.2.2 MVCCåŸç†

PostgreSQLçš„MVCC(å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶)å…è®¸è¯»æ“ä½œä¸é˜»å¡å†™æ“ä½œï¼Œåä¹‹äº¦ç„¶ï¼š

- æ¯è¡Œæ•°æ®å­˜å‚¨æœ‰åˆ›å»ºäº‹åŠ¡ID(xmin)å’Œåˆ é™¤äº‹åŠ¡ID(xmax)
- æŸ¥è¯¢åªèƒ½çœ‹åˆ°åœ¨æŸ¥è¯¢äº‹åŠ¡å¼€å§‹å‰å·²æäº¤çš„æ•°æ®ç‰ˆæœ¬
- æ—§ç‰ˆæœ¬é€šè¿‡VACUUMè¿›ç¨‹æ¸…ç†

è¿™ä½¿å¾—PostgreSQLèƒ½å¤Ÿåœ¨ç»´æŒäº‹åŠ¡ä¸€è‡´æ€§çš„åŒæ—¶å®ç°é«˜å¹¶å‘ã€‚

### 2.3 é«˜çº§ç´¢å¼•ç±»å‹

PostgreSQLæ”¯æŒå¤šç§ç´¢å¼•ç±»å‹ï¼Œé€‚ç”¨äºä¸åŒåœºæ™¯ï¼š

#### 2.3.1 B-treeç´¢å¼•

é»˜è®¤ç´¢å¼•ç±»å‹ï¼Œé€‚ç”¨äºç­‰å€¼ã€èŒƒå›´æŸ¥è¯¢ï¼š

```sql
CREATE INDEX idx_user_email ON users(email);
```

#### 2.3.2 Hashç´¢å¼•

é€‚ç”¨äºç­‰å€¼æŸ¥è¯¢ï¼ŒPostgreSQL 10+æ€§èƒ½æ˜¾è‘—æå‡ï¼š

```sql
CREATE INDEX idx_user_uuid ON users USING HASH (uuid);
```

#### 2.3.3 GiSTç´¢å¼•(é€šç”¨æœç´¢æ ‘)

é€‚ç”¨äºå…¨æ–‡æœç´¢ã€åœ°ç†æ•°æ®ã€èŒƒå›´ç±»å‹ç­‰ï¼š

```sql
CREATE INDEX idx_location ON places USING GIST (location);
```

#### 2.3.4 GINç´¢å¼•(é€šç”¨å€’æ’ç´¢å¼•)

é€‚ç”¨äºåŒ…å«å¤šä¸ªå…ƒç´ çš„å€¼ï¼Œå¦‚æ•°ç»„ã€JSONBã€å…¨æ–‡æœç´¢ï¼š

```sql
CREATE INDEX idx_document_tags ON documents USING GIN (tags);
CREATE INDEX idx_product_attrs ON products USING GIN (attributes);
```

#### 2.3.5 BRINç´¢å¼•(å—èŒƒå›´ç´¢å¼•)

é€‚ç”¨äºçº¿æ€§æ’åºçš„è¶…å¤§è¡¨ï¼Œå¦‚æ—¶é—´åºåˆ—æ•°æ®ï¼š

```sql
CREATE INDEX idx_logs_time ON logs USING BRIN (timestamp);
```

#### 2.3.6 éƒ¨åˆ†ç´¢å¼•å’Œè¡¨è¾¾å¼ç´¢å¼•

ä»…ç´¢å¼•æ»¡è¶³ç‰¹å®šæ¡ä»¶çš„è¡Œæˆ–è¡¨è¾¾å¼ç»“æœï¼š

```sql
-- éƒ¨åˆ†ç´¢å¼•ï¼Œåªä¸ºæ´»è·ƒç”¨æˆ·å»ºç´¢å¼•
CREATE INDEX idx_active_users ON users (email) WHERE active = true;

-- è¡¨è¾¾å¼ç´¢å¼•ï¼Œç´¢å¼•å°å†™ç”µå­é‚®ä»¶
CREATE INDEX idx_user_lower_email ON users (lower(email));
```

### 2.4 å…¨æ–‡æœç´¢åŠŸèƒ½

PostgreSQLå†…ç½®äº†å¼ºå¤§çš„å…¨æ–‡æœç´¢èƒ½åŠ›ï¼š

#### 2.4.1 åŸºæœ¬å…¨æ–‡æœç´¢

```sql
CREATE TABLE articles (
  id SERIAL PRIMARY KEY,
  title TEXT,
  body TEXT
);

-- åˆ›å»ºtsvectoråˆ—
ALTER TABLE articles ADD COLUMN tsv TSVECTOR;

-- æ›´æ–°tsvectorï¼Œç»“åˆæ ‡é¢˜å’Œæ­£æ–‡ï¼Œæƒé‡ä¸åŒ
UPDATE articles SET tsv = 
  setweight(to_tsvector('english', title), 'A') || 
  setweight(to_tsvector('english', body), 'B');

-- åˆ›å»ºGINç´¢å¼•
CREATE INDEX idx_articles_tsv ON articles USING GIN (tsv);

-- å…¨æ–‡æœç´¢æŸ¥è¯¢
SELECT id, title 
FROM articles
WHERE tsv @@ to_tsquery('english', 'postgresql & database')
ORDER BY ts_rank(tsv, to_tsquery('english', 'postgresql & database')) DESC;
```

#### 2.4.2 ä½¿ç”¨è§¦å‘å™¨è‡ªåŠ¨æ›´æ–°æœç´¢å‘é‡

```sql
CREATE FUNCTION articles_update_trigger() RETURNS trigger AS $$
BEGIN
  NEW.tsv := 
    setweight(to_tsvector('english', NEW.title), 'A') ||
    setweight(to_tsvector('english', NEW.body), 'B');
  RETURN NEW;
END
$$ LANGUAGE plpgsql;

CREATE TRIGGER tsvector_update BEFORE INSERT OR UPDATE
ON articles FOR EACH ROW EXECUTE PROCEDURE articles_update_trigger();
```

## 3. PostgreSQLå¼ºå¤§çš„æ‰©å±•ç³»ç»Ÿ

PostgreSQLçš„æ‰©å±•ç³»ç»Ÿæ˜¯å…¶æœ€çªå‡ºçš„ç‰¹æ€§ä¹‹ä¸€ï¼Œå…è®¸æ— ç¼é›†æˆå„ç§é«˜çº§åŠŸèƒ½ã€‚

### 3.1 æ‰©å±•æœºåˆ¶æ¦‚è¿°

PostgreSQLæ‰©å±•æ˜¯ä¸€ç»„SQLå¯¹è±¡ï¼Œä½œä¸ºå•ä¸€å®ä½“æ‰“åŒ…ã€å®‰è£…å’Œç§»é™¤ã€‚æ‰©å±•å¯ä»¥åŒ…å«ï¼š

- æ•°æ®ç±»å‹
- å‡½æ•°å’Œå­˜å‚¨è¿‡ç¨‹
- æ“ä½œç¬¦å’Œç´¢å¼•æ–¹æ³•
- è¡¨å’Œè§†å›¾
- å¤–éƒ¨æ•°æ®åŒ…è£…å™¨

å®‰è£…æ‰©å±•é€šå¸¸åªéœ€ä¸€æ¡SQLå‘½ä»¤ï¼š

```sql
CREATE EXTENSION extension_name;
```

### 3.2 å¸¸ç”¨æ‰©å±•è¯¦è§£

#### 3.2.1 PostGIS - åœ°ç†ä¿¡æ¯ç³»ç»Ÿ

PostGISå°†PostgreSQLè½¬å˜ä¸ºå¼ºå¤§çš„ç©ºé—´æ•°æ®åº“ï¼Œæ”¯æŒåœ°ç†å¯¹è±¡çš„å­˜å‚¨å’ŒæŸ¥è¯¢ï¼š

```sql
-- å®‰è£…PostGISæ‰©å±•
CREATE EXTENSION postgis;

-- åˆ›å»ºåŒ…å«åœ°ç†æ•°æ®çš„è¡¨
CREATE TABLE locations (
  id SERIAL PRIMARY KEY,
  name VARCHAR(100),
  location GEOGRAPHY(POINT, 4326)  -- WGS84åæ ‡ç³»
);

-- æ’å…¥åœ°ç†æ•°æ®
INSERT INTO locations (name, location)
VALUES ('New York', ST_MakePoint(-74.0060, 40.7128)::geography);

-- è®¡ç®—ä¸¤ç‚¹ä¹‹é—´çš„è·ç¦»ï¼ˆç±³ï¼‰
SELECT ST_Distance(
  ST_MakePoint(-74.0060, 40.7128)::geography,
  ST_MakePoint(-118.2437, 34.0522)::geography
);

-- æŸ¥è¯¢1åƒç±³èŒƒå›´å†…çš„ç‚¹
SELECT name FROM locations
WHERE ST_DWithin(
  location,
  ST_MakePoint(-74.0060, 40.7128)::geography,
  1000  -- 1000ç±³
);
```

#### 3.2.2 TimescaleDB - æ—¶åºæ•°æ®åº“

TimescaleDBæ˜¯ä¸“ä¸ºæ—¶é—´åºåˆ—æ•°æ®ä¼˜åŒ–çš„æ‰©å±•ï¼Œæä¾›è‡ªåŠ¨åˆ†åŒºã€é«˜æ•ˆæŸ¥è¯¢å’Œå‹ç¼©ï¼š

```sql
-- å®‰è£…TimescaleDB
CREATE EXTENSION timescaledb;

-- åˆ›å»ºæ­£å¸¸è¡¨
CREATE TABLE sensor_data (
  time TIMESTAMPTZ NOT NULL,
  sensor_id INTEGER,
  temperature DOUBLE PRECISION,
  humidity DOUBLE PRECISION
);

-- è½¬æ¢ä¸ºè¶…è¡¨ï¼ˆè‡ªåŠ¨åˆ†åŒºï¼‰
SELECT create_hypertable('sensor_data', 'time');

-- æ’å…¥æ•°æ®
INSERT INTO sensor_data VALUES 
  (NOW(), 1, 25.1, 60.4),
  (NOW() - INTERVAL '1 hour', 1, 24.5, 58.9),
  (NOW() - INTERVAL '2 hour', 1, 23.2, 62.1);

-- æ—¶é—´èšåˆæŸ¥è¯¢
SELECT time_bucket('15 minutes', time) AS interval,
  sensor_id,
  AVG(temperature) AS avg_temp
FROM sensor_data
WHERE time > NOW() - INTERVAL '1 day'
GROUP BY interval, sensor_id
ORDER BY interval DESC;
```

#### 3.2.3 pgvector - å‘é‡ç›¸ä¼¼æ€§æœç´¢

pgvectoræ‰©å±•æ”¯æŒå‘é‡å­˜å‚¨å’Œç›¸ä¼¼æ€§æœç´¢ï¼Œéå¸¸é€‚åˆæœºå™¨å­¦ä¹ å’ŒAIåº”ç”¨ï¼š

```sql
-- å®‰è£…pgvector
CREATE EXTENSION vector;

-- åˆ›å»ºè¡¨ä½¿ç”¨å‘é‡ç±»å‹
CREATE TABLE items (
  id SERIAL PRIMARY KEY,
  embedding vector(384)  -- 384ç»´å‘é‡
);

-- æ’å…¥å‘é‡æ•°æ®
INSERT INTO items (embedding) VALUES ('[0.1, 0.2, 0.3, ...]');

-- å‘é‡ç›¸ä¼¼æ€§æœç´¢ï¼ˆæ¬§æ°è·ç¦»ï¼‰
SELECT * FROM items
ORDER BY embedding <-> '[0.2, 0.3, 0.4, ...]'
LIMIT 5;

-- åˆ›å»ºç´¢å¼•åŠ é€Ÿå‘é‡æœç´¢
CREATE INDEX idx_items_embedding ON items USING ivfflat (embedding vector_l2_ops);
```

#### 3.2.4 pg_stat_statements - SQLæ€§èƒ½ç›‘æ§

æ­¤æ‰©å±•æä¾›SQLè¯­å¥æ‰§è¡Œç»Ÿè®¡ï¼Œå¸®åŠ©è¯†åˆ«æ€§èƒ½é—®é¢˜ï¼š

```sql
-- å®‰è£…æ‰©å±•
CREATE EXTENSION pg_stat_statements;

-- æŸ¥è¯¢æœ€è€—æ—¶çš„SQL
SELECT query, calls, total_time, rows, mean_time
FROM pg_stat_statements
ORDER BY total_time DESC
LIMIT 10;

-- é‡ç½®ç»Ÿè®¡
SELECT pg_stat_statements_reset();
```

#### 3.2.5 pg_cron - æ•°æ®åº“çº§å®šæ—¶ä»»åŠ¡

pg_cronå…è®¸ç›´æ¥åœ¨PostgreSQLä¸­è°ƒåº¦å®šæ—¶ä»»åŠ¡ï¼š

```sql
-- å®‰è£…æ‰©å±•
CREATE EXTENSION pg_cron;

-- æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œæ¸…ç†
SELECT cron.schedule('0 2 * * *', 'VACUUM ANALYZE');

-- æ¯5åˆ†é’Ÿæ‰§è¡Œç»Ÿè®¡æ›´æ–°
SELECT cron.schedule('*/5 * * * *', 'REFRESH MATERIALIZED VIEW daily_stats');

-- æŸ¥çœ‹å®šæ—¶ä»»åŠ¡
SELECT * FROM cron.job;
```

### 3.3 åˆ›å»ºè‡ªå®šä¹‰æ‰©å±•

PostgreSQLå…è®¸å¼€å‘è‡ªå®šä¹‰æ‰©å±•ä»¥å°è£…ç‰¹å®šåŠŸèƒ½ï¼š

```sql
-- åˆ›å»ºæ‰©å±•æ§åˆ¶æ–‡ä»¶(myextension.control)
/*
comment = 'My custom extension'
default_version = '1.0'
relocatable = true
*/

-- åˆ›å»ºSQLå®‰è£…è„šæœ¬(myextension--1.0.sql)
CREATE SCHEMA myext;

CREATE FUNCTION myext.hello_world() 
RETURNS TEXT AS $$
BEGIN
  RETURN 'Hello, world!';
END;
$$ LANGUAGE plpgsql;

-- å®‰è£…æ‰©å±•
CREATE EXTENSION myextension;
```

## 4. Spring Bootä¸PostgreSQLé›†æˆæœ€ä½³å®è·µ

Spring Bootæä¾›äº†å…¨é¢çš„PostgreSQLæ”¯æŒï¼Œå¯ä»¥è½»æ¾é›†æˆå¹¶å……åˆ†åˆ©ç”¨å…¶é«˜çº§ç‰¹æ€§ã€‚

### 4.1 åŸºç¡€é…ç½®ä¸ä¾èµ–

#### 4.1.1 æ·»åŠ ä¾èµ–

åœ¨`pom.xml`ä¸­æ·»åŠ PostgreSQLä¾èµ–ï¼š

```xml
<!-- Spring Data JPA -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-jpa</artifactId>
</dependency>

<!-- PostgreSQLé©±åŠ¨ -->
<dependency>
    <groupId>org.postgresql</groupId>
    <artifactId>postgresql</artifactId>
    <scope>runtime</scope>
</dependency>

<!-- å¯é€‰ï¼šFlywayæ•°æ®åº“è¿ç§» -->
<dependency>
    <groupId>org.flywaydb</groupId>
    <artifactId>flyway-core</artifactId>
</dependency>
```

#### 4.1.2 é…ç½®æ•°æ®æº

åœ¨`application.yml`ä¸­é…ç½®PostgreSQLè¿æ¥ï¼š

```yaml
spring:
  datasource:
    url: jdbc:postgresql://localhost:5432/mydatabase
    username: postgres
    password: secret
    driver-class-name: org.postgresql.Driver
  
  # JPAé…ç½®
  jpa:
    database-platform: org.hibernate.dialect.PostgreSQLDialect
    hibernate:
      ddl-auto: validate  # ç”Ÿäº§ç¯å¢ƒæ¨èä½¿ç”¨validate
    properties:
      hibernate:
        # å¯ç”¨PostgreSQLç‰¹å®šåŠŸèƒ½
        dialect: org.hibernate.dialect.PostgreSQLDialect
        jdbc:
          lob:
            non_contextual_creation: true

  # Flywayè¿ç§»é…ç½®
  flyway:
    enabled: true
    baseline-on-migrate: true
    locations: classpath:db/migration
```

#### 4.1.3 é…ç½®HikariCPè¿æ¥æ± 

HikariCPæ˜¯Spring Booté»˜è®¤çš„è¿æ¥æ± ï¼Œå¯ä»¥ä¸ºPostgreSQLä¼˜åŒ–é…ç½®ï¼š

```yaml
spring:
  datasource:
    hikari:
      minimum-idle: 5
      maximum-pool-size: 20
      idle-timeout: 30000
      max-lifetime: 2000000
      connection-timeout: 30000
      pool-name: HikariPoolPostgres
```

### 4.2 ä½¿ç”¨é«˜çº§æ•°æ®ç±»å‹

#### 4.2.1 JSONBç±»å‹æ˜ å°„

ä½¿ç”¨JPAå¤„ç†JSONBæ•°æ®ï¼š

```java
import com.vladmihalcea.hibernate.type.json.JsonBinaryType;
import org.hibernate.annotations.Type;
import org.hibernate.annotations.TypeDef;

@Entity
@Table(name = "products")
@TypeDef(name = "jsonb", typeClass = JsonBinaryType.class)
public class Product {
    
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    private String name;
    
    @Type(type = "jsonb")
    @Column(name = "attributes", columnDefinition = "jsonb")
    private Map<String, Object> attributes;
    
    // Getters and setters
}
```

éœ€è¦æ·»åŠ å¯¹Hibernateç±»å‹çš„æ”¯æŒï¼š

```xml
<dependency>
    <groupId>com.vladmihalcea</groupId>
    <artifactId>hibernate-types-55</artifactId>
    <version>2.16.2</version>
</dependency>
```

#### 4.2.2 æ•°ç»„ç±»å‹æ˜ å°„

```java
import java.util.List;
import org.hibernate.annotations.Type;

@Entity
@Table(name = "survey_responses")
public class SurveyResponse {
    
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    private Long userId;
    
    @Type(type = "list-array")
    @Column(name = "answers", columnDefinition = "text[]")
    private List<String> answers;
    
    // Getters and setters
}
```

#### 4.2.3 åœ°ç†æ•°æ®ç±»å‹(ä¸PostGISé›†æˆ)

æ·»åŠ PostGISä¾èµ–ï¼š

```xml
<dependency>
    <groupId>org.hibernate</groupId>
    <artifactId>hibernate-spatial</artifactId>
</dependency>

<dependency>
    <groupId>net.postgis</groupId>
    <artifactId>postgis-jdbc</artifactId>
    <version>2.5.0</version>
</dependency>
```

å®ä½“ç±»å®šä¹‰ï¼š

```java
import org.locationtech.jts.geom.Point;

@Entity
@Table(name = "locations")
public class Location {
    
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    private String name;
    
    @Column(name = "location", columnDefinition = "geography(Point,4326)")
    private Point location;
    
    // Getters and setters
}
```

Repositoryæ¥å£ä½¿ç”¨ç©ºé—´æŸ¥è¯¢ï¼š

```java
public interface LocationRepository extends JpaRepository<Location, Long> {
    
    @Query(value = "SELECT l.* FROM locations l WHERE " +
           "ST_DWithin(l.location, ST_MakePoint(:longitude, :latitude)::geography, :distanceMeters)",
           nativeQuery = true)
    List<Location> findLocationsWithin(
        @Param("longitude") double longitude,
        @Param("latitude") double latitude,
        @Param("distanceMeters") double distanceMeters);
}
```

### 4.3 äº‹åŠ¡ç®¡ç†ä¼˜åŒ–

Spring Bootä¸PostgreSQLçš„äº‹åŠ¡ç®¡ç†å¯æŒ‰å¦‚ä¸‹æ–¹å¼ä¼˜åŒ–ï¼š

#### 4.3.1 é…ç½®äº‹åŠ¡éš”ç¦»çº§åˆ«

```java
@Service
public class UserService {
    
    @Transactional(isolation = Isolation.REPEATABLE_READ)
    public void updateUserProfile(Long userId, UserProfile profile) {
        // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
    }
    
    @Transactional(isolation = Isolation.SERIALIZABLE)
    public void transferFunds(Long fromAccount, Long toAccount, BigDecimal amount) {
        // è½¬è´¦é€»è¾‘
    }
}
```

#### 4.3.2 åªè¯»äº‹åŠ¡ä¼˜åŒ–

å¯¹äºæŸ¥è¯¢æ“ä½œï¼Œæ ‡è®°äº‹åŠ¡ä¸ºåªè¯»å¯æé«˜æ€§èƒ½ï¼š

```java
@Transactional(readOnly = true)
public List<Product> findAllActiveProducts() {
    return productRepository.findByActiveTrue();
}
```

#### 4.3.3 ä½¿ç”¨å‘½åäº‹åŠ¡ç®¡ç†å¤šä¸ªæ•°æ®æº

```java
@Configuration
@EnableTransactionManagement
public class TransactionConfig {
    
    @Bean
    public PlatformTransactionManager primaryTransactionManager(
            EntityManagerFactory primaryEntityManagerFactory) {
        return new JpaTransactionManager(primaryEntityManagerFactory);
    }
    
    @Bean
    public PlatformTransactionManager reportTransactionManager(
            @Qualifier("reportEntityManagerFactory") EntityManagerFactory reportEntityManagerFactory) {
        return new JpaTransactionManager(reportEntityManagerFactory);
    }
}
```

ä½¿ç”¨å‘½åäº‹åŠ¡ï¼š

```java
@Transactional("reportTransactionManager")
public void generateReport() {
    // ä½¿ç”¨æŠ¥è¡¨æ•°æ®æºå¤„ç†
}
```

### 4.4 è‡ªå®šä¹‰å­˜å‚¨åº“å®ç°

åˆ›å»ºè‡ªå®šä¹‰å­˜å‚¨åº“å®ç°ç‰¹å®šPostgreSQLåŠŸèƒ½ï¼š

#### 4.4.1 åŸºæœ¬æ¶æ„

```java
// æ¥å£å®šä¹‰
public interface CustomProductRepository {
    List<Product> findByAttributesContaining(String key, Object value);
    void batchInsert(List<Product> products);
}

// æ ‡å‡†JPAå­˜å‚¨åº“æ¥å£
public interface ProductRepository extends 
    JpaRepository<Product, Long>, CustomProductRepository {
}

// è‡ªå®šä¹‰å®ç°
@Repository
public class CustomProductRepositoryImpl implements CustomProductRepository {
    
    @PersistenceContext
    private EntityManager entityManager;
    
    @Override
    public List<Product> findByAttributesContaining(String key, Object value) {
        String sql = "SELECT p.* FROM products p WHERE p.attributes @> ?::jsonb";
        
        // åˆ›å»ºJSONå¯¹è±¡ {"key": "value"}
        ObjectMapper mapper = new ObjectMapper();
        String jsonString;
        try {
            Map<String, Object> jsonMap = new HashMap<>();
            jsonMap.put(key, value);
            jsonString = mapper.writeValueAsString(jsonMap);
        } catch (Exception e) {
            throw new RuntimeException("JSONåºåˆ—åŒ–å¤±è´¥", e);
        }
        
        // æ‰§è¡ŒåŸç”ŸæŸ¥è¯¢
        Query query = entityManager.createNativeQuery(sql, Product.class);
        query.setParameter(1, jsonString);
        
        return query.getResultList();
    }
    
    @Override
    public void batchInsert(List<Product> products) {
        // åˆ†æ‰¹æ¬¡æ‰§è¡Œæ’å…¥
        int batchSize = 100;
        for (int i = 0; i < products.size(); i++) {
            entityManager.persist(products.get(i));
            
            // æ¯batchSizeæ¡åˆ·æ–°å¹¶æ¸…ç†æŒä¹…åŒ–ä¸Šä¸‹æ–‡
            if (i % batchSize == 0 && i > 0) {
                entityManager.flush();
                entityManager.clear();
            }
        }
        
        entityManager.flush();
        entityManager.clear();
    }
}
```

#### 4.4.2 ä½¿ç”¨JPQLæ‰§è¡ŒPostgreSQLç‰¹å®šå‡½æ•°

```java
public interface ArticleRepository extends JpaRepository<Article, Long> {
    
    @Query(value = "SELECT a.* FROM articles a " +
           "WHERE a.tsv @@ plainto_tsquery('english', :query) " +
           "ORDER BY ts_rank(a.tsv, plainto_tsquery('english', :query)) DESC",
           nativeQuery = true)
    List<Article> fullTextSearch(@Param("query") String query);
}
```

### 4.5 é«˜çº§æŸ¥è¯¢æŠ€å·§

#### 4.5.1 ä½¿ç”¨Criteria APIæ„å»ºåŠ¨æ€æŸ¥è¯¢

```java
@Repository
public class DynamicProductRepository {
    
    @PersistenceContext
    private EntityManager em;
    
    public List<Product> findProductsByDynamicCriteria(
            String name, Map<String, Object> attributes, 
            Double minPrice, Double maxPrice) {
        
        CriteriaBuilder cb = em.getCriteriaBuilder();
        CriteriaQuery<Product> query = cb.createQuery(Product.class);
        Root<Product> product = query.from(Product.class);
        
        List<Predicate> predicates = new ArrayList<>();
        
        if (name != null) {
            predicates.add(cb.like(product.get("name"), "%" + name + "%"));
        }
        
        if (minPrice != null) {
            predicates.add(cb.greaterThanOrEqualTo(product.get("price"), minPrice));
        }
        
        if (maxPrice != null) {
            predicates.add(cb.lessThanOrEqualTo(product.get("price"), maxPrice));
        }
        
        // ç»„åˆæ‰€æœ‰æ¡ä»¶
        query.where(cb.and(predicates.toArray(new Predicate[0])));
        
        return em.createQuery(query).getResultList();
    }
}
```

#### 4.5.2 ä½¿ç”¨åŸç”ŸSQLæ‰§è¡Œå¤æ‚æŸ¥è¯¢

```java
@Repository
public class AnalyticsRepository {
    
    @PersistenceContext
    private EntityManager entityManager;
    
    @SuppressWarnings("unchecked")
    public List<SalesReport> getMonthlySalesReport(int year) {
        String sql = 
            "SELECT " +
            "  date_trunc('month', o.order_date) as month, " +
            "  p.category, " +
            "  sum(oi.quantity) as total_quantity, " +
            "  sum(oi.quantity * oi.price) as total_sales " +
            "FROM orders o " +
            "JOIN order_items oi ON o.id = oi.order_id " +
            "JOIN products p ON oi.product_id = p.id " +
            "WHERE EXTRACT(YEAR FROM o.order_date) = :year " +
            "GROUP BY month, p.category " +
            "ORDER BY month, p.category";
            
        Query query = entityManager.createNativeQuery(sql, "SalesReportMapping");
        query.setParameter("year", year);
        
        return query.getResultList();
    }
}
```

ç›¸åº”çš„å®ä½“æ˜ å°„ï¼š

```java
@SqlResultSetMapping(
    name = "SalesReportMapping",
    classes = @ConstructorResult(
        targetClass = SalesReport.class,
        columns = {
            @ColumnResult(name = "month", type = Date.class),
            @ColumnResult(name = "category", type = String.class),
            @ColumnResult(name = "total_quantity", type = Integer.class),
            @ColumnResult(name = "total_sales", type = BigDecimal.class)
        }
    )
)
public class SalesReport {
    private Date month;
    private String category;
    private Integer totalQuantity;
    private BigDecimal totalSales;
    
    // æ„é€ å‡½æ•°ã€Getterså’ŒSetters
}
``` 

## 5. PostgreSQLæ€§èƒ½ä¼˜åŒ–ç­–ç•¥

PostgreSQLæä¾›äº†å¤šç§æ€§èƒ½ä¼˜åŒ–æœºåˆ¶ï¼Œä»åŸºç¡€é…ç½®åˆ°é«˜çº§æŸ¥è¯¢ä¼˜åŒ–ï¼Œä»¥ä¸‹æ˜¯å…¨é¢çš„æ€§èƒ½ä¼˜åŒ–æŒ‡å—ã€‚

### 5.1 ç¡¬ä»¶ä¸ç³»ç»Ÿé…ç½®ä¼˜åŒ–

æ€§èƒ½ä¼˜åŒ–é¦–å…ˆè¦ä»ç¡¬ä»¶å’Œç³»ç»Ÿé…ç½®å¼€å§‹ã€‚

#### 5.1.1 ç¡¬ä»¶é€‰æ‹©ä¸ä¼˜åŒ–

- **å­˜å‚¨ä¼˜åŒ–**ï¼šä½¿ç”¨SSDæˆ–NVMeå­˜å‚¨ï¼Œé¿å…æœºæ¢°ç¡¬ç›˜
- **å†…å­˜é…ç½®**ï¼šä¸ºPostgreSQLåˆ†é…è¶³å¤Ÿå†…å­˜ï¼ˆè‡³å°‘4GBï¼Œæ¨è8GBä»¥ä¸Šï¼‰
- **CPUèµ„æº**ï¼šå¤šæ ¸CPUæœ‰åŠ©äºå¹¶è¡ŒæŸ¥è¯¢æ‰§è¡Œ
- **RAIDé…ç½®**ï¼šç”Ÿäº§ç¯å¢ƒè€ƒè™‘RAID 10ï¼Œå¹³è¡¡æ€§èƒ½å’Œæ•°æ®å®‰å…¨

#### 5.1.2 æ“ä½œç³»ç»Ÿä¼˜åŒ–

**Linuxç³»ç»Ÿä¼˜åŒ–**ï¼š

```bash
# æ–‡ä»¶æè¿°ç¬¦é™åˆ¶
sudo sysctl -w fs.file-max=100000

# å†…å­˜ç®¡ç†
sudo sysctl -w vm.swappiness=10
sudo sysctl -w vm.dirty_background_ratio=5
sudo sysctl -w vm.dirty_ratio=30

# ç£ç›˜I/Oè°ƒåº¦å™¨ï¼ˆSSDæ¨èï¼‰
echo 'none' | sudo tee /sys/block/sda/queue/scheduler
```

**æ–‡ä»¶ç³»ç»Ÿé€‰æ‹©**ï¼š
- æ¨èä½¿ç”¨XFSæˆ–ext4æ–‡ä»¶ç³»ç»Ÿ
- æŒ‚è½½é€‰é¡¹ï¼š`noatime,nodiratime`å‡å°‘ä¸å¿…è¦çš„å†™å…¥

### 5.2 PostgreSQLæœåŠ¡å™¨å‚æ•°ä¼˜åŒ–

ä»¥ä¸‹æ˜¯å…³é”®é…ç½®å‚æ•°çš„ä¼˜åŒ–å»ºè®®ï¼š

#### 5.2.1 å†…å­˜å‚æ•°

```
# å…±äº«å†…å­˜ç¼“å†²åŒºï¼ˆç³»ç»Ÿå†…å­˜çš„25%-40%ï¼‰
shared_buffers = 4GB

# å·¥ä½œå†…å­˜ï¼ˆå¤æ‚æŸ¥è¯¢ï¼‰
work_mem = 32MB  # æ ¹æ®å¹¶å‘è¿æ¥æ•°å’ŒæŸ¥è¯¢å¤æ‚åº¦è°ƒæ•´

# ç»´æŠ¤æ“ä½œå†…å­˜ï¼ˆç´¢å¼•åˆ›å»ºã€VACUUMç­‰ï¼‰
maintenance_work_mem = 512MB

# æœ‰æ•ˆç¼“å­˜å¤§å°ï¼ˆç³»ç»Ÿå†…å­˜çš„50%-75%ï¼‰
effective_cache_size = 12GB
```

#### 5.2.2 æ£€æŸ¥ç‚¹ä¸WALé…ç½®

```
# æ£€æŸ¥ç‚¹é…ç½®
checkpoint_timeout = 15min
checkpoint_completion_target = 0.9
max_wal_size = 16GB
min_wal_size = 2GB

# WALé…ç½®
wal_buffers = 16MB
```

#### 5.2.3 è‡ªåŠ¨æ¸…ç†é…ç½®

```
# è‡ªåŠ¨æ¸…ç†é…ç½®
autovacuum = on
autovacuum_vacuum_scale_factor = 0.1  # è¡¨å¤§å°çš„10%å˜åŒ–è§¦å‘æ¸…ç†
autovacuum_analyze_scale_factor = 0.05  # è¡¨å¤§å°çš„5%å˜åŒ–è§¦å‘åˆ†æ
autovacuum_vacuum_cost_delay = 2ms  # å‡å°å»¶è¿Ÿï¼Œæé«˜æ¸…ç†é¢‘ç‡
```

### 5.3 æ•°æ®åº“è®¾è®¡ä¼˜åŒ–

è‰¯å¥½çš„æ•°æ®åº“è®¾è®¡æ˜¯æ€§èƒ½çš„åŸºç¡€ã€‚

#### 5.3.1 è¡¨ç»“æ„ä¼˜åŒ–

- **æ­£ç¡®ä½¿ç”¨æ•°æ®ç±»å‹**ï¼šé€‰æ‹©æœ€åˆé€‚ã€æœ€ç²¾ç¡®çš„æ•°æ®ç±»å‹ï¼ˆä¾‹å¦‚ï¼Œä½¿ç”¨smallintä»£æ›¿intï¼Œé€‚å½“æ—¶ï¼‰
- **è§„èŒƒåŒ–ä¸åè§„èŒƒåŒ–å¹³è¡¡**ï¼šæ ¹æ®æŸ¥è¯¢æ¨¡å¼é€‰æ‹©é€‚å½“çš„è§„èŒƒåŒ–çº§åˆ«
- **è¡¨åˆ†åŒº**ï¼šå¯¹å¤§è¡¨ä½¿ç”¨è¡¨åˆ†åŒºæé«˜æŸ¥è¯¢å’Œç»´æŠ¤æ•ˆç‡

è¡¨åˆ†åŒºç¤ºä¾‹ï¼š

```sql
-- åˆ›å»ºåˆ†åŒºè¡¨
CREATE TABLE measurements (
    logdate DATE NOT NULL,
    peaktemp INTEGER,
    unitsales INTEGER
) PARTITION BY RANGE (logdate);

-- åˆ›å»ºåˆ†åŒº
CREATE TABLE measurements_y2022m01 PARTITION OF measurements
    FOR VALUES FROM ('2022-01-01') TO ('2022-02-01');
    
CREATE TABLE measurements_y2022m02 PARTITION OF measurements
    FOR VALUES FROM ('2022-02-01') TO ('2022-03-01');
    
-- ä»¥æ­¤ç±»æ¨...
```

#### 5.3.2 ç´¢å¼•ç­–ç•¥

- **åˆ›å»ºé€‚å½“çš„ç´¢å¼•**ï¼šç´¢å¼•åŠ é€ŸæŸ¥è¯¢ä½†ä¼šå‡æ…¢å†™å…¥æ“ä½œ
- **å¤åˆç´¢å¼•é¡ºåº**ï¼šæœ€é«˜é€‰æ‹©æ€§çš„åˆ—æ”¾åœ¨å‰é¢
- **éƒ¨åˆ†ç´¢å¼•**ï¼šåªä¸ºæ•°æ®å­é›†åˆ›å»ºç´¢å¼•
- **å®šæœŸé‡å»ºç´¢å¼•**ï¼š`REINDEX INDEX index_name;`

ç´¢å¼•ä½¿ç”¨ç¤ºä¾‹ï¼š

```sql
-- B-treeç´¢å¼•ï¼ˆé»˜è®¤ï¼‰
CREATE INDEX idx_customers_email ON customers(email);

-- éƒ¨åˆ†ç´¢å¼•
CREATE INDEX idx_orders_recent ON orders(created_at)
WHERE created_at > current_date - interval '3 months';

-- è¡¨è¾¾å¼ç´¢å¼•
CREATE INDEX idx_customers_lower_email ON customers(lower(email));

-- è¦†ç›–ç´¢å¼•
CREATE INDEX idx_products_search ON products(name, description, price, category_id);
```

#### 5.3.3 ç»Ÿè®¡ä¿¡æ¯æ›´æ–°

å®šæœŸæ›´æ–°ç»Ÿè®¡ä¿¡æ¯ï¼Œå¸®åŠ©æŸ¥è¯¢è®¡åˆ’ä¼˜åŒ–ï¼š

```sql
-- æ›´æ–°å•è¡¨ç»Ÿè®¡ä¿¡æ¯
ANALYZE customers;

-- æ›´æ–°æ•´ä¸ªæ•°æ®åº“
ANALYZE VERBOSE;

-- ä¿®æ”¹è‡ªåŠ¨ç»Ÿè®¡æ”¶é›†
ALTER TABLE large_table SET (autovacuum_analyze_scale_factor = 0.01);
```

### 5.4 æŸ¥è¯¢ä¼˜åŒ–

ä¼˜åŒ–SQLæŸ¥è¯¢æ˜¯æé«˜æ€§èƒ½çš„å…³é”®æ­¥éª¤ã€‚

#### 5.4.1 EXPLAINåˆ†ææŸ¥è¯¢è®¡åˆ’

ä½¿ç”¨EXPLAINå’ŒEXPLAIN ANALYZEåˆ†ææŸ¥è¯¢æ‰§è¡Œè®¡åˆ’ï¼š

```sql
-- åŸºæœ¬æ‰§è¡Œè®¡åˆ’
EXPLAIN
SELECT c.name, count(o.id) as order_count
FROM customers c
JOIN orders o ON c.id = o.customer_id
GROUP BY c.id, c.name;

-- å¸¦å®é™…æ‰§è¡Œæ—¶é—´çš„åˆ†æ
EXPLAIN ANALYZE
SELECT c.name, count(o.id) as order_count
FROM customers c
JOIN orders o ON c.id = o.customer_id
GROUP BY c.id, c.name;

-- æ›´è¯¦ç»†çš„è¾“å‡º
EXPLAIN (ANALYZE, BUFFERS, FORMAT JSON)
SELECT * FROM products WHERE price > 100;
```

å…³é”®æŒ‡æ ‡è§£è¯»ï¼š
- **Seq Scan**ï¼šå…¨è¡¨æ‰«æï¼Œå¯¹å¤§è¡¨åº”é¿å…
- **Index Scan**ï¼šé€šè¿‡ç´¢å¼•æŸ¥æ‰¾æ•°æ®
- **Hash Join** vs **Nested Loop Join**ï¼šäº†è§£ä¸åŒè¿æ¥ç­–ç•¥
- **Sort**ï¼šæ’åºæ“ä½œï¼Œæ¶ˆè€—å†…å­˜å’ŒCPU

#### 5.4.2 å¸¸è§æŸ¥è¯¢ä¼˜åŒ–æŠ€å·§

- **é¿å…SELECT ***ï¼šåªæŸ¥è¯¢éœ€è¦çš„åˆ—
- **å‡å°‘JOINæ•°é‡**ï¼šæ¯ä¸ªJOINéƒ½å¢åŠ å¤æ‚åº¦
- **ä½¿ç”¨LIMITé™åˆ¶ç»“æœæ•°**ï¼šé¿å…è¿”å›ä¸å¿…è¦çš„å¤§é‡ç»“æœ
- **å­æŸ¥è¯¢ä¼˜åŒ–**ï¼šè€ƒè™‘ä½¿ç”¨JOINä»£æ›¿æŸäº›å­æŸ¥è¯¢
- **ä½¿ç”¨æ‰¹é‡æ“ä½œ**ï¼šæ‰¹é‡æ’å…¥/æ›´æ–°æ¯”å•æ¡æ“ä½œæ›´é«˜æ•ˆ

ä¼˜åŒ–ç¤ºä¾‹ï¼š

```sql
-- æœªä¼˜åŒ–ï¼š
SELECT * FROM orders WHERE customer_id IN 
  (SELECT id FROM customers WHERE country = 'USA');

-- ä¼˜åŒ–åï¼š
SELECT o.* FROM orders o
JOIN customers c ON o.customer_id = c.id
WHERE c.country = 'USA';

-- æœªä¼˜åŒ–ï¼šé€æ¡æ’å…¥
INSERT INTO order_items VALUES (1, 101, 1, 29.99);
INSERT INTO order_items VALUES (2, 101, 2, 19.99);
-- ...

-- ä¼˜åŒ–åï¼šæ‰¹é‡æ’å…¥
INSERT INTO order_items VALUES 
  (1, 101, 1, 29.99),
  (2, 101, 2, 19.99),
  (3, 101, 3, 9.99),
  -- ...å¯ä»¥ä¸€æ¬¡æ’å…¥å‡ ç™¾æ¡
```

#### 5.4.3 æ•°æ®åº“å‡½æ•°ä¼˜åŒ–

- **å­˜å‚¨è¿‡ç¨‹**ï¼šå°†å¤æ‚é€»è¾‘æ”¾å…¥æ•°æ®åº“å‡½æ•°å‡å°‘å¾€è¿”
- **çª—å£å‡½æ•°**ï¼šä½¿ç”¨çª—å£å‡½æ•°ä»£æ›¿è‡ªè¿æ¥æˆ–å¤šæ¬¡æŸ¥è¯¢
- **CTEä¼˜åŒ–**ï¼šåˆç†ä½¿ç”¨WITHè¯­å¥ï¼ˆæ³¨æ„ï¼šPostgreSQL 12ä¹‹å‰ï¼ŒCTEæ€»æ˜¯ç‰©åŒ–ï¼‰

ç¤ºä¾‹å­˜å‚¨è¿‡ç¨‹ï¼š

```sql
CREATE OR REPLACE FUNCTION process_orders(customer_id INT)
RETURNS TABLE (order_id INT, total_amount NUMERIC) AS $$
BEGIN
    RETURN QUERY
    SELECT o.id, SUM(oi.price * oi.quantity)
    FROM orders o
    JOIN order_items oi ON o.id = oi.order_id
    WHERE o.customer_id = process_orders.customer_id
    GROUP BY o.id;
END;
$$ LANGUAGE plpgsql;

-- ä½¿ç”¨å‡½æ•°
SELECT * FROM process_orders(123);
```

### 5.5 é«˜çº§æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

å¯¹äºé«˜è´Ÿè½½ç³»ç»Ÿï¼Œå¯ä»¥è€ƒè™‘ä»¥ä¸‹é«˜çº§ä¼˜åŒ–ç­–ç•¥ã€‚

#### 5.5.1 ç‰©åŒ–è§†å›¾

ç‰©åŒ–è§†å›¾é¢„å…ˆè®¡ç®—å¹¶å­˜å‚¨æŸ¥è¯¢ç»“æœï¼Œé€‚ç”¨äºå¤æ‚ä½†ä¸ç»å¸¸å˜åŒ–çš„æŸ¥è¯¢ï¼š

```sql
-- åˆ›å»ºç‰©åŒ–è§†å›¾
CREATE MATERIALIZED VIEW monthly_sales AS
SELECT 
  date_trunc('month', o.order_date) as month,
  p.category,
  SUM(oi.quantity * oi.price) as total_sales
FROM orders o
JOIN order_items oi ON o.id = oi.order_id
JOIN products p ON oi.product_id = p.id
GROUP BY month, p.category;

-- åˆ›å»ºç´¢å¼•åŠ é€Ÿè®¿é—®
CREATE INDEX idx_monthly_sales_month ON monthly_sales(month);

-- æ›´æ–°ç‰©åŒ–è§†å›¾
REFRESH MATERIALIZED VIEW monthly_sales;

-- å¹¶å‘æ›´æ–°ï¼ˆä¸é˜»å¡æŸ¥è¯¢ï¼‰
REFRESH MATERIALIZED VIEW CONCURRENTLY monthly_sales;
```

#### 5.5.2 å¹¶è¡ŒæŸ¥è¯¢

PostgreSQLæ”¯æŒå¹¶è¡ŒæŸ¥è¯¢å¤„ç†ï¼Œå……åˆ†åˆ©ç”¨å¤šæ ¸CPUï¼š

```sql
-- è®¾ç½®å¹¶è¡Œå·¥ä½œè€…æ•°é‡
SET max_parallel_workers_per_gather = 4;

-- å¼ºåˆ¶ä½¿ç”¨å¹¶è¡ŒæŸ¥è¯¢ï¼ˆæµ‹è¯•æ—¶ï¼‰
SET force_parallel_mode = on;

-- æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’ä¸­çš„å¹¶è¡Œå¤„ç†
EXPLAIN
SELECT * FROM large_table WHERE value > 1000;
```

#### 5.5.3 åˆ†åŒºè¡¨æ€§èƒ½ä¼˜åŒ–

åˆ†åŒºè¡¨èƒ½æå¤§æé«˜å¤§è¡¨çš„æŸ¥è¯¢å’Œç»´æŠ¤æ€§èƒ½ï¼š

```sql
-- åˆ†åŒºè¡¨å®šä¹‰
CREATE TABLE logs (
    log_time TIMESTAMP NOT NULL,
    message TEXT,
    detail JSONB
) PARTITION BY RANGE (log_time);

-- åˆ›å»ºæœˆåº¦åˆ†åŒº
CREATE TABLE logs_y2023m01 PARTITION OF logs
    FOR VALUES FROM ('2023-01-01') TO ('2023-02-01');
-- ...æ›´å¤šåˆ†åŒº

-- è‡ªåŠ¨åˆ›å»ºåˆ†åŒºï¼ˆéœ€è¦pg_partmanæ‰©å±•ï¼‰
CREATE EXTENSION pg_partman;

SELECT partman.create_parent(
    'public.logs',
    'log_time',
    'month',
    1,
    p_start_date := '2023-01-01'
);

-- é…ç½®è‡ªåŠ¨åˆ›å»ºæœªæ¥åˆ†åŒº
UPDATE partman.part_config
SET retention = '6 months', retention_keep_table = true
WHERE parent_table = 'public.logs';
```

### 5.6 ç›‘æ§ä¸æŒç»­ä¼˜åŒ–

æŒç»­ç›‘æ§å’Œä¼˜åŒ–æ˜¯ä¿æŒæ•°æ®åº“é«˜æ€§èƒ½çš„å…³é”®ã€‚

#### 5.6.1 å…³é”®ç›‘æ§æŒ‡æ ‡

åº”è¯¥ç›‘æ§ä»¥ä¸‹å…³é”®æŒ‡æ ‡ï¼š
- **è¿æ¥æ•°**ï¼š`SELECT count(*) FROM pg_stat_activity;`
- **ç¼“å­˜å‘½ä¸­ç‡**ï¼š`SELECT sum(heap_blks_hit) / (sum(heap_blks_hit) + sum(heap_blks_read)) AS cache_hit_ratio FROM pg_statio_user_tables;`
- **é”ç­‰å¾…**ï¼š`SELECT * FROM pg_locks WHERE NOT granted;`
- **è¡¨è†¨èƒ€**ï¼šä½¿ç”¨pgstattupleæ‰©å±•
- **æ…¢æŸ¥è¯¢**ï¼šä½¿ç”¨pg_stat_statementsæ‰©å±•

#### 5.6.2 å®šæœŸç»´æŠ¤ä»»åŠ¡

è®¾ç½®ä»¥ä¸‹å®šæœŸç»´æŠ¤ä»»åŠ¡ï¼š
- **VACUUM ANALYZE**ï¼šæ¸…ç†å·²åˆ é™¤æ•°æ®ï¼Œæ›´æ–°ç»Ÿè®¡ä¿¡æ¯
- **REINDEX**ï¼šé‡å»ºç´¢å¼•ä»¥å‡å°‘ç´¢å¼•è†¨èƒ€
- **ç›‘æ§å’Œè°ƒæ•´è‡ªåŠ¨æ¸…ç†**ï¼šç¡®ä¿è‡ªåŠ¨æ¸…ç†æœ‰æ•ˆè¿è¡Œ

è‡ªåŠ¨åŒ–ç»´æŠ¤ç¤ºä¾‹ï¼š

```sql
-- ä½¿ç”¨pg_cronè®¾ç½®ç»´æŠ¤ä»»åŠ¡
CREATE EXTENSION pg_cron;

-- æ¯å‘¨æ—¥å‡Œæ™¨2ç‚¹æ‰§è¡ŒVACUUM ANALYZE
SELECT cron.schedule('0 2 * * 0', 'VACUUM ANALYZE');

-- æ¯æœˆ1å·é‡å»ºç´¢å¼•
SELECT cron.schedule('0 3 1 * *', 'REINDEX TABLE customers');

-- æ¯å°æ—¶æ›´æ–°å…³é”®ç‰©åŒ–è§†å›¾
SELECT cron.schedule('0 * * * *', 'REFRESH MATERIALIZED VIEW sales_summary');
```

#### 5.6.3 ä½¿ç”¨ç›‘æ§å·¥å…·

ä»¥ä¸‹å·¥å…·æœ‰åŠ©äºç›‘æ§PostgreSQLæ€§èƒ½ï¼š
- **pgAdmin**ï¼šå†…ç½®ç›‘æ§ä»ªè¡¨æ¿
- **pg_stat_statements**ï¼šSQLæ‰§è¡Œç»Ÿè®¡
- **Prometheus + Grafana**ï¼šå…¨é¢ç›‘æ§å’Œè­¦æŠ¥
- **pgBadger**ï¼šæ—¥å¿—åˆ†æå·¥å…·

## 6. æœ€ä½³å®è·µä¸å¸¸è§é—®é¢˜è§£å†³

### 6.1 PostgreSQLç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ

#### 6.1.1 å®‰å…¨æ€§æœ€ä½³å®è·µ

- **ä½¿ç”¨å¼ºå¯†ç å’ŒSSLè¿æ¥**
```sql
# åœ¨postgresql.confä¸­å¯ç”¨SSL
ssl = on
ssl_cert_file = 'server.crt'
ssl_key_file = 'server.key'

# åœ¨pg_hba.confä¸­è¦æ±‚SSLè¿æ¥
hostssl all all 0.0.0.0/0 md5
```

- **å®æ–½è¡Œçº§å®‰å…¨æ€§**
```sql
-- åˆ›å»ºç­–ç•¥
CREATE POLICY tenant_isolation ON customer_data
    USING (tenant_id = current_setting('app.tenant_id')::int);
    
-- å¯ç”¨è¡Œçº§å®‰å…¨
ALTER TABLE customer_data ENABLE ROW LEVEL SECURITY;
```

- **å®šæœŸå®‰å…¨å®¡è®¡**
```sql
-- æŸ¥çœ‹æ‰€æœ‰æ•°æ®åº“ç”¨æˆ·
SELECT usename, usesuper, usecreatedb FROM pg_user;

-- æŸ¥çœ‹è¡¨æƒé™
SELECT grantee, table_name, privilege_type 
FROM information_schema.role_table_grants 
WHERE table_schema='public';
```

#### 6.1.2 å¤‡ä»½ç­–ç•¥

- **ç‰©ç†å¤‡ä»½ï¼šä½¿ç”¨pg_basebackup**
```bash
pg_basebackup -D /backup/path -Fp -Xs -P -U postgres
```

- **é€»è¾‘å¤‡ä»½ï¼šä½¿ç”¨pg_dump**
```bash
pg_dump -U postgres -d mydb -F c -f /backup/mydb.dump
```

- **æ—¶é—´ç‚¹æ¢å¤(PITR)é…ç½®**
```
# postgresql.conf
wal_level = replica
archive_mode = on
archive_command = 'cp %p /archive/%f'
```

#### 6.1.3 é«˜å¯ç”¨æ€§è®¾ç½®

- **ä¸»ä»å¤åˆ¶**
```
# ä¸»æœåŠ¡å™¨postgresql.conf
wal_level = replica
max_wal_senders = 10
wal_keep_segments = 32

# ä»æœåŠ¡å™¨postgresql.conf
primary_conninfo = 'host=ä¸»æœåŠ¡å™¨IP port=5432 user=replica password=å¯†ç '
```

- **ä½¿ç”¨Patroni/pgBouncer/HAProxyæ„å»ºé«˜å¯ç”¨é›†ç¾¤**
- **è€ƒè™‘ä½¿ç”¨äº‘æœåŠ¡æä¾›çš„PostgreSQLæ‰˜ç®¡æœåŠ¡**

### 6.2 å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

#### 6.2.1 æ€§èƒ½é—®é¢˜

| é—®é¢˜ | è§£å†³æ–¹æ¡ˆ |
|------|---------|
| æ…¢æŸ¥è¯¢ | ä½¿ç”¨EXPLAIN ANALYZEåˆ†æå¹¶ä¼˜åŒ–æŸ¥è¯¢ï¼Œæ·»åŠ é€‚å½“ç´¢å¼• |
| è¡¨è†¨èƒ€ | å®šæœŸæ‰§è¡ŒVACUUM FULLæˆ–pg_repackï¼ˆåœ¨çº¿é‡å»ºï¼‰ |
| å†…å­˜ä¸è¶³ | è°ƒæ•´shared_bufferså’Œwork_memï¼Œè€ƒè™‘å¢åŠ æœåŠ¡å™¨å†…å­˜ |
| è¿æ¥è€—å°½ | ä½¿ç”¨è¿æ¥æ± ï¼ˆå¦‚PgBouncerï¼‰ç®¡ç†è¿æ¥ï¼Œå¢åŠ max_connections |
| ç´¢å¼•æœªä½¿ç”¨ | æ£€æŸ¥ç»Ÿè®¡ä¿¡æ¯æ˜¯å¦å‡†ç¡®ï¼ˆANALYZEï¼‰ï¼Œè¯„ä¼°ç´¢å¼•è®¾è®¡ |

#### 6.2.2 å¸¸è§é”™è¯¯åŠå¤„ç†

```
ERROR: relation "table_name" does not exist
```
- æ£€æŸ¥è¡¨åæ‹¼å†™å’Œå½“å‰schema
- ä½¿ç”¨`\dt`å‘½ä»¤åˆ—å‡ºæ‰€æœ‰è¡¨

```
ERROR: deadlock detected
```
- æ£€æŸ¥å¹¶ä¼˜åŒ–äº‹åŠ¡é€»è¾‘ï¼Œé¿å…é•¿äº‹åŠ¡
- ä½¿ç”¨`pg_stat_activity`æŸ¥çœ‹å½“å‰é”çŠ¶æ€

```
ERROR: out of memory
```
- è°ƒæ•´work_memå’Œmaintenance_work_mem
- ä¼˜åŒ–å¤æ‚æŸ¥è¯¢ï¼Œåˆ†æ‰¹å¤„ç†å¤§æ•°æ®

#### 6.2.3 æ•°æ®è¿ç§»ä¸å‡çº§

- **å°å‹æ•°æ®åº“è¿ç§»**
```bash
# å¯¼å‡º
pg_dump -U postgres olddb > olddb.sql

# å¯¼å…¥
psql -U postgres newdb < olddb.sql
```

- **å¤§å‹æ•°æ®åº“è¿ç§»**
```bash
# å¯¼å‡ºä¸ºè‡ªå®šä¹‰æ ¼å¼
pg_dump -U postgres -Fc -d olddb > olddb.dump

# å¹¶è¡Œå¯¼å…¥
pg_restore -U postgres -j 4 -d newdb olddb.dump
```

- **ç‰ˆæœ¬å‡çº§**
```bash
# ä½¿ç”¨pg_upgradeè¿›è¡ŒåŸåœ°å‡çº§
pg_upgrade -b /usr/lib/postgresql/13/bin -B /usr/lib/postgresql/14/bin -d /var/lib/postgresql/13/main -D /var/lib/postgresql/14/main
```

### 6.3 ä¸å…¶ä»–ç³»ç»Ÿé›†æˆ

#### 6.3.1 PostgreSQLä¸Kafkaé›†æˆ

ä½¿ç”¨Debeziumæˆ–Kafka Connect CDCè¿æ¥å™¨å®ç°äº‹ä»¶é©±åŠ¨æ¶æ„ï¼š

```properties
# Kafka Connecté…ç½®ç¤ºä¾‹
connector.class=io.debezium.connector.postgresql.PostgresConnector
database.hostname=postgres.example.com
database.port=5432
database.user=debezium
database.password=password
database.dbname=mydatabase
database.server.name=my-postgres-server
```

#### 6.3.2 ä½¿ç”¨å¤–éƒ¨æ•°æ®åŒ…è£…å™¨(FDW)

PostgreSQLå¯é€šè¿‡FDWè¿æ¥å¤–éƒ¨æ•°æ®æºï¼š

```sql
-- å®‰è£…postgres_fdwæ‰©å±•
CREATE EXTENSION postgres_fdw;

-- åˆ›å»ºå¤–éƒ¨æœåŠ¡å™¨
CREATE SERVER foreign_server
FOREIGN DATA WRAPPER postgres_fdw
OPTIONS (host 'remote.example.com', port '5432', dbname 'remote_db');

-- åˆ›å»ºç”¨æˆ·æ˜ å°„
CREATE USER MAPPING FOR local_user
SERVER foreign_server
OPTIONS (user 'remote_user', password 'password');

-- åˆ›å»ºå¤–éƒ¨è¡¨
CREATE FOREIGN TABLE foreign_products (
    id integer NOT NULL,
    name character varying(255),
    price numeric(10,2)
)
SERVER foreign_server
OPTIONS (schema_name 'public', table_name 'products');

-- æŸ¥è¯¢å¤–éƒ¨è¡¨
SELECT * FROM foreign_products WHERE price > 100;
```

#### 6.3.3 PostgreSQLä¸ElasticSearché›†æˆ

```sql
-- ä½¿ç”¨elasticsearch_fdwæ‰©å±•
CREATE EXTENSION elasticsearch_fdw;

CREATE SERVER es_server
FOREIGN DATA WRAPPER elasticsearch_fdw
OPTIONS (host 'localhost', port '9200');

CREATE FOREIGN TABLE es_products (
    id text,
    name text,
    description text,
    price numeric,
    _score float8
)
SERVER es_server
OPTIONS (index 'products', type 'product');
```

### 6.4 Spring Booté¡¹ç›®ä¸­çš„PostgreSQLæœ€ä½³å®è·µ

#### 6.4.1 è¿æ¥æ± é…ç½®

```yaml
spring:
  datasource:
    hikari:
      maximum-pool-size: 10
      minimum-idle: 5
      idle-timeout: 300000  # 5åˆ†é’Ÿ
      connection-timeout: 20000  # 20ç§’
      max-lifetime: 1800000  # 30åˆ†é’Ÿ
      auto-commit: false  # å»ºè®®å…³é—­è‡ªåŠ¨æäº¤ï¼Œä½¿ç”¨äº‹åŠ¡
      connection-test-query: "SELECT 1"  # è¿æ¥æ£€æŸ¥æŸ¥è¯¢
```

#### 6.4.2 å¤šç¯å¢ƒé…ç½®

ä½¿ç”¨Spring profilesç®¡ç†ä¸åŒç¯å¢ƒçš„æ•°æ®åº“é…ç½®ï¼š

```yaml
spring:
  profiles:
    active: dev

---
spring:
  config:
    activate:
      on-profile: dev
  datasource:
    url: jdbc:postgresql://localhost:5432/devdb
    username: dev_user
    password: dev_pass

---
spring:
  config:
    activate:
      on-profile: prod
  datasource:
    url: jdbc:postgresql://prod-db.example.com:5432/proddb
    username: ${DB_USER}  # ä½¿ç”¨ç¯å¢ƒå˜é‡
    password: ${DB_PASS}
    hikari:
      maximum-pool-size: 20  # ç”Ÿäº§ç¯å¢ƒæ›´å¤§çš„è¿æ¥æ± 
```

#### 6.4.3 æ­£ç¡®å¤„ç†å¤§å‹ç»“æœé›†

å¯¹äºå¤§å‹ç»“æœé›†ï¼Œé¿å…ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰æ•°æ®ï¼š

```java
@Repository
public class LargeDataRepository {
    
    @PersistenceContext
    private EntityManager entityManager;
    
    @Transactional(readOnly = true)
    public void processLargeData(Consumer<Object[]> processor) {
        // åˆ›å»ºæ»šåŠ¨æŸ¥è¯¢
        Stream<Object[]> stream = entityManager
            .createNativeQuery("SELECT * FROM large_table")
            .setHint(QueryHints.HINT_FETCH_SIZE, 1000)  // è®¾ç½®æ‰¹å¤§å°
            .getResultStream();
        
        try {
            // æµå¼å¤„ç†ç»“æœ
            stream.forEach(processor);
        } finally {
            // ç¡®ä¿æµè¢«å…³é—­
            stream.close();
        }
    }
}
```

#### 6.4.4 æ­£ç¡®ç®¡ç†äº‹åŠ¡

- **ä½¿ç”¨å£°æ˜å¼äº‹åŠ¡**ï¼šä½¿ç”¨`@Transactional`æ³¨è§£
- **è®¾ç½®é€‚å½“çš„éš”ç¦»çº§åˆ«**ï¼šæ ¹æ®ä¸šåŠ¡åœºæ™¯é€‰æ‹©
- **é¿å…é•¿äº‹åŠ¡**ï¼šé•¿äº‹åŠ¡ä¼šå ç”¨èµ„æºï¼Œå¢åŠ é”äº‰ç”¨
- **åŒºåˆ†è¯»å†™æ“ä½œ**ï¼šåªè¯»äº‹åŠ¡å¯ä»¥å‡è½»æ•°æ®åº“è´Ÿæ‹…

```java
@Service
public class OrderService {

    @Transactional(readOnly = true)
    public List<Order> findUserOrders(Long userId) {
        // åªè¯»æŸ¥è¯¢æ“ä½œ
    }

    @Transactional(isolation = Isolation.READ_COMMITTED)
    public Order createOrder(OrderDTO orderDTO) {
        // å†™å…¥æ“ä½œ
    }

    @Transactional(isolation = Isolation.SERIALIZABLE, 
                  timeout = 30,  // 30ç§’è¶…æ—¶
                  rollbackFor = {Exception.class})
    public void transferFunds(Long fromAccountId, Long toAccountId, 
                             BigDecimal amount) {
        // éœ€è¦é«˜éš”ç¦»çº§åˆ«çš„æ“ä½œ
    }
}
```

é€šè¿‡ä¸Šè¿°æœ€ä½³å®è·µï¼Œå¼€å‘äººå‘˜å¯ä»¥å……åˆ†å‘æŒ¥PostgreSQLçš„æ€§èƒ½å’ŒåŠŸèƒ½ï¼Œæ„å»ºé«˜æ•ˆã€å¯é çš„ä¼ä¸šçº§åº”ç”¨ç¨‹åºã€‚ 