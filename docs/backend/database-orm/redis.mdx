---
sidebar_position: 4
title: Redisç¼“å­˜æ•°æ®åº“è¯¦è§£
description: æ·±å…¥ç†è§£Redisæ•°æ®ç»“æ„ã€æŒä¹…åŒ–æœºåˆ¶ã€é«˜å¯ç”¨æ¶æ„ä¸æ€§èƒ½ä¼˜åŒ–å®è·µ
authors: [Laby]
tags: [Redis, ç¼“å­˜, æ•°æ®åº“, å†…å­˜å­˜å‚¨, é«˜å¯ç”¨, æ€§èƒ½ä¼˜åŒ–]
last_update:
  date: 2025-08-11
  author: Laby
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import CodeBlock from '@theme/CodeBlock';

# Redisç¼“å­˜æ•°æ®åº“è¯¦è§£

Redisï¼ˆRemote Dictionary Serverï¼‰æ˜¯ä¸€ä¸ªå¼€æºçš„å†…å­˜æ•°æ®ç»“æ„å­˜å‚¨ç³»ç»Ÿï¼Œå¯ä»¥ç”¨ä½œæ•°æ®åº“ã€ç¼“å­˜å’Œæ¶ˆæ¯ä¸­é—´ä»¶ã€‚å®ƒæ”¯æŒå¤šç§æ•°æ®ç»“æ„ï¼Œå…·æœ‰é«˜æ€§èƒ½ã€é«˜å¯ç”¨æ€§å’Œä¸°å¯Œçš„åŠŸèƒ½ç‰¹æ€§ï¼Œæ˜¯ç°ä»£Webåº”ç”¨æ¶æ„ä¸­ä¸å¯æˆ–ç¼ºçš„ç»„ä»¶ã€‚

:::tip æ ¸å¿ƒä»·å€¼
**Redis = é«˜æ€§èƒ½å†…å­˜å­˜å‚¨ + ä¸°å¯Œæ•°æ®ç»“æ„ + æŒä¹…åŒ–æœºåˆ¶ + é«˜å¯ç”¨æ¶æ„**
- ğŸš€ **æè‡´æ€§èƒ½**ï¼šåŸºäºå†…å­˜æ“ä½œï¼Œå•çº¿ç¨‹æ¨¡å‹ï¼ŒQPSå¯è¾¾10ä¸‡+
- ğŸ¯ **æ•°æ®ç»“æ„ä¸°å¯Œ**ï¼šStringã€Hashã€Listã€Setã€Sorted Setã€Streamç­‰
- ğŸ’¾ **æŒä¹…åŒ–ä¿éšœ**ï¼šRDBå¿«ç…§ + AOFæ—¥å¿— + æ··åˆæŒä¹…åŒ–
- ğŸ”„ **é«˜å¯ç”¨æ¶æ„**ï¼šä¸»ä»å¤åˆ¶ + å“¨å…µæ¨¡å¼ + é›†ç¾¤åˆ†ç‰‡
- ğŸ› ï¸ **åº”ç”¨åœºæ™¯å¹¿æ³›**ï¼šç¼“å­˜ã€ä¼šè¯ã€æ’è¡Œæ¦œã€åˆ†å¸ƒå¼é”ã€æ¶ˆæ¯é˜Ÿåˆ—
:::

## 1. RedisåŸºç¡€æ¶æ„ä¸ç‰¹æ€§

### 1.1 Redisæ ¸å¿ƒç‰¹æ€§

Redisä½œä¸ºå†…å­˜æ•°æ®åº“ï¼Œå…·æœ‰ä»¥ä¸‹æ ¸å¿ƒç‰¹æ€§ï¼š

```mermaid
graph TB
    A[Redisæ ¸å¿ƒç‰¹æ€§] --> B[é«˜æ€§èƒ½]
    A --> C[æ•°æ®ç»“æ„ä¸°å¯Œ]
    A --> D[æŒä¹…åŒ–æœºåˆ¶]
    A --> E[é«˜å¯ç”¨æ€§]
    A --> F[æ‰©å±•æ€§å¼º]
    
    B --> B1[å†…å­˜æ“ä½œ]
    B --> B2[å•çº¿ç¨‹æ¨¡å‹]
    B --> B3[éé˜»å¡IO]
    
    C --> C1[Stringå­—ç¬¦ä¸²]
    C --> C2[Hashå“ˆå¸Œ]
    C --> C3[Liståˆ—è¡¨]
    C --> C4[Seté›†åˆ]
    C --> C5[Sorted Setæœ‰åºé›†åˆ]
    C --> C6[Streamæµ]
    
    D --> D1[RDBå¿«ç…§]
    D --> D2[AOFæ—¥å¿—]
    D --> D3[æ··åˆæŒä¹…åŒ–]
    
    E --> E1[ä¸»ä»å¤åˆ¶]
    E --> E2[å“¨å…µæ¨¡å¼]
    E --> E3[é›†ç¾¤æ¨¡å¼]
    
    F --> F1[Luaè„šæœ¬]
    F --> F2[å‘å¸ƒè®¢é˜…]
    F --> F3[äº‹åŠ¡æ”¯æŒ]
```

### 1.2 Redisåº”ç”¨åœºæ™¯å¯¹æ¯”

| åº”ç”¨åœºæ™¯ | æ•°æ®ç»“æ„ | å…¸å‹ç”¨ä¾‹ | æ€§èƒ½ç‰¹ç‚¹ | é€‚ç”¨è§„æ¨¡ |
|---------|---------|---------|---------|---------|
| **ç¼“å­˜ç³»ç»Ÿ** | String/Hash | ç”¨æˆ·ä¿¡æ¯ã€å•†å“è¯¦æƒ…ã€é¡µé¢ç¼“å­˜ | è¯»å†™æå¿«ï¼Œæ”¯æŒè¿‡æœŸ | ä¸­å¤§å‹åº”ç”¨ |
| **ä¼šè¯å­˜å‚¨** | String/Hash | ç”¨æˆ·ç™»å½•çŠ¶æ€ã€è´­ç‰©è½¦ | é«˜å¹¶å‘è¯»å†™ | æ‰€æœ‰Webåº”ç”¨ |
| **è®¡æ•°ç»Ÿè®¡** | String/Hash | è®¿é—®é‡ã€ç‚¹èµæ•°ã€åº“å­˜ | åŸå­æ“ä½œï¼Œå®æ—¶æ€§å¼º | é«˜å¹¶å‘åœºæ™¯ |
| **æ’è¡Œæ¦œ** | Sorted Set | æ¸¸æˆæ’è¡Œã€çƒ­æœæ¦œã€è¯„åˆ†ç³»ç»Ÿ | è‡ªåŠ¨æ’åºï¼ŒèŒƒå›´æŸ¥è¯¢ | å®æ—¶æ’åéœ€æ±‚ |
| **æ¶ˆæ¯é˜Ÿåˆ—** | List/Stream | ä»»åŠ¡é˜Ÿåˆ—ã€äº‹ä»¶é€šçŸ¥ | é˜»å¡æ“ä½œï¼Œé¡ºåºä¿è¯ | å¼‚æ­¥å¤„ç†åœºæ™¯ |
| **åˆ†å¸ƒå¼é”** | String | èµ„æºäº’æ–¥ã€é˜²é‡å¤æäº¤ | åŸå­æ“ä½œï¼Œè¿‡æœŸæœºåˆ¶ | åˆ†å¸ƒå¼ç³»ç»Ÿ |
| **åœ°ç†ä½ç½®** | Geo | é™„è¿‘çš„äººã€é…é€èŒƒå›´ | åœ°ç†è®¡ç®—ï¼Œè·ç¦»æŸ¥è¯¢ | LBSåº”ç”¨ |

## 2. Redisæ•°æ®ç»“æ„æ·±åº¦è§£æ

### 2.1 Stringï¼ˆå­—ç¬¦ä¸²ï¼‰- æœ€åŸºç¡€çš„æ•°æ®ç±»å‹

Stringæ˜¯Redisæœ€åŸºæœ¬çš„æ•°æ®ç±»å‹ï¼Œå¯ä»¥å­˜å‚¨å­—ç¬¦ä¸²ã€æ•´æ•°æˆ–æµ®ç‚¹æ•°ï¼Œæ˜¯å…¶ä»–æ•°æ®ç»“æ„çš„åŸºç¡€ã€‚

<Tabs>
<TabItem value="basic" label="åŸºæœ¬æ“ä½œ">

```bash title="StringåŸºæœ¬æ“ä½œ"
# åŸºæœ¬è®¾ç½®å’Œè·å–
SET user:1001 "John Doe"
GET user:1001                    # è¿”å›: "John Doe"
GETSET user:1001 "Jane Doe"      # è®¾ç½®æ–°å€¼å¹¶è¿”å›æ—§å€¼
DEL user:1001                    # åˆ é™¤é”®
EXISTS user:1001                 # æ£€æŸ¥é”®æ˜¯å¦å­˜åœ¨

# æ‰¹é‡æ“ä½œ - æé«˜æ€§èƒ½
MSET user:1001 "John" user:1002 "Jane" user:1003 "Bob"
MGET user:1001 user:1002 user:1003
# è¿”å›: ["John", "Jane", "Bob"]

# æ¡ä»¶è®¾ç½®
SET lock:resource1 "owner1" NX EX 30  # ä¸å­˜åœ¨æ—¶è®¾ç½®ï¼Œ30ç§’è¿‡æœŸ
SET config:timeout "5000" XX          # å­˜åœ¨æ—¶æ‰è®¾ç½®
```

</TabItem>
<TabItem value="numeric" label="æ•°å€¼æ“ä½œ">

```bash title="æ•°å€¼æ“ä½œ"
# è®¡æ•°å™¨æ“ä½œ
SET counter 0
INCR counter                     # é€’å¢1ï¼Œè¿”å›: 1
INCRBY counter 5                 # é€’å¢5ï¼Œè¿”å›: 6
DECR counter                     # é€’å‡1ï¼Œè¿”å›: 5
DECRBY counter 3                 # é€’å‡3ï¼Œè¿”å›: 2

# æµ®ç‚¹æ•°æ“ä½œ
SET price 99.99
INCRBYFLOAT price 0.01           # è¿”å›: "100"
INCRBYFLOAT price -10.5          # è¿”å›: "89.5"

# åº”ç”¨ç¤ºä¾‹ï¼šæ–‡ç« é˜…è¯»é‡ç»Ÿè®¡
INCR article:1001:views          # æ¯æ¬¡è®¿é—®é€’å¢
GET article:1001:views           # è·å–æ€»é˜…è¯»é‡
```

</TabItem>
<TabItem value="string-ops" label="å­—ç¬¦ä¸²æ“ä½œ">

```bash title="å­—ç¬¦ä¸²æ“ä½œ"
# å­—ç¬¦ä¸²æ‹¼æ¥å’Œæˆªå–
SET message "Hello"
APPEND message " World"          # è¿”å›: 11 (æ–°é•¿åº¦)
GET message                      # è¿”å›: "Hello World"
STRLEN message                   # è¿”å›: 11

# å­å­—ç¬¦ä¸²æ“ä½œ
GETRANGE message 0 4             # è¿”å›: "Hello"
SETRANGE message 6 "Redis"       # æ›¿æ¢éƒ¨åˆ†å­—ç¬¦ä¸²
GET message                      # è¿”å›: "Hello Redis"

# ä½æ“ä½œ - é€‚ç”¨äºå¸ƒå°”æ ‡è®°
SETBIT user:1001:flags 0 1       # è®¾ç½®ç¬¬0ä½ä¸º1
GETBIT user:1001:flags 0         # è·å–ç¬¬0ä½çš„å€¼
BITCOUNT user:1001:flags         # ç»Ÿè®¡1çš„ä¸ªæ•°
```

</TabItem>
</Tabs>

#### Stringåº”ç”¨å®è·µ

```java title="Javaä¸­çš„Stringæ“ä½œå®è·µ"
@Service
public class RedisStringService {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    /**
     * ç¼“å­˜ç”¨æˆ·ä¿¡æ¯
     */
    public void cacheUserInfo(Long userId, User user) {
        String key = "user:info:" + userId;
        String userJson = JSON.toJSONString(user);
        
        // ç¼“å­˜1å°æ—¶
        redisTemplate.opsForValue().set(key, userJson, 1, TimeUnit.HOURS);
    }
    
    /**
     * è·å–ç”¨æˆ·ä¿¡æ¯
     */
    public User getUserInfo(Long userId) {
        String key = "user:info:" + userId;
        String userJson = redisTemplate.opsForValue().get(key);
        
        return userJson != null ? JSON.parseObject(userJson, User.class) : null;
    }
    
    /**
     * æ–‡ç« é˜…è¯»é‡ç»Ÿè®¡
     */
    public Long incrementArticleViews(Long articleId) {
        String key = "article:views:" + articleId;
        return redisTemplate.opsForValue().increment(key);
    }
    
    /**
     * åˆ†å¸ƒå¼é”å®ç°
     */
    public boolean tryLock(String lockKey, String lockValue, long timeout) {
        Boolean result = redisTemplate.opsForValue()
            .setIfAbsent(lockKey, lockValue, timeout, TimeUnit.SECONDS);
        return Boolean.TRUE.equals(result);
    }
    
    /**
     * é™æµå™¨å®ç° - æ»‘åŠ¨çª—å£
     */
    public boolean isAllowed(String key, int maxRequests, int windowSeconds) {
        String script = 
            "local current = redis.call('incr', KEYS[1]) " +
            "if tonumber(current) == 1 then " +
            "    redis.call('expire', KEYS[1], ARGV[1]) " +
            "end " +
            "return tonumber(current) <= tonumber(ARGV[2])";
        
        Long result = redisTemplate.execute(
            new DefaultRedisScript<>(script, Long.class),
            Collections.singletonList(key),
            String.valueOf(windowSeconds),
            String.valueOf(maxRequests)
        );
        
        return Long.valueOf(1).equals(result);
    }
}
```

### 2.2 Hashï¼ˆå“ˆå¸Œï¼‰- å¯¹è±¡å­˜å‚¨çš„æœ€ä½³é€‰æ‹©

Hashæ˜¯ä¸€ä¸ªé”®å€¼å¯¹é›†åˆï¼Œç‰¹åˆ«é€‚åˆå­˜å‚¨å¯¹è±¡æ•°æ®ï¼Œç›¸æ¯”Stringå­˜å‚¨JSONæœ‰æ›´å¥½çš„æ€§èƒ½å’Œçµæ´»æ€§ã€‚

<Tabs>
<TabItem value="basic" label="åŸºæœ¬æ“ä½œ">

```bash title="HashåŸºæœ¬æ“ä½œ"
# å•ä¸ªå­—æ®µæ“ä½œ
HSET user:1001 name "John Doe"
HSET user:1001 age 25
HSET user:1001 email "john@example.com"

HGET user:1001 name              # è¿”å›: "John Doe"
HGETALL user:1001                # è¿”å›æ‰€æœ‰å­—æ®µå’Œå€¼
HDEL user:1001 age               # åˆ é™¤ageå­—æ®µ
HEXISTS user:1001 name           # æ£€æŸ¥å­—æ®µæ˜¯å¦å­˜åœ¨

# æ‰¹é‡æ“ä½œ
HMSET user:1002 name "Jane" age 30 email "jane@example.com" city "Beijing"
HMGET user:1002 name age email   # æ‰¹é‡è·å–æŒ‡å®šå­—æ®µ
```

</TabItem>
<TabItem value="advanced" label="é«˜çº§æ“ä½œ">

```bash title="Hashé«˜çº§æ“ä½œ"
# æ•°å€¼æ“ä½œ
HSET product:1001 price 99.99
HSET product:1001 stock 100
HINCRBY product:1001 stock -1    # åº“å­˜å‡1
HINCRBYFLOAT product:1001 price 0.01  # ä»·æ ¼å¢åŠ 0.01

# å­—æ®µä¿¡æ¯è·å–
HKEYS user:1001                  # è·å–æ‰€æœ‰å­—æ®µå
HVALS user:1001                  # è·å–æ‰€æœ‰å­—æ®µå€¼
HLEN user:1001                   # è·å–å­—æ®µæ•°é‡

# æ¡ä»¶è®¾ç½®
HSETNX user:1001 phone "1234567890"  # å­—æ®µä¸å­˜åœ¨æ—¶æ‰è®¾ç½®
```

</TabItem>
<TabItem value="use-cases" label="åº”ç”¨åœºæ™¯">

```bash title="Hashå…¸å‹åº”ç”¨åœºæ™¯"
# 1. ç”¨æˆ·ä¿¡æ¯å­˜å‚¨
HMSET user:1001 
    name "John Doe" 
    age 25 
    email "john@example.com" 
    phone "1234567890"
    created_at "2025-01-01"
    last_login "2025-08-11"

# 2. è´­ç‰©è½¦å®ç°
HSET cart:user:1001 product:1001 2    # å•†å“1001ï¼Œæ•°é‡2
HSET cart:user:1001 product:1002 1    # å•†å“1002ï¼Œæ•°é‡1
HINCRBY cart:user:1001 product:1001 1 # å¢åŠ å•†å“1001æ•°é‡
HGETALL cart:user:1001                # è·å–æ•´ä¸ªè´­ç‰©è½¦

# 3. å•†å“ä¿¡æ¯ç¼“å­˜
HMSET product:1001 
    name "iPhone 15" 
    price 5999 
    stock 100 
    category "electronics"
    brand "Apple"
    
# 4. é…ç½®ä¿¡æ¯ç®¡ç†
HMSET config:app 
    name "MyApp" 
    version "1.0.0" 
    port 8080 
    debug true
    max_connections 1000
```

</TabItem>
</Tabs>

#### Hash vs String æ€§èƒ½å¯¹æ¯”

| å¯¹æ¯”ç»´åº¦ | Hash | String (JSON) | ä¼˜åŠ¿åˆ†æ |
|---------|------|---------------|---------|
| **å†…å­˜ä½¿ç”¨** | æ›´èŠ‚çœ | è¾ƒå¤š | Hashé¿å…äº†JSONåºåˆ—åŒ–å¼€é”€ |
| **éƒ¨åˆ†æ›´æ–°** | æ”¯æŒ | éœ€è¦å…¨é‡æ›´æ–° | Hashå¯ä»¥åªæ›´æ–°å•ä¸ªå­—æ®µ |
| **æŸ¥è¯¢æ€§èƒ½** | å•å­—æ®µå¿« | å…¨é‡è§£æ | Hashæ”¯æŒå­—æ®µçº§åˆ«çš„æ“ä½œ |
| **æ•°æ®ç±»å‹** | åŸç”Ÿæ”¯æŒ | å­—ç¬¦ä¸² | Hashæ”¯æŒæ•°å€¼æ“ä½œ |
| **å¤æ‚æŸ¥è¯¢** | æœ‰é™ | çµæ´» | JSONæ”¯æŒå¤æ‚åµŒå¥—ç»“æ„ |

### 2.3 Listï¼ˆåˆ—è¡¨ï¼‰- æœ‰åºæ•°æ®çš„ç†æƒ³é€‰æ‹©

Listæ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œæ”¯æŒä»ä¸¤ç«¯æ·»åŠ æˆ–åˆ é™¤å…ƒç´ ï¼Œé€‚åˆå®ç°é˜Ÿåˆ—ã€æ ˆå’Œæ—¶é—´çº¿ç­‰åœºæ™¯ã€‚

<Tabs>
<TabItem value="basic" label="åŸºæœ¬æ“ä½œ">

```bash title="ListåŸºæœ¬æ“ä½œ"
# æ·»åŠ å…ƒç´ 
LPUSH mylist "item1"             # å·¦ç«¯æ·»åŠ 
RPUSH mylist "item2" "item3"     # å³ç«¯æ·»åŠ å¤šä¸ªå…ƒç´ 
LINSERT mylist BEFORE "item2" "new_item"  # åœ¨æŒ‡å®šå…ƒç´ å‰æ’å…¥

# è·å–å…ƒç´ 
LRANGE mylist 0 -1               # è·å–æ‰€æœ‰å…ƒç´ 
LINDEX mylist 0                  # è·å–æŒ‡å®šä½ç½®çš„å…ƒç´ 
LLEN mylist                      # è·å–åˆ—è¡¨é•¿åº¦

# åˆ é™¤å…ƒç´ 
LPOP mylist                      # å·¦ç«¯å¼¹å‡º
RPOP mylist                      # å³ç«¯å¼¹å‡º
LREM mylist 1 "item1"            # åˆ é™¤æŒ‡å®šæ•°é‡çš„å…ƒç´ 
LTRIM mylist 0 99                # ä¿ç•™æŒ‡å®šèŒƒå›´çš„å…ƒç´ 
```

</TabItem>
<TabItem value="blocking" label="é˜»å¡æ“ä½œ">

```bash title="Listé˜»å¡æ“ä½œ"
# é˜»å¡å¼¹å‡º - å®ç°æ¶ˆæ¯é˜Ÿåˆ—
BLPOP queue:tasks 10             # é˜»å¡10ç§’ç­‰å¾…å·¦ç«¯å¼¹å‡º
BRPOP queue:tasks 0              # æ— é™ç­‰å¾…å³ç«¯å¼¹å‡º
BRPOPLPUSH source dest 5         # ä»sourceå¼¹å‡ºå¹¶æ¨å…¥dest

# ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼
# ç”Ÿäº§è€…
LPUSH queue:emails "email1@example.com"
LPUSH queue:emails "email2@example.com"

# æ¶ˆè´¹è€…
BRPOP queue:emails 0             # é˜»å¡ç­‰å¾…é‚®ä»¶ä»»åŠ¡
```

</TabItem>
<TabItem value="applications" label="åº”ç”¨åœºæ™¯">

```bash title="Liståº”ç”¨åœºæ™¯"
# 1. æ¶ˆæ¯é˜Ÿåˆ—å®ç°
LPUSH queue:notifications "user:1001:login"
LPUSH queue:notifications "order:2001:created"
BRPOP queue:notifications 0      # æ¶ˆè´¹è€…è·å–é€šçŸ¥

# 2. ç”¨æˆ·åŠ¨æ€æ—¶é—´çº¿
LPUSH user:1001:timeline "post:3001"
LPUSH user:1001:timeline "post:3002"
LRANGE user:1001:timeline 0 9    # è·å–æœ€æ–°10æ¡åŠ¨æ€

# 3. æœ€è¿‘è®¿é—®è®°å½•
LPUSH user:1001:recent_pages "page:home"
LPUSH user:1001:recent_pages "page:product:1001"
LTRIM user:1001:recent_pages 0 19  # åªä¿ç•™æœ€è¿‘20æ¡è®°å½•

# 4. ä»»åŠ¡é˜Ÿåˆ—
LPUSH tasks:high_priority "task:urgent:1001"
LPUSH tasks:normal "task:normal:2001"
BRPOP tasks:high_priority tasks:normal 0  # ä¼˜å…ˆå¤„ç†é«˜ä¼˜å…ˆçº§ä»»åŠ¡
```

</TabItem>
</Tabs>

### 2.4 Setï¼ˆé›†åˆï¼‰- å»é‡å’Œé›†åˆè¿ç®—

Setæ˜¯ä¸€ä¸ªæ— åºçš„å­—ç¬¦ä¸²é›†åˆï¼Œä¸å…è®¸é‡å¤å…ƒç´ ï¼Œæ”¯æŒé›†åˆé—´çš„äº¤é›†ã€å¹¶é›†ã€å·®é›†è¿ç®—ã€‚

<Tabs>
<TabItem value="basic" label="åŸºæœ¬æ“ä½œ">

```bash title="SetåŸºæœ¬æ“ä½œ"
# æ·»åŠ å’Œåˆ é™¤
SADD myset "member1" "member2" "member3"
SREM myset "member1"             # åˆ é™¤æˆå‘˜
SMEMBERS myset                   # è·å–æ‰€æœ‰æˆå‘˜
SCARD myset                      # è·å–æˆå‘˜æ•°é‡
SISMEMBER myset "member2"        # æ£€æŸ¥æˆå‘˜æ˜¯å¦å­˜åœ¨

# éšæœºæ“ä½œ
SRANDMEMBER myset 2              # éšæœºè·å–2ä¸ªæˆå‘˜
SPOP myset                       # éšæœºå¼¹å‡ºå¹¶åˆ é™¤ä¸€ä¸ªæˆå‘˜
```

</TabItem>
<TabItem value="set-ops" label="é›†åˆè¿ç®—">

```bash title="Seté›†åˆè¿ç®—"
# åˆ›å»ºæµ‹è¯•é›†åˆ
SADD set1 "a" "b" "c" "d"
SADD set2 "b" "c" "e" "f"
SADD set3 "c" "d" "g" "h"

# äº¤é›†è¿ç®—
SINTER set1 set2                 # è¿”å›: ["b", "c"]
SINTERSTORE result set1 set2     # äº¤é›†ç»“æœå­˜å‚¨åˆ°result

# å¹¶é›†è¿ç®—
SUNION set1 set2                 # è¿”å›: ["a", "b", "c", "d", "e", "f"]
SUNIONSTORE result set1 set2 set3

# å·®é›†è¿ç®—
SDIFF set1 set2                  # è¿”å›: ["a", "d"] (set1ä¸­æœ‰ä½†set2ä¸­æ²¡æœ‰)
SDIFFSTORE result set1 set2
```

</TabItem>
<TabItem value="use-cases" label="åº”ç”¨åœºæ™¯">

```bash title="Setåº”ç”¨åœºæ™¯"
# 1. ç”¨æˆ·æ ‡ç­¾ç³»ç»Ÿ
SADD user:1001:tags "java" "redis" "mysql" "spring"
SADD user:1002:tags "python" "redis" "mongodb" "django"
SINTER user:1001:tags user:1002:tags  # å…±åŒæŠ€èƒ½æ ‡ç­¾

# 2. å¥½å‹å…³ç³»
SADD user:1001:friends "user:1002" "user:1003" "user:1004"
SADD user:1002:friends "user:1001" "user:1005" "user:1006"
SINTER user:1001:friends user:1002:friends  # å…±åŒå¥½å‹

# 3. æ–‡ç« ç‚¹èµç”¨æˆ·
SADD article:1001:likes "user:1001" "user:1002" "user:1003"
SCARD article:1001:likes         # ç‚¹èµæ€»æ•°
SISMEMBER article:1001:likes "user:1001"  # æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç‚¹èµ

# 4. åœ¨çº¿ç”¨æˆ·ç»Ÿè®¡
SADD online:users "user:1001" "user:1002"
SCARD online:users               # åœ¨çº¿ç”¨æˆ·æ•°
SREM online:users "user:1001"    # ç”¨æˆ·ä¸‹çº¿

# 5. æŠ½å¥–ç³»ç»Ÿ
SADD lottery:participants "user:1001" "user:1002" "user:1003"
SPOP lottery:participants        # éšæœºæŠ½å–è·å¥–è€…
```

</TabItem>
</Tabs>

### 2.5 Sorted Setï¼ˆæœ‰åºé›†åˆï¼‰- æ’åºå’Œæ’å

Sorted Setæ˜¯ä¸€ä¸ªæœ‰åºçš„å­—ç¬¦ä¸²é›†åˆï¼Œæ¯ä¸ªæˆå‘˜éƒ½æœ‰ä¸€ä¸ªåˆ†æ•°ï¼ŒæŒ‰åˆ†æ•°æ’åºï¼Œé€‚åˆå®ç°æ’è¡Œæ¦œã€ä¼˜å…ˆçº§é˜Ÿåˆ—ç­‰ã€‚

<Tabs>
<TabItem value="basic" label="åŸºæœ¬æ“ä½œ">

```bash title="Sorted SetåŸºæœ¬æ“ä½œ"
# æ·»åŠ æˆå‘˜
ZADD leaderboard 1000 "player1"
ZADD leaderboard 1200 "player2" 800 "player3"

# è·å–ä¿¡æ¯
ZSCORE leaderboard "player1"     # è·å–åˆ†æ•°: 1000
ZRANK leaderboard "player1"      # è·å–æ’å(å‡åº): 1
ZREVRANK leaderboard "player1"   # è·å–æ’å(é™åº): 1
ZCARD leaderboard                # è·å–æˆå‘˜æ€»æ•°

# èŒƒå›´æŸ¥è¯¢
ZRANGE leaderboard 0 -1          # è·å–æ‰€æœ‰æˆå‘˜(å‡åº)
ZREVRANGE leaderboard 0 -1       # è·å–æ‰€æœ‰æˆå‘˜(é™åº)
ZRANGE leaderboard 0 -1 WITHSCORES  # åŒ…å«åˆ†æ•°
```

</TabItem>
<TabItem value="advanced" label="é«˜çº§æ“ä½œ">

```bash title="Sorted Seté«˜çº§æ“ä½œ"
# åˆ†æ•°èŒƒå›´æŸ¥è¯¢
ZRANGEBYSCORE leaderboard 800 1200        # åˆ†æ•°åœ¨800-1200ä¹‹é—´
ZREVRANGEBYSCORE leaderboard 1200 800     # é™åº
ZCOUNT leaderboard 800 1200               # ç»Ÿè®¡èŒƒå›´å†…æˆå‘˜æ•°

# åˆ é™¤æ“ä½œ
ZREM leaderboard "player1"                # åˆ é™¤æˆå‘˜
ZREMRANGEBYRANK leaderboard 0 2           # åˆ é™¤æ’åå‰3çš„æˆå‘˜
ZREMRANGEBYSCORE leaderboard 0 500        # åˆ é™¤åˆ†æ•°0-500çš„æˆå‘˜

# åˆ†æ•°æ“ä½œ
ZINCRBY leaderboard 100 "player1"         # å¢åŠ åˆ†æ•°
ZINCRBY leaderboard -50 "player2"         # å‡å°‘åˆ†æ•°

# é›†åˆè¿ç®—
ZUNIONSTORE result 2 set1 set2 WEIGHTS 1 2  # å¹¶é›†ï¼Œset2æƒé‡ä¸º2
ZINTERSTORE result 2 set1 set2 AGGREGATE MAX # äº¤é›†ï¼Œå–æœ€å¤§åˆ†æ•°
```

</TabItem>
<TabItem value="use-cases" label="åº”ç”¨åœºæ™¯">

```bash title="Sorted Setåº”ç”¨åœºæ™¯"
# 1. æ¸¸æˆæ’è¡Œæ¦œ
ZADD game:leaderboard 15000 "player:1001"
ZADD game:leaderboard 12000 "player:1002"
ZADD game:leaderboard 18000 "player:1003"
ZREVRANGE game:leaderboard 0 9 WITHSCORES  # è·å–å‰10å

# 2. çƒ­æœæ’è¡Œ
ZADD trending:topics 1500 "Redisæ•™ç¨‹"
ZADD trending:topics 1200 "Javaé¢è¯•"
ZADD trending:topics 1800 "Spring Boot"
ZREVRANGE trending:topics 0 4             # è·å–å‰5ä¸ªçƒ­æœ

# 3. æ—¶é—´çº¿æ’åº
ZADD user:1001:timeline 1640995200 "post:1001"
ZADD user:1001:timeline 1640995300 "post:1002"
ZREVRANGE user:1001:timeline 0 9          # è·å–æœ€æ–°10æ¡åŠ¨æ€

# 4. ä¼˜å…ˆçº§ä»»åŠ¡é˜Ÿåˆ—
ZADD tasks:queue 1 "low_priority_task"
ZADD tasks:queue 5 "high_priority_task"
ZADD tasks:queue 3 "medium_priority_task"
ZREVRANGE tasks:queue 0 0                 # è·å–æœ€é«˜ä¼˜å…ˆçº§ä»»åŠ¡

# 5. å•†å“é”€é‡æ’è¡Œ
ZADD products:sales 500 "product:1001"
ZADD products:sales 800 "product:1002"
ZINCRBY products:sales 1 "product:1001"   # é”€é‡+1
ZREVRANGE products:sales 0 9 WITHSCORES   # é”€é‡æ’è¡Œæ¦œ
```

</TabItem>
</Tabs>

### 2.6 Streamï¼ˆæµï¼‰- ç°ä»£æ¶ˆæ¯é˜Ÿåˆ—è§£å†³æ–¹æ¡ˆ

Streamæ˜¯Redis 5.0å¼•å…¥çš„æ–°æ•°æ®ç±»å‹ï¼Œä¸“é—¨ç”¨äºæ„å»ºæ¶ˆæ¯é˜Ÿåˆ—å’Œäº‹ä»¶æµå¤„ç†ç³»ç»Ÿï¼Œæ”¯æŒæ¶ˆè´¹è€…ç»„ã€æ¶ˆæ¯ç¡®è®¤ç­‰é«˜çº§ç‰¹æ€§ã€‚

<Tabs>
<TabItem value="basic" label="åŸºæœ¬æ“ä½œ">

```bash title="StreamåŸºæœ¬æ“ä½œ"
# æ·»åŠ æ¶ˆæ¯
XADD user_events * user_id 1001 action "login" timestamp 1640995200
XADD user_events * user_id 1002 action "logout" timestamp 1640995300
XADD user_events 1640995400000-0 user_id 1003 action "purchase" amount 99.99

# è¯»å–æ¶ˆæ¯
XREAD COUNT 10 STREAMS user_events 0      # ä»å¼€å§‹è¯»å–10æ¡æ¶ˆæ¯
XREAD BLOCK 5000 STREAMS user_events $    # é˜»å¡5ç§’ç­‰å¾…æ–°æ¶ˆæ¯
XREAD STREAMS user_events order_events 0-0 0-0  # ä»å¤šä¸ªæµè¯»å–

# èŒƒå›´æŸ¥è¯¢
XRANGE user_events - +                    # è·å–æ‰€æœ‰æ¶ˆæ¯
XRANGE user_events 1640995200000 1640995400000  # æ—¶é—´èŒƒå›´æŸ¥è¯¢
XREVRANGE user_events + - COUNT 5         # åå‘è·å–æœ€æ–°5æ¡æ¶ˆæ¯

# æµä¿¡æ¯
XLEN user_events                          # è·å–æ¶ˆæ¯æ•°é‡
XINFO STREAM user_events                  # è·å–æµè¯¦ç»†ä¿¡æ¯
```

</TabItem>
<TabItem value="consumer-group" label="æ¶ˆè´¹è€…ç»„">

```bash title="Streamæ¶ˆè´¹è€…ç»„"
# åˆ›å»ºæ¶ˆè´¹è€…ç»„
XGROUP CREATE user_events analytics_group $     # ä»æœ€æ–°æ¶ˆæ¯å¼€å§‹
XGROUP CREATE user_events backup_group 0        # ä»å¤´å¼€å§‹æ¶ˆè´¹

# æ¶ˆè´¹è€…è¯»å–æ¶ˆæ¯
XREADGROUP GROUP analytics_group consumer1 COUNT 1 STREAMS user_events >
XREADGROUP GROUP analytics_group consumer2 COUNT 5 STREAMS user_events >

# æ¶ˆæ¯ç¡®è®¤
XACK user_events analytics_group 1640995200000-0

# æŸ¥çœ‹å¾…ç¡®è®¤æ¶ˆæ¯
XPENDING user_events analytics_group              # æŸ¥çœ‹ç»„çš„å¾…ç¡®è®¤æ¶ˆæ¯
XPENDING user_events analytics_group - + 10 consumer1  # æŸ¥çœ‹ç‰¹å®šæ¶ˆè´¹è€…çš„å¾…ç¡®è®¤æ¶ˆæ¯

# å£°æ˜æ¶ˆæ¯æ‰€æœ‰æƒï¼ˆå¤„ç†æ•…éšœæ¶ˆè´¹è€…çš„æ¶ˆæ¯ï¼‰
XCLAIM user_events analytics_group consumer2 3600000 1640995200000-0

# åˆ é™¤æ¶ˆæ¯
XDEL user_events 1640995200000-0
XTRIM user_events MAXLEN 1000              # ä¿ç•™æœ€æ–°1000æ¡æ¶ˆæ¯
```

</TabItem>
<TabItem value="use-cases" label="åº”ç”¨åœºæ™¯">

```bash title="Streamåº”ç”¨åœºæ™¯"
# 1. ç”¨æˆ·è¡Œä¸ºäº‹ä»¶æµ
XADD user_behavior * user_id 1001 page "home" action "view" timestamp 1640995200
XADD user_behavior * user_id 1001 page "product" action "click" product_id 2001
XADD user_behavior * user_id 1001 action "purchase" order_id 3001 amount 299.99

# æ¶ˆè´¹è€…ç»„å¤„ç†ä¸åŒä¸šåŠ¡
XGROUP CREATE user_behavior analytics_group $    # æ•°æ®åˆ†æç»„
XGROUP CREATE user_behavior recommendation_group $  # æ¨èç³»ç»Ÿç»„

# 2. è®¢å•çŠ¶æ€å˜æ›´æµ
XADD order_events * order_id 1001 status "created" user_id 2001
XADD order_events * order_id 1001 status "paid" payment_id 3001
XADD order_events * order_id 1001 status "shipped" tracking_no "SF123456"

# 3. ç³»ç»Ÿæ—¥å¿—æµ
XADD system_logs * level "ERROR" service "user-service" message "Database connection failed"
XADD system_logs * level "INFO" service "order-service" message "Order processed successfully"

# 4. å®æ—¶é€šçŸ¥æµ
XADD notifications * user_id 1001 type "order_shipped" title "æ‚¨çš„è®¢å•å·²å‘è´§"
XADD notifications * user_id 1001 type "friend_request" from_user 2001
```

</TabItem>
</Tabs>

#### Stream vs ä¼ ç»Ÿæ¶ˆæ¯é˜Ÿåˆ—å¯¹æ¯”

| ç‰¹æ€§ | Redis Stream | RabbitMQ | Kafka | é€‚ç”¨åœºæ™¯ |
|------|-------------|----------|-------|---------|
| **æ¶ˆæ¯æŒä¹…åŒ–** | æ”¯æŒ | æ”¯æŒ | æ”¯æŒ | æ‰€æœ‰åœºæ™¯ |
| **æ¶ˆè´¹è€…ç»„** | æ”¯æŒ | æ”¯æŒ | æ”¯æŒ | å¤šæ¶ˆè´¹è€…åœºæ™¯ |
| **æ¶ˆæ¯ç¡®è®¤** | æ”¯æŒ | æ”¯æŒ | æ”¯æŒ | å¯é æ€§è¦æ±‚é«˜ |
| **æ¶ˆæ¯å›æº¯** | æ”¯æŒ | æœ‰é™ | æ”¯æŒ | éœ€è¦é‡æ–°å¤„ç†å†å²æ¶ˆæ¯ |
| **æ€§èƒ½** | æé«˜ | é«˜ | æé«˜ | é«˜å¹¶å‘åœºæ™¯ |
| **è¿ç»´å¤æ‚åº¦** | ä½ | ä¸­ | é«˜ | ç®€å•éƒ¨ç½²éœ€æ±‚ |
| **ç”Ÿæ€ç³»ç»Ÿ** | Redisç”Ÿæ€ | ä¸°å¯Œ | ä¸°å¯Œ | å·²æœ‰RedisåŸºç¡€è®¾æ–½ |

## 3. RedisæŒä¹…åŒ–æœºåˆ¶è¯¦è§£

Redisä½œä¸ºå†…å­˜æ•°æ®åº“ï¼Œæä¾›äº†å¤šç§æŒä¹…åŒ–æœºåˆ¶æ¥ä¿è¯æ•°æ®çš„å®‰å…¨æ€§å’Œå¯æ¢å¤æ€§ã€‚

### 3.1 RDBæŒä¹…åŒ– - å¿«ç…§å¤‡ä»½

RDBï¼ˆRedis Databaseï¼‰é€šè¿‡åˆ›å»ºæ•°æ®å¿«ç…§æ¥å®ç°æŒä¹…åŒ–ï¼Œæ˜¯Redisçš„é»˜è®¤æŒä¹…åŒ–æ–¹å¼ã€‚

```mermaid
graph LR
    A[å†…å­˜æ•°æ®] --> B[Forkå­è¿›ç¨‹]
    B --> C[åˆ›å»ºRDBæ–‡ä»¶]
    C --> D[åŸå­æ›¿æ¢æ—§æ–‡ä»¶]
    D --> E[æŒä¹…åŒ–å®Œæˆ]
    
    F[è§¦å‘æ¡ä»¶] --> F1[å®šæ—¶è§¦å‘]
    F --> F2[æ‰‹åŠ¨è§¦å‘]
    F --> F3[å…³é—­è§¦å‘]
```

<Tabs>
<TabItem value="config" label="RDBé…ç½®">

```bash title="RDBé…ç½®è¯¦è§£"
# redis.conf é…ç½®
save 900 1          # 900ç§’å†…è‡³å°‘1ä¸ªkeyå˜åŒ–æ—¶ä¿å­˜
save 300 10         # 300ç§’å†…è‡³å°‘10ä¸ªkeyå˜åŒ–æ—¶ä¿å­˜  
save 60 10000       # 60ç§’å†…è‡³å°‘10000ä¸ªkeyå˜åŒ–æ—¶ä¿å­˜

# å…¶ä»–RDBé…ç½®
stop-writes-on-bgsave-error yes    # RDBä¿å­˜å¤±è´¥æ—¶åœæ­¢å†™å…¥
rdbcompression yes                 # å¯ç”¨RDBæ–‡ä»¶å‹ç¼©
rdbchecksum yes                    # å¯ç”¨RDBæ–‡ä»¶æ ¡éªŒ
dbfilename dump.rdb                # RDBæ–‡ä»¶å
dir /var/lib/redis                 # RDBæ–‡ä»¶ä¿å­˜ç›®å½•

# æ‰‹åŠ¨è§¦å‘RDB
SAVE                               # åŒæ­¥ä¿å­˜ï¼ˆé˜»å¡ï¼‰
BGSAVE                            # å¼‚æ­¥ä¿å­˜ï¼ˆéé˜»å¡ï¼‰
LASTSAVE                          # è·å–æœ€åä¿å­˜æ—¶é—´
```

</TabItem>
<TabItem value="process" label="RDBè¿‡ç¨‹">

```bash title="RDBæŒä¹…åŒ–è¿‡ç¨‹"
# 1. è§¦å‘æ¡ä»¶æ£€æŸ¥
# - å®šæ—¶æ£€æŸ¥saveé…ç½®æ¡ä»¶
# - æ‰‹åŠ¨æ‰§è¡ŒSAVE/BGSAVEå‘½ä»¤
# - æœåŠ¡å™¨å…³é—­æ—¶è‡ªåŠ¨ä¿å­˜

# 2. Forkå­è¿›ç¨‹ï¼ˆBGSAVEï¼‰
# - ä¸»è¿›ç¨‹forkå‡ºå­è¿›ç¨‹
# - å­è¿›ç¨‹ç»§æ‰¿ä¸»è¿›ç¨‹çš„å†…å­˜å¿«ç…§
# - ä¸»è¿›ç¨‹ç»§ç»­å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚

# 3. å†™å…¥RDBæ–‡ä»¶
# - å­è¿›ç¨‹å°†å†…å­˜æ•°æ®å†™å…¥ä¸´æ—¶RDBæ–‡ä»¶
# - ä½¿ç”¨äºŒè¿›åˆ¶æ ¼å¼ï¼Œé«˜åº¦å‹ç¼©
# - åŒ…å«æ•°æ®åº“é€‰æ‹©ã€é”®å€¼å¯¹ã€è¿‡æœŸæ—¶é—´ç­‰ä¿¡æ¯

# 4. åŸå­æ›¿æ¢
# - å†™å…¥å®Œæˆåï¼ŒåŸå­æ€§åœ°æ›¿æ¢æ—§RDBæ–‡ä»¶
# - ç¡®ä¿RDBæ–‡ä»¶çš„å®Œæ•´æ€§

# RDBæ–‡ä»¶ç»“æ„ç¤ºä¾‹
REDIS0009       # Redisç‰ˆæœ¬å’ŒRDBç‰ˆæœ¬
$6              # æ•°æ®åº“ç¼–å·
redis-ver$5     # Redisç‰ˆæœ¬ä¿¡æ¯
redis-bits$2    # æ¶æ„ä¿¡æ¯
ctime$10        # åˆ›å»ºæ—¶é—´
used-mem$8      # ä½¿ç”¨å†…å­˜
...             # é”®å€¼å¯¹æ•°æ®
$FF             # ç»“æŸæ ‡è®°
$8              # æ ¡éªŒå’Œ
```

</TabItem>
<TabItem value="pros-cons" label="ä¼˜ç¼ºç‚¹åˆ†æ">

```bash title="RDBä¼˜ç¼ºç‚¹åˆ†æ"
# âœ… RDBä¼˜ç‚¹
# 1. æ–‡ä»¶ç´§å‡‘ï¼šé«˜åº¦å‹ç¼©çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œé€‚åˆå¤‡ä»½å’Œä¼ è¾“
# 2. æ¢å¤é€Ÿåº¦å¿«ï¼šç›´æ¥åŠ è½½åˆ°å†…å­˜ï¼Œå¯åŠ¨é€Ÿåº¦å¿«
# 3. æ€§èƒ½å½±å“å°ï¼šä½¿ç”¨forkå­è¿›ç¨‹ï¼Œå¯¹ä¸»è¿›ç¨‹å½±å“æœ€å°
# 4. é€‚åˆç¾å¤‡ï¼šå¯ä»¥å®šæœŸå¤‡ä»½åˆ°è¿œç¨‹å­˜å‚¨

# âŒ RDBç¼ºç‚¹  
# 1. æ•°æ®ä¸¢å¤±é£é™©ï¼šä¸¤æ¬¡å¿«ç…§é—´çš„æ•°æ®å¯èƒ½ä¸¢å¤±
# 2. Forkå¼€é”€ï¼šå¤§æ•°æ®é›†æ—¶forkå¯èƒ½è€—æ—¶è¾ƒé•¿
# 3. ä¸é€‚åˆå®æ—¶ï¼šæ— æ³•åšåˆ°ç§’çº§çš„æ•°æ®æŒä¹…åŒ–
# 4. ç‰ˆæœ¬å…¼å®¹æ€§ï¼šä¸åŒRedisç‰ˆæœ¬çš„RDBæ ¼å¼å¯èƒ½ä¸å…¼å®¹

# é€‚ç”¨åœºæ™¯
# - å¯¹æ•°æ®ä¸¢å¤±å®¹å¿åº¦è¾ƒé«˜çš„åœºæ™¯
# - éœ€è¦å®šæœŸå¤‡ä»½çš„åœºæ™¯  
# - ä¸»ä»å¤åˆ¶çš„å…¨é‡åŒæ­¥
# - å¿«é€Ÿé‡å¯æ¢å¤çš„åœºæ™¯
```

</TabItem>
</Tabs>

### 3.2 AOFæŒä¹…åŒ– - æ“ä½œæ—¥å¿—

AOFï¼ˆAppend Only Fileï¼‰é€šè¿‡è®°å½•æ¯ä¸ªå†™æ“ä½œå‘½ä»¤æ¥å®ç°æŒä¹…åŒ–ï¼Œæä¾›æ›´å¥½çš„æ•°æ®å®‰å…¨æ€§ã€‚

<Tabs>
<TabItem value="config" label="AOFé…ç½®">

```bash title="AOFé…ç½®è¯¦è§£"
# redis.conf é…ç½®
appendonly yes                          # å¯ç”¨AOFæŒä¹…åŒ–
appendfilename "appendonly.aof"         # AOFæ–‡ä»¶å
appendfsync everysec                    # åŒæ­¥ç­–ç•¥

# åŒæ­¥ç­–ç•¥é€‰é¡¹
# appendfsync always      # æ¯ä¸ªå†™å‘½ä»¤éƒ½åŒæ­¥åˆ°ç£ç›˜ï¼ˆæœ€å®‰å…¨ï¼Œæ€§èƒ½æœ€ä½ï¼‰
# appendfsync everysec    # æ¯ç§’åŒæ­¥ä¸€æ¬¡ï¼ˆå¹³è¡¡å®‰å…¨æ€§å’Œæ€§èƒ½ï¼‰
# appendfsync no          # ç”±æ“ä½œç³»ç»Ÿå†³å®šä½•æ—¶åŒæ­¥ï¼ˆæ€§èƒ½æœ€é«˜ï¼Œå®‰å…¨æ€§æœ€ä½ï¼‰

# AOFé‡å†™é…ç½®
auto-aof-rewrite-percentage 100        # å½“AOFæ–‡ä»¶å¤§å°æ¯”ä¸Šæ¬¡é‡å†™åå¢é•¿100%æ—¶è§¦å‘é‡å†™
auto-aof-rewrite-min-size 64mb         # AOFæ–‡ä»¶æœ€å°64MBæ—¶æ‰è€ƒè™‘é‡å†™
aof-load-truncated yes                 # å¯åŠ¨æ—¶åŠ è½½è¢«æˆªæ–­çš„AOFæ–‡ä»¶
aof-rewrite-incremental-fsync yes      # é‡å†™æ—¶å¢é‡åŒæ­¥

# æ‰‹åŠ¨è§¦å‘AOFé‡å†™
BGREWRITEAOF                           # åå°é‡å†™AOFæ–‡ä»¶
```

</TabItem>
<TabItem value="rewrite" label="AOFé‡å†™">

```bash title="AOFé‡å†™æœºåˆ¶"
# AOFé‡å†™å‰åå¯¹æ¯”
# åŸå§‹AOFæ–‡ä»¶å†…å®¹ï¼š
SET counter 1
INCR counter        # counter = 2
INCR counter        # counter = 3  
INCR counter        # counter = 4
DEL counter
SET counter 100
EXPIRE counter 3600

# é‡å†™åAOFæ–‡ä»¶å†…å®¹ï¼š
SET counter 100
EXPIRE counter 3600

# AOFé‡å†™è¿‡ç¨‹
# 1. Forkå­è¿›ç¨‹
#    - ä¸»è¿›ç¨‹ç»§ç»­å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚
#    - å­è¿›ç¨‹åŸºäºå½“å‰å†…å­˜çŠ¶æ€ç”Ÿæˆæ–°AOFæ–‡ä»¶

# 2. é‡å†™ç¼“å†²åŒº
#    - ä¸»è¿›ç¨‹å°†é‡å†™æœŸé—´çš„æ–°å‘½ä»¤å†™å…¥é‡å†™ç¼“å†²åŒº
#    - ç¡®ä¿é‡å†™è¿‡ç¨‹ä¸­çš„æ•°æ®ä¸ä¸¢å¤±

# 3. æ›¿æ¢AOFæ–‡ä»¶
#    - å­è¿›ç¨‹å®Œæˆé‡å†™åï¼Œä¸»è¿›ç¨‹å°†ç¼“å†²åŒºå†…å®¹è¿½åŠ åˆ°æ–°AOFæ–‡ä»¶
#    - åŸå­æ€§åœ°æ›¿æ¢æ—§AOFæ–‡ä»¶

# 4. æ¸…ç†å·¥ä½œ
#    - æ¸…ç©ºé‡å†™ç¼“å†²åŒº
#    - æ›´æ–°AOFæ–‡ä»¶æè¿°ç¬¦
```

</TabItem>
<TabItem value="format" label="AOFæ ¼å¼">

```bash title="AOFæ–‡ä»¶æ ¼å¼"
# AOFæ–‡ä»¶é‡‡ç”¨Redisåè®®æ ¼å¼
# ç¤ºä¾‹å‘½ä»¤ï¼šSET mykey myvalue

*3              # æ•°ç»„é•¿åº¦ä¸º3
$3              # ç¬¬ä¸€ä¸ªå…ƒç´ é•¿åº¦ä¸º3
SET             # å‘½ä»¤å
$5              # ç¬¬äºŒä¸ªå…ƒç´ é•¿åº¦ä¸º5  
mykey           # é”®å
$7              # ç¬¬ä¸‰ä¸ªå…ƒç´ é•¿åº¦ä¸º7
myvalue         # å€¼

# å¤æ‚å‘½ä»¤ç¤ºä¾‹ï¼šHMSET user:1001 name "John" age 25
*6              # æ•°ç»„é•¿åº¦ä¸º6
$5              # HMSET
HMSET
$9              # user:1001
user:1001  
$4              # name
name
$4              # "John"
John
$3              # age  
age
$2              # 25
25

# AOFæ–‡ä»¶ç‰¹ç‚¹
# - çº¯æ–‡æœ¬æ ¼å¼ï¼Œå¯è¯»æ€§å¼º
# - ä¸¥æ ¼æŒ‰ç…§Redisåè®®æ ¼å¼
# - æ”¯æŒæ‰‹åŠ¨ç¼–è¾‘å’Œä¿®å¤
# - æ–‡ä»¶å¤§å°é€šå¸¸æ¯”RDBå¤§
```

</TabItem>
</Tabs>

### 3.3 æ··åˆæŒä¹…åŒ– - æœ€ä½³å®è·µ

Redis 4.0å¼•å…¥æ··åˆæŒä¹…åŒ–ï¼Œç»“åˆRDBå’ŒAOFçš„ä¼˜ç‚¹ï¼Œæ˜¯ç›®å‰æ¨èçš„æŒä¹…åŒ–æ–¹æ¡ˆã€‚

```mermaid
graph TB
    A[æ··åˆæŒä¹…åŒ–] --> B[AOFé‡å†™æ—¶]
    B --> C[RDBæ ¼å¼å†™å…¥åŸºç¡€æ•°æ®]
    B --> D[AOFæ ¼å¼è¿½åŠ å¢é‡æ•°æ®]
    
    E[æ¢å¤è¿‡ç¨‹] --> F[åŠ è½½RDBéƒ¨åˆ†]
    F --> G[é‡æ”¾AOFéƒ¨åˆ†]
    G --> H[å®Œæ•´æ¢å¤æ•°æ®]
```

<Tabs>
<TabItem value="config" label="æ··åˆæŒä¹…åŒ–é…ç½®">

```bash title="æ··åˆæŒä¹…åŒ–é…ç½®"
# redis.conf é…ç½®
appendonly yes                          # å¯ç”¨AOF
aof-use-rdb-preamble yes               # å¯ç”¨æ··åˆæŒä¹…åŒ–

# å·¥ä½œåŸç†
# 1. AOFé‡å†™æ—¶ï¼Œå°†å½“å‰æ•°æ®åº“çŠ¶æ€ä»¥RDBæ ¼å¼å†™å…¥AOFæ–‡ä»¶å¼€å¤´
# 2. é‡å†™åçš„æ–°å†™æ“ä½œä»¥AOFæ ¼å¼è¿½åŠ åˆ°æ–‡ä»¶æœ«å°¾
# 3. æ¢å¤æ—¶å…ˆåŠ è½½RDBéƒ¨åˆ†ï¼Œå†é‡æ”¾AOFéƒ¨åˆ†

# æ–‡ä»¶ç»“æ„ç¤ºä¾‹
# +-------+-------+-------+
# |  RDB  |  AOF  |  AOF  |
# | åŸºç¡€  | å¢é‡1 | å¢é‡2 |
# | æ•°æ®  | æ•°æ®  | æ•°æ®  |
# +-------+-------+-------+
```

</TabItem>
<TabItem value="comparison" label="æŒä¹…åŒ–æ–¹æ¡ˆå¯¹æ¯”">

```bash title="æŒä¹…åŒ–æ–¹æ¡ˆå…¨é¢å¯¹æ¯”"
# ğŸ“Š æ€§èƒ½å¯¹æ¯”
# RDBï¼š        â­â­â­â­â­ (æ€§èƒ½æœ€é«˜)
# AOFï¼š        â­â­â­ (ä¸­ç­‰æ€§èƒ½)  
# æ··åˆæŒä¹…åŒ–ï¼š   â­â­â­â­ (è¾ƒé«˜æ€§èƒ½)

# ğŸ›¡ï¸ æ•°æ®å®‰å…¨æ€§å¯¹æ¯”
# RDBï¼š        â­â­ (å¯èƒ½ä¸¢å¤±è¾ƒå¤šæ•°æ®)
# AOFï¼š        â­â­â­â­â­ (æ•°æ®æœ€å®‰å…¨)
# æ··åˆæŒä¹…åŒ–ï¼š   â­â­â­â­ (è¾ƒå®‰å…¨)

# ğŸ’¾ æ–‡ä»¶å¤§å°å¯¹æ¯”
# RDBï¼š        â­â­â­â­â­ (æ–‡ä»¶æœ€å°)
# AOFï¼š        â­â­ (æ–‡ä»¶è¾ƒå¤§)
# æ··åˆæŒä¹…åŒ–ï¼š   â­â­â­â­ (æ–‡ä»¶é€‚ä¸­)

# âš¡ æ¢å¤é€Ÿåº¦å¯¹æ¯”  
# RDBï¼š        â­â­â­â­â­ (æ¢å¤æœ€å¿«)
# AOFï¼š        â­â­ (æ¢å¤è¾ƒæ…¢)
# æ··åˆæŒä¹…åŒ–ï¼š   â­â­â­â­ (æ¢å¤è¾ƒå¿«)
```

</TabItem>
<TabItem value="best-practices" label="æœ€ä½³å®è·µ">

```bash title="æŒä¹…åŒ–æœ€ä½³å®è·µ"
# ğŸ¯ æ¨èé…ç½®æ–¹æ¡ˆ

# æ–¹æ¡ˆä¸€ï¼šé«˜æ€§èƒ½åœºæ™¯ï¼ˆå¯å®¹å¿å°‘é‡æ•°æ®ä¸¢å¤±ï¼‰
save 900 1
save 300 10  
save 60 10000
appendonly no

# æ–¹æ¡ˆäºŒï¼šé«˜å¯é æ€§åœºæ™¯ï¼ˆä¸èƒ½å®¹å¿æ•°æ®ä¸¢å¤±ï¼‰
appendonly yes
appendfsync everysec
aof-use-rdb-preamble yes

# æ–¹æ¡ˆä¸‰ï¼šå¹³è¡¡æ–¹æ¡ˆï¼ˆæ¨èï¼‰
save 900 1
appendonly yes  
appendfsync everysec
aof-use-rdb-preamble yes
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# ğŸ”§ è¿ç»´æœ€ä½³å®è·µ
# 1. å®šæœŸå¤‡ä»½RDBæ–‡ä»¶åˆ°è¿œç¨‹å­˜å‚¨
# 2. ç›‘æ§AOFæ–‡ä»¶å¤§å°ï¼ŒåŠæ—¶è§¦å‘é‡å†™
# 3. æµ‹è¯•æ¢å¤æµç¨‹ï¼Œç¡®ä¿å¤‡ä»½å¯ç”¨
# 4. æ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹é€‰æ‹©åˆé€‚çš„æŒä¹…åŒ–ç­–ç•¥
# 5. åœ¨ä»èŠ‚ç‚¹å…³é—­æŒä¹…åŒ–ï¼Œå‡å°‘ä¸»èŠ‚ç‚¹å‹åŠ›

# ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®
# 1. å°†RDBå’ŒAOFæ–‡ä»¶æ”¾åœ¨ä¸åŒç£ç›˜ä¸Š
# 2. ä½¿ç”¨SSDå­˜å‚¨æé«˜I/Oæ€§èƒ½
# 3. åˆç†è®¾ç½®AOFé‡å†™é˜ˆå€¼
# 4. åœ¨ä¸šåŠ¡ä½å³°æœŸæ‰§è¡ŒBGSAVEå’ŒBGREWRITEAOF
# 5. ç›‘æ§forkæ“ä½œçš„è€—æ—¶ï¼Œé¿å…é˜»å¡ä¸»è¿›ç¨‹
```

</TabItem>
</Tabs>

## 4. Redisé«˜å¯ç”¨æ¶æ„è®¾è®¡

Redisé«˜å¯ç”¨æ¶æ„æ˜¯ä¿è¯æœåŠ¡ç¨³å®šè¿è¡Œçš„å…³é”®ï¼ŒåŒ…æ‹¬ä¸»ä»å¤åˆ¶ã€å“¨å…µæ¨¡å¼å’Œé›†ç¾¤æ¨¡å¼ä¸‰ç§ä¸»è¦æ–¹æ¡ˆã€‚

### 4.1 ä¸»ä»å¤åˆ¶ - è¯»å†™åˆ†ç¦»åŸºç¡€

ä¸»ä»å¤åˆ¶æ˜¯Redisé«˜å¯ç”¨çš„åŸºç¡€ï¼Œé€šè¿‡æ•°æ®åŒæ­¥å®ç°è¯»å†™åˆ†ç¦»å’Œæ•°æ®å¤‡ä»½ã€‚

```mermaid
graph TB
    M[Masterä¸»èŠ‚ç‚¹] --> S1[Slaveä»èŠ‚ç‚¹1]
    M --> S2[Slaveä»èŠ‚ç‚¹2]  
    M --> S3[Slaveä»èŠ‚ç‚¹3]
    
    C1[å†™å®¢æˆ·ç«¯] --> M
    C2[è¯»å®¢æˆ·ç«¯1] --> S1
    C3[è¯»å®¢æˆ·ç«¯2] --> S2
    C4[è¯»å®¢æˆ·ç«¯3] --> S3
    
    M -.->|å…¨é‡åŒæ­¥| S1
    M -.->|å¢é‡åŒæ­¥| S2
    M -.->|å‘½ä»¤ä¼ æ’­| S3
```

<Tabs>
<TabItem value="config" label="ä¸»ä»é…ç½®">

```bash title="ä¸»ä»å¤åˆ¶é…ç½®"
# ä¸»èŠ‚ç‚¹é…ç½® (redis-master.conf)
bind 0.0.0.0
port 6379
daemonize yes
pidfile /var/run/redis_6379.pid
logfile /var/log/redis_6379.log
dir /var/lib/redis

# å®‰å…¨é…ç½®
requirepass master_password
masterauth master_password

# ä»èŠ‚ç‚¹é…ç½® (redis-slave.conf)  
bind 0.0.0.0
port 6380
daemonize yes
pidfile /var/run/redis_6380.pid
logfile /var/log/redis_6380.log
dir /var/lib/redis

# ä¸»ä»å…³ç³»é…ç½®
replicaof 192.168.1.100 6379        # æŒ‡å®šä¸»èŠ‚ç‚¹
masterauth master_password           # ä¸»èŠ‚ç‚¹å¯†ç 
replica-read-only yes                # ä»èŠ‚ç‚¹åªè¯»
replica-serve-stale-data yes         # è¿æ¥æ–­å¼€æ—¶ç»§ç»­æœåŠ¡

# åŠ¨æ€é…ç½®ä¸»ä»å…³ç³»
REPLICAOF 192.168.1.100 6379        # è®¾ç½®ä¸ºä»èŠ‚ç‚¹
REPLICAOF NO ONE                     # å–æ¶ˆä»èŠ‚ç‚¹èº«ä»½ï¼Œå‡çº§ä¸ºä¸»èŠ‚ç‚¹
```

</TabItem>
<TabItem value="sync-process" label="åŒæ­¥è¿‡ç¨‹">

```bash title="ä¸»ä»åŒæ­¥è¯¦ç»†è¿‡ç¨‹"
# 1ï¸âƒ£ å»ºç«‹è¿æ¥é˜¶æ®µ
# ä»èŠ‚ç‚¹ -> ä¸»èŠ‚ç‚¹: PING
# ä¸»èŠ‚ç‚¹ -> ä»èŠ‚ç‚¹: PONG
# ä»èŠ‚ç‚¹ -> ä¸»èŠ‚ç‚¹: AUTH <password>
# ä¸»èŠ‚ç‚¹ -> ä»èŠ‚ç‚¹: OK

# 2ï¸âƒ£ æ•°æ®åŒæ­¥é˜¶æ®µ
# ä»èŠ‚ç‚¹ -> ä¸»èŠ‚ç‚¹: PSYNC <runid> <offset>
# 
# æƒ…å†µAï¼šå…¨é‡åŒæ­¥
# ä¸»èŠ‚ç‚¹ -> ä»èŠ‚ç‚¹: FULLRESYNC <runid> <offset>
# ä¸»èŠ‚ç‚¹æ‰§è¡ŒBGSAVEç”ŸæˆRDBæ–‡ä»¶
# ä¸»èŠ‚ç‚¹å‘é€RDBæ–‡ä»¶ç»™ä»èŠ‚ç‚¹
# ä»èŠ‚ç‚¹æ¸…ç©ºæ•°æ®åº“å¹¶åŠ è½½RDBæ–‡ä»¶
# ä¸»èŠ‚ç‚¹å‘é€åŒæ­¥æœŸé—´çš„å†™å‘½ä»¤ç¼“å†²åŒº
#
# æƒ…å†µBï¼šéƒ¨åˆ†åŒæ­¥  
# ä¸»èŠ‚ç‚¹ -> ä»èŠ‚ç‚¹: CONTINUE
# ä¸»èŠ‚ç‚¹å‘é€å¤åˆ¶ç§¯å‹ç¼“å†²åŒºä¸­çš„æ•°æ®

# 3ï¸âƒ£ å‘½ä»¤ä¼ æ’­é˜¶æ®µ
# ä¸»èŠ‚ç‚¹æ¥æ”¶å†™å‘½ä»¤åï¼š
# 1. æ‰§è¡Œå‘½ä»¤
# 2. å‘é€å‘½ä»¤ç»™æ‰€æœ‰ä»èŠ‚ç‚¹
# 3. ä»èŠ‚ç‚¹æ‰§è¡Œå‘½ä»¤ä¿æŒæ•°æ®ä¸€è‡´

# å¤åˆ¶ç›¸å…³å‘½ä»¤
INFO replication                     # æŸ¥çœ‹å¤åˆ¶ä¿¡æ¯
ROLE                                # æŸ¥çœ‹èŠ‚ç‚¹è§’è‰²
REPLICAOF NO ONE                    # åœæ­¢å¤åˆ¶
```

</TabItem>
<TabItem value="optimization" label="å¤åˆ¶ä¼˜åŒ–">

```bash title="ä¸»ä»å¤åˆ¶ä¼˜åŒ–é…ç½®"
# å¤åˆ¶æ€§èƒ½ä¼˜åŒ–
repl-diskless-sync no               # æ˜¯å¦å¯ç”¨æ— ç›˜å¤åˆ¶
repl-diskless-sync-delay 5          # æ— ç›˜å¤åˆ¶å»¶è¿Ÿæ—¶é—´
repl-ping-replica-period 10         # ä»èŠ‚ç‚¹pingä¸»èŠ‚ç‚¹é—´éš”
repl-timeout 60                     # å¤åˆ¶è¶…æ—¶æ—¶é—´

# å¤åˆ¶ç§¯å‹ç¼“å†²åŒºé…ç½®
repl-backlog-size 1mb               # ç§¯å‹ç¼“å†²åŒºå¤§å°
repl-backlog-ttl 3600               # ç¼“å†²åŒºä¿ç•™æ—¶é—´

# ä»èŠ‚ç‚¹é…ç½®ä¼˜åŒ–
replica-priority 100                # ä»èŠ‚ç‚¹ä¼˜å…ˆçº§ï¼ˆå“¨å…µé€‰ä¸»æ—¶ä½¿ç”¨ï¼‰
replica-announce-ip 192.168.1.101  # ä»èŠ‚ç‚¹å…¬å‘ŠIP
replica-announce-port 6380          # ä»èŠ‚ç‚¹å…¬å‘Šç«¯å£

# æœ€å°ä»èŠ‚ç‚¹é…ç½®ï¼ˆé˜²æ­¢æ•°æ®ä¸¢å¤±ï¼‰
min-replicas-to-write 1             # è‡³å°‘1ä¸ªä»èŠ‚ç‚¹æ‰å…è®¸å†™å…¥
min-replicas-max-lag 10             # ä»èŠ‚ç‚¹æœ€å¤§å»¶è¿Ÿ10ç§’

# ç›‘æ§å¤åˆ¶çŠ¶æ€
# ä¸»èŠ‚ç‚¹ç›‘æ§
redis-cli -p 6379 INFO replication
# connected_slaves:2
# slave0:ip=192.168.1.101,port=6380,state=online,offset=1234,lag=0
# slave1:ip=192.168.1.102,port=6380,state=online,offset=1234,lag=1

# ä»èŠ‚ç‚¹ç›‘æ§  
redis-cli -p 6380 INFO replication
# role:slave
# master_host:192.168.1.100
# master_port:6379
# master_link_status:up
# master_last_io_seconds_ago:0
```

</TabItem>
</Tabs>

### 4.2 å“¨å…µæ¨¡å¼ - è‡ªåŠ¨æ•…éšœè½¬ç§»

Redis Sentinelæ˜¯Redisçš„é«˜å¯ç”¨è§£å†³æ–¹æ¡ˆï¼Œæä¾›ç›‘æ§ã€é€šçŸ¥ã€è‡ªåŠ¨æ•…éšœè½¬ç§»å’Œé…ç½®æä¾›è€…åŠŸèƒ½ã€‚

```mermaid
graph TB
    subgraph "å“¨å…µé›†ç¾¤"
        S1[Sentinel 1<br/>26379]
        S2[Sentinel 2<br/>26380] 
        S3[Sentinel 3<br/>26381]
    end
    
    subgraph "Redisé›†ç¾¤"
        M[Master<br/>6379]
        R1[Replica 1<br/>6380]
        R2[Replica 2<br/>6381]
    end
    
    S1 -.->|ç›‘æ§| M
    S1 -.->|ç›‘æ§| R1
    S1 -.->|ç›‘æ§| R2
    
    S2 -.->|ç›‘æ§| M
    S2 -.->|ç›‘æ§| R1
    S2 -.->|ç›‘æ§| R2
    
    S3 -.->|ç›‘æ§| M
    S3 -.->|ç›‘æ§| R1
    S3 -.->|ç›‘æ§| R2
    
    M --> R1
    M --> R2
```

<Tabs>
<TabItem value="config" label="å“¨å…µé…ç½®">

```bash title="å“¨å…µé…ç½®è¯¦è§£"
# sentinel.conf é…ç½®æ–‡ä»¶
port 26379                                    # å“¨å…µç«¯å£
daemonize yes                                # åå°è¿è¡Œ
pidfile /var/run/redis-sentinel.pid         # PIDæ–‡ä»¶
logfile /var/log/redis-sentinel.log         # æ—¥å¿—æ–‡ä»¶
dir /var/lib/redis                          # å·¥ä½œç›®å½•

# ç›‘æ§ä¸»èŠ‚ç‚¹é…ç½®
sentinel monitor mymaster 192.168.1.100 6379 2
# mymaster: ä¸»èŠ‚ç‚¹åç§°
# 192.168.1.100 6379: ä¸»èŠ‚ç‚¹åœ°å€å’Œç«¯å£  
# 2: åˆ¤æ–­ä¸»èŠ‚ç‚¹ä¸‹çº¿éœ€è¦çš„å“¨å…µæ•°é‡ï¼ˆquorumï¼‰

# è®¤è¯é…ç½®
sentinel auth-pass mymaster master_password

# æ•…éšœè½¬ç§»é…ç½®
sentinel down-after-milliseconds mymaster 5000    # 5ç§’æ— å“åº”åˆ¤å®šä¸‹çº¿
sentinel failover-timeout mymaster 15000          # æ•…éšœè½¬ç§»è¶…æ—¶æ—¶é—´
sentinel parallel-syncs mymaster 1                # åŒæ—¶åŒæ­¥çš„ä»èŠ‚ç‚¹æ•°é‡

# é€šçŸ¥è„šæœ¬é…ç½®
sentinel notification-script mymaster /opt/scripts/notify.sh
sentinel client-reconfig-script mymaster /opt/scripts/reconfig.sh

# å¯åŠ¨å“¨å…µ
redis-sentinel /etc/redis/sentinel.conf
# æˆ–è€…
redis-server /etc/redis/sentinel.conf --sentinel
```

</TabItem>
<TabItem value="failover" label="æ•…éšœè½¬ç§»æµç¨‹">

```bash title="å“¨å…µæ•…éšœè½¬ç§»è¯¦ç»†æµç¨‹"
# 1ï¸âƒ£ ä¸»è§‚ä¸‹çº¿ï¼ˆSubjectively Downï¼‰
# å•ä¸ªå“¨å…µæ£€æµ‹åˆ°ä¸»èŠ‚ç‚¹æ— å“åº”è¶…è¿‡down-after-milliseconds
# æ ‡è®°ä¸»èŠ‚ç‚¹ä¸ºä¸»è§‚ä¸‹çº¿çŠ¶æ€ï¼ˆSDOWNï¼‰

# 2ï¸âƒ£ å®¢è§‚ä¸‹çº¿ï¼ˆObjectively Downï¼‰  
# å“¨å…µè¯¢é—®å…¶ä»–å“¨å…µå¯¹ä¸»èŠ‚ç‚¹çš„çŠ¶æ€åˆ¤æ–­
# å½“è¶…è¿‡quorumæ•°é‡çš„å“¨å…µè®¤ä¸ºä¸»èŠ‚ç‚¹ä¸‹çº¿æ—¶
# æ ‡è®°ä¸»èŠ‚ç‚¹ä¸ºå®¢è§‚ä¸‹çº¿çŠ¶æ€ï¼ˆODOWNï¼‰

# 3ï¸âƒ£ é€‰ä¸¾é¢†å¯¼è€…å“¨å…µ
# å“¨å…µä¹‹é—´è¿›è¡ŒRaftç®—æ³•é€‰ä¸¾
# é€‰å‡ºè´Ÿè´£æ•…éšœè½¬ç§»çš„é¢†å¯¼è€…å“¨å…µ
# éœ€è¦è·å¾—è¶…è¿‡åŠæ•°å“¨å…µçš„æŠ•ç¥¨

# 4ï¸âƒ£ é€‰æ‹©æ–°çš„ä¸»èŠ‚ç‚¹
# é¢†å¯¼è€…å“¨å…µä»ä»èŠ‚ç‚¹ä¸­é€‰æ‹©æ–°ä¸»èŠ‚ç‚¹
# é€‰æ‹©è§„åˆ™ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰ï¼š
# a) replica-priorityæœ€å°çš„ä»èŠ‚ç‚¹
# b) å¤åˆ¶åç§»é‡æœ€å¤§çš„ä»èŠ‚ç‚¹ï¼ˆæ•°æ®æœ€æ–°ï¼‰
# c) run_idæœ€å°çš„ä»èŠ‚ç‚¹

# 5ï¸âƒ£ æ‰§è¡Œæ•…éšœè½¬ç§»
# å‘é€‰ä¸­çš„ä»èŠ‚ç‚¹å‘é€REPLICAOF NO ONEå‘½ä»¤
# å‘å…¶ä»–ä»èŠ‚ç‚¹å‘é€REPLICAOF <new_master_ip> <new_master_port>
# æ›´æ–°å“¨å…µé…ç½®æ–‡ä»¶ä¸­çš„ä¸»èŠ‚ç‚¹ä¿¡æ¯
# é€šè¿‡å‘å¸ƒè®¢é˜…é€šçŸ¥å®¢æˆ·ç«¯ä¸»èŠ‚ç‚¹å˜æ›´

# æ•…éšœè½¬ç§»ç›¸å…³å‘½ä»¤
SENTINEL masters                              # æŸ¥çœ‹æ‰€æœ‰è¢«ç›‘æ§çš„ä¸»èŠ‚ç‚¹
SENTINEL slaves mymaster                      # æŸ¥çœ‹æŒ‡å®šä¸»èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹
SENTINEL sentinels mymaster                   # æŸ¥çœ‹ç›‘æ§æŒ‡å®šä¸»èŠ‚ç‚¹çš„å“¨å…µ
SENTINEL get-master-addr-by-name mymaster     # è·å–ä¸»èŠ‚ç‚¹åœ°å€
SENTINEL failover mymaster                    # æ‰‹åŠ¨è§¦å‘æ•…éšœè½¬ç§»
SENTINEL reset mymaster                       # é‡ç½®æŒ‡å®šä¸»èŠ‚ç‚¹çš„çŠ¶æ€
```

</TabItem>
<TabItem value="client" label="å®¢æˆ·ç«¯è¿æ¥">

```java title="Javaå®¢æˆ·ç«¯å“¨å…µè¿æ¥"
@Configuration
public class RedisConfig {
    
    @Bean
    public LettuceConnectionFactory redisConnectionFactory() {
        // å“¨å…µé…ç½®
        RedisSentinelConfiguration sentinelConfig = 
            new RedisSentinelConfiguration()
                .master("mymaster")  // ä¸»èŠ‚ç‚¹åç§°
                .sentinel("192.168.1.100", 26379)  // å“¨å…µ1
                .sentinel("192.168.1.101", 26379)  // å“¨å…µ2  
                .sentinel("192.168.1.102", 26379); // å“¨å…µ3
        
        // è®¾ç½®å¯†ç 
        sentinelConfig.setPassword("master_password");
        
        // è¿æ¥æ± é…ç½®
        GenericObjectPoolConfig poolConfig = new GenericObjectPoolConfig();
        poolConfig.setMaxTotal(50);
        poolConfig.setMaxIdle(10);
        poolConfig.setMinIdle(5);
        poolConfig.setMaxWaitMillis(3000);
        
        LettucePoolingClientConfiguration clientConfig = 
            LettucePoolingClientConfiguration.builder()
                .poolConfig(poolConfig)
                .build();
        
        return new LettuceConnectionFactory(sentinelConfig, clientConfig);
    }
    
    @Bean
    public RedisTemplate<String, Object> redisTemplate(
            LettuceConnectionFactory connectionFactory) {
        RedisTemplate<String, Object> template = new RedisTemplate<>();
        template.setConnectionFactory(connectionFactory);
        
        // åºåˆ—åŒ–é…ç½®
        template.setKeySerializer(new StringRedisSerializer());
        template.setValueSerializer(new GenericJackson2JsonRedisSerializer());
        template.setHashKeySerializer(new StringRedisSerializer());
        template.setHashValueSerializer(new GenericJackson2JsonRedisSerializer());
        
        return template;
    }
}

// å®¢æˆ·ç«¯æ•…éšœè½¬ç§»å¤„ç†
@Component
public class RedisFailoverHandler implements MessageListener {
    
    private static final Logger logger = LoggerFactory.getLogger(RedisFailoverHandler.class);
    
    @Override
    public void onMessage(Message message, byte[] pattern) {
        String channel = new String(message.getChannel());
        String msg = new String(message.getBody());
        
        if ("+switch-master".equals(channel)) {
            logger.info("ä¸»èŠ‚ç‚¹åˆ‡æ¢é€šçŸ¥: {}", msg);
            // å¤„ç†ä¸»èŠ‚ç‚¹åˆ‡æ¢é€»è¾‘
            handleMasterSwitch(msg);
        }
    }
    
    private void handleMasterSwitch(String message) {
        // è§£æåˆ‡æ¢ä¿¡æ¯ï¼šmymaster 192.168.1.100 6379 192.168.1.101 6380
        String[] parts = message.split(" ");
        String masterName = parts[0];
        String oldMasterHost = parts[1];
        int oldMasterPort = Integer.parseInt(parts[2]);
        String newMasterHost = parts[3];
        int newMasterPort = Integer.parseInt(parts[4]);
        
        logger.info("ä¸»èŠ‚ç‚¹ä» {}:{} åˆ‡æ¢åˆ° {}:{}", 
            oldMasterHost, oldMasterPort, newMasterHost, newMasterPort);
        
        // æ›´æ–°åº”ç”¨ç¨‹åºé…ç½®æˆ–é‡æ–°åˆå§‹åŒ–è¿æ¥æ± 
        // å¤§å¤šæ•°Rediså®¢æˆ·ç«¯ä¼šè‡ªåŠ¨å¤„ç†è¿™ç§åˆ‡æ¢
    }
}
```

</TabItem>
<TabItem value="monitoring" label="ç›‘æ§è¿ç»´">

```bash title="å“¨å…µç›‘æ§ä¸è¿ç»´"
# å“¨å…µçŠ¶æ€ç›‘æ§
redis-cli -p 26379 SENTINEL masters
# name=mymaster,status=ok,address=192.168.1.100:6379,slaves=2,sentinels=3

redis-cli -p 26379 SENTINEL slaves mymaster
# æ˜¾ç¤ºæ‰€æœ‰ä»èŠ‚ç‚¹ä¿¡æ¯

redis-cli -p 26379 SENTINEL sentinels mymaster  
# æ˜¾ç¤ºæ‰€æœ‰å“¨å…µä¿¡æ¯

# å“¨å…µæ—¥å¿—åˆ†æ
tail -f /var/log/redis-sentinel.log
# +monitor master mymaster 192.168.1.100 6379 quorum 2
# +slave slave 192.168.1.101:6380 192.168.1.101 6380 @ mymaster 192.168.1.100 6379
# +sdown master mymaster 192.168.1.100 6379
# +odown master mymaster 192.168.1.100 6379 #quorum 2/2
# +new-epoch 1
# +try-failover master mymaster 192.168.1.100 6379
# +vote-for-leader 192.168.1.100:26379 1
# +elected-leader master mymaster 192.168.1.100 6379
# +failover-state-select-slave master mymaster 192.168.1.100 6379
# +selected-slave slave 192.168.1.101:6380 192.168.1.101 6380 @ mymaster 192.168.1.100 6379
# +failover-state-send-slaveof-noone slave 192.168.1.101:6380 192.168.1.101 6380 @ mymaster 192.168.1.100 6379
# +failover-state-wait-promotion slave 192.168.1.101:6380 192.168.1.101 6380 @ mymaster 192.168.1.100 6379
# +promoted-slave slave 192.168.1.101:6380 192.168.1.101 6380 @ mymaster 192.168.1.100 6379
# +failover-state-reconf-slaves master mymaster 192.168.1.100 6379
# +slave-reconf-sent slave 192.168.1.102:6380 192.168.1.102 6380 @ mymaster 192.168.1.100 6379
# +slave-reconf-inprog slave 192.168.1.102:6380 192.168.1.102 6380 @ mymaster 192.168.1.100 6379
# +slave-reconf-done slave 192.168.1.102:6380 192.168.1.102 6380 @ mymaster 192.168.1.100 6379
# +failover-end master mymaster 192.168.1.100 6379
# +switch-master mymaster 192.168.1.100 6379 192.168.1.101 6380

# æ€§èƒ½ç›‘æ§æŒ‡æ ‡
# 1. å“¨å…µå“åº”æ—¶é—´
# 2. æ•…éšœè½¬ç§»æ—¶é—´
# 3. ä¸»ä»å»¶è¿Ÿ
# 4. å“¨å…µä¹‹é—´çš„ç½‘ç»œå»¶è¿Ÿ
# 5. è¯¯åˆ¤ç‡ï¼ˆé¢‘ç¹æ•…éšœè½¬ç§»ï¼‰

# è¿ç»´æœ€ä½³å®è·µ
# 1. éƒ¨ç½²å¥‡æ•°ä¸ªå“¨å…µèŠ‚ç‚¹ï¼ˆè‡³å°‘3ä¸ªï¼‰
# 2. å“¨å…µéƒ¨ç½²åœ¨ä¸åŒçš„ç‰©ç†æœºå™¨ä¸Š
# 3. åˆç†è®¾ç½®down-after-millisecondsï¼ˆé¿å…ç½‘ç»œæŠ–åŠ¨è¯¯åˆ¤ï¼‰
# 4. ç›‘æ§å“¨å…µæ—¥å¿—ï¼ŒåŠæ—¶å‘ç°é—®é¢˜
# 5. å®šæœŸæµ‹è¯•æ•…éšœè½¬ç§»æµç¨‹
# 6. å®¢æˆ·ç«¯è¦æ”¯æŒå“¨å…µæ¨¡å¼çš„è‡ªåŠ¨åˆ‡æ¢
```

</TabItem>
</Tabs>

### 4.3 é›†ç¾¤æ¨¡å¼ - æ°´å¹³æ‰©å±•æ–¹æ¡ˆ

Redis Clusteræ˜¯Redisçš„åˆ†å¸ƒå¼è§£å†³æ–¹æ¡ˆï¼Œæ”¯æŒæ•°æ®åˆ†ç‰‡ã€è‡ªåŠ¨æ•…éšœè½¬ç§»å’Œæ°´å¹³æ‰©å±•ã€‚

```mermaid
graph TB
    subgraph "Redisé›†ç¾¤"
        subgraph "èŠ‚ç‚¹1"
            M1[Master 1<br/>7000<br/>Slots: 0-5460]
            S1[Slave 1<br/>7003]
        end
        
        subgraph "èŠ‚ç‚¹2"  
            M2[Master 2<br/>7001<br/>Slots: 5461-10922]
            S2[Slave 2<br/>7004]
        end
        
        subgraph "èŠ‚ç‚¹3"
            M3[Master 3<br/>7002<br/>Slots: 10923-16383]
            S3[Slave 3<br/>7005]
        end
    end
    
    M1 --> S1
    M2 --> S2  
    M3 --> S3
    
    M1 -.->|Gossipåè®®| M2
    M2 -.->|Gossipåè®®| M3
    M3 -.->|Gossipåè®®| M1
    
    C[Client] --> M1
    C --> M2
    C --> M3
```

<Tabs>
<TabItem value="setup" label="é›†ç¾¤æ­å»º">

```bash title="Redisé›†ç¾¤æ­å»º"
# 1. èŠ‚ç‚¹é…ç½®æ–‡ä»¶ (redis-7000.conf)
port 7000
cluster-enabled yes                    # å¯ç”¨é›†ç¾¤æ¨¡å¼
cluster-config-file nodes-7000.conf   # é›†ç¾¤é…ç½®æ–‡ä»¶
cluster-node-timeout 5000             # èŠ‚ç‚¹è¶…æ—¶æ—¶é—´
cluster-announce-ip 192.168.1.100     # èŠ‚ç‚¹å…¬å‘ŠIP
cluster-announce-port 7000             # èŠ‚ç‚¹å…¬å‘Šç«¯å£
cluster-announce-bus-port 17000        # é›†ç¾¤æ€»çº¿ç«¯å£

# æŒä¹…åŒ–é…ç½®
appendonly yes
appendfilename "appendonly-7000.aof"

# å…¶ä»–é…ç½®
daemonize yes
pidfile /var/run/redis_7000.pid
logfile /var/log/redis_7000.log
dir /var/lib/redis/7000

# 2. å¯åŠ¨æ‰€æœ‰èŠ‚ç‚¹
redis-server /etc/redis/redis-7000.conf
redis-server /etc/redis/redis-7001.conf  
redis-server /etc/redis/redis-7002.conf
redis-server /etc/redis/redis-7003.conf
redis-server /etc/redis/redis-7004.conf
redis-server /etc/redis/redis-7005.conf

# 3. åˆ›å»ºé›†ç¾¤
redis-cli --cluster create \
  192.168.1.100:7000 192.168.1.100:7001 192.168.1.100:7002 \
  192.168.1.100:7003 192.168.1.100:7004 192.168.1.100:7005 \
  --cluster-replicas 1

# 4. éªŒè¯é›†ç¾¤çŠ¶æ€
redis-cli -c -p 7000 cluster nodes
redis-cli -c -p 7000 cluster info
```

</TabItem>
<TabItem value="slots" label="æ§½ä½åˆ†é…">

```bash title="Redisé›†ç¾¤æ§½ä½æœºåˆ¶"
# Redisé›†ç¾¤æ§½ä½æ¦‚å¿µ
# - é›†ç¾¤å…±æœ‰16384ä¸ªæ§½ä½ï¼ˆ0-16383ï¼‰
# - æ¯ä¸ªä¸»èŠ‚ç‚¹è´Ÿè´£ä¸€éƒ¨åˆ†æ§½ä½
# - é€šè¿‡CRC16ç®—æ³•è®¡ç®—keyæ‰€å±æ§½ä½ï¼šHASH_SLOT = CRC16(key) mod 16384

# æ§½ä½åˆ†é…ç¤ºä¾‹
# èŠ‚ç‚¹1ï¼š0-5460     (5461ä¸ªæ§½ä½)
# èŠ‚ç‚¹2ï¼š5461-10922 (5462ä¸ªæ§½ä½)  
# èŠ‚ç‚¹3ï¼š10923-16383(5461ä¸ªæ§½ä½)

# æŸ¥çœ‹æ§½ä½åˆ†é…
redis-cli -p 7000 cluster slots
# 0-5460 192.168.1.100:7000 192.168.1.100:7003
# 5461-10922 192.168.1.100:7001 192.168.1.100:7004
# 10923-16383 192.168.1.100:7002 192.168.1.100:7005

# è®¡ç®—keyçš„æ§½ä½
redis-cli -p 7000 cluster keyslot "user:1001"
# (integer) 9189

# æŸ¥çœ‹æ§½ä½ä¸­çš„keyæ•°é‡
redis-cli -p 7000 cluster countkeysinslot 9189
# (integer) 1

# è·å–æ§½ä½ä¸­çš„key
redis-cli -p 7000 cluster getkeysinslot 9189 10
# 1) "user:1001"

# Hash Tagæœºåˆ¶ - ç¡®ä¿ç›¸å…³keyåœ¨åŒä¸€æ§½ä½
SET user:{1001}:profile "John Doe"
SET user:{1001}:settings "theme:dark"
SET user:{1001}:preferences "lang:en"
# è¿™äº›keyéƒ½ä¼šè¢«åˆ†é…åˆ°åŒä¸€ä¸ªæ§½ä½ï¼Œå› ä¸ºéƒ½åŒ…å«{1001}

# æ§½ä½è¿ç§»ï¼ˆåœ¨çº¿æ‰©å®¹/ç¼©å®¹æ—¶ä½¿ç”¨ï¼‰
redis-cli --cluster reshard 192.168.1.100:7000
# äº¤äº’å¼è¿ç§»æ§½ä½åˆ°æ–°èŠ‚ç‚¹
```

</TabItem>
<TabItem value="operations" label="é›†ç¾¤æ“ä½œ">

```bash title="Redisé›†ç¾¤å¸¸ç”¨æ“ä½œ"
# é›†ç¾¤ä¿¡æ¯æŸ¥çœ‹
redis-cli -c -p 7000 cluster info
# cluster_state:ok
# cluster_slots_assigned:16384
# cluster_slots_ok:16384
# cluster_slots_pfail:0
# cluster_slots_fail:0
# cluster_known_nodes:6
# cluster_size:3

redis-cli -c -p 7000 cluster nodes
# æ˜¾ç¤ºæ‰€æœ‰èŠ‚ç‚¹ä¿¡æ¯ï¼ŒåŒ…æ‹¬IDã€è§’è‰²ã€çŠ¶æ€ã€æ§½ä½ç­‰

# æ•°æ®æ“ä½œï¼ˆå®¢æˆ·ç«¯é‡å®šå‘ï¼‰
redis-cli -c -p 7000
127.0.0.1:7000> SET user:1001 "John"
-> Redirected to slot [9189] located at 192.168.1.100:7001
OK
192.168.1.100:7001> GET user:1001
"John"

# æ‰¹é‡æ“ä½œé™åˆ¶
# ä¸æ”¯æŒè·¨æ§½ä½çš„å¤škeyæ“ä½œ
MSET user:1001 "John" user:1002 "Jane"  # å¯èƒ½å¤±è´¥
# (error) CROSSSLOT Keys in request don't hash to the same slot

# ä½¿ç”¨Hash Tagè§£å†³
MSET user:{group1}:1001 "John" user:{group1}:1002 "Jane"  # æˆåŠŸ

# èŠ‚ç‚¹ç®¡ç†
redis-cli --cluster add-node 192.168.1.100:7006 192.168.1.100:7000
# æ·»åŠ æ–°èŠ‚ç‚¹åˆ°é›†ç¾¤

redis-cli --cluster del-node 192.168.1.100:7000 <node-id>
# ä»é›†ç¾¤ä¸­åˆ é™¤èŠ‚ç‚¹

redis-cli --cluster rebalance 192.168.1.100:7000
# é‡æ–°å¹³è¡¡æ§½ä½åˆ†é…

# æ•…éšœè½¬ç§»
redis-cli -p 7003 cluster failover
# æ‰‹åŠ¨è§¦å‘æ•…éšœè½¬ç§»ï¼Œå°†ä»èŠ‚ç‚¹æå‡ä¸ºä¸»èŠ‚ç‚¹

redis-cli -p 7003 cluster failover force
# å¼ºåˆ¶æ•…éšœè½¬ç§»ï¼ˆå³ä½¿ä¸»èŠ‚ç‚¹æ­£å¸¸ï¼‰
```

</TabItem>
<TabItem value="client-code" label="å®¢æˆ·ç«¯ä»£ç ">

```java title="Javaé›†ç¾¤å®¢æˆ·ç«¯"
@Configuration
public class RedisClusterConfig {
    
    @Bean
    public LettuceConnectionFactory redisConnectionFactory() {
        // é›†ç¾¤èŠ‚ç‚¹é…ç½®
        List<RedisNode> nodes = Arrays.asList(
            new RedisNode("192.168.1.100", 7000),
            new RedisNode("192.168.1.100", 7001),
            new RedisNode("192.168.1.100", 7002),
            new RedisNode("192.168.1.100", 7003),
            new RedisNode("192.168.1.100", 7004),
            new RedisNode("192.168.1.100", 7005)
        );
        
        RedisClusterConfiguration clusterConfig = 
            new RedisClusterConfiguration();
        clusterConfig.setClusterNodes(nodes);
        clusterConfig.setMaxRedirects(3);  // æœ€å¤§é‡å®šå‘æ¬¡æ•°
        
        // è¿æ¥æ± é…ç½®
        GenericObjectPoolConfig poolConfig = new GenericObjectPoolConfig();
        poolConfig.setMaxTotal(100);
        poolConfig.setMaxIdle(20);
        poolConfig.setMinIdle(10);
        poolConfig.setMaxWaitMillis(3000);
        
        LettucePoolingClientConfiguration clientConfig = 
            LettucePoolingClientConfiguration.builder()
                .poolConfig(poolConfig)
                .build();
        
        return new LettuceConnectionFactory(clusterConfig, clientConfig);
    }
    
    @Bean
    public RedisTemplate<String, Object> redisTemplate(
            LettuceConnectionFactory connectionFactory) {
        RedisTemplate<String, Object> template = new RedisTemplate<>();
        template.setConnectionFactory(connectionFactory);
        
        // åºåˆ—åŒ–é…ç½®
        template.setKeySerializer(new StringRedisSerializer());
        template.setValueSerializer(new GenericJackson2JsonRedisSerializer());
        template.setHashKeySerializer(new StringRedisSerializer());
        template.setHashValueSerializer(new GenericJackson2JsonRedisSerializer());
        
        return template;
    }
}

// é›†ç¾¤æ“ä½œæœåŠ¡
@Service
public class RedisClusterService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    /**
     * æ‰¹é‡æ“ä½œ - ä½¿ç”¨Hash Tagç¡®ä¿keyåœ¨åŒä¸€æ§½ä½
     */
    public void batchOperationWithHashTag(String groupId, Map<String, Object> data) {
        Map<String, Object> hashTaggedData = new HashMap<>();
        
        for (Map.Entry<String, Object> entry : data.entrySet()) {
            String key = String.format("data:{%s}:%s", groupId, entry.getKey());
            hashTaggedData.put(key, entry.getValue());
        }
        
        redisTemplate.opsForValue().multiSet(hashTaggedData);
    }
    
    /**
     * åˆ†å¸ƒå¼è®¡æ•°å™¨ - åˆ©ç”¨é›†ç¾¤çš„åˆ†ç‰‡ç‰¹æ€§
     */
    public Long distributedIncrement(String counterName, String shardKey) {
        String key = String.format("counter:%s:{%s}", counterName, shardKey);
        return redisTemplate.opsForValue().increment(key);
    }
    
    /**
     * é›†ç¾¤çŠ¶æ€ç›‘æ§
     */
    public Map<String, Object> getClusterInfo() {
        return redisTemplate.execute((RedisCallback<Map<String, Object>>) connection -> {
            if (connection instanceof JedisClusterConnection) {
                JedisClusterConnection clusterConnection = (JedisClusterConnection) connection;
                // è·å–é›†ç¾¤ä¿¡æ¯çš„å…·ä½“å®ç°
                Map<String, Object> info = new HashMap<>();
                info.put("cluster_state", "ok");
                info.put("cluster_size", 3);
                return info;
            }
            return Collections.emptyMap();
        });
    }
}
```

</TabItem>
</Tabs>

### 4.4 é«˜å¯ç”¨æ–¹æ¡ˆå¯¹æ¯”ä¸é€‰æ‹©

| æ–¹æ¡ˆ | æ•°æ®ä¸€è‡´æ€§ | å¯ç”¨æ€§ | æ‰©å±•æ€§ | å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ |
|------|-----------|--------|--------|--------|---------|
| **ä¸»ä»å¤åˆ¶** | æœ€ç»ˆä¸€è‡´ | ä¸­ç­‰ | è¯»æ‰©å±• | ä½ | è¯»å¤šå†™å°‘ï¼Œç®€å•æ¶æ„ |
| **å“¨å…µæ¨¡å¼** | æœ€ç»ˆä¸€è‡´ | é«˜ | è¯»æ‰©å±• | ä¸­ç­‰ | é«˜å¯ç”¨è¦æ±‚ï¼Œè‡ªåŠ¨æ•…éšœè½¬ç§» |
| **é›†ç¾¤æ¨¡å¼** | æœ€ç»ˆä¸€è‡´ | é«˜ | è¯»å†™æ‰©å±• | é«˜ | å¤§æ•°æ®é‡ï¼Œé«˜å¹¶å‘ï¼Œæ°´å¹³æ‰©å±• |

```mermaid
graph TD
    A[é€‰æ‹©Redisé«˜å¯ç”¨æ–¹æ¡ˆ] --> B{æ•°æ®é‡å¤§å°}
    B -->|å°äº100GB| C{å¯ç”¨æ€§è¦æ±‚}
    B -->|å¤§äº100GB| D[é›†ç¾¤æ¨¡å¼]
    
    C -->|ä¸€èˆ¬| E[ä¸»ä»å¤åˆ¶]
    C -->|é«˜| F[å“¨å…µæ¨¡å¼]
    
    D --> G[3ä¸»3ä»èµ·æ­¥]
    E --> H[1ä¸»2ä»é…ç½®]
    F --> I[1ä¸»2ä»+3å“¨å…µ]
    
    G --> J[æ”¯æŒæ°´å¹³æ‰©å±•]
    H --> K[ç®€å•æ˜“ç»´æŠ¤]
    I --> L[è‡ªåŠ¨æ•…éšœè½¬ç§»]
```

## 5. Redisæ€§èƒ½ä¼˜åŒ–å®æˆ˜

Redisæ€§èƒ½ä¼˜åŒ–æ˜¯ä¸€ä¸ªç³»ç»Ÿå·¥ç¨‹ï¼Œæ¶‰åŠå†…å­˜ã€ç½‘ç»œã€æŒä¹…åŒ–ã€æ•°æ®ç»“æ„ç­‰å¤šä¸ªæ–¹é¢ã€‚

### 5.1 å†…å­˜ä¼˜åŒ–ç­–ç•¥

å†…å­˜æ˜¯Redisæœ€å®è´µçš„èµ„æºï¼Œåˆç†çš„å†…å­˜ä½¿ç”¨ç­–ç•¥ç›´æ¥å½±å“ç³»ç»Ÿæ€§èƒ½ã€‚

<Tabs>
<TabItem value="memory-config" label="å†…å­˜é…ç½®">

```bash title="Rediså†…å­˜é…ç½®ä¼˜åŒ–"
# åŸºç¡€å†…å­˜é…ç½®
maxmemory 8gb                           # è®¾ç½®æœ€å¤§å†…å­˜é™åˆ¶
maxmemory-policy allkeys-lru            # å†…å­˜æ·˜æ±°ç­–ç•¥

# å†…å­˜æ·˜æ±°ç­–ç•¥è¯¦è§£
# noevictionï¼šä¸æ·˜æ±°ï¼Œå†…å­˜æ»¡æ—¶å†™å…¥æŠ¥é”™ï¼ˆé»˜è®¤ï¼‰
# allkeys-lruï¼šä»æ‰€æœ‰keyä¸­ä½¿ç”¨LRUç®—æ³•æ·˜æ±°
# volatile-lruï¼šä»è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„keyä¸­ä½¿ç”¨LRUç®—æ³•æ·˜æ±°
# allkeys-randomï¼šä»æ‰€æœ‰keyä¸­éšæœºæ·˜æ±°
# volatile-randomï¼šä»è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„keyä¸­éšæœºæ·˜æ±°
# volatile-ttlï¼šæ·˜æ±°å³å°†è¿‡æœŸçš„key
# allkeys-lfuï¼šä»æ‰€æœ‰keyä¸­ä½¿ç”¨LFUç®—æ³•æ·˜æ±°ï¼ˆRedis 4.0+ï¼‰
# volatile-lfuï¼šä»è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„keyä¸­ä½¿ç”¨LFUç®—æ³•æ·˜æ±°ï¼ˆRedis 4.0+ï¼‰

# LRUé…ç½®ä¼˜åŒ–
maxmemory-samples 5                     # LRUé‡‡æ ·æ•°é‡ï¼Œè¶Šå¤§è¶Šç²¾ç¡®ä½†æ€§èƒ½è¶Šä½

# å†…å­˜ä½¿ç”¨ç›‘æ§
redis-cli INFO memory
# used_memory:8589934592                # å·²ä½¿ç”¨å†…å­˜ï¼ˆå­—èŠ‚ï¼‰
# used_memory_human:8.00G               # å·²ä½¿ç”¨å†…å­˜ï¼ˆäººç±»å¯è¯»ï¼‰
# used_memory_rss:9663676416            # ç³»ç»Ÿåˆ†é…å†…å­˜
# used_memory_peak:8589934592           # å†…å­˜ä½¿ç”¨å³°å€¼
# used_memory_peak_human:8.00G          # å†…å­˜ä½¿ç”¨å³°å€¼ï¼ˆäººç±»å¯è¯»ï¼‰
# maxmemory:8589934592                  # æœ€å¤§å†…å­˜é™åˆ¶
# maxmemory_human:8.00G                 # æœ€å¤§å†…å­˜é™åˆ¶ï¼ˆäººç±»å¯è¯»ï¼‰
# maxmemory_policy:allkeys-lru          # å†…å­˜æ·˜æ±°ç­–ç•¥
```

</TabItem>
<TabItem value="data-structure" label="æ•°æ®ç»“æ„ä¼˜åŒ–">

```bash title="æ•°æ®ç»“æ„å†…å­˜ä¼˜åŒ–"
# 1. String vs Hash å¯¹æ¯”
# ä¸æ¨èï¼šä½¿ç”¨Stringå­˜å‚¨ç”¨æˆ·ä¿¡æ¯
SET user:1001:name "John"               # å ç”¨å†…å­˜ï¼š~50å­—èŠ‚
SET user:1001:age "25"                  # å ç”¨å†…å­˜ï¼š~45å­—èŠ‚  
SET user:1001:email "john@example.com"  # å ç”¨å†…å­˜ï¼š~65å­—èŠ‚
# æ€»è®¡ï¼š~160å­—èŠ‚

# æ¨èï¼šä½¿ç”¨Hashå­˜å‚¨ç”¨æˆ·ä¿¡æ¯
HMSET user:1001 name "John" age "25" email "john@example.com"
# æ€»è®¡ï¼š~80å­—èŠ‚ï¼ŒèŠ‚çœ50%å†…å­˜

# 2. å°å¯¹è±¡å‹ç¼©é…ç½®
# Hashå‹ç¼©é…ç½®
hash-max-ziplist-entries 512           # å­—æ®µæ•°é‡å°äº512æ—¶ä½¿ç”¨ziplist
hash-max-ziplist-value 64              # å­—æ®µå€¼å°äº64å­—èŠ‚æ—¶ä½¿ç”¨ziplist

# Listå‹ç¼©é…ç½®  
list-max-ziplist-size -2               # æ¯ä¸ªèŠ‚ç‚¹æœ€å¤§8KB
list-compress-depth 0                  # ä¸å‹ç¼©å¤´å°¾èŠ‚ç‚¹

# Setå‹ç¼©é…ç½®
set-max-intset-entries 512             # æ•´æ•°é›†åˆæœ€å¤§512ä¸ªå…ƒç´ 

# Sorted Setå‹ç¼©é…ç½®
zset-max-ziplist-entries 128           # å…ƒç´ æ•°é‡å°äº128æ—¶ä½¿ç”¨ziplist
zset-max-ziplist-value 64              # å…ƒç´ å€¼å°äº64å­—èŠ‚æ—¶ä½¿ç”¨ziplist

# 3. å†…å­˜ç¢ç‰‡ä¼˜åŒ–
# å¯ç”¨å†…å­˜ç¢ç‰‡æ•´ç†ï¼ˆRedis 4.0+ï¼‰
activedefrag yes                        # å¯ç”¨ä¸»åŠ¨ç¢ç‰‡æ•´ç†
active-defrag-ignore-bytes 100mb       # ç¢ç‰‡å°äº100MBæ—¶ä¸æ•´ç†
active-defrag-threshold-lower 10       # ç¢ç‰‡ç‡ä½äº10%æ—¶ä¸æ•´ç†
active-defrag-threshold-upper 100      # ç¢ç‰‡ç‡é«˜äº100%æ—¶ç§¯ææ•´ç†
active-defrag-cycle-min 5              # æœ€å°CPUä½¿ç”¨ç‡5%
active-defrag-cycle-max 75             # æœ€å¤§CPUä½¿ç”¨ç‡75%
```

</TabItem>
<TabItem value="key-design" label="é”®è®¾è®¡ä¼˜åŒ–">

```bash title="Redisé”®è®¾è®¡æœ€ä½³å®è·µ"
# 1. é”®å‘½åè§„èŒƒ
# æ¨èæ ¼å¼ï¼šä¸šåŠ¡:å¯¹è±¡:ID:å±æ€§
user:profile:1001:basic                 # ç”¨æˆ·åŸºç¡€ä¿¡æ¯
user:profile:1001:settings              # ç”¨æˆ·è®¾ç½®ä¿¡æ¯
order:detail:2001:items                 # è®¢å•å•†å“ä¿¡æ¯
cache:product:3001:info                 # å•†å“ç¼“å­˜ä¿¡æ¯

# 2. é¿å…è¿‡é•¿çš„é”®å
# ä¸æ¨è
SET "this_is_a_very_long_key_name_that_wastes_memory_and_affects_performance" "value"

# æ¨è  
SET "user:1001:profile" "value"

# 3. ä½¿ç”¨åˆé€‚çš„è¿‡æœŸæ—¶é—´
SET cache:user:1001 "data" EX 3600      # 1å°æ—¶è¿‡æœŸ
SET session:abc123 "data" EX 1800       # 30åˆ†é’Ÿè¿‡æœŸ
SET temp:data:xyz "data" EX 300         # 5åˆ†é’Ÿè¿‡æœŸ

# 4. æ‰¹é‡æ“ä½œä¼˜åŒ–
# ä¸æ¨èï¼šå¤šæ¬¡å•ç‹¬æ“ä½œ
SET user:1001:name "John"
SET user:1001:age "25"  
SET user:1001:email "john@example.com"

# æ¨èï¼šæ‰¹é‡æ“ä½œ
MSET user:1001:name "John" user:1001:age "25" user:1001:email "john@example.com"

# æˆ–è€…ä½¿ç”¨Hash
HMSET user:1001 name "John" age "25" email "john@example.com"

# 5. å¤§keyæ‹†åˆ†
# ä¸æ¨èï¼šå•ä¸ªå¤§Hash
HMSET big_hash field1 value1 field2 value2 ... field10000 value10000

# æ¨èï¼šæ‹†åˆ†ä¸ºå¤šä¸ªå°Hash
HMSET hash:1 field1 value1 field2 value2 ... field100 value100
HMSET hash:2 field101 value101 field102 value102 ... field200 value200
```

</TabItem>
<TabItem value="monitoring" label="å†…å­˜ç›‘æ§">

```java title="Javaå†…å­˜ç›‘æ§å®ç°"
@Component
public class RedisMemoryMonitor {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    private static final Logger logger = LoggerFactory.getLogger(RedisMemoryMonitor.class);
    
    /**
     * è·å–å†…å­˜ä½¿ç”¨ä¿¡æ¯
     */
    public Map<String, Object> getMemoryInfo() {
        return redisTemplate.execute((RedisCallback<Map<String, Object>>) connection -> {
            Properties info = connection.info("memory");
            Map<String, Object> memoryInfo = new HashMap<>();
            
            memoryInfo.put("used_memory", info.getProperty("used_memory"));
            memoryInfo.put("used_memory_human", info.getProperty("used_memory_human"));
            memoryInfo.put("used_memory_rss", info.getProperty("used_memory_rss"));
            memoryInfo.put("used_memory_peak", info.getProperty("used_memory_peak"));
            memoryInfo.put("maxmemory", info.getProperty("maxmemory"));
            memoryInfo.put("maxmemory_policy", info.getProperty("maxmemory_policy"));
            
            return memoryInfo;
        });
    }
    
    /**
     * è®¡ç®—å†…å­˜ä½¿ç”¨ç‡
     */
    public double getMemoryUsageRatio() {
        Map<String, Object> memoryInfo = getMemoryInfo();
        long usedMemory = Long.parseLong((String) memoryInfo.get("used_memory"));
        long maxMemory = Long.parseLong((String) memoryInfo.get("maxmemory"));
        
        if (maxMemory == 0) {
            return 0.0;
        }
        
        return (double) usedMemory / maxMemory * 100;
    }
    
    /**
     * å†…å­˜å‘Šè­¦æ£€æŸ¥
     */
    @Scheduled(fixedRate = 60000) // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    public void checkMemoryUsage() {
        double usageRatio = getMemoryUsageRatio();
        
        if (usageRatio > 80) {
            logger.warn("Rediså†…å­˜ä½¿ç”¨ç‡è¿‡é«˜: {}%", String.format("%.2f", usageRatio));
            // å‘é€å‘Šè­¦é€šçŸ¥
            sendAlert("Rediså†…å­˜ä½¿ç”¨ç‡å‘Šè­¦", "å½“å‰ä½¿ç”¨ç‡: " + String.format("%.2f", usageRatio) + "%");
        }
    }
    
    /**
     * åˆ†æå¤§key
     */
    public List<String> findBigKeys() {
        return redisTemplate.execute((RedisCallback<List<String>>) connection -> {
            List<String> bigKeys = new ArrayList<>();
            
            // ä½¿ç”¨SCANå‘½ä»¤éå†æ‰€æœ‰key
            ScanOptions options = ScanOptions.scanOptions().count(100).build();
            Cursor<byte[]> cursor = connection.scan(options);
            
            while (cursor.hasNext()) {
                byte[] keyBytes = cursor.next();
                String key = new String(keyBytes);
                
                // æ£€æŸ¥keyçš„å†…å­˜ä½¿ç”¨
                Long memoryUsage = connection.memoryUsage(keyBytes);
                if (memoryUsage != null && memoryUsage > 1024 * 1024) { // å¤§äº1MB
                    bigKeys.add(key + " (" + formatBytes(memoryUsage) + ")");
                }
            }
            
            return bigKeys;
        });
    }
    
    private String formatBytes(long bytes) {
        if (bytes < 1024) return bytes + " B";
        if (bytes < 1024 * 1024) return String.format("%.2f KB", bytes / 1024.0);
        if (bytes < 1024 * 1024 * 1024) return String.format("%.2f MB", bytes / (1024.0 * 1024));
        return String.format("%.2f GB", bytes / (1024.0 * 1024 * 1024));
    }
    
    private void sendAlert(String title, String message) {
        // å®ç°å‘Šè­¦é€šçŸ¥é€»è¾‘ï¼ˆé‚®ä»¶ã€çŸ­ä¿¡ã€é’‰é’‰ç­‰ï¼‰
        logger.error("å‘Šè­¦: {} - {}", title, message);
    }
}
```

</TabItem>
</Tabs>

### 5.2 ç½‘ç»œä¸è¿æ¥ä¼˜åŒ–

ç½‘ç»œå’Œè¿æ¥é…ç½®ç›´æ¥å½±å“Redisçš„å“åº”æ—¶é—´å’Œå¹¶å‘å¤„ç†èƒ½åŠ›ã€‚

<Tabs>
<TabItem value="network-config" label="ç½‘ç»œé…ç½®">

```bash title="Redisç½‘ç»œé…ç½®ä¼˜åŒ–"
# åŸºç¡€ç½‘ç»œé…ç½®
bind 0.0.0.0                           # ç»‘å®šæ‰€æœ‰ç½‘ç»œæ¥å£
port 6379                              # ç›‘å¬ç«¯å£
tcp-backlog 511                        # TCPç›‘å¬é˜Ÿåˆ—é•¿åº¦
timeout 0                              # å®¢æˆ·ç«¯ç©ºé—²è¶…æ—¶æ—¶é—´ï¼ˆ0è¡¨ç¤ºä¸è¶…æ—¶ï¼‰

# TCPé…ç½®ä¼˜åŒ–
tcp-keepalive 300                      # TCP keepaliveæ—¶é—´ï¼ˆç§’ï¼‰
# å»ºè®®è®¾ç½®ä¸º300ç§’ï¼Œå¯ä»¥åŠæ—¶å‘ç°æ–­å¼€çš„è¿æ¥

# å®¢æˆ·ç«¯è¿æ¥é…ç½®
maxclients 10000                       # æœ€å¤§å®¢æˆ·ç«¯è¿æ¥æ•°
# é»˜è®¤10000ï¼Œæ ¹æ®æœåŠ¡å™¨æ€§èƒ½å’Œå†…å­˜è°ƒæ•´

# è¾“å‡ºç¼“å†²åŒºé…ç½®
client-output-buffer-limit normal 0 0 0                    # æ™®é€šå®¢æˆ·ç«¯æ— é™åˆ¶
client-output-buffer-limit replica 256mb 64mb 60           # ä»èŠ‚ç‚¹å®¢æˆ·ç«¯
client-output-buffer-limit pubsub 32mb 8mb 60              # å‘å¸ƒè®¢é˜…å®¢æˆ·ç«¯

# ç½‘ç»œæ€§èƒ½ç›‘æ§
redis-cli INFO clients
# connected_clients:100              # å½“å‰è¿æ¥çš„å®¢æˆ·ç«¯æ•°é‡
# client_recent_max_input_buffer:2   # æœ€è¿‘å®¢æˆ·ç«¯æœ€å¤§è¾“å…¥ç¼“å†²åŒº
# client_recent_max_output_buffer:0  # æœ€è¿‘å®¢æˆ·ç«¯æœ€å¤§è¾“å‡ºç¼“å†²åŒº
# blocked_clients:0                  # è¢«é˜»å¡çš„å®¢æˆ·ç«¯æ•°é‡

redis-cli INFO stats
# total_connections_received:1000    # æ€»è¿æ¥æ•°
# total_commands_processed:50000     # æ€»å‘½ä»¤æ•°
# instantaneous_ops_per_sec:100      # å½“å‰æ¯ç§’æ“ä½œæ•°
# instantaneous_input_kbps:10.5      # å½“å‰è¾“å…¥é€Ÿç‡(KB/s)
# instantaneous_output_kbps:15.2     # å½“å‰è¾“å‡ºé€Ÿç‡(KB/s)
```

</TabItem>
<TabItem value="connection-pool" label="è¿æ¥æ± ä¼˜åŒ–">

```java title="Javaè¿æ¥æ± é…ç½®ä¼˜åŒ–"
@Configuration
public class RedisConnectionPoolConfig {
    
    @Bean
    public LettuceConnectionFactory redisConnectionFactory() {
        // å•æœºé…ç½®
        RedisStandaloneConfiguration config = new RedisStandaloneConfiguration();
        config.setHostName("192.168.1.100");
        config.setPort(6379);
        config.setPassword("your_password");
        config.setDatabase(0);
        
        // è¿æ¥æ± é…ç½®
        GenericObjectPoolConfig<Object> poolConfig = new GenericObjectPoolConfig<>();
        
        // è¿æ¥æ± å¤§å°é…ç½®
        poolConfig.setMaxTotal(200);                    // æœ€å¤§è¿æ¥æ•°
        poolConfig.setMaxIdle(50);                      // æœ€å¤§ç©ºé—²è¿æ¥æ•°
        poolConfig.setMinIdle(10);                      // æœ€å°ç©ºé—²è¿æ¥æ•°
        
        // è¿æ¥è·å–é…ç½®
        poolConfig.setMaxWaitMillis(3000);              // æœ€å¤§ç­‰å¾…æ—¶é—´(ms)
        poolConfig.setBlockWhenExhausted(true);         // è¿æ¥è€—å°½æ—¶æ˜¯å¦é˜»å¡
        
        // è¿æ¥éªŒè¯é…ç½®
        poolConfig.setTestOnBorrow(true);               // è·å–è¿æ¥æ—¶éªŒè¯
        poolConfig.setTestOnReturn(false);              // å½’è¿˜è¿æ¥æ—¶éªŒè¯
        poolConfig.setTestWhileIdle(true);              // ç©ºé—²æ—¶éªŒè¯è¿æ¥
        poolConfig.setTimeBetweenEvictionRunsMillis(30000); // ç©ºé—²æ£€æµ‹é—´éš”(ms)
        poolConfig.setMinEvictableIdleTimeMillis(60000);    // æœ€å°ç©ºé—²æ—¶é—´(ms)
        poolConfig.setNumTestsPerEvictionRun(3);            // æ¯æ¬¡æ£€æµ‹è¿æ¥æ•°
        
        // Lettuceå®¢æˆ·ç«¯é…ç½®
        LettucePoolingClientConfiguration clientConfig = 
            LettucePoolingClientConfiguration.builder()
                .poolConfig(poolConfig)
                .commandTimeout(Duration.ofSeconds(5))      // å‘½ä»¤è¶…æ—¶æ—¶é—´
                .shutdownTimeout(Duration.ofSeconds(10))    // å…³é—­è¶…æ—¶æ—¶é—´
                .build();
        
        return new LettuceConnectionFactory(config, clientConfig);
    }
    
    @Bean
    public RedisTemplate<String, Object> redisTemplate(
            LettuceConnectionFactory connectionFactory) {
        RedisTemplate<String, Object> template = new RedisTemplate<>();
        template.setConnectionFactory(connectionFactory);
        
        // åºåˆ—åŒ–é…ç½®
        Jackson2JsonRedisSerializer<Object> serializer = 
            new Jackson2JsonRedisSerializer<>(Object.class);
        ObjectMapper objectMapper = new ObjectMapper();
        objectMapper.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);
        objectMapper.activateDefaultTyping(LaissezFaireSubTypeValidator.instance, 
            ObjectMapper.DefaultTyping.NON_FINAL);
        serializer.setObjectMapper(objectMapper);
        
        template.setKeySerializer(new StringRedisSerializer());
        template.setValueSerializer(serializer);
        template.setHashKeySerializer(new StringRedisSerializer());
        template.setHashValueSerializer(serializer);
        
        template.afterPropertiesSet();
        return template;
    }
}

// è¿æ¥æ± ç›‘æ§
@Component
public class RedisConnectionPoolMonitor {
    
    @Autowired
    private LettuceConnectionFactory connectionFactory;
    
    private static final Logger logger = LoggerFactory.getLogger(RedisConnectionPoolMonitor.class);
    
    @Scheduled(fixedRate = 60000) // æ¯åˆ†é’Ÿç›‘æ§ä¸€æ¬¡
    public void monitorConnectionPool() {
        try {
            // è·å–è¿æ¥æ± ç»Ÿè®¡ä¿¡æ¯
            GenericObjectPool<Object> pool = 
                (GenericObjectPool<Object>) connectionFactory.getClientConfiguration();
            
            if (pool != null) {
                int activeConnections = pool.getNumActive();
                int idleConnections = pool.getNumIdle();
                int totalConnections = activeConnections + idleConnections;
                
                logger.info("Redisè¿æ¥æ± çŠ¶æ€ - æ´»è·ƒè¿æ¥: {}, ç©ºé—²è¿æ¥: {}, æ€»è¿æ¥: {}", 
                    activeConnections, idleConnections, totalConnections);
                
                // è¿æ¥æ± ä½¿ç”¨ç‡å‘Šè­¦
                double usageRatio = (double) activeConnections / pool.getMaxTotal() * 100;
                if (usageRatio > 80) {
                    logger.warn("Redisè¿æ¥æ± ä½¿ç”¨ç‡è¿‡é«˜: {}%", String.format("%.2f", usageRatio));
                }
            }
        } catch (Exception e) {
            logger.error("ç›‘æ§Redisè¿æ¥æ± å¤±è´¥", e);
        }
    }
}
```

</TabItem>
<TabItem value="pipeline" label="Pipelineä¼˜åŒ–">

```java title="Pipelineæ‰¹é‡æ“ä½œä¼˜åŒ–"
@Service
public class RedisPipelineService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    /**
     * ä½¿ç”¨Pipelineæ‰¹é‡è®¾ç½®æ•°æ®
     */
    public void batchSetWithPipeline(Map<String, Object> data) {
        redisTemplate.executePipelined((RedisCallback<Object>) connection -> {
            for (Map.Entry<String, Object> entry : data.entrySet()) {
                connection.set(
                    entry.getKey().getBytes(), 
                    serialize(entry.getValue())
                );
            }
            return null;
        });
    }
    
    /**
     * ä½¿ç”¨Pipelineæ‰¹é‡è·å–æ•°æ®
     */
    public List<Object> batchGetWithPipeline(List<String> keys) {
        return redisTemplate.executePipelined((RedisCallback<Object>) connection -> {
            for (String key : keys) {
                connection.get(key.getBytes());
            }
            return null;
        });
    }
    
    /**
     * æ€§èƒ½å¯¹æ¯”æµ‹è¯•
     */
    public void performanceComparison() {
        Map<String, Object> testData = new HashMap<>();
        for (int i = 0; i < 1000; i++) {
            testData.put("test:key:" + i, "value" + i);
        }
        
        // æ™®é€šæ–¹å¼
        long start1 = System.currentTimeMillis();
        for (Map.Entry<String, Object> entry : testData.entrySet()) {
            redisTemplate.opsForValue().set(entry.getKey(), entry.getValue());
        }
        long time1 = System.currentTimeMillis() - start1;
        
        // Pipelineæ–¹å¼
        long start2 = System.currentTimeMillis();
        batchSetWithPipeline(testData);
        long time2 = System.currentTimeMillis() - start2;
        
        System.out.println("æ™®é€šæ–¹å¼è€—æ—¶: " + time1 + "ms");
        System.out.println("Pipelineæ–¹å¼è€—æ—¶: " + time2 + "ms");
        System.out.println("æ€§èƒ½æå‡: " + (time1 / (double) time2) + "å€");
    }
    
    /**
     * æ™ºèƒ½æ‰¹é‡æ“ä½œ - è‡ªåŠ¨åˆ†æ‰¹å¤„ç†
     */
    public void smartBatchOperation(Map<String, Object> data, int batchSize) {
        List<Map.Entry<String, Object>> entries = new ArrayList<>(data.entrySet());
        
        for (int i = 0; i < entries.size(); i += batchSize) {
            int endIndex = Math.min(i + batchSize, entries.size());
            List<Map.Entry<String, Object>> batch = entries.subList(i, endIndex);
            
            redisTemplate.executePipelined((RedisCallback<Object>) connection -> {
                for (Map.Entry<String, Object> entry : batch) {
                    connection.set(
                        entry.getKey().getBytes(), 
                        serialize(entry.getValue())
                    );
                }
                return null;
            });
        }
    }
    
    private byte[] serialize(Object obj) {
        // å®ç°åºåˆ—åŒ–é€»è¾‘
        return obj.toString().getBytes();
    }
}

// Luaè„šæœ¬ä¼˜åŒ–
@Service
public class RedisLuaScriptService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    // åŸå­æ€§å¢åŠ åº“å­˜çš„Luaè„šæœ¬
    private static final String STOCK_SCRIPT = 
        "local key = KEYS[1] " +
        "local delta = tonumber(ARGV[1]) " +
        "local current = redis.call('GET', key) " +
        "if current == false then " +
        "    current = 0 " +
        "else " +
        "    current = tonumber(current) " +
        "end " +
        "local newValue = current + delta " +
        "if newValue >= 0 then " +
        "    redis.call('SET', key, newValue) " +
        "    return newValue " +
        "else " +
        "    return -1 " +
        "end";
    
    /**
     * åŸå­æ€§åº“å­˜æ“ä½œ
     */
    public Long atomicStockOperation(String productId, int delta) {
        DefaultRedisScript<Long> script = new DefaultRedisScript<>();
        script.setScriptText(STOCK_SCRIPT);
        script.setResultType(Long.class);
        
        return redisTemplate.execute(script, 
            Collections.singletonList("stock:" + productId), 
            String.valueOf(delta));
    }
    
    // åˆ†å¸ƒå¼é™æµLuaè„šæœ¬
    private static final String RATE_LIMIT_SCRIPT =
        "local key = KEYS[1] " +
        "local window = tonumber(ARGV[1]) " +
        "local limit = tonumber(ARGV[2]) " +
        "local current = redis.call('INCR', key) " +
        "if current == 1 then " +
        "    redis.call('EXPIRE', key, window) " +
        "end " +
        "if current <= limit then " +
        "    return 1 " +
        "else " +
        "    return 0 " +
        "end";
    
    /**
     * åˆ†å¸ƒå¼é™æµ
     */
    public boolean rateLimitCheck(String key, int windowSeconds, int limit) {
        DefaultRedisScript<Long> script = new DefaultRedisScript<>();
        script.setScriptText(RATE_LIMIT_SCRIPT);
        script.setResultType(Long.class);
        
        Long result = redisTemplate.execute(script, 
            Collections.singletonList(key), 
            String.valueOf(windowSeconds), 
            String.valueOf(limit));
        
        return Long.valueOf(1).equals(result);
    }
}
```

</TabItem>
</Tabs>

### 5.3 æŒä¹…åŒ–æ€§èƒ½ä¼˜åŒ–

æŒä¹…åŒ–é…ç½®ç›´æ¥å½±å“Redisçš„å†™å…¥æ€§èƒ½å’Œæ•°æ®å®‰å…¨æ€§ï¼Œéœ€è¦æ ¹æ®ä¸šåŠ¡éœ€æ±‚è¿›è¡Œå¹³è¡¡ã€‚

<Tabs>
<TabItem value="rdb-optimization" label="RDBä¼˜åŒ–">

```bash title="RDBæŒä¹…åŒ–æ€§èƒ½ä¼˜åŒ–"
# RDBè§¦å‘æ¡ä»¶ä¼˜åŒ–
# æ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹è°ƒæ•´saveé…ç½®
save 900 1                             # 15åˆ†é’Ÿå†…è‡³å°‘1ä¸ªkeyå˜åŒ–
save 300 10                            # 5åˆ†é’Ÿå†…è‡³å°‘10ä¸ªkeyå˜åŒ–
save 60 10000                          # 1åˆ†é’Ÿå†…è‡³å°‘10000ä¸ªkeyå˜åŒ–

# é«˜å†™å…¥åœºæ™¯çš„é…ç½®
save 3600 1                            # 1å°æ—¶å†…è‡³å°‘1ä¸ªkeyå˜åŒ–
save 1800 100                          # 30åˆ†é’Ÿå†…è‡³å°‘100ä¸ªkeyå˜åŒ–
save 300 10000                         # 5åˆ†é’Ÿå†…è‡³å°‘10000ä¸ªkeyå˜åŒ–

# ä½å†™å…¥åœºæ™¯çš„é…ç½®
save 300 1                             # 5åˆ†é’Ÿå†…è‡³å°‘1ä¸ªkeyå˜åŒ–
save 60 10                             # 1åˆ†é’Ÿå†…è‡³å°‘10ä¸ªkeyå˜åŒ–
save 10 1000                           # 10ç§’å†…è‡³å°‘1000ä¸ªkeyå˜åŒ–

# RDBæ€§èƒ½é…ç½®
stop-writes-on-bgsave-error yes        # BGSAVEå¤±è´¥æ—¶åœæ­¢å†™å…¥
rdbcompression yes                     # å¯ç”¨RDBå‹ç¼©ï¼ˆCPUæ¢å­˜å‚¨ï¼‰
rdbchecksum yes                        # å¯ç”¨RDBæ ¡éªŒï¼ˆå®‰å…¨æ€§ï¼‰
rdb-save-incremental-fsync yes         # å¢é‡fsyncï¼ˆå‡å°‘IOé˜»å¡ï¼‰

# ç›‘æ§RDBæ€§èƒ½
redis-cli LASTSAVE                     # æœ€åä¸€æ¬¡ä¿å­˜æ—¶é—´
redis-cli INFO persistence
# rdb_changes_since_last_save:1000     # ä¸Šæ¬¡ä¿å­˜åçš„å˜åŒ–æ•°
# rdb_bgsave_in_progress:0             # æ˜¯å¦æ­£åœ¨è¿›è¡ŒBGSAVE
# rdb_last_save_time:1640995200        # æœ€åä¿å­˜æ—¶é—´æˆ³
# rdb_last_bgsave_status:ok            # æœ€åBGSAVEçŠ¶æ€
# rdb_last_bgsave_time_sec:2           # æœ€åBGSAVEè€—æ—¶
```

</TabItem>
<TabItem value="aof-optimization" label="AOFä¼˜åŒ–">

```bash title="AOFæŒä¹…åŒ–æ€§èƒ½ä¼˜åŒ–"
# AOFåŸºç¡€é…ç½®
appendonly yes                         # å¯ç”¨AOF
appendfilename "appendonly.aof"        # AOFæ–‡ä»¶å
appendfsync everysec                   # æ¯ç§’åŒæ­¥ï¼ˆæ¨èï¼‰

# AOFåŒæ­¥ç­–ç•¥å¯¹æ¯”
# appendfsync always    - æ¯ä¸ªå†™å‘½ä»¤éƒ½åŒæ­¥ï¼Œæœ€å®‰å…¨ä½†æ€§èƒ½æœ€ä½
# appendfsync everysec  - æ¯ç§’åŒæ­¥ä¸€æ¬¡ï¼Œå¹³è¡¡å®‰å…¨æ€§å’Œæ€§èƒ½ï¼ˆæ¨èï¼‰
# appendfsync no        - ç”±OSå†³å®šåŒæ­¥æ—¶æœºï¼Œæ€§èƒ½æœ€é«˜ä½†å¯èƒ½ä¸¢å¤±æ•°æ®

# AOFé‡å†™ä¼˜åŒ–é…ç½®
auto-aof-rewrite-percentage 100       # AOFæ–‡ä»¶å¢é•¿100%æ—¶é‡å†™
auto-aof-rewrite-min-size 64mb        # AOFæ–‡ä»¶æœ€å°64MBæ—¶æ‰é‡å†™
aof-rewrite-incremental-fsync yes     # é‡å†™æ—¶å¢é‡åŒæ­¥
aof-load-truncated yes                # åŠ è½½æˆªæ–­çš„AOFæ–‡ä»¶

# æ··åˆæŒä¹…åŒ–ï¼ˆæ¨èï¼‰
aof-use-rdb-preamble yes              # AOFé‡å†™æ—¶ä½¿ç”¨RDBæ ¼å¼

# ç›‘æ§AOFæ€§èƒ½
redis-cli INFO persistence
# aof_enabled:1                        # AOFæ˜¯å¦å¯ç”¨
# aof_rewrite_in_progress:0            # æ˜¯å¦æ­£åœ¨é‡å†™
# aof_rewrite_scheduled:0              # æ˜¯å¦è®¡åˆ’é‡å†™
# aof_last_rewrite_time_sec:3          # æœ€åé‡å†™è€—æ—¶
# aof_current_rewrite_time_sec:-1      # å½“å‰é‡å†™è€—æ—¶
# aof_last_bgrewrite_status:ok         # æœ€åé‡å†™çŠ¶æ€
# aof_current_size:1024000             # å½“å‰AOFæ–‡ä»¶å¤§å°
# aof_base_size:512000                 # åŸºç¡€AOFæ–‡ä»¶å¤§å°
```

</TabItem>
<TabItem value="persistence-monitoring" label="æŒä¹…åŒ–ç›‘æ§">

```java title="æŒä¹…åŒ–æ€§èƒ½ç›‘æ§"
@Component
public class RedisPersistenceMonitor {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    private static final Logger logger = LoggerFactory.getLogger(RedisPersistenceMonitor.class);
    
    /**
     * ç›‘æ§æŒä¹…åŒ–çŠ¶æ€
     */
    @Scheduled(fixedRate = 300000) // æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    public void monitorPersistence() {
        Map<String, Object> persistenceInfo = getPersistenceInfo();
        
        // æ£€æŸ¥RDBçŠ¶æ€
        checkRdbStatus(persistenceInfo);
        
        // æ£€æŸ¥AOFçŠ¶æ€
        checkAofStatus(persistenceInfo);
        
        // æ£€æŸ¥æŒä¹…åŒ–æ€§èƒ½
        checkPersistencePerformance(persistenceInfo);
    }
    
    private Map<String, Object> getPersistenceInfo() {
        return redisTemplate.execute((RedisCallback<Map<String, Object>>) connection -> {
            Properties info = connection.info("persistence");
            Map<String, Object> result = new HashMap<>();
            
            for (String key : info.stringPropertyNames()) {
                result.put(key, info.getProperty(key));
            }
            
            return result;
        });
    }
    
    private void checkRdbStatus(Map<String, Object> info) {
        String rdbStatus = (String) info.get("rdb_last_bgsave_status");
        if (!"ok".equals(rdbStatus)) {
            logger.error("RDBæŒä¹…åŒ–çŠ¶æ€å¼‚å¸¸: {}", rdbStatus);
            sendAlert("RDBæŒä¹…åŒ–å‘Šè­¦", "RDBçŠ¶æ€: " + rdbStatus);
        }
        
        // æ£€æŸ¥RDBè€—æ—¶
        String rdbTimeStr = (String) info.get("rdb_last_bgsave_time_sec");
        if (rdbTimeStr != null && !"-1".equals(rdbTimeStr)) {
            int rdbTime = Integer.parseInt(rdbTimeStr);
            if (rdbTime > 60) { // è¶…è¿‡60ç§’
                logger.warn("RDBæŒä¹…åŒ–è€—æ—¶è¿‡é•¿: {}ç§’", rdbTime);
            }
        }
    }
    
    private void checkAofStatus(Map<String, Object> info) {
        String aofEnabled = (String) info.get("aof_enabled");
        if ("1".equals(aofEnabled)) {
            String aofStatus = (String) info.get("aof_last_bgrewrite_status");
            if (!"ok".equals(aofStatus)) {
                logger.error("AOFé‡å†™çŠ¶æ€å¼‚å¸¸: {}", aofStatus);
                sendAlert("AOFæŒä¹…åŒ–å‘Šè­¦", "AOFé‡å†™çŠ¶æ€: " + aofStatus);
            }
            
            // æ£€æŸ¥AOFæ–‡ä»¶å¤§å°å¢é•¿
            String currentSizeStr = (String) info.get("aof_current_size");
            String baseSizeStr = (String) info.get("aof_base_size");
            
            if (currentSizeStr != null && baseSizeStr != null) {
                long currentSize = Long.parseLong(currentSizeStr);
                long baseSize = Long.parseLong(baseSizeStr);
                
                if (baseSize > 0) {
                    double growthRatio = (double) (currentSize - baseSize) / baseSize * 100;
                    if (growthRatio > 200) { // å¢é•¿è¶…è¿‡200%
                        logger.warn("AOFæ–‡ä»¶å¢é•¿è¿‡å¿«: {}%", String.format("%.2f", growthRatio));
                    }
                }
            }
        }
    }
    
    private void checkPersistencePerformance(Map<String, Object> info) {
        // æ£€æŸ¥æ˜¯å¦æœ‰æŒä¹…åŒ–æ“ä½œæ­£åœ¨è¿›è¡Œ
        String rdbInProgress = (String) info.get("rdb_bgsave_in_progress");
        String aofInProgress = (String) info.get("aof_rewrite_in_progress");
        
        if ("1".equals(rdbInProgress)) {
            logger.info("RDBæŒä¹…åŒ–æ­£åœ¨è¿›è¡Œä¸­");
        }
        
        if ("1".equals(aofInProgress)) {
            logger.info("AOFé‡å†™æ­£åœ¨è¿›è¡Œä¸­");
            
            String rewriteTimeStr = (String) info.get("aof_current_rewrite_time_sec");
            if (rewriteTimeStr != null && !"-1".equals(rewriteTimeStr)) {
                int rewriteTime = Integer.parseInt(rewriteTimeStr);
                if (rewriteTime > 300) { // è¶…è¿‡5åˆ†é’Ÿ
                    logger.warn("AOFé‡å†™è€—æ—¶è¿‡é•¿: {}ç§’", rewriteTime);
                }
            }
        }
    }
    
    /**
     * æ‰‹åŠ¨è§¦å‘æŒä¹…åŒ–æ“ä½œ
     */
    public void triggerPersistence(String type) {
        redisTemplate.execute((RedisCallback<Object>) connection -> {
            switch (type.toLowerCase()) {
                case "rdb":
                    connection.bgSave();
                    logger.info("æ‰‹åŠ¨è§¦å‘RDBæŒä¹…åŒ–");
                    break;
                case "aof":
                    connection.bgReWriteAof();
                    logger.info("æ‰‹åŠ¨è§¦å‘AOFé‡å†™");
                    break;
                default:
                    logger.warn("æœªçŸ¥çš„æŒä¹…åŒ–ç±»å‹: {}", type);
            }
            return null;
        });
    }
    
    /**
     * è·å–æŒä¹…åŒ–æ€§èƒ½ç»Ÿè®¡
     */
    public Map<String, Object> getPersistenceStats() {
        Map<String, Object> info = getPersistenceInfo();
        Map<String, Object> stats = new HashMap<>();
        
        // RDBç»Ÿè®¡
        stats.put("rdb_last_save_time", info.get("rdb_last_save_time"));
        stats.put("rdb_changes_since_last_save", info.get("rdb_changes_since_last_save"));
        stats.put("rdb_last_bgsave_time_sec", info.get("rdb_last_bgsave_time_sec"));
        
        // AOFç»Ÿè®¡
        if ("1".equals(info.get("aof_enabled"))) {
            stats.put("aof_current_size", info.get("aof_current_size"));
            stats.put("aof_base_size", info.get("aof_base_size"));
            stats.put("aof_last_rewrite_time_sec", info.get("aof_last_rewrite_time_sec"));
        }
        
        return stats;
    }
    
    private void sendAlert(String title, String message) {
        // å®ç°å‘Šè­¦é€šçŸ¥é€»è¾‘
        logger.error("å‘Šè­¦: {} - {}", title, message);
    }
}
```

</TabItem>
</Tabs>

## 6. Rediså®æˆ˜åº”ç”¨åœºæ™¯

Redisåœ¨å®é™…é¡¹ç›®ä¸­æœ‰ç€å¹¿æ³›çš„åº”ç”¨åœºæ™¯ï¼Œä»¥ä¸‹æ˜¯ä¸€äº›å…¸å‹çš„å®æˆ˜æ¡ˆä¾‹ã€‚

### 6.1 ç¼“å­˜ç³»ç»Ÿè®¾è®¡

ç¼“å­˜æ˜¯Redisæœ€å¸¸è§çš„åº”ç”¨åœºæ™¯ï¼Œåˆç†çš„ç¼“å­˜ç­–ç•¥å¯ä»¥æ˜¾è‘—æå‡ç³»ç»Ÿæ€§èƒ½ã€‚

<Tabs>
<TabItem value="cache-patterns" label="ç¼“å­˜æ¨¡å¼">

```java title="ç¼“å­˜æ¨¡å¼å®ç°"
@Service
public class CacheService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Autowired
    private UserRepository userRepository;
    
    /**
     * Cache-Asideæ¨¡å¼ï¼ˆæ—è·¯ç¼“å­˜ï¼‰
     * åº”ç”¨ç¨‹åºç›´æ¥ç®¡ç†ç¼“å­˜
     */
    public User getUserCacheAside(Long userId) {
        String cacheKey = "user:cache:" + userId;
        
        // 1. å…ˆæŸ¥ç¼“å­˜
        User user = (User) redisTemplate.opsForValue().get(cacheKey);
        if (user != null) {
            return user;
        }
        
        // 2. ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥æ•°æ®åº“
        user = userRepository.findById(userId).orElse(null);
        if (user != null) {
            // 3. å†™å…¥ç¼“å­˜ï¼Œè®¾ç½®è¿‡æœŸæ—¶é—´
            redisTemplate.opsForValue().set(cacheKey, user, 1, TimeUnit.HOURS);
        }
        
        return user;
    }
    
    /**
     * Write-Throughæ¨¡å¼ï¼ˆå†™ç©¿é€ï¼‰
     * å†™æ“ä½œåŒæ—¶æ›´æ–°ç¼“å­˜å’Œæ•°æ®åº“
     */
    public void updateUserWriteThrough(User user) {
        String cacheKey = "user:cache:" + user.getId();
        
        // 1. æ›´æ–°æ•°æ®åº“
        userRepository.save(user);
        
        // 2. æ›´æ–°ç¼“å­˜
        redisTemplate.opsForValue().set(cacheKey, user, 1, TimeUnit.HOURS);
    }
    
    /**
     * Write-Behindæ¨¡å¼ï¼ˆå†™å›ï¼‰
     * å…ˆæ›´æ–°ç¼“å­˜ï¼Œå¼‚æ­¥æ›´æ–°æ•°æ®åº“
     */
    public void updateUserWriteBehind(User user) {
        String cacheKey = "user:cache:" + user.getId();
        
        // 1. ç«‹å³æ›´æ–°ç¼“å­˜
        redisTemplate.opsForValue().set(cacheKey, user, 1, TimeUnit.HOURS);
        
        // 2. å¼‚æ­¥æ›´æ–°æ•°æ®åº“
        CompletableFuture.runAsync(() -> {
            try {
                Thread.sleep(100); // æ¨¡æ‹Ÿå»¶è¿Ÿ
                userRepository.save(user);
            } catch (Exception e) {
                // å¤„ç†å¼‚å¸¸ï¼Œå¯èƒ½éœ€è¦å›æ»šç¼“å­˜
                redisTemplate.delete(cacheKey);
                throw new RuntimeException("æ•°æ®åº“æ›´æ–°å¤±è´¥", e);
            }
        });
    }
    
    /**
     * ç¼“å­˜é¢„çƒ­
     */
    @PostConstruct
    public void warmUpCache() {
        // é¢„åŠ è½½çƒ­ç‚¹æ•°æ®
        List<User> hotUsers = userRepository.findHotUsers();
        for (User user : hotUsers) {
            String cacheKey = "user:cache:" + user.getId();
            redisTemplate.opsForValue().set(cacheKey, user, 2, TimeUnit.HOURS);
        }
    }
    
    /**
     * ç¼“å­˜ç©¿é€é˜²æŠ¤ - å¸ƒéš†è¿‡æ»¤å™¨
     */
    public User getUserWithBloomFilter(Long userId) {
        // 1. å¸ƒéš†è¿‡æ»¤å™¨æ£€æŸ¥
        if (!bloomFilterContains("user:bloom", userId.toString())) {
            return null; // ç¡®å®šä¸å­˜åœ¨
        }
        
        // 2. æŸ¥ç¼“å­˜
        String cacheKey = "user:cache:" + userId;
        User user = (User) redisTemplate.opsForValue().get(cacheKey);
        if (user != null) {
            return user;
        }
        
        // 3. æŸ¥æ•°æ®åº“
        user = userRepository.findById(userId).orElse(null);
        if (user != null) {
            redisTemplate.opsForValue().set(cacheKey, user, 1, TimeUnit.HOURS);
        } else {
            // ç¼“å­˜ç©ºå€¼ï¼Œé˜²æ­¢ç¼“å­˜ç©¿é€
            redisTemplate.opsForValue().set(cacheKey, "NULL", 5, TimeUnit.MINUTES);
        }
        
        return user;
    }
    
    /**
     * ç¼“å­˜å‡»ç©¿é˜²æŠ¤ - åˆ†å¸ƒå¼é”
     */
    public User getUserWithLock(Long userId) {
        String cacheKey = "user:cache:" + userId;
        String lockKey = "user:lock:" + userId;
        
        // 1. æŸ¥ç¼“å­˜
        User user = (User) redisTemplate.opsForValue().get(cacheKey);
        if (user != null) {
            return user;
        }
        
        // 2. è·å–åˆ†å¸ƒå¼é”
        String lockValue = UUID.randomUUID().toString();
        Boolean lockAcquired = redisTemplate.opsForValue()
            .setIfAbsent(lockKey, lockValue, 10, TimeUnit.SECONDS);
        
        if (Boolean.TRUE.equals(lockAcquired)) {
            try {
                // 3. åŒé‡æ£€æŸ¥
                user = (User) redisTemplate.opsForValue().get(cacheKey);
                if (user != null) {
                    return user;
                }
                
                // 4. æŸ¥æ•°æ®åº“
                user = userRepository.findById(userId).orElse(null);
                if (user != null) {
                    redisTemplate.opsForValue().set(cacheKey, user, 1, TimeUnit.HOURS);
                }
                
                return user;
            } finally {
                // 5. é‡Šæ”¾é”
                releaseLock(lockKey, lockValue);
            }
        } else {
            // ç­‰å¾…å…¶ä»–çº¿ç¨‹åŠ è½½æ•°æ®
            try {
                Thread.sleep(100);
                return getUserWithLock(userId); // é€’å½’é‡è¯•
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
                return null;
            }
        }
    }
    
    private boolean bloomFilterContains(String filterKey, String value) {
        // ç®€åŒ–çš„å¸ƒéš†è¿‡æ»¤å™¨å®ç°
        // å®é™…é¡¹ç›®ä¸­å»ºè®®ä½¿ç”¨Redissonçš„å¸ƒéš†è¿‡æ»¤å™¨
        return true; // å‡è®¾å­˜åœ¨
    }
    
    private void releaseLock(String lockKey, String lockValue) {
        String script = 
            "if redis.call('get', KEYS[1]) == ARGV[1] then " +
            "return redis.call('del', KEYS[1]) " +
            "else return 0 end";
        
        redisTemplate.execute(
            new DefaultRedisScript<>(script, Long.class),
            Collections.singletonList(lockKey),
            lockValue
        );
    }
}
```

</TabItem>
<TabItem value="cache-strategy" label="ç¼“å­˜ç­–ç•¥">

```java title="å¤šçº§ç¼“å­˜ç­–ç•¥"
@Service
public class MultiLevelCacheService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    // æœ¬åœ°ç¼“å­˜
    private final Cache<String, Object> localCache = Caffeine.newBuilder()
        .maximumSize(1000)
        .expireAfterWrite(5, TimeUnit.MINUTES)
        .build();
    
    /**
     * å¤šçº§ç¼“å­˜æŸ¥è¯¢
     * L1: æœ¬åœ°ç¼“å­˜ -> L2: Redisç¼“å­˜ -> L3: æ•°æ®åº“
     */
    public Object getWithMultiLevelCache(String key, Supplier<Object> dataLoader) {
        // L1: æœ¬åœ°ç¼“å­˜
        Object value = localCache.getIfPresent(key);
        if (value != null) {
            return value;
        }
        
        // L2: Redisç¼“å­˜
        value = redisTemplate.opsForValue().get(key);
        if (value != null) {
            localCache.put(key, value);
            return value;
        }
        
        // L3: æ•°æ®åº“
        value = dataLoader.get();
        if (value != null) {
            // å†™å…¥Redisç¼“å­˜
            redisTemplate.opsForValue().set(key, value, 1, TimeUnit.HOURS);
            // å†™å…¥æœ¬åœ°ç¼“å­˜
            localCache.put(key, value);
        }
        
        return value;
    }
    
    /**
     * ç¼“å­˜æ›´æ–°ç­–ç•¥
     */
    public void updateCache(String key, Object value) {
        // 1. åˆ é™¤æœ¬åœ°ç¼“å­˜
        localCache.invalidate(key);
        
        // 2. æ›´æ–°Redisç¼“å­˜
        redisTemplate.opsForValue().set(key, value, 1, TimeUnit.HOURS);
        
        // 3. é€šçŸ¥å…¶ä»–èŠ‚ç‚¹åˆ é™¤æœ¬åœ°ç¼“å­˜
        redisTemplate.convertAndSend("cache:invalidate", key);
    }
    
    /**
     * ç¼“å­˜å¤±æ•ˆç›‘å¬
     */
    @EventListener
    public void handleCacheInvalidate(String key) {
        localCache.invalidate(key);
    }
}

// ç¼“å­˜æ³¨è§£å®ç°
@Component
@Aspect
public class CacheAspect {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Around("@annotation(cacheable)")
    public Object cache(ProceedingJoinPoint joinPoint, Cacheable cacheable) throws Throwable {
        String key = generateKey(joinPoint, cacheable.key());
        
        // æŸ¥ç¼“å­˜
        Object cachedValue = redisTemplate.opsForValue().get(key);
        if (cachedValue != null) {
            return cachedValue;
        }
        
        // æ‰§è¡Œæ–¹æ³•
        Object result = joinPoint.proceed();
        
        // å†™ç¼“å­˜
        if (result != null) {
            redisTemplate.opsForValue().set(key, result, 
                cacheable.expire(), TimeUnit.SECONDS);
        }
        
        return result;
    }
    
    private String generateKey(ProceedingJoinPoint joinPoint, String keyExpression) {
        // ç®€åŒ–çš„keyç”Ÿæˆé€»è¾‘
        return joinPoint.getSignature().getName() + ":" + 
               Arrays.toString(joinPoint.getArgs());
    }
}

// è‡ªå®šä¹‰ç¼“å­˜æ³¨è§£
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface Cacheable {
    String key() default "";
    int expire() default 3600;
}
```

</TabItem>
</Tabs>

### 6.2 åˆ†å¸ƒå¼é”å®ç°

åˆ†å¸ƒå¼é”æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„é‡è¦ç»„ä»¶ï¼ŒRedisæä¾›äº†ç®€å•é«˜æ•ˆçš„å®ç°æ–¹æ¡ˆã€‚

<Tabs>
<TabItem value="distributed-lock" label="åˆ†å¸ƒå¼é”">

```java title="Redisåˆ†å¸ƒå¼é”å®ç°"
@Component
public class RedisDistributedLock {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    private static final String LOCK_PREFIX = "distributed:lock:";
    private static final String UNLOCK_SCRIPT = 
        "if redis.call('get', KEYS[1]) == ARGV[1] then " +
        "return redis.call('del', KEYS[1]) " +
        "else return 0 end";
    
    /**
     * å°è¯•è·å–é”
     */
    public boolean tryLock(String lockKey, String lockValue, long expireTime, TimeUnit timeUnit) {
        String key = LOCK_PREFIX + lockKey;
        Boolean result = redisTemplate.opsForValue()
            .setIfAbsent(key, lockValue, expireTime, timeUnit);
        return Boolean.TRUE.equals(result);
    }
    
    /**
     * é‡Šæ”¾é”
     */
    public boolean releaseLock(String lockKey, String lockValue) {
        String key = LOCK_PREFIX + lockKey;
        Long result = redisTemplate.execute(
            new DefaultRedisScript<>(UNLOCK_SCRIPT, Long.class),
            Collections.singletonList(key),
            lockValue
        );
        return Long.valueOf(1).equals(result);
    }
    
    /**
     * å¯é‡å…¥é”å®ç°
     */
    private static final String REENTRANT_LOCK_SCRIPT = 
        "local key = KEYS[1] " +
        "local value = ARGV[1] " +
        "local expire = ARGV[2] " +
        "local current = redis.call('HGET', key, 'owner') " +
        "if current == false then " +
        "    redis.call('HSET', key, 'owner', value) " +
        "    redis.call('HSET', key, 'count', 1) " +
        "    redis.call('EXPIRE', key, expire) " +
        "    return 1 " +
        "elseif current == value then " +
        "    local count = redis.call('HINCRBY', key, 'count', 1) " +
        "    redis.call('EXPIRE', key, expire) " +
        "    return 1 " +
        "else " +
        "    return 0 " +
        "end";
    
    private static final String REENTRANT_UNLOCK_SCRIPT = 
        "local key = KEYS[1] " +
        "local value = ARGV[1] " +
        "local current = redis.call('HGET', key, 'owner') " +
        "if current == value then " +
        "    local count = redis.call('HINCRBY', key, 'count', -1) " +
        "    if count == 0 then " +
        "        redis.call('DEL', key) " +
        "        return 1 " +
        "    else " +
        "        return 1 " +
        "    end " +
        "else " +
        "    return 0 " +
        "end";
    
    /**
     * å¯é‡å…¥é” - è·å–é”
     */
    public boolean tryReentrantLock(String lockKey, String lockValue, long expireTime) {
        String key = LOCK_PREFIX + lockKey;
        Long result = redisTemplate.execute(
            new DefaultRedisScript<>(REENTRANT_LOCK_SCRIPT, Long.class),
            Collections.singletonList(key),
            lockValue,
            String.valueOf(expireTime)
        );
        return Long.valueOf(1).equals(result);
    }
    
    /**
     * å¯é‡å…¥é” - é‡Šæ”¾é”
     */
    public boolean releaseReentrantLock(String lockKey, String lockValue) {
        String key = LOCK_PREFIX + lockKey;
        Long result = redisTemplate.execute(
            new DefaultRedisScript<>(REENTRANT_UNLOCK_SCRIPT, Long.class),
            Collections.singletonList(key),
            lockValue
        );
        return Long.valueOf(1).equals(result);
    }
}

// åˆ†å¸ƒå¼é”æ³¨è§£
@Component
@Aspect
public class DistributedLockAspect {
    
    @Autowired
    private RedisDistributedLock distributedLock;
    
    @Around("@annotation(lockAnnotation)")
    public Object around(ProceedingJoinPoint joinPoint, DistributedLock lockAnnotation) throws Throwable {
        String lockKey = generateLockKey(joinPoint, lockAnnotation.key());
        String lockValue = UUID.randomUUID().toString();
        
        boolean acquired = distributedLock.tryLock(
            lockKey, 
            lockValue, 
            lockAnnotation.expireTime(), 
            lockAnnotation.timeUnit()
        );
        
        if (!acquired) {
            if (lockAnnotation.waitTime() > 0) {
                // ç­‰å¾…è·å–é”
                return waitAndRetry(joinPoint, lockAnnotation, lockKey, lockValue);
            } else {
                throw new RuntimeException("è·å–åˆ†å¸ƒå¼é”å¤±è´¥: " + lockKey);
            }
        }
        
        try {
            return joinPoint.proceed();
        } finally {
            distributedLock.releaseLock(lockKey, lockValue);
        }
    }
    
    private Object waitAndRetry(ProceedingJoinPoint joinPoint, DistributedLock lockAnnotation, 
                               String lockKey, String lockValue) throws Throwable {
        long waitTime = lockAnnotation.waitTime();
        long startTime = System.currentTimeMillis();
        
        while (System.currentTimeMillis() - startTime < waitTime) {
            boolean acquired = distributedLock.tryLock(
                lockKey, 
                lockValue, 
                lockAnnotation.expireTime(), 
                lockAnnotation.timeUnit()
            );
            
            if (acquired) {
                try {
                    return joinPoint.proceed();
                } finally {
                    distributedLock.releaseLock(lockKey, lockValue);
                }
            }
            
            try {
                Thread.sleep(100); // ç­‰å¾…100msåé‡è¯•
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
                throw new RuntimeException("ç­‰å¾…é”è¢«ä¸­æ–­", e);
            }
        }
        
        throw new RuntimeException("ç­‰å¾…åˆ†å¸ƒå¼é”è¶…æ—¶: " + lockKey);
    }
    
    private String generateLockKey(ProceedingJoinPoint joinPoint, String keyExpression) {
        if (keyExpression.isEmpty()) {
            return joinPoint.getSignature().toShortString();
        }
        
        // ç®€åŒ–çš„SpELè¡¨è¾¾å¼è§£æ
        Object[] args = joinPoint.getArgs();
        return keyExpression.replace("#args[0]", String.valueOf(args[0]));
    }
}

// åˆ†å¸ƒå¼é”æ³¨è§£å®šä¹‰
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface DistributedLock {
    String key() default "";
    long expireTime() default 30;
    TimeUnit timeUnit() default TimeUnit.SECONDS;
    long waitTime() default 0;
}

// ä½¿ç”¨ç¤ºä¾‹
@Service
public class OrderService {
    
    @DistributedLock(key = "order:create:#args[0]", expireTime = 10, waitTime = 5000)
    public void createOrder(String userId, OrderRequest request) {
        // åˆ›å»ºè®¢å•çš„ä¸šåŠ¡é€»è¾‘
        // åŒä¸€ç”¨æˆ·åŒæ—¶åªèƒ½åˆ›å»ºä¸€ä¸ªè®¢å•
    }
    
    @DistributedLock(key = "inventory:reduce:#args[0]", expireTime = 30)
    public void reduceInventory(String productId, int quantity) {
        // å‡åº“å­˜çš„ä¸šåŠ¡é€»è¾‘
        // åŒä¸€å•†å“çš„åº“å­˜æ“ä½œéœ€è¦ä¸²è¡ŒåŒ–
    }
}
```

</TabItem>
</Tabs>

### 6.3 é™æµå™¨å®ç°

é™æµæ˜¯ä¿æŠ¤ç³»ç»Ÿç¨³å®šæ€§çš„é‡è¦æ‰‹æ®µï¼ŒRedisæä¾›äº†å¤šç§é™æµç®—æ³•çš„å®ç°æ–¹æ¡ˆã€‚

<Tabs>
<TabItem value="rate-limiter" label="é™æµç®—æ³•">

```java title="Redisé™æµå™¨å®ç°"
@Component
public class RedisRateLimiter {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    /**
     * å›ºå®šçª—å£é™æµ
     */
    private static final String FIXED_WINDOW_SCRIPT = 
        "local key = KEYS[1] " +
        "local window = tonumber(ARGV[1]) " +
        "local limit = tonumber(ARGV[2]) " +
        "local current = redis.call('INCR', key) " +
        "if current == 1 then " +
        "    redis.call('EXPIRE', key, window) " +
        "end " +
        "if current <= limit then " +
        "    return {1, current, limit - current} " +
        "else " +
        "    return {0, current, 0} " +
        "end";
    
    public RateLimitResult fixedWindowLimit(String key, int windowSeconds, int limit) {
        List<Long> result = redisTemplate.execute(
            new DefaultRedisScript<>(FIXED_WINDOW_SCRIPT, List.class),
            Collections.singletonList("rate_limit:fixed:" + key),
            String.valueOf(windowSeconds),
            String.valueOf(limit)
        );
        
        return new RateLimitResult(
            result.get(0) == 1,
            result.get(1).intValue(),
            result.get(2).intValue()
        );
    }
    
    /**
     * æ»‘åŠ¨çª—å£é™æµ
     */
    private static final String SLIDING_WINDOW_SCRIPT = 
        "local key = KEYS[1] " +
        "local window = tonumber(ARGV[1]) " +
        "local limit = tonumber(ARGV[2]) " +
        "local now = tonumber(ARGV[3]) " +
        "local clearBefore = now - window * 1000 " +
        "redis.call('ZREMRANGEBYSCORE', key, 0, clearBefore) " +
        "local current = redis.call('ZCARD', key) " +
        "if current < limit then " +
        "    redis.call('ZADD', key, now, now) " +
        "    redis.call('EXPIRE', key, window) " +
        "    return {1, current + 1, limit - current - 1} " +
        "else " +
        "    return {0, current, 0} " +
        "end";
    
    public RateLimitResult slidingWindowLimit(String key, int windowSeconds, int limit) {
        long now = System.currentTimeMillis();
        List<Long> result = redisTemplate.execute(
            new DefaultRedisScript<>(SLIDING_WINDOW_SCRIPT, List.class),
            Collections.singletonList("rate_limit:sliding:" + key),
            String.valueOf(windowSeconds),
            String.valueOf(limit),
            String.valueOf(now)
        );
        
        return new RateLimitResult(
            result.get(0) == 1,
            result.get(1).intValue(),
            result.get(2).intValue()
        );
    }
    
    /**
     * ä»¤ç‰Œæ¡¶é™æµ
     */
    private static final String TOKEN_BUCKET_SCRIPT = 
        "local key = KEYS[1] " +
        "local capacity = tonumber(ARGV[1]) " +
        "local tokens = tonumber(ARGV[2]) " +
        "local interval = tonumber(ARGV[3]) " +
        "local requested = tonumber(ARGV[4]) " +
        "local now = tonumber(ARGV[5]) " +
        
        "local bucket = redis.call('HMGET', key, 'tokens', 'last_refill') " +
        "local current_tokens = tonumber(bucket[1]) or capacity " +
        "local last_refill = tonumber(bucket[2]) or now " +
        
        "local elapsed = now - last_refill " +
        "local tokens_to_add = math.floor(elapsed / interval * tokens) " +
        "current_tokens = math.min(capacity, current_tokens + tokens_to_add) " +
        
        "if current_tokens >= requested then " +
        "    current_tokens = current_tokens - requested " +
        "    redis.call('HMSET', key, 'tokens', current_tokens, 'last_refill', now) " +
        "    redis.call('EXPIRE', key, 3600) " +
        "    return {1, current_tokens, requested} " +
        "else " +
        "    redis.call('HMSET', key, 'tokens', current_tokens, 'last_refill', now) " +
        "    redis.call('EXPIRE', key, 3600) " +
        "    return {0, current_tokens, 0} " +
        "end";
    
    public RateLimitResult tokenBucketLimit(String key, int capacity, int tokensPerSecond, int requested) {
        long now = System.currentTimeMillis();
        List<Long> result = redisTemplate.execute(
            new DefaultRedisScript<>(TOKEN_BUCKET_SCRIPT, List.class),
            Collections.singletonList("rate_limit:token:" + key),
            String.valueOf(capacity),
            String.valueOf(tokensPerSecond),
            String.valueOf(1000), // 1ç§’çš„æ¯«ç§’æ•°
            String.valueOf(requested),
            String.valueOf(now)
        );
        
        return new RateLimitResult(
            result.get(0) == 1,
            result.get(1).intValue(),
            result.get(2).intValue()
        );
    }
    
    /**
     * æ¼æ¡¶é™æµ
     */
    private static final String LEAKY_BUCKET_SCRIPT = 
        "local key = KEYS[1] " +
        "local capacity = tonumber(ARGV[1]) " +
        "local leak_rate = tonumber(ARGV[2]) " +
        "local requested = tonumber(ARGV[3]) " +
        "local now = tonumber(ARGV[4]) " +
        
        "local bucket = redis.call('HMGET', key, 'volume', 'last_leak') " +
        "local current_volume = tonumber(bucket[1]) or 0 " +
        "local last_leak = tonumber(bucket[2]) or now " +
        
        "local elapsed = now - last_leak " +
        "local leaked = math.floor(elapsed / 1000 * leak_rate) " +
        "current_volume = math.max(0, current_volume - leaked) " +
        
        "if current_volume + requested <= capacity then " +
        "    current_volume = current_volume + requested " +
        "    redis.call('HMSET', key, 'volume', current_volume, 'last_leak', now) " +
        "    redis.call('EXPIRE', key, 3600) " +
        "    return {1, current_volume, capacity - current_volume} " +
        "else " +
        "    redis.call('HMSET', key, 'volume', current_volume, 'last_leak', now) " +
        "    redis.call('EXPIRE', key, 3600) " +
        "    return {0, current_volume, capacity - current_volume} " +
        "end";
    
    public RateLimitResult leakyBucketLimit(String key, int capacity, int leakRate, int requested) {
        long now = System.currentTimeMillis();
        List<Long> result = redisTemplate.execute(
            new DefaultRedisScript<>(LEAKY_BUCKET_SCRIPT, List.class),
            Collections.singletonList("rate_limit:leaky:" + key),
            String.valueOf(capacity),
            String.valueOf(leakRate),
            String.valueOf(requested),
            String.valueOf(now)
        );
        
        return new RateLimitResult(
            result.get(0) == 1,
            result.get(1).intValue(),
            result.get(2).intValue()
        );
    }
    
    // é™æµç»“æœç±»
    public static class RateLimitResult {
        private final boolean allowed;
        private final int current;
        private final int remaining;
        
        public RateLimitResult(boolean allowed, int current, int remaining) {
            this.allowed = allowed;
            this.current = current;
            this.remaining = remaining;
        }
        
        // getters
        public boolean isAllowed() { return allowed; }
        public int getCurrent() { return current; }
        public int getRemaining() { return remaining; }
    }
}

// é™æµæ³¨è§£å®ç°
@Component
@Aspect
public class RateLimitAspect {
    
    @Autowired
    private RedisRateLimiter rateLimiter;
    
    @Around("@annotation(rateLimit)")
    public Object around(ProceedingJoinPoint joinPoint, RateLimit rateLimit) throws Throwable {
        String key = generateKey(joinPoint, rateLimit);
        
        RedisRateLimiter.RateLimitResult result;
        switch (rateLimit.algorithm()) {
            case FIXED_WINDOW:
                result = rateLimiter.fixedWindowLimit(key, rateLimit.window(), rateLimit.limit());
                break;
            case SLIDING_WINDOW:
                result = rateLimiter.slidingWindowLimit(key, rateLimit.window(), rateLimit.limit());
                break;
            case TOKEN_BUCKET:
                result = rateLimiter.tokenBucketLimit(key, rateLimit.limit(), rateLimit.tokensPerSecond(), 1);
                break;
            case LEAKY_BUCKET:
                result = rateLimiter.leakyBucketLimit(key, rateLimit.limit(), rateLimit.leakRate(), 1);
                break;
            default:
                result = rateLimiter.fixedWindowLimit(key, rateLimit.window(), rateLimit.limit());
        }
        
        if (!result.isAllowed()) {
            throw new RateLimitExceededException("è¯·æ±‚é¢‘ç‡è¿‡é«˜ï¼Œè¯·ç¨åé‡è¯•");
        }
        
        // åœ¨å“åº”å¤´ä¸­æ·»åŠ é™æµä¿¡æ¯
        HttpServletResponse response = getCurrentResponse();
        if (response != null) {
            response.setHeader("X-RateLimit-Limit", String.valueOf(rateLimit.limit()));
            response.setHeader("X-RateLimit-Remaining", String.valueOf(result.getRemaining()));
            response.setHeader("X-RateLimit-Reset", String.valueOf(System.currentTimeMillis() + rateLimit.window() * 1000));
        }
        
        return joinPoint.proceed();
    }
    
    private String generateKey(ProceedingJoinPoint joinPoint, RateLimit rateLimit) {
        String baseKey = rateLimit.key();
        if (baseKey.isEmpty()) {
            baseKey = joinPoint.getSignature().toShortString();
        }
        
        // æ ¹æ®é™æµç»´åº¦ç”Ÿæˆkey
        switch (rateLimit.dimension()) {
            case IP:
                return baseKey + ":" + getCurrentClientIp();
            case USER:
                return baseKey + ":" + getCurrentUserId();
            case GLOBAL:
                return baseKey;
            default:
                return baseKey;
        }
    }
    
    private String getCurrentClientIp() {
        HttpServletRequest request = getCurrentRequest();
        if (request != null) {
            String xForwardedFor = request.getHeader("X-Forwarded-For");
            if (xForwardedFor != null && !xForwardedFor.isEmpty()) {
                return xForwardedFor.split(",")[0].trim();
            }
            return request.getRemoteAddr();
        }
        return "unknown";
    }
    
    private String getCurrentUserId() {
        // ä»å®‰å…¨ä¸Šä¸‹æ–‡è·å–ç”¨æˆ·ID
        return "user123"; // ç®€åŒ–å®ç°
    }
    
    private HttpServletRequest getCurrentRequest() {
        RequestAttributes requestAttributes = RequestContextHolder.getRequestAttributes();
        if (requestAttributes instanceof ServletRequestAttributes) {
            return ((ServletRequestAttributes) requestAttributes).getRequest();
        }
        return null;
    }
    
    private HttpServletResponse getCurrentResponse() {
        RequestAttributes requestAttributes = RequestContextHolder.getRequestAttributes();
        if (requestAttributes instanceof ServletRequestAttributes) {
            return ((ServletRequestAttributes) requestAttributes).getResponse();
        }
        return null;
    }
}

// é™æµæ³¨è§£å®šä¹‰
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface RateLimit {
    String key() default "";
    int limit() default 100;
    int window() default 60;
    RateLimitAlgorithm algorithm() default RateLimitAlgorithm.FIXED_WINDOW;
    RateLimitDimension dimension() default RateLimitDimension.IP;
    int tokensPerSecond() default 10;
    int leakRate() default 10;
}

// é™æµç®—æ³•æšä¸¾
public enum RateLimitAlgorithm {
    FIXED_WINDOW,    // å›ºå®šçª—å£
    SLIDING_WINDOW,  // æ»‘åŠ¨çª—å£
    TOKEN_BUCKET,    // ä»¤ç‰Œæ¡¶
    LEAKY_BUCKET     // æ¼æ¡¶
}

// é™æµç»´åº¦æšä¸¾
public enum RateLimitDimension {
    IP,      // æŒ‰IPé™æµ
    USER,    // æŒ‰ç”¨æˆ·é™æµ
    GLOBAL   // å…¨å±€é™æµ
}

// é™æµå¼‚å¸¸
public class RateLimitExceededException extends RuntimeException {
    public RateLimitExceededException(String message) {
        super(message);
    }
}

// ä½¿ç”¨ç¤ºä¾‹
@RestController
public class ApiController {
    
    @GetMapping("/api/data")
    @RateLimit(key = "api:data", limit = 100, window = 60, algorithm = RateLimitAlgorithm.SLIDING_WINDOW)
    public ResponseEntity<String> getData() {
        return ResponseEntity.ok("data");
    }
    
    @PostMapping("/api/upload")
    @RateLimit(key = "api:upload", limit = 10, window = 60, dimension = RateLimitDimension.USER)
    public ResponseEntity<String> uploadFile() {
        return ResponseEntity.ok("uploaded");
    }
    
    @GetMapping("/api/search")
    @RateLimit(key = "api:search", limit = 1000, tokensPerSecond = 50, algorithm = RateLimitAlgorithm.TOKEN_BUCKET)
    public ResponseEntity<String> search() {
        return ResponseEntity.ok("search results");
    }
}
```

</TabItem>
<TabItem value="rate-limit-comparison" label="é™æµç®—æ³•å¯¹æ¯”">

```java title="é™æµç®—æ³•æ€§èƒ½å¯¹æ¯”"
@Component
public class RateLimitPerformanceTest {
    
    @Autowired
    private RedisRateLimiter rateLimiter;
    
    /**
     * é™æµç®—æ³•æ€§èƒ½æµ‹è¯•
     */
    public void performanceTest() {
        int testCount = 10000;
        String testKey = "performance_test";
        
        // å›ºå®šçª—å£æµ‹è¯•
        long start1 = System.currentTimeMillis();
        for (int i = 0; i < testCount; i++) {
            rateLimiter.fixedWindowLimit(testKey + "_fixed", 60, 1000);
        }
        long time1 = System.currentTimeMillis() - start1;
        
        // æ»‘åŠ¨çª—å£æµ‹è¯•
        long start2 = System.currentTimeMillis();
        for (int i = 0; i < testCount; i++) {
            rateLimiter.slidingWindowLimit(testKey + "_sliding", 60, 1000);
        }
        long time2 = System.currentTimeMillis() - start2;
        
        // ä»¤ç‰Œæ¡¶æµ‹è¯•
        long start3 = System.currentTimeMillis();
        for (int i = 0; i < testCount; i++) {
            rateLimiter.tokenBucketLimit(testKey + "_token", 1000, 100, 1);
        }
        long time3 = System.currentTimeMillis() - start3;
        
        // æ¼æ¡¶æµ‹è¯•
        long start4 = System.currentTimeMillis();
        for (int i = 0; i < testCount; i++) {
            rateLimiter.leakyBucketLimit(testKey + "_leaky", 1000, 100, 1);
        }
        long time4 = System.currentTimeMillis() - start4;
        
        System.out.println("é™æµç®—æ³•æ€§èƒ½æµ‹è¯•ç»“æœï¼ˆ" + testCount + "æ¬¡è¯·æ±‚ï¼‰ï¼š");
        System.out.println("å›ºå®šçª—å£: " + time1 + "ms");
        System.out.println("æ»‘åŠ¨çª—å£: " + time2 + "ms");
        System.out.println("ä»¤ç‰Œæ¡¶: " + time3 + "ms");
        System.out.println("æ¼æ¡¶: " + time4 + "ms");
    }
}
```

| ç®—æ³• | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ | æ€§èƒ½ |
|------|------|------|---------|------|
| **å›ºå®šçª—å£** | å®ç°ç®€å•ï¼Œæ€§èƒ½æœ€é«˜ | è¾¹ç•Œçªåˆºé—®é¢˜ | ç²—ç²’åº¦é™æµ | â­â­â­â­â­ |
| **æ»‘åŠ¨çª—å£** | å¹³æ»‘é™æµï¼Œç²¾ç¡®æ§åˆ¶ | å†…å­˜å ç”¨è¾ƒé«˜ | ç²¾ç¡®é™æµéœ€æ±‚ | â­â­â­ |
| **ä»¤ç‰Œæ¡¶** | å…è®¸çªå‘æµé‡ | å®ç°å¤æ‚ | éœ€è¦å¤„ç†çªå‘è¯·æ±‚ | â­â­â­â­ |
| **æ¼æ¡¶** | æµé‡æ•´å½¢ï¼Œå¹³æ»‘è¾“å‡º | ä¸å…è®¸çªå‘ | éœ€è¦å¹³æ»‘æµé‡ | â­â­â­â­ |

</TabItem>
</Tabs>

### 6.4 æ’è¡Œæ¦œç³»ç»Ÿ

åŸºäºRedis Sorted Setå®ç°çš„æ’è¡Œæ¦œç³»ç»Ÿï¼Œæ”¯æŒå®æ—¶æ›´æ–°å’Œå¤šç»´åº¦æ’åºã€‚

<Tabs>
<TabItem value="leaderboard" label="æ’è¡Œæ¦œå®ç°">

```java title="Redisæ’è¡Œæ¦œç³»ç»Ÿ"
@Service
public class LeaderboardService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    private static final String LEADERBOARD_PREFIX = "leaderboard:";
    
    /**
     * æ›´æ–°ç”¨æˆ·åˆ†æ•°
     */
    public void updateScore(String leaderboardName, String userId, double score) {
        String key = LEADERBOARD_PREFIX + leaderboardName;
        redisTemplate.opsForZSet().add(key, userId, score);
        
        // è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆå¯é€‰ï¼‰
        redisTemplate.expire(key, 7, TimeUnit.DAYS);
    }
    
    /**
     * å¢åŠ ç”¨æˆ·åˆ†æ•°
     */
    public Double incrementScore(String leaderboardName, String userId, double increment) {
        String key = LEADERBOARD_PREFIX + leaderboardName;
        return redisTemplate.opsForZSet().incrementScore(key, userId, increment);
    }
    
    /**
     * è·å–ç”¨æˆ·åˆ†æ•°
     */
    public Double getUserScore(String leaderboardName, String userId) {
        String key = LEADERBOARD_PREFIX + leaderboardName;
        return redisTemplate.opsForZSet().score(key, userId);
    }
    
    /**
     * è·å–ç”¨æˆ·æ’åï¼ˆä»1å¼€å§‹ï¼‰
     */
    public Long getUserRank(String leaderboardName, String userId) {
        String key = LEADERBOARD_PREFIX + leaderboardName;
        Long rank = redisTemplate.opsForZSet().reverseRank(key, userId);
        return rank != null ? rank + 1 : null;
    }
    
    /**
     * è·å–æ’è¡Œæ¦œå‰Nå
     */
    public List<LeaderboardEntry> getTopN(String leaderboardName, int n) {
        String key = LEADERBOARD_PREFIX + leaderboardName;
        Set<ZSetOperations.TypedTuple<Object>> tuples = 
            redisTemplate.opsForZSet().reverseRangeWithScores(key, 0, n - 1);
        
        List<LeaderboardEntry> result = new ArrayList<>();
        int rank = 1;
        for (ZSetOperations.TypedTuple<Object> tuple : tuples) {
            result.add(new LeaderboardEntry(
                rank++,
                (String) tuple.getValue(),
                tuple.getScore()
            ));
        }
        
        return result;
    }
    
    /**
     * è·å–æŒ‡å®šæ’åèŒƒå›´çš„ç”¨æˆ·
     */
    public List<LeaderboardEntry> getRangeByRank(String leaderboardName, long start, long end) {
        String key = LEADERBOARD_PREFIX + leaderboardName;
        Set<ZSetOperations.TypedTuple<Object>> tuples = 
            redisTemplate.opsForZSet().reverseRangeWithScores(key, start - 1, end - 1);
        
        List<LeaderboardEntry> result = new ArrayList<>();
        long rank = start;
        for (ZSetOperations.TypedTuple<Object> tuple : tuples) {
            result.add(new LeaderboardEntry(
                rank++,
                (String) tuple.getValue(),
                tuple.getScore()
            ));
        }
        
        return result;
    }
    
    /**
     * è·å–æŒ‡å®šåˆ†æ•°èŒƒå›´çš„ç”¨æˆ·
     */
    public List<LeaderboardEntry> getRangeByScore(String leaderboardName, double minScore, double maxScore) {
        String key = LEADERBOARD_PREFIX + leaderboardName;
        Set<ZSetOperations.TypedTuple<Object>> tuples = 
            redisTemplate.opsForZSet().reverseRangeByScoreWithScores(key, minScore, maxScore);
        
        List<LeaderboardEntry> result = new ArrayList<>();
        for (ZSetOperations.TypedTuple<Object> tuple : tuples) {
            Long rank = redisTemplate.opsForZSet().reverseRank(key, tuple.getValue());
            result.add(new LeaderboardEntry(
                rank != null ? rank + 1 : 0,
                (String) tuple.getValue(),
                tuple.getScore()
            ));
        }
        
        return result;
    }
    
    /**
     * è·å–ç”¨æˆ·å‘¨å›´çš„æ’å
     */
    public List<LeaderboardEntry> getUserNeighbors(String leaderboardName, String userId, int count) {
        Long userRank = getUserRank(leaderboardName, userId);
        if (userRank == null) {
            return Collections.emptyList();
        }
        
        long start = Math.max(1, userRank - count / 2);
        long end = start + count - 1;
        
        return getRangeByRank(leaderboardName, start, end);
    }
    
    /**
     * åˆ é™¤ç”¨æˆ·
     */
    public void removeUser(String leaderboardName, String userId) {
        String key = LEADERBOARD_PREFIX + leaderboardName;
        redisTemplate.opsForZSet().remove(key, userId);
    }
    
    /**
     * è·å–æ’è¡Œæ¦œæ€»äººæ•°
     */
    public Long getTotalCount(String leaderboardName) {
        String key = LEADERBOARD_PREFIX + leaderboardName;
        return redisTemplate.opsForZSet().zCard(key);
    }
    
    /**
     * æ‰¹é‡æ›´æ–°åˆ†æ•°
     */
    public void batchUpdateScores(String leaderboardName, Map<String, Double> userScores) {
        String key = LEADERBOARD_PREFIX + leaderboardName;
        
        Set<ZSetOperations.TypedTuple<Object>> tuples = new HashSet<>();
        for (Map.Entry<String, Double> entry : userScores.entrySet()) {
            tuples.add(new DefaultTypedTuple<>(entry.getKey(), entry.getValue()));
        }
        
        redisTemplate.opsForZSet().add(key, tuples);
    }
    
    /**
     * å¤šç»´åº¦æ’è¡Œæ¦œåˆå¹¶
     */
    public void mergeLeaderboards(String targetLeaderboard, List<String> sourceLeaderboards, List<Double> weights) {
        String targetKey = LEADERBOARD_PREFIX + targetLeaderboard;
        
        List<String> sourceKeys = sourceLeaderboards.stream()
            .map(name -> LEADERBOARD_PREFIX + name)
            .collect(Collectors.toList());
        
        // ä½¿ç”¨ZUNIONSTOREåˆå¹¶å¤šä¸ªæ’è¡Œæ¦œ
        ZSetOperations.Aggregate aggregate = ZSetOperations.Aggregate.SUM;
        redisTemplate.opsForZSet().unionAndStore(sourceKeys.get(0), sourceKeys.subList(1, sourceKeys.size()), targetKey, aggregate, weights.toArray(new Double[0]));
        
        // è®¾ç½®è¿‡æœŸæ—¶é—´
        redisTemplate.expire(targetKey, 1, TimeUnit.HOURS);
    }
    
    // æ’è¡Œæ¦œæ¡ç›®ç±»
    public static class LeaderboardEntry {
        private final long rank;
        private final String userId;
        private final double score;
        
        public LeaderboardEntry(long rank, String userId, double score) {
            this.rank = rank;
            this.userId = userId;
            this.score = score;
        }
        
        // getters
        public long getRank() { return rank; }
        public String getUserId() { return userId; }
        public double getScore() { return score; }
    }
}

// æ’è¡Œæ¦œç®¡ç†å™¨
@Service
public class LeaderboardManager {
    
    @Autowired
    private LeaderboardService leaderboardService;
    
    /**
     * æ¸¸æˆæ’è¡Œæ¦œç¤ºä¾‹
     */
    public void gameLeaderboardExample() {
        String leaderboard = "game:global";
        
        // æ›´æ–°ç©å®¶åˆ†æ•°
        leaderboardService.updateScore(leaderboard, "player1", 1500);
        leaderboardService.updateScore(leaderboard, "player2", 1200);
        leaderboardService.updateScore(leaderboard, "player3", 1800);
        
        // è·å–å‰10å
        List<LeaderboardService.LeaderboardEntry> top10 = 
            leaderboardService.getTopN(leaderboard, 10);
        
        System.out.println("æ¸¸æˆæ’è¡Œæ¦œå‰10åï¼š");
        for (LeaderboardService.LeaderboardEntry entry : top10) {
            System.out.printf("ç¬¬%då: %s (åˆ†æ•°: %.0f)\n", 
                entry.getRank(), entry.getUserId(), entry.getScore());
        }
    }
    
    /**
     * å®æ—¶æ´»åŠ¨æ’è¡Œæ¦œ
     */
    public void activityLeaderboardExample() {
        String leaderboard = "activity:2025_spring";
        
        // ç”¨æˆ·å®Œæˆä»»åŠ¡ï¼Œå¢åŠ ç§¯åˆ†
        leaderboardService.incrementScore(leaderboard, "user1", 100);
        leaderboardService.incrementScore(leaderboard, "user2", 150);
        leaderboardService.incrementScore(leaderboard, "user3", 80);
        
        // è·å–ç”¨æˆ·æ’åå’Œå‘¨å›´ç”¨æˆ·
        String userId = "user1";
        Long userRank = leaderboardService.getUserRank(leaderboard, userId);
        List<LeaderboardService.LeaderboardEntry> neighbors = 
            leaderboardService.getUserNeighbors(leaderboard, userId, 5);
        
        System.out.println("ç”¨æˆ·" + userId + "å½“å‰æ’å: " + userRank);
        System.out.println("å‘¨å›´ç”¨æˆ·æ’åï¼š");
        for (LeaderboardService.LeaderboardEntry entry : neighbors) {
            System.out.printf("ç¬¬%då: %s (ç§¯åˆ†: %.0f)\n", 
                entry.getRank(), entry.getUserId(), entry.getScore());
        }
    }
    
    /**
     * å¤šç»´åº¦æ’è¡Œæ¦œç¤ºä¾‹
     */
    public void multiDimensionLeaderboardExample() {
        // åˆ›å»ºä¸åŒç»´åº¦çš„æ’è¡Œæ¦œ
        String scoreBoard = "game:score";
        String timeBoard = "game:time";
        String comboBoard = "game:combo";
        
        // æ›´æ–°å„ç»´åº¦æ•°æ®
        leaderboardService.updateScore(scoreBoard, "player1", 1500);
        leaderboardService.updateScore(timeBoard, "player1", 120); // ç”¨æ—¶120ç§’
        leaderboardService.updateScore(comboBoard, "player1", 50); // è¿å‡»50æ¬¡
        
        // åˆå¹¶æ’è¡Œæ¦œï¼ˆç»¼åˆæ’åï¼‰
        List<String> sourceBoards = Arrays.asList(scoreBoard, timeBoard, comboBoard);
        List<Double> weights = Arrays.asList(0.5, -0.3, 0.2); // åˆ†æ•°æƒé‡0.5ï¼Œæ—¶é—´æƒé‡-0.3ï¼ˆè¶Šå°‘è¶Šå¥½ï¼‰ï¼Œè¿å‡»æƒé‡0.2
        
        leaderboardService.mergeLeaderboards("game:comprehensive", sourceBoards, weights);
        
        // è·å–ç»¼åˆæ’è¡Œæ¦œ
        List<LeaderboardService.LeaderboardEntry> comprehensive = 
            leaderboardService.getTopN("game:comprehensive", 10);
        
        System.out.println("ç»¼åˆæ’è¡Œæ¦œï¼š");
        for (LeaderboardService.LeaderboardEntry entry : comprehensive) {
            System.out.printf("ç¬¬%då: %s (ç»¼åˆåˆ†: %.2f)\n", 
                entry.getRank(), entry.getUserId(), entry.getScore());
        }
    }
}
```

</TabItem>
<TabItem value="leaderboard-optimization" label="æ’è¡Œæ¦œä¼˜åŒ–">

```java title="æ’è¡Œæ¦œæ€§èƒ½ä¼˜åŒ–"
@Service
public class OptimizedLeaderboardService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    /**
     * åˆ†é¡µæ’è¡Œæ¦œ - é¿å…å¤§é‡æ•°æ®ä¼ è¾“
     */
    public PageResult<LeaderboardEntry> getLeaderboardPage(String leaderboardName, int page, int size) {
        String key = LEADERBOARD_PREFIX + leaderboardName;
        
        long total = redisTemplate.opsForZSet().zCard(key);
        long start = (page - 1) * size;
        long end = start + size - 1;
        
        Set<ZSetOperations.TypedTuple<Object>> tuples = 
            redisTemplate.opsForZSet().reverseRangeWithScores(key, start, end);
        
        List<LeaderboardEntry> entries = new ArrayList<>();
        long rank = start + 1;
        for (ZSetOperations.TypedTuple<Object> tuple : tuples) {
            entries.add(new LeaderboardEntry(
                rank++,
                (String) tuple.getValue(),
                tuple.getScore()
            ));
        }
        
        return new PageResult<>(entries, page, size, total);
    }
    
    /**
     * ç¼“å­˜ç”¨æˆ·æ’å - å‡å°‘é‡å¤è®¡ç®—
     */
    private final Cache<String, Long> rankCache = Caffeine.newBuilder()
        .maximumSize(10000)
        .expireAfterWrite(5, TimeUnit.MINUTES)
        .build();
    
    public Long getCachedUserRank(String leaderboardName, String userId) {
        String cacheKey = leaderboardName + ":" + userId;
        
        return rankCache.get(cacheKey, key -> {
            String redisKey = LEADERBOARD_PREFIX + leaderboardName;
            Long rank = redisTemplate.opsForZSet().reverseRank(redisKey, userId);
            return rank != null ? rank + 1 : null;
        });
    }
    
    /**
     * æ‰¹é‡è·å–ç”¨æˆ·æ’å
     */
    public Map<String, Long> batchGetUserRanks(String leaderboardName, List<String> userIds) {
        String key = LEADERBOARD_PREFIX + leaderboardName;
        Map<String, Long> result = new HashMap<>();
        
        // ä½¿ç”¨Pipelineæ‰¹é‡è·å–
        List<Object> ranks = redisTemplate.executePipelined((RedisCallback<Object>) connection -> {
            for (String userId : userIds) {
                connection.zRevRank(key.getBytes(), userId.getBytes());
            }
            return null;
        });
        
        for (int i = 0; i < userIds.size(); i++) {
            Long rank = (Long) ranks.get(i);
            result.put(userIds.get(i), rank != null ? rank + 1 : null);
        }
        
        return result;
    }
    
    /**
     * å®šæ—¶æ’è¡Œæ¦œå¿«ç…§
     */
    @Scheduled(cron = "0 0 * * * ?") // æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡
    public void createLeaderboardSnapshot() {
        String sourceKey = LEADERBOARD_PREFIX + "game:realtime";
        String snapshotKey = LEADERBOARD_PREFIX + "game:snapshot:" + 
            LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyyMMddHH"));
        
        // å¤åˆ¶æ’è¡Œæ¦œæ•°æ®
        redisTemplate.opsForZSet().unionAndStore(sourceKey, Collections.emptyList(), snapshotKey);
        
        // è®¾ç½®å¿«ç…§è¿‡æœŸæ—¶é—´ï¼ˆä¿ç•™7å¤©ï¼‰
        redisTemplate.expire(snapshotKey, 7, TimeUnit.DAYS);
    }
    
    /**
     * æ’è¡Œæ¦œæ•°æ®æ¸…ç†
     */
    public void cleanupLeaderboard(String leaderboardName, int keepTopN) {
        String key = LEADERBOARD_PREFIX + leaderboardName;
        
        // åªä¿ç•™å‰Nå
        redisTemplate.opsForZSet().removeRange(key, 0, -keepTopN - 1);
    }
    
    /**
     * æ’è¡Œæ¦œç»Ÿè®¡ä¿¡æ¯
     */
    public LeaderboardStats getLeaderboardStats(String leaderboardName) {
        String key = LEADERBOARD_PREFIX + leaderboardName;
        
        Long totalUsers = redisTemplate.opsForZSet().zCard(key);
        
        // è·å–æœ€é«˜åˆ†å’Œæœ€ä½åˆ†
        Set<ZSetOperations.TypedTuple<Object>> highest = 
            redisTemplate.opsForZSet().reverseRangeWithScores(key, 0, 0);
        Set<ZSetOperations.TypedTuple<Object>> lowest = 
            redisTemplate.opsForZSet().rangeWithScores(key, 0, 0);
        
        Double maxScore = highest.isEmpty() ? 0.0 : highest.iterator().next().getScore();
        Double minScore = lowest.isEmpty() ? 0.0 : lowest.iterator().next().getScore();
        
        // è®¡ç®—å¹³å‡åˆ†ï¼ˆç®€åŒ–å®ç°ï¼‰
        Double avgScore = (maxScore + minScore) / 2;
        
        return new LeaderboardStats(totalUsers, maxScore, minScore, avgScore);
    }
    
    // åˆ†é¡µç»“æœç±»
    public static class PageResult<T> {
        private final List<T> data;
        private final int page;
        private final int size;
        private final long total;
        private final int totalPages;
        
        public PageResult(List<T> data, int page, int size, long total) {
            this.data = data;
            this.page = page;
            this.size = size;
            this.total = total;
            this.totalPages = (int) Math.ceil((double) total / size);
        }
        
        // getters
        public List<T> getData() { return data; }
        public int getPage() { return page; }
        public int getSize() { return size; }
        public long getTotal() { return total; }
        public int getTotalPages() { return totalPages; }
    }
    
    // æ’è¡Œæ¦œç»Ÿè®¡ç±»
    public static class LeaderboardStats {
        private final long totalUsers;
        private final double maxScore;
        private final double minScore;
        private final double avgScore;
        
        public LeaderboardStats(long totalUsers, double maxScore, double minScore, double avgScore) {
            this.totalUsers = totalUsers;
            this.maxScore = maxScore;
            this.minScore = minScore;
            this.avgScore = avgScore;
        }
        
        // getters
        public long getTotalUsers() { return totalUsers; }
        public double getMaxScore() { return maxScore; }
        public double getMinScore() { return minScore; }
        public double getAvgScore() { return avgScore; }
    }
}
```

</TabItem>
</Tabs>

## 7. Redisé¢è¯•é¢˜ç²¾é€‰

### 7.1 åŸºç¡€æ¦‚å¿µé¢˜

**Q1: Redisä¸ºä»€ä¹ˆè¿™ä¹ˆå¿«ï¼Ÿ**

A: Redisé«˜æ€§èƒ½çš„åŸå› åŒ…æ‹¬ï¼š
1. **å†…å­˜æ“ä½œ**ï¼šæ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œé¿å…ç£ç›˜I/O
2. **å•çº¿ç¨‹æ¨¡å‹**ï¼šé¿å…çº¿ç¨‹åˆ‡æ¢å’Œé”ç«äº‰å¼€é”€
3. **é«˜æ•ˆæ•°æ®ç»“æ„**ï¼šé’ˆå¯¹ä¸åŒåœºæ™¯ä¼˜åŒ–çš„æ•°æ®ç»“æ„
4. **éé˜»å¡I/O**ï¼šä½¿ç”¨epollç­‰é«˜æ•ˆI/Oå¤šè·¯å¤ç”¨
5. **ä¼˜åŒ–çš„ç½‘ç»œåè®®**ï¼šç®€å•é«˜æ•ˆçš„RESPåè®®

**Q2: Redisçš„æ•°æ®ç±»å‹æœ‰å“ªäº›ï¼Ÿåˆ†åˆ«é€‚ç”¨äºä»€ä¹ˆåœºæ™¯ï¼Ÿ**

A: Redisæ”¯æŒä»¥ä¸‹æ•°æ®ç±»å‹ï¼š
- **String**ï¼šç¼“å­˜ã€è®¡æ•°å™¨ã€åˆ†å¸ƒå¼é”
- **Hash**ï¼šå¯¹è±¡å­˜å‚¨ã€è´­ç‰©è½¦
- **List**ï¼šæ¶ˆæ¯é˜Ÿåˆ—ã€æ—¶é—´çº¿ã€æœ€æ–°åˆ—è¡¨
- **Set**ï¼šæ ‡ç­¾ç³»ç»Ÿã€å¥½å‹å…³ç³»ã€å»é‡
- **Sorted Set**ï¼šæ’è¡Œæ¦œã€ä¼˜å…ˆçº§é˜Ÿåˆ—ã€èŒƒå›´æŸ¥è¯¢
- **Stream**ï¼šæ¶ˆæ¯æµã€äº‹ä»¶æº¯æº

**Q3: RedisæŒä¹…åŒ–æ–¹å¼æœ‰å“ªäº›ï¼Ÿå„æœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹ï¼Ÿ**

A: Redisæ”¯æŒä¸‰ç§æŒä¹…åŒ–æ–¹å¼ï¼š

| æ–¹å¼ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|---------|
| **RDB** | æ–‡ä»¶å°ã€æ¢å¤å¿«ã€æ€§èƒ½å½±å“å° | å¯èƒ½ä¸¢å¤±æ•°æ®ã€forkè€—æ—¶ | å¤‡ä»½ã€ä¸»ä»åŒæ­¥ |
| **AOF** | æ•°æ®å®‰å…¨ã€å¯è¯»æ€§å¼º | æ–‡ä»¶å¤§ã€æ¢å¤æ…¢ | æ•°æ®å®‰å…¨è¦æ±‚é«˜ |
| **æ··åˆæŒä¹…åŒ–** | å…¼é¡¾æ€§èƒ½å’Œå®‰å…¨ | å¤æ‚åº¦è¾ƒé«˜ | ç”Ÿäº§ç¯å¢ƒæ¨è |

### 7.2 æ¶æ„è®¾è®¡é¢˜

**Q4: Rediså¦‚ä½•å®ç°é«˜å¯ç”¨ï¼Ÿ**

A: Redisé«˜å¯ç”¨æ–¹æ¡ˆï¼š
1. **ä¸»ä»å¤åˆ¶**ï¼šæ•°æ®å¤‡ä»½å’Œè¯»å†™åˆ†ç¦»
2. **å“¨å…µæ¨¡å¼**ï¼šè‡ªåŠ¨æ•…éšœæ£€æµ‹å’Œè½¬ç§»
3. **é›†ç¾¤æ¨¡å¼**ï¼šæ•°æ®åˆ†ç‰‡å’Œæ°´å¹³æ‰©å±•
4. **å®¢æˆ·ç«¯å®¹é”™**ï¼šè¿æ¥æ± ã€é‡è¯•æœºåˆ¶

**Q5: Redisé›†ç¾¤çš„æ•°æ®åˆ†ç‰‡åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ**

A: Redisé›†ç¾¤ä½¿ç”¨ä¸€è‡´æ€§å“ˆå¸Œçš„å˜ç§ï¼š
- 16384ä¸ªæ§½ä½ï¼ˆslotï¼‰
- CRC16(key) % 16384 è®¡ç®—æ§½ä½
- æ¯ä¸ªä¸»èŠ‚ç‚¹è´Ÿè´£ä¸€éƒ¨åˆ†æ§½ä½
- ä½¿ç”¨Hash Tagç¡®ä¿ç›¸å…³keyåœ¨åŒä¸€æ§½ä½

**Q6: å¦‚ä½•è§£å†³Redisç¼“å­˜ç©¿é€ã€å‡»ç©¿ã€é›ªå´©é—®é¢˜ï¼Ÿ**

A: è§£å†³æ–¹æ¡ˆï¼š

| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|---------|
| **ç¼“å­˜ç©¿é€** | æŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ® | å¸ƒéš†è¿‡æ»¤å™¨ã€ç¼“å­˜ç©ºå€¼ |
| **ç¼“å­˜å‡»ç©¿** | çƒ­ç‚¹keyè¿‡æœŸ | åˆ†å¸ƒå¼é”ã€æ°¸ä¸è¿‡æœŸ |
| **ç¼“å­˜é›ªå´©** | å¤§é‡keyåŒæ—¶è¿‡æœŸ | è¿‡æœŸæ—¶é—´éšæœºåŒ–ã€å¤šçº§ç¼“å­˜ |

### 7.3 æ€§èƒ½ä¼˜åŒ–é¢˜

**Q7: å¦‚ä½•ä¼˜åŒ–Redisæ€§èƒ½ï¼Ÿ**

A: æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ï¼š
1. **å†…å­˜ä¼˜åŒ–**ï¼šåˆé€‚çš„æ•°æ®ç»“æ„ã€å†…å­˜æ·˜æ±°ç­–ç•¥
2. **ç½‘ç»œä¼˜åŒ–**ï¼šè¿æ¥æ± ã€Pipelineã€æ‰¹é‡æ“ä½œ
3. **æŒä¹…åŒ–ä¼˜åŒ–**ï¼šåˆç†é…ç½®RDBå’ŒAOFå‚æ•°
4. **æ¶æ„ä¼˜åŒ–**ï¼šè¯»å†™åˆ†ç¦»ã€åˆ†ç‰‡ã€å¤šçº§ç¼“å­˜

**Q8: Redisçš„å†…å­˜æ·˜æ±°ç­–ç•¥æœ‰å“ªäº›ï¼Ÿ**

A: Redisæ”¯æŒ8ç§å†…å­˜æ·˜æ±°ç­–ç•¥ï¼š
- **noeviction**ï¼šä¸æ·˜æ±°ï¼Œå†™å…¥æŠ¥é”™
- **allkeys-lru/lfu**ï¼šä»æ‰€æœ‰keyä¸­æ·˜æ±°
- **volatile-lru/lfu**ï¼šä»è¿‡æœŸkeyä¸­æ·˜æ±°
- **allkeys-random**ï¼šéšæœºæ·˜æ±°æ‰€æœ‰key
- **volatile-random**ï¼šéšæœºæ·˜æ±°è¿‡æœŸkey
- **volatile-ttl**ï¼šæ·˜æ±°å³å°†è¿‡æœŸçš„key

### 7.4 å®æˆ˜åº”ç”¨é¢˜

**Q9: å¦‚ä½•ä½¿ç”¨Rediså®ç°åˆ†å¸ƒå¼é”ï¼Ÿéœ€è¦æ³¨æ„ä»€ä¹ˆé—®é¢˜ï¼Ÿ**

A: åˆ†å¸ƒå¼é”å®ç°è¦ç‚¹ï¼š
1. **åŸå­æ€§**ï¼šä½¿ç”¨SET NX EXå‘½ä»¤
2. **å”¯ä¸€æ€§**ï¼šä½¿ç”¨UUIDä½œä¸ºé”å€¼
3. **è¿‡æœŸæ—¶é—´**ï¼šé˜²æ­¢æ­»é”
4. **å®‰å…¨é‡Šæ”¾**ï¼šLuaè„šæœ¬ç¡®ä¿åŸå­æ€§
5. **å¯é‡å…¥æ€§**ï¼šä½¿ç”¨Hashç»“æ„è®°å½•é‡å…¥æ¬¡æ•°

**Q10: å¦‚ä½•è®¾è®¡ä¸€ä¸ªé«˜æ€§èƒ½çš„Redisç¼“å­˜ç³»ç»Ÿï¼Ÿ**

A: è®¾è®¡è¦ç‚¹ï¼š
1. **ç¼“å­˜ç­–ç•¥**ï¼šCache-Asideã€Write-Throughç­‰
2. **æ•°æ®ç»“æ„é€‰æ‹©**ï¼šæ ¹æ®åœºæ™¯é€‰æ‹©åˆé€‚çš„æ•°æ®ç±»å‹
3. **è¿‡æœŸç­–ç•¥**ï¼šåˆç†è®¾ç½®TTLï¼Œé¿å…é›ªå´©
4. **ç›‘æ§å‘Šè­¦**ï¼šå†…å­˜ä½¿ç”¨ç‡ã€å‘½ä¸­ç‡ã€å“åº”æ—¶é—´
5. **å®¹ç¾å¤‡ä»½**ï¼šä¸»ä»å¤åˆ¶ã€å®šæœŸå¤‡ä»½

:::tip Rediså­¦ä¹ å»ºè®®
1. **ç†è®ºåŸºç¡€**ï¼šæ·±å…¥ç†è§£Redisçš„æ•°æ®ç»“æ„å’Œå®ç°åŸç†
2. **å®è·µåº”ç”¨**ï¼šå¤šåšé¡¹ç›®å®æˆ˜ï¼ŒæŒæ¡å¸¸è§åº”ç”¨åœºæ™¯
3. **æ€§èƒ½è°ƒä¼˜**ï¼šå­¦ä¼šåˆ†ææ€§èƒ½ç“¶é¢ˆï¼ŒæŒæ¡ä¼˜åŒ–æŠ€å·§
4. **æ¶æ„è®¾è®¡**ï¼šäº†è§£é«˜å¯ç”¨æ–¹æ¡ˆï¼Œèƒ½å¤Ÿè®¾è®¡åˆ†å¸ƒå¼ç¼“å­˜æ¶æ„
5. **æŒç»­å­¦ä¹ **ï¼šå…³æ³¨Redisæ–°ç‰ˆæœ¬ç‰¹æ€§ï¼Œå­¦ä¹ æœ€ä½³å®è·µ
:::

---

é€šè¿‡æœ¬ç« çš„æ·±å…¥å­¦ä¹ ï¼Œä½ åº”è¯¥å·²ç»å…¨é¢æŒæ¡äº†Redisçš„æ ¸å¿ƒæ¦‚å¿µã€æ•°æ®ç»“æ„ã€æŒä¹…åŒ–æœºåˆ¶ã€é«˜å¯ç”¨æ¶æ„å’Œæ€§èƒ½ä¼˜åŒ–æŠ€å·§ã€‚Redisä½œä¸ºç°ä»£åº”ç”¨æ¶æ„ä¸­çš„é‡è¦ç»„ä»¶ï¼Œåœ¨ç¼“å­˜ã€ä¼šè¯å­˜å‚¨ã€æ¶ˆæ¯é˜Ÿåˆ—ã€åˆ†å¸ƒå¼é”ç­‰åœºæ™¯ä¸­å‘æŒ¥ç€å…³é”®ä½œç”¨ã€‚

åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œåˆç†ä½¿ç”¨Redisä¸ä»…èƒ½æ˜¾è‘—æå‡ç³»ç»Ÿæ€§èƒ½ï¼Œè¿˜èƒ½ç®€åŒ–æ¶æ„è®¾è®¡ã€‚å¸Œæœ›è¿™ä»½è¯¦ç»†çš„RedisæŒ‡å—èƒ½å¤Ÿå¸®åŠ©ä½ åœ¨æŠ€æœ¯é¢è¯•å’Œå®é™…å·¥ä½œä¸­æ¸¸åˆƒæœ‰ä½™ï¼