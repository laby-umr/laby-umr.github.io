---
sidebar_position: 7
title: Hibernateè¯¦è§£
description: æ·±å…¥ç†è§£Hibernate ORMæ¡†æ¶çš„æ ¸å¿ƒæœºåˆ¶ã€é«˜çº§ç‰¹æ€§ä¸å®æˆ˜åº”ç”¨
authors: [Laby]
tags: [Hibernate, ORMæ¡†æ¶, JPA, æŒä¹…åŒ–, ç¼“å­˜]
last_update:
  date: 2025-09-03
  author: Laby
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import CodeBlock from '@theme/CodeBlock';

# Hibernateè¯¦è§£

Hibernateæ˜¯ä¸€ä¸ªæˆç†Ÿã€å¼ºå¤§çš„å¼€æºORMï¼ˆå¯¹è±¡å…³ç³»æ˜ å°„ï¼‰æ¡†æ¶ï¼Œä¸ºJavaåº”ç”¨ç¨‹åºæä¾›äº†å¯¹è±¡ä¸å…³ç³»å‹æ•°æ®åº“ä¹‹é—´çš„æ˜ å°„èƒ½åŠ›ã€‚ä½œä¸ºJPAè§„èŒƒçš„å‚è€ƒå®ç°ï¼ŒHibernateä¸ä»…ç®€åŒ–äº†æ•°æ®åº“è®¿é—®ï¼Œè¿˜æä¾›äº†ç¼“å­˜ã€å»¶è¿ŸåŠ è½½ã€æ‰¹å¤„ç†ç­‰å¤šç§é«˜çº§ç‰¹æ€§ï¼Œå¸®åŠ©å¼€å‘è€…æ„å»ºé«˜æ•ˆã€å¯ç»´æŠ¤çš„æ•°æ®è®¿é—®å±‚ã€‚

:::tip æ ¸å¿ƒä»·å€¼
**Hibernate = å¯¹è±¡å…³ç³»æ˜ å°„ + é€æ˜æŒä¹…åŒ– + ç¼“å­˜æœºåˆ¶ + æŸ¥è¯¢ä¼˜åŒ–**
- ğŸ”„ **å¯¹è±¡å…³ç³»æ˜ å°„**ï¼šæ— éœ€ç¼–å†™SQLï¼Œè‡ªåŠ¨è½¬æ¢å¯¹è±¡ä¸å…³ç³»æ¨¡å‹
- ğŸ›¡ï¸ **é€æ˜æŒä¹…åŒ–**ï¼šå¯¹è±¡çŠ¶æ€è‡ªåŠ¨åŒæ­¥åˆ°æ•°æ®åº“ï¼Œå‡å°‘æ ·æ¿ä»£ç 
- ğŸš€ **å¤šçº§ç¼“å­˜**ï¼šä¸€çº§ç¼“å­˜ã€äºŒçº§ç¼“å­˜ã€æŸ¥è¯¢ç¼“å­˜æå‡æ€§èƒ½
- ğŸ’¡ **æ‡’åŠ è½½**ï¼šæŒ‰éœ€åŠ è½½å…³è”æ•°æ®ï¼Œä¼˜åŒ–å†…å­˜ä½¿ç”¨
- ğŸ”Œ **æ–¹è¨€ç³»ç»Ÿ**ï¼šæ”¯æŒå‡ ä¹æ‰€æœ‰ä¸»æµå…³ç³»å‹æ•°æ®åº“
:::

## 1. HibernateåŸºç¡€ä¸æ¶æ„

### 1.1 ORMæ¦‚å¿µä¸Hibernateå®šä½

ORMï¼ˆObject-Relational Mappingï¼Œå¯¹è±¡å…³ç³»æ˜ å°„ï¼‰æ˜¯ä¸€ç§å°†å¯¹è±¡ä¸å…³ç³»æ•°æ®åº“è¡¨ä¹‹é—´å»ºç«‹æ˜ å°„å…³ç³»çš„æŠ€æœ¯ï¼Œç›®çš„æ˜¯è§£å†³é¢å‘å¯¹è±¡ç¼–ç¨‹è¯­è¨€ä¸å…³ç³»æ•°æ®åº“ä¹‹é—´çš„é˜»æŠ—ä¸åŒ¹é…é—®é¢˜ã€‚

Hibernateæ˜¯Javaç”Ÿæ€ä¸­æœ€æˆç†Ÿçš„ORMè§£å†³æ–¹æ¡ˆä¹‹ä¸€ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

- **å®Œå…¨å±è”½SQL**ï¼šå¼€å‘è€…å¯ä»¥ä½¿ç”¨é¢å‘å¯¹è±¡çš„æ–¹å¼æ“ä½œæ•°æ®åº“ï¼Œæ— éœ€ç¼–å†™SQLè¯­å¥
- **è‡ªåŠ¨ç®¡ç†å¯¹è±¡çŠ¶æ€**ï¼šè¿½è¸ªå¯¹è±¡å˜åŒ–ï¼Œè‡ªåŠ¨åŒæ­¥åˆ°æ•°æ®åº“
- **é€æ˜æŒä¹…åŒ–**ï¼šæŒä¹…åŒ–æ“ä½œå¯¹ä¸šåŠ¡é€»è¾‘å‡ ä¹ä¸å¯è§
- **JPAè§„èŒƒå®ç°**ï¼šåŒæ—¶æ”¯æŒåŸç”ŸAPIå’Œæ ‡å‡†JPA API
- **ä¸°å¯Œçš„æ˜ å°„ç­–ç•¥**ï¼šæ”¯æŒå„ç§å¤æ‚çš„å¯¹è±¡å…³ç³»æ˜ å°„

#### 1.1.1 Hibernateä¸å…¶ä»–ORMæ¡†æ¶å¯¹æ¯”

| ç‰¹æ€§ | Hibernate | MyBatis | JPA | JDBC |
|------|-----------|---------|-----|------|
| **æŠ½è±¡çº§åˆ«** | é«˜ | ä¸­ | é«˜ | ä½ |
| **SQLæ§åˆ¶** | è‡ªåŠ¨ç”Ÿæˆ | æ‰‹åŠ¨ç¼–å†™ | è‡ªåŠ¨ç”Ÿæˆ | æ‰‹åŠ¨ç¼–å†™ |
| **å­¦ä¹ æ›²çº¿** | é™¡å³­ | å¹³ç¼“ | ä¸­ç­‰ | ç®€å• |
| **æ€§èƒ½æ§åˆ¶** | è¾ƒä½ | è¾ƒé«˜ | ä¸­ç­‰ | å®Œå…¨æ§åˆ¶ |
| **å¯¹è±¡æ˜ å°„** | è‡ªåŠ¨å®Œæˆ | æ‰‹åŠ¨æ˜ å°„ | è‡ªåŠ¨å®Œæˆ | æ‰‹åŠ¨æ˜ å°„ |
| **ç¼“å­˜æœºåˆ¶** | å¤šçº§ç¼“å­˜ | ä¸€çº§ç¼“å­˜ | äºŒçº§ç¼“å­˜ | æ— å†…ç½®ç¼“å­˜ |
| **æ•°æ®åº“ç§»æ¤** | æä½³ | ä¸€èˆ¬ | è‰¯å¥½ | è¾ƒå·® |
| **é€‚ç”¨åœºæ™¯** | å¤æ‚å¯¹è±¡æ¨¡å‹ | SQLä¼˜åŒ–åœºæ™¯ | æ ‡å‡†åŒ–åº”ç”¨ | æ€§èƒ½æé™åœºæ™¯ |

### 1.2 Hibernateæ¶æ„

Hibernateé‡‡ç”¨åˆ†å±‚æ¶æ„è®¾è®¡ï¼Œä¸»è¦åŒ…æ‹¬ä»¥ä¸‹æ ¸å¿ƒç»„ä»¶ï¼š

![Hibernateæ¶æ„](https://hibernate.org/images/hibernate_architecture.svg)

#### 1.2.1 æ ¸å¿ƒç»„ä»¶

1. **Configuration**ï¼šé…ç½®ç®¡ç†ï¼Œè´Ÿè´£è¯»å–é…ç½®æ–‡ä»¶å’Œåˆ›å»ºSessionFactory
2. **SessionFactory**ï¼šä¼šè¯å·¥å‚ï¼Œçº¿ç¨‹å®‰å…¨çš„å…±äº«å¯¹è±¡ï¼Œè´Ÿè´£åˆ›å»ºSession
3. **Session**ï¼šæ ¸å¿ƒæ¥å£ï¼Œä»£è¡¨ä¸æ•°æ®åº“çš„ä¸€æ¬¡ä¼šè¯ï¼Œæä¾›CRUDæ“ä½œ
4. **Transaction**ï¼šäº‹åŠ¡ç®¡ç†ï¼Œæ§åˆ¶åŸå­æ€§æ“ä½œ
5. **ConnectionProvider**ï¼šè¿æ¥æä¾›è€…ï¼Œç®¡ç†æ•°æ®åº“è¿æ¥
6. **TransactionFactory**ï¼šäº‹åŠ¡å·¥å‚ï¼Œåˆ›å»ºTransactionå¯¹è±¡
7. **PersistentManager**ï¼šæŒä¹…åŒ–ç®¡ç†å™¨ï¼Œè´Ÿè´£å¯¹è±¡çŠ¶æ€ç®¡ç†

#### 1.2.2 å·¥ä½œæµç¨‹

```mermaid
flowchart TD
    A[Configuration] -->|åˆ›å»º| B[SessionFactory]
    B -->|åˆ›å»º| C[Session]
    C -->|æ‰“å¼€| D[Transaction]
    C -->|æ‰§è¡Œ| E[æŒä¹…åŒ–æ“ä½œ]
    E -->|è®¿é—®| F[æ•°æ®åº“]
    D -->|æäº¤/å›æ»š| G[äº‹åŠ¡ç»“æŸ]
    G -->|å…³é—­| C
```

Hibernateçš„å…¸å‹å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š

1. åŠ è½½é…ç½®åˆ›å»ºSessionFactoryï¼ˆåº”ç”¨å¯åŠ¨æ—¶ä¸€æ¬¡æ€§å®Œæˆï¼‰
2. ä»SessionFactoryè·å–Sessionï¼ˆæ¯æ¬¡æ•°æ®åº“æ“ä½œè·å–ï¼‰
3. å¼€å¯äº‹åŠ¡ï¼ˆä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼‰
4. æ‰§è¡ŒæŒä¹…åŒ–æ“ä½œï¼ˆå¢åˆ æ”¹æŸ¥ï¼‰
5. æäº¤äº‹åŠ¡ï¼ˆæˆ–å‡ºé”™æ—¶å›æ»šï¼‰
6. å…³é—­Sessionï¼ˆé‡Šæ”¾èµ„æºï¼‰

### 1.3 Hibernateå¯¹è±¡ç”Ÿå‘½å‘¨æœŸ

Hibernateç®¡ç†çš„å®ä½“å¯¹è±¡åœ¨å…¶ç”Ÿå‘½å‘¨æœŸä¸­å¯èƒ½å¤„äºä»¥ä¸‹å››ç§çŠ¶æ€ä¹‹ä¸€ï¼š

#### 1.3.1 å¯¹è±¡çŠ¶æ€

1. **ç¬æ—¶æ€ï¼ˆTransientï¼‰**ï¼š
   - åˆšåˆ›å»ºçš„å¯¹è±¡ï¼Œæœªä¸Sessionå…³è”
   - æ²¡æœ‰æŒä¹…åŒ–æ ‡è¯†ç¬¦ï¼ˆæ•°æ®åº“ä¸»é”®ï¼‰
   - å¯¹æ­¤å¯¹è±¡çš„ä¿®æ”¹ä¸ä¼šå½±å“æ•°æ®åº“

```java
// ç¬æ—¶æ€å¯¹è±¡
User user = new User();
user.setName("å¼ ä¸‰");
// æ­¤æ—¶å¯¹è±¡ä¸åœ¨Sessionç®¡ç†ä¸‹ï¼Œå¯¹å…¶ä¿®æ”¹ä¸ä¼šåæ˜ åˆ°æ•°æ®åº“
```

2. **æŒä¹…æ€ï¼ˆPersistentï¼‰**ï¼š
   - å·²ä¸Sessionå…³è”ï¼Œæœ‰æŒä¹…åŒ–æ ‡è¯†ç¬¦
   - å¯¹è¯¥å¯¹è±¡çš„ä¿®æ”¹ä¼šè¢«Sessionè·Ÿè¸ª
   - äº‹åŠ¡æäº¤æ—¶è‡ªåŠ¨åŒæ­¥åˆ°æ•°æ®åº“

```java
Session session = sessionFactory.openSession();
Transaction tx = session.beginTransaction();

// é€šè¿‡save()æ–¹æ³•ä½¿å¯¹è±¡è¿›å…¥æŒä¹…æ€
session.save(user);
// æˆ–é€šè¿‡get()æ–¹æ³•è·å–çš„å¯¹è±¡ç›´æ¥å¤„äºæŒä¹…æ€
User persistentUser = session.get(User.class, 1L);

// æŒä¹…æ€å¯¹è±¡çš„ä¿®æ”¹ä¼šè¢«è‡ªåŠ¨è·Ÿè¸ª
persistentUser.setEmail("zhangsan@example.com");
// ä¸éœ€è¦æ˜¾å¼updateï¼Œä¿®æ”¹ä¼šåœ¨äº‹åŠ¡æäº¤æ—¶åŒæ­¥åˆ°æ•°æ®åº“

tx.commit();
```

3. **æ¸¸ç¦»æ€ï¼ˆDetachedï¼‰**ï¼š
   - æ›¾ç»å¤„äºæŒä¹…æ€ï¼Œä½†å½“å‰ä¸åœ¨Sessionç®¡ç†ä¸‹
   - æœ‰æŒä¹…åŒ–æ ‡è¯†ç¬¦ï¼Œä½†ä¿®æ”¹ä¸ä¼šåŒæ­¥åˆ°æ•°æ®åº“

```java
// Sessionå…³é—­åï¼ŒæŒä¹…æ€å¯¹è±¡å˜ä¸ºæ¸¸ç¦»æ€
session.close();
// æ­¤æ—¶persistentUserå·²ç»æ˜¯æ¸¸ç¦»æ€
persistentUser.setPhone("13800138000");
// è¿™ä¸ªä¿®æ”¹ä¸ä¼šè¢«åŒæ­¥åˆ°æ•°æ®åº“
```

4. **åˆ é™¤æ€ï¼ˆRemovedï¼‰**ï¼š
   - å·²è¢«Sessionæ ‡è®°ä¸ºåˆ é™¤çš„å¯¹è±¡
   - äº‹åŠ¡æäº¤åä»æ•°æ®åº“ä¸­åˆ é™¤

```java
Session session = sessionFactory.openSession();
Transaction tx = session.beginTransaction();

User user = session.get(User.class, 1L);
// æ ‡è®°å¯¹è±¡ä¸ºåˆ é™¤æ€
session.delete(user);
// äº‹åŠ¡æäº¤åï¼Œæ•°æ®ä¼šä»æ•°æ®åº“ä¸­åˆ é™¤
tx.commit();
```

#### 1.3.2 çŠ¶æ€è½¬æ¢

ä»¥ä¸‹æ˜¯å¯¹è±¡çŠ¶æ€è½¬æ¢çš„ä¸»è¦æ–¹æ³•ï¼š

- **ç¬æ—¶æ€â†’æŒä¹…æ€**ï¼š`save()`, `saveOrUpdate()`, `persist()`
- **æŒä¹…æ€â†’æ¸¸ç¦»æ€**ï¼š`evict()`, `clear()`, sessionå…³é—­
- **æ¸¸ç¦»æ€â†’æŒä¹…æ€**ï¼š`update()`, `saveOrUpdate()`, `lock()`, `merge()`
- **æŒä¹…æ€â†’åˆ é™¤æ€**ï¼š`delete()`
- **æ¸¸ç¦»æ€â†’åˆ é™¤æ€**ï¼š`delete()`

```java
Session session = sessionFactory.openSession();
Transaction tx = session.beginTransaction();

// ç¬æ—¶æ€ -> æŒä¹…æ€
User user = new User("æå››", "lisi@example.com");
session.save(user);

// æŒä¹…æ€ -> æ¸¸ç¦»æ€
session.evict(user);

// æ¸¸ç¦»æ€ -> æŒä¹…æ€
user.setName("æå››(å·²æ›´æ–°)");
session.update(user);

// æŒä¹…æ€ -> åˆ é™¤æ€
session.delete(user);

tx.commit();
session.close();
```

### 1.4 ç¯å¢ƒæ­å»ºä¸åŸºç¡€é…ç½®

#### 1.4.1 æ·»åŠ ä¾èµ–

åœ¨Mavené¡¹ç›®ä¸­æ·»åŠ Hibernateä¾èµ–ï¼š

```xml
<!-- Hibernateæ ¸å¿ƒ -->
<dependency>
    <groupId>org.hibernate</groupId>
    <artifactId>hibernate-core</artifactId>
    <version>5.6.15.Final</version>
</dependency>

<!-- æ•°æ®åº“é©±åŠ¨ï¼ˆä»¥MySQLä¸ºä¾‹ï¼‰ -->
<dependency>
    <groupId>mysql</groupId>
    <artifactId>mysql-connector-java</artifactId>
    <version>8.0.30</version>
</dependency>

<!-- è¿æ¥æ± ï¼ˆå¯é€‰ï¼‰ -->
<dependency>
    <groupId>com.zaxxer</groupId>
    <artifactId>HikariCP</artifactId>
    <version>5.0.1</version>
</dependency>
```

#### 1.4.2 XMLé…ç½®æ–¹å¼

åˆ›å»º`hibernate.cfg.xml`é…ç½®æ–‡ä»¶ï¼š

```xml
<!DOCTYPE hibernate-configuration PUBLIC
        "-//Hibernate/Hibernate Configuration DTD 3.0//EN"
        "http://www.hibernate.org/dtd/hibernate-configuration-3.0.dtd">
<hibernate-configuration>
    <session-factory>
        <!-- æ•°æ®åº“è¿æ¥è®¾ç½® -->
        <property name="hibernate.connection.driver_class">com.mysql.cj.jdbc.Driver</property>
        <property name="hibernate.connection.url">jdbc:mysql://localhost:3306/test?useSSL=false&amp;serverTimezone=UTC</property>
        <property name="hibernate.connection.username">root</property>
        <property name="hibernate.connection.password">password</property>
        
        <!-- æ–¹è¨€é…ç½® -->
        <property name="hibernate.dialect">org.hibernate.dialect.MySQL8Dialect</property>
        
        <!-- è¾“å‡ºSQL -->
        <property name="hibernate.show_sql">true</property>
        <property name="hibernate.format_sql">true</property>
        
        <!-- è‡ªåŠ¨å»ºè¡¨ -->
        <property name="hibernate.hbm2ddl.auto">update</property>
        
        <!-- è¿æ¥æ± é…ç½®ï¼ˆä½¿ç”¨HikariCPï¼‰ -->
        <property name="hibernate.connection.provider_class">org.hibernate.hikaricp.internal.HikariCPConnectionProvider</property>
        <property name="hibernate.hikari.minimumIdle">5</property>
        <property name="hibernate.hikari.maximumPoolSize">10</property>
        <property name="hibernate.hikari.idleTimeout">30000</property>
        
        <!-- äºŒçº§ç¼“å­˜é…ç½® -->
        <property name="hibernate.cache.use_second_level_cache">true</property>
        <property name="hibernate.cache.region.factory_class">org.hibernate.cache.jcache.JCacheRegionFactory</property>
        <property name="hibernate.javax.cache.provider">org.ehcache.jsr107.EhcacheCachingProvider</property>
        
        <!-- æ˜ å°„æ–‡ä»¶ -->
        <mapping resource="com/example/model/User.hbm.xml"/>
        <!-- æˆ–ä½¿ç”¨æ³¨è§£æ˜ å°„ -->
        <mapping class="com.example.model.User"/>
    </session-factory>
</hibernate-configuration>
```

#### 1.4.3 Javaé…ç½®æ–¹å¼

ä½¿ç”¨Javaä»£ç è¿›è¡Œé…ç½®ï¼š

```java
import org.hibernate.SessionFactory;
import org.hibernate.boot.Metadata;
import org.hibernate.boot.MetadataSources;
import org.hibernate.boot.registry.StandardServiceRegistry;
import org.hibernate.boot.registry.StandardServiceRegistryBuilder;

public class HibernateUtil {
    private static StandardServiceRegistry registry;
    private static SessionFactory sessionFactory;
    
    public static SessionFactory getSessionFactory() {
        if (sessionFactory == null) {
            try {
                // åˆ›å»ºæ³¨å†Œè¡¨
                registry = new StandardServiceRegistryBuilder()
                    .configure() // åŠ è½½hibernate.cfg.xml
                    .build();
                
                // åˆ›å»ºMetadataSources
                MetadataSources sources = new MetadataSources(registry);
                
                // æ·»åŠ å®ä½“ç±»
                sources.addAnnotatedClass(User.class);
                
                // åˆ›å»ºMetadata
                Metadata metadata = sources.getMetadataBuilder().build();
                
                // åˆ›å»ºSessionFactory
                sessionFactory = metadata.getSessionFactoryBuilder().build();
            } catch (Exception e) {
                if (registry != null) {
                    StandardServiceRegistryBuilder.destroy(registry);
                }
                throw e;
            }
        }
        return sessionFactory;
    }
    
    public static void shutdown() {
        if (registry != null) {
            StandardServiceRegistryBuilder.destroy(registry);
        }
    }
}
```

#### 1.4.4 ä¸»è¦é…ç½®é€‰é¡¹è¯´æ˜

| é…ç½®é¡¹ | è¯´æ˜ | å¸¸ç”¨å€¼ |
|-------|------|-------|
| `hibernate.dialect` | æ•°æ®åº“æ–¹è¨€ | MySQL8Dialect, PostgreSQLDialect, Oracle12cDialect |
| `hibernate.show_sql` | æ˜¾ç¤ºSQLè¯­å¥ | true, false |
| `hibernate.format_sql` | æ ¼å¼åŒ–SQL | true, false |
| `hibernate.hbm2ddl.auto` | è‡ªåŠ¨å»ºè¡¨ç­–ç•¥ | create, update, validate, create-drop, none |
| `hibernate.cache.use_second_level_cache` | å¯ç”¨äºŒçº§ç¼“å­˜ | true, false |
| `hibernate.cache.use_query_cache` | å¯ç”¨æŸ¥è¯¢ç¼“å­˜ | true, false |
| `hibernate.current_session_context_class` | Sessionä¸Šä¸‹æ–‡ç®¡ç† | thread, jta |
| `hibernate.jdbc.batch_size` | JDBCæ‰¹å¤„ç†å¤§å° | 10-50 (è§†æƒ…å†µ) |
| `hibernate.connection.isolation` | äº‹åŠ¡éš”ç¦»çº§åˆ« | 1(è¯»æœªæäº¤), 2(è¯»å·²æäº¤), 4(å¯é‡å¤è¯»), 8(ä¸²è¡ŒåŒ–) |

## 2. å®ä½“æ˜ å°„æŠ€æœ¯

Hibernateçš„æ ¸å¿ƒåŠŸèƒ½æ˜¯å®ç°å¯¹è±¡å…³ç³»æ˜ å°„ï¼Œå°†Javaå¯¹è±¡æ˜ å°„åˆ°å…³ç³»æ•°æ®åº“è¡¨ã€‚

### 2.1 æ³¨è§£æ˜ å°„

åœ¨ç°ä»£Hibernateåº”ç”¨ä¸­ï¼Œæ³¨è§£æ˜¯æœ€å¸¸ç”¨çš„æ˜ å°„æ–¹å¼ï¼Œå®ƒç›´æ¥åœ¨å®ä½“ç±»ä¸Šå®šä¹‰æ˜ å°„å…³ç³»ã€‚

#### 2.1.1 åŸºæœ¬æ³¨è§£

```java
import javax.persistence.*;
import java.util.Date;

@Entity // å£°æ˜è¿™æ˜¯ä¸€ä¸ªå®ä½“ç±»
@Table(name = "users") // æ˜ å°„åˆ°æ•°æ®åº“ä¸­çš„è¡¨å
public class User {
    
    @Id // å£°æ˜ä¸»é”®
    @GeneratedValue(strategy = GenerationType.IDENTITY) // ä¸»é”®ç”Ÿæˆç­–ç•¥
    private Long id;
    
    @Column(name = "username", nullable = false, length = 50) // åˆ—å®šä¹‰
    private String username;
    
    @Column(name = "email", unique = true)
    private String email;
    
    @Temporal(TemporalType.TIMESTAMP) // æ—¥æœŸç±»å‹æ˜ å°„
    @Column(name = "created_at")
    private Date createdAt;
    
    @Enumerated(EnumType.STRING) // æšä¸¾ç±»å‹æ˜ å°„
    @Column(name = "status")
    private UserStatus status;
    
    @Transient // éæŒä¹…åŒ–å­—æ®µ
    private String temporaryData;
    
    // æ„é€ å‡½æ•°ã€Getterå’ŒSetterçœç•¥...
}

// æšä¸¾ç±»
public enum UserStatus {
    ACTIVE, INACTIVE, SUSPENDED
}
```

#### 2.1.2 ä¸»é”®ç”Ÿæˆç­–ç•¥

Hibernateæ”¯æŒå¤šç§ä¸»é”®ç”Ÿæˆç­–ç•¥ï¼Œé€šè¿‡`@GeneratedValue`æ³¨è§£é…ç½®ï¼š

```java
// è‡ªå¢é•¿ï¼ˆä¾èµ–æ•°æ®åº“çš„è‡ªå¢ç‰¹æ€§ï¼‰
@Id
@GeneratedValue(strategy = GenerationType.IDENTITY)
private Long id;

// åºåˆ—ç”Ÿæˆå™¨ï¼ˆé€‚ç”¨äºOracleç­‰æ”¯æŒåºåˆ—çš„æ•°æ®åº“ï¼‰
@Id
@GeneratedValue(strategy = GenerationType.SEQUENCE, generator = "user_seq")
@SequenceGenerator(name = "user_seq", sequenceName = "USER_SEQ", allocationSize = 1)
private Long id;

// è¡¨ç”Ÿæˆå™¨ï¼ˆç‹¬ç«‹äºç‰¹å®šæ•°æ®åº“ï¼‰
@Id
@GeneratedValue(strategy = GenerationType.TABLE, generator = "user_gen")
@TableGenerator(name = "user_gen", table = "id_generator", 
                pkColumnName = "gen_name", pkColumnValue = "user_id",
                valueColumnName = "gen_value", allocationSize = 1)
private Long id;

// UUIDç”Ÿæˆå™¨ï¼ˆä½¿ç”¨è‡ªå®šä¹‰ç”Ÿæˆå™¨ï¼‰
@Id
@GenericGenerator(name = "uuid", strategy = "uuid2")
@GeneratedValue(generator = "uuid")
@Column(columnDefinition = "VARCHAR(36)")
private String id;
```

### 2.2 å…³è”å…³ç³»æ˜ å°„

Hibernateèƒ½å¤Ÿå¤„ç†å„ç§ç±»å‹çš„å¯¹è±¡å…³ç³»æ˜ å°„ï¼ŒåŒ…æ‹¬ä¸€å¯¹ä¸€ã€ä¸€å¯¹å¤šã€å¤šå¯¹ä¸€å’Œå¤šå¯¹å¤šå…³ç³»ã€‚

#### 2.2.1 ä¸€å¯¹ä¸€å…³ç³»(One-to-One)

ä¸€å¯¹ä¸€å…³ç³»å¯ä»¥é€šè¿‡å¤–é”®æˆ–å…±äº«ä¸»é”®å®ç°ï¼š

```java
// åŸºäºå¤–é”®çš„ä¸€å¯¹ä¸€æ˜ å°„
@Entity
@Table(name = "users")
public class User {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    private String username;
    
    // ç”¨æˆ·å’Œç”¨æˆ·è¯¦æƒ…çš„ä¸€å¯¹ä¸€å…³ç³»
    @OneToOne(cascade = CascadeType.ALL, fetch = FetchType.LAZY)
    @JoinColumn(name = "profile_id")
    private UserProfile profile;
    
    // Getterså’ŒSettersçœç•¥...
}

@Entity
@Table(name = "user_profiles")
public class UserProfile {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    private String biography;
    private String avatarUrl;
    
    // åŒå‘å…³è”ï¼ˆå¯é€‰ï¼‰
    @OneToOne(mappedBy = "profile")
    private User user;
    
    // Getterså’ŒSettersçœç•¥...
}
```

#### 2.2.2 ä¸€å¯¹å¤š/å¤šå¯¹ä¸€å…³ç³»(One-to-Many/Many-to-One)

ä¸€å¯¹å¤šæ˜¯æœ€å¸¸è§çš„å…³è”å…³ç³»ï¼š

```java
// éƒ¨é—¨ä¸å‘˜å·¥çš„ä¸€å¯¹å¤šå…³ç³»
@Entity
@Table(name = "departments")
public class Department {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    private String name;
    
    // ä¸€ä¸ªéƒ¨é—¨æœ‰å¤šä¸ªå‘˜å·¥
    @OneToMany(mappedBy = "department", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<Employee> employees = new ArrayList<>();
    
    // ä¾¿æ·æ–¹æ³•ç®¡ç†å…³ç³»
    public void addEmployee(Employee employee) {
        employees.add(employee);
        employee.setDepartment(this);
    }
    
    public void removeEmployee(Employee employee) {
        employees.remove(employee);
        employee.setDepartment(null);
    }
    
    // Getterså’ŒSettersçœç•¥...
}

@Entity
@Table(name = "employees")
public class Employee {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    private String name;
    private String position;
    
    // å¤šä¸ªå‘˜å·¥å±äºä¸€ä¸ªéƒ¨é—¨
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "department_id")
    private Department department;
    
    // Getterså’ŒSettersçœç•¥...
}
```

#### 2.2.3 å¤šå¯¹å¤šå…³ç³»(Many-to-Many)

å¤šå¯¹å¤šå…³ç³»é€šå¸¸é€šè¿‡ä¸­é—´è¡¨å®ç°ï¼š

```java
// å­¦ç”Ÿå’Œè¯¾ç¨‹çš„å¤šå¯¹å¤šå…³ç³»
@Entity
@Table(name = "students")
public class Student {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    private String name;
    
    @ManyToMany(cascade = {CascadeType.PERSIST, CascadeType.MERGE})
    @JoinTable(
        name = "student_course", 
        joinColumns = @JoinColumn(name = "student_id"),
        inverseJoinColumns = @JoinColumn(name = "course_id")
    )
    private Set<Course> courses = new HashSet<>();
    
    // ä¾¿æ·æ–¹æ³•ç®¡ç†å…³ç³»
    public void addCourse(Course course) {
        courses.add(course);
        course.getStudents().add(this);
    }
    
    public void removeCourse(Course course) {
        courses.remove(course);
        course.getStudents().remove(this);
    }
    
    // Getterså’ŒSettersçœç•¥...
}

@Entity
@Table(name = "courses")
public class Course {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    private String name;
    private int credits;
    
    @ManyToMany(mappedBy = "courses")
    private Set<Student> students = new HashSet<>();
    
    // Getterså’ŒSettersçœç•¥...
}
```

#### 2.2.4 çº§è”æ“ä½œä¸å­¤å„¿åˆ é™¤

Hibernateé€šè¿‡çº§è”ï¼ˆCascadeï¼‰é€‰é¡¹æ§åˆ¶å…³è”å¯¹è±¡çš„æ“ä½œä¼ æ’­ï¼š

```java
// çº§è”æ‰€æœ‰æ“ä½œï¼ˆåˆ›å»ºã€æ›´æ–°ã€åˆ é™¤ç­‰ï¼‰
@OneToMany(mappedBy = "parent", cascade = CascadeType.ALL)

// çº§è”ç‰¹å®šæ“ä½œ
@OneToMany(mappedBy = "parent", 
           cascade = {CascadeType.PERSIST, CascadeType.MERGE})

// å­¤å„¿åˆ é™¤ï¼ˆå½“å­å¯¹è±¡ä¸å†è¢«å¼•ç”¨æ—¶è‡ªåŠ¨åˆ é™¤ï¼‰
@OneToMany(mappedBy = "parent", orphanRemoval = true)
```

ä¸»è¦çš„çº§è”é€‰é¡¹ï¼š
- **CascadeType.PERSIST**ï¼šçº§è”ä¿å­˜
- **CascadeType.MERGE**ï¼šçº§è”æ›´æ–°
- **CascadeType.REMOVE**ï¼šçº§è”åˆ é™¤
- **CascadeType.REFRESH**ï¼šçº§è”åˆ·æ–°
- **CascadeType.DETACH**ï¼šçº§è”è„±ç®¡
- **CascadeType.ALL**ï¼šåŒ…å«æ‰€æœ‰çº§è”æ“ä½œ

### 2.3 ç»§æ‰¿æ˜ å°„ç­–ç•¥

Hibernateæä¾›äº†å¤šç§å®ç°Javaç±»ç»§æ‰¿å…³ç³»çš„æ˜ å°„ç­–ç•¥ã€‚

#### 2.3.1 å•è¡¨ç­–ç•¥(Single Table)

å°†æ•´ä¸ªç»§æ‰¿å±‚æ¬¡ç»“æ„æ˜ å°„åˆ°å•ä¸ªæ•°æ®åº“è¡¨ï¼Œä½¿ç”¨åˆ¤åˆ«åˆ—åŒºåˆ†ä¸åŒç±»å‹ã€‚

```java
@Entity
@Inheritance(strategy = InheritanceType.SINGLE_TABLE)
@DiscriminatorColumn(name = "type")
public abstract class Payment {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    private BigDecimal amount;
    private LocalDateTime paymentDate;
    
    // Getterså’ŒSettersçœç•¥...
}

@Entity
@DiscriminatorValue("CC")
public class CreditCardPayment extends Payment {
    private String cardNumber;
    private String cardHolderName;
    private YearMonth expiryDate;
    
    // Getterså’ŒSettersçœç•¥...
}

@Entity
@DiscriminatorValue("BA")
public class BankAccountPayment extends Payment {
    private String accountNumber;
    private String bankName;
    private String swiftCode;
    
    // Getterså’ŒSettersçœç•¥...
}
```

**ä¼˜ç‚¹**ï¼š
- æŸ¥è¯¢æ•ˆç‡é«˜ï¼Œä¸éœ€è¦è”æ¥
- é€‚åˆç®€å•çš„ç»§æ‰¿å±‚æ¬¡ç»“æ„

**ç¼ºç‚¹**ï¼š
- å­ç±»ç‰¹æœ‰çš„å­—æ®µä¸èƒ½è®¾ä¸ºéç©º
- è¡¨å¯èƒ½åŒ…å«è®¸å¤šç©ºå€¼ï¼Œæµªè´¹ç©ºé—´

#### 2.3.2 è¿æ¥è¡¨ç­–ç•¥(Joined)

æ¯ä¸ªç±»éƒ½æœ‰è‡ªå·±çš„è¡¨ï¼Œå­ç±»è¡¨åªåŒ…å«ç‰¹æœ‰å±æ€§å’ŒæŒ‡å‘çˆ¶ç±»çš„å¤–é”®ã€‚

```java
@Entity
@Inheritance(strategy = InheritanceType.JOINED)
public abstract class Vehicle {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    private String manufacturer;
    private String model;
    private Integer yearOfManufacture;
    
    // Getterså’ŒSettersçœç•¥...
}

@Entity
@PrimaryKeyJoinColumn(name = "vehicle_id")
public class Car extends Vehicle {
    private Integer numberOfDoors;
    private Integer engineCapacity;
    
    // Getterså’ŒSettersçœç•¥...
}

@Entity
@PrimaryKeyJoinColumn(name = "vehicle_id")
public class Motorcycle extends Vehicle {
    private Boolean hasSideCar;
    
    // Getterså’ŒSettersçœç•¥...
}
```

**ä¼˜ç‚¹**ï¼š
- æ•°æ®å®Œæ•´æ€§æ›´å¥½ï¼Œå­ç±»ç‰¹æœ‰å­—æ®µå¯è®¾ä¸ºéç©º
- è¡¨ç»“æ„ç¬¦åˆè§„èŒƒåŒ–åŸåˆ™

**ç¼ºç‚¹**ï¼š
- æŸ¥è¯¢å­ç±»éœ€è¦è¿æ¥ï¼Œæ€§èƒ½è¾ƒä½
- æ’å…¥/æ›´æ–°éœ€è¦æ“ä½œå¤šå¼ è¡¨

#### 2.3.3 æ¯ä¸ªç±»ä¸€å¼ è¡¨ç­–ç•¥(Table Per Class)

æ¯ä¸ªå…·ä½“ç±»éƒ½æœ‰è‡ªå·±çš„è¡¨ï¼ŒåŒ…å«æ‰€æœ‰å±æ€§(åŒ…æ‹¬ç»§æ‰¿çš„å±æ€§)ã€‚

```java
@Entity
@Inheritance(strategy = InheritanceType.TABLE_PER_CLASS)
public abstract class Account {
    @Id
    @GeneratedValue(strategy = GenerationType.TABLE)
    private Long id;
    
    private String owner;
    private BigDecimal balance;
    
    // Getterså’ŒSettersçœç•¥...
}

@Entity
public class SavingsAccount extends Account {
    private Double interestRate;
    
    // Getterså’ŒSettersçœç•¥...
}

@Entity
public class CheckingAccount extends Account {
    private BigDecimal overdraftLimit;
    
    // Getterså’ŒSettersçœç•¥...
}
```

**ä¼˜ç‚¹**ï¼š
- æ¯ä¸ªè¡¨æ˜¯å®Œå…¨ç‹¬ç«‹çš„ï¼Œè¡¨ç»“æ„ç›´è§‚
- å­ç±»ç‰¹æœ‰å­—æ®µå¯è®¾ä¸ºéç©º

**ç¼ºç‚¹**ï¼š
- å¤šæ€æŸ¥è¯¢æ€§èƒ½å·®
- å¯èƒ½å¯¼è‡´æ•°æ®é‡å¤
- ä¸»é”®ç”Ÿæˆç­–ç•¥å—é™ 

## 3. Hibernateæ ¸å¿ƒAPIä¸æ“ä½œ

### 3.1 SessionFactory

`SessionFactory`æ˜¯Hibernateçš„æ ¸å¿ƒæ¥å£ä¹‹ä¸€ï¼Œå®ƒæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œé€šå¸¸åœ¨åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶åˆ›å»ºä¸€æ¬¡ï¼Œå¹¶åœ¨æ•´ä¸ªåº”ç”¨ç¨‹åºç”Ÿå‘½å‘¨æœŸä¸­å…±äº«ä½¿ç”¨ã€‚

ä¸»è¦åŠŸèƒ½ï¼š
- åˆ›å»ºSessionå®ä¾‹
- ä¿å­˜æ•°æ®åº“è¿æ¥é…ç½®
- ç»´æŠ¤äºŒçº§ç¼“å­˜
- ä¿å­˜æ˜ å°„å…ƒæ•°æ®

```java
// åˆ›å»ºSessionFactory
StandardServiceRegistry registry = new StandardServiceRegistryBuilder()
        .configure() // ä»hibernate.cfg.xmlåŠ è½½è®¾ç½®
        .build();
SessionFactory sessionFactory = new MetadataSources(registry)
        .buildMetadata()
        .buildSessionFactory();

// è·å–Session
Session session = sessionFactory.openSession();

// è·å–å½“å‰Sessionï¼ˆå¦‚æœé…ç½®äº†å½“å‰Sessionä¸Šä¸‹æ–‡ï¼‰
Session currentSession = sessionFactory.getCurrentSession();

// åº”ç”¨å…³é—­æ—¶é‡Šæ”¾èµ„æº
sessionFactory.close();
```

### 3.2 Session

`Session`æ˜¯Hibernateçš„ä¸»è¦å·¥ä½œæ¥å£ï¼Œä»£è¡¨ä¸æ•°æ®åº“çš„ä¸€æ¬¡ä¼šè¯ã€‚å®ƒæ˜¯ä¸€ä¸ªè½»é‡çº§ã€éçº¿ç¨‹å®‰å…¨çš„å¯¹è±¡ï¼Œé€šå¸¸åœ¨æ‰§è¡Œä¸€ç»„æ“ä½œæ—¶åˆ›å»ºï¼Œå®Œæˆåå…³é—­ã€‚

#### 3.2.1 åŸºæœ¬CRUDæ“ä½œ

```java
// å¼€å¯ä¼šè¯
Session session = sessionFactory.openSession();
Transaction tx = null;

try {
    // å¼€å§‹äº‹åŠ¡
    tx = session.beginTransaction();
    
    // åˆ›å»º(Create)
    User newUser = new User("ç‹äº”", "wangwu@example.com");
    Long userId = (Long) session.save(newUser);
    
    // è¯»å–(Read)
    User user = session.get(User.class, userId);
    // æˆ–ä½¿ç”¨loadæ–¹æ³•ï¼ˆè¿”å›ä»£ç†å¯¹è±¡ï¼Œå¯èƒ½è§¦å‘æ‡’åŠ è½½ï¼‰
    User lazyUser = session.load(User.class, userId);
    
    // æ›´æ–°(Update)
    user.setEmail("wangwu_new@example.com");
    session.update(user);
    // æˆ–ä½¿ç”¨saveOrUpdateæ–¹æ³•ï¼ˆè‡ªåŠ¨åˆ¤æ–­æ˜¯ä¿å­˜è¿˜æ˜¯æ›´æ–°ï¼‰
    user.setName("ç‹äº”(å·²æ›´æ–°)");
    session.saveOrUpdate(user);
    
    // åˆ é™¤(Delete)
    session.delete(user);
    
    // æäº¤äº‹åŠ¡
    tx.commit();
} catch (Exception e) {
    // å›æ»šäº‹åŠ¡
    if (tx != null) tx.rollback();
    e.printStackTrace();
} finally {
    // å…³é—­ä¼šè¯
    session.close();
}
```

#### 3.2.2 æ‰¹é‡æ“ä½œ

ä¸ºæé«˜æ€§èƒ½ï¼ŒHibernateæ”¯æŒæ‰¹é‡å¤„ç†ï¼š

```java
Session session = sessionFactory.openSession();
Transaction tx = session.beginTransaction();

try {
    // è®¾ç½®JDBCæ‰¹å¤„ç†å¤§å°
    session.setJdbcBatchSize(20);
    
    // æ‰¹é‡æ’å…¥
    for (int i = 0; i < 100; i++) {
        User user = new User("ç”¨æˆ·" + i, "user" + i + "@example.com");
        session.save(user);
        
        // æ¯20æ¡æ¸…ç†ç¼“å­˜ï¼Œé¿å…å†…å­˜æº¢å‡º
        if (i > 0 && i % 20 == 0) {
            session.flush();
            session.clear();
        }
    }
    
    tx.commit();
} catch (Exception e) {
    tx.rollback();
    throw e;
} finally {
    session.close();
}
```

#### 3.2.3 åˆ·æ–°ä¸æ¸…ç†

```java
// åˆ·æ–°ï¼šå°†Sessionç¼“å­˜ä¸­çš„å˜æ›´åŒæ­¥åˆ°æ•°æ®åº“
session.flush();

// åˆ·æ–°ç‰¹å®šå®ä½“ï¼šä»æ•°æ®åº“é‡æ–°åŠ è½½å®ä½“æ•°æ®
session.refresh(user);

// æ¸…ç†Sessionç¼“å­˜
session.clear();

// ä»Sessionç¼“å­˜ä¸­ç§»é™¤ç‰¹å®šå®ä½“
session.evict(user);
```

### 3.3 äº‹åŠ¡ç®¡ç†

Hibernateæ”¯æŒå¤šç§äº‹åŠ¡ç®¡ç†æ–¹å¼ï¼ŒåŒ…æ‹¬æœ¬åœ°äº‹åŠ¡å’ŒJTAäº‹åŠ¡ã€‚

#### 3.3.1 æœ¬åœ°äº‹åŠ¡

```java
Session session = sessionFactory.openSession();
Transaction tx = null;

try {
    tx = session.beginTransaction();
    
    // ä¸šåŠ¡æ“ä½œ...
    
    // æäº¤äº‹åŠ¡
    tx.commit();
} catch (Exception e) {
    // å›æ»šäº‹åŠ¡
    if (tx != null) tx.rollback();
    throw e;
} finally {
    session.close();
}
```

#### 3.3.2 ä½¿ç”¨å½“å‰Sessionå’Œäº‹åŠ¡

å½“é…ç½®äº†`hibernate.current_session_context_class`ä¸º`thread`æˆ–`jta`æ—¶ï¼Œå¯ä»¥ä½¿ç”¨å½“å‰Sessionï¼š

```java
// ä½¿ç”¨çº¿ç¨‹ç»‘å®šçš„å½“å‰Session
Session session = sessionFactory.getCurrentSession();
session.beginTransaction();

try {
    // ä¸šåŠ¡æ“ä½œ...
    
    // æäº¤äº‹åŠ¡
    session.getTransaction().commit();
} catch (Exception e) {
    // å›æ»šäº‹åŠ¡
    session.getTransaction().rollback();
    throw e;
    // æ³¨æ„ï¼šä½¿ç”¨getCurrentSession()æ—¶ï¼Œäº‹åŠ¡æäº¤æˆ–å›æ»šåSessionä¼šè‡ªåŠ¨å…³é—­
}
```

#### 3.3.3 äº‹åŠ¡éš”ç¦»çº§åˆ«

Hibernateå…è®¸è®¾ç½®äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼š

```java
// åœ¨é…ç½®ä¸­è®¾ç½®
cfg.setProperty("hibernate.connection.isolation", "2"); // READ_COMMITTED

// æˆ–åœ¨è·å–è¿æ¥æ—¶è®¾ç½®
session.doWork(connection -> {
    connection.setTransactionIsolation(Connection.TRANSACTION_SERIALIZABLE);
});
```

### 3.4 æŸ¥è¯¢æ–¹å¼

Hibernateæä¾›äº†å¤šç§æŸ¥è¯¢æ•°æ®çš„APIï¼Œæ¯ç§éƒ½æœ‰å„è‡ªçš„ä¼˜ç¼ºç‚¹ã€‚

<Tabs>
<TabItem value="hql" label="HQL">

```java
// åŸºæœ¬HQLæŸ¥è¯¢
String hql = "FROM User u WHERE u.email LIKE :pattern ORDER BY u.name";
List<User> users = session.createQuery(hql, User.class)
        .setParameter("pattern", "%@gmail.com")
        .list();

// åˆ†é¡µæŸ¥è¯¢
List<User> pagedUsers = session.createQuery("FROM User", User.class)
        .setFirstResult(0)    // èµ·å§‹ä½ç½®ï¼ˆ0ä¸ºç¬¬ä¸€æ¡ï¼‰
        .setMaxResults(20)    // æ¯é¡µè®°å½•æ•°
        .list();

// èšåˆå‡½æ•°
Long count = (Long) session.createQuery("SELECT COUNT(u) FROM User u")
        .uniqueResult();

// è¿æ¥æŸ¥è¯¢
String joinHql = "SELECT u, o FROM User u JOIN u.orders o WHERE o.status = :status";
List<Object[]> userOrders = session.createQuery(joinHql)
        .setParameter("status", OrderStatus.COMPLETED)
        .list();
for (Object[] result : userOrders) {
    User user = (User) result[0];
    Order order = (Order) result[1];
    // å¤„ç†ç»“æœ...
}

// å‘½åæŸ¥è¯¢ï¼ˆåœ¨å®ä½“ç±»ä¸Šå®šä¹‰ï¼‰
List<User> activeUsers = session.createNamedQuery("User.findActive", User.class)
        .setMaxResults(10)
        .list();
```

</TabItem>
<TabItem value="criteria" label="Criteria API">

```java
// JPA Criteria API
CriteriaBuilder builder = session.getCriteriaBuilder();
CriteriaQuery<User> query = builder.createQuery(User.class);
Root<User> root = query.from(User.class);

// æ„å»ºæ¡ä»¶
query.select(root)
     .where(
         builder.and(
             builder.equal(root.get("status"), UserStatus.ACTIVE),
             builder.greaterThan(root.get("registrationDate"), LocalDate.now().minusDays(30))
         )
     )
     .orderBy(builder.desc(root.get("lastLoginTime")));

// æ‰§è¡ŒæŸ¥è¯¢
List<User> recentActiveUsers = session.createQuery(query).getResultList();

// å¤æ‚æ¡ä»¶ç¤ºä¾‹
CriteriaBuilder cb = session.getCriteriaBuilder();
CriteriaQuery<User> criteriaQuery = cb.createQuery(User.class);
Root<User> userRoot = criteriaQuery.from(User.class);

// è¿æ¥
Join<User, Order> orderJoin = userRoot.join("orders", JoinType.LEFT);

// å­æŸ¥è¯¢
Subquery<Long> subquery = criteriaQuery.subquery(Long.class);
Root<Order> subRoot = subquery.from(Order.class);
subquery.select(cb.count(subRoot))
        .where(cb.equal(subRoot.get("user"), userRoot));

// ç»„åˆæ¡ä»¶
Predicate conditions = cb.and(
    cb.like(userRoot.get("email"), "%.com"),
    cb.greaterThanOrEqualTo(subquery, 1L)
);

criteriaQuery.select(userRoot).where(conditions);
List<User> usersWithOrders = session.createQuery(criteriaQuery).getResultList();
```

</TabItem>
<TabItem value="native" label="åŸç”ŸSQL">

```java
// åŸç”ŸSQLæŸ¥è¯¢
String sql = "SELECT * FROM users WHERE registration_date > :date";
List<User> newUsers = session.createNativeQuery(sql, User.class)
        .setParameter("date", java.sql.Date.valueOf(LocalDate.now().minusDays(7)))
        .list();

// åŸç”ŸSQLæŸ¥è¯¢è¿”å›éå®ä½“ç»“æœ
String sqlReport = "SELECT u.name, COUNT(o.id) as order_count, SUM(o.total) as total_amount " +
                  "FROM users u LEFT JOIN orders o ON u.id = o.user_id " +
                  "GROUP BY u.id";
List<Object[]> reportData = session.createNativeQuery(sqlReport)
        .list();
for (Object[] row : reportData) {
    String name = (String) row[0];
    Long orderCount = ((Number) row[1]).longValue();
    BigDecimal totalAmount = (BigDecimal) row[2];
    // å¤„ç†ç»“æœ...
}

// æ˜ å°„åŸç”ŸSQLç»“æœåˆ°DTO
String sqlQuery = "SELECT u.id as user_id, u.name as user_name, " +
                  "COUNT(o.id) as order_count " +
                  "FROM users u LEFT JOIN orders o ON u.id = o.user_id " +
                  "GROUP BY u.id";
List<UserStatsDTO> stats = session.createNativeQuery(sqlQuery)
        .setResultTransformer(Transformers.aliasToBean(UserStatsDTO.class))
        .list();
```

</TabItem>
<TabItem value="queryDSL" label="QueryDSL">

```java
// ä½¿ç”¨QueryDSLï¼ˆéœ€è¦é¢å¤–ä¾èµ–ï¼‰
JPAQuery<User> query = new JPAQuery<>(session);
QUser user = QUser.user;
QOrder order = QOrder.order;

List<User> premiumUsers = query
        .select(user)
        .from(user)
        .leftJoin(user.orders, order)
        .where(user.type.eq(UserType.PREMIUM)
            .and(order.total.gt(new BigDecimal("1000"))))
        .orderBy(user.name.asc())
        .fetch();
```

</TabItem>
</Tabs>

### 3.5 é”å®šç­–ç•¥

Hibernateæä¾›äº†å¤šç§é”å®šç­–ç•¥ä»¥æ”¯æŒå¹¶å‘è®¿é—®æ§åˆ¶ï¼š

#### 3.5.1 æ‚²è§‚é”

æ‚²è§‚é”é€šè¿‡æ•°æ®åº“é”æœºåˆ¶å®ç°ï¼Œé€‚ç”¨äºé«˜å¹¶å‘åœºæ™¯ã€‚

```java
// ä½¿ç”¨LockModeæšä¸¾
User user = session.get(User.class, userId, LockMode.PESSIMISTIC_WRITE);

// åœ¨HQLä¸­ä½¿ç”¨é”
List<Product> products = session.createQuery("FROM Product p WHERE p.stock > 0", Product.class)
        .setLockMode(LockModeType.PESSIMISTIC_WRITE)
        .list();

// JPAé”å®šæ¨¡å¼
session.find(Order.class, orderId, LockModeType.PESSIMISTIC_READ);
```

#### 3.5.2 ä¹è§‚é”

ä¹è§‚é”é€šè¿‡ç‰ˆæœ¬æ£€æŸ¥å®ç°ï¼Œé€‚ç”¨äºå¹¶å‘å†²çªè¾ƒå°‘çš„åœºæ™¯ã€‚

```java
@Entity
public class Product {
    @Id
    private Long id;
    
    private String name;
    private BigDecimal price;
    
    @Version  // ç‰ˆæœ¬å­—æ®µï¼Œè‡ªåŠ¨å¤„ç†ä¹è§‚é”
    private Integer version;
    
    // ...
}
```

#### 3.5.3 è‡ªç„¶é”

åˆ©ç”¨æ•°æ®åº“äº‹åŠ¡éš”ç¦»çº§åˆ«æä¾›çš„é”å®šè¡Œä¸ºã€‚

```java
// å¼€å§‹äº‹åŠ¡
Transaction tx = session.beginTransaction();

// åœ¨READ_COMMITTEDæˆ–æ›´é«˜éš”ç¦»çº§åˆ«ä¸‹ï¼Œæ›´æ–°æ“ä½œä¼šè·å–è¡Œé”
Product product = session.get(Product.class, productId);
product.setStock(product.getStock() - 1);
session.update(product);

// æäº¤äº‹åŠ¡å¹¶é‡Šæ”¾é”
tx.commit();
```

### 3.6 æ‰¹é‡å¤„ç†ä¸æ€§èƒ½ä¼˜åŒ–

#### 3.6.1 æ‰¹é‡æ’å…¥å’Œæ›´æ–°

```java
Session session = sessionFactory.openSession();
Transaction tx = session.beginTransaction();

try {
    int batchSize = 30;
    
    for (int i = 0; i < 1000; i++) {
        Product product = new Product();
        product.setName("Product " + i);
        product.setPrice(new BigDecimal(random.nextDouble() * 100));
        session.save(product);
        
        // æ¯batchSizeæ¡è®°å½•åˆ·æ–°ä¸€æ¬¡ä¼šè¯å¹¶æ¸…ç†ç¼“å­˜
        if (i > 0 && i % batchSize == 0) {
            session.flush();
            session.clear();
            System.out.println("Batch " + (i / batchSize) + " completed");
        }
    }
    
    tx.commit();
} catch (Exception e) {
    if (tx != null) tx.rollback();
    throw e;
} finally {
    session.close();
}
```

#### 3.6.2 æ‰¹é‡HQLæ“ä½œ

```java
// æ‰¹é‡æ›´æ–°
int updatedEntities = session.createQuery(
        "UPDATE User SET status = :newStatus WHERE lastLoginDate < :date")
        .setParameter("newStatus", UserStatus.INACTIVE)
        .setParameter("date", LocalDate.now().minusMonths(6))
        .executeUpdate();

// æ‰¹é‡åˆ é™¤
int deletedEntities = session.createQuery(
        "DELETE FROM TempData WHERE creationDate < :date")
        .setParameter("date", LocalDate.now().minusDays(7))
        .executeUpdate();

// æ³¨æ„ï¼šæ‰¹é‡æ“ä½œä¼šç»•è¿‡Sessionç¼“å­˜å’Œç”Ÿå‘½å‘¨æœŸäº‹ä»¶
```

#### 3.6.3 StatelessSession

å¯¹äºå¤§æ‰¹é‡æ“ä½œï¼Œå¯ä»¥ä½¿ç”¨`StatelessSession`ä»¥è·å¾—æ›´å¥½çš„æ€§èƒ½ï¼š

```java
StatelessSession statelessSession = sessionFactory.openStatelessSession();
Transaction tx = statelessSession.beginTransaction();

try {
    ScrollableResults scrollableResults = statelessSession.createQuery(
            "FROM LargeEntity")
            .scroll(ScrollMode.FORWARD_ONLY);
    
    int count = 0;
    while (scrollableResults.next()) {
        LargeEntity entity = (LargeEntity) scrollableResults.get(0);
        // å¤„ç†å®ä½“
        entity.setProcessed(true);
        statelessSession.update(entity);
        
        if (++count % 100 == 0) {
            // å®šæœŸæäº¤ä»¥é‡Šæ”¾å†…å­˜
            tx.commit();
            tx = statelessSession.beginTransaction();
        }
    }
    
    tx.commit();
} catch (Exception e) {
    if (tx != null) tx.rollback();
    throw e;
} finally {
    statelessSession.close();
}
```

**StatelessSessionç‰¹ç‚¹**ï¼š
- ä¸ç»´æŠ¤ä¸€çº§ç¼“å­˜
- ä¸è¿›è¡Œè„æ£€æŸ¥
- ä¸çº§è”æ“ä½œ
- ä¸ç®¡ç†åŒå‘å…³ç³»
- ç›´æ¥æ“ä½œæ•°æ®åº“ï¼Œç»•è¿‡ç”Ÿå‘½å‘¨æœŸå›è°ƒ 

## 4. Hibernateç¼“å­˜æœºåˆ¶

Hibernateæä¾›äº†å¤æ‚è€Œå¼ºå¤§çš„å¤šçº§ç¼“å­˜ç³»ç»Ÿï¼Œé€šè¿‡åˆç†é…ç½®ç¼“å­˜å¯ä»¥æ˜¾è‘—æå‡åº”ç”¨ç¨‹åºæ€§èƒ½ã€‚

### 4.1 ä¸€çº§ç¼“å­˜ï¼ˆSessionç¼“å­˜ï¼‰

Sessionçº§åˆ«çš„ç¼“å­˜æ˜¯Hibernateçš„æ ¸å¿ƒç‰¹æ€§ï¼Œå§‹ç»ˆå¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œæ— æ³•ç¦ç”¨ã€‚

ç‰¹ç‚¹ï¼š
- ä½œç”¨åŸŸé™äºå•ä¸ªSession
- è‡ªåŠ¨ç®¡ç†ï¼Œä¸éœ€è¦æ˜¾å¼é…ç½®
- åŒä¸€Sessionä¸­é‡å¤è·å–ç›¸åŒå¯¹è±¡æ—¶ï¼Œç›´æ¥ä»ç¼“å­˜è¿”å›
- äº‹åŠ¡æäº¤æˆ–Sessionå…³é—­æ—¶å¤±æ•ˆ

```java
Session session = sessionFactory.openSession();

// ç¬¬ä¸€æ¬¡æŸ¥è¯¢ï¼Œä»æ•°æ®åº“åŠ è½½
User user1 = session.get(User.class, 1L); // æ‰§è¡ŒSQLæŸ¥è¯¢

// ç¬¬äºŒæ¬¡æŸ¥è¯¢ç›¸åŒIDï¼Œç›´æ¥ä»ä¸€çº§ç¼“å­˜è¿”å›
User user2 = session.get(User.class, 1L); // ä¸æ‰§è¡ŒSQLæŸ¥è¯¢

// user1å’Œuser2æ˜¯åŒä¸€ä¸ªå¯¹è±¡å®ä¾‹
System.out.println(user1 == user2); // è¾“å‡ºtrue

session.close();
```

ä¸€çº§ç¼“å­˜ç®¡ç†æ“ä½œï¼š

```java
// æ¸…é™¤ç‰¹å®šå®ä½“çš„ç¼“å­˜
session.evict(user);

// æ¸…é™¤æ‰€æœ‰ç¼“å­˜
session.clear();

// å°†ç¼“å­˜ä¸­çš„ä¿®æ”¹ç«‹å³åŒæ­¥åˆ°æ•°æ®åº“
session.flush();

// ä»æ•°æ®åº“é‡æ–°åŠ è½½å®ä½“ï¼Œæ›´æ–°ç¼“å­˜
session.refresh(user);
```

### 4.2 äºŒçº§ç¼“å­˜ï¼ˆSessionFactoryç¼“å­˜ï¼‰

SessionFactoryçº§åˆ«çš„ç¼“å­˜åœ¨æ‰€æœ‰Sessionä¹‹é—´å…±äº«ï¼Œèƒ½å¤Ÿæ˜¾è‘—å‡å°‘æ•°æ®åº“è®¿é—®ï¼Œä½†éœ€è¦è°¨æ…é…ç½®ä»¥ç¡®ä¿æ•°æ®ä¸€è‡´æ€§ã€‚

#### 4.2.1 äºŒçº§ç¼“å­˜æ¶æ„

![HibernateäºŒçº§ç¼“å­˜](https://hibernate.org/images/hibernate_cache.png)

#### 4.2.2 å¯ç”¨äºŒçº§ç¼“å­˜

**Mavenä¾èµ–**ï¼š

```xml
<!-- JCache API -->
<dependency>
    <groupId>javax.cache</groupId>
    <artifactId>cache-api</artifactId>
    <version>1.1.1</version>
</dependency>

<!-- EhCacheå®ç° -->
<dependency>
    <groupId>org.ehcache</groupId>
    <artifactId>ehcache</artifactId>
    <version>3.9.9</version>
</dependency>

<!-- Hibernate EhCacheé›†æˆ -->
<dependency>
    <groupId>org.hibernate</groupId>
    <artifactId>hibernate-jcache</artifactId>
    <version>5.6.15.Final</version>
</dependency>
```

**XMLé…ç½®**ï¼š

```xml
<property name="hibernate.cache.use_second_level_cache">true</property>
<property name="hibernate.cache.region.factory_class">org.hibernate.cache.jcache.JCacheRegionFactory</property>
<property name="hibernate.javax.cache.provider">org.ehcache.jsr107.EhcacheCachingProvider</property>
<property name="hibernate.cache.use_query_cache">true</property>
```

**Javaä»£ç é…ç½®**ï¼š

```java
StandardServiceRegistryBuilder registryBuilder = new StandardServiceRegistryBuilder()
    .configure()
    .applySetting("hibernate.cache.use_second_level_cache", "true")
    .applySetting("hibernate.cache.region.factory_class", "org.hibernate.cache.jcache.JCacheRegionFactory")
    .applySetting("hibernate.javax.cache.provider", "org.ehcache.jsr107.EhcacheCachingProvider")
    .applySetting("hibernate.javax.cache.uri", "classpath:ehcache.xml");
```

#### 4.2.3 é…ç½®å®ä½“ç¼“å­˜

å®ä½“ç±»çº§åˆ«é…ç½®ï¼š

```java
@Entity
@Cacheable
@org.hibernate.annotations.Cache(
    usage = CacheConcurrencyStrategy.READ_WRITE,
    region = "userCache"
)
public class User {
    // å®ä½“å±æ€§
}

// é›†åˆç¼“å­˜
@Entity
public class Department {
    // ...
    
    @OneToMany(mappedBy = "department")
    @org.hibernate.annotations.Cache(
        usage = CacheConcurrencyStrategy.READ_WRITE,
        region = "departmentEmployeesCache"
    )
    private Set<Employee> employees = new HashSet<>();
}
```

ä¸åŒçš„ç¼“å­˜å¹¶å‘ç­–ç•¥ï¼š

| ç­–ç•¥ | æè¿° | é€‚ç”¨åœºæ™¯ |
|------|------|---------|
| **READ_ONLY** | åªè¯»è®¿é—®ï¼Œä¸å…è®¸æ›´æ–° | é™æ€æ•°æ®ï¼Œå¦‚å‚è€ƒæ•°æ®ã€é…ç½®æ•°æ® |
| **NONSTRICT_READ_WRITE** | éä¸¥æ ¼è¯»å†™ï¼Œé€‚åˆå¶å°”æ›´æ–° | å¾ˆå°‘æ›´æ–°çš„æ•°æ®ï¼Œå¯æ¥å—çŸ­æš‚çš„ä¸ä¸€è‡´ |
| **READ_WRITE** | è¯»å†™è®¿é—®ï¼Œä½¿ç”¨è½¯é”ä¿è¯ä¸€è‡´æ€§ | é¢‘ç¹è¯»å–ã€å¶å°”æ›´æ–°çš„æ•°æ® |
| **TRANSACTIONAL** | æ”¯æŒäº‹åŠ¡ï¼Œå¼ºä¸€è‡´æ€§ | éœ€è¦JTAå…¼å®¹ç¼“å­˜å®ç°ï¼Œå¦‚åº”ç”¨äºé›†ç¾¤ç¯å¢ƒ |

#### 4.2.4 æŸ¥è¯¢ç¼“å­˜

é’ˆå¯¹æŸ¥è¯¢ç»“æœçš„ç¼“å­˜ï¼š

```java
// å¯ç”¨ç‰¹å®šæŸ¥è¯¢çš„ç¼“å­˜
List<Product> products = session.createQuery("FROM Product p WHERE p.category = :category", Product.class)
        .setParameter("category", "Electronics")
        .setCacheable(true)          // å¯ç”¨æŸ¥è¯¢ç¼“å­˜
        .setCacheRegion("productsByCategory")  // æŒ‡å®šç¼“å­˜åŒºåŸŸ
        .list();
```

æ³¨æ„ï¼š
- æŸ¥è¯¢ç¼“å­˜åªç¼“å­˜IDåˆ—è¡¨ï¼Œå®é™…å®ä½“ä»éœ€ä»äºŒçº§ç¼“å­˜æˆ–æ•°æ®åº“è·å–
- å½“ç›¸å…³è¡¨æœ‰æ›´æ–°æ—¶ï¼Œç¼“å­˜ä¼šè‡ªåŠ¨å¤±æ•ˆ
- æŸ¥è¯¢ç¼“å­˜é€‚ç”¨äºé‡å¤æ‰§è¡Œçš„å‚æ•°åŒ–æŸ¥è¯¢

#### 4.2.5 ç¼“å­˜å¤±æ•ˆå’Œç®¡ç†

```java
// è·å–ç¼“å­˜å·¥å‚
SessionFactory sessionFactory = // ...
Cache cache = sessionFactory.getCache();

// æ¸…é™¤ç‰¹å®šå®ä½“ç±»çš„ç¼“å­˜
cache.evictEntityRegion(User.class);

// æ¸…é™¤ç‰¹å®šå®ä½“å®ä¾‹çš„ç¼“å­˜
cache.evictEntity(User.class, userId);

// æ¸…é™¤ç‰¹å®šé›†åˆç¼“å­˜
cache.evictCollection("com.example.Department.employees", departmentId);

// æ¸…é™¤æŸ¥è¯¢ç¼“å­˜åŒºåŸŸ
cache.evictQueryRegion("productsByCategory");

// æ¸…é™¤æ‰€æœ‰æ•°æ®
cache.evictAllRegions();
```

#### 4.2.6 è‡ªå®šä¹‰ç¼“å­˜é…ç½®

EhCacheé…ç½®æ–‡ä»¶ï¼ˆehcache.xmlï¼‰ï¼š

```xml
<config xmlns='http://www.ehcache.org/v3'>
    <!-- é»˜è®¤ç¼“å­˜é…ç½® -->
    <cache-template name="defaultTemplate">
        <expiry>
            <ttl unit="minutes">30</ttl>
        </expiry>
        <resources>
            <heap>1000</heap>
            <offheap unit="MB">10</offheap>
        </resources>
    </cache-template>
    
    <!-- å®ä½“ç¼“å­˜åŒºåŸŸ -->
    <cache alias="userCache" uses-template="defaultTemplate">
        <expiry>
            <ttl unit="minutes">60</ttl>
        </expiry>
        <resources>
            <heap>2000</heap>
        </resources>
    </cache>
    
    <!-- é›†åˆç¼“å­˜åŒºåŸŸ -->
    <cache alias="departmentEmployeesCache" uses-template="defaultTemplate">
        <resources>
            <heap>500</heap>
        </resources>
    </cache>
    
    <!-- æŸ¥è¯¢ç¼“å­˜åŒºåŸŸ -->
    <cache alias="productsByCategory" uses-template="defaultTemplate">
        <expiry>
            <ttl unit="minutes">15</ttl>
        </expiry>
    </cache>
</config>
```

Javaä¸­åŠ è½½ç¼“å­˜é…ç½®ï¼š

```java
Properties properties = new Properties();
properties.put("hibernate.cache.use_second_level_cache", "true");
properties.put("hibernate.cache.region.factory_class", "org.hibernate.cache.jcache.JCacheRegionFactory");
properties.put("hibernate.javax.cache.provider", "org.ehcache.jsr107.EhcacheCachingProvider");
properties.put("hibernate.javax.cache.uri", "classpath:ehcache.xml");
```

### 4.3 ç¼“å­˜æœ€ä½³å®è·µ

1. **é€‰æ‹©æ€§ç¼“å­˜**ï¼šåªç¼“å­˜é¢‘ç¹è®¿é—®ä¸”å¾ˆå°‘ä¿®æ”¹çš„æ•°æ®
2. **åˆç†çš„ç¼“å­˜ç­–ç•¥**ï¼šæ ¹æ®æ•°æ®çš„ä½¿ç”¨æ¨¡å¼é€‰æ‹©é€‚å½“çš„ç¼“å­˜å¹¶å‘ç­–ç•¥
3. **ç›‘æ§ç¼“å­˜æ€§èƒ½**ï¼šä½¿ç”¨å·¥å…·ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡ï¼ŒåŠæ—¶è°ƒæ•´ç¼“å­˜é…ç½®
4. **åˆç†è®¾ç½®ç¼“å­˜å¤§å°**ï¼šé¿å…ç¼“å­˜è¿‡å¤§å¯¼è‡´å†…å­˜å‹åŠ›
5. **è®¾ç½®é€‚å½“çš„TTL**ï¼šä¸ºç¼“å­˜æ¡ç›®è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´
6. **åˆ†å¸ƒå¼ç¯å¢ƒæ³¨æ„äº‹é¡¹**ï¼šåœ¨é›†ç¾¤ç¯å¢ƒä¸­ä½¿ç”¨åˆ†å¸ƒå¼ç¼“å­˜æˆ–ç¼“å­˜åŒæ­¥æœºåˆ¶
7. **é¿å…ç¼“å­˜å¤§ç»“æœé›†**ï¼šä¸è¦ç¼“å­˜åŒ…å«å¤§é‡æ•°æ®çš„æŸ¥è¯¢ç»“æœ

## 5. ä¸Spring Booté›†æˆ

Hibernateå¯ä»¥æ— ç¼é›†æˆåˆ°Spring Bootåº”ç”¨ç¨‹åºä¸­ï¼Œæˆä¸ºSpring Data JPAçš„åº•å±‚å®ç°ã€‚

### 5.1 åŸºæœ¬é›†æˆ

#### 5.1.1 æ·»åŠ ä¾èµ–

```xml
<!-- Spring Boot Starter Data JPA è‡ªåŠ¨åŒ…å«Hibernate -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-jpa</artifactId>
</dependency>

<!-- æ•°æ®åº“é©±åŠ¨ -->
<dependency>
    <groupId>mysql</groupId>
    <artifactId>mysql-connector-java</artifactId>
</dependency>
```

#### 5.1.2 é…ç½®æ•°æ®æºå’ŒJPAå±æ€§

application.yml:

```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/testdb?useSSL=false&serverTimezone=UTC
    username: root
    password: password
    driver-class-name: com.mysql.cj.jdbc.Driver
  
  jpa:
    hibernate:
      ddl-auto: update
    show-sql: true
    properties:
      hibernate:
        dialect: org.hibernate.dialect.MySQL8Dialect
        format_sql: true
        # äºŒçº§ç¼“å­˜é…ç½®
        cache:
          use_second_level_cache: true
          region.factory_class: org.hibernate.cache.jcache.JCacheRegionFactory
          use_query_cache: true
        javax.cache.provider: org.ehcache.jsr107.EhcacheCachingProvider
```

#### 5.1.3 åˆ›å»ºå®ä½“ç±»

```java
@Entity
@Table(name = "users")
@Cacheable
@org.hibernate.annotations.Cache(usage = CacheConcurrencyStrategy.READ_WRITE)
public class User {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(nullable = false)
    private String username;
    
    @Email
    @Column(unique = true)
    private String email;
    
    @CreationTimestamp
    private LocalDateTime createdAt;
    
    @UpdateTimestamp
    private LocalDateTime updatedAt;
    
    // Gettersã€Settersã€æ„é€ å‡½æ•°...
}
```

#### 5.1.4 åˆ›å»ºRepository

```java
public interface UserRepository extends JpaRepository<User, Long> {
    
    List<User> findByEmailContaining(String emailPattern);
    
    @Query("FROM User u WHERE u.createdAt > :date")
    List<User> findRecentUsers(@Param("date") LocalDateTime date);
    
    @Modifying
    @Query("UPDATE User u SET u.active = false WHERE u.lastLogin < :date")
    int deactivateInactiveUsers(@Param("date") LocalDateTime date);
}
```

### 5.2 é«˜çº§é…ç½®

#### 5.2.1 è‡ªå®šä¹‰EntityManager

```java
@Configuration
public class JpaConfig {
    
    @PersistenceContext
    private EntityManager entityManager;
    
    @Bean
    public SessionFactory hibernateSessionFactory() {
        if (entityManager == null || 
            !(entityManager.getDelegate() instanceof Session)) {
            throw new IllegalStateException("EntityManagerä¸æ˜¯Hibernateå®ç°");
        }
        
        return entityManager.unwrap(Session.class).getSessionFactory();
    }
}
```

#### 5.2.2 ä½¿ç”¨åŸç”ŸHibernate API

```java
@Service
public class ProductService {
    
    @PersistenceContext
    private EntityManager entityManager;
    
    // ä½¿ç”¨Hibernate Session
    public void processLargeDataSet() {
        Session session = entityManager.unwrap(Session.class);
        
        // ä½¿ç”¨StatelessSessionè¿›è¡Œæ‰¹å¤„ç†
        StatelessSession statelessSession = session.getSessionFactory().openStatelessSession();
        Transaction tx = statelessSession.beginTransaction();
        
        try {
            ScrollableResults results = statelessSession.createQuery("FROM Product")
                    .scroll(ScrollMode.FORWARD_ONLY);
            
            int count = 0;
            while (results.next()) {
                Product product = (Product) results.get(0);
                // å¤„ç†äº§å“...
                statelessSession.update(product);
                
                if (++count % 50 == 0) {
                    tx.commit();
                    tx = statelessSession.beginTransaction();
                }
            }
            
            tx.commit();
        } catch (Exception e) {
            if (tx != null) tx.rollback();
            throw e;
        } finally {
            statelessSession.close();
        }
    }
}
```

#### 5.2.3 é…ç½®å¤šæ•°æ®æº

```java
@Configuration
@EnableTransactionManagement
@EnableJpaRepositories(
    basePackages = "com.example.primary.repository",
    entityManagerFactoryRef = "primaryEntityManagerFactory",
    transactionManagerRef = "primaryTransactionManager"
)
public class PrimaryDbConfig {
    
    @Primary
    @Bean
    @ConfigurationProperties("spring.datasource.primary")
    public DataSource primaryDataSource() {
        return DataSourceBuilder.create().build();
    }
    
    @Primary
    @Bean
    public LocalContainerEntityManagerFactoryBean primaryEntityManagerFactory(
            EntityManagerFactoryBuilder builder,
            @Qualifier("primaryDataSource") DataSource dataSource) {
        return builder
            .dataSource(dataSource)
            .packages("com.example.primary.entity")
            .persistenceUnit("primary")
            .properties(hibernateProperties())
            .build();
    }
    
    @Primary
    @Bean
    public PlatformTransactionManager primaryTransactionManager(
            @Qualifier("primaryEntityManagerFactory") EntityManagerFactory entityManagerFactory) {
        return new JpaTransactionManager(entityManagerFactory);
    }
    
    private Map<String, Object> hibernateProperties() {
        Map<String, Object> properties = new HashMap<>();
        properties.put("hibernate.dialect", "org.hibernate.dialect.MySQL8Dialect");
        properties.put("hibernate.hbm2ddl.auto", "update");
        return properties;
    }
}

// ç±»ä¼¼åœ°å®šä¹‰ç¬¬äºŒä¸ªæ•°æ®æºé…ç½®...
```

### 5.3 äº‹åŠ¡ç®¡ç†

Spring Bootä¸Hibernateç»“åˆæ—¶ï¼Œäº‹åŠ¡ç®¡ç†ä¸»è¦é€šè¿‡Springçš„äº‹åŠ¡æŠ½è±¡å®ç°ã€‚

#### 5.3.1 å£°æ˜å¼äº‹åŠ¡

```java
@Service
public class UserService {
    
    @Autowired
    private UserRepository userRepository;
    
    @Transactional
    public User registerUser(User user) {
        // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å­˜åœ¨
        if (userRepository.existsByUsername(user.getUsername())) {
            throw new UsernameAlreadyExistsException("ç”¨æˆ·åå·²å­˜åœ¨");
        }
        
        // ä¿å­˜ç”¨æˆ·
        return userRepository.save(user);
        // å¦‚æœå‘ç”Ÿå¼‚å¸¸ï¼Œäº‹åŠ¡ä¼šè‡ªåŠ¨å›æ»š
    }
    
    @Transactional(readOnly = true)
    public User getUserDetails(Long id) {
        return userRepository.findById(id)
            .orElseThrow(() -> new UserNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨"));
    }
    
    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void logUserActivity(UserActivity activity) {
        // å³ä½¿å¤–å±‚äº‹åŠ¡å¤±è´¥ï¼Œæ­¤æ“ä½œä¹Ÿä¼šåœ¨æ–°äº‹åŠ¡ä¸­æäº¤
    }
    
    @Transactional(noRollbackFor = NotFoundException.class)
    public void processUserData(Long userId) {
        // å³ä½¿æŠ›å‡ºNotFoundExceptionï¼Œäº‹åŠ¡ä¹Ÿä¸ä¼šå›æ»š
    }
}
```

#### 5.3.2 ç¼–ç¨‹å¼äº‹åŠ¡

```java
@Service
public class OrderService {
    
    @Autowired
    private PlatformTransactionManager transactionManager;
    
    @Autowired
    private OrderRepository orderRepository;
    
    public void processOrder(Order order) {
        TransactionTemplate transactionTemplate = new TransactionTemplate(transactionManager);
        
        // å®šä¹‰äº‹åŠ¡å±æ€§
        transactionTemplate.setIsolationLevel(TransactionDefinition.ISOLATION_READ_COMMITTED);
        transactionTemplate.setTimeout(30); // 30ç§’è¶…æ—¶
        
        // æ‰§è¡Œäº‹åŠ¡
        Order savedOrder = transactionTemplate.execute(status -> {
            try {
                return orderRepository.save(order);
            } catch (Exception e) {
                status.setRollbackOnly();
                throw e;
            }
        });
    }
}
```

#### 5.3.3 äº‹åŠ¡éš”ç¦»çº§åˆ«

```java
@Transactional(isolation = Isolation.READ_COMMITTED)
public void updateUserProfile(UserProfile profile) {
    // ä½¿ç”¨READ_COMMITTEDéš”ç¦»çº§åˆ«æ‰§è¡Œæ›´æ–°
}
```

Springæ”¯æŒçš„éš”ç¦»çº§åˆ«ï¼š
- **DEFAULT**ï¼šä½¿ç”¨æ•°æ®åº“é»˜è®¤éš”ç¦»çº§åˆ«
- **READ_UNCOMMITTED**ï¼šè¯»æœªæäº¤ï¼ˆæœ€ä½éš”ç¦»çº§åˆ«ï¼‰
- **READ_COMMITTED**ï¼šè¯»å·²æäº¤
- **REPEATABLE_READ**ï¼šå¯é‡å¤è¯»
- **SERIALIZABLE**ï¼šä¸²è¡ŒåŒ–ï¼ˆæœ€é«˜éš”ç¦»çº§åˆ«ï¼‰ 

## 6. Hibernateæ€§èƒ½ä¼˜åŒ–

Hibernateåœ¨æä¾›ä¾¿æ·çš„å¯¹è±¡å…³ç³»æ˜ å°„åŒæ—¶ï¼Œä¹Ÿå¼•å…¥äº†æ€§èƒ½å¼€é”€ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›æé«˜Hibernateåº”ç”¨æ€§èƒ½çš„ç­–ç•¥ã€‚

### 6.1 æŸ¥è¯¢ä¼˜åŒ–

#### 6.1.1 é€‰æ‹©é€‚å½“çš„è·å–ç­–ç•¥

```java
// å³æ—¶åŠ è½½ï¼šç«‹å³è·å–å…³è”æ•°æ®
@OneToMany(fetch = FetchType.EAGER)
private Set<OrderItem> items;

// æ‡’åŠ è½½ï¼šä»…åœ¨è®¿é—®æ—¶è·å–å…³è”æ•°æ®
@ManyToOne(fetch = FetchType.LAZY)
@JoinColumn(name = "customer_id")
private Customer customer;
```

**æœ€ä½³å®è·µ**ï¼š
- å¯¹äºå•ä¸ªå®ä½“æˆ–å¾ˆå°‘å˜åŒ–çš„å°é›†åˆï¼Œå¯ä»¥ä½¿ç”¨å³æ—¶åŠ è½½
- å¯¹äºå¤§å‹é›†åˆæˆ–å¤æ‚å…³è”ï¼Œåº”ä½¿ç”¨æ‡’åŠ è½½
- è®¾è®¡ç»†ç²’åº¦APIï¼Œé¿å…ä¸å¿…è¦çš„æ•°æ®åŠ è½½

#### 6.1.2 æ‰¹é‡è·å–

é…ç½®æ‰¹é‡è·å–å¯ä»¥å‡å°‘N+1æŸ¥è¯¢é—®é¢˜ï¼š

```java
@Entity
public class Order {
    @Id
    private Long id;
    
    @OneToMany(mappedBy = "order")
    @BatchSize(size = 25)  // å½“åŠ è½½å¤šä¸ªOrderæ—¶ï¼Œæ‰¹é‡åŠ è½½æ¯ä¸ªOrderçš„items
    private Set<OrderItem> items;
}

// æˆ–è€…åœ¨å…¨å±€é…ç½®ä¸­è®¾ç½®
// hibernate.default_batch_fetch_size=25
```

#### 6.1.3 è¿æ¥æŸ¥è¯¢å’ŒDTOs

å¯¹äºéœ€è¦å…³è”æ•°æ®çš„æŸ¥è¯¢ï¼Œå¯ä»¥ä½¿ç”¨è¿æ¥å’ŒDTOsï¼š

```java
// ä½¿ç”¨JOIN FETCHé¢„åŠ è½½å…³è”æ•°æ®
@Query("SELECT o FROM Order o JOIN FETCH o.customer JOIN FETCH o.items WHERE o.status = :status")
List<Order> findActiveOrdersWithDetails(@Param("status") OrderStatus status);

// ä½¿ç”¨æŠ•å½±è¿”å›ä»…éœ€çš„å­—æ®µï¼Œé¿å…åŠ è½½æ•´ä¸ªå®ä½“
@Query("SELECT new com.example.dto.OrderSummaryDTO(o.id, o.orderDate, c.name) " +
       "FROM Order o JOIN o.customer c WHERE o.status = :status")
List<OrderSummaryDTO> findOrderSummaries(@Param("status") OrderStatus status);
```

### 6.2 ä¼šè¯ç®¡ç†

#### 6.2.1 æ§åˆ¶Sessionå¤§å°

```java
// æ¸…ç†Sessionç¼“å­˜ï¼Œé˜²æ­¢å†…å­˜æº¢å‡º
public void processManyEntities() {
    Session session = sessionFactory.openSession();
    Transaction tx = session.beginTransaction();
    
    ScrollableResults results = session.createQuery("FROM LargeEntity")
            .scroll(ScrollMode.FORWARD_ONLY);
    
    int count = 0;
    while (results.next()) {
        LargeEntity entity = (LargeEntity) results.get(0);
        processEntity(entity);
        
        // æ¯100æ¡è®°å½•æ¸…ç†ä¸€æ¬¡Sessionç¼“å­˜
        if (++count % 100 == 0) {
            session.flush();
            session.clear();
        }
    }
    
    tx.commit();
    session.close();
}
```

#### 6.2.2 ä½¿ç”¨æœ‰çŠ¶æ€ä¸æ— çŠ¶æ€ä¼šè¯

```java
// å¤§æ‰¹é‡æ“ä½œä½¿ç”¨StatelessSession
public void batchImport(List<Product> products) {
    StatelessSession statelessSession = sessionFactory.openStatelessSession();
    Transaction tx = statelessSession.beginTransaction();
    
    try {
        for (Product product : products) {
            statelessSession.insert(product);
        }
        tx.commit();
    } catch (Exception e) {
        tx.rollback();
        throw e;
    } finally {
        statelessSession.close();
    }
}
```

### 6.3 å®ä½“è®¾è®¡ä¼˜åŒ–

#### 6.3.1 ä½¿ç”¨æ´¾ç”Ÿå±æ€§

å¯¹äºç»å¸¸éœ€è¦è®¡ç®—çš„å±æ€§ï¼Œå¯ä»¥åœ¨æ•°æ®åº“çº§åˆ«è®¡ç®—å¹¶å­˜å‚¨ï¼š

```java
@Entity
public class Order {
    @Column(name = "total_amount")
    private BigDecimal totalAmount;
    
    @OneToMany(mappedBy = "order", cascade = CascadeType.ALL)
    private Set<OrderItem> items = new HashSet<>();
    
    // åœ¨æ·»åŠ /ç§»é™¤é¡¹ç›®æ—¶ç»´æŠ¤æ€»é‡‘é¢
    public void addItem(OrderItem item) {
        items.add(item);
        item.setOrder(this);
        this.totalAmount = this.totalAmount.add(item.getSubtotal());
    }
    
    public void removeItem(OrderItem item) {
        items.remove(item);
        item.setOrder(null);
        this.totalAmount = this.totalAmount.subtract(item.getSubtotal());
    }
}
```

#### 6.3.2 é¿å…æ·±å±‚å…³è”

è¿‡æ·±çš„å…³è”å…³ç³»å®¹æ˜“å¯¼è‡´æ€§èƒ½é—®é¢˜ï¼š

```java
// ä¸å¥½çš„è®¾è®¡ï¼šæ·±å±‚çº§çº§è”
@Entity
public class Company {
    @OneToMany(cascade = CascadeType.ALL, fetch = FetchType.EAGER)
    private Set<Department> departments;
}

@Entity
public class Department {
    @OneToMany(cascade = CascadeType.ALL, fetch = FetchType.EAGER)
    private Set<Employee> employees;
}

@Entity
public class Employee {
    @OneToMany(cascade = CascadeType.ALL, fetch = FetchType.EAGER)
    private Set<Task> tasks;
}

// æ”¹è¿›ï¼šæ ¹æ®è®¿é—®æ¨¡å¼è®¾è®¡åˆç†çš„å…³è”ä¸åŠ è½½ç­–ç•¥
@Entity
public class Company {
    @OneToMany(mappedBy = "company", cascade = CascadeType.ALL, fetch = FetchType.LAZY)
    private Set<Department> departments;
}

// ä½¿ç”¨ä¸“é—¨çš„DTOå’ŒæŸ¥è¯¢å¤„ç†è·¨å¤šçº§çš„æ•°æ®éœ€æ±‚
```

### 6.4 ç¼“å­˜ä¼˜åŒ–

#### 6.4.1 é€‰æ‹©æ€§å¯ç”¨äºŒçº§ç¼“å­˜

```java
// é€‚åˆç¼“å­˜çš„å®ä½“ï¼ˆå˜åŒ–å°‘ï¼Œè®¿é—®é¢‘ç¹ï¼‰
@Entity
@Cacheable
@org.hibernate.annotations.Cache(usage = CacheConcurrencyStrategy.READ_WRITE)
public class Product {
    // ...
}

// ä¸é€‚åˆç¼“å­˜çš„å®ä½“ï¼ˆé¢‘ç¹å˜åŒ–ï¼‰
@Entity
public class StockLevel {
    // æ²¡æœ‰æ·»åŠ ç¼“å­˜æ³¨è§£
}
```

#### 6.4.2 æŸ¥è¯¢ç¼“å­˜å’Œç»“æœè½¬æ¢å™¨

```java
// ç»å¸¸æ‰§è¡Œçš„ç›¸åŒæŸ¥è¯¢å¯ä»¥ç¼“å­˜
@QueryHints({
    @QueryHint(name = "org.hibernate.cacheable", value = "true"),
    @QueryHint(name = "org.hibernate.cacheRegion", value = "productQueries")
})
@Query("FROM Product p WHERE p.category = :category")
List<Product> findByCategory(@Param("category") String category);
```

### 6.5 æ‰¹å¤„ç†æ“ä½œ

#### 6.5.1 JDBCæ‰¹å¤„ç†

```java
// å¯ç”¨JDBCæ‰¹å¤„ç†
<property name="hibernate.jdbc.batch_size">30</property>
<property name="hibernate.order_inserts">true</property>
<property name="hibernate.order_updates">true</property>

// ä»£ç ä¸­ä½¿ç”¨æ‰¹å¤„ç†
Session session = sessionFactory.openSession();
Transaction tx = session.beginTransaction();

try {
    for (int i = 0; i < 10000; i++) {
        Product product = new Product("Product " + i);
        session.save(product);
        
        if (i % 30 == 0) { 
            // æ¯30æ¡è®°å½•åˆ·æ–°å¹¶æ¸…ç†ä¼šè¯
            session.flush();
            session.clear();
        }
    }
    tx.commit();
} catch (Exception e) {
    tx.rollback();
    throw e;
} finally {
    session.close();
}
```

#### 6.5.2 å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶

```java
@Entity
public class Account {
    @Id
    private Long id;
    
    private BigDecimal balance;
    
    @Version
    private Integer version;
    
    // ...
}

// ä½¿ç”¨ä¹è§‚é”è¿›è¡Œé«˜å¹¶å‘æ›´æ–°
public void transfer(Long fromId, Long toId, BigDecimal amount) {
    Session session = sessionFactory.openSession();
    Transaction tx = session.beginTransaction();
    
    try {
        Account from = session.get(Account.class, fromId);
        Account to = session.get(Account.class, toId);
        
        from.setBalance(from.getBalance().subtract(amount));
        to.setBalance(to.getBalance().add(amount));
        
        // ä¿å­˜æ›´æ”¹ï¼Œå¦‚æœversionå·²å˜æ›´ï¼ŒæŠ›å‡ºStaleObjectStateException
        session.update(from);
        session.update(to);
        
        tx.commit();
    } catch (StaleObjectStateException e) {
        // å¤„ç†ä¹è§‚é”å†²çªï¼Œä¾‹å¦‚é‡è¯•æˆ–é€šçŸ¥ç”¨æˆ·
        tx.rollback();
        throw new ConcurrentModificationException("æ•°æ®å·²è¢«å…¶ä»–äº‹åŠ¡ä¿®æ”¹ï¼Œè¯·é‡è¯•");
    } catch (Exception e) {
        tx.rollback();
        throw e;
    } finally {
        session.close();
    }
}
```

### 6.6 SQLä¼˜åŒ–

#### 6.6.1 ä½¿ç”¨SQLæç¤º

```java
// ä½¿ç”¨SQLæç¤ºä¼˜åŒ–æŸ¥è¯¢
@QueryHint(name = "org.hibernate.comment", value = "ç´¢å¼•æç¤º")
@Query(value = "SELECT * FROM products p USE INDEX (idx_category) WHERE p.category = :category", nativeQuery = true)
List<Product> findProductsByCategoryOptimized(@Param("category") String category);
```

#### 6.6.2 æ‰¹é‡æ›´æ–°å’Œåˆ é™¤

```java
// ä½¿ç”¨HQLè¿›è¡Œæ‰¹é‡æ“ä½œ
@Modifying
@Query("UPDATE Product p SET p.price = p.price * 1.1 WHERE p.category = :category")
int increasePriceForCategory(@Param("category") String category);

// ä½¿ç”¨åŸç”ŸSQLè¿›è¡Œå¤æ‚æ‰¹é‡æ“ä½œ
@Modifying
@Query(value = "UPDATE products p JOIN product_stats s ON p.id = s.product_id " +
               "SET p.featured = true WHERE s.views > 1000", nativeQuery = true)
int markHighViewProductsAsFeatured();
```

## 7. å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### 7.1 N+1æŸ¥è¯¢é—®é¢˜

**é—®é¢˜**ï¼šå½“åŠ è½½ä¸€ä¸ªé›†åˆæ—¶ï¼ŒHibernateä¸ºé›†åˆä¸­çš„æ¯ä¸ªå…ƒç´ å•ç‹¬æ‰§è¡ŒæŸ¥è¯¢ã€‚

```java
// N+1æŸ¥è¯¢é—®é¢˜ç¤ºä¾‹
List<Department> departments = session.createQuery("FROM Department").list(); // 1æ¬¡æŸ¥è¯¢
for (Department dept : departments) {
    // æ¯æ¬¡è®¿é—®employeesé›†åˆæ—¶ä¼šè§¦å‘1æ¬¡æ–°çš„æŸ¥è¯¢
    dept.getEmployees().size(); // Næ¬¡é¢å¤–æŸ¥è¯¢
}
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. **ä½¿ç”¨JOIN FETCH**ï¼š
```java
// ä½¿ç”¨JOIN FETCHé¢„åŠ è½½å…³è”é›†åˆ
List<Department> departments = session.createQuery(
        "FROM Department d JOIN FETCH d.employees")
        .list();

// ç°åœ¨è®¿é—®employeesä¸ä¼šè§¦å‘é¢å¤–æŸ¥è¯¢
for (Department dept : departments) {
    dept.getEmployees().size(); // ä¸ä¼šæ‰§è¡Œé¢å¤–æŸ¥è¯¢
}
```

2. **ä½¿ç”¨æ‰¹é‡è·å–**ï¼š
```java
// åœ¨Departmentç±»ä¸Šæ·»åŠ 
@Entity
public class Department {
    @OneToMany(mappedBy = "department")
    @BatchSize(size = 20)  // æ¯æ¬¡åŠ è½½æœ€å¤š20ä¸ªéƒ¨é—¨çš„å‘˜å·¥
    private Set<Employee> employees;
}

// æˆ–åœ¨å…¨å±€é…ç½®ä¸­è®¾ç½®
// <property name="hibernate.default_batch_fetch_size">20</property>
```

3. **ä½¿ç”¨å­æŸ¥è¯¢**ï¼š
```java
@Entity
public class Department {
    @OneToMany(mappedBy = "department")
    @org.hibernate.annotations.Fetch(FetchMode.SUBSELECT)
    private Set<Employee> employees;
}
```

### 7.2 æ‡’åŠ è½½å¼‚å¸¸

**é—®é¢˜**ï¼šåœ¨Sessionå…³é—­åè®¿é—®æ‡’åŠ è½½å±æ€§æ—¶æŠ›å‡ºLazyInitializationExceptionã€‚

```java
// é—®é¢˜ä»£ç 
Session session = sessionFactory.openSession();
Department dept = session.get(Department.class, 1L);
session.close();

// å¼‚å¸¸äº§ç”Ÿç‚¹
dept.getEmployees().size(); // LazyInitializationException
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. **å¼€æ”¾ä¼šè¯è§†å›¾æ¨¡å¼**ï¼š
```java
// Springä¸­é…ç½®OpenSessionInViewFilter
@Bean
public FilterRegistrationBean<OpenSessionInViewFilter> openSessionInViewFilter() {
    FilterRegistrationBean<OpenSessionInViewFilter> bean = new FilterRegistrationBean<>();
    bean.setFilter(new OpenSessionInViewFilter());
    bean.addUrlPatterns("/*");
    return bean;
}
```

2. **é¢„åŠ è½½éœ€è¦çš„æ•°æ®**ï¼š
```java
// æŸ¥è¯¢æ—¶é¢„åŠ è½½
Department dept = session.createQuery(
        "FROM Department d JOIN FETCH d.employees WHERE d.id = :id", Department.class)
        .setParameter("id", 1L)
        .uniqueResult();
session.close();
dept.getEmployees().size(); // å®‰å…¨ï¼Œå·²é¢„åŠ è½½
```

3. **åˆ†ç¦»DTO**ï¼š
```java
// åˆ›å»ºDTOï¼ŒåªåŒ…å«éœ€è¦çš„æ•°æ®
public class DepartmentDTO {
    private Long id;
    private String name;
    private int employeeCount;
    
    // æ„é€ å‡½æ•°ã€Gettersã€Setters...
}

// æŸ¥è¯¢ç›´æ¥è¿”å›DTO
@Query("SELECT new com.example.dto.DepartmentDTO(d.id, d.name, SIZE(d.employees)) " +
       "FROM Department d WHERE d.id = :id")
DepartmentDTO getDepartmentSummary(@Param("id") Long id);
```

### 7.3 ç¼“å­˜ç›¸å…³é—®é¢˜

**é—®é¢˜**ï¼šç¼“å­˜ä¸€è‡´æ€§å’Œæ•°æ®é™ˆæ—§é—®é¢˜ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. **é€‚å½“çš„ç¼“å­˜ç­–ç•¥**ï¼š
```java
// é’ˆå¯¹ä¸åŒæ•°æ®ç±»å‹é€‰æ‹©åˆé€‚çš„ç¼“å­˜ç­–ç•¥
@Cacheable
@org.hibernate.annotations.Cache(usage = CacheConcurrencyStrategy.READ_ONLY)
public class Country {
    // é™æ€å‚è€ƒæ•°æ®ï¼Œå¾ˆå°‘å˜åŒ–
}

@Cacheable
@org.hibernate.annotations.Cache(usage = CacheConcurrencyStrategy.READ_WRITE)
public class Product {
    // ç»å¸¸è¯»å–ï¼Œå¶å°”æ›´æ–°çš„æ•°æ®
}
```

2. **æ˜¾å¼æ¸…é™¤ç¼“å­˜**ï¼š
```java
// åœ¨å…³é”®æ•°æ®æ›´æ–°åä¸»åŠ¨æ¸…é™¤ç¼“å­˜
SessionFactory sessionFactory = // ...
sessionFactory.getCache().evictEntityRegion(Product.class);
// æˆ–è€…æ›´ç²¾ç¡®åœ°æ¸…é™¤ç‰¹å®šå®ä½“
sessionFactory.getCache().evictEntity(Product.class, productId);
```

3. **è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´**ï¼š
```xml
<cache alias="productCache" uses-template="defaultTemplate">
    <expiry>
        <ttl unit="minutes">15</ttl>  <!-- 15åˆ†é’Ÿåè¿‡æœŸ -->
    </expiry>
</cache>
```

### 7.4 æ€§èƒ½é—®é¢˜

**é—®é¢˜**ï¼šHibernateåº”ç”¨å‡ºç°æ€§èƒ½ç“¶é¢ˆã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. **ä½¿ç”¨åˆ†æå·¥å…·**ï¼š
```java
// å¯ç”¨ç»Ÿè®¡ä¿¡æ¯
<property name="hibernate.generate_statistics">true</property>

// è·å–ç»Ÿè®¡ä¿¡æ¯
Statistics stats = sessionFactory.getStatistics();
System.out.println("æŸ¥è¯¢æ‰§è¡Œæ¬¡æ•°: " + stats.getQueryExecutionCount());
System.out.println("äºŒçº§ç¼“å­˜å‘½ä¸­ç‡: " + stats.getSecondLevelCacheHitRatio());
```

2. **ä½¿ç”¨åŸç”ŸSQLå¤„ç†å¤æ‚æŸ¥è¯¢**ï¼š
```java
// å¯¹äºå¤æ‚æŸ¥è¯¢ï¼Œè€ƒè™‘ä½¿ç”¨åŸç”ŸSQL
@Query(value = "SELECT p.* FROM products p " +
               "JOIN inventory i ON p.id = i.product_id " +
               "WHERE i.stock > 0 AND p.price < :maxPrice " +
               "ORDER BY p.popularity DESC LIMIT 10", 
       nativeQuery = true)
List<Product> findBestSellingProducts(@Param("maxPrice") BigDecimal maxPrice);
```

3. **é¿å…ä¸å¿…è¦çš„è¿æ¥**ï¼š
```java
// ä¸å¥½çš„å®è·µï¼šåŠ è½½å®ä½“å¹¶è¿›è¡Œè¿‡æ»¤
List<Order> orders = orderRepository.findAll();
List<Order> recentOrders = orders.stream()
        .filter(o -> o.getOrderDate().isAfter(LocalDateTime.now().minusDays(7)))
        .collect(Collectors.toList());

// å¥½çš„å®è·µï¼šåœ¨æŸ¥è¯¢ä¸­è¿›è¡Œè¿‡æ»¤
@Query("SELECT o FROM Order o WHERE o.orderDate > :date")
List<Order> findOrdersAfterDate(@Param("date") LocalDateTime date);
```

### 7.5 äº‹åŠ¡å’Œå¹¶å‘é—®é¢˜

**é—®é¢˜**ï¼šäº‹åŠ¡éš”ç¦»çº§åˆ«ä¸å½“å¯¼è‡´å¹¶å‘é—®é¢˜ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. **é€‰æ‹©é€‚å½“çš„äº‹åŠ¡éš”ç¦»çº§åˆ«**ï¼š
```java
// è¯»å·²æäº¤ï¼šå…è®¸ä¸å¯é‡å¤è¯»ï¼Œä½†é˜²æ­¢è„è¯»
@Transactional(isolation = Isolation.READ_COMMITTED)
public void updateUserData(User user) {
    // ...
}

// å¯é‡å¤è¯»ï¼šé˜²æ­¢ä¸å¯é‡å¤è¯»
@Transactional(isolation = Isolation.REPEATABLE_READ)
public void generateReport(Long userId) {
    // ...
}
```

2. **ä¹è§‚é”ä¸æ‚²è§‚é”**ï¼š
```java
// ä¹è§‚é”ï¼šé€‚ç”¨äºå†²çªè¾ƒå°‘çš„æƒ…å†µ
@Entity
public class Inventory {
    @Version
    private Integer version;
    // ...
}

// æ‚²è§‚é”ï¼šé€‚ç”¨äºé«˜å¹¶å‘å†²çªåœºæ™¯
@Lock(LockModeType.PESSIMISTIC_WRITE)
@Query("SELECT i FROM Inventory i WHERE i.productId = :id")
Inventory findWithLock(@Param("id") Long productId);
```

## 8. æœ€ä½³å®è·µå’Œæ€»ç»“

### 8.1 è®¾è®¡æœ€ä½³å®è·µ

1. **é¢†åŸŸæ¨¡å‹è®¾è®¡**ï¼š
   - ä½¿ç”¨å……è¡€æ¨¡å‹ï¼Œå°†ä¸šåŠ¡é€»è¾‘å°è£…åœ¨å®ä½“ä¸­
   - éµå¾ªå•ä¸€èŒè´£åŸåˆ™ï¼Œæ¯ä¸ªå®ä½“åªå…³æ³¨è‡ªå·±çš„æ ¸å¿ƒèŒè´£
   - åˆç†ä½¿ç”¨ç»§æ‰¿å’Œç»„åˆå…³ç³»

2. **æ˜ å°„ç­–ç•¥**ï¼š
   - é€‰æ‹©åˆé€‚çš„IDç”Ÿæˆç­–ç•¥ï¼ˆå¦‚è‡ªå¢ã€UUIDï¼‰
   - åˆç†è®¾ç½®å…³è”å…³ç³»çš„çº§è”ç‰¹æ€§
   - è°¨æ…ä½¿ç”¨åŒå‘å…³è”ï¼Œåªåœ¨å¿…è¦æ—¶ä½¿ç”¨

3. **æŸ¥è¯¢è®¾è®¡**ï¼š
   - ä¼˜å…ˆä½¿ç”¨å‘½åæŸ¥è¯¢æˆ–å­˜å‚¨è¿‡ç¨‹å¤„ç†å¤æ‚é€»è¾‘
   - ä½¿ç”¨æŠ•å½±DTOå‡å°‘æ•°æ®ä¼ è¾“é‡
   - æ ¹æ®æŸ¥è¯¢é¢‘ç‡å’Œå¤æ‚æ€§é€‰æ‹©HQLæˆ–åŸç”ŸSQL

### 8.2 æ€§èƒ½æœ€ä½³å®è·µ

1. **ä¼šè¯ç®¡ç†**ï¼š
   - ä¿æŒSessionç”Ÿå‘½å‘¨æœŸçŸ­ï¼Œé¿å…é•¿ä¼šè¯
   - å®šæœŸæ¸…ç†Sessionç¼“å­˜ï¼Œé˜²æ­¢å†…å­˜æº¢å‡º
   - ä½¿ç”¨StatelessSessionå¤„ç†æ‰¹é‡æ“ä½œ

2. **æ‰¹å¤„ç†ä¼˜åŒ–**ï¼š
   - é…ç½®åˆé€‚çš„æ‰¹å¤„ç†å¤§å°ï¼ˆé€šå¸¸10-50ï¼‰
   - å¯¹ç›¸ä¼¼æ“ä½œè¿›è¡Œæ’åºä»¥æé«˜æ‰¹å¤„ç†æ•ˆç‡
   - ä½¿ç”¨å¤šçº¿ç¨‹å¤„ç†å¤§æ‰¹é‡æ•°æ®

3. **ç¼“å­˜ç­–ç•¥**ï¼š
   - ä¸ºè¯»å¤šå†™å°‘çš„æ•°æ®å¯ç”¨äºŒçº§ç¼“å­˜
   - ä¸ºé¢‘ç¹æ‰§è¡Œçš„æŸ¥è¯¢å¯ç”¨æŸ¥è¯¢ç¼“å­˜
   - è®¾ç½®åˆç†çš„ç¼“å­˜åŒºåŸŸå’Œè¿‡æœŸç­–ç•¥

### 8.3 å¼€å‘å·¥å…·å’Œè°ƒè¯•

1. **æ—¥å¿—é…ç½®**ï¼š
```xml
<property name="hibernate.show_sql">true</property>
<property name="hibernate.format_sql">true</property>
<property name="hibernate.use_sql_comments">true</property>
```

2. **è°ƒè¯•å·¥å…·**ï¼š
   - ä½¿ç”¨p6spyç­‰å·¥å…·æ‹¦æˆªå’Œåˆ†æSQL
   - ä½¿ç”¨JPA Buddyã€Hibernate Toolsç­‰IDEæ’ä»¶
   - ä½¿ç”¨Hibernate Profilerç›‘æ§æ€§èƒ½

3. **æµ‹è¯•ç­–ç•¥**ï¼š
   - ä½¿ç”¨å†…å­˜æ•°æ®åº“ï¼ˆH2ã€HSQLDBï¼‰è¿›è¡Œå•å…ƒæµ‹è¯•
   - ä½¿ç”¨æµ‹è¯•å®¹å™¨ï¼ˆTestcontainersï¼‰è¿›è¡Œé›†æˆæµ‹è¯•
   - åˆ›å»ºä¸“ç”¨æµ‹è¯•ç¯å¢ƒæ¨¡æ‹Ÿç”Ÿäº§è´Ÿè½½

### 8.4 Hibernateä¸å…¶ä»–æŠ€æœ¯é›†æˆ

1. **ä¸Spring Booté›†æˆ**ï¼š
   - ä½¿ç”¨Spring Data JPAç®€åŒ–æ•°æ®è®¿é—®å±‚
   - åˆ©ç”¨Springçš„äº‹åŠ¡ç®¡ç†å’ŒAOPåŠŸèƒ½
   - ä½¿ç”¨Spring Profilesç®¡ç†ä¸åŒç¯å¢ƒé…ç½®

2. **ä¸æŸ¥è¯¢æ¡†æ¶é›†æˆ**ï¼š
   - ä½¿ç”¨QueryDSLå®ç°ç±»å‹å®‰å…¨æŸ¥è¯¢
   - ä½¿ç”¨JOOQè¿›è¡Œå¤æ‚SQLæ“ä½œ
   - ä½¿ç”¨Blaze-Persistenceè¿›è¡Œé«˜çº§æŸ¥è¯¢ä¼˜åŒ–

3. **ä¸NoSQLé›†æˆ**ï¼š
   - ä½¿ç”¨Hibernate OGMè¿æ¥MongoDBã€Neo4jç­‰
   - ä½¿ç”¨Spring DataåŒæ—¶å¤„ç†å…³ç³»å‹å’Œéå…³ç³»å‹æ•°æ®åº“
   - å®ç°å¤šæ¨¡å‹æŒä¹…åŒ–ç­–ç•¥

### 8.5 æ€»ç»“ä¸å±•æœ›

Hibernateä½œä¸ºä¸€ä¸ªæˆç†Ÿçš„ORMæ¡†æ¶ï¼Œä¸ºJavaå¼€å‘è€…æä¾›äº†ä¸°å¯Œçš„æ•°æ®æŒä¹…åŒ–èƒ½åŠ›ã€‚æ­£ç¡®ä½¿ç”¨Hibernateéœ€è¦ç†è§£å…¶æ ¸å¿ƒæ¦‚å¿µå’Œå†…éƒ¨æœºåˆ¶ï¼Œå¹¶åœ¨ä¸åŒåœºæ™¯ä¸‹åº”ç”¨é€‚å½“çš„ç­–ç•¥ã€‚

éšç€å¾®æœåŠ¡æ¶æ„å’Œäº‘åŸç”Ÿåº”ç”¨çš„å…´èµ·ï¼ŒHibernateä¹Ÿåœ¨ä¸æ–­æ¼”è¿›ï¼Œä¾‹å¦‚é€šè¿‡Hibernate Reactiveæä¾›å¯¹å“åº”å¼ç¼–ç¨‹çš„æ”¯æŒï¼Œä»¥åŠå¢å¼ºå¯¹åŸç”ŸSQLçš„å¤„ç†èƒ½åŠ›ï¼Œä»¥æ»¡è¶³ç°ä»£åº”ç”¨çš„éœ€æ±‚ã€‚

åœ¨é€‰æ‹©ä½¿ç”¨Hibernateæ—¶ï¼Œåº”å……åˆ†è€ƒè™‘é¡¹ç›®éœ€æ±‚ã€å›¢é˜Ÿç»éªŒå’Œæ€§èƒ½è¦æ±‚ï¼Œå¹¶ä¸å…¶ä»–æ•°æ®è®¿é—®æŠ€æœ¯ï¼ˆå¦‚MyBatisã€jOOQï¼‰è¿›è¡Œæ¯”è¾ƒï¼Œé€‰æ‹©æœ€é€‚åˆçš„è§£å†³æ–¹æ¡ˆã€‚

:::tip å­¦ä¹ å»ºè®®
æŒæ¡Hibernateéœ€è¦ï¼š
1. æ·±å…¥ç†è§£å¯¹è±¡å…³ç³»æ˜ å°„åŸç†
2. ç†Ÿæ‚‰ç¼“å­˜æœºåˆ¶å’ŒæŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥
3. æŒæ¡æ€§èƒ½è°ƒä¼˜å’Œé—®é¢˜æ’æŸ¥æ–¹æ³•
4. ç»“åˆå®é™…é¡¹ç›®ç»ƒä¹ ä¸åŒåœºæ™¯çš„åº”ç”¨
5. å…³æ³¨ç¤¾åŒºåŠ¨æ€å’Œç‰ˆæœ¬æ›´æ–°
:::

## 9. é¢è¯•é¢˜ä¸è§£ç­”

### 9.1 åŸºç¡€æ¦‚å¿µ

**Q: Hibernateä¸­å®ä½“çš„ç”Ÿå‘½å‘¨æœŸæœ‰å“ªå‡ ç§çŠ¶æ€ï¼Ÿå„è‡ªæœ‰ä»€ä¹ˆç‰¹ç‚¹ï¼Ÿ**

A: Hibernateå®ä½“æœ‰å››ç§çŠ¶æ€ï¼š
- **ç¬æ—¶æ€(Transient)**: æ–°åˆ›å»ºçš„å¯¹è±¡ï¼Œæœªä¸Sessionå…³è”ï¼Œæ²¡æœ‰æŒä¹…åŒ–æ ‡è¯†ç¬¦
- **æŒä¹…æ€(Persistent)**: ä¸Sessionå…³è”ï¼Œæœ‰æŒä¹…åŒ–æ ‡è¯†ç¬¦ï¼Œå¯¹è±¡çš„å˜æ›´ä¼šè¢«è‡ªåŠ¨åŒæ­¥åˆ°æ•°æ®åº“
- **æ¸¸ç¦»æ€(Detached)**: æ›¾ç»å¤„äºæŒä¹…æ€ï¼Œç°åœ¨ä¸Sessionåˆ†ç¦»ï¼Œæœ‰æŒä¹…åŒ–æ ‡è¯†ç¬¦ï¼Œä½†å˜æ›´ä¸ä¼šåŒæ­¥åˆ°æ•°æ®åº“
- **åˆ é™¤æ€(Removed)**: å·²è¢«Sessionæ ‡è®°ä¸ºåˆ é™¤ï¼Œäº‹åŠ¡æäº¤åå°†ä»æ•°æ®åº“ä¸­åˆ é™¤

**Q: Hibernateçš„ä¸€çº§ç¼“å­˜å’ŒäºŒçº§ç¼“å­˜æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ**

A: 
- **ä¸€çº§ç¼“å­˜**ï¼šSessionçº§åˆ«ï¼Œå¼ºåˆ¶å¯ç”¨ï¼Œç”Ÿå‘½å‘¨æœŸä¸Sessionç›¸åŒï¼Œå•çº¿ç¨‹é€‚ç”¨
- **äºŒçº§ç¼“å­˜**ï¼šSessionFactoryçº§åˆ«ï¼Œå¯é€‰é…ç½®ï¼Œè·¨Sessionå…±äº«ï¼Œé€‚ç”¨äºå¤šçº¿ç¨‹/é›†ç¾¤ç¯å¢ƒ
- ä¸»è¦åŒºåˆ«ï¼šä½œç”¨èŒƒå›´ä¸åŒï¼ˆå•Session vs å¤šSessionï¼‰ï¼Œç”Ÿå‘½å‘¨æœŸä¸åŒï¼ˆçŸ­æœŸ vs é•¿æœŸï¼‰ï¼Œå¹¶å‘æ§åˆ¶ç­–ç•¥ä¸åŒ

### 9.2 é«˜çº§ç‰¹æ€§

**Q: å¦‚ä½•è§£å†³Hibernateä¸­çš„N+1æŸ¥è¯¢é—®é¢˜ï¼Ÿ**

A: è§£å†³N+1æŸ¥è¯¢é—®é¢˜çš„æ–¹æ³•ï¼š
1. ä½¿ç”¨JOIN FETCHé¢„åŠ è½½å…³è”æ•°æ®
2. é…ç½®@BatchSizeè¿›è¡Œæ‰¹é‡åŠ è½½
3. ä½¿ç”¨@Fetch(FetchMode.SUBSELECT)å­æŸ¥è¯¢ç­–ç•¥
4. ä½¿ç”¨DTOæŠ•å½±åªè·å–å¿…è¦å­—æ®µ
5. åœ¨å…¨å±€é…ç½®ä¸­è®¾ç½®hibernate.default_batch_fetch_size

**Q: ä¹è§‚é”å’Œæ‚²è§‚é”åœ¨Hibernateä¸­å¦‚ä½•å®ç°ï¼Ÿå„é€‚ç”¨äºä»€ä¹ˆåœºæ™¯ï¼Ÿ**

A:
- **ä¹è§‚é”**: é€šè¿‡@Versionæ³¨è§£å®ç°ï¼Œé€‚ç”¨äºè¯»å¤šå†™å°‘ã€å†²çªè¾ƒå°‘çš„åœºæ™¯
```java
@Entity
public class Product {
    @Version
    private Integer version;
}
```
- **æ‚²è§‚é”**: é€šè¿‡LockModeæˆ–LockModeTypeå®ç°ï¼Œé€‚ç”¨äºå†™æ“ä½œé¢‘ç¹ã€å†²çªè¾ƒå¤šçš„åœºæ™¯
```java
session.get(Product.class, id, LockMode.PESSIMISTIC_WRITE);
```

### 9.3 æ€§èƒ½è°ƒä¼˜

**Q: å¦‚ä½•ä¼˜åŒ–Hibernateçš„æ€§èƒ½ï¼Ÿ**

A: Hibernateæ€§èƒ½ä¼˜åŒ–ç­–ç•¥ï¼š
1. åˆç†è®¾è®¡å®ä½“å…³ç³»å’ŒåŠ è½½ç­–ç•¥
2. ä½¿ç”¨æ‰¹å¤„ç†å‡å°‘æ•°æ®åº“äº¤äº’æ¬¡æ•°
3. é€‚å½“é…ç½®äºŒçº§ç¼“å­˜å’ŒæŸ¥è¯¢ç¼“å­˜
4. ä½¿ç”¨æŠ•å½±æŸ¥è¯¢å’ŒDTOå‡å°‘æ•°æ®ä¼ è¾“
5. åˆ†æå’Œä¼˜åŒ–ç”Ÿæˆçš„SQL
6. ä½¿ç”¨StatelessSessionå¤„ç†å¤§æ‰¹é‡æ“ä½œ
7. é…ç½®é€‚å½“çš„æ•°æ®åº“è¿æ¥æ± å’Œäº‹åŠ¡éš”ç¦»çº§åˆ«

**Q: StatelessSessionä¸æ™®é€šSessionæœ‰ä½•ä¸åŒï¼Ÿä½•æ—¶ä½¿ç”¨ï¼Ÿ**

A: StatelessSessionä¸æ™®é€šSessionçš„åŒºåˆ«ï¼š
- ä¸ç»´æŠ¤ä¸€çº§ç¼“å­˜
- ä¸è¿›è¡Œè„æ£€æŸ¥
- ä¸çº§è”æ“ä½œ
- ä¸ç®¡ç†åŒå‘å…³ç³»
- ç›´æ¥æ“ä½œæ•°æ®åº“ï¼Œç»•è¿‡ç”Ÿå‘½å‘¨æœŸå›è°ƒ
- é€‚ç”¨åœºæ™¯ï¼šå¤§æ‰¹é‡æ•°æ®å¤„ç†ã€ETLæ“ä½œã€ç›´æ¥æ•°æ®åº“æ“ä½œç­‰æ€§èƒ½æ•æ„Ÿåœºæ™¯

### 9.4 å®è·µé—®é¢˜

**Q: Hibernateä¸Spring Booté›†æˆçš„æœ€ä½³å®è·µæ˜¯ä»€ä¹ˆï¼Ÿ**

A: Hibernateä¸Spring Booté›†æˆæœ€ä½³å®è·µï¼š
1. ä½¿ç”¨spring-boot-starter-data-jpaç®€åŒ–é…ç½®
2. åˆç†è®¾ç½®æ•°æ®æºå’ŒHibernateå±æ€§
3. ä½¿ç”¨Spring Data Repositoryç®€åŒ–DAOå±‚
4. åˆ©ç”¨Springçš„@Transactionalç®¡ç†äº‹åŠ¡
5. ä¸ºä¸åŒç¯å¢ƒé…ç½®ä¸åŒçš„Hibernateè®¾ç½®
6. ç»“åˆSpring Boot Actuatorç›‘æ§æ€§èƒ½
7. ä½¿ç”¨Spring Profileså’Œé…ç½®å±æ€§ç®¡ç†ä¸åŒç¯å¢ƒè®¾ç½®

**Q: å¦‚ä½•å¤„ç†Hibernateä¸­çš„LazyInitializationExceptionï¼Ÿ**

A: å¤„ç†LazyInitializationExceptionçš„æ–¹æ³•ï¼š
1. ä½¿ç”¨JOIN FETCHé¢„åŠ è½½éœ€è¦çš„å…³è”æ•°æ®
2. åœ¨è®¿é—®æ‡’åŠ è½½å±æ€§ä¹‹å‰ç¡®ä¿Sessionä»ç„¶æ‰“å¼€
3. é…ç½®OpenSessionInViewFilterå»¶é•¿Sessionç”Ÿå‘½å‘¨æœŸï¼ˆä»…åœ¨Webå±‚ä½¿ç”¨ï¼‰
4. ä½¿ç”¨DTOä¼ è¾“å¿…è¦çš„æ•°æ®ï¼Œé¿å…æ‡’åŠ è½½
5. ä½¿ç”¨Hibernate.initialize()æ–¹æ³•æ˜¾å¼åˆå§‹åŒ–æ‡’åŠ è½½é›†åˆ 