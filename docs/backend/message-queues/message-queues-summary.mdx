---
sidebar_position: 1
title: æ¶ˆæ¯é˜Ÿåˆ—ç»¼åˆè¯¦è§£
description: å…¨é¢è§£ææ¶ˆæ¯é˜Ÿåˆ—åŸç†ã€æ¶æ„æ¨¡å¼ã€æŠ€æœ¯é€‰å‹ä¸ä¼ä¸šçº§æœ€ä½³å®è·µ
authors: [Laby]
tags: [æ¶ˆæ¯é˜Ÿåˆ—, åˆ†å¸ƒå¼ç³»ç»Ÿ, å¼‚æ­¥é€šä¿¡, ç³»ç»Ÿè§£è€¦, æ¶æ„è®¾è®¡, æŠ€æœ¯é€‰å‹]
last_update:
  date: 2025-08-15
  author: Laby
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import CodeBlock from '@theme/CodeBlock';

# æ¶ˆæ¯é˜Ÿåˆ—ç»¼åˆè¯¦è§£

æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMessage Queueï¼‰æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„æ ¸å¿ƒç»„ä»¶ï¼Œé€šè¿‡å¼‚æ­¥æ¶ˆæ¯ä¼ é€’å®ç°ç³»ç»Ÿè§£è€¦ã€å‰Šå³°å¡«è°·å’Œå¯é é€šä¿¡ã€‚å®ƒæ˜¯æ„å»ºé«˜å¯ç”¨ã€é«˜æ€§èƒ½ã€å¯æ‰©å±•åˆ†å¸ƒå¼æ¶æ„çš„åŸºç¡€è®¾æ–½ï¼Œå¹¿æ³›åº”ç”¨äºå¾®æœåŠ¡ã€å¤§æ•°æ®ã€ç‰©è”ç½‘ç­‰é¢†åŸŸã€‚

:::tip æ ¸å¿ƒä»·å€¼
**æ¶ˆæ¯é˜Ÿåˆ— = å¼‚æ­¥é€šä¿¡ + ç³»ç»Ÿè§£è€¦ + å‰Šå³°å¡«è°· + å¯é ä¼ é€’**
- ğŸš€ **å¼‚æ­¥å¤„ç†**ï¼šæå‡ç³»ç»Ÿå“åº”é€Ÿåº¦ï¼Œæ”¹å–„ç”¨æˆ·ä½“éªŒ
- ğŸ”— **ç³»ç»Ÿè§£è€¦**ï¼šé™ä½ç»„ä»¶é—´è€¦åˆåº¦ï¼Œæé«˜ç³»ç»Ÿçµæ´»æ€§
- ğŸ“Š **å‰Šå³°å¡«è°·**ï¼šç¼“å†²æµé‡å³°å€¼ï¼Œä¿æŠ¤ç³»ç»Ÿç¨³å®šæ€§
- ğŸ›¡ï¸ **å¯é ä¼ é€’**ï¼šä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±ï¼Œæ”¯æŒäº‹åŠ¡ä¸€è‡´æ€§
- ğŸŒ **æ°´å¹³æ‰©å±•**ï¼šæ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²ï¼Œæ»¡è¶³å¤§è§„æ¨¡åœºæ™¯éœ€æ±‚
:::

## 1. æ¶ˆæ¯é˜Ÿåˆ—åŸºç¡€ç†è®º

### 1.1 æ ¸å¿ƒæ¦‚å¿µä¸æ¶æ„æ¨¡å¼

æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿé€šå¸¸åŒ…å«ç”Ÿäº§è€…ã€æ¶ˆæ¯ä»£ç†ã€æ¶ˆè´¹è€…ä¸‰ä¸ªæ ¸å¿ƒè§’è‰²ï¼Œé€šè¿‡ä¸åŒçš„æ¶æ„æ¨¡å¼å®ç°å„ç§ä¸šåŠ¡éœ€æ±‚ã€‚

```mermaid
graph TB
    subgraph "æ¶ˆæ¯é˜Ÿåˆ—æ ¸å¿ƒæ¶æ„"
        P1[Producer 1<br/>ç”Ÿäº§è€…1] --> MQ[Message Queue<br/>æ¶ˆæ¯é˜Ÿåˆ—]
        P2[Producer 2<br/>ç”Ÿäº§è€…2] --> MQ
        P3[Producer 3<br/>ç”Ÿäº§è€…3] --> MQ
        
        MQ --> C1[Consumer 1<br/>æ¶ˆè´¹è€…1]
        MQ --> C2[Consumer 2<br/>æ¶ˆè´¹è€…2]
        MQ --> C3[Consumer 3<br/>æ¶ˆè´¹è€…3]
        
        subgraph "æ ¸å¿ƒåŠŸèƒ½"
            F1[æ¶ˆæ¯è·¯ç”±]
            F2[æŒä¹…åŒ–å­˜å‚¨]
            F3[è´Ÿè½½å‡è¡¡]
            F4[æ•…éšœè½¬ç§»]
        end
    end
```

#### æ¶ˆæ¯é˜Ÿåˆ—æ ¸å¿ƒä½œç”¨

| æ ¸å¿ƒä½œç”¨ | æè¿° | ä¸šåŠ¡ä»·å€¼ | å…¸å‹åœºæ™¯ |
|---------|------|----------|----------|
| **å¼‚æ­¥å¤„ç†** | å°†è€—æ—¶æ“ä½œå¼‚æ­¥åŒ–æ‰§è¡Œ | æå‡å“åº”é€Ÿåº¦ï¼Œæ”¹å–„ç”¨æˆ·ä½“éªŒ | é‚®ä»¶å‘é€ã€å›¾ç‰‡å¤„ç†ã€æ•°æ®åˆ†æ |
| **ç³»ç»Ÿè§£è€¦** | é™ä½ç³»ç»Ÿé—´ç›´æ¥ä¾èµ– | æé«˜ç³»ç»Ÿçµæ´»æ€§å’Œå¯ç»´æŠ¤æ€§ | å¾®æœåŠ¡é€šä¿¡ã€äº‹ä»¶é©±åŠ¨æ¶æ„ |
| **å‰Šå³°å¡«è°·** | ç¼“å†²çªå‘æµé‡å³°å€¼ | ä¿æŠ¤ç³»ç»Ÿç¨³å®šæ€§ï¼Œåˆç†åˆ©ç”¨èµ„æº | ç§’æ€æ´»åŠ¨ã€æ—¥å¿—æ”¶é›†ã€æ•°æ®åŒæ­¥ |
| **å¯é ä¼ é€’** | ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤± | ç¡®ä¿ä¸šåŠ¡æ•°æ®ä¸€è‡´æ€§ | æ”¯ä»˜é€šçŸ¥ã€è®¢å•å¤„ç†ã€åº“å­˜æ›´æ–° |
| **è´Ÿè½½å‡è¡¡** | åˆ†æ•£å¤„ç†å‹åŠ› | æé«˜ç³»ç»Ÿå¤„ç†èƒ½åŠ› | ä»»åŠ¡åˆ†å‘ã€å¹¶è¡Œè®¡ç®—ã€æ‰¹å¤„ç† |

### 1.2 æ¶ˆæ¯ä¼ é€’æ¨¡å¼

<Tabs>
<TabItem value="point-to-point" label="ç‚¹å¯¹ç‚¹æ¨¡å¼">

```mermaid
graph LR
    P[Producer<br/>ç”Ÿäº§è€…] --> Q[Queue<br/>é˜Ÿåˆ—]
    Q --> C[Consumer<br/>æ¶ˆè´¹è€…]
    
    subgraph "ç‰¹ç‚¹"
        F1[ä¸€å¯¹ä¸€é€šä¿¡]
        F2[æ¶ˆæ¯åªè¢«æ¶ˆè´¹ä¸€æ¬¡]
        F3[æ”¯æŒè´Ÿè½½å‡è¡¡]
    end
```

**ç‚¹å¯¹ç‚¹æ¨¡å¼ç‰¹ç‚¹**ï¼š
- æ¯ä¸ªæ¶ˆæ¯åªæœ‰ä¸€ä¸ªæ¶ˆè´¹è€…
- æ¶ˆè´¹è€…ä¹‹é—´ç«äº‰æ¶ˆè´¹æ¶ˆæ¯
- æ”¯æŒæ¶ˆæ¯æŒä¹…åŒ–å’Œäº‹åŠ¡
- é€‚ç”¨äºä»»åŠ¡åˆ†å‘ã€è´Ÿè½½å‡è¡¡åœºæ™¯

</TabItem>
<TabItem value="publish-subscribe" label="å‘å¸ƒè®¢é˜…æ¨¡å¼">

```mermaid
graph TB
    P[Publisher<br/>å‘å¸ƒè€…] --> T[Topic<br/>ä¸»é¢˜]
    T --> S1[Subscriber 1<br/>è®¢é˜…è€…1]
    T --> S2[Subscriber 2<br/>è®¢é˜…è€…2]
    T --> S3[Subscriber 3<br/>è®¢é˜…è€…3]
    
    subgraph "ç‰¹ç‚¹"
        F1[ä¸€å¯¹å¤šé€šä¿¡]
        F2[æ¶ˆæ¯è¢«å¤šæ¬¡æ¶ˆè´¹]
        F3[æ”¯æŒå¹¿æ’­é€šçŸ¥]
    end
```

**å‘å¸ƒè®¢é˜…æ¨¡å¼ç‰¹ç‚¹**ï¼š
- ä¸€ä¸ªæ¶ˆæ¯å¯ä»¥è¢«å¤šä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹
- å‘å¸ƒè€…å’Œè®¢é˜…è€…è§£è€¦
- æ”¯æŒä¸»é¢˜åˆ†ç±»å’Œè¿‡æ»¤
- é€‚ç”¨äºäº‹ä»¶é€šçŸ¥ã€æ•°æ®åŒæ­¥åœºæ™¯

</TabItem>
<TabItem value="request-reply" label="è¯·æ±‚å“åº”æ¨¡å¼">

```mermaid
sequenceDiagram
    participant C as Client
    participant Q1 as Request Queue
    participant S as Server
    participant Q2 as Reply Queue
    
    C->>Q1: å‘é€è¯·æ±‚æ¶ˆæ¯
    Q1->>S: æ¶ˆè´¹è¯·æ±‚
    S->>Q2: å‘é€å“åº”æ¶ˆæ¯
    Q2->>C: æ¥æ”¶å“åº”
```

**è¯·æ±‚å“åº”æ¨¡å¼ç‰¹ç‚¹**ï¼š
- æ”¯æŒåŒæ­¥å’Œå¼‚æ­¥è°ƒç”¨
- éœ€è¦å…³è”è¯·æ±‚å’Œå“åº”
- æ”¯æŒè¶…æ—¶å’Œé‡è¯•æœºåˆ¶
- é€‚ç”¨äºRPCè°ƒç”¨ã€æœåŠ¡é€šä¿¡åœºæ™¯

</TabItem>
</Tabs>
## 2
. ä¸»æµæ¶ˆæ¯é˜Ÿåˆ—æŠ€æœ¯å¯¹æ¯”

### 2.1 æŠ€æœ¯é€‰å‹å¯¹æ¯”çŸ©é˜µ

| ç‰¹æ€§å¯¹æ¯” | Apache Kafka | RabbitMQ | Apache RocketMQ | Apache Pulsar | Redis Streams |
|---------|-------------|----------|----------------|---------------|---------------|
| **ååé‡** | â­â­â­â­â­ | â­â­â­ | â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ |
| **å»¶è¿Ÿ** | â­â­â­ | â­â­â­â­ | â­â­â­â­ | â­â­â­ | â­â­â­â­â­ |
| **å¯é æ€§** | â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ | â­â­â­ |
| **æ‰©å±•æ€§** | â­â­â­â­â­ | â­â­â­ | â­â­â­â­ | â­â­â­â­â­ | â­â­â­ |
| **è¿ç»´å¤æ‚åº¦** | â­â­ | â­â­â­â­ | â­â­â­ | â­â­ | â­â­â­â­â­ |
| **ç”Ÿæ€æˆç†Ÿåº¦** | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ | â­â­â­ | â­â­â­â­ |

<Tabs>
<TabItem value="kafka" label="Apache Kafka">

**æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- è¶…é«˜ååé‡ï¼Œå•æœºå¯è¾¾ç™¾ä¸‡TPS
- åˆ†å¸ƒå¼æ¶æ„ï¼Œæ”¯æŒæ°´å¹³æ‰©å±•
- æŒä¹…åŒ–å­˜å‚¨ï¼Œæ”¯æŒæ•°æ®å›æº¯
- ä¸°å¯Œçš„ç”Ÿæ€ç³»ç»Ÿå’Œå·¥å…·é“¾

**é€‚ç”¨åœºæ™¯**ï¼š
- å¤§æ•°æ®å®æ—¶å¤„ç†
- æ—¥å¿—æ”¶é›†å’Œåˆ†æ
- äº‹ä»¶æµå¤„ç†
- å¾®æœåŠ¡é—´é€šä¿¡

**æŠ€æœ¯ç‰¹ç‚¹**ï¼š
```bash
# Kafkaæ ¸å¿ƒæ¦‚å¿µ
Topic: æ¶ˆæ¯ä¸»é¢˜åˆ†ç±»
Partition: åˆ†åŒºå¹¶è¡Œå¤„ç†
Consumer Group: æ¶ˆè´¹è€…ç»„è´Ÿè½½å‡è¡¡
Offset: æ¶ˆæ¯ä½ç§»ç®¡ç†
```

</TabItem>
<TabItem value="rabbitmq" label="RabbitMQ">

**æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- çµæ´»çš„è·¯ç”±æœºåˆ¶ï¼ˆ4ç§äº¤æ¢æœºç±»å‹ï¼‰
- å®Œå–„çš„æ¶ˆæ¯ç¡®è®¤å’ŒæŒä¹…åŒ–
- æ˜“äºä½¿ç”¨çš„ç®¡ç†ç•Œé¢
- å¼ºå¤§çš„é›†ç¾¤å’Œé«˜å¯ç”¨æ”¯æŒ

**é€‚ç”¨åœºæ™¯**ï¼š
- ä¼ä¸šçº§åº”ç”¨é›†æˆ
- å¤æ‚çš„æ¶ˆæ¯è·¯ç”±
- å¯é æ€§è¦æ±‚é«˜çš„åœºæ™¯
- ä¼ ç»Ÿä¼ä¸šæ¶æ„

**æŠ€æœ¯ç‰¹ç‚¹**ï¼š
```bash
# RabbitMQæ ¸å¿ƒæ¦‚å¿µ
Exchange: æ¶ˆæ¯äº¤æ¢æœºè·¯ç”±
Queue: æ¶ˆæ¯é˜Ÿåˆ—å­˜å‚¨
Binding: ç»‘å®šå…³ç³»å®šä¹‰
Virtual Host: è™šæ‹Ÿä¸»æœºéš”ç¦»
```

</TabItem>
<TabItem value="rocketmq" label="Apache RocketMQ">

**æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- é‡‘èçº§å¯é æ€§ä¿éšœ
- æ”¯æŒäº‹åŠ¡æ¶ˆæ¯
- é¡ºåºæ¶ˆæ¯å’Œå»¶è¿Ÿæ¶ˆæ¯
- ä¸‡äº¿çº§æ¶ˆæ¯å †ç§¯èƒ½åŠ›

**é€‚ç”¨åœºæ™¯**ï¼š
- é‡‘èæ”¯ä»˜ç³»ç»Ÿ
- ç”µå•†äº¤æ˜“å¹³å°
- åˆ†å¸ƒå¼äº‹åŠ¡åœºæ™¯
- é«˜å¯é æ€§è¦æ±‚

**æŠ€æœ¯ç‰¹ç‚¹**ï¼š
```bash
# RocketMQæ ¸å¿ƒæ¦‚å¿µ
NameServer: è·¯ç”±æ³¨å†Œä¸­å¿ƒ
Broker: æ¶ˆæ¯å­˜å‚¨æœåŠ¡
Producer: æ¶ˆæ¯ç”Ÿäº§è€…
Consumer: æ¶ˆæ¯æ¶ˆè´¹è€…
```

</TabItem>
</Tabs>

### 2.2 é€‰å‹å†³ç­–æ ‘

```mermaid
graph TD
    A[æ¶ˆæ¯é˜Ÿåˆ—é€‰å‹] --> B{ååé‡è¦æ±‚}
    B -->|è¶…é«˜åå| C{å»¶è¿Ÿè¦æ±‚}
    B -->|ä¸­ç­‰åå| D{è·¯ç”±å¤æ‚åº¦}
    B -->|ä½åå| E[Redis Streams]
    
    C -->|å¯æ¥å—| F[Apache Kafka]
    C -->|ä½å»¶è¿Ÿ| G[Apache Pulsar]
    
    D -->|å¤æ‚è·¯ç”±| H[RabbitMQ]
    D -->|ç®€å•è·¯ç”±| I{å¯é æ€§è¦æ±‚}
    
    I -->|é‡‘èçº§| J[Apache RocketMQ]
    I -->|ä¸€èˆ¬| K[Apache Kafka]
    
    F --> L[å¤§æ•°æ®/æµå¤„ç†]
    G --> M[å®æ—¶è®¡ç®—]
    H --> N[ä¼ä¸šé›†æˆ]
    J --> O[é‡‘èæ”¯ä»˜]
    K --> P[å¾®æœåŠ¡é€šä¿¡]
    E --> Q[è½»é‡çº§åœºæ™¯]
```

## 3. æ¶ˆæ¯é˜Ÿåˆ—æ ¸å¿ƒæœºåˆ¶

### 3.1 æ¶ˆæ¯å¯é æ€§ä¿éšœ

<Tabs>
<TabItem value="producer-reliability" label="ç”Ÿäº§è€…å¯é æ€§">

**ç”Ÿäº§è€…ç«¯ä¿éšœæœºåˆ¶**ï¼š

1. **æ¶ˆæ¯ç¡®è®¤æœºåˆ¶**
```java
// Kafkaç”Ÿäº§è€…ç¡®è®¤
Properties props = new Properties();
props.put("acks", "all"); // ç­‰å¾…æ‰€æœ‰å‰¯æœ¬ç¡®è®¤
props.put("retries", 3);  // é‡è¯•æ¬¡æ•°
props.put("enable.idempotence", true); // å¹‚ç­‰æ€§

// RabbitMQç”Ÿäº§è€…ç¡®è®¤
rabbitTemplate.setConfirmCallback((correlationData, ack, cause) -> {
    if (ack) {
        log.info("æ¶ˆæ¯å‘é€æˆåŠŸ");
    } else {
        log.error("æ¶ˆæ¯å‘é€å¤±è´¥: {}", cause);
    }
});
```

2. **äº‹åŠ¡æ”¯æŒ**
```java
// RocketMQäº‹åŠ¡æ¶ˆæ¯
TransactionMQProducer producer = new TransactionMQProducer();
producer.setTransactionListener(new TransactionListener() {
    @Override
    public LocalTransactionState executeLocalTransaction(Message msg, Object arg) {
        // æ‰§è¡Œæœ¬åœ°äº‹åŠ¡
        return LocalTransactionState.COMMIT_MESSAGE;
    }
    
    @Override
    public LocalTransactionState checkLocalTransaction(MessageExt msg) {
        // äº‹åŠ¡çŠ¶æ€å›æŸ¥
        return LocalTransactionState.COMMIT_MESSAGE;
    }
});
```

</TabItem>
<TabItem value="broker-reliability" label="ä»£ç†å¯é æ€§">

**æ¶ˆæ¯ä»£ç†ä¿éšœæœºåˆ¶**ï¼š

1. **æŒä¹…åŒ–å­˜å‚¨**
```bash
# KafkaæŒä¹…åŒ–é…ç½®
log.retention.hours=168        # ä¿ç•™7å¤©
log.segment.bytes=1073741824   # 1GBåˆ†æ®µ
log.flush.interval.messages=10000

# RabbitMQæŒä¹…åŒ–é…ç½®
durable=true                   # é˜Ÿåˆ—æŒä¹…åŒ–
delivery_mode=2                # æ¶ˆæ¯æŒä¹…åŒ–
```

2. **å‰¯æœ¬æœºåˆ¶**
```bash
# Kafkaå‰¯æœ¬é…ç½®
default.replication.factor=3   # 3ä¸ªå‰¯æœ¬
min.insync.replicas=2         # æœ€å°‘2ä¸ªåŒæ­¥å‰¯æœ¬

# RocketMQä¸»ä»é…ç½®
brokerRole=SYNC_MASTER        # åŒæ­¥ä¸»èŠ‚ç‚¹
flushDiskType=SYNC_FLUSH      # åŒæ­¥åˆ·ç›˜
```

</TabItem>
<TabItem value="consumer-reliability" label="æ¶ˆè´¹è€…å¯é æ€§">

**æ¶ˆè´¹è€…ç«¯ä¿éšœæœºåˆ¶**ï¼š

1. **æ¶ˆæ¯ç¡®è®¤**
```java
// Kafkaæ‰‹åŠ¨æäº¤
@KafkaListener(topics = "test-topic")
public void listen(ConsumerRecord<String, String> record, 
                   Acknowledgment ack) {
    try {
        // å¤„ç†æ¶ˆæ¯
        processMessage(record.value());
        // æ‰‹åŠ¨ç¡®è®¤
        ack.acknowledge();
    } catch (Exception e) {
        // å¤„ç†å¤±è´¥ï¼Œä¸ç¡®è®¤
        log.error("æ¶ˆæ¯å¤„ç†å¤±è´¥", e);
    }
}

// RabbitMQæ‰‹åŠ¨ç¡®è®¤
@RabbitListener(queues = "test.queue", ackMode = "MANUAL")
public void handleMessage(String message, Channel channel, 
                         @Header(AmqpHeaders.DELIVERY_TAG) long tag) {
    try {
        processMessage(message);
        channel.basicAck(tag, false);
    } catch (Exception e) {
        channel.basicNack(tag, false, true); // é‡æ–°å…¥é˜Ÿ
    }
}
```

2. **é‡è¯•æœºåˆ¶**
```java
// Spring Retryé…ç½®
@Retryable(value = {Exception.class}, maxAttempts = 3, 
           backoff = @Backoff(delay = 1000, multiplier = 2))
public void processMessage(String message) {
    // æ¶ˆæ¯å¤„ç†é€»è¾‘
}

@Recover
public void recover(Exception ex, String message) {
    // é‡è¯•å¤±è´¥åçš„å¤„ç†
    log.error("æ¶ˆæ¯å¤„ç†æœ€ç»ˆå¤±è´¥: {}", message, ex);
}
```

</TabItem>
</Tabs>

### 3.2 æ¶ˆæ¯é¡ºåºæ€§ä¿éšœ

<Tabs>
<TabItem value="global-order" label="å…¨å±€é¡ºåº">

**å…¨å±€é¡ºåºæ¶ˆæ¯**ï¼š
- æ‰€æœ‰æ¶ˆæ¯ä¸¥æ ¼æŒ‰ç…§å‘é€é¡ºåºæ¶ˆè´¹
- æ€§èƒ½è¾ƒä½ï¼Œé€‚ç”¨äºå¯¹é¡ºåºè¦æ±‚æé«˜çš„åœºæ™¯
- å®ç°æ–¹å¼ï¼šå•åˆ†åŒºã€å•æ¶ˆè´¹è€…

```mermaid
graph LR
    P[Producer] --> Q[Single Queue]
    Q --> C[Single Consumer]
    
    subgraph "æ¶ˆæ¯é¡ºåº"
        M1[Message 1] --> M2[Message 2]
        M2 --> M3[Message 3]
        M3 --> M4[Message 4]
    end
```

</TabItem>
<TabItem value="partition-order" label="åˆ†åŒºé¡ºåº">

**åˆ†åŒºé¡ºåºæ¶ˆæ¯**ï¼š
- åŒä¸€åˆ†åŒºå†…æ¶ˆæ¯æœ‰åº
- ä¸åŒåˆ†åŒºé—´æ¶ˆæ¯å¯å¹¶è¡Œå¤„ç†
- å¹³è¡¡äº†æ€§èƒ½å’Œé¡ºåºæ€§è¦æ±‚

```mermaid
graph TB
    P[Producer] --> PS[Partition Selector]
    PS --> Q1[Partition 0<br/>User A Messages]
    PS --> Q2[Partition 1<br/>User B Messages]
    PS --> Q3[Partition 2<br/>User C Messages]
    
    Q1 --> C1[Consumer 1]
    Q2 --> C2[Consumer 2]
    Q3 --> C3[Consumer 3]
```

**åˆ†åŒºé€‰æ‹©ç­–ç•¥**ï¼š
```java
// Kafkaåˆ†åŒºé€‰æ‹©
public class OrderPartitioner implements Partitioner {
    @Override
    public int partition(String topic, Object key, byte[] keyBytes,
                        Object value, byte[] valueBytes, Cluster cluster) {
        // æ ¹æ®è®¢å•IDé€‰æ‹©åˆ†åŒº
        String orderId = (String) key;
        return Math.abs(orderId.hashCode()) % cluster.partitionCountForTopic(topic);
    }
}

// RocketMQé˜Ÿåˆ—é€‰æ‹©
MessageQueueSelector selector = new MessageQueueSelector() {
    @Override
    public MessageQueue select(List<MessageQueue> mqs, Message msg, Object arg) {
        String orderId = (String) arg;
        int index = Math.abs(orderId.hashCode()) % mqs.size();
        return mqs.get(index);
    }
};
```

</TabItem>
</Tabs>

## 4. ä¼ä¸šçº§æœ€ä½³å®è·µ

### 4.1 æ¶æ„è®¾è®¡åŸåˆ™

:::tip è®¾è®¡åŸåˆ™
1. **ä¸šåŠ¡éš”ç¦»**ï¼šä¸åŒä¸šåŠ¡ä½¿ç”¨ä¸åŒçš„Topic/Queue
2. **å®¹é‡è§„åˆ’**ï¼šåˆç†è¯„ä¼°æ¶ˆæ¯é‡å’Œå­˜å‚¨éœ€æ±‚
3. **ç›‘æ§å‘Šè­¦**ï¼šå®Œå–„çš„ç›‘æ§ä½“ç³»å’Œå‘Šè­¦æœºåˆ¶
4. **å®¹ç¾å¤‡ä»½**ï¼šè·¨æœºæˆ¿éƒ¨ç½²å’Œæ•°æ®å¤‡ä»½ç­–ç•¥
5. **æ€§èƒ½ä¼˜åŒ–**ï¼šæ‰¹é‡å¤„ç†å’Œè¿æ¥æ± ä¼˜åŒ–
:::

<Tabs>
<TabItem value="topic-design" label="ä¸»é¢˜è®¾è®¡">

**ä¸»é¢˜å‘½åè§„èŒƒ**ï¼š
```bash
# ç¯å¢ƒ.ä¸šåŠ¡åŸŸ.æ•°æ®ç±»å‹.ç‰ˆæœ¬
prod.order.events.v1
prod.payment.notifications.v1
prod.user.activities.v2

# æŒ‰æ•°æ®æµå‘å‘½å
mysql-to-es.user-profiles
app-to-analytics.click-events
crm-to-warehouse.customer-data
```

**åˆ†åŒºç­–ç•¥**ï¼š
```java
// åŸºäºä¸šåŠ¡é”®åˆ†åŒº
public class BusinessKeyPartitioner implements Partitioner {
    @Override
    public int partition(String topic, Object key, byte[] keyBytes,
                        Object value, byte[] valueBytes, Cluster cluster) {
        if (key == null) {
            return 0; // é»˜è®¤åˆ†åŒº
        }
        
        // æ ¹æ®ä¸šåŠ¡é”®è®¡ç®—åˆ†åŒº
        String businessKey = extractBusinessKey((String) key);
        return Math.abs(businessKey.hashCode()) % cluster.partitionCountForTopic(topic);
    }
    
    private String extractBusinessKey(String key) {
        // æå–ä¸šåŠ¡é”®é€»è¾‘ï¼Œå¦‚ç”¨æˆ·IDã€è®¢å•IDç­‰
        return key.split(":")[0];
    }
}
```

</TabItem>
<TabItem value="error-handling" label="å¼‚å¸¸å¤„ç†">

**æ­»ä¿¡é˜Ÿåˆ—æœºåˆ¶**ï¼š
```java
@Component
public class MessageErrorHandler {
    
    private static final int MAX_RETRY_COUNT = 3;
    
    @RabbitListener(queues = "business.queue")
    public void handleMessage(String message, 
                             @Header Map<String, Object> headers,
                             Channel channel,
                             @Header(AmqpHeaders.DELIVERY_TAG) long deliveryTag) {
        try {
            processMessage(message);
            channel.basicAck(deliveryTag, false);
        } catch (BusinessException e) {
            // ä¸šåŠ¡å¼‚å¸¸ï¼Œå‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ—
            sendToDeadLetterQueue(message, e.getMessage());
            channel.basicAck(deliveryTag, false);
        } catch (Exception e) {
            // ç³»ç»Ÿå¼‚å¸¸ï¼Œé‡è¯•å¤„ç†
            handleRetry(message, headers, channel, deliveryTag, e);
        }
    }
    
    private void handleRetry(String message, Map<String, Object> headers,
                           Channel channel, long deliveryTag, Exception e) {
        Integer retryCount = (Integer) headers.getOrDefault("x-retry-count", 0);
        
        if (retryCount < MAX_RETRY_COUNT) {
            // å¢åŠ é‡è¯•æ¬¡æ•°å¹¶é‡æ–°å‘é€
            retryCount++;
            sendWithRetryCount(message, retryCount);
            channel.basicAck(deliveryTag, false);
        } else {
            // è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œå‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ—
            sendToDeadLetterQueue(message, "è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°");
            channel.basicAck(deliveryTag, false);
        }
    }
}
```

**ç†”æ–­é™çº§**ï¼š
```java
@Component
public class MessageCircuitBreaker {
    
    private final CircuitBreaker circuitBreaker;
    
    public MessageCircuitBreaker() {
        this.circuitBreaker = CircuitBreaker.ofDefaults("messageProcessor");
        circuitBreaker.getEventPublisher()
            .onStateTransition(event -> 
                log.info("ç†”æ–­å™¨çŠ¶æ€å˜æ›´: {}", event));
    }
    
    @EventListener
    public void handleMessage(MessageEvent event) {
        Supplier<Void> decoratedSupplier = CircuitBreaker
            .decorateSupplier(circuitBreaker, () -> {
                processMessage(event.getMessage());
                return null;
            });
        
        Try.ofSupplier(decoratedSupplier)
            .recover(throwable -> {
                log.error("æ¶ˆæ¯å¤„ç†å¤±è´¥ï¼Œç†”æ–­å™¨å¼€å¯", throwable);
                handleFallback(event.getMessage());
                return null;
            });
    }
    
    private void handleFallback(String message) {
        // é™çº§å¤„ç†é€»è¾‘
        log.info("æ‰§è¡Œé™çº§å¤„ç†: {}", message);
    }
}
```

</TabItem>
<TabItem value="monitoring" label="ç›‘æ§å‘Šè­¦">

**å…³é”®ç›‘æ§æŒ‡æ ‡**ï¼š
```java
@Component
public class MessageQueueMonitor {
    
    private final MeterRegistry meterRegistry;
    private final Counter messageProducedCounter;
    private final Counter messageConsumedCounter;
    private final Timer messageProcessingTimer;
    private final Gauge queueSizeGauge;
    
    public MessageQueueMonitor(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        this.messageProducedCounter = Counter.builder("mq.message.produced")
            .description("ç”Ÿäº§æ¶ˆæ¯æ•°é‡")
            .register(meterRegistry);
        this.messageConsumedCounter = Counter.builder("mq.message.consumed")
            .description("æ¶ˆè´¹æ¶ˆæ¯æ•°é‡")
            .register(meterRegistry);
        this.messageProcessingTimer = Timer.builder("mq.message.processing.time")
            .description("æ¶ˆæ¯å¤„ç†æ—¶é—´")
            .register(meterRegistry);
    }
    
    public void recordMessageProduced(String topic) {
        messageProducedCounter.increment(Tags.of("topic", topic));
    }
    
    public void recordMessageConsumed(String topic, long processingTime) {
        messageConsumedCounter.increment(Tags.of("topic", topic));
        messageProcessingTimer.record(processingTime, TimeUnit.MILLISECONDS);
    }
    
    @Scheduled(fixedRate = 60000) // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    public void checkQueueHealth() {
        // æ£€æŸ¥é˜Ÿåˆ—å †ç§¯æƒ…å†µ
        Map<String, Long> queueSizes = getQueueSizes();
        
        for (Map.Entry<String, Long> entry : queueSizes.entrySet()) {
            String queueName = entry.getKey();
            Long queueSize = entry.getValue();
            
            // æ›´æ–°é˜Ÿåˆ—å¤§å°æŒ‡æ ‡
            Gauge.builder("mq.queue.size")
                .description("é˜Ÿåˆ—æ¶ˆæ¯æ•°é‡")
                .tags("queue", queueName)
                .register(meterRegistry, queueSize);
            
            // å‘Šè­¦æ£€æŸ¥
            if (queueSize > 10000) {
                sendAlert("é˜Ÿåˆ—å †ç§¯å‘Šè­¦", 
                    String.format("é˜Ÿåˆ— %s æ¶ˆæ¯å †ç§¯: %d", queueName, queueSize));
            }
        }
    }
    
    private Map<String, Long> getQueueSizes() {
        // å®ç°è·å–é˜Ÿåˆ—å¤§å°çš„é€»è¾‘
        return new HashMap<>();
    }
    
    private void sendAlert(String title, String message) {
        log.error("å‘Šè­¦: {} - {}", title, message);
        // å‘é€å‘Šè­¦é€šçŸ¥
    }
}
```

**å‘Šè­¦è§„åˆ™é…ç½®**ï¼š
```yaml
# Prometheuså‘Šè­¦è§„åˆ™
groups:
  - name: message_queue_alerts
    rules:
      - alert: MessageQueueLag
        expr: mq_queue_size > 10000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "æ¶ˆæ¯é˜Ÿåˆ—å †ç§¯å‘Šè­¦"
          description: "é˜Ÿåˆ— {{ $labels.queue }} æ¶ˆæ¯å †ç§¯è¶…è¿‡10000æ¡"
      
      - alert: MessageProcessingError
        expr: rate(mq_message_error_total[5m]) > 0.1
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "æ¶ˆæ¯å¤„ç†é”™è¯¯ç‡è¿‡é«˜"
          description: "æ¶ˆæ¯å¤„ç†é”™è¯¯ç‡è¶…è¿‡10%"
```

</TabItem>
</Tabs>

## 5. æ€»ç»“ä¸å±•æœ›

### 5.1 æŠ€æœ¯é€‰å‹å»ºè®®

```mermaid
graph TD
    A[ä¸šåŠ¡åœºæ™¯åˆ†æ] --> B{æ•°æ®é‡çº§}
    B -->|TBçº§ä»¥ä¸Š| C[Apache Kafka]
    B -->|GBçº§| D{å¯é æ€§è¦æ±‚}
    B -->|MBçº§| E[Redis Streams]
    
    D -->|é‡‘èçº§| F[Apache RocketMQ]
    D -->|ä¼ä¸šçº§| G[RabbitMQ]
    D -->|äº’è”ç½‘çº§| H[Apache Kafka]
    
    C --> I[å¤§æ•°æ®ç”Ÿæ€]
    F --> J[é‡‘èæ”¯ä»˜]
    G --> K[ä¼ä¸šé›†æˆ]
    H --> L[å¾®æœåŠ¡æ¶æ„]
    E --> M[è½»é‡çº§åº”ç”¨]
```

### 5.2 å‘å±•è¶‹åŠ¿

**äº‘åŸç”Ÿæ¶ˆæ¯é˜Ÿåˆ—**ï¼š
- KubernetesåŸç”Ÿæ”¯æŒ
- è‡ªåŠ¨æ‰©ç¼©å®¹èƒ½åŠ›
- å¤šäº‘éƒ¨ç½²æ”¯æŒ
- Serverlessæ¶ˆæ¯æœåŠ¡

**æ™ºèƒ½åŒ–è¿ç»´**ï¼š
- AIé©±åŠ¨çš„æ€§èƒ½ä¼˜åŒ–
- è‡ªåŠ¨æ•…éšœæ£€æµ‹å’Œæ¢å¤
- æ™ºèƒ½å®¹é‡è§„åˆ’
- é¢„æµ‹æ€§ç»´æŠ¤

**è¾¹ç¼˜è®¡ç®—æ”¯æŒ**ï¼š
- è¾¹ç¼˜èŠ‚ç‚¹æ¶ˆæ¯å¤„ç†
- è¾¹äº‘ååŒæ¶ˆæ¯ä¼ é€’
- ä½å»¶è¿Ÿæ¶ˆæ¯è·¯ç”±
- ç¦»çº¿æ¶ˆæ¯åŒæ­¥

:::tip å­¦ä¹ å»ºè®®
1. **ç†è®ºåŸºç¡€**ï¼šæ·±å…¥ç†è§£æ¶ˆæ¯é˜Ÿåˆ—çš„åŸºæœ¬åŸç†å’Œè®¾è®¡æ¨¡å¼
2. **æŠ€æœ¯å®è·µ**ï¼šåŠ¨æ‰‹å®è·µä¸åŒæ¶ˆæ¯é˜Ÿåˆ—çš„éƒ¨ç½²å’Œä½¿ç”¨
3. **åœºæ™¯åº”ç”¨**ï¼šç»“åˆå…·ä½“ä¸šåŠ¡åœºæ™¯é€‰æ‹©åˆé€‚çš„æŠ€æœ¯æ–¹æ¡ˆ
4. **æ€§èƒ½ä¼˜åŒ–**ï¼šæŒæ¡æ€§èƒ½è°ƒä¼˜å’Œæ•…éšœæ’æŸ¥æŠ€èƒ½
5. **æ¶æ„è®¾è®¡**ï¼šå­¦ä¹ å¤§è§„æ¨¡åˆ†å¸ƒå¼æ¶ˆæ¯ç³»ç»Ÿçš„æ¶æ„è®¾è®¡
:::

---

æ¶ˆæ¯é˜Ÿåˆ—ä½œä¸ºåˆ†å¸ƒå¼ç³»ç»Ÿçš„æ ¸å¿ƒåŸºç¡€è®¾æ–½ï¼Œåœ¨ç°ä»£è½¯ä»¶æ¶æ„ä¸­å‘æŒ¥ç€è¶Šæ¥è¶Šé‡è¦çš„ä½œç”¨ã€‚é€šè¿‡åˆç†çš„æŠ€æœ¯é€‰å‹ã€æ¶æ„è®¾è®¡å’Œè¿ç»´ç®¡ç†ï¼Œå¯ä»¥æ„å»ºé«˜å¯ç”¨ã€é«˜æ€§èƒ½ã€å¯æ‰©å±•çš„æ¶ˆæ¯ç³»ç»Ÿï¼Œä¸ºä¸šåŠ¡å‘å±•æä¾›å¼ºæœ‰åŠ›çš„æŠ€æœ¯æ”¯æ’‘ã€‚