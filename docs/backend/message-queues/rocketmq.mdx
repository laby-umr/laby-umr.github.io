---
sidebar_position: 3
title: RocketMQåˆ†å¸ƒå¼æ¶ˆæ¯ç³»ç»Ÿè¯¦è§£
description: æ·±å…¥ç†è§£RocketMQæ¶æ„åŸç†ã€äº‹åŠ¡æ¶ˆæ¯ã€é¡ºåºæ¶ˆæ¯ä¸é«˜æ€§èƒ½é›†ç¾¤éƒ¨ç½²å®è·µ
authors: [Laby]
tags: [RocketMQ, æ¶ˆæ¯é˜Ÿåˆ—, åˆ†å¸ƒå¼äº‹åŠ¡, é¡ºåºæ¶ˆæ¯, é˜¿é‡Œå·´å·´, é«˜å¯ç”¨, é‡‘èçº§]
last_update:
  date: 2025-08-12
  author: Laby
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import CodeBlock from '@theme/CodeBlock';

# RocketMQåˆ†å¸ƒå¼æ¶ˆæ¯ç³»ç»Ÿè¯¦è§£

Apache RocketMQæ˜¯é˜¿é‡Œå·´å·´å¼€æºçš„åˆ†å¸ƒå¼æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œç»è¿‡åŒ11ç­‰å¤§è§„æ¨¡åœºæ™¯éªŒè¯ï¼Œå…·æœ‰é«˜æ€§èƒ½ã€é«˜å¯é æ€§ã€é«˜å®æ—¶æ€§çš„åˆ†å¸ƒå¼ç‰¹æ€§ã€‚RocketMQåœ¨äº‹åŠ¡æ¶ˆæ¯ã€é¡ºåºæ¶ˆæ¯ã€å»¶è¿Ÿæ¶ˆæ¯ç­‰æ–¹é¢æœ‰ç€ç‹¬ç‰¹ä¼˜åŠ¿ï¼Œæ˜¯é‡‘èçº§åˆ†å¸ƒå¼æ¶ˆæ¯è§£å†³æ–¹æ¡ˆçš„é¦–é€‰ã€‚

:::tip æ ¸å¿ƒä»·å€¼
**RocketMQ = é‡‘èçº§å¯é æ€§ + ä¸‡äº¿çº§æ¶ˆæ¯å †ç§¯ + æ¯«ç§’çº§å»¶è¿Ÿ + åˆ†å¸ƒå¼äº‹åŠ¡**
- ğŸ’° **é‡‘èçº§å¯é æ€§**ï¼š99.996%è¶…é«˜å¯ç”¨æ€§ï¼Œæ”¯æŒåˆ†å¸ƒå¼äº‹åŠ¡
- ğŸ“ˆ **ä¸‡äº¿çº§å †ç§¯**ï¼šæ”¯æŒä¸‡äº¿çº§æ¶ˆæ¯å †ç§¯ï¼Œä¸å½±å“æ€§èƒ½
- âš¡ **æ¯«ç§’çº§å»¶è¿Ÿ**ï¼šç«¯åˆ°ç«¯å»¶è¿Ÿåœ¨æ¯«ç§’çº§åˆ«
- ğŸ”„ **åˆ†å¸ƒå¼äº‹åŠ¡**ï¼šå®Œæ•´çš„äº‹åŠ¡æ¶ˆæ¯è§£å†³æ–¹æ¡ˆ
- ğŸ“Š **é¡ºåºæ¶ˆæ¯**ï¼šæ”¯æŒå…¨å±€å’Œåˆ†åŒºé¡ºåºæ¶ˆæ¯
- â° **å»¶è¿Ÿæ¶ˆæ¯**ï¼šæ”¯æŒ18ä¸ªå»¶è¿Ÿç­‰çº§çš„å®šæ—¶æ¶ˆæ¯
:::

## 1. RocketMQæ ¸å¿ƒæ¶æ„ä¸è®¾è®¡ç†å¿µ

### 1.1 åˆ†å¸ƒå¼æ¶æ„æ¨¡å‹

RocketMQé‡‡ç”¨åˆ†å¸ƒå¼é›†ç¾¤æ¶æ„ï¼Œé€šè¿‡å¤šä¸ªç»„ä»¶ååŒå·¥ä½œï¼Œæä¾›é«˜æ€§èƒ½ã€é«˜å¯é çš„æ¶ˆæ¯æœåŠ¡ã€‚

```mermaid
graph TB
    subgraph "RocketMQåˆ†å¸ƒå¼æ¶æ„"
        NS1[NameServer 1] 
        NS2[NameServer 2]
        NS3[NameServer 3]
        
        subgraph "Brokeré›†ç¾¤"
            BM1[Broker Master 1]
            BS1[Broker Slave 1]
            BM2[Broker Master 2] 
            BS2[Broker Slave 2]
        end
        
        P1[Producer 1] --> NS1
        P2[Producer 2] --> NS2
        P1 --> BM1
        P2 --> BM2
        
        BM1 --> BS1
        BM2 --> BS2
        
        C1[Consumer Group A] --> NS3
        C2[Consumer Group B] --> NS1
        C1 --> BM1
        C2 --> BM2
    end
```

#### æ ¸å¿ƒç»„ä»¶è¯¦è§£

| ç»„ä»¶ | ä½œç”¨ | ç‰¹ç‚¹ | éƒ¨ç½²å»ºè®® |
|------|------|------|----------|
| **NameServer** | è·¯ç”±æ³¨å†Œä¸­å¿ƒ | æ— çŠ¶æ€ã€è½»é‡çº§ | é›†ç¾¤éƒ¨ç½²ï¼Œå¥‡æ•°ä¸ªèŠ‚ç‚¹ |
| **Broker** | æ¶ˆæ¯å­˜å‚¨è½¬å‘ | æ”¯æŒä¸»ä»ã€é«˜å¯ç”¨ | ä¸»ä»éƒ¨ç½²ï¼Œæ•°æ®åŒæ­¥ |
| **Producer** | æ¶ˆæ¯ç”Ÿäº§è€… | è´Ÿè½½å‡è¡¡ã€æ•…éšœè½¬ç§» | é›†æˆåˆ°ä¸šåŠ¡åº”ç”¨ |
| **Consumer** | æ¶ˆæ¯æ¶ˆè´¹è€… | æ¨æ‹‰æ¨¡å¼ã€é›†ç¾¤æ¶ˆè´¹ | ç‹¬ç«‹éƒ¨ç½²æˆ–é›†æˆ |### 1.2 
RocketMQåº”ç”¨åœºæ™¯å¯¹æ¯”

| åº”ç”¨åœºæ™¯ | ä¼ ç»Ÿæ–¹æ¡ˆ | RocketMQæ–¹æ¡ˆ | æ ¸å¿ƒä¼˜åŠ¿ | é€‚ç”¨è§„æ¨¡ |
|---------|---------|-------------|----------|---------|
| **åˆ†å¸ƒå¼äº‹åŠ¡** | 2PC/3PC | äº‹åŠ¡æ¶ˆæ¯ | æœ€ç»ˆä¸€è‡´æ€§ã€é«˜æ€§èƒ½ | é‡‘èæ”¯ä»˜ |
| **é¡ºåºå¤„ç†** | å•çº¿ç¨‹å¤„ç† | é¡ºåºæ¶ˆæ¯ | é«˜å¹¶å‘ã€ä¿åº | è®¢å•çŠ¶æ€æµè½¬ |
| **å»¶è¿Ÿä»»åŠ¡** | å®šæ—¶ä»»åŠ¡ | å»¶è¿Ÿæ¶ˆæ¯ | ç²¾ç¡®å»¶è¿Ÿã€é«˜å¯é  | å®šæ—¶æé†’ |
| **æ¶ˆæ¯å †ç§¯** | æ•°æ®åº“å­˜å‚¨ | ç£ç›˜å­˜å‚¨ | ä¸‡äº¿çº§å †ç§¯èƒ½åŠ› | å¤§æ•°æ®åœºæ™¯ |
| **å¹¿æ’­é€šçŸ¥** | æ¨é€æœåŠ¡ | å¹¿æ’­æ¶ˆè´¹ | ä¸€å¯¹å¤šã€å®æ—¶æ€§ | é…ç½®æ›´æ–° |

## 2. äº‹åŠ¡æ¶ˆæ¯æ·±åº¦è§£æ

### 2.1 åˆ†å¸ƒå¼äº‹åŠ¡åŸç†

RocketMQçš„äº‹åŠ¡æ¶ˆæ¯åŸºäºä¸¤é˜¶æ®µæäº¤åè®®ï¼Œé€šè¿‡åŠæ¶ˆæ¯æœºåˆ¶ç¡®ä¿æœ¬åœ°äº‹åŠ¡ä¸æ¶ˆæ¯å‘é€çš„æœ€ç»ˆä¸€è‡´æ€§ã€‚

<Tabs>
<TabItem value="transaction-flow" label="äº‹åŠ¡æµç¨‹">

```mermaid
sequenceDiagram
    participant P as Producer
    participant B as Broker
    participant C as Consumer
    participant DB as Database
    
    P->>B: 1. å‘é€åŠæ¶ˆæ¯(Half Message)
    B-->>P: 2. åŠæ¶ˆæ¯å‘é€æˆåŠŸ
    P->>DB: 3. æ‰§è¡Œæœ¬åœ°äº‹åŠ¡
    DB-->>P: 4. äº‹åŠ¡æ‰§è¡Œç»“æœ
    
    alt äº‹åŠ¡æˆåŠŸ
        P->>B: 5a. æäº¤æ¶ˆæ¯(Commit)
        B->>C: 6a. æ¶ˆæ¯å¯è§ï¼Œå¼€å§‹æ¶ˆè´¹
    else äº‹åŠ¡å¤±è´¥
        P->>B: 5b. å›æ»šæ¶ˆæ¯(Rollback)
        B->>B: 6b. åˆ é™¤åŠæ¶ˆæ¯
    else çŠ¶æ€æœªçŸ¥
        B->>P: 5c. äº‹åŠ¡å›æŸ¥(Check)
        P->>DB: 6c. æŸ¥è¯¢äº‹åŠ¡çŠ¶æ€
        DB-->>P: 7c. è¿”å›äº‹åŠ¡çŠ¶æ€
        P->>B: 8c. è¿”å›æœ€ç»ˆå†³å®š
    end
```

**äº‹åŠ¡æ¶ˆæ¯ç‰¹ç‚¹**ï¼š
- **ä¸¤é˜¶æ®µæäº¤**ï¼šå…ˆå‘é€åŠæ¶ˆæ¯ï¼Œå†æ ¹æ®æœ¬åœ°äº‹åŠ¡ç»“æœå†³å®šæäº¤æˆ–å›æ»š
- **äº‹åŠ¡å›æŸ¥**ï¼šæ”¯æŒäº‹åŠ¡çŠ¶æ€å›æŸ¥æœºåˆ¶ï¼Œç¡®ä¿æœ€ç»ˆä¸€è‡´æ€§
- **é«˜å¯é æ€§**ï¼šå³ä½¿åœ¨ç½‘ç»œå¼‚å¸¸æƒ…å†µä¸‹ä¹Ÿèƒ½ä¿è¯äº‹åŠ¡çš„æœ€ç»ˆä¸€è‡´æ€§

</TabItem>
<TabItem value="java-impl" label="Javaå®ç°">

```java title="äº‹åŠ¡æ¶ˆæ¯å®Œæ•´å®ç°"
@Component
public class TransactionMessageService {
    
    private TransactionMQProducer transactionProducer;
    
    @PostConstruct
    public void init() throws MQClientException {
        // åˆ›å»ºäº‹åŠ¡ç”Ÿäº§è€…
        transactionProducer = new TransactionMQProducer("transaction_producer_group");
        transactionProducer.setNamesrvAddr("localhost:9876");
        
        // è®¾ç½®äº‹åŠ¡ç›‘å¬å™¨
        transactionProducer.setTransactionListener(new OrderTransactionListener());
        
        // è®¾ç½®çº¿ç¨‹æ± 
        ExecutorService executorService = new ThreadPoolExecutor(
            2, 5, 100, TimeUnit.SECONDS,
            new ArrayBlockingQueue<>(2000),
            r -> {
                Thread thread = new Thread(r);
                thread.setName("client-transaction-msg-check-thread");
                return thread;
            }
        );
        transactionProducer.setExecutorService(executorService);
        
        transactionProducer.start();
        log.info("äº‹åŠ¡ç”Ÿäº§è€…å¯åŠ¨æˆåŠŸ");
    }
    
    /**
     * å‘é€äº‹åŠ¡æ¶ˆæ¯
     */
    public void sendTransactionMessage(OrderCreateEvent event) {
        try {
            Message message = new Message(
                "order_transaction_topic",
                "order_create",
                event.getOrderId(),
                JSON.toJSONBytes(event)
            );
            
            // å‘é€äº‹åŠ¡æ¶ˆæ¯ï¼Œä¼ é€’æœ¬åœ°äº‹åŠ¡å‚æ•°
            TransactionSendResult result = transactionProducer.sendMessageInTransaction(
                message, event
            );
            
            log.info("äº‹åŠ¡æ¶ˆæ¯å‘é€ç»“æœ: {}, äº‹åŠ¡çŠ¶æ€: {}", 
                result.getSendStatus(), result.getLocalTransactionState());
                
        } catch (MQClientException e) {
            log.error("å‘é€äº‹åŠ¡æ¶ˆæ¯å¤±è´¥", e);
            throw new BusinessException("äº‹åŠ¡æ¶ˆæ¯å‘é€å¤±è´¥", e);
        }
    }
    
    /**
     * äº‹åŠ¡ç›‘å¬å™¨å®ç°
     */
    @Component
    public static class OrderTransactionListener implements TransactionListener {
        
        @Autowired
        private OrderService orderService;
        
        @Autowired
        private PaymentService paymentService;
        
        /**
         * æ‰§è¡Œæœ¬åœ°äº‹åŠ¡
         */
        @Override
        public LocalTransactionState executeLocalTransaction(Message msg, Object arg) {
            OrderCreateEvent event = (OrderCreateEvent) arg;
            String orderId = event.getOrderId();
            
            log.info("å¼€å§‹æ‰§è¡Œæœ¬åœ°äº‹åŠ¡ï¼Œè®¢å•ID: {}", orderId);
            
            try {
                // 1. åˆ›å»ºè®¢å•
                Order order = orderService.createOrder(event);
                
                // 2. æ‰£å‡åº“å­˜
                boolean stockReduced = orderService.reduceStock(
                    event.getProductId(), event.getQuantity()
                );
                
                if (!stockReduced) {
                    log.warn("åº“å­˜ä¸è¶³ï¼Œè®¢å•åˆ›å»ºå¤±è´¥: {}", orderId);
                    return LocalTransactionState.ROLLBACK_MESSAGE;
                }
                
                // 3. é¢„æ‰£è´¹ç”¨
                boolean paymentReserved = paymentService.reservePayment(
                    event.getUserId(), event.getAmount()
                );
                
                if (!paymentReserved) {
                    log.warn("ä½™é¢ä¸è¶³ï¼Œè®¢å•åˆ›å»ºå¤±è´¥: {}", orderId);
                    // å›æ»šåº“å­˜
                    orderService.rollbackStock(event.getProductId(), event.getQuantity());
                    return LocalTransactionState.ROLLBACK_MESSAGE;
                }
                
                log.info("æœ¬åœ°äº‹åŠ¡æ‰§è¡ŒæˆåŠŸï¼Œè®¢å•ID: {}", orderId);
                return LocalTransactionState.COMMIT_MESSAGE;
                
            } catch (Exception e) {
                log.error("æœ¬åœ°äº‹åŠ¡æ‰§è¡Œå¼‚å¸¸ï¼Œè®¢å•ID: {}", orderId, e);
                return LocalTransactionState.UNKNOW;
            }
        }
        
        /**
         * äº‹åŠ¡çŠ¶æ€å›æŸ¥
         */
        @Override
        public LocalTransactionState checkLocalTransaction(MessageExt msg) {
            String orderId = msg.getKeys();
            log.info("å›æŸ¥æœ¬åœ°äº‹åŠ¡çŠ¶æ€ï¼Œè®¢å•ID: {}", orderId);
            
            try {
                // æŸ¥è¯¢è®¢å•çŠ¶æ€
                Order order = orderService.getOrderById(orderId);
                
                if (order == null) {
                    log.info("è®¢å•ä¸å­˜åœ¨ï¼Œå›æ»šæ¶ˆæ¯: {}", orderId);
                    return LocalTransactionState.ROLLBACK_MESSAGE;
                }
                
                switch (order.getStatus()) {
                    case CREATED:
                    case PAID:
                        log.info("è®¢å•çŠ¶æ€æ­£å¸¸ï¼Œæäº¤æ¶ˆæ¯: {}", orderId);
                        return LocalTransactionState.COMMIT_MESSAGE;
                        
                    case CANCELLED:
                    case FAILED:
                        log.info("è®¢å•å·²å–æ¶ˆæˆ–å¤±è´¥ï¼Œå›æ»šæ¶ˆæ¯: {}", orderId);
                        return LocalTransactionState.ROLLBACK_MESSAGE;
                        
                    default:
                        log.info("è®¢å•çŠ¶æ€æœªçŸ¥ï¼Œç­‰å¾…ä¸‹æ¬¡å›æŸ¥: {}", orderId);
                        return LocalTransactionState.UNKNOW;
                }
                
            } catch (Exception e) {
                log.error("å›æŸ¥äº‹åŠ¡çŠ¶æ€å¼‚å¸¸ï¼Œè®¢å•ID: {}", orderId, e);
                return LocalTransactionState.UNKNOW;
            }
        }
    }
    
    @PreDestroy
    public void destroy() {
        if (transactionProducer != null) {
            transactionProducer.shutdown();
            log.info("äº‹åŠ¡ç”Ÿäº§è€…å…³é—­æˆåŠŸ");
        }
    }
}

/**
 * äº‹åŠ¡æ¶ˆæ¯æ¶ˆè´¹è€…
 */
@Component
@RocketMQMessageListener(
    topic = "order_transaction_topic",
    consumerGroup = "order_transaction_consumer_group",
    messageModel = MessageModel.CLUSTERING
)
public class TransactionMessageConsumer implements RocketMQListener<OrderCreateEvent> {
    
    @Autowired
    private NotificationService notificationService;
    
    @Autowired
    private LogisticsService logisticsService;
    
    @Override
    public void onMessage(OrderCreateEvent event) {
        String orderId = event.getOrderId();
        log.info("æ¥æ”¶åˆ°è®¢å•åˆ›å»ºäº‹åŠ¡æ¶ˆæ¯: {}", orderId);
        
        try {
            // 1. å‘é€è®¢å•ç¡®è®¤é€šçŸ¥
            notificationService.sendOrderConfirmation(event);
            
            // 2. åˆ›å»ºç‰©æµè®¢å•
            logisticsService.createShippingOrder(event);
            
            // 3. æ›´æ–°è®¢å•çŠ¶æ€
            orderService.updateOrderStatus(orderId, OrderStatus.CONFIRMED);
            
            log.info("è®¢å•åˆ›å»ºäº‹åŠ¡æ¶ˆæ¯å¤„ç†å®Œæˆ: {}", orderId);
            
        } catch (Exception e) {
            log.error("å¤„ç†è®¢å•åˆ›å»ºäº‹åŠ¡æ¶ˆæ¯å¤±è´¥: {}", orderId, e);
            throw new RuntimeException("æ¶ˆæ¯å¤„ç†å¤±è´¥", e);
        }
    }
}
```

</TabItem>
<TabItem value="use-cases" label="åº”ç”¨åœºæ™¯">

**äº‹åŠ¡æ¶ˆæ¯å…¸å‹åº”ç”¨åœºæ™¯**ï¼š

1. **ç”µå•†è®¢å•ç³»ç»Ÿ**ï¼šè®¢å•åˆ›å»ºä¸åº“å­˜æ‰£å‡çš„ä¸€è‡´æ€§
2. **æ”¯ä»˜ç³»ç»Ÿ**ï¼šæ”¯ä»˜æˆåŠŸä¸è´¦æˆ·å˜æ›´çš„ä¸€è‡´æ€§  
3. **ç§¯åˆ†ç³»ç»Ÿ**ï¼šæ¶ˆè´¹è¡Œä¸ºä¸ç§¯åˆ†å¢åŠ çš„ä¸€è‡´æ€§
4. **ç‰©æµç³»ç»Ÿ**ï¼šè®¢å•ç¡®è®¤ä¸ç‰©æµåˆ›å»ºçš„ä¸€è‡´æ€§

```java title="äº‹åŠ¡æ¶ˆæ¯åº”ç”¨åœºæ™¯"
/**
 * 1. ç”µå•†ä¸‹å•åœºæ™¯
 */
public class EcommerceOrderScenario {
    
    public void processOrder(OrderRequest request) {
        // å‘é€äº‹åŠ¡æ¶ˆæ¯
        OrderCreateEvent event = new OrderCreateEvent(
            request.getOrderId(),
            request.getUserId(), 
            request.getProductId(),
            request.getQuantity(),
            request.getAmount()
        );
        
        transactionMessageService.sendTransactionMessage(event);
        
        // æœ¬åœ°äº‹åŠ¡å°†åœ¨TransactionListenerä¸­æ‰§è¡Œï¼š
        // 1. åˆ›å»ºè®¢å•è®°å½•
        // 2. æ‰£å‡å•†å“åº“å­˜
        // 3. é¢„æ‰£ç”¨æˆ·ä½™é¢
        // 4. æ ¹æ®æ‰§è¡Œç»“æœå†³å®šæ¶ˆæ¯çš„æäº¤æˆ–å›æ»š
    }
}

/**
 * 2. æ”¯ä»˜æˆåŠŸåœºæ™¯
 */
public class PaymentSuccessScenario {
    
    public void handlePaymentSuccess(PaymentEvent event) {
        // å‘é€äº‹åŠ¡æ¶ˆæ¯
        PaymentSuccessEvent successEvent = new PaymentSuccessEvent(
            event.getPaymentId(),
            event.getOrderId(),
            event.getAmount(),
            event.getPaymentMethod()
        );
        
        transactionMessageService.sendTransactionMessage(successEvent);
        
        // æœ¬åœ°äº‹åŠ¡ï¼š
        // 1. æ›´æ–°æ”¯ä»˜çŠ¶æ€
        // 2. æ›´æ–°è®¢å•çŠ¶æ€
        // 3. å¢åŠ ç”¨æˆ·ç§¯åˆ†
        // 4. åˆ›å»ºå‘ç¥¨è®°å½•
    }
}
```

</TabItem>
</Tabs>

### 2.2 äº‹åŠ¡æ¶ˆæ¯æœ€ä½³å®è·µ

<Tabs>
<TabItem value="best-practices" label="æœ€ä½³å®è·µ">

**äº‹åŠ¡æ¶ˆæ¯è®¾è®¡åŸåˆ™**ï¼š

1. **å¹‚ç­‰æ€§è®¾è®¡**ï¼šç¡®ä¿æ¶ˆæ¯å¤„ç†å’Œæœ¬åœ°äº‹åŠ¡éƒ½æ˜¯å¹‚ç­‰çš„
2. **çŠ¶æ€å¯æŸ¥è¯¢**ï¼šæœ¬åœ°äº‹åŠ¡çŠ¶æ€å¿…é¡»å¯ä»¥é€šè¿‡ä¸šåŠ¡ä¸»é”®æŸ¥è¯¢
3. **è¶…æ—¶å¤„ç†**ï¼šè®¾ç½®åˆç†çš„äº‹åŠ¡è¶…æ—¶æ—¶é—´
4. **å¼‚å¸¸å¤„ç†**ï¼šåŒºåˆ†ä¸šåŠ¡å¼‚å¸¸å’Œç³»ç»Ÿå¼‚å¸¸

```java title="äº‹åŠ¡æ¶ˆæ¯æœ€ä½³å®è·µ"
@Component
public class TransactionBestPractices {
    
    /**
     * 1. å¹‚ç­‰æ€§è®¾è®¡
     */
    @Transactional
    public boolean createOrderIdempotent(OrderCreateEvent event) {
        String orderId = event.getOrderId();
        
        // æ£€æŸ¥è®¢å•æ˜¯å¦å·²å­˜åœ¨ï¼ˆå¹‚ç­‰æ€§æ£€æŸ¥ï¼‰
        Order existingOrder = orderRepository.findByOrderId(orderId);
        if (existingOrder != null) {
            log.info("è®¢å•å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º: {}", orderId);
            return true;
        }
        
        // åˆ›å»ºè®¢å•
        Order order = new Order();
        order.setOrderId(orderId);
        order.setUserId(event.getUserId());
        order.setAmount(event.getAmount());
        order.setStatus(OrderStatus.CREATED);
        order.setCreateTime(new Date());
        
        orderRepository.save(order);
        log.info("è®¢å•åˆ›å»ºæˆåŠŸ: {}", orderId);
        return true;
    }
    
    /**
     * 2. çŠ¶æ€å¯æŸ¥è¯¢è®¾è®¡
     */
    public LocalTransactionState checkTransactionState(String orderId) {
        try {
            Order order = orderRepository.findByOrderId(orderId);
            
            if (order == null) {
                // è®¢å•ä¸å­˜åœ¨ï¼Œå¯èƒ½æ˜¯åˆ›å»ºå¤±è´¥
                return LocalTransactionState.ROLLBACK_MESSAGE;
            }
            
            // æ ¹æ®è®¢å•çŠ¶æ€åˆ¤æ–­äº‹åŠ¡çŠ¶æ€
            switch (order.getStatus()) {
                case CREATED:
                case CONFIRMED:
                    return LocalTransactionState.COMMIT_MESSAGE;
                case CANCELLED:
                case FAILED:
                    return LocalTransactionState.ROLLBACK_MESSAGE;
                default:
                    return LocalTransactionState.UNKNOW;
            }
            
        } catch (Exception e) {
            log.error("æŸ¥è¯¢äº‹åŠ¡çŠ¶æ€å¼‚å¸¸: {}", orderId, e);
            return LocalTransactionState.UNKNOW;
        }
    }
    
    /**
     * 3. è¶…æ—¶å’Œé‡è¯•é…ç½®
     */
    @Bean
    public TransactionMQProducer transactionProducer() {
        TransactionMQProducer producer = new TransactionMQProducer("tx_producer_group");
        producer.setNamesrvAddr("localhost:9876");
        
        // è®¾ç½®äº‹åŠ¡è¶…æ—¶æ—¶é—´ï¼ˆé»˜è®¤6ç§’ï¼‰
        producer.setTransactionTimeOut(10000);
        
        // è®¾ç½®å›æŸ¥é—´éš”ï¼ˆé»˜è®¤60ç§’ï¼‰
        producer.setCheckThreadPoolMinSize(2);
        producer.setCheckThreadPoolMaxSize(5);
        producer.setCheckRequestHoldMax(2000);
        
        return producer;
    }
}
```

</TabItem>
<TabItem value="monitoring" label="ç›‘æ§å‘Šè­¦">

```java title="äº‹åŠ¡æ¶ˆæ¯ç›‘æ§"
@Component
public class TransactionMessageMonitor {
    
    private final MeterRegistry meterRegistry;
    private final Counter transactionSuccessCounter;
    private final Counter transactionFailureCounter;
    private final Timer transactionTimer;
    
    public TransactionMessageMonitor(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        this.transactionSuccessCounter = Counter.builder("transaction.message.success")
            .description("äº‹åŠ¡æ¶ˆæ¯æˆåŠŸæ•°é‡")
            .register(meterRegistry);
        this.transactionFailureCounter = Counter.builder("transaction.message.failure")
            .description("äº‹åŠ¡æ¶ˆæ¯å¤±è´¥æ•°é‡")
            .register(meterRegistry);
        this.transactionTimer = Timer.builder("transaction.message.duration")
            .description("äº‹åŠ¡æ¶ˆæ¯å¤„ç†æ—¶é•¿")
            .register(meterRegistry);
    }
    
    /**
     * è®°å½•äº‹åŠ¡æ¶ˆæ¯æŒ‡æ ‡
     */
    public void recordTransactionMetrics(String orderId, boolean success, long duration) {
        if (success) {
            transactionSuccessCounter.increment();
        } else {
            transactionFailureCounter.increment();
        }
        
        transactionTimer.record(duration, TimeUnit.MILLISECONDS);
        
        log.info("äº‹åŠ¡æ¶ˆæ¯æŒ‡æ ‡è®°å½• - è®¢å•: {}, æˆåŠŸ: {}, è€—æ—¶: {}ms", 
            orderId, success, duration);
    }
    
    /**
     * æ£€æŸ¥äº‹åŠ¡æ¶ˆæ¯å¥åº·çŠ¶æ€
     */
    @Scheduled(fixedRate = 60000) // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    public void checkTransactionHealth() {
        double successRate = calculateSuccessRate();
        
        if (successRate < 0.95) { // æˆåŠŸç‡ä½äº95%å‘Šè­¦
            sendAlert("äº‹åŠ¡æ¶ˆæ¯æˆåŠŸç‡å‘Šè­¦", 
                String.format("å½“å‰æˆåŠŸç‡: %.2f%%", successRate * 100));
        }
        
        // æ£€æŸ¥é•¿æ—¶é—´æœªå›æŸ¥çš„äº‹åŠ¡
        checkLongPendingTransactions();
    }
    
    private double calculateSuccessRate() {
        double successCount = transactionSuccessCounter.count();
        double failureCount = transactionFailureCounter.count();
        double totalCount = successCount + failureCount;
        
        return totalCount > 0 ? successCount / totalCount : 1.0;
    }
    
    private void checkLongPendingTransactions() {
        // æŸ¥è¯¢é•¿æ—¶é—´æœªç¡®è®¤çš„äº‹åŠ¡æ¶ˆæ¯
        // å®ç°å…·ä½“çš„æ£€æŸ¥é€»è¾‘
    }
    
    private void sendAlert(String title, String message) {
        log.error("å‘Šè­¦: {} - {}", title, message);
        // å‘é€å‘Šè­¦é€šçŸ¥åˆ°ç›‘æ§ç³»ç»Ÿ
    }
}
```

</TabItem>
</Tabs>

## 3. é¡ºåºæ¶ˆæ¯ä¸å»¶è¿Ÿæ¶ˆæ¯

### 3.1 é¡ºåºæ¶ˆæ¯å®ç°

RocketMQæ”¯æŒä¸¤ç§é¡ºåºæ¶ˆæ¯ï¼šå…¨å±€é¡ºåºå’Œåˆ†åŒºé¡ºåºï¼Œé€šè¿‡é˜Ÿåˆ—é€‰æ‹©å™¨ç¡®ä¿æ¶ˆæ¯çš„æœ‰åºæ€§ã€‚

<Tabs>
<TabItem value="order-concept" label="é¡ºåºåŸç†">

```mermaid
graph TB
    subgraph "åˆ†åŒºé¡ºåºæ¶ˆæ¯"
        P[Producer] --> Q1[Queue 0<br/>è®¢å•A: åˆ›å»ºâ†’æ”¯ä»˜â†’å‘è´§]
        P --> Q2[Queue 1<br/>è®¢å•B: åˆ›å»ºâ†’æ”¯ä»˜â†’å‘è´§]
        P --> Q3[Queue 2<br/>è®¢å•C: åˆ›å»ºâ†’æ”¯ä»˜â†’å‘è´§]
        
        Q1 --> C1[Consumer 1]
        Q2 --> C2[Consumer 2]
        Q3 --> C3[Consumer 3]
    end
    
    subgraph "é˜Ÿåˆ—é€‰æ‹©ç­–ç•¥"
        OS[Order Selector] --> |orderId % queueNum| QS[Queue Selection]
    end
```

**é¡ºåºæ¶ˆæ¯ç‰¹ç‚¹**ï¼š
- **åˆ†åŒºé¡ºåº**ï¼šåŒä¸€åˆ†åŒºå†…æ¶ˆæ¯ä¸¥æ ¼æœ‰åº
- **å…¨å±€é¡ºåº**ï¼šæ‰€æœ‰æ¶ˆæ¯å…¨å±€æœ‰åºï¼ˆæ€§èƒ½è¾ƒä½ï¼‰
- **é˜Ÿåˆ—é€‰æ‹©**ï¼šé€šè¿‡MessageQueueSelectoré€‰æ‹©é˜Ÿåˆ—

</TabItem>
<TabItem value="order-impl" label="Javaå®ç°">

```java title="é¡ºåºæ¶ˆæ¯å®Œæ•´å®ç°"
@Component
public class OrderedMessageService {
    
    private DefaultMQProducer orderedProducer;
    
    @PostConstruct
    public void init() throws MQClientException {
        orderedProducer = new DefaultMQProducer("ordered_producer_group");
        orderedProducer.setNamesrvAddr("localhost:9876");
        orderedProducer.start();
        log.info("é¡ºåºæ¶ˆæ¯ç”Ÿäº§è€…å¯åŠ¨æˆåŠŸ");
    }
    
    /**
     * å‘é€é¡ºåºæ¶ˆæ¯
     */
    public void sendOrderedMessage(OrderStatusEvent event) {
        try {
            Message message = new Message(
                "order_status_topic",
                event.getEventType(),
                event.getOrderId(), // ä½¿ç”¨orderIdä½œä¸ºkey
                JSON.toJSONBytes(event)
            );
            
            // å‘é€é¡ºåºæ¶ˆæ¯ï¼Œä½¿ç”¨è®¢å•IDä½œä¸ºé˜Ÿåˆ—é€‰æ‹©å› å­
            SendResult result = orderedProducer.send(
                message,
                new MessageQueueSelector() {
                    @Override
                    public MessageQueue select(List<MessageQueue> mqs, Message msg, Object arg) {
                        String orderId = (String) arg;
                        // æ ¹æ®è®¢å•IDé€‰æ‹©é˜Ÿåˆ—ï¼Œç¡®ä¿åŒä¸€è®¢å•çš„æ¶ˆæ¯å‘é€åˆ°åŒä¸€é˜Ÿåˆ—
                        int index = Math.abs(orderId.hashCode()) % mqs.size();
                        return mqs.get(index);
                    }
                },
                event.getOrderId() // é˜Ÿåˆ—é€‰æ‹©å‚æ•°
            );
            
            log.info("é¡ºåºæ¶ˆæ¯å‘é€æˆåŠŸ - è®¢å•: {}, äº‹ä»¶: {}, é˜Ÿåˆ—: {}", 
                event.getOrderId(), event.getEventType(), result.getMessageQueue().getQueueId());
                
        } catch (Exception e) {
            log.error("å‘é€é¡ºåºæ¶ˆæ¯å¤±è´¥", e);
            throw new BusinessException("é¡ºåºæ¶ˆæ¯å‘é€å¤±è´¥", e);
        }
    }
    
    /**
     * æ‰¹é‡å‘é€è®¢å•çŠ¶æ€å˜æ›´æ¶ˆæ¯
     */
    public void sendOrderStatusFlow(String orderId) {
        // æ¨¡æ‹Ÿè®¢å•çŠ¶æ€æµè½¬ï¼šåˆ›å»º -> æ”¯ä»˜ -> å‘è´§ -> å®Œæˆ
        List<OrderStatusEvent> events = Arrays.asList(
            new OrderStatusEvent(orderId, "ORDER_CREATED", "è®¢å•åˆ›å»º"),
            new OrderStatusEvent(orderId, "ORDER_PAID", "è®¢å•æ”¯ä»˜"),
            new OrderStatusEvent(orderId, "ORDER_SHIPPED", "è®¢å•å‘è´§"),
            new OrderStatusEvent(orderId, "ORDER_COMPLETED", "è®¢å•å®Œæˆ")
        );
        
        // æŒ‰é¡ºåºå‘é€æ¶ˆæ¯
        for (OrderStatusEvent event : events) {
            sendOrderedMessage(event);
            
            // æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç†é—´éš”
            try {
                Thread.sleep(100);
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
        }
    }
    
    @PreDestroy
    public void destroy() {
        if (orderedProducer != null) {
            orderedProducer.shutdown();
            log.info("é¡ºåºæ¶ˆæ¯ç”Ÿäº§è€…å…³é—­æˆåŠŸ");
        }
    }
}

/**
 * é¡ºåºæ¶ˆæ¯æ¶ˆè´¹è€…
 */
@Component
@RocketMQMessageListener(
    topic = "order_status_topic",
    consumerGroup = "order_status_consumer_group",
    messageModel = MessageModel.CLUSTERING,
    consumeMode = ConsumeMode.ORDERLY // é¡ºåºæ¶ˆè´¹
)
public class OrderedMessageConsumer implements RocketMQListener<OrderStatusEvent> {
    
    @Autowired
    private OrderService orderService;
    
    @Override
    public void onMessage(OrderStatusEvent event) {
        String orderId = event.getOrderId();
        String eventType = event.getEventType();
        
        log.info("æ¥æ”¶åˆ°é¡ºåºæ¶ˆæ¯ - è®¢å•: {}, äº‹ä»¶: {}", orderId, eventType);
        
        try {
            // æ ¹æ®äº‹ä»¶ç±»å‹å¤„ç†ä¸šåŠ¡é€»è¾‘
            switch (eventType) {
                case "ORDER_CREATED":
                    handleOrderCreated(event);
                    break;
                case "ORDER_PAID":
                    handleOrderPaid(event);
                    break;
                case "ORDER_SHIPPED":
                    handleOrderShipped(event);
                    break;
                case "ORDER_COMPLETED":
                    handleOrderCompleted(event);
                    break;
                default:
                    log.warn("æœªçŸ¥çš„è®¢å•äº‹ä»¶ç±»å‹: {}", eventType);
            }
            
            log.info("é¡ºåºæ¶ˆæ¯å¤„ç†å®Œæˆ - è®¢å•: {}, äº‹ä»¶: {}", orderId, eventType);
            
        } catch (Exception e) {
            log.error("å¤„ç†é¡ºåºæ¶ˆæ¯å¤±è´¥ - è®¢å•: {}, äº‹ä»¶: {}", orderId, eventType, e);
            throw new RuntimeException("é¡ºåºæ¶ˆæ¯å¤„ç†å¤±è´¥", e);
        }
    }
    
    private void handleOrderCreated(OrderStatusEvent event) {
        orderService.updateOrderStatus(event.getOrderId(), OrderStatus.CREATED);
        log.info("è®¢å•åˆ›å»ºå¤„ç†å®Œæˆ: {}", event.getOrderId());
    }
    
    private void handleOrderPaid(OrderStatusEvent event) {
        orderService.updateOrderStatus(event.getOrderId(), OrderStatus.PAID);
        log.info("è®¢å•æ”¯ä»˜å¤„ç†å®Œæˆ: {}", event.getOrderId());
    }
    
    private void handleOrderShipped(OrderStatusEvent event) {
        orderService.updateOrderStatus(event.getOrderId(), OrderStatus.SHIPPED);
        log.info("è®¢å•å‘è´§å¤„ç†å®Œæˆ: {}", event.getOrderId());
    }
    
    private void handleOrderCompleted(OrderStatusEvent event) {
        orderService.updateOrderStatus(event.getOrderId(), OrderStatus.COMPLETED);
        log.info("è®¢å•å®Œæˆå¤„ç†å®Œæˆ: {}", event.getOrderId());
    }
}
```

</TabItem>
</Tabs>

### 3.2 å»¶è¿Ÿæ¶ˆæ¯å®ç°

RocketMQæ”¯æŒ18ä¸ªå»¶è¿Ÿç­‰çº§çš„å®šæ—¶æ¶ˆæ¯ï¼Œé€‚ç”¨äºå»¶è¿Ÿå¤„ç†åœºæ™¯ã€‚

<Tabs>
<TabItem value="delay-levels" label="å»¶è¿Ÿç­‰çº§">

```java title="RocketMQå»¶è¿Ÿç­‰çº§"
public class DelayLevels {
    
    /**
     * RocketMQæ”¯æŒçš„18ä¸ªå»¶è¿Ÿç­‰çº§
     * 1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h
     */
    public static final Map<Integer, String> DELAY_LEVELS = Map.of(
        1, "1s",    2, "5s",    3, "10s",   4, "30s",
        5, "1m",    6, "2m",    7, "3m",    8, "4m",
        9, "5m",    10, "6m",   11, "7m",   12, "8m",
        13, "9m",   14, "10m",  15, "20m",  16, "30m",
        17, "1h",   18, "2h"
    );
    
    /**
     * å¸¸ç”¨å»¶è¿Ÿåœºæ™¯æ˜ å°„
     */
    public static class DelayScenarios {
        public static final int ORDER_TIMEOUT_CHECK = 16;    // 30åˆ†é’Ÿåæ£€æŸ¥è®¢å•è¶…æ—¶
        public static final int PAYMENT_REMINDER = 14;       // 10åˆ†é’Ÿåæ”¯ä»˜æé†’
        public static final int COUPON_EXPIRE_NOTICE = 17;   // 1å°æ—¶åä¼˜æƒ åˆ¸è¿‡æœŸæé†’
        public static final int RETRY_AFTER_FAILURE = 6;     // 2åˆ†é’Ÿåé‡è¯•
    }
}
```

</TabItem>
<TabItem value="delay-impl" label="Javaå®ç°">

```java title="å»¶è¿Ÿæ¶ˆæ¯å®Œæ•´å®ç°"
@Component
public class DelayMessageService {
    
    private DefaultMQProducer delayProducer;
    
    @PostConstruct
    public void init() throws MQClientException {
        delayProducer = new DefaultMQProducer("delay_producer_group");
        delayProducer.setNamesrvAddr("localhost:9876");
        delayProducer.start();
        log.info("å»¶è¿Ÿæ¶ˆæ¯ç”Ÿäº§è€…å¯åŠ¨æˆåŠŸ");
    }
    
    /**
     * å‘é€å»¶è¿Ÿæ¶ˆæ¯
     */
    public void sendDelayMessage(String topic, String tag, Object messageBody, int delayLevel) {
        try {
            Message message = new Message(topic, tag, JSON.toJSONBytes(messageBody));
            
            // è®¾ç½®å»¶è¿Ÿç­‰çº§
            message.setDelayTimeLevel(delayLevel);
            
            SendResult result = delayProducer.send(message);
            
            log.info("å»¶è¿Ÿæ¶ˆæ¯å‘é€æˆåŠŸ - Topic: {}, å»¶è¿Ÿç­‰çº§: {}, æ¶ˆæ¯ID: {}", 
                topic, delayLevel, result.getMsgId());
                
        } catch (Exception e) {
            log.error("å‘é€å»¶è¿Ÿæ¶ˆæ¯å¤±è´¥", e);
            throw new BusinessException("å»¶è¿Ÿæ¶ˆæ¯å‘é€å¤±è´¥", e);
        }
    }
    
    /**
     * è®¢å•è¶…æ—¶æ£€æŸ¥
     */
    public void scheduleOrderTimeoutCheck(String orderId) {
        OrderTimeoutCheckEvent event = new OrderTimeoutCheckEvent(
            orderId, System.currentTimeMillis()
        );
        
        // 30åˆ†é’Ÿåæ£€æŸ¥è®¢å•æ˜¯å¦è¶…æ—¶
        sendDelayMessage(
            "order_timeout_topic",
            "timeout_check",
            event,
            DelayLevels.DelayScenarios.ORDER_TIMEOUT_CHECK
        );
        
        log.info("è®¢å•è¶…æ—¶æ£€æŸ¥ä»»åŠ¡å·²è°ƒåº¦: {}", orderId);
    }
    
    /**
     * æ”¯ä»˜æé†’
     */
    public void schedulePaymentReminder(String orderId, String userId) {
        PaymentReminderEvent event = new PaymentReminderEvent(
            orderId, userId, System.currentTimeMillis()
        );
        
        // 10åˆ†é’Ÿåå‘é€æ”¯ä»˜æé†’
        sendDelayMessage(
            "payment_reminder_topic",
            "payment_reminder",
            event,
            DelayLevels.DelayScenarios.PAYMENT_REMINDER
        );
        
        log.info("æ”¯ä»˜æé†’ä»»åŠ¡å·²è°ƒåº¦ - è®¢å•: {}, ç”¨æˆ·: {}", orderId, userId);
    }
    
    /**
     * å¤±è´¥é‡è¯•
     */
    public void scheduleRetryTask(RetryTaskEvent event) {
        // 2åˆ†é’Ÿåé‡è¯•
        sendDelayMessage(
            "retry_task_topic",
            "retry",
            event,
            DelayLevels.DelayScenarios.RETRY_AFTER_FAILURE
        );
        
        log.info("é‡è¯•ä»»åŠ¡å·²è°ƒåº¦ - ä»»åŠ¡ID: {}, é‡è¯•æ¬¡æ•°: {}", 
            event.getTaskId(), event.getRetryCount());
    }
    
    @PreDestroy
    public void destroy() {
        if (delayProducer != null) {
            delayProducer.shutdown();
            log.info("å»¶è¿Ÿæ¶ˆæ¯ç”Ÿäº§è€…å…³é—­æˆåŠŸ");
        }
    }
}

/**
 * è®¢å•è¶…æ—¶æ£€æŸ¥æ¶ˆè´¹è€…
 */
@Component
@RocketMQMessageListener(
    topic = "order_timeout_topic",
    consumerGroup = "order_timeout_consumer_group"
)
public class OrderTimeoutConsumer implements RocketMQListener<OrderTimeoutCheckEvent> {
    
    @Autowired
    private OrderService orderService;
    
    @Override
    public void onMessage(OrderTimeoutCheckEvent event) {
        String orderId = event.getOrderId();
        log.info("æ‰§è¡Œè®¢å•è¶…æ—¶æ£€æŸ¥: {}", orderId);
        
        try {
            Order order = orderService.getOrderById(orderId);
            
            if (order == null) {
                log.warn("è®¢å•ä¸å­˜åœ¨: {}", orderId);
                return;
            }
            
            // æ£€æŸ¥è®¢å•æ˜¯å¦å·²æ”¯ä»˜
            if (order.getStatus() == OrderStatus.CREATED) {
                // è®¢å•æœªæ”¯ä»˜ï¼Œæ‰§è¡Œè¶…æ—¶å¤„ç†
                orderService.handleOrderTimeout(orderId);
                log.info("è®¢å•è¶…æ—¶å¤„ç†å®Œæˆ: {}", orderId);
            } else {
                log.info("è®¢å•å·²æ”¯ä»˜ï¼Œæ— éœ€è¶…æ—¶å¤„ç†: {}", orderId);
            }
            
        } catch (Exception e) {
            log.error("è®¢å•è¶…æ—¶æ£€æŸ¥å¤±è´¥: {}", orderId, e);
            throw new RuntimeException("è®¢å•è¶…æ—¶æ£€æŸ¥å¤±è´¥", e);
        }
    }
}

/**
 * æ”¯ä»˜æé†’æ¶ˆè´¹è€…
 */
@Component
@RocketMQMessageListener(
    topic = "payment_reminder_topic",
    consumerGroup = "payment_reminder_consumer_group"
)
public class PaymentReminderConsumer implements RocketMQListener<PaymentReminderEvent> {
    
    @Autowired
    private NotificationService notificationService;
    
    @Override
    public void onMessage(PaymentReminderEvent event) {
        String orderId = event.getOrderId();
        String userId = event.getUserId();
        
        log.info("æ‰§è¡Œæ”¯ä»˜æé†’ - è®¢å•: {}, ç”¨æˆ·: {}", orderId, userId);
        
        try {
            // æ£€æŸ¥è®¢å•æ˜¯å¦ä»éœ€è¦æ”¯ä»˜
            Order order = orderService.getOrderById(orderId);
            
            if (order != null && order.getStatus() == OrderStatus.CREATED) {
                // å‘é€æ”¯ä»˜æé†’é€šçŸ¥
                notificationService.sendPaymentReminder(userId, orderId);
                log.info("æ”¯ä»˜æé†’å‘é€æˆåŠŸ - è®¢å•: {}", orderId);
            } else {
                log.info("è®¢å•å·²æ”¯ä»˜æˆ–ä¸å­˜åœ¨ï¼Œè·³è¿‡æé†’ - è®¢å•: {}", orderId);
            }
            
        } catch (Exception e) {
            log.error("æ”¯ä»˜æé†’å¤„ç†å¤±è´¥ - è®¢å•: {}", orderId, e);
            throw new RuntimeException("æ”¯ä»˜æé†’å¤„ç†å¤±è´¥", e);
        }
    }
}
```

</TabItem>
</Tabs>

## 4. é«˜å¯ç”¨é›†ç¾¤æ¶æ„

### 4.1 é›†ç¾¤éƒ¨ç½²æ¨¡å¼

<Tabs>
<TabItem value="cluster-arch" label="é›†ç¾¤æ¶æ„">

```mermaid
graph TB
    subgraph "NameServeré›†ç¾¤"
        NS1[NameServer-1<br/>192.168.1.10]
        NS2[NameServer-2<br/>192.168.1.11]
        NS3[NameServer-3<br/>192.168.1.12]
    end
    
    subgraph "Brokeré›†ç¾¤"
        subgraph "Broker-A"
            BMA[Master-A<br/>192.168.1.20]
            BSA[Slave-A<br/>192.168.1.21]
        end
        
        subgraph "Broker-B"
            BMB[Master-B<br/>192.168.1.22]
            BSB[Slave-B<br/>192.168.1.23]
        end
    end
    
    BMA -.->|åŒæ­¥å¤åˆ¶| BSA
    BMB -.->|åŒæ­¥å¤åˆ¶| BSB
    
    BMA --> NS1
    BMA --> NS2
    BMA --> NS3
    BMB --> NS1
    BMB --> NS2
    BMB --> NS3
```

**é›†ç¾¤ç‰¹ç‚¹**ï¼š
- **NameServeré›†ç¾¤**ï¼šæ— çŠ¶æ€ï¼Œä»»æ„èŠ‚ç‚¹å®•æœºä¸å½±å“æœåŠ¡
- **Brokerä¸»ä»**ï¼šæ”¯æŒåŒæ­¥/å¼‚æ­¥å¤åˆ¶ï¼Œä¸»èŠ‚ç‚¹å®•æœºä»èŠ‚ç‚¹å¯è¯»
- **å¤šMasteræ¨¡å¼**ï¼šæ”¯æŒå¤šMasteréƒ¨ç½²ï¼Œæé«˜å¹¶å‘èƒ½åŠ›

</TabItem>
<TabItem value="cluster-config" label="é›†ç¾¤é…ç½®">

```bash title="RocketMQé›†ç¾¤é…ç½®"
# NameServeré…ç½® (namesrv.conf)
# æ— éœ€ç‰¹æ®Šé…ç½®ï¼Œå¯åŠ¨å¤šä¸ªå®ä¾‹å³å¯
rocketmqHome=/opt/rocketmq
kvConfigPath=/opt/rocketmq/namesrv/kvConfig.json
configStorePath=/opt/rocketmq/namesrv/namesrv.properties
listenPort=9876

# Broker Masteré…ç½® (broker-a.conf)
brokerClusterName=DefaultCluster
brokerName=broker-a
brokerId=0
deleteWhen=04
fileReservedTime=48
brokerRole=SYNC_MASTER
flushDiskType=ASYNC_FLUSH

# ç½‘ç»œé…ç½®
namesrvAddr=192.168.1.10:9876;192.168.1.11:9876;192.168.1.12:9876
listenPort=10911
brokerIP1=192.168.1.20

# å­˜å‚¨é…ç½®
storePathRootDir=/opt/rocketmq/store
storePathCommitLog=/opt/rocketmq/store/commitlog
storePathConsumeQueue=/opt/rocketmq/store/consumequeue
storePathIndex=/opt/rocketmq/store/index

# æ€§èƒ½é…ç½®
sendMessageThreadPoolNums=128
pullMessageThreadPoolNums=128
queryMessageThreadPoolNums=8
adminBrokerThreadPoolNums=16
clientManagerThreadPoolNums=32

# Broker Slaveé…ç½® (broker-a-s.conf)
brokerClusterName=DefaultCluster
brokerName=broker-a
brokerId=1
deleteWhen=04
fileReservedTime=48
brokerRole=SLAVE
flushDiskType=ASYNC_FLUSH

namesrvAddr=192.168.1.10:9876;192.168.1.11:9876;192.168.1.12:9876
listenPort=10921
brokerIP1=192.168.1.21

# å¯åŠ¨è„šæœ¬
#!/bin/bash
# å¯åŠ¨NameServeré›†ç¾¤
nohup sh mqnamesrv > /dev/null 2>&1 &

# å¯åŠ¨Broker Master
nohup sh mqbroker -c broker-a.conf > /dev/null 2>&1 &

# å¯åŠ¨Broker Slave  
nohup sh mqbroker -c broker-a-s.conf > /dev/null 2>&1 &
```

</TabItem>
<TabItem value="ha-config" label="é«˜å¯ç”¨é…ç½®">

```java title="é«˜å¯ç”¨å®¢æˆ·ç«¯é…ç½®"
@Configuration
public class RocketMQHighAvailabilityConfig {
    
    /**
     * é«˜å¯ç”¨ç”Ÿäº§è€…é…ç½®
     */
    @Bean
    public DefaultMQProducer haProducer() throws MQClientException {
        DefaultMQProducer producer = new DefaultMQProducer("ha_producer_group");
        
        // é…ç½®å¤šä¸ªNameServeråœ°å€
        producer.setNamesrvAddr("192.168.1.10:9876;192.168.1.11:9876;192.168.1.12:9876");
        
        // å‘é€è¶…æ—¶æ—¶é—´
        producer.setSendMsgTimeout(10000);
        
        // å‘é€å¤±è´¥é‡è¯•æ¬¡æ•°
        producer.setRetryTimesWhenSendFailed(3);
        producer.setRetryTimesWhenSendAsyncFailed(3);
        
        // å‹ç¼©æ¶ˆæ¯ä½“é˜ˆå€¼
        producer.setCompressMsgBodyOverHowmuch(4096);
        
        // æœ€å¤§æ¶ˆæ¯å¤§å°
        producer.setMaxMessageSize(4 * 1024 * 1024);
        
        producer.start();
        return producer;
    }
    
    /**
     * é«˜å¯ç”¨æ¶ˆè´¹è€…é…ç½®
     */
    @Bean
    public DefaultMQPushConsumer haConsumer() throws MQClientException {
        DefaultMQPushConsumer consumer = new DefaultMQPushConsumer("ha_consumer_group");
        
        // é…ç½®å¤šä¸ªNameServeråœ°å€
        consumer.setNamesrvAddr("192.168.1.10:9876;192.168.1.11:9876;192.168.1.12:9876");
        
        // æ¶ˆè´¹æ¨¡å¼
        consumer.setMessageModel(MessageModel.CLUSTERING);
        
        // æ¶ˆè´¹çº¿ç¨‹æ•°
        consumer.setConsumeThreadMin(10);
        consumer.setConsumeThreadMax(20);
        
        // æ‰¹é‡æ¶ˆè´¹æ•°é‡
        consumer.setConsumeMessageBatchMaxSize(10);
        
        // æ¶ˆæ¯æ‹‰å–é—´éš”
        consumer.setPullInterval(1000);
        
        // æ¶ˆæ¯æ‹‰å–æ‰¹æ¬¡å¤§å°
        consumer.setPullBatchSize(32);
        
        consumer.start();
        return consumer;
    }
    
    /**
     * è¿æ¥ç›‘æ§å’Œæ•…éšœè½¬ç§»
     */
    @Component
    public static class ConnectionMonitor {
        
        @EventListener
        public void handleConnectionEvent(ConnectionEvent event) {
            if (event.getType() == ConnectionEventType.DISCONNECT) {
                log.warn("RocketMQè¿æ¥æ–­å¼€: {}", event.getRemoteAddr());
                // è§¦å‘é‡è¿é€»è¾‘
                handleReconnection(event);
            } else if (event.getType() == ConnectionEventType.CONNECT) {
                log.info("RocketMQè¿æ¥æ¢å¤: {}", event.getRemoteAddr());
            }
        }
        
        private void handleReconnection(ConnectionEvent event) {
            // å®ç°é‡è¿é€»è¾‘
            // 1. è®°å½•è¿æ¥å¤±è´¥ä¿¡æ¯
            // 2. å°è¯•è¿æ¥å…¶ä»–NameServer
            // 3. å‘é€å‘Šè­¦é€šçŸ¥
        }
    }
}
```

</TabItem>
</Tabs>

## 5. æ€§èƒ½ä¼˜åŒ–ä¸ç›‘æ§

### 5.1 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

<Tabs>
<TabItem value="performance-tuning" label="æ€§èƒ½è°ƒä¼˜">

```java title="RocketMQæ€§èƒ½ä¼˜åŒ–é…ç½®"
@Configuration
public class RocketMQPerformanceConfig {
    
    /**
     * é«˜æ€§èƒ½ç”Ÿäº§è€…é…ç½®
     */
    @Bean
    public DefaultMQProducer highPerformanceProducer() throws MQClientException {
        DefaultMQProducer producer = new DefaultMQProducer("high_perf_producer");
        producer.setNamesrvAddr("localhost:9876");
        
        // å¼‚æ­¥å‘é€é…ç½®
        producer.setRetryTimesWhenSendAsyncFailed(0);
        producer.setSendMsgTimeout(3000);
        
        // æ‰¹é‡å‘é€é…ç½®
        producer.setMaxMessageSize(4 * 1024 * 1024);
        producer.setCompressMsgBodyOverHowmuch(4096);
        
        // å®¢æˆ·ç«¯é…ç½®
        producer.setClientCallbackExecutorThreads(Runtime.getRuntime().availableProcessors());
        
        producer.start();
        return producer;
    }
    
    /**
     * æ‰¹é‡æ¶ˆæ¯å‘é€
     */
    @Service
    public static class BatchMessageService {
        
        @Autowired
        private DefaultMQProducer producer;
        
        /**
         * æ‰¹é‡å‘é€æ¶ˆæ¯
         */
        public void sendBatchMessages(List<MessageEvent> events) {
            if (events.isEmpty()) {
                return;
            }
            
            try {
                List<Message> messages = events.stream()
                    .map(event -> new Message(
                        event.getTopic(),
                        event.getTag(),
                        event.getKey(),
                        JSON.toJSONBytes(event)
                    ))
                    .collect(Collectors.toList());
                
                // æ‰¹é‡å‘é€
                SendResult result = producer.send(messages);
                log.info("æ‰¹é‡æ¶ˆæ¯å‘é€æˆåŠŸï¼Œæ•°é‡: {}, æ¶ˆæ¯ID: {}", 
                    messages.size(), result.getMsgId());
                    
            } catch (Exception e) {
                log.error("æ‰¹é‡æ¶ˆæ¯å‘é€å¤±è´¥", e);
                throw new BusinessException("æ‰¹é‡æ¶ˆæ¯å‘é€å¤±è´¥", e);
            }
        }
        
        /**
         * å¼‚æ­¥æ‰¹é‡å‘é€
         */
        public void sendBatchMessagesAsync(List<MessageEvent> events) {
            if (events.isEmpty()) {
                return;
            }
            
            try {
                List<Message> messages = events.stream()
                    .map(event -> new Message(
                        event.getTopic(),
                        event.getTag(), 
                        event.getKey(),
                        JSON.toJSONBytes(event)
                    ))
                    .collect(Collectors.toList());
                
                // å¼‚æ­¥æ‰¹é‡å‘é€
                producer.send(messages, new SendCallback() {
                    @Override
                    public void onSuccess(SendResult sendResult) {
                        log.info("å¼‚æ­¥æ‰¹é‡æ¶ˆæ¯å‘é€æˆåŠŸï¼Œæ•°é‡: {}, æ¶ˆæ¯ID: {}", 
                            messages.size(), sendResult.getMsgId());
                    }
                    
                    @Override
                    public void onException(Throwable e) {
                        log.error("å¼‚æ­¥æ‰¹é‡æ¶ˆæ¯å‘é€å¤±è´¥ï¼Œæ•°é‡: {}", messages.size(), e);
                    }
                });
                
            } catch (Exception e) {
                log.error("å¼‚æ­¥æ‰¹é‡æ¶ˆæ¯å‘é€å¤±è´¥", e);
                throw new BusinessException("å¼‚æ­¥æ‰¹é‡æ¶ˆæ¯å‘é€å¤±è´¥", e);
            }
        }
    }
}
```

</TabItem>
<TabItem value="monitoring" label="ç›‘æ§æŒ‡æ ‡">

```java title="RocketMQç›‘æ§æŒ‡æ ‡"
@Component
public class RocketMQMonitor {
    
    private final MeterRegistry meterRegistry;
    private final Counter messagesSentCounter;
    private final Counter messagesConsumedCounter;
    private final Timer sendLatencyTimer;
    private final Gauge queueDepthGauge;
    
    public RocketMQMonitor(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        
        this.messagesSentCounter = Counter.builder("rocketmq.messages.sent")
            .description("å‘é€æ¶ˆæ¯æ€»æ•°")
            .register(meterRegistry);
            
        this.messagesConsumedCounter = Counter.builder("rocketmq.messages.consumed")
            .description("æ¶ˆè´¹æ¶ˆæ¯æ€»æ•°")
            .register(meterRegistry);
            
        this.sendLatencyTimer = Timer.builder("rocketmq.send.latency")
            .description("æ¶ˆæ¯å‘é€å»¶è¿Ÿ")
            .register(meterRegistry);
            
        this.queueDepthGauge = Gauge.builder("rocketmq.queue.depth")
            .description("é˜Ÿåˆ—æ·±åº¦")
            .register(meterRegistry, this, RocketMQMonitor::getQueueDepth);
    }
    
    /**
     * è®°å½•æ¶ˆæ¯å‘é€æŒ‡æ ‡
     */
    public void recordMessageSent(String topic, long latency) {
        messagesSentCounter.increment(Tags.of("topic", topic));
        sendLatencyTimer.record(latency, TimeUnit.MILLISECONDS);
    }
    
    /**
     * è®°å½•æ¶ˆæ¯æ¶ˆè´¹æŒ‡æ ‡
     */
    public void recordMessageConsumed(String topic, String consumerGroup) {
        messagesConsumedCounter.increment(
            Tags.of("topic", topic, "consumer_group", consumerGroup)
        );
    }
    
    /**
     * è·å–é˜Ÿåˆ—æ·±åº¦
     */
    private double getQueueDepth() {
        // å®ç°é˜Ÿåˆ—æ·±åº¦æŸ¥è¯¢é€»è¾‘
        // å¯ä»¥é€šè¿‡RocketMQ Adminå·¥å…·æŸ¥è¯¢
        return 0.0;
    }
    
    /**
     * å¥åº·æ£€æŸ¥
     */
    @Scheduled(fixedRate = 60000)
    public void healthCheck() {
        try {
            // æ£€æŸ¥ç”Ÿäº§è€…çŠ¶æ€
            checkProducerHealth();
            
            // æ£€æŸ¥æ¶ˆè´¹è€…çŠ¶æ€
            checkConsumerHealth();
            
            // æ£€æŸ¥Brokerè¿æ¥çŠ¶æ€
            checkBrokerConnection();
            
        } catch (Exception e) {
            log.error("RocketMQå¥åº·æ£€æŸ¥å¤±è´¥", e);
        }
    }
    
    private void checkProducerHealth() {
        // å®ç°ç”Ÿäº§è€…å¥åº·æ£€æŸ¥
    }
    
    private void checkConsumerHealth() {
        // å®ç°æ¶ˆè´¹è€…å¥åº·æ£€æŸ¥
    }
    
    private void checkBrokerConnection() {
        // å®ç°Brokerè¿æ¥æ£€æŸ¥
    }
    
    /**
     * æ€§èƒ½æŠ¥å‘Š
     */
    @Scheduled(fixedRate = 300000) // æ¯5åˆ†é’Ÿç”Ÿæˆä¸€æ¬¡æŠ¥å‘Š
    public void generatePerformanceReport() {
        double sendTps = messagesSentCounter.count() / 300.0; // 5åˆ†é’Ÿå†…çš„TPS
        double consumeTps = messagesConsumedCounter.count() / 300.0;
        double avgLatency = sendLatencyTimer.mean(TimeUnit.MILLISECONDS);
        
        log.info("RocketMQæ€§èƒ½æŠ¥å‘Š - å‘é€TPS: {}, æ¶ˆè´¹TPS: {}, å¹³å‡å»¶è¿Ÿ: {}ms", 
            String.format("%.2f", sendTps),
            String.format("%.2f", consumeTps),
            String.format("%.2f", avgLatency)
        );
        
        // é‡ç½®è®¡æ•°å™¨
        meterRegistry.remove(messagesSentCounter);
        meterRegistry.remove(messagesConsumedCounter);
    }
}
```

</TabItem>
</Tabs>

## 6. æœ€ä½³å®è·µä¸æ€»ç»“

### 6.1 æ¶æ„è®¾è®¡æœ€ä½³å®è·µ

**æ¶ˆæ¯è®¾è®¡åŸåˆ™**ï¼š
1. **Topicè§„åˆ’**ï¼šæŒ‰ä¸šåŠ¡åŸŸåˆ’åˆ†Topicï¼Œé¿å…è¿‡å¤šç»†åˆ†
2. **æ¶ˆæ¯å¹‚ç­‰**ï¼šç¡®ä¿æ¶ˆæ¯å¤„ç†çš„å¹‚ç­‰æ€§
3. **æ¶ˆæ¯å¤§å°**ï¼šå•æ¡æ¶ˆæ¯ä¸è¶…è¿‡4MBï¼Œæ‰¹é‡æ¶ˆæ¯ä¸è¶…è¿‡1MB
4. **æ¶ˆæ¯Key**ï¼šè®¾ç½®æœ‰æ„ä¹‰çš„æ¶ˆæ¯Keyï¼Œä¾¿äºé—®é¢˜æ’æŸ¥

**æ€§èƒ½ä¼˜åŒ–å»ºè®®**ï¼š
1. **å¼‚æ­¥å‘é€**ï¼šä¼˜å…ˆä½¿ç”¨å¼‚æ­¥å‘é€æé«˜ååé‡
2. **æ‰¹é‡æ“ä½œ**ï¼šä½¿ç”¨æ‰¹é‡å‘é€å’Œæ¶ˆè´¹
3. **åˆç†é…ç½®**ï¼šæ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹è°ƒæ•´çº¿ç¨‹æ± å’Œç¼“å†²åŒºå¤§å°
4. **ç›‘æ§å‘Šè­¦**ï¼šå»ºç«‹å®Œå–„çš„ç›‘æ§ä½“ç³»

**é«˜å¯ç”¨è®¾è®¡**ï¼š
1. **é›†ç¾¤éƒ¨ç½²**ï¼šNameServerå’ŒBrokeréƒ½è¦é›†ç¾¤éƒ¨ç½²
2. **ä¸»ä»å¤åˆ¶**ï¼šé…ç½®Brokerä¸»ä»åŒæ­¥å¤åˆ¶
3. **æ•…éšœè½¬ç§»**ï¼šå®¢æˆ·ç«¯æ”¯æŒè‡ªåŠ¨æ•…éšœè½¬ç§»
4. **æ•°æ®å¤‡ä»½**ï¼šå®šæœŸå¤‡ä»½é‡è¦çš„æ¶ˆæ¯æ•°æ®

### 6.2 RocketMQ vs å…¶ä»–æ¶ˆæ¯é˜Ÿåˆ—

| ç‰¹æ€§å¯¹æ¯” | RocketMQ | Kafka | RabbitMQ | é€‚ç”¨åœºæ™¯ |
|---------|----------|-------|----------|----------|
| **äº‹åŠ¡æ¶ˆæ¯** | â­â­â­â­â­ | â­â­â­ | â­â­ | é‡‘èæ”¯ä»˜ |
| **é¡ºåºæ¶ˆæ¯** | â­â­â­â­â­ | â­â­â­â­ | â­â­â­ | çŠ¶æ€æµè½¬ |
| **å»¶è¿Ÿæ¶ˆæ¯** | â­â­â­â­â­ | â­â­ | â­â­â­ | å®šæ—¶ä»»åŠ¡ |
| **æ¶ˆæ¯å †ç§¯** | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­ | å¤§æ•°æ®åœºæ™¯ |
| **è¿ç»´å¤æ‚åº¦** | â­â­â­ | â­â­ | â­â­â­â­ | å›¢é˜ŸæŠ€æœ¯æ°´å¹³ |
| **ç¤¾åŒºç”Ÿæ€** | â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | æŠ€æœ¯é€‰å‹ |

:::tip RocketMQå­¦ä¹ å»ºè®®
1. **æŒæ¡æ ¸å¿ƒç‰¹æ€§**ï¼šæ·±å…¥ç†è§£äº‹åŠ¡æ¶ˆæ¯ã€é¡ºåºæ¶ˆæ¯ã€å»¶è¿Ÿæ¶ˆæ¯
2. **å®è·µä¸šåŠ¡åœºæ™¯**ï¼šåœ¨å®é™…é¡¹ç›®ä¸­åº”ç”¨RocketMQè§£å†³ä¸šåŠ¡é—®é¢˜
3. **æ€§èƒ½è°ƒä¼˜**ï¼šå­¦ä¼šåˆ†æå’Œä¼˜åŒ–RocketMQæ€§èƒ½
4. **è¿ç»´ç›‘æ§**ï¼šæŒæ¡é›†ç¾¤éƒ¨ç½²å’Œç›‘æ§å‘Šè­¦
5. **æºç å­¦ä¹ **ï¼šæœ‰æ¡ä»¶çš„è¯å¯ä»¥å­¦ä¹ RocketMQæºç å®ç°
:::

---

RocketMQä½œä¸ºé˜¿é‡Œå·´å·´å¼€æºçš„åˆ†å¸ƒå¼æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œåœ¨é‡‘èçº§åº”ç”¨åœºæ™¯ä¸­è¡¨ç°å‡ºè‰²ã€‚é€šè¿‡åˆç†çš„æ¶æ„è®¾è®¡å’Œæ€§èƒ½ä¼˜åŒ–ï¼Œå¯ä»¥æ„å»ºé«˜å¯ç”¨ã€é«˜æ€§èƒ½çš„æ¶ˆæ¯ç³»ç»Ÿï¼Œç‰¹åˆ«é€‚åˆå¯¹å¯é æ€§è¦æ±‚æé«˜çš„ä¸šåŠ¡åœºæ™¯ã€‚