---
sidebar_position: 2
title: RabbitMQæ¶ˆæ¯é˜Ÿåˆ—è¯¦è§£
description: æ·±å…¥ç†è§£RabbitMQæ¶æ„åŸç†ã€äº¤æ¢æœºç±»å‹ã€æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ä¸é«˜å¯ç”¨é›†ç¾¤éƒ¨ç½²å®è·µ
authors: [Laby]
tags: [RabbitMQ, æ¶ˆæ¯é˜Ÿåˆ—, AMQP, å¾®æœåŠ¡, å¼‚æ­¥é€šä¿¡, é«˜å¯ç”¨, é›†ç¾¤]
last_update:
  date: 2025-08-12
  author: Laby
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import CodeBlock from '@theme/CodeBlock';

# RabbitMQä¼ä¸šçº§æ¶ˆæ¯é˜Ÿåˆ—è¯¦è§£

RabbitMQæ˜¯ä¸€ä¸ªå¼€æºçš„æ¶ˆæ¯ä»£ç†ï¼ˆMessage Brokerï¼‰ï¼Œå®ç°äº†é«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®ï¼ˆAMQPï¼‰ã€‚å®ƒä»¥å…¶çµæ´»çš„è·¯ç”±æœºåˆ¶ã€å¯é çš„æ¶ˆæ¯ä¼ é€’ã€ä¸°å¯Œçš„ç®¡ç†åŠŸèƒ½å’Œå¼ºå¤§çš„é›†ç¾¤æ”¯æŒï¼Œæˆä¸ºä¼ä¸šçº§å¾®æœåŠ¡æ¶æ„ä¸­çš„æ ¸å¿ƒæ¶ˆæ¯ä¸­é—´ä»¶ã€‚

:::tip æ ¸å¿ƒä»·å€¼
**RabbitMQ = çµæ´»è·¯ç”± + å¯é ä¼ é€’ + é›†ç¾¤ç®¡ç† + ä¸°å¯Œç”Ÿæ€**
- ğŸ¯ **çµæ´»è·¯ç”±**ï¼šå››ç§äº¤æ¢æœºç±»å‹æ”¯æŒå¤æ‚è·¯ç”±ç­–ç•¥
- ğŸ›¡ï¸ **å¯é ä¼ é€’**ï¼šå®Œå–„çš„æ¶ˆæ¯ç¡®è®¤ã€æŒä¹…åŒ–å’Œäº‹åŠ¡æœºåˆ¶
- ğŸ”§ **æ˜“äºç®¡ç†**ï¼šç›´è§‚çš„Webç®¡ç†ç•Œé¢å’Œä¸°å¯Œçš„ç›‘æ§æŒ‡æ ‡
- ğŸŒ **é«˜å¯ç”¨æ€§**ï¼šæ”¯æŒé›†ç¾¤éƒ¨ç½²ã€é•œåƒé˜Ÿåˆ—å’Œæ•…éšœè½¬ç§»
- ğŸš€ **ç”Ÿæ€ä¸°å¯Œ**ï¼šå¤šè¯­è¨€å®¢æˆ·ç«¯ã€æ’ä»¶ç³»ç»Ÿå’ŒSpringé›†æˆ
:::

## 1. RabbitMQæ ¸å¿ƒæ¶æ„ä¸è®¾è®¡ç†å¿µ

### 1.1 AMQPåè®®ä¸æ¶æ„æ¨¡å‹

RabbitMQåŸºäºAMQPï¼ˆAdvanced Message Queuing Protocolï¼‰åè®®ï¼Œé‡‡ç”¨ç”Ÿäº§è€…-äº¤æ¢æœº-é˜Ÿåˆ—-æ¶ˆè´¹è€…çš„ç»å…¸æ¶æ„æ¨¡å¼ã€‚

```mermaid
graph TB
    subgraph "RabbitMQæ ¸å¿ƒæ¶æ„"
        P[Producerç”Ÿäº§è€…] --> E[Exchangeäº¤æ¢æœº]
        E --> Q1[Queueé˜Ÿåˆ—1]
        E --> Q2[Queueé˜Ÿåˆ—2]
        E --> Q3[Queueé˜Ÿåˆ—3]
        Q1 --> C1[Consumeræ¶ˆè´¹è€…1]
        Q2 --> C2[Consumeræ¶ˆè´¹è€…2]
        Q3 --> C3[Consumeræ¶ˆè´¹è€…3]
        
        B[Bindingç»‘å®š] -.-> E
        B -.-> Q1
        B -.-> Q2
        B -.-> Q3
    end
    
    subgraph "æ ¸å¿ƒç»„ä»¶"
        VH[Virtual Hostè™šæ‹Ÿä¸»æœº]
        CH[Channelä¿¡é“]
        CONN[Connectionè¿æ¥]
    end
```

#### æ ¸å¿ƒç»„ä»¶è¯¦è§£

| ç»„ä»¶ | ä½œç”¨ | ç‰¹ç‚¹ | åº”ç”¨åœºæ™¯ |
|------|------|------|----------|
| **Producer** | æ¶ˆæ¯ç”Ÿäº§è€… | å‘é€æ¶ˆæ¯åˆ°äº¤æ¢æœº | ä¸šåŠ¡ç³»ç»Ÿã€å®šæ—¶ä»»åŠ¡ |
| **Exchange** | æ¶ˆæ¯äº¤æ¢æœº | è·¯ç”±æ¶ˆæ¯åˆ°é˜Ÿåˆ— | æ¶ˆæ¯åˆ†å‘ã€è·¯ç”±æ§åˆ¶ |
| **Queue** | æ¶ˆæ¯é˜Ÿåˆ— | å­˜å‚¨æ¶ˆæ¯ | æ¶ˆæ¯ç¼“å­˜ã€è´Ÿè½½å‡è¡¡ |
| **Consumer** | æ¶ˆæ¯æ¶ˆè´¹è€… | å¤„ç†æ¶ˆæ¯ | ä¸šåŠ¡å¤„ç†ã€æ•°æ®åŒæ­¥ |
| **Binding** | ç»‘å®šå…³ç³» | è¿æ¥äº¤æ¢æœºå’Œé˜Ÿåˆ— | è·¯ç”±è§„åˆ™å®šä¹‰ |
| **Virtual Host** | è™šæ‹Ÿä¸»æœº | é€»è¾‘éš”ç¦» | å¤šç§Ÿæˆ·ã€ç¯å¢ƒéš”ç¦» |
| **Channel** | ä¿¡é“ | è½»é‡çº§è¿æ¥ | å¹¶å‘å¤„ç†ã€èµ„æºå¤ç”¨ |

### 1.2 RabbitMQåº”ç”¨åœºæ™¯å¯¹æ¯”

| åº”ç”¨åœºæ™¯ | ä¼ ç»Ÿæ–¹æ¡ˆ | RabbitMQæ–¹æ¡ˆ | æ ¸å¿ƒä¼˜åŠ¿ | é€‚ç”¨è§„æ¨¡ |
|---------|---------|-------------|----------|---------|
| **å¼‚æ­¥å¤„ç†** | åŒæ­¥è°ƒç”¨ | æ¶ˆæ¯é˜Ÿåˆ— | è§£è€¦ã€æå‡å“åº”é€Ÿåº¦ | é«˜å¹¶å‘ç³»ç»Ÿ |
| **æœåŠ¡è§£è€¦** | ç›´æ¥è°ƒç”¨ | äº‹ä»¶é©±åŠ¨ | é™ä½è€¦åˆåº¦ | å¾®æœåŠ¡æ¶æ„ |
| **æµé‡å‰Šå³°** | é™æµç†”æ–­ | é˜Ÿåˆ—ç¼“å†² | å¹³æ»‘å¤„ç†çªå‘æµé‡ | ç”µå•†ç§’æ€ |
| **æ•°æ®åˆ†å‘** | ç‚¹å¯¹ç‚¹æ¨é€ | å‘å¸ƒè®¢é˜… | ä¸€å¯¹å¤šå¹¿æ’­ | æ¶ˆæ¯é€šçŸ¥ |
| **ä»»åŠ¡è°ƒåº¦** | å®šæ—¶ä»»åŠ¡ | å»¶è¿Ÿé˜Ÿåˆ— | çµæ´»çš„ä»»åŠ¡è°ƒåº¦ | ä¸šåŠ¡æµç¨‹ |## 2
. äº¤æ¢æœºç±»å‹æ·±åº¦è§£æ

### 2.1 Direct Exchange - ç²¾ç¡®è·¯ç”±

Direct Exchangeé€šè¿‡å®Œå…¨åŒ¹é…è·¯ç”±é”®å®ç°ç‚¹å¯¹ç‚¹æ¶ˆæ¯ä¼ é€’ï¼Œæ˜¯æœ€ç®€å•é«˜æ•ˆçš„è·¯ç”±æ–¹å¼ã€‚

<Tabs>
<TabItem value="concept" label="å·¥ä½œåŸç†">

```mermaid
graph LR
    P[Producer] --> E[Direct Exchange]
    E -->|routing_key: order.created| Q1[Order Queue]
    E -->|routing_key: payment.success| Q2[Payment Queue]
    E -->|routing_key: user.registered| Q3[User Queue]
    
    Q1 --> C1[Order Service]
    Q2 --> C2[Payment Service]
    Q3 --> C3[User Service]
```

**è·¯ç”±è§„åˆ™**ï¼š
- æ¶ˆæ¯çš„routing_keyå¿…é¡»ä¸é˜Ÿåˆ—ç»‘å®šçš„binding_keyå®Œå…¨åŒ¹é…
- ä¸€ä¸ªäº¤æ¢æœºå¯ä»¥ç»‘å®šå¤šä¸ªé˜Ÿåˆ—ï¼Œæ¯ä¸ªé˜Ÿåˆ—å¯ä»¥æœ‰ä¸åŒçš„binding_key
- é€‚ç”¨äºéœ€è¦ç²¾ç¡®è·¯ç”±çš„åœºæ™¯

</TabItem>
<TabItem value="java-impl" label="Javaå®ç°">

```java title="Direct Exchangeå®Œæ•´å®ç°"
@Component
public class DirectExchangeService {
    
    private static final String EXCHANGE_NAME = "business.direct";
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    /**
     * é…ç½®Direct Exchangeå’Œé˜Ÿåˆ—
     */
    @Configuration
    public static class DirectExchangeConfig {
        
        // å£°æ˜Direct Exchange
        @Bean
        public DirectExchange businessDirectExchange() {
            return ExchangeBuilder.directExchange(EXCHANGE_NAME)
                .durable(true)  // æŒä¹…åŒ–
                .build();
        }
        
        // å£°æ˜é˜Ÿåˆ—
        @Bean
        public Queue orderQueue() {
            return QueueBuilder.durable("order.queue")
                .withArgument("x-message-ttl", 60000)  // æ¶ˆæ¯TTL 60ç§’
                .build();
        }
        
        @Bean
        public Queue paymentQueue() {
            return QueueBuilder.durable("payment.queue")
                .withArgument("x-max-length", 10000)   // é˜Ÿåˆ—æœ€å¤§é•¿åº¦
                .build();
        }
        
        // ç»‘å®šé˜Ÿåˆ—åˆ°äº¤æ¢æœº
        @Bean
        public Binding orderBinding() {
            return BindingBuilder
                .bind(orderQueue())
                .to(businessDirectExchange())
                .with("order.created");  // routing key
        }
        
        @Bean
        public Binding paymentBinding() {
            return BindingBuilder
                .bind(paymentQueue())
                .to(businessDirectExchange())
                .with("payment.success");
        }
    }
    
    /**
     * å‘é€è®¢å•åˆ›å»ºæ¶ˆæ¯
     */
    public void sendOrderCreated(OrderCreatedEvent event) {
        rabbitTemplate.convertAndSend(EXCHANGE_NAME, "order.created", event);
        log.info("è®¢å•åˆ›å»ºæ¶ˆæ¯å‘é€æˆåŠŸ: {}", event.getOrderId());
    }
    
    /**
     * å‘é€æ”¯ä»˜æˆåŠŸæ¶ˆæ¯
     */
    public void sendPaymentSuccess(PaymentSuccessEvent event) {
        rabbitTemplate.convertAndSend(EXCHANGE_NAME, "payment.success", event);
        log.info("æ”¯ä»˜æˆåŠŸæ¶ˆæ¯å‘é€: {}", event.getPaymentId());
    }
}

/**
 * æ¶ˆæ¯æ¶ˆè´¹è€…
 */
@Component
public class DirectExchangeConsumer {
    
    /**
     * å¤„ç†è®¢å•åˆ›å»ºæ¶ˆæ¯
     */
    @RabbitListener(queues = "order.queue")
    public void handleOrderCreated(OrderCreatedEvent event) {
        log.info("å¤„ç†è®¢å•åˆ›å»ºäº‹ä»¶: {}", event.getOrderId());
        // ä¸šåŠ¡å¤„ç†é€»è¾‘
        processOrderCreated(event);
    }
    
    /**
     * å¤„ç†æ”¯ä»˜æˆåŠŸæ¶ˆæ¯
     */
    @RabbitListener(queues = "payment.queue")
    public void handlePaymentSuccess(PaymentSuccessEvent event) {
        log.info("å¤„ç†æ”¯ä»˜æˆåŠŸäº‹ä»¶: {}", event.getPaymentId());
        // ä¸šåŠ¡å¤„ç†é€»è¾‘
        processPaymentSuccess(event);
    }
    
    private void processOrderCreated(OrderCreatedEvent event) {
        // è®¢å•å¤„ç†é€»è¾‘ï¼šåº“å­˜æ£€æŸ¥ã€é£æ§éªŒè¯ã€å‘é€ç¡®è®¤é‚®ä»¶
    }
    
    private void processPaymentSuccess(PaymentSuccessEvent event) {
        // æ”¯ä»˜å¤„ç†é€»è¾‘ï¼šæ›´æ–°è®¢å•çŠ¶æ€ã€å‘é€å‘è´§æŒ‡ä»¤ã€ç§¯åˆ†å¥–åŠ±
    }
}
```

</TabItem>
<TabItem value="use-cases" label="åº”ç”¨åœºæ™¯">

**Direct Exchangeå…¸å‹åº”ç”¨åœºæ™¯**ï¼š

1. **è®¢å•å¤„ç†ç³»ç»Ÿ**ï¼šä¸åŒè®¢å•çŠ¶æ€è·¯ç”±åˆ°ä¸åŒå¤„ç†é˜Ÿåˆ—
2. **ç”¨æˆ·è¡Œä¸ºåˆ†æ**ï¼šä¸åŒç”¨æˆ·è¡Œä¸ºè·¯ç”±åˆ°å¯¹åº”åˆ†æé˜Ÿåˆ—
3. **ç³»ç»Ÿé€šçŸ¥**ï¼šä¸åŒé€šçŸ¥ç±»å‹è·¯ç”±åˆ°å¯¹åº”å‘é€é˜Ÿåˆ—
4. **ä»»åŠ¡åˆ†å‘**ï¼šä¸åŒä»»åŠ¡ç±»å‹è·¯ç”±åˆ°ä¸“é—¨çš„å¤„ç†é˜Ÿåˆ—

```java title="åº”ç”¨åœºæ™¯ç¤ºä¾‹"
// è®¢å•çŠ¶æ€å˜æ›´
public void sendOrderStatusChange(String orderId, OrderStatus status) {
    String routingKey = "order.status." + status.name().toLowerCase();
    rabbitTemplate.convertAndSend("order.direct", routingKey, 
        new OrderStatusEvent(orderId, status));
}

// ç”¨æˆ·è¡Œä¸ºè¿½è¸ª
public void trackUserAction(String userId, String action) {
    String routingKey = "user.action." + action;
    UserActionEvent event = new UserActionEvent(userId, action, System.currentTimeMillis());
    rabbitTemplate.convertAndSend("user.direct", routingKey, event);
}
```

</TabItem>
</Tabs>

### 2.2 Topic Exchange - æ¨¡å¼åŒ¹é…è·¯ç”±

Topic Exchangeä½¿ç”¨é€šé…ç¬¦è¿›è¡Œæ¨¡å¼åŒ¹é…ï¼Œæ”¯æŒçµæ´»çš„è·¯ç”±è§„åˆ™ï¼Œæ˜¯æœ€å¼ºå¤§çš„è·¯ç”±æ–¹å¼ã€‚

<Tabs>
<TabItem value="concept" label="å·¥ä½œåŸç†">

```mermaid
graph TB
    P[Producer] --> E[Topic Exchange]
    
    E -->|user.*| Q1[User Queue]
    E -->|*.order| Q2[Order Queue] 
    E -->|system.#| Q3[System Queue]
    E -->|#| Q4[All Queue]
    
    subgraph "è·¯ç”±ç¤ºä¾‹"
        R1[user.registered] --> Q1
        R1 --> Q4
        R2[user.order] --> Q1
        R2 --> Q2
        R2 --> Q4
        R3[system.error.database] --> Q3
        R3 --> Q4
    end
```

**é€šé…ç¬¦è§„åˆ™**ï¼š
- `*`ï¼šåŒ¹é…ä¸€ä¸ªå•è¯ï¼ˆwordï¼‰
- `#`ï¼šåŒ¹é…é›¶ä¸ªæˆ–å¤šä¸ªå•è¯
- `.`ï¼šå•è¯åˆ†éš”ç¬¦
- è·¯ç”±é”®å’Œç»‘å®šé”®éƒ½æ˜¯ç”±`.`åˆ†éš”çš„å•è¯åˆ—è¡¨

</TabItem>
<TabItem value="java-impl" label="Javaå®ç°">

```java title="Topic Exchangeå®Œæ•´å®ç°"
@Component
public class TopicExchangeService {
    
    private static final String EXCHANGE_NAME = "events.topic";
    
    @Configuration
    public static class TopicExchangeConfig {
        
        @Bean
        public TopicExchange eventsTopicExchange() {
            return ExchangeBuilder.topicExchange(EXCHANGE_NAME)
                .durable(true)
                .build();
        }
        
        // ç”¨æˆ·ç›¸å…³é˜Ÿåˆ— - åŒ¹é… user.*
        @Bean
        public Queue userEventsQueue() {
            return QueueBuilder.durable("user.events.queue").build();
        }
        
        // è®¢å•ç›¸å…³é˜Ÿåˆ— - åŒ¹é… *.order
        @Bean  
        public Queue orderEventsQueue() {
            return QueueBuilder.durable("order.events.queue").build();
        }
        
        // ç³»ç»Ÿæ—¥å¿—é˜Ÿåˆ— - åŒ¹é… system.#
        @Bean
        public Queue systemLogsQueue() {
            return QueueBuilder.durable("system.logs.queue").build();
        }
        
        // ç»‘å®šå…³ç³»
        @Bean
        public Binding userEventsBinding() {
            return BindingBuilder.bind(userEventsQueue())
                .to(eventsTopicExchange()).with("user.*");
        }
        
        @Bean
        public Binding orderEventsBinding() {
            return BindingBuilder.bind(orderEventsQueue())
                .to(eventsTopicExchange()).with("*.order");
        }
        
        @Bean
        public Binding systemLogsBinding() {
            return BindingBuilder.bind(systemLogsQueue())
                .to(eventsTopicExchange()).with("system.#");
        }
    }
    
    /**
     * å‘é€ç”¨æˆ·äº‹ä»¶
     */
    public void sendUserEvent(String eventType, Object eventData) {
        String routingKey = "user." + eventType;
        rabbitTemplate.convertAndSend(EXCHANGE_NAME, routingKey, eventData);
        log.info("ç”¨æˆ·äº‹ä»¶å‘é€: {} -> {}", routingKey, eventData);
    }
    
    /**
     * å‘é€è®¢å•äº‹ä»¶  
     */
    public void sendOrderEvent(String source, Object eventData) {
        String routingKey = source + ".order";
        rabbitTemplate.convertAndSend(EXCHANGE_NAME, routingKey, eventData);
        log.info("è®¢å•äº‹ä»¶å‘é€: {} -> {}", routingKey, eventData);
    }
}
```

</TabItem>
<TabItem value="patterns" label="è·¯ç”±æ¨¡å¼">

```bash title="Topic Exchangeè·¯ç”±æ¨¡å¼ç¤ºä¾‹"
# 1. åŸºç¡€æ¨¡å¼åŒ¹é…
user.registered     -> user.*     âœ“ åŒ¹é…
user.login         -> user.*     âœ“ åŒ¹é…  
user.profile.update -> user.*     âœ— ä¸åŒ¹é…

# 2. åç¼€æ¨¡å¼åŒ¹é…
web.order          -> *.order    âœ“ åŒ¹é…
mobile.order       -> *.order    âœ“ åŒ¹é…
api.order.cancel   -> *.order    âœ— ä¸åŒ¹é…

# 3. å¤šçº§æ¨¡å¼åŒ¹é…
system.error       -> system.#   âœ“ åŒ¹é…
system.error.db    -> system.#   âœ“ åŒ¹é…
system.warn.cache  -> system.#   âœ“ åŒ¹é…
user.error         -> system.#   âœ— ä¸åŒ¹é…

# 4. å…¨åŒ¹é…æ¨¡å¼
ä»»ä½•æ¶ˆæ¯            -> #          âœ“ å…¨éƒ¨åŒ¹é…
```

</TabItem>
</Tabs>

### 2.3 Fanout Exchange - å¹¿æ’­è·¯ç”±

Fanout Exchangeå°†æ¶ˆæ¯å¹¿æ’­åˆ°æ‰€æœ‰ç»‘å®šçš„é˜Ÿåˆ—ï¼Œå®ç°å‘å¸ƒ-è®¢é˜…æ¨¡å¼ã€‚

<Tabs>
<TabItem value="concept" label="å·¥ä½œåŸç†">

```mermaid
graph TB
    P[Producer] --> E[Fanout Exchange]
    E --> Q1[Email Queue]
    E --> Q2[SMS Queue]
    E --> Q3[Push Queue]
    E --> Q4[Log Queue]
    
    Q1 --> C1[Email Service]
    Q2 --> C2[SMS Service]
    Q3 --> C3[Push Service]
    Q4 --> C4[Log Service]
```

**ç‰¹ç‚¹**ï¼š
- å¿½ç•¥è·¯ç”±é”®ï¼Œæ¶ˆæ¯å¹¿æ’­åˆ°æ‰€æœ‰ç»‘å®šé˜Ÿåˆ—
- æ€§èƒ½æœ€é«˜ï¼Œè·¯ç”±é€»è¾‘æœ€ç®€å•
- é€‚ç”¨äºå‘å¸ƒ-è®¢é˜…åœºæ™¯

</TabItem>
<TabItem value="java-impl" label="Javaå®ç°">

```java title="Fanout Exchangeå®ç°"
@Component
public class FanoutExchangeService {
    
    private static final String EXCHANGE_NAME = "notifications.fanout";
    
    @Configuration
    public static class FanoutExchangeConfig {
        
        @Bean
        public FanoutExchange notificationsFanoutExchange() {
            return ExchangeBuilder.fanoutExchange(EXCHANGE_NAME)
                .durable(true)
                .build();
        }
        
        @Bean
        public Queue emailNotificationQueue() {
            return QueueBuilder.durable("email.notification.queue").build();
        }
        
        @Bean
        public Queue smsNotificationQueue() {
            return QueueBuilder.durable("sms.notification.queue").build();
        }
        
        @Bean
        public Queue pushNotificationQueue() {
            return QueueBuilder.durable("push.notification.queue").build();
        }
        
        // ç»‘å®šæ‰€æœ‰é˜Ÿåˆ—åˆ°Fanout Exchangeï¼ˆæ— éœ€è·¯ç”±é”®ï¼‰
        @Bean
        public Binding emailNotificationBinding() {
            return BindingBuilder.bind(emailNotificationQueue())
                .to(notificationsFanoutExchange());
        }
        
        @Bean
        public Binding smsNotificationBinding() {
            return BindingBuilder.bind(smsNotificationQueue())
                .to(notificationsFanoutExchange());
        }
        
        @Bean
        public Binding pushNotificationBinding() {
            return BindingBuilder.bind(pushNotificationQueue())
                .to(notificationsFanoutExchange());
        }
    }
    
    /**
     * å¹¿æ’­é€šçŸ¥æ¶ˆæ¯
     */
    public void broadcastNotification(NotificationEvent event) {
        // è·¯ç”±é”®è¢«å¿½ç•¥ï¼Œå¯ä»¥ä¼ ç©ºå­—ç¬¦ä¸²
        rabbitTemplate.convertAndSend(EXCHANGE_NAME, "", event);
        log.info("å¹¿æ’­é€šçŸ¥æ¶ˆæ¯: {}", event.getMessage());
    }
}
```

</TabItem>
</Tabs>

### 2.4 Headers Exchange - å±æ€§è·¯ç”±

Headers Exchangeæ ¹æ®æ¶ˆæ¯å¤´éƒ¨å±æ€§è¿›è¡Œè·¯ç”±ï¼Œæä¾›æœ€çµæ´»çš„è·¯ç”±æœºåˆ¶ã€‚

<Tabs>
<TabItem value="concept" label="å·¥ä½œåŸç†">

```mermaid
graph TB
    P[Producer] --> E[Headers Exchange]
    
    E -->|x-match: all<br/>type: order<br/>priority: high| Q1[High Priority Order Queue]
    E -->|x-match: any<br/>type: notification<br/>channel: email| Q2[Email Notification Queue]
    E -->|x-match: any<br/>type: notification<br/>channel: sms| Q3[SMS Notification Queue]
    
    Q1 --> C1[High Priority Processor]
    Q2 --> C2[Email Service]
    Q3 --> C3[SMS Service]
```

**åŒ¹é…è§„åˆ™**ï¼š
- `x-match: all`ï¼šæ‰€æœ‰æŒ‡å®šçš„å¤´éƒ¨å±æ€§éƒ½å¿…é¡»åŒ¹é…
- `x-match: any`ï¼šä»»æ„ä¸€ä¸ªæŒ‡å®šçš„å¤´éƒ¨å±æ€§åŒ¹é…å³å¯
- æ”¯æŒå¤æ‚çš„å±æ€§ç»„åˆåŒ¹é…

</TabItem>
<TabItem value="java-impl" label="Javaå®ç°">

```java title="Headers Exchangeå®ç°"
@Component
public class HeadersExchangeService {
    
    private static final String EXCHANGE_NAME = "headers.exchange";
    
    @Configuration
    public static class HeadersExchangeConfig {
        
        @Bean
        public HeadersExchange headersExchange() {
            return ExchangeBuilder.headersExchange(EXCHANGE_NAME)
                .durable(true)
                .build();
        }
        
        @Bean
        public Queue highPriorityQueue() {
            return QueueBuilder.durable("high.priority.queue").build();
        }
        
        @Bean
        public Queue emailQueue() {
            return QueueBuilder.durable("email.queue").build();
        }
        
        // ç»‘å®šé«˜ä¼˜å…ˆçº§é˜Ÿåˆ— - éœ€è¦åŒæ—¶åŒ¹é…type=orderå’Œpriority=high
        @Bean
        public Binding highPriorityBinding() {
            Map<String, Object> headers = new HashMap<>();
            headers.put("x-match", "all");
            headers.put("type", "order");
            headers.put("priority", "high");
            
            return BindingBuilder.bind(highPriorityQueue())
                .to(headersExchange()).whereAll(headers).match();
        }
        
        // ç»‘å®šé‚®ä»¶é˜Ÿåˆ— - åŒ¹é…type=notificationæˆ–channel=email
        @Bean
        public Binding emailBinding() {
            Map<String, Object> headers = new HashMap<>();
            headers.put("x-match", "any");
            headers.put("type", "notification");
            headers.put("channel", "email");
            
            return BindingBuilder.bind(emailQueue())
                .to(headersExchange()).whereAny(headers).match();
        }
    }
    
    /**
     * å‘é€å¸¦å¤´éƒ¨å±æ€§çš„æ¶ˆæ¯
     */
    public void sendMessageWithHeaders(Object message, Map<String, Object> headers) {
        MessageProperties properties = new MessageProperties();
        
        // è®¾ç½®å¤´éƒ¨å±æ€§
        for (Map.Entry<String, Object> entry : headers.entrySet()) {
            properties.setHeader(entry.getKey(), entry.getValue());
        }
        
        Message rabbitMessage = new Message(
            rabbitTemplate.getMessageConverter().toMessage(message, properties).getBody(),
            properties
        );
        
        rabbitTemplate.send(EXCHANGE_NAME, "", rabbitMessage);
        log.info("Headersæ¶ˆæ¯å‘é€æˆåŠŸï¼Œå¤´éƒ¨: {}", headers);
    }
    
    /**
     * å‘é€é«˜ä¼˜å…ˆçº§è®¢å•æ¶ˆæ¯
     */
    public void sendHighPriorityOrder(OrderEvent event) {
        Map<String, Object> headers = new HashMap<>();
        headers.put("type", "order");
        headers.put("priority", "high");
        headers.put("source", "web");
        
        sendMessageWithHeaders(event, headers);
    }
    
    /**
     * å‘é€é‚®ä»¶é€šçŸ¥æ¶ˆæ¯
     */
    public void sendEmailNotification(NotificationEvent event) {
        Map<String, Object> headers = new HashMap<>();
        headers.put("type", "notification");
        headers.put("channel", "email");
        headers.put("urgent", false);
        
        sendMessageWithHeaders(event, headers);
    }
}
```

</TabItem>
</Tabs>