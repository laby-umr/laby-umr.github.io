---
sidebar_position: 3
title: "é«˜å¯ç”¨æ€§ç³»ç»Ÿè®¾è®¡"
description: "æ·±å…¥ç†è§£é«˜å¯ç”¨æ€§ç³»ç»Ÿè®¾è®¡åŸç†ã€æ•…éšœå¤„ç†ä¸å®¹é”™æœºåˆ¶"
authors: [Laby]
last_update:
  date: 2025-08-07
  author: Laby
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import TOCInline from '@theme/TOCInline';

# é«˜å¯ç”¨æ€§ç³»ç»Ÿè®¾è®¡

é«˜å¯ç”¨æ€§ç³»ç»Ÿè®¾è®¡æ˜¯æ„å»ºç¨³å®šå¯é ã€æŒç»­æä¾›æœåŠ¡ç³»ç»Ÿçš„æ ¸å¿ƒæŠ€æœ¯ã€‚é€šè¿‡å†—ä½™è®¾è®¡ã€æ•…éšœè½¬ç§»ã€ç›‘æ§å‘Šè­¦ç­‰æœºåˆ¶ï¼Œå¯ä»¥æ„å»ºå‡ºé«˜å¯ç”¨çš„ç³»ç»Ÿã€‚

:::info æœ¬æ–‡å†…å®¹æ¦‚è§ˆ
<TOCInline toc={toc} />
:::

:::tip æ ¸å¿ƒä»·å€¼
**é«˜å¯ç”¨æ€§ = å†—ä½™è®¾è®¡ + æ•…éšœè½¬ç§» + å®¹é”™æœºåˆ¶ + ç›‘æ§å‘Šè­¦ + è‡ªåŠ¨æ¢å¤**
- ğŸ”„ **å†—ä½™è®¾è®¡**ï¼šé¿å…å•ç‚¹æ•…éšœï¼Œç¡®ä¿ç³»ç»ŸæŒç»­è¿è¡Œ
- ğŸ”€ **æ•…éšœè½¬ç§»**ï¼šåœ¨æ•…éšœå‘ç”Ÿæ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨èµ„æº
- ğŸ›¡ï¸ **å®¹é”™æœºåˆ¶**ï¼šéš”ç¦»æ•…éšœï¼Œé˜²æ­¢æ•…éšœæ‰©æ•£
- ğŸ”” **ç›‘æ§å‘Šè­¦**ï¼šå®æ—¶å‘ç°é—®é¢˜ï¼Œå¿«é€Ÿå“åº”å¤„ç†
- ğŸ” **è‡ªåŠ¨æ¢å¤**ï¼šç³»ç»Ÿèƒ½å¤Ÿè‡ªæˆ‘ä¿®å¤ï¼Œå‡å°‘äººå·¥å¹²é¢„
:::

## 1. é«˜å¯ç”¨æ€§åŸºç¡€

### 1.1 å¯ç”¨æ€§æŒ‡æ ‡

é«˜å¯ç”¨æ€§ç³»ç»Ÿçš„æ ¸å¿ƒæŒ‡æ ‡ï¼š

```mermaid
graph LR
    A["é«˜å¯ç”¨æ€§æŒ‡æ ‡"] --> B["å¯ç”¨æ€§ (Availability)"]
    A --> C["MTBF (å¹³å‡æ•…éšœé—´éš”æ—¶é—´)"]
    A --> D["MTTR (å¹³å‡æ•…éšœä¿®å¤æ—¶é—´)"]
    A --> E["RTO (æ¢å¤æ—¶é—´ç›®æ ‡)"]
    A --> F["RPO (æ¢å¤ç‚¹ç›®æ ‡)"]
    
    B --> B1["è¡¡é‡ç³»ç»Ÿæ­£å¸¸è¿è¡Œæ—¶é—´æ¯”ä¾‹"]
    C --> C1["è¡¡é‡ç³»ç»Ÿç¨³å®šæ€§ï¼Œè¶Šé•¿è¶Šå¥½"]
    D --> D1["è¡¡é‡æ¢å¤é€Ÿåº¦ï¼Œè¶ŠçŸ­è¶Šå¥½"]
    E --> E1["æœåŠ¡æ¢å¤æ‰€éœ€æœ€é•¿æ—¶é—´"]
    F --> F1["å¯æ¥å—çš„æ•°æ®ä¸¢å¤±æ—¶é—´èŒƒå›´"]
```

| æŒ‡æ ‡ | è¯´æ˜ | ç›®æ ‡å€¼ | è®¡ç®—æ–¹å¼ |
|------|------|--------|---------|
| **å¯ç”¨æ€§ (Availability)** | ç³»ç»Ÿæ­£å¸¸è¿è¡Œæ—¶é—´æ¯”ä¾‹ | 99.9%+ | `(æ€»æ—¶é—´ - æ•…éšœæ—¶é—´) / æ€»æ—¶é—´` |
| **MTBF (Mean Time Between Failures)** | å¹³å‡æ•…éšœé—´éš”æ—¶é—´ | è¶Šé•¿è¶Šå¥½ | `æ€»è¿è¡Œæ—¶é—´ / æ•…éšœæ¬¡æ•°` |
| **MTTR (Mean Time To Repair)** | å¹³å‡æ•…éšœä¿®å¤æ—¶é—´ | è¶ŠçŸ­è¶Šå¥½ | `æ€»ä¿®å¤æ—¶é—´ / æ•…éšœæ¬¡æ•°` |
| **RTO (Recovery Time Objective)** | æ¢å¤æ—¶é—´ç›®æ ‡ | < 5åˆ†é’Ÿ | ä¸šåŠ¡å¯æ¥å—çš„æœ€é•¿æ¢å¤æ—¶é—´ |
| **RPO (Recovery Point Objective)** | æ¢å¤ç‚¹ç›®æ ‡ | < 1åˆ†é’Ÿ | ä¸šåŠ¡å¯æ¥å—çš„æ•°æ®ä¸¢å¤±æ—¶é—´ |

<details>
<summary>å¯ç”¨æ€§ç­‰çº§å‚è€ƒ</summary>

| å¯ç”¨æ€§çº§åˆ« | å¹´åº¦åœæœºæ—¶é—´ | æè¿° |
|-----------|-------------|------|
| 99% | 87.6å°æ—¶ | åŸºæœ¬å¯ç”¨ |
| 99.9% | 8.76å°æ—¶ | é«˜å¯ç”¨ |
| 99.99% | 52.56åˆ†é’Ÿ | å¾ˆé«˜å¯ç”¨ |
| 99.999% | 5.26åˆ†é’Ÿ | æé«˜å¯ç”¨ |
| 99.9999% | 31.5ç§’ | æ¥è¿‘å®Œå…¨å¯ç”¨ |

</details>

<Tabs>
  <TabItem value="calculation" label="å¯ç”¨æ€§è®¡ç®—" default>
  ```java
  public double calculateAvailability() {
      long total = totalRequests.get();
      long failed = failedRequests.get();
      
      if (total == 0) {
          return 100.0;
      }
      
      return ((double) (total - failed) / total) * 100;
  }
  ```
  </TabItem>
  <TabItem value="metrics" label="æŒ‡æ ‡ç›‘æ§">
  ```java
  public void recordRequest(boolean success) {
      totalRequests.incrementAndGet();
      if (!success) {
          failedRequests.incrementAndGet();
      }
      
      // è®¡ç®—å¯ç”¨æ€§
      double availability = calculateAvailability();
      
      // è®°å½•åˆ°ç›‘æ§ç³»ç»Ÿ
      Gauge.builder("system.availability")
          .register(meterRegistry, this, AvailabilityMonitor::calculateAvailability);
  }
  ```
  </TabItem>
  <TabItem value="mtbf" label="MTBFè®¡ç®—">
  ```java
  public double getMTBF() {
      // è®¡ç®—å¹³å‡æ•…éšœé—´éš”æ—¶é—´
      long totalTime = getUptime();
      long failureCount = failedRequests.get();
      
      if (failureCount == 0) {
          return Double.MAX_VALUE;
      }
      
      return (double) totalTime / failureCount;
  }
  ```
  </TabItem>
</Tabs>

### 1.2 æ•…éšœç±»å‹åˆ†æ

<div className="card">
<div className="card__body">

æ•…éšœç±»å‹å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ç±»ï¼š

1. **ç¡¬ä»¶æ•…éšœ**ï¼šæœåŠ¡å™¨ã€ç½‘ç»œè®¾å¤‡ã€å­˜å‚¨è®¾å¤‡æ•…éšœ
2. **è½¯ä»¶æ•…éšœ**ï¼šç¨‹åºå´©æºƒã€å†…å­˜æ³„æ¼ã€æ­»é”
3. **ç½‘ç»œæ•…éšœ**ï¼šç½‘ç»œä¸­æ–­ã€å»¶è¿Ÿè¿‡é«˜ã€ä¸¢åŒ…
4. **äººä¸ºæ•…éšœ**ï¼šé…ç½®é”™è¯¯ã€è¯¯æ“ä½œã€ä»£ç ç¼ºé™·
5. **è‡ªç„¶ç¾å®³**ï¼šåœ°éœ‡ã€ç«ç¾ã€æ´ªæ°´
6. **å¤–éƒ¨ä¾èµ–æ•…éšœ**ï¼šç¬¬ä¸‰æ–¹æœåŠ¡æ•…éšœã€APIé™æµ

</div>
</div>

```mermaid
mindmap
  root((æ•…éšœç±»å‹))
    ç¡¬ä»¶æ•…éšœ
      æœåŠ¡å™¨ç¡¬ä»¶
      ç½‘ç»œè®¾å¤‡
      å­˜å‚¨è®¾å¤‡
    è½¯ä»¶æ•…éšœ
      ç¨‹åºå´©æºƒ
      å†…å­˜æ³„æ¼
      æ­»é”
    ç½‘ç»œæ•…éšœ
      è¿æ¥ä¸­æ–­
      å»¶è¿Ÿè¿‡é«˜
      ä¸¢åŒ…
    äººä¸ºæ•…éšœ
      é…ç½®é”™è¯¯
      è¯¯æ“ä½œ
      ä»£ç ç¼ºé™·
    è‡ªç„¶ç¾å®³
      åœ°éœ‡
      ç«ç¾
      æ´ªæ°´
    å¤–éƒ¨ä¾èµ–
      ç¬¬ä¸‰æ–¹æœåŠ¡
      APIé™æµ
```

<Tabs>
  <TabItem value="code" label="æ•…éšœå¤„ç†ç­–ç•¥" default>
  ```java
  @Component
  public class FailureHandler {
      
      private final Map<FailureType, FailureStrategy> strategies = new HashMap<>();
      
      public FailureHandler() {
          strategies.put(FailureType.HARDWARE_FAILURE, new HardwareFailureStrategy());
          strategies.put(FailureType.SOFTWARE_FAILURE, new SoftwareFailureStrategy());
          strategies.put(FailureType.NETWORK_FAILURE, new NetworkFailureStrategy());
          strategies.put(FailureType.EXTERNAL_DEPENDENCY, new ExternalDependencyStrategy());
      }
      
      public void handleFailure(FailureType type, String details) {
          FailureStrategy strategy = strategies.get(type);
          if (strategy != null) {
              strategy.handle(details);
          } else {
              log.error("æœªçŸ¥æ•…éšœç±»å‹: {}", type);
          }
      }
  }
  ```
  </TabItem>
  <TabItem value="strategies" label="å…·ä½“ç­–ç•¥å®ç°">
  ```java
  class HardwareFailureStrategy implements FailureStrategy {
      @Override
      public void handle(String details) {
          // ç¡¬ä»¶æ•…éšœå¤„ç†ï¼šåˆ‡æ¢åˆ°å¤‡ç”¨æœåŠ¡å™¨
          log.info("å¤„ç†ç¡¬ä»¶æ•…éšœ: {}", details);
          // æ‰§è¡Œæ•…éšœè½¬ç§»é€»è¾‘
      }
  }
  
  class NetworkFailureStrategy implements FailureStrategy {
      @Override
      public void handle(String details) {
          // ç½‘ç»œæ•…éšœå¤„ç†ï¼šå°è¯•é‡è¿æˆ–åˆ‡æ¢ç½‘ç»œ
          log.info("å¤„ç†ç½‘ç»œæ•…éšœ: {}", details);
          // æ‰§è¡Œç½‘ç»œæ¢å¤é€»è¾‘
      }
  }
  ```
  </TabItem>
</Tabs>

## 2. å†—ä½™è®¾è®¡

:::info
å†—ä½™è®¾è®¡æ˜¯é«˜å¯ç”¨ç³»ç»Ÿçš„åŸºç¡€ï¼Œé€šè¿‡éƒ¨ç½²å¤šä»½ç›¸åŒçš„èµ„æºï¼Œåœ¨ä¸€ä»½èµ„æºæ•…éšœæ—¶å¯ä»¥ç”±å…¶ä»–èµ„æºæ¥ç®¡å·¥ä½œã€‚
:::

### 2.1 ç¡¬ä»¶å†—ä½™

ç¡¬ä»¶å†—ä½™ä¸»è¦åŒ…æ‹¬ï¼šæœåŠ¡å™¨å†—ä½™ã€ç½‘ç»œå†—ä½™ã€å­˜å‚¨å†—ä½™å’Œç”µåŠ›å†—ä½™ã€‚

```mermaid
graph TD
    A[ç¡¬ä»¶å†—ä½™] --> B[æœåŠ¡å™¨å†—ä½™]
    A --> C[ç½‘ç»œå†—ä½™]
    A --> D[å­˜å‚¨å†—ä½™]
    A --> E[ç”µåŠ›å†—ä½™]
    
    B --> B1[ä¸»å¤‡æœåŠ¡å™¨]
    B --> B2[é›†ç¾¤éƒ¨ç½²]
    
    C --> C1[å¤šç½‘ç»œæ¥å£]
    C --> C2[å¤šç½‘ç»œæä¾›å•†]
    
    D --> D1[RAIDé˜µåˆ—]
    D --> D2[å¤šåœ°å¤‡ä»½]
    
    E --> E1[UPSä¸é—´æ–­ç”µæº]
    E --> E2[å‘ç”µæœº]
```

<Tabs>
  <TabItem value="database" label="æ•°æ®åº“å†—ä½™" default>
  ```java
  @Configuration
  public class HardwareRedundancyConfig {
      
      @Bean
      @Primary
      public DataSource primaryDataSource() {
          HikariConfig config = new HikariConfig();
          config.setJdbcUrl("jdbc:mysql://primary-db:3306/test");
          config.setUsername("root");
          config.setPassword("password");
          config.setMaximumPoolSize(20);
          return new HikariDataSource(config);
      }
      
      @Bean
      public DataSource secondaryDataSource() {
          HikariConfig config = new HikariConfig();
          config.setJdbcUrl("jdbc:mysql://secondary-db:3306/test");
          config.setUsername("root");
          config.setPassword("password");
          config.setMaximumPoolSize(20);
          return new HikariDataSource(config);
      }
      
      @Bean
      public DataSource routingDataSource() {
          RoutingDataSource routingDataSource = new RoutingDataSource();
          Map<Object, Object> targetDataSources = new HashMap<>();
          targetDataSources.put("primary", primaryDataSource());
          targetDataSources.put("secondary", secondaryDataSource());
          routingDataSource.setTargetDataSources(targetDataSources);
          routingDataSource.setDefaultTargetDataSource(primaryDataSource());
          return routingDataSource;
      }
  }
  ```
  </TabItem>
  <TabItem value="routing" label="æ•°æ®æºè·¯ç”±">
  ```java
  // æ•°æ®æºè·¯ç”±
  public class RoutingDataSource extends AbstractRoutingDataSource {
      
      @Override
      protected Object determineCurrentLookupKey() {
          return DataSourceContextHolder.getDataSourceType();
      }
  }
  
  // æ•°æ®æºä¸Šä¸‹æ–‡
  public class DataSourceContextHolder {
      
      private static final ThreadLocal<String> contextHolder = new ThreadLocal<>();
      
      public static void setDataSourceType(String dataSourceType) {
          contextHolder.set(dataSourceType);
      }
      
      public static String getDataSourceType() {
          return contextHolder.get();
      }
      
      public static void clearDataSourceType() {
          contextHolder.remove();
      }
  }
  ```
  </TabItem>
</Tabs>

:::caution æ³¨æ„äº‹é¡¹
ç¡¬ä»¶å†—ä½™è™½ç„¶å¢åŠ äº†ç³»ç»Ÿå¯é æ€§ï¼Œä½†ä¹Ÿå¢åŠ äº†æˆæœ¬å’Œå¤æ‚åº¦ã€‚åœ¨è®¾è®¡æ—¶ï¼Œéœ€è¦åœ¨å¯é æ€§å’Œæˆæœ¬ä¹‹é—´æ‰¾åˆ°å¹³è¡¡ç‚¹ã€‚
:::

### 2.2 è½¯ä»¶å†—ä½™

è½¯ä»¶å†—ä½™ä¸»è¦åŒ…æ‹¬ï¼šæœåŠ¡å®ä¾‹å†—ä½™ã€é€šä¿¡æœºåˆ¶å†—ä½™å’Œæ•°æ®å­˜å‚¨å†—ä½™ã€‚

```mermaid
graph TD
    A[è½¯ä»¶å†—ä½™] --> B[æœåŠ¡å®ä¾‹å†—ä½™]
    A --> C[é€šä¿¡æœºåˆ¶å†—ä½™]
    A --> D[æ•°æ®å­˜å‚¨å†—ä½™]
    
    B --> B1[å¤šå®ä¾‹éƒ¨ç½²]
    B --> B2[å¤šåŒºåŸŸéƒ¨ç½²]
    
    C --> C1[å¤šç§é€šä¿¡åè®®]
    C --> C2[æ¶ˆæ¯é˜Ÿåˆ—]
    C --> C3[é‡è¯•æœºåˆ¶]
    
    D --> D1[å¤šæ•°æ®åº“å®ä¾‹]
    D --> D2[ç¼“å­˜+æ•°æ®åº“]
```

<Tabs>
  <TabItem value="service" label="æœåŠ¡å†—ä½™" default>
  ```java
  @Service
  public class ServiceRedundancy {
      
      @Autowired
      private List<EmailService> emailServices;
      
      @Autowired
      private CircuitBreaker circuitBreaker;
      
      public void sendEmail(String to, String subject, String content) {
          // å°è¯•æ‰€æœ‰å¯ç”¨çš„é‚®ä»¶æœåŠ¡
          for (EmailService emailService : emailServices) {
              try {
                  if (circuitBreaker.isHealthy(emailService.getClass().getSimpleName())) {
                      emailService.sendEmail(to, subject, content);
                      return; // å‘é€æˆåŠŸï¼Œé€€å‡º
                  }
              } catch (Exception e) {
                  log.error("é‚®ä»¶æœåŠ¡ {} å‘é€å¤±è´¥", emailService.getClass().getSimpleName(), e);
                  circuitBreaker.recordFailure(emailService.getClass().getSimpleName());
              }
          }
          
          // æ‰€æœ‰æœåŠ¡éƒ½å¤±è´¥ï¼Œè®°å½•é”™è¯¯
          log.error("æ‰€æœ‰é‚®ä»¶æœåŠ¡éƒ½ä¸å¯ç”¨");
          throw new ServiceUnavailableException("é‚®ä»¶æœåŠ¡ä¸å¯ç”¨");
      }
  }
  ```
  </TabItem>
  <TabItem value="circuit" label="ç†”æ–­å™¨å®ç°">
  ```java
  @Component
  public class CircuitBreaker {
      
      private Map<String, CircuitBreakerState> states = new ConcurrentHashMap<>();
      
      public boolean isHealthy(String serviceName) {
          CircuitBreakerState state = states.get(serviceName);
          if (state == null) {
              state = new CircuitBreakerState();
              states.put(serviceName, state);
          }
          return state.isHealthy();
      }
      
      public void recordFailure(String serviceName) {
          CircuitBreakerState state = states.get(serviceName);
          if (state != null) {
              state.recordFailure();
          }
      }
      
      public void recordSuccess(String serviceName) {
          CircuitBreakerState state = states.get(serviceName);
          if (state != null) {
              state.recordSuccess();
          }
      }
  }
  ```
  </TabItem>
</Tabs>

## 3. æ•…éšœè½¬ç§»æœºåˆ¶

æ•…éšœè½¬ç§»æ˜¯é«˜å¯ç”¨ç³»ç»Ÿçš„æ ¸å¿ƒæœºåˆ¶ï¼Œèƒ½å¤Ÿåœ¨å‡ºç°æ•…éšœæ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨èµ„æºï¼Œä¿è¯ç³»ç»Ÿçš„æŒç»­å¯ç”¨ã€‚

### 3.1 è‡ªåŠ¨æ•…éšœè½¬ç§»

<details>
<summary>æ•…éšœè½¬ç§»æµç¨‹</summary>

```mermaid
sequenceDiagram
    participant Client
    participant LoadBalancer
    participant ServiceA
    participant ServiceB
    
    Client->>LoadBalancer: è¯·æ±‚æœåŠ¡
    LoadBalancer->>ServiceA: è½¬å‘è¯·æ±‚
    ServiceA--xLoadBalancer: æœåŠ¡æ•…éšœ
    Note over LoadBalancer: æ£€æµ‹åˆ°ServiceAæ•…éšœ
    LoadBalancer->>ServiceB: æ•…éšœè½¬ç§»è¯·æ±‚
    ServiceB-->>LoadBalancer: å¤„ç†æˆåŠŸ
    LoadBalancer-->>Client: è¿”å›ç»“æœ
```

</details>

```java title="è‡ªåŠ¨æ•…éšœè½¬ç§»å®ç°"
@Component
public class AutoFailover {
    
    @Autowired
    private List<DataSource> dataSources;
    
    private AtomicInteger currentIndex = new AtomicInteger(0);
    private AtomicBoolean[] healthStatus;
    
    @PostConstruct
    public void init() {
        healthStatus = new AtomicBoolean[dataSources.size()];
        for (int i = 0; i < healthStatus.length; i++) {
            healthStatus[i] = new AtomicBoolean(true);
        }
        
        // å¯åŠ¨å¥åº·æ£€æŸ¥
        startHealthCheck();
    }
    
    public DataSource getHealthyDataSource() {
        for (int i = 0; i < dataSources.size(); i++) {
            int index = (currentIndex.get() + i) % dataSources.size();
            if (healthStatus[index].get()) {
                return dataSources.get(index);
            }
        }
        throw new ServiceUnavailableException("æ²¡æœ‰å¯ç”¨çš„æ•°æ®æº");
    }
    
    @Scheduled(fixedRate = 5000)
    public void healthCheck() {
        for (int i = 0; i < dataSources.size(); i++) {
            boolean healthy = checkDataSourceHealth(dataSources.get(i));
            healthStatus[i].set(healthy);
            
            if (!healthy) {
                log.warn("æ•°æ®æº {} ä¸å¥åº·", i);
            }
        }
    }
}
```

### 3.2 è´Ÿè½½å‡è¡¡æ•…éšœè½¬ç§»

:::tip
è´Ÿè½½å‡è¡¡ä¸ä»…èƒ½å¤Ÿåˆ†æ•£ç³»ç»Ÿè´Ÿè½½ï¼Œè¿˜èƒ½å®ç°æ•…éšœè½¬ç§»ï¼Œæ˜¯é«˜å¯ç”¨ç³»ç»Ÿçš„é‡è¦ç»„ä»¶ã€‚
:::

<Tabs>
  <TabItem value="loadbalancer" label="è´Ÿè½½å‡è¡¡å™¨" default>
  ```java
  @Component
  public class LoadBalancerFailover {
      
      private List<Server> servers = new ArrayList<>();
      private AtomicInteger currentIndex = new AtomicInteger(0);
      
      public LoadBalancerFailover() {
          // åˆå§‹åŒ–æœåŠ¡å™¨åˆ—è¡¨
          servers.add(new Server("server1:8080", true));
          servers.add(new Server("server2:8080", true));
          servers.add(new Server("server3:8080", true));
      }
      
      public String getNextHealthyServer() {
          for (int i = 0; i < servers.size(); i++) {
              int index = (currentIndex.get() + i) % servers.size();
              Server server = servers.get(index);
              
              if (server.isHealthy()) {
                  currentIndex.set(index);
                  return server.getAddress();
              }
          }
          
          throw new ServiceUnavailableException("æ²¡æœ‰å¯ç”¨çš„æœåŠ¡å™¨");
      }
  }
  ```
  </TabItem>
  <TabItem value="health" label="å¥åº·æ£€æŸ¥">
  ```java
  @Scheduled(fixedRate = 10000)
  public void healthCheck() {
      for (Server server : servers) {
          boolean healthy = checkServerHealth(server.getAddress());
          server.setHealthy(healthy);
      }
  }
  
  private boolean checkServerHealth(String address) {
      try {
          RestTemplate restTemplate = new RestTemplate();
          restTemplate.getForObject("http://" + address + "/health", String.class);
          return true;
      } catch (Exception e) {
          return false;
      }
  }
  ```
  </TabItem>
  <TabItem value="mark" label="æœåŠ¡å™¨çŠ¶æ€æ ‡è®°">
  ```java
  public void markServerUnhealthy(String address) {
      for (Server server : servers) {
          if (server.getAddress().equals(address)) {
              server.setHealthy(false);
              log.warn("æ ‡è®°æœåŠ¡å™¨ {} ä¸ºä¸å¥åº·çŠ¶æ€", address);
              break;
          }
      }
  }
  
  public void markServerHealthy(String address) {
      for (Server server : servers) {
          if (server.getAddress().equals(address)) {
              server.setHealthy(true);
              log.info("æ ‡è®°æœåŠ¡å™¨ {} ä¸ºå¥åº·çŠ¶æ€", address);
              break;
          }
      }
  }
  ```
  </TabItem>
</Tabs>

```mermaid
flowchart LR
    Client([å®¢æˆ·ç«¯]) --> LB[è´Ÿè½½å‡è¡¡å™¨]
    LB -- å¥åº· --> S1[æœåŠ¡å™¨1]
    LB -- å¥åº· --> S2[æœåŠ¡å™¨2]
    LB -- æ•…éšœ -.- S3[æœåŠ¡å™¨3]
    
    subgraph å¥åº·æ£€æŸ¥
    HC[å¥åº·æ£€æŸ¥å™¨] -.-> S1
    HC -.-> S2
    HC -.-> S3
    end
    
    HC -- "æŠ¥å‘ŠçŠ¶æ€" --> LB
```

## 4. å®¹é”™æœºåˆ¶

å®¹é”™æœºåˆ¶æ˜¯é«˜å¯ç”¨ç³»ç»Ÿçš„å…³é”®éƒ¨åˆ†ï¼Œèƒ½å¤Ÿéš”ç¦»æ•…éšœï¼Œé˜²æ­¢æ•…éšœæ‰©æ•£ï¼Œæé«˜ç³»ç»Ÿçš„ç¨³å®šæ€§ã€‚

### 4.1 ç†”æ–­å™¨æ¨¡å¼

ç†”æ–­å™¨æ¨¡å¼å¯ä»¥é˜²æ­¢ç³»ç»Ÿå› è°ƒç”¨å¤±è´¥çš„æœåŠ¡è€Œå‡ºç°çº§è”æ•…éšœã€‚

```mermaid
stateDiagram-v2
    [*] --> å…³é—­
    å…³é—­ --> å¼€å¯: å¤±è´¥æ¬¡æ•°è¶…è¿‡é˜ˆå€¼
    å¼€å¯ --> åŠå¼€: è¶…è¿‡è¶…æ—¶æ—¶é—´
    åŠå¼€ --> å…³é—­: æˆåŠŸè°ƒç”¨æ¢å¤
    åŠå¼€ --> å¼€å¯: æŒç»­å¤±è´¥
```

<Tabs>
  <TabItem value="pattern" label="ç†”æ–­å™¨æ¨¡å¼" default>
  ```java
  @Component
  public class CircuitBreakerPattern {
      
      private Map<String, CircuitBreaker> circuitBreakers = new ConcurrentHashMap<>();
      
      public <T> T execute(String serviceName, Supplier<T> supplier) {
          CircuitBreaker circuitBreaker = getOrCreateCircuitBreaker(serviceName);
          
          if (circuitBreaker.isOpen()) {
              throw new CircuitBreakerOpenException("ç†”æ–­å™¨å·²æ‰“å¼€: " + serviceName);
          }
          
          try {
              T result = supplier.get();
              circuitBreaker.recordSuccess();
              return result;
          } catch (Exception e) {
              circuitBreaker.recordFailure();
              throw e;
          }
      }
      
      private CircuitBreaker getOrCreateCircuitBreaker(String serviceName) {
          return circuitBreakers.computeIfAbsent(serviceName, k -> new CircuitBreaker());
      }
  }
  ```
  </TabItem>
  <TabItem value="breaker" label="ç†”æ–­å™¨å®ç°">
  ```java
  class CircuitBreaker {
      private AtomicInteger failureCount = new AtomicInteger(0);
      private AtomicLong lastFailureTime = new AtomicLong(0);
      private AtomicBoolean isOpen = new AtomicBoolean(false);
      
      private static final int FAILURE_THRESHOLD = 5;
      private static final long TIMEOUT = 60000; // 60ç§’
      
      public boolean isOpen() {
          if (isOpen.get()) {
              long now = System.currentTimeMillis();
              if (now - lastFailureTime.get() > TIMEOUT) {
                  // å°è¯•åŠå¼€çŠ¶æ€
                  isOpen.set(false);
                  failureCount.set(0);
                  return false;
              }
              return true;
          }
          return false;
      }
      
      public void recordSuccess() {
          failureCount.set(0);
          isOpen.set(false);
      }
      
      public void recordFailure() {
          failureCount.incrementAndGet();
          lastFailureTime.set(System.currentTimeMillis());
          
          if (failureCount.get() >= FAILURE_THRESHOLD) {
              isOpen.set(true);
          }
      }
  }
  ```
  </TabItem>
</Tabs>

:::caution
ç†”æ–­å™¨å‚æ•°é…ç½®è‡³å…³é‡è¦ï¼šæ•…éšœé˜ˆå€¼å¤ªä½å¯èƒ½å¯¼è‡´é¢‘ç¹ç†”æ–­ï¼Œé˜ˆå€¼å¤ªé«˜åˆ™æ— æ³•åŠæ—¶ç†”æ–­æ•…éšœæœåŠ¡ã€‚
:::

### 4.2 é™çº§ç­–ç•¥

æœåŠ¡é™çº§æ˜¯åœ¨ç³»ç»Ÿå‹åŠ›è¿‡å¤§æˆ–éƒ¨åˆ†æœåŠ¡ä¸å¯ç”¨æ—¶ï¼Œä¸»åŠ¨é™ä½æœåŠ¡è´¨é‡ä»¥ä¿è¯æ ¸å¿ƒåŠŸèƒ½å¯ç”¨çš„ç­–ç•¥ã€‚

<div className="card">
<div className="card__body">

é™çº§ç­–ç•¥åŒ…æ‹¬ï¼š

1. **åŠŸèƒ½é™çº§**ï¼šå…³é—­éæ ¸å¿ƒåŠŸèƒ½
2. **æœåŠ¡é™çº§**ï¼šè¿”å›ç¼“å­˜æ•°æ®æˆ–é»˜è®¤å€¼
3. **é™æµé™çº§**ï¼šé™åˆ¶è®¿é—®é¢‘ç‡
4. **å¼‚æ­¥åŒ–é™çº§**ï¼šå°†åŒæ­¥æ“ä½œè½¬ä¸ºå¼‚æ­¥
5. **ç®€åŒ–é™çº§**ï¼šä½¿ç”¨æ›´ç®€å•çš„ç®—æ³•

</div>
</div>

```java title="æœåŠ¡é™çº§å®ç°"
@Service
public class ServiceDegradation {
    
    @Autowired
    private CircuitBreakerPattern circuitBreaker;
    
    public UserInfo getUserInfo(Long userId) {
        try {
            return circuitBreaker.execute("user-service", () -> {
                // è°ƒç”¨ç”¨æˆ·æœåŠ¡
                return callUserService(userId);
            });
        } catch (Exception e) {
            log.warn("ç”¨æˆ·æœåŠ¡è°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨é™çº§ç­–ç•¥", e);
            return getFallbackUserInfo(userId);
        }
    }
    
    private UserInfo getFallbackUserInfo(Long userId) {
        // é™çº§ç­–ç•¥ï¼šè¿”å›ç¼“å­˜æ•°æ®æˆ–é»˜è®¤æ•°æ®
        UserInfo fallback = new UserInfo();
        fallback.setId(userId);
        fallback.setName("ç”¨æˆ·" + userId);
        fallback.setEmail("user" + userId + "@example.com");
        return fallback;
    }
}
```

## 5. ç›‘æ§å‘Šè­¦

æœ‰æ•ˆçš„ç›‘æ§å‘Šè­¦ç³»ç»Ÿèƒ½å¤ŸåŠæ—¶å‘ç°å¹¶å¤„ç†é—®é¢˜ï¼Œæ˜¯é«˜å¯ç”¨ç³»ç»Ÿçš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚

### 5.1 å¥åº·æ£€æŸ¥

```mermaid
graph TD
    A[å¥åº·æ£€æŸ¥] --> B[æ•°æ®åº“æ£€æŸ¥]
    A --> C[Redisæ£€æŸ¥]
    A --> D[å¤–éƒ¨æœåŠ¡æ£€æŸ¥]
    A --> E[ç³»ç»Ÿèµ„æºæ£€æŸ¥]
    A --> F[æ—¥å¿—æ£€æŸ¥]
    
    B --> B1[è¿æ¥æµ‹è¯•]
    B --> B2[æŸ¥è¯¢æµ‹è¯•]
    
    C --> C1[è¿æ¥æµ‹è¯•]
    C --> C2[æ“ä½œæµ‹è¯•]
    
    D --> D1[APIå¯ç”¨æ€§]
    D --> D2[å“åº”æ—¶é—´]
    
    E --> E1[CPUä½¿ç”¨ç‡]
    E --> E2[å†…å­˜ä½¿ç”¨ç‡]
    E --> E3[ç£ç›˜ç©ºé—´]
    
    F --> F1[é”™è¯¯æ—¥å¿—æ•°é‡]
    F --> F2[è­¦å‘Šæ—¥å¿—è¶‹åŠ¿]
```

<Tabs>
  <TabItem value="health" label="å¥åº·æ£€æŸ¥æœåŠ¡" default>
  ```java
  @Component
  public class HealthCheckService {
      
      @Autowired
      private DataSource dataSource;
      
      @Autowired
      private RedisTemplate<String, Object> redisTemplate;
      
      @Autowired
      private RestTemplate restTemplate;
      
      public HealthStatus checkSystemHealth() {
          HealthStatus status = new HealthStatus();
          
          // æ£€æŸ¥æ•°æ®åº“
          status.setDatabase(checkDatabaseHealth());
          
          // æ£€æŸ¥Redis
          status.setRedis(checkRedisHealth());
          
          // æ£€æŸ¥å¤–éƒ¨æœåŠ¡
          status.setExternalService(checkExternalServiceHealth());
          
          // æ£€æŸ¥ç£ç›˜ç©ºé—´
          status.setDiskSpace(checkDiskSpace());
          
          // æ£€æŸ¥å†…å­˜ä½¿ç”¨
          status.setMemoryUsage(checkMemoryUsage());
          
          return status;
      }
  }
  ```
  </TabItem>
  <TabItem value="checks" label="å…·ä½“æ£€æŸ¥å®ç°">
  ```java
  private boolean checkDatabaseHealth() {
      try (Connection conn = dataSource.getConnection()) {
          conn.createStatement().execute("SELECT 1");
          return true;
      } catch (Exception e) {
          log.error("æ•°æ®åº“å¥åº·æ£€æŸ¥å¤±è´¥", e);
          return false;
      }
  }
  
  private boolean checkRedisHealth() {
      try {
          redisTemplate.opsForValue().get("health_check");
          return true;
      } catch (Exception e) {
          log.error("Rediså¥åº·æ£€æŸ¥å¤±è´¥", e);
          return false;
      }
  }
  
  private boolean checkDiskSpace() {
      File root = new File("/");
      long freeSpace = root.getFreeSpace();
      long totalSpace = root.getTotalSpace();
      double usagePercent = (double) (totalSpace - freeSpace) / totalSpace * 100;
      
      return usagePercent < 90; // ç£ç›˜ä½¿ç”¨ç‡å°äº90%
  }
  ```
  </TabItem>
</Tabs>

### 5.2 å‘Šè­¦æœºåˆ¶

:::warning
å‘Šè­¦æœºåˆ¶åº”å½“é¿å…å‘Šè­¦é£æš´ï¼Œå®æ–½åˆ†çº§å‘Šè­¦ï¼Œç¡®ä¿çœŸæ­£éœ€è¦äººå·¥å¹²é¢„çš„é—®é¢˜èƒ½å¤ŸåŠæ—¶å¾—åˆ°å¤„ç†ã€‚
:::

```java title="å‘Šè­¦ç³»ç»Ÿå®ç°"
@Component
public class AlertSystem {
    
    @Autowired
    private HealthCheckService healthCheckService;
    
    @Autowired
    private EmailService emailService;
    
    @Autowired
    private SmsService smsService;
    
    @Scheduled(fixedRate = 30000) // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
    public void checkAndAlert() {
        HealthStatus status = healthCheckService.checkSystemHealth();
        
        if (!status.isDatabase()) {
            sendAlert("æ•°æ®åº“æœåŠ¡å¼‚å¸¸", "æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œè¯·ç«‹å³æ£€æŸ¥", AlertLevel.HIGH);
        }
        
        if (!status.isRedis()) {
            sendAlert("RedisæœåŠ¡å¼‚å¸¸", "Redisè¿æ¥å¤±è´¥ï¼Œè¯·ç«‹å³æ£€æŸ¥", AlertLevel.MEDIUM);
        }
        
        if (!status.isDiskSpace()) {
            sendAlert("ç£ç›˜ç©ºé—´ä¸è¶³", "ç£ç›˜ä½¿ç”¨ç‡è¶…è¿‡90%ï¼Œè¯·ç«‹å³æ¸…ç†", AlertLevel.HIGH);
        }
    }
    
    private void sendAlert(String title, String message, AlertLevel level) {
        log.error("å‘Šè­¦: {} - {} (çº§åˆ«: {})", title, message, level);
        
        // æ ¹æ®å‘Šè­¦çº§åˆ«é€‰æ‹©é€šçŸ¥æ–¹å¼
        switch (level) {
            case HIGH:
                // é«˜çº§åˆ«å‘Šè­¦ï¼šé‚®ä»¶+çŸ­ä¿¡
                emailService.sendAlertEmail(title, message);
                smsService.sendAlertSms(title, message);
                break;
            case MEDIUM:
                // ä¸­çº§åˆ«å‘Šè­¦ï¼šä»…é‚®ä»¶
                emailService.sendAlertEmail(title, message);
                break;
            case LOW:
                // ä½çº§åˆ«å‘Šè­¦ï¼šä»…æ—¥å¿—è®°å½•
                break;
        }
    }
    
    public enum AlertLevel {
        LOW, MEDIUM, HIGH
    }
}
```

## 6. é¢è¯•é¢˜ç²¾é€‰

### 6.1 åŸºç¡€æ¦‚å¿µé¢˜

<details>
<summary>**Q: ä»€ä¹ˆæ˜¯é«˜å¯ç”¨æ€§ï¼Ÿå¦‚ä½•è¡¡é‡ç³»ç»Ÿå¯ç”¨æ€§ï¼Ÿ**</summary>

**A:** é«˜å¯ç”¨æ€§æ˜¯æŒ‡ç³»ç»Ÿèƒ½å¤ŸæŒç»­æä¾›æœåŠ¡çš„èƒ½åŠ›ã€‚è¡¡é‡æŒ‡æ ‡åŒ…æ‹¬ï¼š
- **å¯ç”¨æ€§**ï¼šç³»ç»Ÿæ­£å¸¸è¿è¡Œæ—¶é—´æ¯”ä¾‹ï¼Œé€šå¸¸ä»¥ç™¾åˆ†æ¯”è¡¨ç¤º
- **MTBF**ï¼šå¹³å‡æ•…éšœé—´éš”æ—¶é—´ï¼Œè¶Šé•¿è¶Šå¥½
- **MTTR**ï¼šå¹³å‡æ•…éšœä¿®å¤æ—¶é—´ï¼Œè¶ŠçŸ­è¶Šå¥½
- **RTO**ï¼šæ¢å¤æ—¶é—´ç›®æ ‡ï¼Œç³»ç»Ÿæ¢å¤çš„æ—¶é—´è¦æ±‚
- **RPO**ï¼šæ¢å¤ç‚¹ç›®æ ‡ï¼Œæ•°æ®ä¸¢å¤±çš„æ—¶é—´çª—å£
</details>

<details>
<summary>**Q: å¦‚ä½•è®¾è®¡ä¸€ä¸ªé«˜å¯ç”¨ç³»ç»Ÿï¼Ÿ**</summary>

**A:** è®¾è®¡é«˜å¯ç”¨ç³»ç»Ÿçš„æ–¹æ³•ï¼š
- **å†—ä½™è®¾è®¡**ï¼šç¡¬ä»¶å†—ä½™ã€è½¯ä»¶å†—ä½™ã€åœ°ç†å†—ä½™
- **æ•…éšœè½¬ç§»**ï¼šè‡ªåŠ¨æ•…éšœæ£€æµ‹å’Œåˆ‡æ¢æœºåˆ¶
- **è´Ÿè½½å‡è¡¡**ï¼šåˆ†æ•£è¯·æ±‚å‹åŠ›ï¼Œæé«˜ç³»ç»Ÿå®¹é‡
- **å®¹é”™æœºåˆ¶**ï¼šç†”æ–­å™¨ã€é™çº§ç­–ç•¥ã€é‡è¯•æœºåˆ¶
- **ç›‘æ§å‘Šè­¦**ï¼šå®æ—¶ç›‘æ§ç³»ç»ŸçŠ¶æ€ï¼ŒåŠæ—¶å‘ç°é—®é¢˜
</details>

### 6.2 æ¶æ„è®¾è®¡é¢˜

<details>
<summary>**Q: å¦‚ä½•å®ç°æ•°æ®åº“çš„é«˜å¯ç”¨ï¼Ÿ**</summary>

**A:** æ•°æ®åº“é«˜å¯ç”¨å®ç°æ–¹æ³•ï¼š
- **ä¸»ä»å¤åˆ¶**ï¼šè¯»å†™åˆ†ç¦»ã€æ•…éšœè½¬ç§»
- **é›†ç¾¤éƒ¨ç½²**ï¼šå¤šèŠ‚ç‚¹éƒ¨ç½²ã€æ•°æ®åŒæ­¥
- **åˆ†åº“åˆ†è¡¨**ï¼šæ°´å¹³åˆ†ç‰‡ã€å‚ç›´åˆ†ç‰‡
- **å¤‡ä»½æ¢å¤**ï¼šå®šæœŸå¤‡ä»½ã€å¿«é€Ÿæ¢å¤
- **ç›‘æ§å‘Šè­¦**ï¼šæ€§èƒ½ç›‘æ§ã€æ•…éšœå‘Šè­¦
</details>

<details>
<summary>**Q: å¦‚ä½•è®¾è®¡å¾®æœåŠ¡çš„é«˜å¯ç”¨æ¶æ„ï¼Ÿ**</summary>

**A:** å¾®æœåŠ¡é«˜å¯ç”¨æ¶æ„è®¾è®¡ï¼š
- **æœåŠ¡æ³¨å†Œå‘ç°**ï¼šEurekaã€Consulã€Zookeeper
- **è´Ÿè½½å‡è¡¡**ï¼šRibbonã€LoadBalancer
- **ç†”æ–­é™çº§**ï¼šHystrixã€Resilience4j
- **é…ç½®ä¸­å¿ƒ**ï¼šSpring Cloud Configã€Apollo
- **é“¾è·¯è¿½è¸ª**ï¼šSleuthã€Zipkin
</details>

### 6.3 æ•…éšœå¤„ç†é¢˜

<details>
<summary>**Q: å¦‚ä½•å¤„ç†ç³»ç»Ÿæ•…éšœï¼Ÿ**</summary>

**A:** ç³»ç»Ÿæ•…éšœå¤„ç†æ–¹æ³•ï¼š
- **æ•…éšœæ£€æµ‹**ï¼šå¥åº·æ£€æŸ¥ã€ç›‘æ§å‘Šè­¦
- **æ•…éšœéš”ç¦»**ï¼šå¿«é€Ÿéš”ç¦»æ•…éšœèŠ‚ç‚¹
- **æ•…éšœè½¬ç§»**ï¼šè‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨èŠ‚ç‚¹
- **æ•…éšœæ¢å¤**ï¼šä¿®å¤æ•…éšœã€æ¢å¤æœåŠ¡
- **æ•…éšœåˆ†æ**ï¼šæ ¹å› åˆ†æã€é¢„é˜²æªæ–½
</details>

<details>
<summary>**Q: å¦‚ä½•è®¾è®¡å®¹é”™æœºåˆ¶ï¼Ÿ**</summary>

**A:** å®¹é”™æœºåˆ¶è®¾è®¡æ–¹æ³•ï¼š
- **ç†”æ–­å™¨æ¨¡å¼**ï¼šé˜²æ­¢æ•…éšœæ‰©æ•£
- **é™çº§ç­–ç•¥**ï¼šæä¾›åŸºæœ¬æœåŠ¡
- **é‡è¯•æœºåˆ¶**ï¼šå¤„ç†ä¸´æ—¶æ•…éšœ
- **è¶…æ—¶æ§åˆ¶**ï¼šé¿å…é•¿æ—¶é—´ç­‰å¾…
- **é™æµä¿æŠ¤**ï¼šé˜²æ­¢ç³»ç»Ÿè¿‡è½½
</details>

:::tip é«˜å¯ç”¨æ€§å­¦ä¹ è¦ç‚¹
1. **ç†è§£å¯ç”¨æ€§æŒ‡æ ‡**ï¼šæŒæ¡MTBFã€MTTRã€RTOã€RPOç­‰æ¦‚å¿µ
2. **æŒæ¡å†—ä½™è®¾è®¡**ï¼šå­¦ä¼šç¡¬ä»¶å†—ä½™ã€è½¯ä»¶å†—ä½™ã€åœ°ç†å†—ä½™
3. **ç†Ÿæ‚‰æ•…éšœå¤„ç†**ï¼šäº†è§£æ•…éšœæ£€æµ‹ã€éš”ç¦»ã€è½¬ç§»ã€æ¢å¤
4. **å­¦ä¼šå®¹é”™æœºåˆ¶**ï¼šæŒæ¡ç†”æ–­å™¨ã€é™çº§ã€é‡è¯•ç­‰æ¨¡å¼
5. **äº†è§£ç›‘æ§å‘Šè­¦**ï¼šå­¦ä¼šå¥åº·æ£€æŸ¥ã€æ€§èƒ½ç›‘æ§ã€æ•…éšœå‘Šè­¦
:::

---

é€šè¿‡æœ¬ç« çš„å­¦ä¹ ï¼Œä½ åº”è¯¥å·²ç»æŒæ¡äº†é«˜å¯ç”¨æ€§ç³»ç»Ÿè®¾è®¡çš„æ ¸å¿ƒæ¦‚å¿µã€æ¶æ„æ¨¡å¼å’Œæœ€ä½³å®è·µã€‚é«˜å¯ç”¨æ€§ç³»ç»Ÿè®¾è®¡æ˜¯æ„å»ºç¨³å®šå¯é ç³»ç»Ÿçš„é‡è¦æŠ€èƒ½ï¼ŒæŒæ¡è¿™äº›æŠ€æœ¯å¯ä»¥å¸®åŠ©ä½ è®¾è®¡å‡ºé«˜å¯ç”¨çš„ç³»ç»Ÿã€‚åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œåˆç†è¿ç”¨è¿™äº›æŠ€æœ¯å¯ä»¥å¤§å¤§æé«˜ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œå¯é æ€§ã€‚ 