---
sidebar_position: 5
title: "ç†”æ–­å™¨æ¨¡å¼è®¾è®¡"
description: "æ·±å…¥ç†è§£ç†”æ–­å™¨æ¨¡å¼åŸç†ã€å®ç°ç­–ç•¥ä¸æœ€ä½³å®è·µ"
authors: [Laby]
last_update:
  date: 2025-08-07
  author: Laby
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import TOCInline from '@theme/TOCInline';

# ç†”æ–­å™¨æ¨¡å¼è®¾è®¡

ç†”æ–­å™¨æ¨¡å¼æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿä¸­é‡è¦çš„å®¹é”™æœºåˆ¶ï¼Œé€šè¿‡ç›‘æ§æœåŠ¡è°ƒç”¨çŠ¶æ€ï¼Œåœ¨æœåŠ¡å‡ºç°æ•…éšœæ—¶å¿«é€Ÿå¤±è´¥ï¼Œé˜²æ­¢æ•…éšœæ‰©æ•£ï¼Œæé«˜ç³»ç»Ÿç¨³å®šæ€§ã€‚

:::info æœ¬æ–‡å†…å®¹æ¦‚è§ˆ
<TOCInline toc={toc} />
:::

:::tip æ ¸å¿ƒä»·å€¼
**ç†”æ–­å™¨ = æ•…éšœéš”ç¦» + å¿«é€Ÿå¤±è´¥ + è‡ªåŠ¨æ¢å¤ + é™çº§ç­–ç•¥ + ç³»ç»Ÿä¿æŠ¤**
- ğŸ›¡ï¸ **æ•…éšœéš”ç¦»**ï¼šé˜»æ­¢æ•…éšœæ‰©æ•£åˆ°å…¶ä»–æœåŠ¡
- âš¡ **å¿«é€Ÿå¤±è´¥**ï¼šè¿…é€Ÿè¿”å›é”™è¯¯ï¼Œé¿å…èµ„æºè€—å°½
- ğŸ”„ **è‡ªåŠ¨æ¢å¤**ï¼šå®šæœŸå°è¯•æ¢å¤ï¼Œæ— éœ€äººå·¥å¹²é¢„
- â¬‡ï¸ **é™çº§ç­–ç•¥**ï¼šæä¾›å¤‡é€‰æ–¹æ¡ˆï¼Œä¿è¯åŸºæœ¬åŠŸèƒ½å¯ç”¨
- ğŸ”’ **ç³»ç»Ÿä¿æŠ¤**ï¼šé˜²æ­¢è¿‡è½½ï¼Œç»´æŠ¤ç³»ç»Ÿæ•´ä½“ç¨³å®š
:::

## 1. ç†”æ–­å™¨åŸºç¡€æ¦‚å¿µ

### 1.1 ç†”æ–­å™¨çŠ¶æ€

ç†”æ–­å™¨æœ‰ä¸‰ç§çŠ¶æ€ï¼š

```mermaid
stateDiagram-v2
    [*] --> å…³é—­
    å…³é—­ --> å¼€å¯: å¤±è´¥æ¬¡æ•°è¶…è¿‡é˜ˆå€¼
    å¼€å¯ --> åŠå¼€: è¶…è¿‡è¶…æ—¶æ—¶é—´
    åŠå¼€ --> å…³é—­: æˆåŠŸè°ƒç”¨æ¢å¤
    åŠå¼€ --> å¼€å¯: æŒç»­å¤±è´¥
```

| çŠ¶æ€ | è¯´æ˜ | è¡Œä¸º |
|------|------|------|
| **å…³é—­ (Closed)** | æ­£å¸¸çŠ¶æ€ | å…è®¸è¯·æ±‚é€šè¿‡ï¼Œç»Ÿè®¡å¤±è´¥æ¬¡æ•° |
| **å¼€å¯ (Open)** | ç†”æ–­çŠ¶æ€ | å¿«é€Ÿå¤±è´¥ï¼Œä¸è°ƒç”¨ç›®æ ‡æœåŠ¡ |
| **åŠå¼€ (Half-Open)** | æ¢å¤çŠ¶æ€ | å…è®¸å°‘é‡è¯·æ±‚æµ‹è¯•æœåŠ¡æ¢å¤æƒ…å†µ |

<Tabs>
  <TabItem value="state" label="ç†”æ–­å™¨çŠ¶æ€å®šä¹‰" default>
  ```java
public enum CircuitBreakerState {
    CLOSED("å…³é—­", "æ­£å¸¸çŠ¶æ€ï¼Œå…è®¸è¯·æ±‚é€šè¿‡"),
    OPEN("å¼€å¯", "ç†”æ–­çŠ¶æ€ï¼Œå¿«é€Ÿå¤±è´¥"),
    HALF_OPEN("åŠå¼€", "æ¢å¤çŠ¶æ€ï¼Œå…è®¸å°‘é‡è¯·æ±‚æµ‹è¯•");
    
    private final String name;
    private final String description;
    
    CircuitBreakerState(String name, String description) {
        this.name = name;
        this.description = description;
    }
}
  ```
  </TabItem>
  <TabItem value="component" label="ç†”æ–­å™¨ç»„ä»¶">
  ```java
@Component
public class CircuitBreaker {
    
    private final String name;
    private final AtomicReference<CircuitBreakerState> state = new AtomicReference<>(CircuitBreakerState.CLOSED);
    private final AtomicInteger failureCount = new AtomicInteger(0);
    private final AtomicLong lastFailureTime = new AtomicLong(0);
    private final AtomicInteger successCount = new AtomicInteger(0);
    
    private final int failureThreshold;
    private final long timeout;
    private final int successThreshold;
    
    public CircuitBreaker(String name, int failureThreshold, long timeout, int successThreshold) {
        this.name = name;
        this.failureThreshold = failureThreshold;
        this.timeout = timeout;
        this.successThreshold = successThreshold;
    }
    
    public boolean isClosed() {
        return state.get() == CircuitBreakerState.CLOSED;
    }
    
    public boolean isOpen() {
        return state.get() == CircuitBreakerState.OPEN;
    }
    
    public boolean isHalfOpen() {
        return state.get() == CircuitBreakerState.HALF_OPEN;
    }
}
```
  </TabItem>
</Tabs>

### 1.2 ç†”æ–­å™¨é…ç½®

ç†”æ–­å™¨çš„å…³é”®é…ç½®å‚æ•°ï¼š

<div className="card">
<div className="card__body">

- **å¤±è´¥é˜ˆå€¼ï¼ˆFailure Thresholdï¼‰**ï¼šè§¦å‘ç†”æ–­çš„è¿ç»­å¤±è´¥æ¬¡æ•°
- **è¶…æ—¶æ—¶é—´ï¼ˆTimeoutï¼‰**ï¼šç†”æ–­å™¨ä¿æŒæ‰“å¼€çŠ¶æ€çš„æ—¶é—´çª—å£
- **æˆåŠŸé˜ˆå€¼ï¼ˆSuccess Thresholdï¼‰**ï¼šåŠå¼€çŠ¶æ€è½¬ä¸ºå…³é—­çŠ¶æ€çš„æˆåŠŸæ¬¡æ•°è¦æ±‚
- **çª—å£å¤§å°ï¼ˆWindow Sizeï¼‰**ï¼šç»Ÿè®¡å¤±è´¥ç‡çš„è¯·æ±‚æ•°é‡æ ·æœ¬
- **å¤±è´¥ç‡é˜ˆå€¼ï¼ˆFailure Rate Thresholdï¼‰**ï¼šè§¦å‘ç†”æ–­çš„å¤±è´¥ç‡ç™¾åˆ†æ¯”

</div>
</div>

```java title="ç†”æ–­å™¨é…ç½®"
@Configuration
public class CircuitBreakerConfig {
    
    @Value("${circuit.breaker.failure.threshold:5}")
    private int failureThreshold;
    
    @Value("${circuit.breaker.timeout:60000}")
    private long timeout;
    
    @Value("${circuit.breaker.success.threshold:3}")
    private int successThreshold;
    
    @Bean
    public CircuitBreakerProperties circuitBreakerProperties() {
        CircuitBreakerProperties properties = new CircuitBreakerProperties();
        properties.setFailureThreshold(failureThreshold);
        properties.setTimeout(timeout);
        properties.setSuccessThreshold(successThreshold);
        return properties;
    }
}
```

## 2. ç†”æ–­å™¨å®ç°åŸç†

### 2.1 ç†”æ–­åˆ¤æ–­é€»è¾‘

```mermaid
flowchart TD
    A[æ¥æ”¶è¯·æ±‚] --> B{ç†”æ–­å™¨çŠ¶æ€?}
    B -- å…³é—­ --> C[æ‰§è¡Œè¯·æ±‚]
    B -- å¼€å¯ --> D[å¿«é€Ÿå¤±è´¥]
    B -- åŠå¼€ --> E{æ˜¯å¦å…è®¸æµ‹è¯•?}
    E -- æ˜¯ --> C
    E -- å¦ --> D
    C --> F{è¯·æ±‚æˆåŠŸ?}
    F -- æ˜¯ --> G[è®°å½•æˆåŠŸ]
    F -- å¦ --> H[è®°å½•å¤±è´¥]
    G --> I{åŠå¼€çŠ¶æ€ä¸”æˆåŠŸæ¬¡æ•°>=é˜ˆå€¼?}
    I -- æ˜¯ --> J[è½¬ä¸ºå…³é—­çŠ¶æ€]
    H --> K{å¤±è´¥æ¬¡æ•°>=é˜ˆå€¼?}
    K -- æ˜¯ --> L[è½¬ä¸ºå¼€å¯çŠ¶æ€]
```

<Tabs>
  <TabItem value="allow" label="è¯·æ±‚å…è®¸åˆ¤æ–­" default>
  ```java
  public boolean allowRequest() {
      CircuitBreakerState currentState = state.get();
      
      if (currentState == CircuitBreakerState.CLOSED) {
          return true;
      } else if (currentState == CircuitBreakerState.OPEN) {
          // æ£€æŸ¥æ˜¯å¦è¶…è¿‡è¶…æ—¶æ—¶é—´
          long now = System.currentTimeMillis();
          long lastFailure = lastFailureTime.get();
          
          if (now - lastFailure > timeout) {
              // è½¬ä¸ºåŠå¼€çŠ¶æ€
              if (state.compareAndSet(CircuitBreakerState.OPEN, CircuitBreakerState.HALF_OPEN)) {
                  successCount.set(0);
                  return true;
              }
          }
          return false;
      } else { // HALF_OPEN
          // åŠå¼€çŠ¶æ€ä¸‹é™åˆ¶è¯·æ±‚æ•°é‡
          long currentCount = successCount.get();
          return currentCount < successThreshold;
      }
  }
  ```
  </TabItem>
  <TabItem value="record" label="ç»“æœè®°å½•é€»è¾‘">
  ```java
  public void recordSuccess() {
      CircuitBreakerState currentState = state.get();
      
      if (currentState == CircuitBreakerState.CLOSED) {
          // å…³é—­çŠ¶æ€ä¸‹é‡ç½®å¤±è´¥è®¡æ•°
          failureCount.set(0);
      } else if (currentState == CircuitBreakerState.HALF_OPEN) {
          // åŠå¼€çŠ¶æ€ä¸‹è®¡æ•°æˆåŠŸæ¬¡æ•°
          int currentSuccesses = successCount.incrementAndGet();
          
          if (currentSuccesses >= successThreshold) {
              // è½¬ä¸ºå…³é—­çŠ¶æ€
              state.compareAndSet(CircuitBreakerState.HALF_OPEN, CircuitBreakerState.CLOSED);
              failureCount.set(0);
              successCount.set(0);
          }
      }
  }
  
  public void recordFailure() {
      CircuitBreakerState currentState = state.get();
      lastFailureTime.set(System.currentTimeMillis());
      
      if (currentState == CircuitBreakerState.CLOSED) {
          // å…³é—­çŠ¶æ€ä¸‹è®¡æ•°å¤±è´¥
          int failures = failureCount.incrementAndGet();
          
          if (failures >= failureThreshold) {
              // è½¬ä¸ºå¼€å¯çŠ¶æ€
              state.compareAndSet(CircuitBreakerState.CLOSED, CircuitBreakerState.OPEN);
          }
      } else if (currentState == CircuitBreakerState.HALF_OPEN) {
          // åŠå¼€çŠ¶æ€ä¸‹å¤±è´¥ç«‹å³è½¬ä¸ºå¼€å¯çŠ¶æ€
          state.compareAndSet(CircuitBreakerState.HALF_OPEN, CircuitBreakerState.OPEN);
          successCount.set(0);
    }
}
```
  </TabItem>
</Tabs>

:::caution æ³¨æ„äº‹é¡¹
åœ¨é«˜å¹¶å‘ç¯å¢ƒä¸‹ï¼Œç†”æ–­çŠ¶æ€çš„è½¬æ¢éœ€è¦è€ƒè™‘åŸå­æ€§ï¼Œé¿å…ç«æ€æ¡ä»¶å¯¼è‡´çš„çŠ¶æ€ä¸ä¸€è‡´ã€‚ä½¿ç”¨AtomicReferenceå’ŒcompareAndSetå¯ä»¥ä¿è¯çŠ¶æ€è½¬æ¢çš„çº¿ç¨‹å®‰å…¨ã€‚
:::

### 2.2 å¤±è´¥ç»Ÿè®¡ç­–ç•¥

ç†”æ–­å™¨å¯ä»¥é‡‡ç”¨ä¸åŒçš„å¤±è´¥ç»Ÿè®¡ç­–ç•¥ï¼š

<details>
<summary>ç»Ÿè®¡ç­–ç•¥è¯¦è§£</summary>

1. **è®¡æ•°çª—å£ï¼ˆCount-based Windowï¼‰**ï¼š
   - ç»Ÿè®¡æœ€è¿‘Næ¬¡è¯·æ±‚çš„å¤±è´¥æ•°
   - ä¼˜ç‚¹ï¼šå®ç°ç®€å•
   - ç¼ºç‚¹ï¼šä¸è€ƒè™‘æ—¶é—´å› ç´ 

2. **æ—¶é—´çª—å£ï¼ˆTime-based Windowï¼‰**ï¼š
   - ç»Ÿè®¡æœ€è¿‘Nç§’å†…çš„å¤±è´¥ç‡
   - ä¼˜ç‚¹ï¼šè€ƒè™‘æ—¶é—´å› ç´ 
   - ç¼ºç‚¹ï¼šå®ç°å¤æ‚ï¼Œéœ€è¦ç»´æŠ¤æ»‘åŠ¨çª—å£

3. **æ··åˆçª—å£ï¼ˆHybrid Windowï¼‰**ï¼š
   - ç»¼åˆè®¡æ•°å’Œæ—¶é—´å› ç´ 
   - ä¼˜ç‚¹ï¼šæ›´å‡†ç¡®çš„æ•…éšœæ£€æµ‹
   - ç¼ºç‚¹ï¼šå®ç°æœ€å¤æ‚

</details>

```java title="æ—¶é—´çª—å£å¤±è´¥ç»Ÿè®¡"
public class TimeWindowFailureCounter {
    
    private final int windowSize; // æ—¶é—´çª—å£å¤§å°ï¼ˆæ¯«ç§’ï¼‰
    private final double failureRateThreshold; // å¤±è´¥ç‡é˜ˆå€¼
    private final Queue<RequestRecord> requestRecords = new ConcurrentLinkedQueue<>();
    
    public TimeWindowFailureCounter(int windowSize, double failureRateThreshold) {
        this.windowSize = windowSize;
        this.failureRateThreshold = failureRateThreshold;
    }
    
    public synchronized void recordRequest(boolean successful) {
            long now = System.currentTimeMillis();
        removeExpiredRecords(now);
        requestRecords.add(new RequestRecord(successful, now));
    }
    
    public synchronized boolean isFailureThresholdExceeded() {
        long now = System.currentTimeMillis();
        removeExpiredRecords(now);
        
        if (requestRecords.isEmpty()) {
        return false;
    }
    
        int total = requestRecords.size();
        int failures = countFailures();
        
        return (double) failures / total >= failureRateThreshold;
    }
    
    private void removeExpiredRecords(long now) {
        while (!requestRecords.isEmpty() && now - requestRecords.peek().timestamp > windowSize) {
            requestRecords.poll();
        }
    }
    
    private int countFailures() {
        return (int) requestRecords.stream()
            .filter(record -> !record.successful)
            .count();
    }
    
    private static class RequestRecord {
        final boolean successful;
        final long timestamp;
        
        RequestRecord(boolean successful, long timestamp) {
            this.successful = successful;
            this.timestamp = timestamp;
        }
    }
}
```

## 3. ç†”æ–­å™¨å®ç°æ–¹æ¡ˆ

### 3.1 ç®€å•ç†”æ–­å™¨å®ç°

```java title="ç®€å•ç†”æ–­å™¨å®ç°"
@Component
public class SimpleCircuitBreaker {
    
    private final String name;
    private final AtomicReference<CircuitBreakerState> state = new AtomicReference<>(CircuitBreakerState.CLOSED);
    private final AtomicInteger failureCount = new AtomicInteger(0);
    private final AtomicLong lastFailureTime = new AtomicLong(0);
    private final int failureThreshold;
    private final long timeout;
    
    public SimpleCircuitBreaker(String name, int failureThreshold, long timeout) {
        this.name = name;
        this.failureThreshold = failureThreshold;
        this.timeout = timeout;
    }
    
    public <T> T execute(Supplier<T> supplier) throws CircuitBreakerOpenException {
        if (!allowRequest()) {
            throw new CircuitBreakerOpenException("Circuit breaker for [" + name + "] is open");
        }
        
        try {
            T result = supplier.get();
            recordSuccess();
            return result;
        } catch (Exception e) {
            recordFailure();
            throw e;
        }
    }
    
    public void executeRunnable(Runnable runnable) throws CircuitBreakerOpenException {
        if (!allowRequest()) {
            throw new CircuitBreakerOpenException("Circuit breaker for [" + name + "] is open");
        }
        
        try {
            runnable.run();
            recordSuccess();
        } catch (Exception e) {
            recordFailure();
            throw e;
        }
    }
    
    // allowRequest, recordSuccess, recordFailure æ–¹æ³•ä¸å‰é¢ç›¸åŒ
}
```

### 3.2 Resilience4j ç†”æ–­å™¨

[Resilience4j](https://github.com/resilience4j/resilience4j) æ˜¯ä¸€ä¸ªè½»é‡çº§çš„å®¹é”™åº“ï¼Œæä¾›äº†å¼ºå¤§çš„ç†”æ–­å™¨å®ç°ï¼š

```java title="Resilience4jç†”æ–­å™¨ç¤ºä¾‹"
@Configuration
public class Resilience4jConfig {
    
    @Bean
    public CircuitBreakerRegistry circuitBreakerRegistry() {
        CircuitBreakerConfig config = CircuitBreakerConfig.custom()
            .failureRateThreshold(50) // å¤±è´¥ç‡é˜ˆå€¼
            .waitDurationInOpenState(Duration.ofMillis(1000)) // å¼€å¯çŠ¶æ€ç­‰å¾…æ—¶é—´
            .slidingWindowType(SlidingWindowType.COUNT_BASED) // ç»Ÿè®¡çª—å£ç±»å‹
            .slidingWindowSize(10) // ç»Ÿè®¡çª—å£å¤§å°
            .minimumNumberOfCalls(5) // æœ€å°è°ƒç”¨æ¬¡æ•°
            .permittedNumberOfCallsInHalfOpenState(3) // åŠå¼€çŠ¶æ€å…è®¸çš„è°ƒç”¨æ¬¡æ•°
            .automaticTransitionFromOpenToHalfOpenEnabled(true) // è‡ªåŠ¨ä»å¼€å¯è½¬ä¸ºåŠå¼€
            .recordExceptions(IOException.class, TimeoutException.class) // è®°å½•çš„å¼‚å¸¸ç±»å‹
            .build();
            
        return CircuitBreakerRegistry.of(config);
    }
    
    @Bean
    public CircuitBreaker userServiceCircuitBreaker(CircuitBreakerRegistry registry) {
        return registry.circuitBreaker("userService");
    }
}
```

<Tabs>
  <TabItem value="usage" label="ä½¿ç”¨æ–¹å¼" default>
  ```java
  @Service
  public class UserService {
      
      private final RestTemplate restTemplate;
      private final CircuitBreaker circuitBreaker;
      private final Logger logger = LoggerFactory.getLogger(UserService.class);
      
      public UserService(RestTemplate restTemplate, CircuitBreaker circuitBreaker) {
          this.restTemplate = restTemplate;
          this.circuitBreaker = circuitBreaker;
      }
      
      public User getUserById(Long id) {
          return CircuitBreaker.decorateSupplier(circuitBreaker, 
              () -> restTemplate.getForObject("/users/" + id, User.class))
              .get();
      }
      
      // å¸¦å›é€€çš„ç†”æ–­
      public User getUserByIdWithFallback(Long id) {
          Supplier<User> supplier = CircuitBreaker.decorateSupplier(circuitBreaker,
              () -> restTemplate.getForObject("/users/" + id, User.class));
              
          return Try.ofSupplier(supplier)
              .recover(e -> {
                  logger.error("Circuit breaker open for user service", e);
                  return getFallbackUser(id);
              }).get();
      }
      
      private User getFallbackUser(Long id) {
          User fallback = new User();
          fallback.setId(id);
          fallback.setName("ç”¨æˆ·_" + id);
          fallback.setEmail("user" + id + "@example.com");
          return fallback;
      }
  }
  ```
  </TabItem>
  <TabItem value="monitoring" label="ç›‘æ§é›†æˆ">
  ```java
  @Configuration
  public class CircuitBreakerMonitoring {
      
      @Bean
      public CircuitBreakerEventConsumer circuitBreakerEventConsumer() {
          return new CircuitBreakerEventConsumer();
      }
      
      static class CircuitBreakerEventConsumer implements EventConsumer<CircuitBreakerEvent> {
          
          private final Logger logger = LoggerFactory.getLogger(CircuitBreakerEventConsumer.class);
          
          @Override
          public void consumeEvent(CircuitBreakerEvent event) {
              if (event.getEventType() == CircuitBreakerEvent.Type.STATE_TRANSITION) {
                  CircuitBreakerOnStateTransitionEvent transitionEvent = 
                      (CircuitBreakerOnStateTransitionEvent) event;
                  
                  logger.info("Circuit breaker '{}' changed state from {} to {}",
                      event.getCircuitBreakerName(),
                      transitionEvent.getStateTransition().getFromState(),
                      transitionEvent.getStateTransition().getToState());
              } else if (event.getEventType() == CircuitBreakerEvent.Type.FAILURE_RATE_EXCEEDED) {
                  logger.warn("Circuit breaker '{}' failure rate exceeded: {}",
                      event.getCircuitBreakerName(), event);
              }
          }
      }
      
      @PostConstruct
      public void registerEventConsumer(CircuitBreakerRegistry registry, 
                                        CircuitBreakerEventConsumer consumer) {
          registry.getAllCircuitBreakers().forEach(cb -> 
              cb.getEventPublisher().onEvent(consumer));
      }
  }
  ```
  </TabItem>
</Tabs>

## 4. Spring Cloud ä¸­çš„ç†”æ–­å®ç°

### 4.1 Hystrix

:::info
Hystrix å·²è¿›å…¥ç»´æŠ¤æ¨¡å¼ï¼ŒSpring Cloud æ¨èä½¿ç”¨ Resilience4j æ›¿ä»£ã€‚è¿™é‡Œä»‹ç» Hystrix ä¸»è¦æ˜¯ä¸ºäº†ç†è§£æ¦‚å¿µã€‚
:::

```java title="Hystrixç†”æ–­å™¨ç¤ºä¾‹"
@HystrixCommand(fallbackMethod = "getDefaultUser",
    commandProperties = {
        @HystrixProperty(name = "circuitBreaker.requestVolumeThreshold", value = "4"),
        @HystrixProperty(name = "circuitBreaker.sleepWindowInMilliseconds", value = "10000"),
        @HystrixProperty(name = "circuitBreaker.errorThresholdPercentage", value = "50"),
        @HystrixProperty(name = "execution.isolation.thread.timeoutInMilliseconds", value = "1000")
    })
    public User getUserById(Long id) {
    return restTemplate.getForObject("/users/" + id, User.class);
}

public User getDefaultUser(Long id) {
        User fallback = new User();
        fallback.setId(id);
    fallback.setName("é»˜è®¤ç”¨æˆ·");
    fallback.setEmail("default@example.com");
        return fallback;
}
```

### 4.2 Spring Cloud Circuit Breaker

Spring Cloud Circuit Breaker æ˜¯ Spring Cloud æä¾›çš„ç†”æ–­å™¨æŠ½è±¡ï¼Œå¯ä»¥é›†æˆä¸åŒçš„ç†”æ–­å™¨å®ç°ï¼š

```java title="Spring Cloud Circuit Breakerç¤ºä¾‹"
@Service
public class UserService {
    
    private final ReactiveCircuitBreakerFactory circuitBreakerFactory;
    private final WebClient webClient;
    
    public UserService(ReactiveCircuitBreakerFactory circuitBreakerFactory, WebClient webClient) {
        this.circuitBreakerFactory = circuitBreakerFactory;
        this.webClient = webClient;
    }
    
    public Mono<User> getUserById(Long id) {
        return webClient.get()
            .uri("/users/{id}", id)
            .retrieve()
            .bodyToMono(User.class)
            .transform(it -> {
                ReactiveCircuitBreaker rcb = circuitBreakerFactory.create("userService");
                return rcb.run(it, throwable -> getDefaultUser(id));
            });
    }
    
    private Mono<User> getDefaultUser(Long id) {
        User fallback = new User();
        fallback.setId(id);
        fallback.setName("é»˜è®¤ç”¨æˆ·");
        fallback.setEmail("default@example.com");
        return Mono.just(fallback);
    }
}
```

## 5. ç†”æ–­å™¨æœ€ä½³å®è·µ

### 5.1 ç†”æ–­å™¨é…ç½®è°ƒä¼˜

<div className="card">
<div className="card__header">
<h4>ç†”æ–­å™¨é…ç½®å‚æ•°è°ƒä¼˜å»ºè®®</h4>
</div>
<div className="card__body">

| å‚æ•° | å»ºè®®å€¼ | è¯´æ˜ |
|-----|-------|------|
| å¤±è´¥é˜ˆå€¼ | 5-10 | è¿ç»­å¤±è´¥æ¬¡æ•°æˆ–å¤±è´¥ç‡ï¼Œå–å†³äºæœåŠ¡ç‰¹æ€§ |
| æ—¶é—´çª—å£å¤§å° | 10-20 | ç»Ÿè®¡è¯·æ±‚çš„æ ·æœ¬å¤§å° |
| åŠå¼€æ¢å¤æ—¶é—´ | 30s-5min | ç†”æ–­å™¨ä»å¼€å¯åˆ°åŠå¼€çš„æ—¶é—´ï¼Œæ ¹æ®æ•…éšœæ¢å¤æ—¶é—´ä¼°è®¡ |
| åŠå¼€è¯·æ±‚æ•° | 3-5 | åŠå¼€çŠ¶æ€å…è®¸çš„è¯·æ±‚æ•°é‡ |
| æˆåŠŸé˜ˆå€¼ | 2-5 | ä»åŠå¼€è½¬ä¸ºå…³é—­çš„æˆåŠŸè¯·æ±‚æ•° |

</div>
</div>

:::tip è°ƒä¼˜å»ºè®®
1. **å°æ‰¹é‡æµ‹è¯•**ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒä¸­å…ˆé€‰æ‹©å°‘é‡éå…³é”®æœåŠ¡è¿›è¡Œç†”æ–­å™¨é…ç½®æµ‹è¯•
2. **å·®å¼‚åŒ–é…ç½®**ï¼šä¸åŒæœåŠ¡å¯èƒ½éœ€è¦ä¸åŒçš„ç†”æ–­ç­–ç•¥ï¼Œé¿å…ä¸€åˆ€åˆ‡
3. **ç›‘æ§åé¦ˆ**ï¼šæ ¹æ®ç›‘æ§æ•°æ®æŒç»­è°ƒæ•´ç†”æ–­å‚æ•°
4. **åœºæ™¯åŒ¹é…**ï¼šæ ¹æ®æœåŠ¡ç‰¹æ€§é€‰æ‹©åˆé€‚çš„çª—å£ç±»å‹ï¼ˆè®¡æ•°/æ—¶é—´ï¼‰
:::

### 5.2 å¼‚å¸¸å¤„ç†ç­–ç•¥

<Tabs>
  <TabItem value="selective" label="é€‰æ‹©æ€§ç†”æ–­" default>
  ```java
  @Component
  public class SelectiveCircuitBreaker extends SimpleCircuitBreaker {
      
      private final Set<Class<? extends Throwable>> recordedExceptions;
      private final Set<Class<? extends Throwable>> ignoredExceptions;
      
      public SelectiveCircuitBreaker(String name, int failureThreshold, long timeout,
                                    Set<Class<? extends Throwable>> recordedExceptions,
                                    Set<Class<? extends Throwable>> ignoredExceptions) {
          super(name, failureThreshold, timeout);
          this.recordedExceptions = recordedExceptions;
          this.ignoredExceptions = ignoredExceptions;
      }
      
      @Override
      public <T> T execute(Supplier<T> supplier) throws CircuitBreakerOpenException {
          if (!allowRequest()) {
              throw new CircuitBreakerOpenException("Circuit breaker for [" + getName() + "] is open");
          }
          
          try {
              T result = supplier.get();
              recordSuccess();
              return result;
        } catch (Exception e) {
              if (shouldRecordFailure(e)) {
                  recordFailure();
              }
              throw e;
          }
      }
      
      private boolean shouldRecordFailure(Throwable throwable) {
          // æ£€æŸ¥æ˜¯å¦å±äºå¿½ç•¥çš„å¼‚å¸¸
          for (Class<? extends Throwable> ignored : ignoredExceptions) {
              if (ignored.isInstance(throwable)) {
                  return false;
              }
          }
          
          // æ£€æŸ¥æ˜¯å¦å±äºè®°å½•çš„å¼‚å¸¸
          if (recordedExceptions.isEmpty()) {
              return true; // å¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œè®°å½•æ‰€æœ‰å¼‚å¸¸
          }
          
          for (Class<? extends Throwable> recorded : recordedExceptions) {
              if (recorded.isInstance(throwable)) {
                  return true;
              }
          }
          
          return false;
    }
}
```
  </TabItem>
  <TabItem value="bulkhead" label="éš”æ¿æ¨¡å¼">
  ```java
@Component
  public class BulkheadCircuitBreaker extends SimpleCircuitBreaker {
      
      private final Semaphore semaphore;
      
      public BulkheadCircuitBreaker(String name, int failureThreshold, long timeout, int maxConcurrentCalls) {
          super(name, failureThreshold, timeout);
          this.semaphore = new Semaphore(maxConcurrentCalls, true);
      }
      
      @Override
      public <T> T execute(Supplier<T> supplier) throws CircuitBreakerOpenException, BulkheadFullException {
          if (!allowRequest()) {
              throw new CircuitBreakerOpenException("Circuit breaker for [" + getName() + "] is open");
          }
          
          boolean acquired = false;
          try {
              acquired = semaphore.tryAcquire(100, TimeUnit.MILLISECONDS);
              if (!acquired) {
                  throw new BulkheadFullException("Bulkhead for [" + getName() + "] is full");
              }
              
              T result = supplier.get();
              recordSuccess();
              return result;
          } catch (BulkheadFullException e) {
              throw e;
          } catch (InterruptedException e) {
              Thread.currentThread().interrupt();
              throw new RuntimeException("Interrupted while waiting for bulkhead", e);
          } catch (Exception e) {
              recordFailure();
              throw e;
          } finally {
              if (acquired) {
                  semaphore.release();
              }
          }
      }
  }
  
  class BulkheadFullException extends RuntimeException {
      public BulkheadFullException(String message) {
          super(message);
    }
}
```
  </TabItem>
</Tabs>

### 5.3 ç›‘æ§ä¸å‘Šè­¦

:::warning
ç†”æ–­å™¨çŠ¶æ€çš„å˜åŒ–éœ€è¦åŠæ—¶ç›‘æ§å’Œå‘Šè­¦ï¼Œä»¥ä¾¿è¿ç»´äººå‘˜äº†è§£ç³»ç»Ÿå¥åº·çŠ¶å†µå¹¶åŠæ—¶å¤„ç†é—®é¢˜ã€‚
:::

```java title="ç†”æ–­å™¨ç›‘æ§"
@Configuration
public class CircuitBreakerMonitoring {
    
    private final MeterRegistry meterRegistry;
    private final Map<String, CircuitBreaker> circuitBreakers;
    
    public CircuitBreakerMonitoring(MeterRegistry meterRegistry, 
                                    Map<String, CircuitBreaker> circuitBreakers) {
        this.meterRegistry = meterRegistry;
        this.circuitBreakers = circuitBreakers;
        
        registerMetrics();
    }
    
    private void registerMetrics() {
        circuitBreakers.forEach((name, circuitBreaker) -> {
            Gauge.builder("circuit.breaker.state", circuitBreaker, this::getStateValue)
                .tag("name", name)
                .description("Circuit breaker state (0:closed, 1:open, 2:half_open)")
                .register(meterRegistry);
            
            Counter.builder("circuit.breaker.calls")
                .tag("name", name)
                .tag("result", "success")
                .description("Circuit breaker successful calls")
                .register(meterRegistry);
            
            Counter.builder("circuit.breaker.calls")
                .tag("name", name)
                .tag("result", "failure")
                .description("Circuit breaker failed calls")
                .register(meterRegistry);
        });
    }
    
    private int getStateValue(CircuitBreaker circuitBreaker) {
        if (circuitBreaker.isClosed()) return 0;
        if (circuitBreaker.isOpen()) return 1;
        return 2; // Half-open
    }
}
```

## 6. é¢è¯•é¢˜ç²¾é€‰

<details>
<summary>**Q: ä»€ä¹ˆæ˜¯ç†”æ–­å™¨æ¨¡å¼ï¼Ÿç†”æ–­å™¨çš„ä¸‰ç§çŠ¶æ€æ˜¯ä»€ä¹ˆï¼Ÿ**</summary>

**A:** ç†”æ–­å™¨æ¨¡å¼æ˜¯ä¸€ç§ä¿æŠ¤åˆ†å¸ƒå¼ç³»ç»Ÿçš„å®¹é”™æœºåˆ¶ï¼Œå½“æ£€æµ‹åˆ°ç›®æ ‡æœåŠ¡å‡ºç°æ•…éšœæ—¶ï¼Œå¯ä»¥å¿«é€Ÿå¤±è´¥å¹¶é˜»æ–­è¯·æ±‚ï¼Œé˜²æ­¢æ•…éšœæ‰©æ•£ï¼Œå¹¶åœ¨é€‚å½“æ—¶æœºå°è¯•æ¢å¤ã€‚

ç†”æ–­å™¨çš„ä¸‰ç§çŠ¶æ€ï¼š
1. **å…³é—­çŠ¶æ€(Closed)**ï¼šæ­£å¸¸çŠ¶æ€ï¼Œå…è®¸è¯·æ±‚é€šè¿‡ï¼Œç»Ÿè®¡å¤±è´¥æ¬¡æ•°ã€‚
2. **å¼€å¯çŠ¶æ€(Open)**ï¼šç†”æ–­çŠ¶æ€ï¼Œå¿«é€Ÿå¤±è´¥æ‰€æœ‰è¯·æ±‚ï¼Œä¸è°ƒç”¨ç›®æ ‡æœåŠ¡ã€‚
3. **åŠå¼€çŠ¶æ€(Half-Open)**ï¼šæ¢å¤é˜¶æ®µï¼Œå…è®¸å°‘é‡è¯·æ±‚å°è¯•è°ƒç”¨ç›®æ ‡æœåŠ¡ï¼Œæµ‹è¯•æœåŠ¡æ˜¯å¦æ¢å¤ã€‚
</details>

<details>
<summary>**Q: ç†”æ–­å™¨ä¸é™çº§çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ**</summary>

**A:** 
- **ç†”æ–­å™¨**ï¼šä¾§é‡äºæ•…éšœæ£€æµ‹å’Œé˜»æ–­ï¼Œæ˜¯ä¸€ç§"å¼€/å…³"æœºåˆ¶ï¼Œå½“æœåŠ¡å‡ºç°é—®é¢˜æ—¶ä¼šä¸­æ–­æ‰€æœ‰è¯·æ±‚ï¼Œä»¥ä¿æŠ¤ç³»ç»Ÿå’Œä¾èµ–æ–¹ã€‚
- **é™çº§**ï¼šä¾§é‡äºæœåŠ¡åŠŸèƒ½çš„é€€åŒ–å¤„ç†ï¼Œæä¾›å¤‡é€‰æ–¹æ¡ˆï¼Œç¡®ä¿åœ¨ä¸ç†æƒ³æ¡ä»¶ä¸‹ä»èƒ½æä¾›åŸºæœ¬æœåŠ¡ã€‚

ç†”æ–­é€šå¸¸ä¼šè§¦å‘é™çº§ï¼Œä½†é™çº§ä¸ä¸€å®šç”±ç†”æ–­è§¦å‘ï¼ˆä¹Ÿå¯èƒ½ç”±è´Ÿè½½è¿‡é«˜ã€äººå·¥é…ç½®ç­‰è§¦å‘ï¼‰ã€‚
</details>

<details>
<summary>**Q: å¦‚ä½•è®¾è®¡ç†”æ–­å™¨çš„é˜ˆå€¼å‚æ•°ï¼Ÿ**</summary>

**A:** è®¾è®¡ç†”æ–­å™¨é˜ˆå€¼æ—¶éœ€è¦è€ƒè™‘ï¼š

1. **å¤±è´¥é˜ˆå€¼**ï¼š
   - å¯¹å…³é”®æœåŠ¡è®¾ç½®è¾ƒé«˜é˜ˆå€¼ï¼ˆå¦‚10æ¬¡ï¼‰
   - å¯¹éå…³é”®æœåŠ¡å¯è®¾ç½®è¾ƒä½é˜ˆå€¼ï¼ˆå¦‚5æ¬¡ï¼‰
   - è€ƒè™‘ä½¿ç”¨ç™¾åˆ†æ¯”å¤±è´¥ç‡è€Œéç»å¯¹æ¬¡æ•°ï¼ˆå¦‚50%å¤±è´¥ç‡ï¼‰

2. **æ—¶é—´çª—å£**ï¼š
   - æ ¹æ®æœåŠ¡å“åº”æ—¶é—´è®¾ç½®çª—å£å¤§å°
   - é«˜æµé‡æœåŠ¡ä½¿ç”¨è¾ƒå°çª—å£ï¼ˆå¦‚10ç§’ï¼‰
   - ä½æµé‡æœåŠ¡ä½¿ç”¨è¾ƒå¤§çª—å£ï¼ˆå¦‚60ç§’ï¼‰

3. **æ¢å¤ç­–ç•¥**ï¼š
   - åŠå¼€çŠ¶æ€æŒç»­æ—¶é—´åº”å¤§äºä¾èµ–æœåŠ¡çš„å…¸å‹æ¢å¤æ—¶é—´
   - åŠå¼€çŠ¶æ€å…è®¸çš„è¯·æ±‚æ•°ä¸å®œè¿‡å¤šï¼Œé€šå¸¸3-5ä¸ª
   - æµ‹è¯•è¯·æ±‚æˆåŠŸé˜ˆå€¼åº”è€ƒè™‘ä¸šåŠ¡ç¨³å®šæ€§éœ€æ±‚
</details>

<details>
<summary>**Q: Spring Cloudä¸­å¦‚ä½•å®ç°ç†”æ–­å™¨ï¼Ÿ**</summary>

**A:** Spring Cloudæä¾›å¤šç§ç†”æ–­å™¨å®ç°ï¼š

1. **Spring Cloud Circuit Breaker**ï¼š
   - æä¾›ç»Ÿä¸€çš„æŠ½è±¡API
   - æ”¯æŒå¤šç§åº•å±‚å®ç°ï¼ˆResilience4jã€Sentinelç­‰ï¼‰
   - å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶æˆ–ä»£ç é…ç½®ç†”æ–­è§„åˆ™

2. **Resilience4jï¼ˆæ¨èï¼‰**ï¼š
   - è½»é‡çº§å®¹é”™åº“ï¼ŒNetflix Hystrixçš„ç»§ä»»è€…
   - æä¾›ç†”æ–­å™¨ã€é™æµå™¨ã€é‡è¯•ã€éš”æ¿ç­‰åŠŸèƒ½
   - ä¸Spring Bootã€Spring Cloudè‰¯å¥½é›†æˆ
   - åŸºäºå‡½æ•°å¼ç¼–ç¨‹ï¼Œæ”¯æŒå“åº”å¼ç¼–ç¨‹

3. **Hystrixï¼ˆå·²è¿›å…¥ç»´æŠ¤æ¨¡å¼ï¼‰**ï¼š
   - é€šè¿‡@HystrixCommandæ³¨è§£å®ç°
   - æä¾›ç†”æ–­ã€é™çº§ã€ç¼“å­˜ã€ç›‘æ§ç­‰åŠŸèƒ½
   - æœ‰å®Œå–„çš„ä»ªè¡¨ç›˜ç›‘æ§å·¥å…·

4. **Sentinelï¼ˆå›½äº§æ›¿ä»£ï¼‰**ï¼š
   - é˜¿é‡Œå¼€æºçš„æµé‡æ§åˆ¶ç»„ä»¶
   - æä¾›ç†”æ–­ã€æµæ§ã€ç³»ç»Ÿè´Ÿè½½ä¿æŠ¤ç­‰åŠŸèƒ½
   - æœ‰å¼ºå¤§çš„æ§åˆ¶å°ï¼Œæ”¯æŒåŠ¨æ€è§„åˆ™è°ƒæ•´
</details>

<details>
<summary>**Q: ç†”æ–­å™¨å¦‚ä½•å¤„ç†ç¬æ—¶æ•…éšœå’Œæ…¢è¯·æ±‚ï¼Ÿ**</summary>

**A:** å¤„ç†ç¬æ—¶æ•…éšœå’Œæ…¢è¯·æ±‚çš„ç­–ç•¥ï¼š

1. **ç¬æ—¶æ•…éšœå¤„ç†**ï¼š
   - ä½¿ç”¨æ»‘åŠ¨çª—å£ç»Ÿè®¡æ•…éšœç‡ï¼Œé¿å…å•æ¬¡æ•…éšœè§¦å‘ç†”æ–­
   - å®ç°é‡è¯•æœºåˆ¶ï¼Œè‡ªåŠ¨é‡è¯•ä¸´æ—¶æ€§æ•…éšœ
   - åŒºåˆ†å¼‚å¸¸ç±»å‹ï¼Œå¯¹ç¬æ—¶æ•…éšœä½¿ç”¨ä¸åŒçš„ç†”æ–­ç­–ç•¥

2. **æ…¢è¯·æ±‚å¤„ç†**ï¼š
   - è®¾ç½®è¯·æ±‚è¶…æ—¶ï¼Œè¶…å‡ºæ—¶é—´è§†ä¸ºå¤±è´¥
   - å®ç°è¯·æ±‚ç¼“å­˜ï¼Œå‡å°‘é‡å¤æ…¢è¯·æ±‚
   - ä½¿ç”¨éš”æ¿æ¨¡å¼ï¼ˆBulkheadï¼‰é™åˆ¶å¹¶å‘è¯·æ±‚æ•°
   - å¯¹æ…¢é€Ÿç«¯ç‚¹å•ç‹¬è®¾ç½®ç†”æ–­å™¨ï¼Œé¿å…å½±å“å…¶ä»–è¯·æ±‚
</details>

:::tip ç†”æ–­å™¨å­¦ä¹ è¦ç‚¹
1. **æŒæ¡ä¸‰ç§çŠ¶æ€**ï¼šç†è§£å…³é—­ã€å¼€å¯ã€åŠå¼€ä¸‰ç§çŠ¶æ€çš„è½¬æ¢é€»è¾‘
2. **å‚æ•°è°ƒä¼˜**ï¼šå­¦ä¼šæ ¹æ®å®é™…åœºæ™¯è°ƒæ•´å¤±è´¥é˜ˆå€¼ã€çª—å£å¤§å°ç­‰å‚æ•°
3. **å¼‚å¸¸å¤„ç†**ï¼šåŒºåˆ†ä¸åŒç±»å‹çš„å¼‚å¸¸ï¼Œé€‰æ‹©æ€§è®°å½•æ•…éšœ
4. **é™çº§ç­–ç•¥**ï¼šè®¾è®¡åˆç†çš„é™çº§ç­–ç•¥ï¼Œä¿è¯åŸºæœ¬åŠŸèƒ½å¯ç”¨
5. **ç›‘æ§å‘Šè­¦**ï¼šå®æ–½æœ‰æ•ˆçš„ç›‘æ§ï¼ŒåŠæ—¶å‘ç°å¹¶å¤„ç†ç†”æ–­äº‹ä»¶
:::

---

é€šè¿‡æœ¬ç« çš„å­¦ä¹ ï¼Œä½ åº”è¯¥å·²ç»æŒæ¡äº†ç†”æ–­å™¨æ¨¡å¼çš„åŸç†ã€å®ç°æ–¹æ³•å’Œæœ€ä½³å®è·µã€‚ç†”æ–­å™¨æ˜¯æ„å»ºå¼¹æ€§åˆ†å¸ƒå¼ç³»ç»Ÿçš„å…³é”®ç»„ä»¶ï¼Œèƒ½å¤Ÿæœ‰æ•ˆé˜²æ­¢æ•…éšœæ‰©æ•£ï¼Œæé«˜ç³»ç»Ÿæ•´ä½“ç¨³å®šæ€§ã€‚åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œåˆç†åº”ç”¨ç†”æ–­å™¨æ¨¡å¼å¯ä»¥å¤§å¤§æå‡ç³»ç»Ÿçš„å¯ç”¨æ€§å’Œç”¨æˆ·ä½“éªŒã€‚ 