---
sidebar_position: 1
title: "é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡"
description: "æ·±å…¥ç†è§£é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡åŸç†ã€æ¶æ„æ¨¡å¼ä¸æ€§èƒ½ä¼˜åŒ–ç­–ç•¥"
authors: [Laby]
last_update:
  date: 2025-08-07
  author: Laby
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import TOCInline from '@theme/TOCInline';

# é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡

é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡æ˜¯æ„å»ºé«˜æ€§èƒ½ã€é«˜å¯ç”¨ç³»ç»Ÿçš„æ ¸å¿ƒæŠ€æœ¯ã€‚é€šè¿‡åˆç†çš„æ¶æ„è®¾è®¡ã€ç¼“å­˜ç­–ç•¥ã€å¼‚æ­¥å¤„ç†å’Œæ•°æ®åº“ä¼˜åŒ–ï¼Œå¯ä»¥æ„å»ºå‡ºèƒ½å¤Ÿå¤„ç†å¤§é‡å¹¶å‘è¯·æ±‚çš„ç³»ç»Ÿã€‚

:::info æœ¬æ–‡å†…å®¹æ¦‚è§ˆ
<TOCInline toc={toc} />
:::

:::tip æ ¸å¿ƒä»·å€¼
**é«˜å¹¶å‘ = å¹¶å‘æ¨¡å‹ + ç¼“å­˜ä¼˜åŒ– + å¼‚æ­¥å¤„ç† + æ•°æ®åº“ä¼˜åŒ– + è´Ÿè½½å‡è¡¡**
- ğŸ§µ **å¹¶å‘æ¨¡å‹**ï¼šé«˜æ•ˆå¤„ç†å¤šä»»åŠ¡çš„çº¿ç¨‹æ¨¡å‹è®¾è®¡
- ğŸš€ **ç¼“å­˜ä¼˜åŒ–**ï¼šå‡å°‘è®¿é—®å»¶è¿Ÿï¼Œæé«˜æ•°æ®è¯»å–é€Ÿåº¦
- âš¡ **å¼‚æ­¥å¤„ç†**ï¼šé¿å…é˜»å¡ï¼Œæé«˜ç³»ç»Ÿååé‡
- ğŸ“Š **æ•°æ®åº“ä¼˜åŒ–**ï¼šåˆ†ç‰‡ã€ç´¢å¼•ã€è¯»å†™åˆ†ç¦»ç­‰ç­–ç•¥
- âš–ï¸ **è´Ÿè½½å‡è¡¡**ï¼šåˆç†åˆ†é…è¯·æ±‚ï¼Œé¿å…å•ç‚¹è¿‡è½½
:::

## 1. å¹¶å‘æ¨¡å‹åŸºç¡€

### 1.1 å¹¶å‘ä¸å¹¶è¡Œ

```mermaid
graph TD
    A[å¤šä»»åŠ¡å¤„ç†] --> B[å¹¶å‘ Concurrency]
    A --> C[å¹¶è¡Œ Parallelism]
    
    B --> D[å•æ ¸CPU]
    B --> E[æ—¶é—´åˆ†ç‰‡]
    B --> F[äº¤æ›¿æ‰§è¡Œ]
    
    C --> G[å¤šæ ¸CPU]
    C --> H[åŒæ—¶æ‰§è¡Œ]
    C --> I[çœŸå®å¹¶è¡Œ]
    
    style B fill:#f9f,stroke:#333,stroke-width:2px
    style C fill:#bbf,stroke:#333,stroke-width:2px
```

å¹¶å‘å’Œå¹¶è¡Œæ˜¯å¤„ç†å¤šä»»åŠ¡çš„ä¸åŒæ–¹å¼ï¼š

| æ¦‚å¿µ | è¯´æ˜ | ç‰¹ç‚¹ |
|------|------|------|
| **å¹¶å‘ (Concurrency)** | å¤šä¸ªä»»åŠ¡äº¤æ›¿æ‰§è¡Œ | å•æ ¸CPUä¸Šçš„å¤šä»»åŠ¡å¤„ç† |
| **å¹¶è¡Œ (Parallelism)** | å¤šä¸ªä»»åŠ¡åŒæ—¶æ‰§è¡Œ | å¤šæ ¸CPUä¸Šçš„å¤šä»»åŠ¡å¤„ç† |

<details>
<summary>å¹¶å‘ä¸å¹¶è¡Œçš„è¯¦ç»†æ¯”è¾ƒ</summary>

**å¹¶å‘ (Concurrency)**:
- æ˜¯ä¸€ç§é€»è¾‘æ¦‚å¿µï¼ŒæŒ‡å¤šä¸ªä»»åŠ¡å¯ä»¥åœ¨é‡å çš„æ—¶é—´æ®µå†…å¯åŠ¨ã€è¿è¡Œå’Œå®Œæˆ
- ä¸€ä¸ªå¤„ç†å™¨é€šè¿‡æ—¶é—´ç‰‡åˆ‡æ¢æ¥å¤„ç†å¤šä¸ªä»»åŠ¡
- å¼ºè°ƒä»»åŠ¡çš„è°ƒåº¦ä¸åˆ‡æ¢
- é€‚ç”¨äºIOå¯†é›†å‹ä»»åŠ¡

**å¹¶è¡Œ (Parallelism)**:
- æ˜¯ä¸€ç§ç‰©ç†æ¦‚å¿µï¼ŒæŒ‡å¤šä¸ªä»»åŠ¡åœ¨åŒä¸€æ—¶åˆ»åŒæ—¶è¿è¡Œ
- éœ€è¦å¤šä¸ªå¤„ç†å™¨æˆ–å¤šæ ¸å¤„ç†å™¨
- å¼ºè°ƒåŒæ—¶æ‰§è¡Œå¤šä¸ªä»»åŠ¡
- é€‚ç”¨äºè®¡ç®—å¯†é›†å‹ä»»åŠ¡

</details>

<Tabs>
  <TabItem value="concurrent" label="å¹¶å‘ç¤ºä¾‹" default>
  ```java
@RestController
public class ConcurrentController {
    
    @Autowired
    private AsyncTaskExecutor taskExecutor;
    
    @GetMapping("/concurrent")
    public CompletableFuture<String> handleConcurrent() {
        return CompletableFuture.supplyAsync(() -> {
            // æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ
            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
            return "å¹¶å‘å¤„ç†å®Œæˆ";
        }, taskExecutor);
    }
}
  ```
  </TabItem>
  <TabItem value="parallel" label="å¹¶è¡Œç¤ºä¾‹">
  ```java
@Service
public class ParallelService {
    
    @Autowired
    private ThreadPoolTaskExecutor executor;
    
    public List<String> processParallel(List<String> items) {
        return items.parallelStream()
            .map(item -> {
                // å¹¶è¡Œå¤„ç†æ¯ä¸ªé¡¹ç›®
                return processItem(item);
            })
            .collect(Collectors.toList());
    }
    
    private String processItem(String item) {
        // å¤„ç†å•ä¸ªé¡¹ç›®çš„é€»è¾‘
        return "processed_" + item;
    }
}
```
  </TabItem>
</Tabs>

### 1.2 çº¿ç¨‹æ¨¡å‹

```mermaid
graph TD
    A[Javaçº¿ç¨‹æ¨¡å‹] --> B[çº¿ç¨‹æ± ]
    A --> C[å¼‚æ­¥ç¼–ç¨‹]
    A --> D[å“åº”å¼ç¼–ç¨‹]
    
    B --> B1[å›ºå®šçº¿ç¨‹æ± ]
    B --> B2[ç¼“å­˜çº¿ç¨‹æ± ]
    B --> B3[å®šæ—¶çº¿ç¨‹æ± ]
    B --> B4[å·¥ä½œçªƒå–çº¿ç¨‹æ± ]
    
    C --> C1[CompletableFuture]
    C --> C2[@Asyncæ³¨è§£]
    C --> C3[å›è°ƒå‡½æ•°]
    
    D --> D1[Reactor]
    D --> D2[RxJava]
    D --> D3[WebFlux]
```

#### çº¿ç¨‹æ± è®¾è®¡

çº¿ç¨‹æ± æ˜¯ç®¡ç†çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸã€æ§åˆ¶å¹¶å‘çš„é‡è¦å·¥å…·ã€‚åˆç†é…ç½®çº¿ç¨‹æ± å‚æ•°å¯¹ç³»ç»Ÿæ€§èƒ½è‡³å…³é‡è¦ã€‚

<div className="card">
<div className="card__header">
<h4>çº¿ç¨‹æ± å‚æ•°é…ç½®æŒ‡å—</h4>
</div>
<div className="card__body">

| å‚æ•° | è¯´æ˜ | é…ç½®å»ºè®® |
|------|------|----------|
| **æ ¸å¿ƒçº¿ç¨‹æ•°(corePoolSize)** | çº¿ç¨‹æ± ç»´æŠ¤çš„æœ€å°çº¿ç¨‹æ•° | IOå¯†é›†å‹ï¼šCPUæ ¸å¿ƒæ•° * 2<br/>CPUå¯†é›†å‹ï¼šCPUæ ¸å¿ƒæ•° |
| **æœ€å¤§çº¿ç¨‹æ•°(maxPoolSize)** | çº¿ç¨‹æ± å…è®¸çš„æœ€å¤§çº¿ç¨‹æ•° | IOå¯†é›†å‹ï¼šæ ¸å¿ƒçº¿ç¨‹æ•° * 3<br/>CPUå¯†é›†å‹ï¼šæ ¸å¿ƒçº¿ç¨‹æ•° + 1 |
| **é˜Ÿåˆ—å®¹é‡(queueCapacity)** | ä»»åŠ¡é˜Ÿåˆ—å¤§å° | æ ¹æ®å†…å­˜å’Œä»»åŠ¡ç‰¹æ€§è¯„ä¼°ï¼Œå¸¸è§100~1000 |
| **æ‹’ç»ç­–ç•¥(rejectedExecutionHandler)** | é˜Ÿåˆ—æ»¡æ—¶çš„å¤„ç†ç­–ç•¥ | AbortPolicyï¼šæŠ›å¼‚å¸¸<br/>CallerRunsPolicyï¼šç”±è°ƒç”¨è€…çº¿ç¨‹æ‰§è¡Œ<br/>DiscardPolicyï¼šä¸¢å¼ƒä»»åŠ¡<br/>DiscardOldestPolicyï¼šä¸¢å¼ƒæœ€æ—§ä»»åŠ¡ |

</div>
</div>

<Tabs>
  <TabItem value="config" label="çº¿ç¨‹æ± é…ç½®" default>
  ```java
@Configuration
public class ThreadPoolConfig {
    
    @Bean("ioThreadPool")
    public ThreadPoolTaskExecutor ioThreadPool() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(20);
        executor.setMaxPoolSize(100);
        executor.setQueueCapacity(500);
        executor.setThreadNamePrefix("IO-");
        executor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());
        executor.initialize();
        return executor;
    }
    
    @Bean("cpuThreadPool")
    public ThreadPoolTaskExecutor cpuThreadPool() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(Runtime.getRuntime().availableProcessors());
        executor.setMaxPoolSize(Runtime.getRuntime().availableProcessors() * 2);
        executor.setQueueCapacity(1000);
        executor.setThreadNamePrefix("CPU-");
        executor.setRejectedExecutionHandler(new ThreadPoolExecutor.AbortPolicy());
        executor.initialize();
        return executor;
    }
}
  ```
  </TabItem>
  <TabItem value="usage" label="çº¿ç¨‹æ± ä½¿ç”¨">
  ```java
@Service
public class ThreadPoolService {
    
    @Autowired
    @Qualifier("ioThreadPool")
    private ThreadPoolTaskExecutor ioExecutor;
    
    @Autowired
    @Qualifier("cpuThreadPool")
    private ThreadPoolTaskExecutor cpuExecutor;
    
    public CompletableFuture<String> handleIOBoundTask() {
        return CompletableFuture.supplyAsync(() -> {
            // IOå¯†é›†å‹ä»»åŠ¡
            return performIOOperation();
        }, ioExecutor);
    }
    
    public CompletableFuture<String> handleCPUBoundTask() {
        return CompletableFuture.supplyAsync(() -> {
            // CPUå¯†é›†å‹ä»»åŠ¡
            return performCPUOperation();
        }, cpuExecutor);
    }
}
```
  </TabItem>
  <TabItem value="monitor" label="çº¿ç¨‹æ± ç›‘æ§">
  ```java
  @Component
  public class ThreadPoolMonitor {
      
      @Autowired
      @Qualifier("ioThreadPool")
      private ThreadPoolTaskExecutor ioExecutor;
      
      @Autowired
      @Qualifier("cpuThreadPool")
      private ThreadPoolTaskExecutor cpuExecutor;
      
      @Scheduled(fixedRate = 30000) // æ¯30ç§’æ‰§è¡Œä¸€æ¬¡
      public void monitorThreadPools() {
          logThreadPoolStats("IOçº¿ç¨‹æ± ", ioExecutor);
          logThreadPoolStats("CPUçº¿ç¨‹æ± ", cpuExecutor);
      }
      
      private void logThreadPoolStats(String poolName, ThreadPoolTaskExecutor executor) {
          ThreadPoolExecutor threadPoolExecutor = executor.getThreadPoolExecutor();
          
          int corePoolSize = threadPoolExecutor.getCorePoolSize();
          int poolSize = threadPoolExecutor.getPoolSize();
          int activeCount = threadPoolExecutor.getActiveCount();
          long taskCount = threadPoolExecutor.getTaskCount();
          long completedTaskCount = threadPoolExecutor.getCompletedTaskCount();
          int queueSize = threadPoolExecutor.getQueue().size();
          
          log.info("{} çŠ¶æ€ - æ ¸å¿ƒçº¿ç¨‹æ•°: {}, å½“å‰çº¿ç¨‹æ•°: {}, æ´»è·ƒçº¿ç¨‹æ•°: {}, " +
                  "ä»»åŠ¡æ€»æ•°: {}, å·²å®Œæˆä»»åŠ¡: {}, é˜Ÿåˆ—å¤§å°: {}",
                  poolName, corePoolSize, poolSize, activeCount,
                  taskCount, completedTaskCount, queueSize);
      }
  }
  ```
  </TabItem>
</Tabs>

:::caution çº¿ç¨‹æ± é…ç½®æ³¨æ„äº‹é¡¹
1. **é¿å…æ— é™å¢é•¿**ï¼šè®¾ç½®åˆç†çš„æœ€å¤§çº¿ç¨‹æ•°ï¼Œé˜²æ­¢èµ„æºè€—å°½
2. **ä»»åŠ¡åˆ†ç±»**ï¼šæ ¹æ®ä»»åŠ¡ç±»å‹ï¼ˆIOå¯†é›†/CPUå¯†é›†ï¼‰ä½¿ç”¨ä¸åŒçº¿ç¨‹æ± 
3. **åŠ¨æ€è°ƒæ•´**ï¼šæ ¹æ®ç³»ç»Ÿè´Ÿè½½åŠ¨æ€è°ƒæ•´çº¿ç¨‹æ± å‚æ•°
4. **ç›‘æ§å‘Šè­¦**ï¼šç›‘æ§çº¿ç¨‹æ± çŠ¶æ€ï¼ŒåŠæ—¶å‘ç°é—®é¢˜
5. **ä¼˜é›…å…³é—­**ï¼šåº”ç”¨å…³é—­æ—¶ç­‰å¾…çº¿ç¨‹æ± ä»»åŠ¡å®Œæˆ
:::

#### å¼‚æ­¥ç¼–ç¨‹æ¨¡å‹

å¼‚æ­¥ç¼–ç¨‹æ˜¯é«˜å¹¶å‘ç³»ç»Ÿçš„é‡è¦æŠ€æœ¯ï¼Œå¯ä»¥æœ‰æ•ˆæé«˜ç³»ç»Ÿååé‡å’Œèµ„æºåˆ©ç”¨ç‡ã€‚

```mermaid
sequenceDiagram
    participant Client
    participant Controller
    participant AsyncService
    participant Thread1
    participant Thread2
    
    Client->>Controller: è¯·æ±‚
    Controller->>AsyncService: è°ƒç”¨å¼‚æ­¥æ–¹æ³•
    AsyncService->>Thread1: å¼‚æ­¥æ“ä½œ1
    AsyncService->>Thread2: å¼‚æ­¥æ“ä½œ2
    Controller-->>Client: ç«‹å³å“åº”
    
    Thread1-->>AsyncService: æ“ä½œ1å®Œæˆ
    Thread2-->>AsyncService: æ“ä½œ2å®Œæˆ
```

<Tabs>
  <TabItem value="async" label="@Asyncæ³¨è§£" default>
  ```java
@Service
public class AsyncService {
    
    @Async("ioThreadPool")
    public CompletableFuture<String> asyncOperation1() {
        // å¼‚æ­¥æ“ä½œ1
        return CompletableFuture.completedFuture("æ“ä½œ1å®Œæˆ");
    }
    
    @Async("ioThreadPool")
    public CompletableFuture<String> asyncOperation2() {
        // å¼‚æ­¥æ“ä½œ2
        return CompletableFuture.completedFuture("æ“ä½œ2å®Œæˆ");
    }
    
      public CompletableFuture<List<String>> performAsyncOperations() {
        CompletableFuture<String> future1 = asyncOperation1();
        CompletableFuture<String> future2 = asyncOperation2();
        
        return CompletableFuture.allOf(future1, future2)
            .thenApply(v -> {
                  List<String> results = new ArrayList<>();
                  results.add(future1.join());
                  results.add(future2.join());
                  return results;
            });
    }
}
```
  </TabItem>
  <TabItem value="completable" label="CompletableFuture">
  ```java
  @Service
  public class CompletableFutureService {
      
      @Autowired
      private ProductRepository productRepository;
      
      @Autowired
      private ReviewRepository reviewRepository;
      
      @Autowired
      private PriceRepository priceRepository;
      
      @Autowired
      private Executor executor;
      
      public CompletableFuture<ProductDetails> getProductDetails(Long productId) {
          CompletableFuture<Product> productFuture = CompletableFuture
              .supplyAsync(() -> productRepository.findById(productId)
                  .orElseThrow(() -> new ProductNotFoundException(productId)), executor);
              
          CompletableFuture<List<Review>> reviewsFuture = CompletableFuture
              .supplyAsync(() -> reviewRepository.findByProductId(productId), executor);
              
          CompletableFuture<Price> priceFuture = CompletableFuture
              .supplyAsync(() -> priceRepository.findByProductId(productId), executor);
              
          return CompletableFuture.allOf(productFuture, reviewsFuture, priceFuture)
              .thenApply(v -> {
                  Product product = productFuture.join();
                  List<Review> reviews = reviewsFuture.join();
                  Price price = priceFuture.join();
                  
                  return new ProductDetails(product, reviews, price);
              });
      }
  }
  ```
  </TabItem>
  <TabItem value="reactive" label="å“åº”å¼ç¼–ç¨‹">
  ```java
  @Service
  public class ReactiveService {
      
      @Autowired
      private ReactiveProductRepository productRepository;
      
      @Autowired
      private ReactiveReviewRepository reviewRepository;
      
      public Mono<ProductDetails> getProductDetails(Long productId) {
          Mono<Product> productMono = productRepository.findById(productId);
          Flux<Review> reviewsFlux = reviewRepository.findByProductId(productId);
          
          return productMono.zipWith(reviewsFlux.collectList())
              .map(tuple -> {
                  Product product = tuple.getT1();
                  List<Review> reviews = tuple.getT2();
                  return new ProductDetails(product, reviews);
              });
      }
  }
  ```
  </TabItem>
</Tabs>

## 2. é«˜å¹¶å‘æ¶æ„è®¾è®¡

### 2.1 åˆ†å±‚æ¶æ„

åˆ†å±‚æ¶æ„æ˜¯æ„å»ºé«˜å¹¶å‘ç³»ç»Ÿçš„åŸºç¡€ï¼Œé€šè¿‡å°†ç³»ç»Ÿåˆ†ä¸ºä¸åŒçš„å±‚æ¬¡ï¼Œå¯ä»¥å®ç°æ›´å¥½çš„æ‰©å±•æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

```mermaid
graph TD
    A[ç”¨æˆ·è¯·æ±‚] --> B[è´Ÿè½½å‡è¡¡å±‚]
    B --> C[åº”ç”¨æœåŠ¡å±‚]
    C --> D[ä¸šåŠ¡æœåŠ¡å±‚]
    D --> E[æ•°æ®è®¿é—®å±‚]
    E --> F[æ•°æ®å­˜å‚¨å±‚]
    
    B --> G[ç¼“å­˜å±‚]
    C --> G
    D --> G
    E --> G
```

<div className="card">
<div className="card__body">

é«˜å¹¶å‘ç³»ç»Ÿå¸¸è§çš„æ¶æ„å±‚æ¬¡ï¼š

1. **è´Ÿè½½å‡è¡¡å±‚**ï¼šåˆ†å‘è¯·æ±‚ï¼Œé˜²æ­¢å•ç‚¹è¿‡è½½
2. **åº”ç”¨æœåŠ¡å±‚**ï¼šå¤„ç†HTTPè¯·æ±‚ï¼Œæƒé™éªŒè¯ï¼Œå‚æ•°æ ¡éªŒ
3. **ä¸šåŠ¡æœåŠ¡å±‚**ï¼šå®ç°æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
4. **æ•°æ®è®¿é—®å±‚**ï¼šæä¾›ç»Ÿä¸€çš„æ•°æ®è®¿é—®æ¥å£
5. **æ•°æ®å­˜å‚¨å±‚**ï¼šå®é™…çš„æ•°æ®å­˜å‚¨ï¼Œå¦‚æ•°æ®åº“ã€ç¼“å­˜ç­‰
6. **ç¼“å­˜å±‚**ï¼šæ¨ªåˆ‡å„å±‚ï¼Œæä¾›æ•°æ®ç¼“å­˜

</div>
</div>

### 2.2 å¾®æœåŠ¡æ¶æ„

å¾®æœåŠ¡æ¶æ„å°†ç³»ç»Ÿæ‹†åˆ†ä¸ºå¤šä¸ªå°å‹æœåŠ¡ï¼Œæ¯ä¸ªæœåŠ¡è´Ÿè´£ç‰¹å®šä¸šåŠ¡åŠŸèƒ½ï¼ŒæœåŠ¡ä¹‹é—´é€šè¿‡APIé€šä¿¡ã€‚è¿™ç§æ¶æ„å¯ä»¥å®ç°æ›´å¥½çš„æ°´å¹³æ‰©å±•ï¼Œæé«˜ç³»ç»Ÿæ•´ä½“çš„å¹¶å‘å¤„ç†èƒ½åŠ›ã€‚

```mermaid
graph TD
    A[APIç½‘å…³] --> B[ç”¨æˆ·æœåŠ¡]
    A --> C[å•†å“æœåŠ¡]
    A --> D[è®¢å•æœåŠ¡]
    A --> E[æ”¯ä»˜æœåŠ¡]
    
    B --> F[ç”¨æˆ·æ•°æ®åº“]
    C --> G[å•†å“æ•°æ®åº“]
    D --> H[è®¢å•æ•°æ®åº“]
    E --> I[æ”¯ä»˜æ•°æ®åº“]
    
    B -.-> J[æœåŠ¡æ³¨å†Œä¸­å¿ƒ]
    C -.-> J
    D -.-> J
    E -.-> J
    
    K[è´Ÿè½½å‡è¡¡å™¨] --> A
```

<details>
<summary>å¾®æœåŠ¡æ¶æ„ä¼˜åŠ¿ä¸æŒ‘æˆ˜</summary>

**ä¼˜åŠ¿**ï¼š
- **ç‹¬ç«‹æ‰©å±•**ï¼šå¯ä»¥é’ˆå¯¹ä¸åŒæœåŠ¡è¿›è¡Œç‹¬ç«‹æ‰©å±•
- **æŠ€æœ¯å¤šæ ·æ€§**ï¼šä¸åŒæœåŠ¡å¯ä»¥ä½¿ç”¨ä¸åŒçš„æŠ€æœ¯æ ˆ
- **æ•…éšœéš”ç¦»**ï¼šå•ä¸ªæœåŠ¡æ•…éšœä¸ä¼šå½±å“æ•´ä¸ªç³»ç»Ÿ
- **å›¢é˜Ÿè‡ªæ²»**ï¼šå°å›¢é˜Ÿè´Ÿè´£ç‰¹å®šæœåŠ¡ï¼Œæé«˜å¼€å‘æ•ˆç‡
- **è¿­ä»£é€Ÿåº¦**ï¼šå°æœåŠ¡å¯ä»¥å¿«é€Ÿè¿­ä»£æ›´æ–°

**æŒ‘æˆ˜**ï¼š
- **åˆ†å¸ƒå¼å¤æ‚æ€§**ï¼šéœ€è¦å¤„ç†ç½‘ç»œå»¶è¿Ÿã€åˆ†å¸ƒå¼äº‹åŠ¡ç­‰
- **æœåŠ¡æ²»ç†**ï¼šéœ€è¦ç®¡ç†æœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡ç­‰
- **ä¸€è‡´æ€§ä¿è¯**ï¼šè·¨æœåŠ¡äº‹åŠ¡éš¾ä»¥ä¿è¯å¼ºä¸€è‡´æ€§
- **è¿ç»´å¤æ‚åº¦**ï¼šéœ€è¦ç®¡ç†å¤šä¸ªæœåŠ¡å®ä¾‹
- **ç›‘æ§éš¾åº¦**ï¼šéœ€è¦è·¨æœåŠ¡é“¾è·¯è¿½è¸ªå’Œç›‘æ§

</details>

## 3. ç¼“å­˜ä¼˜åŒ–ç­–ç•¥

ç¼“å­˜æ˜¯é«˜å¹¶å‘ç³»ç»Ÿä¸­æå‡æ€§èƒ½çš„å…³é”®æŠ€æœ¯ï¼Œåˆç†ä½¿ç”¨ç¼“å­˜å¯ä»¥å¤§å¹…å‡å°‘å¯¹åç«¯æœåŠ¡çš„è®¿é—®å‹åŠ›ã€‚

### 3.1 å¤šçº§ç¼“å­˜æ¶æ„

```mermaid
graph TD
    A[ç”¨æˆ·è¯·æ±‚] --> B[æœ¬åœ°ç¼“å­˜ L1]
    B -- å‘½ä¸­ --> C[è¿”å›æ•°æ®]
    B -- æœªå‘½ä¸­ --> D[åˆ†å¸ƒå¼ç¼“å­˜ L2]
    D -- å‘½ä¸­ --> E[è¿”å›æ•°æ®å¹¶æ›´æ–°L1]
    D -- æœªå‘½ä¸­ --> F[æ•°æ®åº“ L3]
    F --> G[è¿”å›æ•°æ®å¹¶æ›´æ–°L2ã€L1]
    
    style B fill:#f9f,stroke:#333,stroke-width:2px
    style D fill:#bbf,stroke:#333,stroke-width:2px
    style F fill:#fdd,stroke:#333,stroke-width:2px
```

<div className="card">
<div className="card__header">
<h4>å¤šçº§ç¼“å­˜ç‰¹ç‚¹</h4>
</div>
<div className="card__body">

| ç¼“å­˜çº§åˆ« | è¯´æ˜ | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ |
|----------|------|------|----------|
| **L1 æœ¬åœ°ç¼“å­˜** | åº”ç”¨å†…å­˜ä¸­çš„ç¼“å­˜ | è®¿é—®æœ€å¿«ã€å®¹é‡æœ‰é™ã€ä¸åº”ç”¨åŒç”Ÿå‘½å‘¨æœŸ | é«˜é¢‘è®¿é—®ã€å˜åŒ–å°‘çš„æ•°æ® |
| **L2 åˆ†å¸ƒå¼ç¼“å­˜** | Redisç­‰åˆ†å¸ƒå¼ç¼“å­˜ç³»ç»Ÿ | å®¹é‡å¤§ã€å¯é æ€§é«˜ã€è·¨åº”ç”¨å…±äº« | éœ€è¦è·¨å®ä¾‹å…±äº«çš„æ•°æ® |
| **L3 æ•°æ®åº“** | æŒä¹…åŒ–å­˜å‚¨ | å®¹é‡æœ€å¤§ã€è®¿é—®æœ€æ…¢ã€æœ€ç»ˆæ•°æ®æº | æ‰€æœ‰éœ€è¦æŒä¹…åŒ–çš„æ•°æ® |

</div>
</div>

<Tabs>
  <TabItem value="multi" label="å¤šçº§ç¼“å­˜å®ç°" default>
  ```java
@Service
public class MultiLevelCacheService {
    
    // L1ç¼“å­˜ï¼šæœ¬åœ°ç¼“å­˜
    private LoadingCache<String, Object> localCache = Caffeine.newBuilder()
        .maximumSize(1000)
        .expireAfterWrite(Duration.ofMinutes(5))
        .build(key -> getFromL2Cache(key));
    
    // L2ç¼“å­˜ï¼šRedisç¼“å­˜
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    // L3ç¼“å­˜ï¼šæ•°æ®åº“
    @Autowired
    private UserRepository userRepository;
    
    public Object getData(String key) {
        try {
            // ä»L1ç¼“å­˜è·å–
            return localCache.get(key);
        } catch (Exception e) {
            log.error("L1ç¼“å­˜è·å–å¤±è´¥", e);
            // é™çº§åˆ°L2ç¼“å­˜
            return getFromL2Cache(key);
        }
    }
    
    private Object getFromL2Cache(String key) {
        try {
            Object value = redisTemplate.opsForValue().get(key);
            if (value == null) {
                // L2ç¼“å­˜æœªå‘½ä¸­ï¼Œä»L3è·å–
                value = getFromL3Cache(key);
                if (value != null) {
                    // å†™å…¥L2ç¼“å­˜
                    redisTemplate.opsForValue().set(key, value, Duration.ofMinutes(30));
                }
            }
            return value;
        } catch (Exception e) {
            log.error("L2ç¼“å­˜è·å–å¤±è´¥", e);
            // é™çº§åˆ°L3ç¼“å­˜
            return getFromL3Cache(key);
        }
    }
    
    private Object getFromL3Cache(String key) {
        // ä»æ•°æ®åº“è·å–æ•°æ®
        if (key.startsWith("user:")) {
            Long userId = Long.parseLong(key.substring(5));
            return userRepository.findById(userId).orElse(null);
        }
        return null;
    }
}
```
  </TabItem>
  <TabItem value="metrics" label="ç¼“å­˜ç›‘æ§">
  ```java
  @Component
  public class CacheMetricsCollector {
      
      private final MeterRegistry registry;
      private final Map<String, Counter> hitCounters = new HashMap<>();
      private final Map<String, Counter> missCounters = new HashMap<>();
      private final Map<String, Timer> accessTimers = new HashMap<>();
      
      public CacheMetricsCollector(MeterRegistry registry) {
          this.registry = registry;
          
          // åˆå§‹åŒ–è®¡æ•°å™¨
          initializeCounters("l1");
          initializeCounters("l2");
          initializeCounters("l3");
      }
      
      private void initializeCounters(String level) {
          hitCounters.put(level, Counter.builder("cache." + level + ".hits")
              .description(level + " cache hit count")
              .register(registry));
              
          missCounters.put(level, Counter.builder("cache." + level + ".misses")
              .description(level + " cache miss count")
              .register(registry));
              
          accessTimers.put(level, Timer.builder("cache." + level + ".access.time")
              .description(level + " cache access time")
              .register(registry));
      }
      
      public void recordHit(String level) {
          hitCounters.get(level).increment();
      }
      
      public void recordMiss(String level) {
          missCounters.get(level).increment();
      }
      
      public <T> T recordAccessTime(String level, Supplier<T> operation) {
          return accessTimers.get(level).record(operation);
      }
      
      // è·å–å‘½ä¸­ç‡
      public double getHitRate(String level) {
          long hits = (long) hitCounters.get(level).count();
          long misses = (long) missCounters.get(level).count();
          long total = hits + misses;
          
          return total == 0 ? 0 : (double) hits / total;
      }
  }
  ```
  </TabItem>
</Tabs>

### 3.2 ç¼“å­˜æ›´æ–°ç­–ç•¥

ç¼“å­˜æ›´æ–°ç­–ç•¥å…³ç³»åˆ°ç³»ç»Ÿæ•°æ®ä¸€è‡´æ€§å’Œæ€§èƒ½ï¼Œä¸åŒçš„åœºæ™¯éœ€è¦é€‰æ‹©ä¸åŒçš„ç­–ç•¥ã€‚

```mermaid
graph TD
    A[ç¼“å­˜æ›´æ–°ç­–ç•¥] --> B[Cache-Aside]
    A --> C[Read-Through]
    A --> D[Write-Through]
    A --> E[Write-Behind]
    A --> F[Write-Invalidate]
    
    B --> B1[åº”ç”¨è´Ÿè´£åè°ƒç¼“å­˜å’Œæ•°æ®åº“]
    C --> C1[ç¼“å­˜è´Ÿè´£åŠ è½½æ•°æ®]
    D --> D1[å…ˆå†™æ•°æ®åº“å†å†™ç¼“å­˜]
    E --> E1[å…ˆå†™ç¼“å­˜å¼‚æ­¥å†™æ•°æ®åº“]
    F --> F1[å…ˆå†™æ•°æ®åº“å†åˆ é™¤ç¼“å­˜]
```

<Tabs>
  <TabItem value="through" label="å†™ç©¿ç­–ç•¥" default>
  ```java
    @Transactional
    public void writeThrough(String key, Object value) {
        // 1. æ›´æ–°æ•°æ®åº“
        updateDatabase(key, value);
        
        // 2. æ›´æ–°ç¼“å­˜
        redisTemplate.opsForValue().set(key, value, Duration.ofMinutes(30));
        localCache.invalidate(key);
    }
  ```
  </TabItem>
  <TabItem value="behind" label="å†™å›ç­–ç•¥">
  ```java
    public void writeBack(String key, Object value) {
        // 1. æ›´æ–°ç¼“å­˜
        redisTemplate.opsForValue().set(key, value, Duration.ofMinutes(30));
        localCache.invalidate(key);
        
        // 2. å¼‚æ­¥æ›´æ–°æ•°æ®åº“
        CompletableFuture.runAsync(() -> {
            updateDatabase(key, value);
        });
    }
  ```
  </TabItem>
  <TabItem value="invalidate" label="å¤±æ•ˆç­–ç•¥">
  ```java
    @Transactional
    public void writeInvalidate(String key, Object value) {
        // 1. æ›´æ–°æ•°æ®åº“
        updateDatabase(key, value);
        
        // 2. åˆ é™¤ç¼“å­˜
        redisTemplate.delete(key);
        localCache.invalidate(key);
    }
  ```
  </TabItem>
</Tabs>

:::caution ç¼“å­˜æ›´æ–°æ³¨æ„äº‹é¡¹
1. **ä¸€è‡´æ€§ä¸æ€§èƒ½å¹³è¡¡**ï¼šå¼ºä¸€è‡´æ€§ä¼šå½±å“æ€§èƒ½ï¼Œéœ€è¦åœ¨ä¸€è‡´æ€§å’Œæ€§èƒ½ä¹‹é—´æ‰¾å¹³è¡¡
2. **æ•°æ®ç‰¹æ€§è€ƒè™‘**ï¼šé«˜é¢‘è¯»å–çš„æ•°æ®é€‚åˆRead-Throughï¼Œé¢‘ç¹å†™å…¥çš„æ•°æ®å¯èƒ½é€‚åˆWrite-Invalidate
3. **å¤±æ•ˆé£é™©**ï¼šå…ˆåˆ é™¤ç¼“å­˜å†æ›´æ–°æ•°æ®åº“å¯èƒ½å¯¼è‡´è„è¯»
4. **åŒå†™é£é™©**ï¼šå…ˆæ›´æ–°æ•°æ®åº“å†æ›´æ–°ç¼“å­˜å¯èƒ½å› ä¸ºå¹¶å‘å¯¼è‡´ä¸ä¸€è‡´
5. **å»¶è¿ŸåŒåˆ **ï¼šæ›´æ–°æ•°æ®åº“ååˆ é™¤ç¼“å­˜ï¼Œå»¶è¿Ÿä¸€æ®µæ—¶é—´åå†æ¬¡åˆ é™¤ç¼“å­˜
:::

### 3.3 ç¼“å­˜ç©¿é€é˜²æŠ¤

ç¼“å­˜ç©¿é€æ˜¯æŒ‡æŸ¥è¯¢ä¸€ä¸ªä¸€å®šä¸å­˜åœ¨çš„æ•°æ®ï¼Œå¯¼è‡´æ¯æ¬¡è¯·æ±‚éƒ½ä¼šç©¿é€ç¼“å­˜åˆ°è¾¾æ•°æ®åº“ã€‚

<details>
<summary>ç¼“å­˜ç©¿é€ã€å‡»ç©¿ã€é›ªå´©çš„åŒºåˆ«</summary>

**ç¼“å­˜ç©¿é€(Cache Penetration)**ï¼š
- æŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®ï¼Œç¼“å­˜æœªå‘½ä¸­ç›´æ¥æŸ¥è¯¢æ•°æ®åº“
- å¯ä»¥é€šè¿‡ç©ºå€¼ç¼“å­˜ã€å¸ƒéš†è¿‡æ»¤å™¨ç­‰æ–¹æ¡ˆè§£å†³

**ç¼“å­˜å‡»ç©¿(Cache Breakdown)**ï¼š
- çƒ­ç‚¹æ•°æ®è¿‡æœŸç¬é—´ï¼Œå¤§é‡è¯·æ±‚ç›´æ¥æŸ¥è¯¢æ•°æ®åº“
- å¯ä»¥é€šè¿‡äº’æ–¥é”ã€çƒ­ç‚¹æ•°æ®æ°¸ä¸è¿‡æœŸç­‰æ–¹æ¡ˆè§£å†³

**ç¼“å­˜é›ªå´©(Cache Avalanche)**ï¼š
- å¤§é‡ç¼“å­˜åŒæ—¶è¿‡æœŸï¼Œå¯¼è‡´è¯·æ±‚å…¨éƒ¨è½¬å‘åˆ°æ•°æ®åº“
- å¯ä»¥é€šè¿‡éšæœºè¿‡æœŸæ—¶é—´ã€å¤šçº§ç¼“å­˜ç­‰æ–¹æ¡ˆè§£å†³

</details>

<Tabs>
  <TabItem value="bloom" label="å¸ƒéš†è¿‡æ»¤å™¨" default>
  ```java
  @Component
  public class BloomFilter {
      
      private BitSet bitSet;
      private int size;
      private int hashFunctions;
      
      public BloomFilter(int size, int hashFunctions) {
          this.bitSet = new BitSet(size);
          this.size = size;
          this.hashFunctions = hashFunctions;
      }
      
      public void add(String key) {
          for (int i = 0; i < hashFunctions; i++) {
              int hash = hash(key, i);
              bitSet.set(hash % size);
          }
      }
      
      public boolean mightContain(String key) {
          for (int i = 0; i < hashFunctions; i++) {
              int hash = hash(key, i);
              if (!bitSet.get(hash % size)) {
                  return false;
              }
          }
          return true;
      }
      
      private int hash(String key, int seed) {
          int result = 0;
          for (int i = 0; i < key.length(); i++) {
              result = 31 * result + key.charAt(i) + seed;
          }
          return Math.abs(result);
      }
  }
  
  // ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨é˜²æ­¢ç¼“å­˜ç©¿é€
@Service
public class CachePenetrationProtection {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Autowired
    private BloomFilter bloomFilter;
    
    public Object getDataWithProtection(String key) {
        // 1. å¸ƒéš†è¿‡æ»¤å™¨æ£€æŸ¥
        if (!bloomFilter.mightContain(key)) {
            return null;
        }
        
        // 2. ä»ç¼“å­˜è·å–
        Object value = redisTemplate.opsForValue().get(key);
        if (value != null) {
            return value;
        }
        
        // 3. ç¼“å­˜æœªå‘½ä¸­ï¼Œä»æ•°æ®åº“è·å–
        value = getFromDatabase(key);
        if (value != null) {
            // å†™å…¥ç¼“å­˜
            redisTemplate.opsForValue().set(key, value, Duration.ofMinutes(30));
        } else {
            // ç©ºå€¼ç¼“å­˜ï¼Œé˜²æ­¢ç¼“å­˜ç©¿é€
            redisTemplate.opsForValue().set(key, "NULL", Duration.ofMinutes(5));
        }
        
        return value;
    }
}
  ```
  </TabItem>
  <TabItem value="mutex" label="äº’æ–¥é”é˜²å‡»ç©¿">
  ```java
  @Service
  public class CacheBreakdownProtection {
      
      @Autowired
      private RedisTemplate<String, Object> redisTemplate;
      
      @Autowired
      private StringRedisTemplate stringRedisTemplate;
      
      public Object getDataWithLock(String key) {
          // 1. ä»ç¼“å­˜è·å–
          Object value = redisTemplate.opsForValue().get(key);
          if (value != null) {
              return value;
          }
          
          // 2. è·å–äº’æ–¥é”
          String lockKey = "lock:" + key;
          boolean locked = false;
          try {
              locked = stringRedisTemplate.opsForValue()
                  .setIfAbsent(lockKey, "1", Duration.ofSeconds(10));
              
              if (locked) {
                  // 3. åŒé‡æ£€æŸ¥
                  value = redisTemplate.opsForValue().get(key);
                  if (value != null) {
                      return value;
                  }
                  
                  // 4. ä»æ•°æ®åº“åŠ è½½
                  value = getFromDatabase(key);
                  
                  // 5. æ›´æ–°ç¼“å­˜
                  if (value != null) {
                      redisTemplate.opsForValue().set(key, value, Duration.ofMinutes(30));
                  } else {
                      redisTemplate.opsForValue().set(key, "NULL", Duration.ofMinutes(5));
                  }
              } else {
                  // 6. ç­‰å¾…ä¸€æ®µæ—¶é—´åé‡è¯•
                  Thread.sleep(50);
                  return getDataWithLock(key);
              }
              
              return value;
          } catch (Exception e) {
              log.error("è·å–æ•°æ®å¤±è´¥", e);
              return null;
          } finally {
              // 7. é‡Šæ”¾é”
              if (locked) {
                  stringRedisTemplate.delete(lockKey);
              }
          }
    }
}
```
  </TabItem>
</Tabs>

## 4. å¼‚æ­¥å¤„ç†æœºåˆ¶

å¼‚æ­¥å¤„ç†æ˜¯é«˜å¹¶å‘ç³»ç»Ÿæå‡ååé‡çš„é‡è¦æ‰‹æ®µï¼Œé€šè¿‡å°†è€—æ—¶æ“ä½œå¼‚æ­¥åŒ–ï¼Œå¯ä»¥å¿«é€Ÿå“åº”ç”¨æˆ·è¯·æ±‚ã€‚

### 4.1 æ¶ˆæ¯é˜Ÿåˆ—

æ¶ˆæ¯é˜Ÿåˆ—å¯ä»¥è§£è€¦ç³»ç»Ÿç»„ä»¶ï¼Œå¹³æ»‘æµé‡å³°å€¼ï¼Œæé«˜ç³»ç»Ÿå¯é æ€§ã€‚

```mermaid
graph LR
    A[ç”Ÿäº§è€…] --> B[æ¶ˆæ¯é˜Ÿåˆ—]
    B --> C[æ¶ˆè´¹è€…1]
    B --> D[æ¶ˆè´¹è€…2]
    B --> E[æ¶ˆè´¹è€…3]
    
    subgraph å¼‚æ­¥è§£è€¦
    A
    B
    end
    
    subgraph å¹¶è¡Œå¤„ç†
    C
    D
    E
    end
```

<Tabs>
  <TabItem value="producer" label="æ¶ˆæ¯ç”Ÿäº§è€…" default>
  ```java
@Service
public class MessageQueueService {
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    @Autowired
    private KafkaTemplate<String, String> kafkaTemplate;
    
    // å‘é€æ¶ˆæ¯åˆ°RabbitMQ
    public void sendToRabbitMQ(String message) {
        rabbitTemplate.convertAndSend("exchange", "routing.key", message);
    }
    
    // å‘é€æ¶ˆæ¯åˆ°Kafka
    public void sendToKafka(String topic, String message) {
        kafkaTemplate.send(topic, message);
    }
    
    // å¼‚æ­¥å¤„ç†è®¢å•
      public Long processOrderAsync(Order order) {
        // 1. åˆ›å»ºè®¢å•
        Order savedOrder = orderRepository.save(order);
        
        // 2. å‘é€å¼‚æ­¥æ¶ˆæ¯
        OrderEvent event = new OrderEvent(savedOrder.getId(), "CREATED");
        rabbitTemplate.convertAndSend("order.exchange", "order.created", event);
        
        // 3. ç«‹å³è¿”å›è®¢å•ID
        return savedOrder.getId();
    }
}
  ```
  </TabItem>
  <TabItem value="consumer" label="æ¶ˆæ¯æ¶ˆè´¹è€…">
  ```java
@Component
public class OrderMessageConsumer {
    
    @RabbitListener(queues = "order.queue")
    public void handleOrderCreated(OrderEvent event) {
        // å¼‚æ­¥å¤„ç†è®¢å•åˆ›å»ºåçš„ä¸šåŠ¡é€»è¾‘
        switch (event.getType()) {
            case "CREATED":
                processOrderCreated(event.getOrderId());
                break;
            case "PAID":
                processOrderPaid(event.getOrderId());
                break;
            case "SHIPPED":
                processOrderShipped(event.getOrderId());
                break;
        }
    }
    
    private void processOrderCreated(Long orderId) {
        // å¤„ç†è®¢å•åˆ›å»ºé€»è¾‘
        // 1. å‘é€ç¡®è®¤é‚®ä»¶
        // 2. æ›´æ–°åº“å­˜
        // 3. ç”Ÿæˆç‰©æµå•
    }
}
```
  </TabItem>
</Tabs>

### 4.2 å¼‚æ­¥è°ƒç”¨

å¼‚æ­¥è°ƒç”¨å¯ä»¥é¿å…è¯·æ±‚çº¿ç¨‹è¢«é•¿æ—¶é—´é˜»å¡ï¼Œæé«˜ç³»ç»Ÿçš„ååé‡ã€‚

```mermaid
sequenceDiagram
    participant Client
    participant Server
    participant Service1
    participant Service2
    participant Service3
    
    Client->>Server: è¯·æ±‚
    activate Server
    Server->>+Service1: å¼‚æ­¥è°ƒç”¨
    Server->>+Service2: å¼‚æ­¥è°ƒç”¨
    Server->>+Service3: å¼‚æ­¥è°ƒç”¨
    Server-->>Client: ç«‹å³å“åº”
    deactivate Server
    
    Service1-->>-Server: å®Œæˆå¤„ç†
    Service2-->>-Server: å®Œæˆå¤„ç†
    Service3-->>-Server: å®Œæˆå¤„ç†
```

<Tabs>
  <TabItem value="asynccall" label="å¼‚æ­¥è°ƒç”¨å®ç°" default>
  ```java
@Service
public class AsyncCallService {
    
    @Autowired
    private ThreadPoolTaskExecutor executor;
    
    // å¼‚æ­¥è°ƒç”¨å¤–éƒ¨æœåŠ¡
    public CompletableFuture<ApiResponse> callExternalServiceAsync(String url) {
        return CompletableFuture.supplyAsync(() -> {
            try {
                // è°ƒç”¨å¤–éƒ¨API
                RestTemplate restTemplate = new RestTemplate();
                return restTemplate.getForObject(url, ApiResponse.class);
            } catch (Exception e) {
                log.error("å¤–éƒ¨æœåŠ¡è°ƒç”¨å¤±è´¥", e);
                return new ApiResponse("ERROR", e.getMessage());
            }
        }, executor);
    }
    
    // æ‰¹é‡å¼‚æ­¥å¤„ç†
    public List<ApiResponse> batchProcessAsync(List<String> urls) {
        List<CompletableFuture<ApiResponse>> futures = urls.stream()
            .map(this::callExternalServiceAsync)
            .collect(Collectors.toList());
        
          // ç­‰å¾…æ‰€æœ‰å¼‚æ­¥è°ƒç”¨å®Œæˆ
          CompletableFuture.allOf(futures.toArray(new CompletableFuture[0])).join();
          
          // æ”¶é›†ç»“æœ
        return futures.stream()
            .map(CompletableFuture::join)
            .collect(Collectors.toList());
    }
  }
  ```
  </TabItem>
  <TabItem value="timeout" label="è¶…æ—¶æ§åˆ¶">
  ```java
    public ApiResponse callWithTimeout(String url, long timeout) {
        try {
            return callExternalServiceAsync(url)
              .orTimeout(timeout, TimeUnit.MILLISECONDS)
              .exceptionally(ex -> {
                  if (ex instanceof TimeoutException) {
                      log.error("è°ƒç”¨è¶…æ—¶", ex);
            return new ApiResponse("TIMEOUT", "è¯·æ±‚è¶…æ—¶");
                  } else {
                      log.error("è°ƒç”¨å¤±è´¥", ex);
                      return new ApiResponse("ERROR", ex.getMessage());
                  }
              })
              .get();
        } catch (Exception e) {
          log.error("è·å–å¼‚æ­¥ç»“æœå¤±è´¥", e);
            return new ApiResponse("ERROR", e.getMessage());
        }
    }
  ```
  </TabItem>
  <TabItem value="fallback" label="é™çº§å¤„ç†">
  ```java
  public CompletableFuture<ApiResponse> callWithFallback(String url) {
      return callExternalServiceAsync(url)
          .thenApply(response -> {
              // å¤„ç†æˆåŠŸå“åº”
              if ("SUCCESS".equals(response.getStatus())) {
                  return response;
              }
              // å¯¹é”™è¯¯å“åº”è¿›è¡Œè½¬æ¢
              return enhanceErrorResponse(response);
          })
          .exceptionally(ex -> {
              log.error("è°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨é™çº§å“åº”", ex);
              return getFallbackResponse(url);
          });
  }
  
  private ApiResponse getFallbackResponse(String url) {
      // æä¾›é™çº§å“åº”
      return new ApiResponse("FALLBACK", "ä½¿ç”¨é™çº§å“åº”");
  }
  ```
  </TabItem>
</Tabs>

## 5. æ•°æ®åº“ä¼˜åŒ–

æ•°æ®åº“å¾€å¾€æ˜¯é«˜å¹¶å‘ç³»ç»Ÿçš„æ€§èƒ½ç“¶é¢ˆï¼Œä¼˜åŒ–æ•°æ®åº“è®¿é—®å¯¹æå‡ç³»ç»Ÿæ•´ä½“æ€§èƒ½è‡³å…³é‡è¦ã€‚

### 5.1 è¯»å†™åˆ†ç¦»

```mermaid
graph TD
    A[åº”ç”¨æœåŠ¡å™¨] --> B{è¯»å†™åˆ†ç¦»}
    B -- å†™æ“ä½œ --> C[ä¸»åº“]
    B -- è¯»æ“ä½œ --> D[ä»åº“1]
    B -- è¯»æ“ä½œ --> E[ä»åº“2]
    B -- è¯»æ“ä½œ --> F[ä»åº“3]
    C -- æ•°æ®åŒæ­¥ --> D
    C -- æ•°æ®åŒæ­¥ --> E
    C -- æ•°æ®åŒæ­¥ --> F
```

<div className="card">
<div className="card__body">

è¯»å†™åˆ†ç¦»çš„æ ¸å¿ƒä¼˜åŠ¿ï¼š

1. **è´Ÿè½½åˆ†æ‹…**ï¼šå†™æ“ä½œé›†ä¸­åœ¨ä¸»åº“ï¼Œè¯»æ“ä½œåˆ†æ•£åˆ°å¤šä¸ªä»åº“
2. **æ°´å¹³æ‰©å±•**ï¼šå¯ä»¥é€šè¿‡å¢åŠ ä»åº“æå‡è¯»æ€§èƒ½
3. **é«˜å¯ç”¨æ€§**ï¼šä¸»åº“æ•…éšœæ—¶å¯ä»¥æå‡ä»åº“ä¸ºä¸»åº“
4. **è¯»å†™å¹¶è¡Œ**ï¼šè¯»å†™æ“ä½œå¯ä»¥å¹¶è¡Œæ‰§è¡Œï¼Œæé«˜ååé‡

</div>
</div>

<Tabs>
  <TabItem value="config" label="è¯»å†™åˆ†ç¦»é…ç½®" default>
  ```java
@Configuration
public class DataSourceConfig {
    
    @Bean
    @Primary
    @ConfigurationProperties("spring.datasource.master")
    public DataSource masterDataSource() {
        return DataSourceBuilder.create().build();
    }
    
    @Bean
    @ConfigurationProperties("spring.datasource.slave")
    public DataSource slaveDataSource() {
        return DataSourceBuilder.create().build();
    }
    
    @Bean
    public DataSource routingDataSource() {
        RoutingDataSource routingDataSource = new RoutingDataSource();
        Map<Object, Object> targetDataSources = new HashMap<>();
        targetDataSources.put("master", masterDataSource());
        targetDataSources.put("slave", slaveDataSource());
        routingDataSource.setTargetDataSources(targetDataSources);
        routingDataSource.setDefaultTargetDataSource(masterDataSource());
        return routingDataSource;
    }
}
  ```
  </TabItem>
  <TabItem value="routing" label="æ•°æ®æºè·¯ç”±">
  ```java
// æ•°æ®æºè·¯ç”±
public class RoutingDataSource extends AbstractRoutingDataSource {
    
    @Override
    protected Object determineCurrentLookupKey() {
        return DataSourceContextHolder.getDataSourceType();
    }
}

// æ•°æ®æºä¸Šä¸‹æ–‡
public class DataSourceContextHolder {
    
    private static final ThreadLocal<String> contextHolder = new ThreadLocal<>();
    
    public static void setDataSourceType(String dataSourceType) {
        contextHolder.set(dataSourceType);
    }
    
    public static String getDataSourceType() {
        return contextHolder.get();
    }
    
    public static void clearDataSourceType() {
        contextHolder.remove();
    }
}
  ```
  </TabItem>
  <TabItem value="aspect" label="AOPåˆ‡é¢">
  ```java
// AOPåˆ‡é¢
@Aspect
@Component
public class DataSourceAspect {
    
    @Around("@annotation(readOnly)")
    public Object around(ProceedingJoinPoint point, ReadOnly readOnly) throws Throwable {
        DataSourceContextHolder.setDataSourceType("slave");
        try {
            return point.proceed();
        } finally {
            DataSourceContextHolder.clearDataSourceType();
        }
    }
}

// åªè¯»æ³¨è§£
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface ReadOnly {
}
```
  </TabItem>
</Tabs>

### 5.2 åˆ†åº“åˆ†è¡¨

åˆ†åº“åˆ†è¡¨æ˜¯è§£å†³æ•°æ®åº“å•è¡¨æ•°æ®é‡è¿‡å¤§é—®é¢˜çš„æœ‰æ•ˆæ–¹æ¡ˆï¼Œé€šè¿‡æ°´å¹³æˆ–å‚ç›´æ‹†åˆ†ï¼Œå¯ä»¥æå‡æ•°æ®åº“çš„å¹¶å‘å¤„ç†èƒ½åŠ›ã€‚

```mermaid
graph TD
    A[åº”ç”¨] --> B[åˆ†åº“åˆ†è¡¨ä¸­é—´ä»¶]
    B --> C[DB1]
    B --> D[DB2]
    B --> E[DB3]
    
    C --> C1[è¡¨1_0]
    C --> C2[è¡¨1_1]
    D --> D1[è¡¨2_0]
    D --> D2[è¡¨2_1]
    E --> E1[è¡¨3_0]
    E --> E2[è¡¨3_1]
```

<Tabs>
  <TabItem value="strategy" label="åˆ†ç‰‡ç­–ç•¥" default>
  ```java
@Component
public class ShardingStrategy {
    
    private List<DataSource> dataSources = Arrays.asList(
        dataSource1, dataSource2, dataSource3, dataSource4
    );
    
    // æ ¹æ®ç”¨æˆ·IDåˆ†åº“
    public DataSource getDataSourceByUserId(Long userId) {
        int dbIndex = (int) (userId % dataSources.size());
        return dataSources.get(dbIndex);
    }
    
    // æ ¹æ®ç”¨æˆ·IDåˆ†è¡¨
    public String getTableNameByUserId(String baseTableName, Long userId) {
        int tableIndex = (int) (userId % 10);
        return baseTableName + "_" + tableIndex;
    }
    
    // ä¸€è‡´æ€§å“ˆå¸Œåˆ†ç‰‡
    public DataSource getDataSourceByHash(String key) {
        int hash = Math.abs(key.hashCode());
        int index = hash % dataSources.size();
        return dataSources.get(index);
    }
}
  ```
  </TabItem>
  <TabItem value="service" label="åˆ†ç‰‡æœåŠ¡">
  ```java
@Service
public class ShardingService {
    
    @Autowired
    private ShardingStrategy shardingStrategy;
    
    public User getUserById(Long userId) {
        DataSource dataSource = shardingStrategy.getDataSourceByUserId(userId);
        String tableName = shardingStrategy.getTableNameByUserId("users", userId);
        
        // ä½¿ç”¨æŒ‡å®šçš„æ•°æ®æºå’Œè¡¨åæŸ¥è¯¢
        return queryUserFromDataSource(dataSource, tableName, userId);
    }
    
    private User queryUserFromDataSource(DataSource dataSource, String tableName, Long userId) {
          try (Connection conn = dataSource.getConnection()) {
              PreparedStatement stmt = conn.prepareStatement(
                  "SELECT * FROM " + tableName + " WHERE id = ?"
              );
              stmt.setLong(1, userId);
              ResultSet rs = stmt.executeQuery();
              
              if (rs.next()) {
                  User user = new User();
                  user.setId(rs.getLong("id"));
                  user.setName(rs.getString("name"));
                  user.setEmail(rs.getString("email"));
                  return user;
              }
              
              return null;
          } catch (SQLException e) {
              log.error("æŸ¥è¯¢ç”¨æˆ·å¤±è´¥", e);
              throw new RuntimeException("æŸ¥è¯¢ç”¨æˆ·å¤±è´¥", e);
          }
    }
}
```
  </TabItem>
</Tabs>

:::caution åˆ†åº“åˆ†è¡¨æ³¨æ„äº‹é¡¹
1. **åˆ†ç‰‡é”®é€‰æ‹©**ï¼šé€‰æ‹©åˆé€‚çš„åˆ†ç‰‡é”®å¯¹æ€§èƒ½è‡³å…³é‡è¦
2. **è·¨åº“æŸ¥è¯¢**ï¼šè·¨åº“æŸ¥è¯¢ä¼šå¸¦æ¥æ€§èƒ½é—®é¢˜ï¼Œåº”å°½é‡é¿å…
3. **äº‹åŠ¡å¤„ç†**ï¼šè·¨åº“äº‹åŠ¡éœ€è¦ä½¿ç”¨åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†
4. **æ•°æ®æ‰©å®¹**ï¼šéšç€æ•°æ®å¢é•¿ï¼Œå¯èƒ½éœ€è¦é‡æ–°åˆ†ç‰‡
5. **æ•°æ®è¿ç§»**ï¼šå†å²æ•°æ®è¿ç§»éœ€è¦åœ¨ä¸šåŠ¡ä½å³°æœŸè¿›è¡Œ
:::

## 6. é¢è¯•é¢˜ç²¾é€‰

<details>
<summary>**Q: ä»€ä¹ˆæ˜¯é«˜å¹¶å‘ï¼Ÿå¦‚ä½•è®¾è®¡é«˜å¹¶å‘ç³»ç»Ÿï¼Ÿ**</summary>

**A:** é«˜å¹¶å‘æ˜¯æŒ‡ç³»ç»Ÿèƒ½å¤ŸåŒæ—¶å¤„ç†å¤§é‡å¹¶å‘è¯·æ±‚çš„èƒ½åŠ›ã€‚è®¾è®¡é«˜å¹¶å‘ç³»ç»Ÿçš„æ–¹æ³•ï¼š
- **æ¶æ„å±‚é¢**ï¼šé‡‡ç”¨åˆ†å¸ƒå¼æ¶æ„ã€å¾®æœåŠ¡æ¶æ„
- **ç¼“å­˜å±‚é¢**ï¼šå¤šçº§ç¼“å­˜ã€ç¼“å­˜é¢„çƒ­ã€ç¼“å­˜æ›´æ–°ç­–ç•¥
- **å¼‚æ­¥å¤„ç†**ï¼šæ¶ˆæ¯é˜Ÿåˆ—ã€å¼‚æ­¥è°ƒç”¨ã€äº‹ä»¶é©±åŠ¨
- **æ•°æ®åº“ä¼˜åŒ–**ï¼šè¯»å†™åˆ†ç¦»ã€åˆ†åº“åˆ†è¡¨ã€ç´¢å¼•ä¼˜åŒ–
- **è´Ÿè½½å‡è¡¡**ï¼šåº”ç”¨å±‚è´Ÿè½½å‡è¡¡ã€æ•°æ®åº“è´Ÿè½½å‡è¡¡
</details>

<details>
<summary>**Q: å¦‚ä½•è§£å†³ç¼“å­˜ç©¿é€é—®é¢˜ï¼Ÿ**</summary>

**A:** è§£å†³ç¼“å­˜ç©¿é€çš„æ–¹æ³•ï¼š
- **å¸ƒéš†è¿‡æ»¤å™¨**ï¼šå¿«é€Ÿåˆ¤æ–­keyæ˜¯å¦å­˜åœ¨
- **ç©ºå€¼ç¼“å­˜**ï¼šå°†ç©ºç»“æœä¹Ÿç¼“å­˜ï¼Œè®¾ç½®è¾ƒçŸ­çš„è¿‡æœŸæ—¶é—´
- **å‚æ•°æ ¡éªŒ**ï¼šå¯¹è¯·æ±‚å‚æ•°è¿›è¡Œä¸¥æ ¼æ ¡éªŒ
- **é™æµä¿æŠ¤**ï¼šå¯¹å¼‚å¸¸è¯·æ±‚è¿›è¡Œé™æµ
</details>

<details>
<summary>**Q: å¦‚ä½•è®¾è®¡ä¸€ä¸ªç§’æ€ç³»ç»Ÿï¼Ÿ**</summary>

**A:** ç§’æ€ç³»ç»Ÿè®¾è®¡è¦ç‚¹ï¼š
- **å‰ç«¯ä¼˜åŒ–**ï¼šé¡µé¢é™æ€åŒ–ã€CDNåŠ é€Ÿã€æŒ‰é’®æ§åˆ¶
- **æ¥å£ä¼˜åŒ–**ï¼šé™æµã€å¼‚æ­¥å¤„ç†ã€ç¼“å­˜é¢„çƒ­
- **åº“å­˜æ§åˆ¶**ï¼šé¢„æ‰£åº“å­˜ã€åº“å­˜é”å®šã€è¶…æ—¶é‡Šæ”¾
- **è®¢å•å¤„ç†**ï¼šå¼‚æ­¥åˆ›å»ºè®¢å•ã€æ¶ˆæ¯é˜Ÿåˆ—ã€æ•°æ®åº“ä¼˜åŒ–
- **é˜²åˆ·æœºåˆ¶**ï¼šç”¨æˆ·é™è´­ã€IPé™æµã€éªŒè¯ç 
</details>

<details>
<summary>**Q: å¦‚ä½•å¤„ç†é«˜å¹¶å‘ä¸‹çš„æ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼Ÿ**</summary>

**A:** æ•°æ®ä¸€è‡´æ€§å¤„ç†æ–¹æ³•ï¼š
- **åˆ†å¸ƒå¼äº‹åŠ¡**ï¼š2PCã€3PCã€TCCã€Saga
- **æœ€ç»ˆä¸€è‡´æ€§**ï¼šæ¶ˆæ¯é˜Ÿåˆ—ã€è¡¥å¿æœºåˆ¶ã€å¹‚ç­‰æ€§
- **ä¹è§‚é”**ï¼šç‰ˆæœ¬å·ã€æ—¶é—´æˆ³ã€CASæ“ä½œ
- **æ‚²è§‚é”**ï¼šæ•°æ®åº“é”ã€åˆ†å¸ƒå¼é”ã€Redisé”
</details>

:::tip é«˜å¹¶å‘å­¦ä¹ è¦ç‚¹
1. **ç†è§£å¹¶å‘æ¨¡å‹**ï¼šæŒæ¡çº¿ç¨‹æ¨¡å‹ã€å¼‚æ­¥ç¼–ç¨‹ã€å¹¶å‘æ§åˆ¶
2. **æŒæ¡ç¼“å­˜ç­–ç•¥**ï¼šå­¦ä¼šå¤šçº§ç¼“å­˜ã€ç¼“å­˜æ›´æ–°ã€ç¼“å­˜ç©¿é€é˜²æŠ¤
3. **ç†Ÿæ‚‰å¼‚æ­¥å¤„ç†**ï¼šäº†è§£æ¶ˆæ¯é˜Ÿåˆ—ã€å¼‚æ­¥è°ƒç”¨ã€äº‹ä»¶é©±åŠ¨
4. **å­¦ä¼šæ•°æ®åº“ä¼˜åŒ–**ï¼šæŒæ¡è¯»å†™åˆ†ç¦»ã€åˆ†åº“åˆ†è¡¨ã€ç´¢å¼•ä¼˜åŒ–
5. **äº†è§£è´Ÿè½½å‡è¡¡**ï¼šå­¦ä¼šè´Ÿè½½å‡è¡¡ç®—æ³•ã€å¥åº·æ£€æŸ¥ã€æ•…éšœè½¬ç§»
:::

---

é€šè¿‡æœ¬ç« çš„å­¦ä¹ ï¼Œä½ åº”è¯¥å·²ç»æŒæ¡äº†é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡çš„æ ¸å¿ƒæ¦‚å¿µã€æ¶æ„æ¨¡å¼å’Œä¼˜åŒ–ç­–ç•¥ã€‚é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡æ˜¯æ„å»ºé«˜æ€§èƒ½ã€é«˜å¯ç”¨ç³»ç»Ÿçš„é‡è¦æŠ€èƒ½ï¼ŒæŒæ¡è¿™äº›æŠ€æœ¯å¯ä»¥å¸®åŠ©ä½ è®¾è®¡å‡ºèƒ½å¤Ÿå¤„ç†å¤§é‡å¹¶å‘è¯·æ±‚çš„ç³»ç»Ÿã€‚åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œåˆç†è¿ç”¨è¿™äº›æŠ€æœ¯å¯ä»¥å¤§å¤§æé«˜ç³»ç»Ÿçš„å¹¶å‘å¤„ç†èƒ½åŠ›å’Œç”¨æˆ·ä½“éªŒã€‚ 