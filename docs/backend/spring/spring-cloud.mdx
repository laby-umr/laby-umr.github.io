---
sidebar_position: 6
title: "Spring Cloudè¯¦è§£"
description: "æ·±å…¥ç†è§£Spring Cloudå¾®æœåŠ¡æ¶æ„ä¸ç»„ä»¶"
authors: [Laby]
last_update:
  date: 2025-08-07
  author: Laby
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import TOCInline from '@theme/TOCInline';

# Spring Cloud è¯¦è§£

Spring Cloudæ˜¯æ„å»ºåˆ†å¸ƒå¼ç³»ç»Ÿå’Œå¾®æœåŠ¡æ¶æ„çš„å®Œæ•´è§£å†³æ–¹æ¡ˆï¼Œå®ƒåŸºäºSpring Bootæä¾›äº†æœåŠ¡æ³¨å†Œå‘ç°ã€é…ç½®ç®¡ç†ã€è´Ÿè½½å‡è¡¡ã€ç†”æ–­é™çº§ç­‰å¾®æœåŠ¡æ ¸å¿ƒåŠŸèƒ½ã€‚

:::info æœ¬æ–‡å†…å®¹æ¦‚è§ˆ
<TOCInline toc={toc} />
:::

:::tip æ ¸å¿ƒä»·å€¼
**Spring Cloud = å¾®æœåŠ¡æ¶æ„ + æœåŠ¡æ²»ç† + é…ç½®ç®¡ç† + è´Ÿè½½å‡è¡¡ + ç†”æ–­é™çº§**
- ğŸ” **æœåŠ¡æ²»ç†**ï¼šæœåŠ¡æ³¨å†Œå‘ç°ã€APIç½‘å…³
- âš–ï¸ **è´Ÿè½½å‡è¡¡**ï¼šæ™ºèƒ½è·¯ç”±ã€å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡
- ğŸ›¡ï¸ **ç†”æ–­é™çº§**ï¼šæœåŠ¡å®¹é”™ã€å¤±è´¥éš”ç¦»
- âš™ï¸ **é…ç½®ç®¡ç†**ï¼šé›†ä¸­é…ç½®ã€åŠ¨æ€åˆ·æ–°
- ğŸ“Š **é“¾è·¯è¿½è¸ª**ï¼šåˆ†å¸ƒå¼ç³»ç»Ÿç›‘æ§ã€è°ƒç”¨é“¾åˆ†æ
:::

## 1. Spring CloudåŸºç¡€æ¦‚å¿µ

### 1.1 ä»€ä¹ˆæ˜¯å¾®æœåŠ¡ï¼Ÿ

å¾®æœåŠ¡æ˜¯ä¸€ç§è½¯ä»¶æ¶æ„é£æ ¼ï¼Œå°†åº”ç”¨ç¨‹åºæ‹†åˆ†ä¸ºä¸€ç»„å°å‹ã€ç‹¬ç«‹çš„æœåŠ¡ï¼Œæ¯ä¸ªæœåŠ¡è¿è¡Œåœ¨è‡ªå·±çš„è¿›ç¨‹ä¸­ï¼Œé€šè¿‡è½»é‡çº§æœºåˆ¶è¿›è¡Œé€šä¿¡ã€‚

```mermaid
graph TD
    A[å•ä½“åº”ç”¨] --> B[æ‹†åˆ†]
    B --> C[æœåŠ¡A]
    B --> D[æœåŠ¡B]
    B --> E[æœåŠ¡C]
    
    C --> F[ç‹¬ç«‹éƒ¨ç½²]
    D --> F
    E --> F
    
    C --> G[ç‹¬ç«‹æ‰©å±•]
    D --> G
    E --> G
    
    C --> H[ç‹¬ç«‹ç»´æŠ¤]
    D --> H
    E --> H
    
    style A fill:#ffcccc
    style C fill:#ccffcc
    style D fill:#ccffcc
    style E fill:#ccffcc
```

#### å¾®æœåŠ¡æ¶æ„ç‰¹ç‚¹

<div className="card">
<div className="card__body">

| ç‰¹ç‚¹ | è¯´æ˜ | ä¼˜åŠ¿ |
|------|------|------|
| **æœåŠ¡æ‹†åˆ†** | æŒ‰ä¸šåŠ¡åŠŸèƒ½æ‹†åˆ†æœåŠ¡ | èŒè´£å•ä¸€ï¼Œæ˜“äºç»´æŠ¤ |
| **ç‹¬ç«‹éƒ¨ç½²** | æ¯ä¸ªæœåŠ¡å¯ç‹¬ç«‹éƒ¨ç½² | å¿«é€Ÿè¿­ä»£ï¼Œé™ä½é£é™© |
| **æŠ€æœ¯å¼‚æ„** | ä¸åŒæœåŠ¡å¯ä½¿ç”¨ä¸åŒæŠ€æœ¯æ ˆ | æŠ€æœ¯é€‰å‹çµæ´» |
| **æ•°æ®éš”ç¦»** | æ¯ä¸ªæœåŠ¡ç®¡ç†è‡ªå·±çš„æ•°æ® | æ•°æ®ä¸€è‡´æ€§å¯æ§ |
| **æ•…éšœéš”ç¦»** | å•ä¸ªæœåŠ¡æ•…éšœä¸å½±å“æ•´ä½“ | æé«˜ç³»ç»Ÿå¯ç”¨æ€§ |

</div>
</div>

### 1.2 Spring Cloudç»„ä»¶

Spring Cloudæä¾›äº†ä¸€å¥—å®Œæ•´çš„å¾®æœåŠ¡è§£å†³æ–¹æ¡ˆï¼ŒåŒ…å«å¤šä¸ªç»„ä»¶å…±åŒæ„å»ºåˆ†å¸ƒå¼ç³»ç»Ÿã€‚

```mermaid
graph TB
    A[Spring Cloud] --> B[æœåŠ¡æ³¨å†Œä¸å‘ç°]
    A --> C[æœåŠ¡ç½‘å…³]
    A --> D[è´Ÿè½½å‡è¡¡]
    A --> E[ç†”æ–­é™çº§]
    A --> F[é…ç½®ç®¡ç†]
    A --> G[é“¾è·¯è¿½è¸ª]
    
    B --> B1[Eureka]
    B --> B2[Consul]
    B --> B3[Nacos]
    
    C --> C1[Gateway]
    C --> C2[Zuul]
    
    D --> D1[Ribbon]
    D --> D2[LoadBalancer]
    
    E --> E1[Hystrix]
    E --> E2[Sentinel]
    E --> E3[Resilience4j]
    
    F --> F1[Config]
    F --> F2[Bus]
    
    G --> G1[Sleuth]
    G --> G2[Zipkin]
```

<details>
<summary>Spring Cloudä¾èµ–é…ç½®</summary>

```xml title="Spring Cloudä¾èµ–"
<dependencyManagement>
    <dependencies>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-dependencies</artifactId>
            <version>2021.0.8</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>
    </dependencies>
</dependencyManagement>
```

</details>

## 2. æœåŠ¡æ³¨å†Œä¸å‘ç°

æœåŠ¡æ³¨å†Œä¸å‘ç°æ˜¯å¾®æœåŠ¡æ¶æ„çš„åŸºç¡€è®¾æ–½ï¼Œç”¨äºç®¡ç†å’Œå®šä½æœåŠ¡å®ä¾‹ã€‚

```mermaid
sequenceDiagram
    participant ServiceA as æœåŠ¡A
    participant Registry as æ³¨å†Œä¸­å¿ƒ
    participant ServiceB as æœåŠ¡B
    
    ServiceA->>Registry: æ³¨å†ŒæœåŠ¡(æœåŠ¡åã€IPã€ç«¯å£)
    ServiceB->>Registry: æ³¨å†ŒæœåŠ¡(æœåŠ¡åã€IPã€ç«¯å£)
    
    ServiceA->>Registry: è·å–æœåŠ¡Bçš„å®ä¾‹åˆ—è¡¨
    Registry-->>ServiceA: è¿”å›æœåŠ¡Bçš„å®ä¾‹åˆ—è¡¨
    
    ServiceA->>ServiceB: è°ƒç”¨æœåŠ¡
    
    loop å®šæ—¶
        ServiceA->>Registry: å‘é€å¿ƒè·³
        ServiceB->>Registry: å‘é€å¿ƒè·³
        Registry->>Registry: æ¸…ç†æ— å¿ƒè·³æœåŠ¡
    end
```

### 2.1 Eureka Server

<Tabs>
  <TabItem value="java" label="Javaé…ç½®" default>
```java title="Eureka Serveré…ç½®"
@SpringBootApplication
@EnableEurekaServer
public class EurekaServerApplication {
    public static void main(String[] args) {
        SpringApplication.run(EurekaServerApplication.class, args);
    }
}
```
  </TabItem>
  <TabItem value="yaml" label="YAMLé…ç½®">
```yaml title="Eureka Serveré…ç½®"
server:
  port: 8761

spring:
  application:
    name: eureka-server

eureka:
  instance:
    hostname: localhost
  client:
    register-with-eureka: false
    fetch-registry: false
    service-url:
      defaultZone: http://localhost:8761/eureka/
  server:
    enable-self-preservation: false
    eviction-interval-timer-in-ms: 1000
```
  </TabItem>
  <TabItem value="cluster" label="é›†ç¾¤é…ç½®">
  ```yaml title="Eureka Serveré›†ç¾¤é…ç½®"
  # eureka-server-1 é…ç½®
  server:
    port: 8761
  
  spring:
    application:
      name: eureka-server
  
  eureka:
    instance:
      hostname: eureka1
    client:
      register-with-eureka: true
      fetch-registry: true
      service-url:
        defaultZone: http://eureka2:8762/eureka/,http://eureka3:8763/eureka/
        
  # eureka-server-2 é…ç½®
  server:
    port: 8762
  
  spring:
    application:
      name: eureka-server
  
  eureka:
    instance:
      hostname: eureka2
    client:
      register-with-eureka: true
      fetch-registry: true
      service-url:
        defaultZone: http://eureka1:8761/eureka/,http://eureka3:8763/eureka/
  ```
  </TabItem>
</Tabs>

### 2.2 Eureka Client

<Tabs>
  <TabItem value="java" label="Javaé…ç½®" default>
```java title="Eureka Clienté…ç½®"
@SpringBootApplication
@EnableEurekaClient
public class UserServiceApplication {
    public static void main(String[] args) {
        SpringApplication.run(UserServiceApplication.class, args);
    }
}
```
  </TabItem>
  <TabItem value="yaml" label="YAMLé…ç½®">
```yaml title="Eureka Clienté…ç½®"
spring:
  application:
    name: user-service

eureka:
  client:
    service-url:
      defaultZone: http://localhost:8761/eureka/
    register-with-eureka: true
    fetch-registry: true
  instance:
    prefer-ip-address: true
    instance-id: ${spring.application.name}:${server.port}
    lease-renewal-interval-in-seconds: 30
    lease-expiration-duration-in-seconds: 90
```
  </TabItem>
</Tabs>

<div className="card">
<div className="card__header">
<h4>Eureka Clientæ ¸å¿ƒé…ç½®è¯´æ˜</h4>
</div>
<div className="card__body">

| é…ç½®é¡¹ | è¯´æ˜ | é»˜è®¤å€¼ | æ¨èè®¾ç½® |
|------|------|--------|---------|
| **register-with-eureka** | æ˜¯å¦æ³¨å†Œåˆ°Eureka | true | ç”Ÿäº§ç¯å¢ƒä¿æŒtrue |
| **fetch-registry** | æ˜¯å¦ä»Eurekaè·å–æ³¨å†Œä¿¡æ¯ | true | ç”Ÿäº§ç¯å¢ƒä¿æŒtrue |
| **prefer-ip-address** | æ˜¯å¦ä½¿ç”¨IPåœ°å€æ³¨å†Œ | false | å»ºè®®è®¾ä¸ºtrue |
| **lease-renewal-interval** | å¿ƒè·³é—´éš”æ—¶é—´(ç§’) | 30 | æ ¹æ®è´Ÿè½½è°ƒæ•´ |
| **lease-expiration-duration** | å¤±æ•ˆæ—¶é—´(ç§’) | 90 | é€šå¸¸ä¸ºå¿ƒè·³é—´éš”çš„3å€ |

</div>
</div>

### 2.3 æœåŠ¡æ³¨å†Œç¤ºä¾‹

<div className="card">
<div className="card__body">

```java title="æœåŠ¡æ³¨å†Œç¤ºä¾‹"
@RestController
@RequestMapping("/users")
public class UserController {
    
    @Autowired
    private UserService userService;
    
    @GetMapping("/{id}")
    public ResponseEntity<User> getUser(@PathVariable Long id) {
        User user = userService.findById(id);
        return ResponseEntity.ok(user);
    }
    
    @PostMapping
    public ResponseEntity<User> createUser(@RequestBody User user) {
        User savedUser = userService.save(user);
        return ResponseEntity.status(HttpStatus.CREATED).body(savedUser);
    }
}
```

</div>
</div>

## 3. æœåŠ¡ç½‘å…³

### 3.1 Gatewayé…ç½®

Spring Cloud Gatewayæ˜¯APIç½‘å…³æœåŠ¡ï¼Œæä¾›äº†è·¯ç”±ã€è¿‡æ»¤ã€é™æµç­‰åŠŸèƒ½ã€‚

```mermaid
flowchart TD
    A[å®¢æˆ·ç«¯] --> B[Gateway]
    B --> C[è·¯ç”±Predicate]
    B --> D[è¿‡æ»¤å™¨é“¾]
    C --> E[æœåŠ¡A]
    C --> F[æœåŠ¡B]
    C --> G[æœåŠ¡C]
    D --> H[å‰ç½®è¿‡æ»¤å™¨\nè®¤è¯/é™æµ/æ—¥å¿—]
    D --> I[åç½®è¿‡æ»¤å™¨\nå“åº”ä¿®æ”¹]
    
    subgraph è¿‡æ»¤å™¨é“¾
    H
    I
    end
    
    subgraph æœåŠ¡å®ä¾‹
    E
    F
    G
    end
```

<Tabs>
  <TabItem value="java" label="Javaé…ç½®" default>
```java title="Gatewayé…ç½®"
@SpringBootApplication
@EnableDiscoveryClient
public class GatewayApplication {
    public static void main(String[] args) {
        SpringApplication.run(GatewayApplication.class, args);
    }
}
```
  </TabItem>
  <TabItem value="yaml" label="YAMLé…ç½®">
```yaml title="Gatewayè·¯ç”±é…ç½®"
spring:
  cloud:
    gateway:
      discovery:
        locator:
          enabled: true
          lower-case-service-id: true
      routes:
        - id: user-service
          uri: lb://user-service
          predicates:
            - Path=/api/users/**
          filters:
            - StripPrefix=1
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 10
                redis-rate-limiter.burstCapacity: 20
        
        - id: order-service
          uri: lb://order-service
          predicates:
            - Path=/api/orders/**
          filters:
            - StripPrefix=1
            - name: CircuitBreaker
              args:
                name: orderCircuitBreaker
                fallbackUri: forward:/fallback/order
```
  </TabItem>
</Tabs>

### 3.2 è‡ªå®šä¹‰è¿‡æ»¤å™¨

<div className="card">
<div className="card__body">

```java title="è‡ªå®šä¹‰è¿‡æ»¤å™¨"
@Component
public class AuthFilter implements GlobalFilter, Ordered {
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        ServerHttpRequest request = exchange.getRequest();
        String token = request.getHeaders().getFirst("Authorization");
        
        if (token == null || !isValidToken(token)) {
            ServerHttpResponse response = exchange.getResponse();
            response.setStatusCode(HttpStatus.UNAUTHORIZED);
            return response.setComplete();
        }
        
        return chain.filter(exchange);
    }
    
    @Override
    public int getOrder() {
        return -100;
    }
    
    private boolean isValidToken(String token) {
        // éªŒè¯tokené€»è¾‘
        return token != null && token.startsWith("Bearer ");
    }
}
```

</div>
</div>

### 3.3 é™æµé…ç½®

<Tabs>
  <TabItem value="code" label="ä»£ç é…ç½®" default>
```java title="é™æµé…ç½®"
@Configuration
public class RateLimiterConfig {
    
    @Bean
    public KeyResolver userKeyResolver() {
        return exchange -> Mono.just(
            exchange.getRequest().getHeaders().getFirst("X-User-Id")
        );
    }
    
    @Bean
    public KeyResolver ipKeyResolver() {
        return exchange -> Mono.just(
            exchange.getRequest().getRemoteAddress().getAddress().getHostAddress()
        );
    }
}
```
  </TabItem>
  <TabItem value="redisrate" label="Redisé™æµå™¨">
  ```yaml title="Redisé™æµé…ç½®"
  spring:
    cloud:
      gateway:
        routes:
          - id: user-service
            uri: lb://user-service
            predicates:
              - Path=/api/users/**
            filters:
              - name: RequestRateLimiter
                args:
                  redis-rate-limiter.replenishRate: 10  # ä»¤ç‰Œæ¡¶æ¯ç§’å¡«å……é€Ÿç‡
                  redis-rate-limiter.burstCapacity: 20  # ä»¤ç‰Œæ¡¶æ€»å®¹é‡
                  key-resolver: "#{@ipKeyResolver}"     # é™æµé”®è§£æå™¨
  ```
  </TabItem>
</Tabs>

## 4. è´Ÿè½½å‡è¡¡

Spring Cloudæä¾›äº†å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡åŠŸèƒ½ï¼Œä¸»è¦é€šè¿‡Ribbonå’ŒLoadBalancerç»„ä»¶å®ç°ã€‚

```mermaid
graph TD
    A[æœåŠ¡æ¶ˆè´¹è€…] --> B[è´Ÿè½½å‡è¡¡å™¨]
    B --> C[æœåŠ¡æ³¨å†Œä¸­å¿ƒ]
    C --> D[è·å–æœåŠ¡å®ä¾‹åˆ—è¡¨]
    D --> B
    B --> E["è´Ÿè½½å‡è¡¡ç­–ç•¥\n(è½®è¯¢/éšæœº/æƒé‡)"]
    E --> F["æœåŠ¡æä¾›è€…1"]
    E --> G["æœåŠ¡æä¾›è€…2"]
    E --> H["æœåŠ¡æä¾›è€…3"]
    
    style B fill:#f9f,stroke:#333,stroke-width:2px
    style E fill:#bbf,stroke:#333,stroke-width:1px
```

### 4.1 Ribboné…ç½®

<Tabs>
  <TabItem value="config" label="åŸºç¡€é…ç½®" default>
```java title="Ribboné…ç½®"
@Configuration
public class RibbonConfig {
    
    @Bean
    @LoadBalanced
    public RestTemplate restTemplate() {
        return new RestTemplate();
    }
    
    @Bean
    public IRule ribbonRule() {
        return new RoundRobinRule(); // è½®è¯¢ç­–ç•¥
    }
    
    @Bean
    public IPing ribbonPing() {
        return new PingUrl();
    }
}
```
  </TabItem>
  <TabItem value="yaml" label="YAMLé…ç½®">
  ```yaml title="Ribboné…ç½®"
  ribbon:
    ReadTimeout: 5000
    ConnectTimeout: 2000
    MaxAutoRetries: 1
    MaxAutoRetriesNextServer: 2
    # ç‰¹å®šæœåŠ¡çš„é…ç½®
    user-service:
      ReadTimeout: 10000
      ConnectTimeout: 5000
  ```
  </TabItem>
</Tabs>

### 4.2 è´Ÿè½½å‡è¡¡ç­–ç•¥

```mermaid
graph TD
    A[Ribbonè´Ÿè½½å‡è¡¡ç­–ç•¥] --> B[RoundRobinRule]
    A --> C[RandomRule]
    A --> D[RetryRule]
    A --> E[WeightedResponseTimeRule]
    A --> F[ZoneAvoidanceRule]
    A --> G[BestAvailableRule]
    
    B --> B1["è½®è¯¢é€‰æ‹©æœåŠ¡å®ä¾‹"]
    C --> C1["éšæœºé€‰æ‹©æœåŠ¡å®ä¾‹"]
    D --> D1["é‡è¯•å…¶ä»–æœåŠ¡å®ä¾‹"]
    E --> E1["å“åº”æ—¶é—´åŠ æƒé€‰æ‹©"]
    F --> F1["åŒºåŸŸæ„ŸçŸ¥é€‰æ‹©"]
    G --> G1["é€‰æ‹©å¹¶å‘è¯·æ±‚æœ€å°‘çš„å®ä¾‹"]
```

<div className="card">
<div className="card__body">

```java title="è´Ÿè½½å‡è¡¡ç­–ç•¥"
@Service
public class UserService {
    
    @Autowired
    @LoadBalanced
    private RestTemplate restTemplate;
    
    public User getUserById(Long id) {
        // ä½¿ç”¨æœåŠ¡åè¿›è¡Œè´Ÿè½½å‡è¡¡è°ƒç”¨
        return restTemplate.getForObject(
            "http://user-service/users/" + id, 
            User.class
        );
    }
    
    public List<User> getAllUsers() {
        return restTemplate.getForObject(
            "http://user-service/users", 
            List.class
        );
    }
}
```

</div>
</div>

### 4.3 è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡

<Tabs>
  <TabItem value="custom-rule" label="è‡ªå®šä¹‰è§„åˆ™" default>
```java title="è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡"
@Component
public class CustomLoadBalancerRule extends AbstractLoadBalancerRule {
    
    @Override
    public Server choose(Object key) {
        ILoadBalancer lb = getLoadBalancer();
        
        List<Server> reachableServers = lb.getReachableServers();
        List<Server> allServers = lb.getAllServers();
        
        if (reachableServers.isEmpty()) {
            return null;
        }
        
        // è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡é€»è¾‘
        return reachableServers.get(new Random().nextInt(reachableServers.size()));
    }
    
    @Override
    public void initWithNiwsConfig(IClientConfig clientConfig) {
        // åˆå§‹åŒ–é…ç½®
    }
}
```
  </TabItem>
  <TabItem value="config-rule" label="é…ç½®è‡ªå®šä¹‰è§„åˆ™">
  ```java title="é…ç½®è‡ªå®šä¹‰è§„åˆ™"
  @Configuration
  public class RibbonClientConfig {
      
      @Bean
      public IRule ribbonRule() {
          return new CustomLoadBalancerRule();
      }
  }
  
  // é’ˆå¯¹ç‰¹å®šæœåŠ¡çš„é…ç½®
  @Configuration
  @RibbonClient(name = "user-service", configuration = UserServiceRibbonConfig.class)
  public class UserServiceRibbonConfig {
      
      @Bean
      public IRule ribbonRule() {
          return new WeightedResponseTimeRule();
      }
      
      @Bean
      public IPing ribbonPing() {
          return new PingUrl();
      }
  }
  ```
  </TabItem>
</Tabs>

## 5. ç†”æ–­é™çº§

ç†”æ–­å™¨è®¾è®¡æ¨¡å¼ç”¨äºä¿æŠ¤ç³»ç»Ÿå…å—çº§è”æ•…éšœå½±å“ï¼Œå½“æœåŠ¡è°ƒç”¨å¤±è´¥è¾¾åˆ°é˜ˆå€¼æ—¶ï¼Œè§¦å‘ç†”æ–­ï¼Œå¹¶æä¾›åå¤‡å“åº”ã€‚

```mermaid
stateDiagram-v2
    [*] --> CLOSED
    CLOSED --> OPEN: é”™è¯¯ç‡è¾¾åˆ°é˜ˆå€¼
    OPEN --> HALF_OPEN: ç­‰å¾…ç†”æ–­æ—¶é—´çª—å£
    HALF_OPEN --> CLOSED: æ¢æµ‹è¯·æ±‚æˆåŠŸ
    HALF_OPEN --> OPEN: æ¢æµ‹è¯·æ±‚å¤±è´¥
    
    state CLOSED {
        [*] --> æ‰§è¡Œæ“ä½œ
        æ‰§è¡Œæ“ä½œ --> æˆåŠŸ: æ­£å¸¸è¿”å›
        æ‰§è¡Œæ“ä½œ --> å¤±è´¥: æŠ›å‡ºå¼‚å¸¸
        å¤±è´¥ --> è®¡æ•°å™¨å¢åŠ 
        è®¡æ•°å™¨å¢åŠ  --> æ£€æŸ¥é˜ˆå€¼
    }
    
    state OPEN {
        [*] --> æ‹’ç»è¯·æ±‚
        æ‹’ç»è¯·æ±‚ --> æ‰§è¡Œé™çº§é€»è¾‘
    }
    
    state HALF_OPEN {
        [*] --> å°è¯•æ“ä½œ
        å°è¯•æ“ä½œ --> æˆåŠŸæ¢æµ‹: æ­£å¸¸è¿”å›
        å°è¯•æ“ä½œ --> å¤±è´¥æ¢æµ‹: æŠ›å‡ºå¼‚å¸¸
    }
```

### 5.1 Hystrixé…ç½®

<Tabs>
  <TabItem value="app" label="åº”ç”¨é…ç½®" default>
```java title="Hystrixé…ç½®"
@SpringBootApplication
@EnableCircuitBreaker
public class UserServiceApplication {
    public static void main(String[] args) {
        SpringApplication.run(UserServiceApplication.class, args);
    }
}
```
  </TabItem>
  <TabItem value="service" label="æœåŠ¡é…ç½®">
```java title="Hystrixä½¿ç”¨ç¤ºä¾‹"
@Service
public class UserService {
    
    @Autowired
    private RestTemplate restTemplate;
    
    @HystrixCommand(
        fallbackMethod = "getUserFallback",
        commandProperties = {
            @HystrixProperty(name = "execution.isolation.thread.timeoutInMilliseconds", value = "2000"),
            @HystrixProperty(name = "circuitBreaker.requestVolumeThreshold", value = "10"),
            @HystrixProperty(name = "circuitBreaker.errorThresholdPercentage", value = "50"),
            @HystrixProperty(name = "circuitBreaker.sleepWindowInMilliseconds", value = "5000")
        }
    )
    public User getUserById(Long id) {
        return restTemplate.getForObject(
            "http://user-service/users/" + id, 
            User.class
        );
    }
    
    public User getUserFallback(Long id, Throwable e) {
        // é™çº§é€»è¾‘
        User fallbackUser = new User();
        fallbackUser.setId(id);
        fallbackUser.setName("é»˜è®¤ç”¨æˆ·");
        fallbackUser.setEmail("default@example.com");
        return fallbackUser;
    }
}
```
  </TabItem>
  <TabItem value="props" label="å…³é”®å±æ€§">
  <div className="card">
  <div className="card__header">
  <h4>Hystrixå…³é”®å±æ€§</h4>
  </div>
  <div className="card__body">
  
  | å±æ€§ | è¯´æ˜ | é»˜è®¤å€¼ | æ¨èå€¼ |
  |------|------|--------|--------|
  | **execution.isolation.thread.timeoutInMilliseconds** | æ‰§è¡Œè¶…æ—¶æ—¶é—´ | 1000ms | æ ¹æ®æ¥å£è°ƒæ•´ |
  | **circuitBreaker.requestVolumeThreshold** | ç†”æ–­è§¦å‘æœ€å°è¯·æ±‚æ•° | 20 | ç”Ÿäº§ç¯å¢ƒè°ƒå¤§ |
  | **circuitBreaker.errorThresholdPercentage** | é”™è¯¯ç‡é˜ˆå€¼ | 50% | æ ¹æ®å®¹é”™ç‡è°ƒæ•´ |
  | **circuitBreaker.sleepWindowInMilliseconds** | ç†”æ–­æ¢å¤æ—¶é—´çª—å£ | 5000ms | æ ¹æ®æœåŠ¡æ¢å¤æ—¶é—´è°ƒæ•´ |
  
  </div>
  </div>
  </TabItem>
</Tabs>

### 5.2 Sentinelé…ç½®

Sentinelæ˜¯é˜¿é‡Œå·´å·´å¼€æºçš„æµé‡æ§åˆ¶ç»„ä»¶ï¼Œæä¾›äº†ç†”æ–­é™çº§ã€ç³»ç»Ÿè´Ÿè½½ä¿æŠ¤ã€å®æ—¶ç›‘æ§ç­‰åŠŸèƒ½ã€‚

```mermaid
graph LR
    A[è¯·æ±‚] --> B{Sentinel}
    B -->|é™æµ| C[æ‹’ç»å¤šä½™è¯·æ±‚]
    B -->|ç†”æ–­| D[æœåŠ¡é™çº§]
    B -->|ç³»ç»Ÿä¿æŠ¤| E[è´Ÿè½½ä¿æŠ¤]
    B -->|é€šè¿‡| F[æ­£å¸¸å¤„ç†]
    
    C --> G[è§¦å‘é™æµè§„åˆ™]
    D --> H[è§¦å‘é™çº§è§„åˆ™]
    E --> I[è§¦å‘ç³»ç»Ÿè§„åˆ™]
```

<div className="card">
<div className="card__body">

```java title="Sentinelé…ç½®"
@Configuration
public class SentinelConfig {
    
    @PostConstruct
    public void init() {
        // é…ç½®é™æµè§„åˆ™
        List<FlowRule> rules = new ArrayList<>();
        FlowRule rule = new FlowRule();
        rule.setResource("getUser");
        rule.setGrade(RuleConstant.FLOW_GRADE_QPS);
        rule.setCount(10);
        rules.add(rule);
        FlowRuleManager.loadRules(rules);
    }
}
```

</div>
</div>

<Tabs>
  <TabItem value="sentinel-service" label="æœåŠ¡ä½¿ç”¨" default>
```java title="Sentinelä½¿ç”¨ç¤ºä¾‹"
@Service
public class UserService {
    
    @SentinelResource(
        value = "getUser",
        blockHandler = "getUserBlockHandler",
        fallback = "getUserFallback"
    )
    public User getUserById(Long id) {
        return userRepository.findById(id).orElse(null);
    }
    
    public User getUserBlockHandler(Long id, BlockException ex) {
        // é™æµå¤„ç†
        return new User();
    }
    
    public User getUserFallback(Long id, Throwable e) {
        // é™çº§å¤„ç†
        return new User();
    }
}
```
  </TabItem>
  <TabItem value="sentinel-rules" label="è§„åˆ™é…ç½®">
  ```java title="Sentinelè§„åˆ™é…ç½®"
  // æµæ§è§„åˆ™
  private void initFlowRules() {
      List<FlowRule> rules = new ArrayList<>();
      FlowRule rule = new FlowRule();
      rule.setResource("getUser");
      rule.setGrade(RuleConstant.FLOW_GRADE_QPS);  // QPSæ¨¡å¼
      rule.setCount(20);  // æ¯ç§’å…è®¸20æ¬¡è°ƒç”¨
      
      // æµæ§æ•ˆæœ
      rule.setControlBehavior(RuleConstant.CONTROL_BEHAVIOR_WARM_UP); // é¢„çƒ­æ–¹å¼
      rule.setWarmUpPeriodSec(10); // é¢„çƒ­æ—¶é—´10ç§’
      
      rules.add(rule);
      FlowRuleManager.loadRules(rules);
  }
  
  // é™çº§è§„åˆ™
  private void initDegradeRules() {
      List<DegradeRule> rules = new ArrayList<>();
      DegradeRule rule = new DegradeRule();
      rule.setResource("getUser");
      rule.setGrade(RuleConstant.DEGRADE_GRADE_EXCEPTION_RATIO); // å¼‚å¸¸æ¯”ä¾‹
      rule.setCount(0.5); // å¼‚å¸¸æ¯”ä¾‹é˜ˆå€¼50%
      rule.setTimeWindow(10); // ç†”æ–­æ—¶é—´10ç§’
      
      rules.add(rule);
      DegradeRuleManager.loadRules(rules);
  }
  ```
  </TabItem>
</Tabs>

## 6. é…ç½®ç®¡ç†

Spring Cloud Configæä¾›äº†é›†ä¸­åŒ–çš„é…ç½®ç®¡ç†ï¼Œæ”¯æŒåŠ¨æ€åˆ·æ–°å’Œç‰ˆæœ¬ç®¡ç†ã€‚

```mermaid
sequenceDiagram
    participant Client as æœåŠ¡
    participant Server as Config Server
    participant Git as é…ç½®ä»“åº“
    
    Client->>Server: è¯·æ±‚é…ç½®
    Server->>Git: è·å–é…ç½®
    Git-->>Server: è¿”å›é…ç½®æ–‡ä»¶
    Server-->>Client: è¿”å›é…ç½®å†…å®¹
    
    note over Client,Server: é…ç½®å˜æ›´
    
    Server->>Git: ç›‘å¬å˜æ›´
    Git-->>Server: é…ç½®å˜æ›´é€šçŸ¥
    Server->>Client: åˆ·æ–°é…ç½®
    Client->>Client: æ›´æ–°é…ç½®
```

### 6.1 Config Server

<Tabs>
  <TabItem value="server-java" label="æœåŠ¡é…ç½®" default>
```java title="Config Serveré…ç½®"
@SpringBootApplication
@EnableConfigServer
public class ConfigServerApplication {
    public static void main(String[] args) {
        SpringApplication.run(ConfigServerApplication.class, args);
    }
}
```
  </TabItem>
  <TabItem value="server-yaml" label="YAMLé…ç½®">
```yaml title="Config Serveré…ç½®"
server:
  port: 8888

spring:
  application:
    name: config-server
  cloud:
    config:
      server:
        git:
          uri: https://github.com/example/config-repo
          default-label: main
          search-paths: config
          username: ${GIT_USERNAME}
          password: ${GIT_PASSWORD}
```
  </TabItem>
  <TabItem value="native" label="æœ¬åœ°é…ç½®">
  ```yaml title="æœ¬åœ°é…ç½®æ¨¡å¼"
  spring:
    cloud:
      config:
        server:
          native:
            search-locations: classpath:/config,file:./config
    profiles:
      active: native
  ```
  </TabItem>
</Tabs>

### 6.2 Config Client

<div className="card">
<div className="card__body">

```java title="Config Clienté…ç½®"
@SpringBootApplication
@EnableDiscoveryClient
@RefreshScope
public class UserServiceApplication {
    public static void main(String[] args) {
        SpringApplication.run(UserServiceApplication.class, args);
    }
}
```

</div>
</div>

<Tabs>
  <TabItem value="client-yaml" label="YAMLé…ç½®" default>
```yaml title="Config Clienté…ç½®"
spring:
  application:
    name: user-service
  cloud:
    config:
      uri: http://localhost:8888
      fail-fast: true
      retry:
        initial-interval: 1000
        max-interval: 2000
        max-attempts: 6
```
  </TabItem>
  <TabItem value="bootstrap" label="Bootstrapé…ç½®">
  ```yaml title="bootstrap.yml"
  spring:
    application:
      name: user-service
    cloud:
      config:
        uri: http://localhost:8888
        fail-fast: true
    profiles:
      active: dev
  ```
  </TabItem>
  <TabItem value="config-use" label="é…ç½®ä½¿ç”¨">
```java title="é…ç½®ä½¿ç”¨ç¤ºä¾‹"
@RestController
@RefreshScope
public class ConfigController {
    
    @Value("${app.feature.enabled:false}")
    private boolean featureEnabled;
    
    @Value("${app.max.users:100}")
    private int maxUsers;
    
    @GetMapping("/config")
    public Map<String, Object> getConfig() {
        Map<String, Object> config = new HashMap<>();
        config.put("featureEnabled", featureEnabled);
        config.put("maxUsers", maxUsers);
        return config;
    }
}
```
  </TabItem>
</Tabs>

### 6.3 åŠ¨æ€åˆ·æ–°é…ç½®

<Tabs>
  <TabItem value="manual" label="æ‰‹åŠ¨åˆ·æ–°" default>
  ```shell
  # å•ä¸ªæœåŠ¡æ‰‹åŠ¨åˆ·æ–°
  curl -X POST http://localhost:8080/actuator/refresh
  
  # æ·»åŠ actuatorä¾èµ–å’Œé…ç½®
  # pom.xml
  <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-actuator</artifactId>
  </dependency>
  
  # application.yml
  management:
    endpoints:
      web:
        exposure:
          include: refresh,health,info
  ```
  </TabItem>
  <TabItem value="bus" label="æ¶ˆæ¯æ€»çº¿è‡ªåŠ¨åˆ·æ–°">
  ```yaml
  # æ·»åŠ ä¾èµ–
  # pom.xml
  <dependency>
      <groupId>org.springframework.cloud</groupId>
      <artifactId>spring-cloud-starter-bus-amqp</artifactId>
  </dependency>
  
  # application.yml
  spring:
    rabbitmq:
      host: localhost
      port: 5672
      username: guest
      password: guest
    cloud:
      bus:
        enabled: true
        trace:
          enabled: true
          
  # åˆ·æ–°æ‰€æœ‰æœåŠ¡é…ç½®
  curl -X POST http://localhost:8888/actuator/busrefresh
  
  # åˆ·æ–°æŒ‡å®šæœåŠ¡é…ç½®
  curl -X POST http://localhost:8888/actuator/busrefresh/user-service:8080
  ```
  </TabItem>
</Tabs>

## 7. åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª

åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªç”¨äºè·Ÿè¸ªå’Œå¯è§†åŒ–å¾®æœåŠ¡è°ƒç”¨é“¾è·¯ï¼Œå¸®åŠ©å¼€å‘äººå‘˜ç†è§£ç³»ç»Ÿè¡Œä¸ºå’Œæ’æŸ¥é—®é¢˜ã€‚

```mermaid
graph TD
    A[å®¢æˆ·ç«¯] --> B["APIç½‘å…³\ntraceId=x1"]
    B --> C["ç”¨æˆ·æœåŠ¡\ntraceId=x1\nspanId=a1"]
    B --> D["è®¢å•æœåŠ¡\ntraceId=x1\nspanId=a2"]
    D --> E["åº“å­˜æœåŠ¡\ntraceId=x1\nspanId=a2-1"]
    D --> F["æ”¯ä»˜æœåŠ¡\ntraceId=x1\nspanId=a2-2"]
    
    G[Sleuth] -.-> B
    G -.-> C
    G -.-> D
    G -.-> E
    G -.-> F
    
    G --> H[Zipkin]
    
    H --> I["åˆ†å¸ƒå¼è¿½è¸ªUI\nå¯è§†åŒ–è°ƒç”¨é“¾"]
```

### 7.1 Sleuthé…ç½®

<Tabs>
  <TabItem value="dep" label="ä¾èµ–é…ç½®" default>
```xml title="Sleuthä¾èµ–"
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-sleuth</artifactId>
</dependency>
```
  </TabItem>
  <TabItem value="yaml" label="YAMLé…ç½®">
```yaml title="Sleuthé…ç½®"
spring:
  sleuth:
    sampler:
      probability: 1.0
    web:
      client:
        enabled: true
    messaging:
      enabled: true
```
  </TabItem>
  <TabItem value="example" label="ä½¿ç”¨ç¤ºä¾‹">
```java title="Sleuthä½¿ç”¨ç¤ºä¾‹"
@Service
public class UserService {
    
    private static final Logger logger = LoggerFactory.getLogger(UserService.class);
    
    @Autowired
    private RestTemplate restTemplate;
    
    public User getUserById(Long id) {
        logger.info("å¼€å§‹è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œç”¨æˆ·ID: {}", id);
        
        User user = restTemplate.getForObject(
            "http://user-service/users/" + id, 
            User.class
        );
        
        logger.info("è·å–ç”¨æˆ·ä¿¡æ¯æˆåŠŸï¼Œç”¨æˆ·: {}", user);
        return user;
    }
}
```
  </TabItem>
</Tabs>

### 7.2 Zipkiné…ç½®

<div className="card">
<div className="card__body">

```yaml title="Zipkiné…ç½®"
spring:
  application:
    name: zipkin-server
  sleuth:
    zipkin:
      base-url: http://localhost:9411
```

</div>
</div>

<Tabs>
  <TabItem value="zipkin-dep" label="Zipkinä¾èµ–" default>
  ```xml
  <!-- Zipkinä¾èµ– -->
  <dependency>
      <groupId>org.springframework.cloud</groupId>
      <artifactId>spring-cloud-starter-zipkin</artifactId>
  </dependency>
  ```
  </TabItem>
  <TabItem value="zipkin-server" label="ZipkinæœåŠ¡å™¨">
  ```java title="ZipkinæœåŠ¡å™¨å¯åŠ¨"
  // ç°ä»£ç‰ˆæœ¬æ¨èä½¿ç”¨Dockeræ–¹å¼å¯åŠ¨ZipkinæœåŠ¡å™¨
  // docker run -d -p 9411:9411 openzipkin/zipkin
  
  // æˆ–è€…ä½¿ç”¨Javaå‘½ä»¤
  // java -jar zipkin-server.jar
  
  // Spring Boot 2.0åä¸å†æ¨èè‡ªå»ºZipkinæœåŠ¡å™¨
  @SpringBootApplication
  @EnableZipkinServer // å·²å¼ƒç”¨
  public class ZipkinServerApplication {
      public static void main(String[] args) {
          SpringApplication.run(ZipkinServerApplication.class, args);
      }
  }
  ```
  </TabItem>
</Tabs>

## 8. é¢è¯•é¢˜ç²¾é€‰

### 8.1 åŸºç¡€æ¦‚å¿µé¢˜

<Tabs>
  <TabItem value="q1" label="å¾®æœåŠ¡æ¶æ„" default>
  <div className="card">
  <div className="card__header">
  <h4>Q: ä»€ä¹ˆæ˜¯å¾®æœåŠ¡æ¶æ„ï¼Ÿå®ƒçš„ä¼˜åŠ¿å’ŒæŒ‘æˆ˜æ˜¯ä»€ä¹ˆï¼Ÿ</h4>
  </div>
  <div className="card__body">
  <p><strong>A:</strong> å¾®æœåŠ¡æ¶æ„æ˜¯ä¸€ç§å°†åº”ç”¨ç¨‹åºæ‹†åˆ†ä¸ºå°å‹ã€ç‹¬ç«‹æœåŠ¡çš„æ¶æ„é£æ ¼ã€‚</p>
  <p>ä¼˜åŠ¿åŒ…æ‹¬ï¼š</p>
  <ul>
  <li><strong>æœåŠ¡æ‹†åˆ†</strong>ï¼šæŒ‰ä¸šåŠ¡åŠŸèƒ½æ‹†åˆ†ï¼ŒèŒè´£å•ä¸€</li>
  <li><strong>ç‹¬ç«‹éƒ¨ç½²</strong>ï¼šæ¯ä¸ªæœåŠ¡å¯ç‹¬ç«‹éƒ¨ç½²å’Œæ‰©å±•</li>
  <li><strong>æŠ€æœ¯å¼‚æ„</strong>ï¼šä¸åŒæœåŠ¡å¯ä½¿ç”¨ä¸åŒæŠ€æœ¯æ ˆ</li>
  <li><strong>æ•…éšœéš”ç¦»</strong>ï¼šå•ä¸ªæœåŠ¡æ•…éšœä¸å½±å“æ•´ä½“</li>
  </ul>
  
  <p>æŒ‘æˆ˜åŒ…æ‹¬ï¼š</p>
  <ul>
  <li><strong>åˆ†å¸ƒå¼å¤æ‚æ€§</strong>ï¼šç½‘ç»œé€šä¿¡ã€æ•°æ®ä¸€è‡´æ€§ç­‰</li>
  <li><strong>æœåŠ¡æ²»ç†</strong>ï¼šæœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡ã€ç†”æ–­é™çº§</li>
  <li><strong>æ•°æ®ç®¡ç†</strong>ï¼šåˆ†å¸ƒå¼äº‹åŠ¡ã€æ•°æ®ä¸€è‡´æ€§</li>
  <li><strong>è¿ç»´å¤æ‚åº¦</strong>ï¼šç›‘æ§ã€æ—¥å¿—ã€éƒ¨ç½²ç­‰</li>
  </ul>
  </div>
  </div>
  </TabItem>
  <TabItem value="q2" label="æ ¸å¿ƒç»„ä»¶">
  <div className="card">
  <div className="card__header">
  <h4>Q: Spring Cloudçš„æ ¸å¿ƒç»„ä»¶æœ‰å“ªäº›ï¼Ÿ</h4>
  </div>
  <div className="card__body">
  <p><strong>A:</strong> Spring Cloudçš„æ ¸å¿ƒç»„ä»¶åŒ…æ‹¬ï¼š</p>
  <ul>
  <li><strong>Eureka/Nacos/Consul</strong>ï¼šæœåŠ¡æ³¨å†Œä¸å‘ç°</li>
  <li><strong>Gateway/Zuul</strong>ï¼šAPIç½‘å…³</li>
  <li><strong>Ribbon/LoadBalancer</strong>ï¼šå®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡</li>
  <li><strong>Hystrix/Sentinel/Resilience4j</strong>ï¼šç†”æ–­é™çº§</li>
  <li><strong>Config</strong>ï¼šé…ç½®ç®¡ç†</li>
  <li><strong>Bus</strong>ï¼šæ¶ˆæ¯æ€»çº¿</li>
  <li><strong>Sleuth</strong>ï¼šåˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª</li>
  <li><strong>Zipkin</strong>ï¼šè°ƒç”¨é“¾å¯è§†åŒ–</li>
  </ul>
  </div>
  </div>
  </TabItem>
</Tabs>

### 8.2 å®è·µé¢˜

<Tabs>
  <TabItem value="q3" label="æœåŠ¡æ³¨å†Œå‘ç°" default>
  <div className="card">
  <div className="card__header">
  <h4>Q: å¦‚ä½•å®ç°æœåŠ¡æ³¨å†Œä¸å‘ç°ï¼Ÿ</h4>
  </div>
  <div className="card__body">
  <p><strong>A:</strong> å®ç°æœåŠ¡æ³¨å†Œä¸å‘ç°çš„æ­¥éª¤ï¼š</p>
  <ol>
  <li><strong>é…ç½®Eureka Server</strong>ï¼š</li>
  </ol>
  
  ```java
@SpringBootApplication
@EnableEurekaServer
public class EurekaServerApplication {
    public static void main(String[] args) {
        SpringApplication.run(EurekaServerApplication.class, args);
    }
}
  ```
  
  <ol start="2">
  <li><strong>é…ç½®Eureka Client</strong>ï¼š</li>
  </ol>
  
  ```java
@SpringBootApplication
@EnableEurekaClient
public class ServiceApplication {
    public static void main(String[] args) {
        SpringApplication.run(ServiceApplication.class, args);
    }
}
  ```
  
  <ol start="3">
  <li><strong>æœåŠ¡è°ƒç”¨</strong>ï¼šä½¿ç”¨@LoadBalancedæ³¨è§£çš„RestTemplateæˆ–Feignå®¢æˆ·ç«¯</li>
  <li><strong>è´Ÿè½½å‡è¡¡</strong>ï¼šé€šè¿‡Ribbonå®ç°ï¼Œå¯è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡ç­–ç•¥</li>
  </ol>
  </div>
  </div>
  </TabItem>
  <TabItem value="q4" label="APIç½‘å…³">
  <div className="card">
  <div className="card__header">
  <h4>Q: å¦‚ä½•å®ç°APIç½‘å…³ï¼Ÿ</h4>
  </div>
  <div className="card__body">
  <p><strong>A:</strong> å®ç°APIç½‘å…³çš„æ–¹æ³•ï¼š</p>
  <ol>
  <li><strong>é…ç½®Gateway</strong>ï¼š</li>
  </ol>
  
  ```yaml
spring:
  cloud:
    gateway:
      routes:
        - id: user-service
          uri: lb://user-service
          predicates:
            - Path=/api/users/**
          filters:
            - StripPrefix=1
  ```
  
  <ol start="2">
  <li><strong>è¿‡æ»¤å™¨é“¾</strong>ï¼šå®ç°GlobalFilteræ¥å£ï¼Œå¯å¤„ç†è®¤è¯ã€é™æµã€æ—¥å¿—ç­‰</li>
  <li><strong>æœåŠ¡å‘ç°</strong>ï¼šç»“åˆEurekaï¼Œå®ç°åŠ¨æ€è·¯ç”±</li>
  <li><strong>è´Ÿè½½å‡è¡¡</strong>ï¼šä½¿ç”¨lb://å‰ç¼€è¿›è¡Œè´Ÿè½½å‡è¡¡</li>
  </ol>
  </div>
  </div>
  </TabItem>
</Tabs>

### 8.3 é«˜çº§é¢˜

<Tabs>
  <TabItem value="q5" label="åˆ†å¸ƒå¼äº‹åŠ¡" default>
  <div className="card">
  <div className="card__header">
  <h4>Q: å¦‚ä½•å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ï¼Ÿ</h4>
  </div>
  <div className="card__body">
  <p><strong>A:</strong> å®ç°åˆ†å¸ƒå¼äº‹åŠ¡çš„æ–¹æ³•ï¼š</p>
  <ul>
  <li><strong>2PC/3PC</strong>ï¼šä¸¤é˜¶æ®µ/ä¸‰é˜¶æ®µæäº¤åè®®ï¼Œå¼ºä¸€è‡´æ€§ä½†æ€§èƒ½è¾ƒå·®</li>
  <li><strong>TCCæ¨¡å¼</strong>ï¼šTry-Confirm-Cancelæ¨¡å¼ï¼Œè¡¥å¿äº‹åŠ¡</li>
  </ul>
  
  ```java
// Tryé˜¶æ®µ
@Transactional
public void tryCreate(Order order) {
    orderMapper.insert(order);  // åˆ›å»ºè®¢å•
    accountService.tryDeduct(order.getUserId(), order.getAmount());  // å°è¯•æ‰£å‡ä½™é¢
}

// Confirmé˜¶æ®µ
@Transactional
public void confirmCreate(Order order) {
    order.setStatus("CONFIRMED");
    orderMapper.updateStatus(order);  // ç¡®è®¤è®¢å•
    accountService.confirmDeduct(order.getUserId(), order.getAmount());  // ç¡®è®¤æ‰£å‡
}

// Cancelé˜¶æ®µ
@Transactional
public void cancelCreate(Order order) {
    order.setStatus("CANCELED");
    orderMapper.updateStatus(order);  // å–æ¶ˆè®¢å•
    accountService.cancelDeduct(order.getUserId(), order.getAmount());  // å–æ¶ˆæ‰£å‡
}
  ```
  
  <ul start="3">
  <li><strong>Sagaæ¨¡å¼</strong>ï¼šé•¿äº‹åŠ¡çš„è¡¥å¿æ¨¡å¼ï¼Œæ¯æ­¥éƒ½æœ‰å¯¹åº”çš„è¡¥å¿æ“ä½œ</li>
  <li><strong>æ¶ˆæ¯äº‹åŠ¡</strong>ï¼šåŸºäºæ¶ˆæ¯çš„æœ€ç»ˆä¸€è‡´æ€§ï¼Œé€šè¿‡æ¶ˆæ¯è¡¨+å®šæ—¶ä»»åŠ¡å®ç°</li>
  <li><strong>Seata</strong>ï¼šé˜¿é‡Œå¼€æºçš„åˆ†å¸ƒå¼äº‹åŠ¡æ¡†æ¶ï¼Œæ”¯æŒATã€TCCã€Sagaå’ŒXAæ¨¡å¼</li>
  </ul>
  </div>
  </div>
  </TabItem>
  <TabItem value="q6" label="ç†”æ–­é™çº§">
  <div className="card">
  <div className="card__header">
  <h4>Q: å¦‚ä½•å®ç°æœåŠ¡ç†”æ–­é™çº§ï¼Ÿ</h4>
  </div>
  <div className="card__body">
  <p><strong>A:</strong> å®ç°æœåŠ¡ç†”æ–­é™çº§çš„æ–¹æ³•ï¼š</p>
  <ul>
  <li><strong>Hystrix</strong>ï¼š</li>
  </ul>
  
  ```java
@HystrixCommand(
    fallbackMethod = "fallbackMethod",
    commandProperties = {
        @HystrixProperty(name = "circuitBreaker.requestVolumeThreshold", value = "10"),
        @HystrixProperty(name = "circuitBreaker.errorThresholdPercentage", value = "50"),
        @HystrixProperty(name = "circuitBreaker.sleepWindowInMilliseconds", value = "5000")
    }
)
public String serviceMethod() {
    // ä¸šåŠ¡é€»è¾‘
}

public String fallbackMethod() {
    return "é™çº§å“åº”";
}
  ```
  
  <ul start="2">
  <li><strong>Sentinel</strong>ï¼š</li>
  </ul>
  
  ```java
@SentinelResource(
    value = "resourceName",
    blockHandler = "blockHandler",
    fallback = "fallbackMethod"
)
public String serviceMethod() {
    // ä¸šåŠ¡é€»è¾‘
}

public String blockHandler(BlockException ex) {
    return "é™æµå“åº”";
}

public String fallbackMethod(Throwable t) {
    return "é™çº§å“åº”";
}
  ```
  
  <ul start="3">
  <li><strong>Resilience4j</strong>ï¼šæ–°ä¸€ä»£ç†”æ–­å™¨ï¼Œå¯æ›¿ä»£Hystrix</li>
  </ul>
  </div>
  </div>
  </TabItem>
</Tabs>

:::tip Spring Cloudå­¦ä¹ è¦ç‚¹
1. **ç†è§£å¾®æœåŠ¡æ¶æ„**ï¼šæŒæ¡å¾®æœåŠ¡çš„è®¾è®¡åŸåˆ™å’Œæœ€ä½³å®è·µ
2. **ç†Ÿæ‚‰æ ¸å¿ƒç»„ä»¶**ï¼šäº†è§£Eurekaã€Gatewayã€Ribbonç­‰ç»„ä»¶
3. **æŒæ¡æœåŠ¡æ²»ç†**ï¼šå­¦ä¼šæœåŠ¡æ³¨å†Œå‘ç°ã€è´Ÿè½½å‡è¡¡ã€ç†”æ–­é™çº§
4. **å­¦ä¼šé…ç½®ç®¡ç†**ï¼šæŒæ¡åˆ†å¸ƒå¼é…ç½®å’Œé…ç½®ä¸­å¿ƒ
5. **äº†è§£ç›‘æ§è¿½è¸ª**ï¼šå­¦ä¼šåˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªå’Œç›‘æ§
:::

```mermaid
mindmap
  root((Spring Cloud))
    æœåŠ¡æ²»ç†
      æœåŠ¡æ³¨å†Œä¸å‘ç°
        Eureka
        Nacos
        Consul
      APIç½‘å…³
        Gateway
        Zuul
    è´Ÿè½½å‡è¡¡
      Ribbon
      LoadBalancer
      è´Ÿè½½å‡è¡¡ç­–ç•¥
    ç†”æ–­é™çº§
      Hystrix
      Sentinel
      Resilience4j
    é…ç½®ç®¡ç†
      Config
      åŠ¨æ€é…ç½®
      Bus
    é“¾è·¯è¿½è¸ª
      Sleuth
      Zipkin
      ELK
    å¾®æœåŠ¡æ¶æ„
      æœåŠ¡æ‹†åˆ†
      æœåŠ¡é€šä¿¡
      æœåŠ¡ç›‘æ§
```

---

é€šè¿‡æœ¬ç« çš„å­¦ä¹ ï¼Œä½ åº”è¯¥å·²ç»æŒæ¡äº†Spring Cloudçš„æ ¸å¿ƒæ¦‚å¿µã€ç»„ä»¶ä½¿ç”¨å’Œå¾®æœåŠ¡æ¶æ„è®¾è®¡ã€‚Spring Cloudæ˜¯æ„å»ºåˆ†å¸ƒå¼ç³»ç»Ÿçš„é‡è¦æ¡†æ¶ï¼ŒæŒæ¡Spring Cloudå¯¹äºæ„å»ºé«˜å¯ç”¨ã€å¯æ‰©å±•çš„å¾®æœåŠ¡åº”ç”¨è‡³å…³é‡è¦ã€‚ 