---
sidebar_position: 3
title: "Springäº‹åŠ¡ç®¡ç†è¯¦è§£"
description: "æ·±å…¥ç†è§£Springäº‹åŠ¡ç®¡ç†æœºåˆ¶ã€ä¼ æ’­è¡Œä¸ºä¸æœ€ä½³å®è·µ"
authors: [Laby]
last_update:
  date: 2025-08-07
  author: Laby
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import TOCInline from '@theme/TOCInline';

# Spring äº‹åŠ¡ç®¡ç†è¯¦è§£

Springäº‹åŠ¡ç®¡ç†æ˜¯Springæ¡†æ¶çš„é‡è¦ç‰¹æ€§ï¼Œå®ƒæä¾›äº†å£°æ˜å¼å’Œç¼–ç¨‹å¼ä¸¤ç§äº‹åŠ¡ç®¡ç†æ–¹å¼ï¼Œç®€åŒ–äº†æ•°æ®åº“äº‹åŠ¡çš„å¤„ç†ï¼Œç¡®ä¿æ•°æ®çš„ä¸€è‡´æ€§å’Œå®Œæ•´æ€§ã€‚

:::info æœ¬æ–‡å†…å®¹æ¦‚è§ˆ
<TOCInline toc={toc} />
:::

:::tip æ ¸å¿ƒä»·å€¼
**Springäº‹åŠ¡ = å£°æ˜å¼äº‹åŠ¡ + ç¼–ç¨‹å¼äº‹åŠ¡ + ä¼ æ’­è¡Œä¸º + éš”ç¦»çº§åˆ« + å›æ»šæœºåˆ¶**
- ğŸ“Œ **å£°æ˜å¼äº‹åŠ¡**ï¼šé€šè¿‡æ³¨è§£è½»æ¾ç®¡ç†äº‹åŠ¡ï¼Œæ— éœ€ç¼–å†™æ¨¡æ¿ä»£ç 
- ğŸ”„ **ç¼–ç¨‹å¼äº‹åŠ¡**ï¼šçµæ´»æ§åˆ¶äº‹åŠ¡è¾¹ç•Œï¼Œæ»¡è¶³å¤æ‚åœºæ™¯éœ€æ±‚
- ğŸ”€ **ä¼ æ’­è¡Œä¸º**ï¼šå®šä¹‰äº‹åŠ¡æ–¹æ³•é—´çš„åä½œæ–¹å¼ï¼Œä¼˜åŒ–äº‹åŠ¡è¾¹ç•Œ
- ğŸ›¡ï¸ **éš”ç¦»çº§åˆ«**ï¼šè§£å†³å¹¶å‘äº‹åŠ¡é—®é¢˜ï¼Œä¿éšœæ•°æ®ä¸€è‡´æ€§
- âª **å›æ»šæœºåˆ¶**ï¼šç²¾ç¡®æ§åˆ¶å¼‚å¸¸å›æ»šç­–ç•¥ï¼Œæå‡ç³»ç»Ÿå¥å£®æ€§
:::

## 1. äº‹åŠ¡åŸºç¡€æ¦‚å¿µ

### 1.1 ä»€ä¹ˆæ˜¯äº‹åŠ¡ï¼Ÿ

äº‹åŠ¡æ˜¯æ•°æ®åº“æ“ä½œçš„ä¸€ä¸ªé€»è¾‘å•å…ƒï¼Œå®ƒè¦ä¹ˆå…¨éƒ¨æˆåŠŸæ‰§è¡Œï¼Œè¦ä¹ˆå…¨éƒ¨å›æ»šã€‚äº‹åŠ¡ç¡®ä¿æ•°æ®çš„ä¸€è‡´æ€§å’Œå®Œæ•´æ€§ã€‚

```mermaid
graph TD
    A[äº‹åŠ¡] --> B[åŸå­æ€§]
    A --> C[ä¸€è‡´æ€§]
    A --> D[éš”ç¦»æ€§]
    A --> E[æŒä¹…æ€§]
    
    B --> B1["ä¸€ä¸ªä¸å¯åˆ†å‰²çš„å·¥ä½œå•ä½"]
    C --> C1["äº‹åŠ¡å‰åæ•°æ®ä¿æŒä¸€è‡´çŠ¶æ€"]
    D --> D1["äº‹åŠ¡æ‰§è¡Œç›¸äº’éš”ç¦»"]
    E --> E1["äº‹åŠ¡ä¸€æ—¦æäº¤ï¼Œæ°¸ä¹…ä¿å­˜"]
    
    F[è½¬è´¦ç¤ºä¾‹] --> F1["1. è´¦æˆ·Aæ‰£æ¬¾"]
    F1 --> F2["2. è´¦æˆ·BåŠ æ¬¾"]
    F -->|"åŸå­æ€§"| F3["è¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å›æ»š"]
    F -->|"ä¸€è‡´æ€§"| F4["æ€»é‡‘é¢åœ¨è½¬è´¦å‰åä¿æŒä¸å˜"]
    F -->|"éš”ç¦»æ€§"| F5["å¹¶å‘è½¬è´¦äº’ä¸å½±å“"]
    F -->|"æŒä¹…æ€§"| F6["è½¬è´¦æˆåŠŸåç»“æœæ°¸ä¹…ä¿å­˜"]
```

#### ACIDç‰¹æ€§

<div className="card">
<div className="card__body">

| ç‰¹æ€§ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| **åŸå­æ€§ï¼ˆAtomicityï¼‰** | äº‹åŠ¡æ˜¯ä¸å¯åˆ†å‰²çš„å·¥ä½œå•ä½ | è½¬è´¦æ“ä½œè¦ä¹ˆæˆåŠŸè¦ä¹ˆå¤±è´¥ |
| **ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰** | äº‹åŠ¡æ‰§è¡Œå‰åæ•°æ®çŠ¶æ€ä¸€è‡´ | è½¬è´¦å‰åæ€»é‡‘é¢ä¸å˜ |
| **éš”ç¦»æ€§ï¼ˆIsolationï¼‰** | å¹¶å‘äº‹åŠ¡ä¹‹é—´ç›¸äº’éš”ç¦» | äº‹åŠ¡Açœ‹ä¸åˆ°äº‹åŠ¡Bçš„æœªæäº¤æ•°æ® |
| **æŒä¹…æ€§ï¼ˆDurabilityï¼‰** | äº‹åŠ¡æäº¤åæ•°æ®æ°¸ä¹…ä¿å­˜ | æäº¤åæ•°æ®ä¸ä¼šä¸¢å¤± |

</div>
</div>

### 1.2 Springäº‹åŠ¡ç®¡ç†æ–¹å¼

Springæä¾›äº†ä¸¤ç§äº‹åŠ¡ç®¡ç†æ–¹å¼ï¼šå£°æ˜å¼äº‹åŠ¡å’Œç¼–ç¨‹å¼äº‹åŠ¡ã€‚

<Tabs>
  <TabItem value="declarative" label="å£°æ˜å¼äº‹åŠ¡" default>
  ```java title="å£°æ˜å¼äº‹åŠ¡"
  @Service
  @Transactional
  public class UserService {
      
      @Autowired
      private UserRepository userRepository;
      
      @Autowired
      private AccountRepository accountRepository;
      
      @Transactional
      public void transferMoney(Long fromUserId, Long toUserId, BigDecimal amount) {
          // æ‰£æ¬¾
          Account fromAccount = accountRepository.findByUserId(fromUserId);
          fromAccount.setBalance(fromAccount.getBalance().subtract(amount));
          accountRepository.save(fromAccount);
          
          // åŠ æ¬¾
          Account toAccount = accountRepository.findByUserId(toUserId);
          toAccount.setBalance(toAccount.getBalance().add(amount));
          accountRepository.save(toAccount);
      }
  }
  ```
  </TabItem>
  <TabItem value="programmatic" label="ç¼–ç¨‹å¼äº‹åŠ¡">
  ```java title="ç¼–ç¨‹å¼äº‹åŠ¡"
  @Service
  public class UserService {
      
      @Autowired
      private TransactionTemplate transactionTemplate;
      
      @Autowired
      private UserRepository userRepository;
      
      public void createUser(User user) {
          transactionTemplate.execute(new TransactionCallbackWithoutResult() {
              @Override
              protected void doInTransactionWithoutResult(TransactionStatus status) {
                  try {
                      userRepository.save(user);
                      // å…¶ä»–ä¸šåŠ¡é€»è¾‘
                  } catch (Exception e) {
                      status.setRollbackOnly();
                      throw e;
                  }
              }
          });
      }
  }
  ```
  </TabItem>
  <TabItem value="comparison" label="å¯¹æ¯”åˆ†æ">
  <div className="card">
  <div className="card__header">
  <h4>å£°æ˜å¼äº‹åŠ¡ vs ç¼–ç¨‹å¼äº‹åŠ¡</h4>
  </div>
  <div className="card__body">
  
  | ç‰¹æ€§ | å£°æ˜å¼äº‹åŠ¡ | ç¼–ç¨‹å¼äº‹åŠ¡ |
  |------|-----------|-----------|
  | **ä½¿ç”¨æ–¹å¼** | æ³¨è§£é…ç½® | ä»£ç æ§åˆ¶ |
  | **ä»£ç ä¾µå…¥æ€§** | ä½ | é«˜ |
  | **çµæ´»æ€§** | è¾ƒä½ | å¾ˆé«˜ |
  | **é€‚ç”¨åœºæ™¯** | å¤§å¤šæ•°ä¸šåŠ¡åœºæ™¯ | å¤æ‚äº‹åŠ¡æ§åˆ¶ |
  | **å­¦ä¹ æ›²çº¿** | å¹³ç¼“ | è¾ƒé™¡ |
  | **ç»´æŠ¤æˆæœ¬** | ä½ | é«˜ |

  </div>
  </div>
  </TabItem>
</Tabs>

## 2. äº‹åŠ¡ä¼ æ’­è¡Œä¸º

### 2.1 ä¼ æ’­è¡Œä¸ºç±»å‹

Springå®šä¹‰äº†7ç§äº‹åŠ¡ä¼ æ’­è¡Œä¸ºï¼Œç”¨äºæ§åˆ¶äº‹åŠ¡æ–¹æ³•ä¹‹é—´çš„è°ƒç”¨å…³ç³»ï¼š

```mermaid
flowchart LR
    A[ä¼ æ’­è¡Œä¸º] --> B[REQUIRED]
    A --> C[SUPPORTS]
    A --> D[MANDATORY]
    A --> E[REQUIRES_NEW]
    A --> F[NOT_SUPPORTED]
    A --> G[NEVER]
    A --> H[NESTED]
    
    B -->|"é»˜è®¤è¡Œä¸º"| B1["åŠ å…¥ç°æœ‰äº‹åŠ¡ï¼Œå¦åˆ™åˆ›å»ºæ–°äº‹åŠ¡"]
    C --> C1["æœ‰äº‹åŠ¡åˆ™åŠ å…¥ï¼Œæ— äº‹åŠ¡åˆ™ä¸å¼€å¯"]
    D --> D1["å¿…é¡»åœ¨äº‹åŠ¡ä¸­è¿è¡Œï¼Œå¦åˆ™å¼‚å¸¸"]
    E --> E1["åˆ›å»ºæ–°äº‹åŠ¡ï¼ŒæŒ‚èµ·å½“å‰äº‹åŠ¡"]
    F --> F1["ä¸æ”¯æŒäº‹åŠ¡ï¼ŒæŒ‚èµ·å½“å‰äº‹åŠ¡"]
    G --> G1["ä¸èƒ½åœ¨äº‹åŠ¡ä¸­è¿è¡Œï¼Œå¦åˆ™å¼‚å¸¸"]
    H --> H2["åµŒå¥—äº‹åŠ¡ï¼Œå¯ç‹¬ç«‹å›æ»š"]
```

<div className="card">
<div className="card__body">

| ä¼ æ’­è¡Œä¸º | è¯´æ˜ | ä½¿ç”¨åœºæ™¯ |
|---------|------|---------|
| **REQUIRED** | å¦‚æœå­˜åœ¨äº‹åŠ¡åˆ™åŠ å…¥ï¼Œå¦åˆ™åˆ›å»ºæ–°äº‹åŠ¡ | å¤§å¤šæ•°ä¸šåŠ¡æ–¹æ³• |
| **SUPPORTS** | å¦‚æœå­˜åœ¨äº‹åŠ¡åˆ™åŠ å…¥ï¼Œå¦åˆ™ä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œ | æŸ¥è¯¢æ–¹æ³• |
| **MANDATORY** | å¿…é¡»åœ¨å·²å­˜åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸ | ä¸šåŠ¡æ–¹æ³•å¿…é¡»åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œ |
| **REQUIRES_NEW** | åˆ›å»ºæ–°äº‹åŠ¡ï¼ŒæŒ‚èµ·å½“å‰äº‹åŠ¡ | æ—¥å¿—è®°å½•ã€ç‹¬ç«‹ç»Ÿè®¡ |
| **NOT_SUPPORTED** | ä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œï¼ŒæŒ‚èµ·å½“å‰äº‹åŠ¡ | è€—æ—¶æŸ¥è¯¢ |
| **NEVER** | ä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œï¼Œå¦‚æœå­˜åœ¨äº‹åŠ¡åˆ™æŠ›å‡ºå¼‚å¸¸ | ç¡®ä¿æ–¹æ³•åœ¨éäº‹åŠ¡ç¯å¢ƒæ‰§è¡Œ |
| **NESTED** | åµŒå¥—äº‹åŠ¡ï¼Œå¯ç‹¬ç«‹å›æ»š | æ‰¹é‡æ“ä½œä¸­çš„å•æ¡ä¿å­˜ |

</div>
</div>

```java title="äº‹åŠ¡ä¼ æ’­è¡Œä¸ºç¤ºä¾‹"
@Service
public class UserService {
    
    @Autowired
    private OrderService orderService;
    
    @Transactional
    public void createUserWithOrders(User user) {
        userRepository.save(user);
        
        // REQUIRED: å’Œå½“å‰äº‹åŠ¡åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­
        orderService.createOrder(user);
        
        // REQUIRES_NEW: ç‹¬ç«‹çš„æ–°äº‹åŠ¡
        orderService.createUserLog(user);
    }
}

@Service
public class OrderService {
    
    @Autowired
    private OrderRepository orderRepository;
    
    @Autowired
    private LogService logService;
    
    @Transactional(propagation = Propagation.REQUIRED)
    public void createOrder(User user) {
        Order order = new Order();
        order.setUserId(user.getId());
        orderRepository.save(order);
    }
    
    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void createUserLog(User user) {
        UserLog log = new UserLog();
        log.setUserId(user.getId());
        log.setOperation("CREATE_USER");
        logService.save(log);
    }
}
```

## 3. äº‹åŠ¡éš”ç¦»çº§åˆ«

### 3.1 éš”ç¦»çº§åˆ«ç±»å‹

```java title="äº‹åŠ¡éš”ç¦»çº§åˆ«ç¤ºä¾‹"
@Service
public class UserService {
    
    // 1. READ_UNCOMMITTED - è¯»æœªæäº¤
    @Transactional(isolation = Isolation.READ_UNCOMMITTED)
    public User getUserWithDirtyRead(Long id) {
        return userRepository.findById(id).orElse(null);
    }
    
    // 2. READ_COMMITTED - è¯»å·²æäº¤ï¼ˆé»˜è®¤ï¼‰
    @Transactional(isolation = Isolation.READ_COMMITTED)
    public User getUserWithReadCommitted(Long id) {
        return userRepository.findById(id).orElse(null);
    }
    
    // 3. REPEATABLE_READ - å¯é‡å¤è¯»
    @Transactional(isolation = Isolation.REPEATABLE_READ)
    public User getUserWithRepeatableRead(Long id) {
        return userRepository.findById(id).orElse(null);
    }
    
    // 4. SERIALIZABLE - ä¸²è¡ŒåŒ–
    @Transactional(isolation = Isolation.SERIALIZABLE)
    public User getUserWithSerializable(Long id) {
        return userRepository.findById(id).orElse(null);
    }
}
```

### 3.2 éš”ç¦»çº§åˆ«è¯¦è§£

| éš”ç¦»çº§åˆ« | è¯´æ˜ | é—®é¢˜ | æ€§èƒ½ |
|----------|------|------|------|
| **READ_UNCOMMITTED** | è¯»æœªæäº¤ | è„è¯»ã€ä¸å¯é‡å¤è¯»ã€å¹»è¯» | æœ€é«˜ |
| **READ_COMMITTED** | è¯»å·²æäº¤ | ä¸å¯é‡å¤è¯»ã€å¹»è¯» | é«˜ |
| **REPEATABLE_READ** | å¯é‡å¤è¯» | å¹»è¯» | ä¸­ç­‰ |
| **SERIALIZABLE** | ä¸²è¡ŒåŒ– | æ—  | æœ€ä½ |

#### å¹¶å‘é—®é¢˜ç¤ºä¾‹

```java title="å¹¶å‘é—®é¢˜ç¤ºä¾‹"
// 1. è„è¯»é—®é¢˜
@Service
public class DirtyReadExample {
    
    @Transactional(isolation = Isolation.READ_UNCOMMITTED)
    public void updateUserBalance(Long userId, BigDecimal amount) {
        // äº‹åŠ¡Aï¼šæ›´æ–°ä½™é¢ä½†æœªæäº¤
        Account account = accountRepository.findByUserId(userId);
        account.setBalance(account.getBalance().add(amount));
        accountRepository.save(account);
        // æ­¤æ—¶äº‹åŠ¡Bå¯ä»¥è¯»åˆ°æœªæäº¤çš„æ•°æ®
    }
    
    @Transactional(isolation = Isolation.READ_UNCOMMITTED)
    public BigDecimal getUserBalance(Long userId) {
        // äº‹åŠ¡Bï¼šå¯èƒ½è¯»åˆ°äº‹åŠ¡Aæœªæäº¤çš„æ•°æ®
        Account account = accountRepository.findByUserId(userId);
        return account.getBalance();
    }
}

// 2. ä¸å¯é‡å¤è¯»é—®é¢˜
@Service
public class NonRepeatableReadExample {
    
    @Transactional(isolation = Isolation.READ_COMMITTED)
    public void updateUser(Long userId, String name) {
        // äº‹åŠ¡Aï¼šæ›´æ–°ç”¨æˆ·å
        User user = userRepository.findById(userId).orElse(null);
        user.setName(name);
        userRepository.save(user);
    }
    
    @Transactional(isolation = Isolation.READ_COMMITTED)
    public void readUserTwice(Long userId) {
        // äº‹åŠ¡Bï¼šä¸¤æ¬¡è¯»å–å¯èƒ½å¾—åˆ°ä¸åŒç»“æœ
        User user1 = userRepository.findById(userId).orElse(null);
        // äº‹åŠ¡Aæäº¤
        User user2 = userRepository.findById(userId).orElse(null);
        // user1.getName() != user2.getName()
    }
}
```

## 4. äº‹åŠ¡å›æ»šæœºåˆ¶

### 4.1 è‡ªåŠ¨å›æ»š

```java title="è‡ªåŠ¨å›æ»šç¤ºä¾‹"
@Service
public class UserService {
    
    @Transactional
    public void createUser(User user) {
        try {
            userRepository.save(user);
            // å¦‚æœè¿™é‡ŒæŠ›å‡ºå¼‚å¸¸ï¼Œäº‹åŠ¡ä¼šè‡ªåŠ¨å›æ»š
            if (user.getAge() < 0) {
                throw new IllegalArgumentException("å¹´é¾„ä¸èƒ½ä¸ºè´Ÿæ•°");
            }
        } catch (Exception e) {
            // å¼‚å¸¸ä¼šè¢«é‡æ–°æŠ›å‡ºï¼Œè§¦å‘äº‹åŠ¡å›æ»š
            throw e;
        }
    }
    
    // æŒ‡å®šå›æ»šå¼‚å¸¸
    @Transactional(rollbackFor = {IllegalArgumentException.class, SQLException.class})
    public void createUserWithCustomRollback(User user) {
        userRepository.save(user);
        if (user.getAge() < 0) {
            throw new IllegalArgumentException("å¹´é¾„ä¸èƒ½ä¸ºè´Ÿæ•°");
        }
    }
    
    // æŒ‡å®šä¸å›æ»šå¼‚å¸¸
    @Transactional(noRollbackFor = {BusinessException.class})
    public void createUserWithNoRollback(User user) {
        userRepository.save(user);
        if (user.getName().isEmpty()) {
            throw new BusinessException("ç”¨æˆ·åä¸èƒ½ä¸ºç©º");
        }
    }
}
```

### 4.2 æ‰‹åŠ¨å›æ»š

<div className="card">
<div className="card__body">

```java title="æ‰‹åŠ¨å›æ»šç¤ºä¾‹"
@Service
public class UserService {
    
    @Autowired
    private TransactionTemplate transactionTemplate;
    
    public void createUserWithManualRollback(User user) {
        transactionTemplate.execute(new TransactionCallbackWithoutResult() {
            @Override
            protected void doInTransactionWithoutResult(TransactionStatus status) {
                try {
                    userRepository.save(user);
                    
                    // ä¸šåŠ¡é€»è¾‘æ£€æŸ¥
                    if (user.getAge() < 0) {
                        // æ‰‹åŠ¨è®¾ç½®å›æ»š
                        status.setRollbackOnly();
                        return;
                    }
                    
                    // å…¶ä»–ä¸šåŠ¡é€»è¾‘
                } catch (Exception e) {
                    // å¼‚å¸¸æ—¶è‡ªåŠ¨å›æ»š
                    status.setRollbackOnly();
                    throw e;
                }
            }
        });
    }
}
```

</div>
</div>

<details>
<summary>å¼‚å¸¸å›æ»šè§„åˆ™æ€»ç»“</summary>

1. é»˜è®¤æƒ…å†µä¸‹ï¼ŒSpringåªå¯¹è¿è¡Œæ—¶å¼‚å¸¸ï¼ˆRuntimeExceptionåŠå…¶å­ç±»ï¼‰å’ŒErrorè¿›è¡Œå›æ»š
2. å—æ£€å¼‚å¸¸ï¼ˆchecked exceptionï¼‰ä¸ä¼šè§¦å‘å›æ»š
3. å¯ä»¥é€šè¿‡`rollbackFor`æŒ‡å®šéœ€è¦å›æ»šçš„å¼‚å¸¸ç±»å‹
4. å¯ä»¥é€šè¿‡`noRollbackFor`æŒ‡å®šä¸éœ€è¦å›æ»šçš„å¼‚å¸¸ç±»å‹
5. ç¼–ç¨‹å¼äº‹åŠ¡ä¸­å¯ä»¥é€šè¿‡`status.setRollbackOnly()`æ‰‹åŠ¨æ ‡è®°äº‹åŠ¡å›æ»š

</details>

```mermaid
flowchart TD
    A[å¼‚å¸¸å‘ç”Ÿ] --> B{æ˜¯å¦ä¸ºRuntimeException<br>æˆ–Error?}
    B -->|æ˜¯| C[é»˜è®¤å›æ»š]
    B -->|å¦| D[é»˜è®¤ä¸å›æ»š]
    
    D --> E{æ˜¯å¦é…ç½®rollbackFor<br>åŒ…å«è¯¥å¼‚å¸¸?}
    E -->|æ˜¯| F[è§¦å‘å›æ»š]
    E -->|å¦| G[ä¸è§¦å‘å›æ»š]
    
    C --> H{æ˜¯å¦é…ç½®noRollbackFor<br>åŒ…å«è¯¥å¼‚å¸¸?}
    H -->|æ˜¯| I[ä¸è§¦å‘å›æ»š]
    H -->|å¦| J[è§¦å‘å›æ»š]
```

## 5. äº‹åŠ¡å¤±æ•ˆåœºæ™¯

### 5.1 å¸¸è§å¤±æ•ˆåœºæ™¯

<Tabs>
  <TabItem value="case1" label="épublicæ–¹æ³•" default>
  ```java
  @Service
  public class TransactionFailureExample {
      // 1. épublicæ–¹æ³•
      @Transactional
      private void privateMethod() {
          // äº‹åŠ¡ä¸ä¼šç”Ÿæ•ˆ
          userRepository.save(new User());
      }
  }
  ```
  <div className="card">
  <div className="card__body">
  <p><strong>åŸå› ï¼š</strong> Spring AOPä»£ç†åªæ‹¦æˆªpublicæ–¹æ³•è°ƒç”¨ï¼Œépublicæ–¹æ³•ä¸ä¼šåˆ›å»ºä»£ç†</p>
  <p><strong>è§£å†³æ–¹æ³•ï¼š</strong> ç¡®ä¿äº‹åŠ¡æ–¹æ³•æ˜¯publicçš„</p>
  </div>
  </div>
  </TabItem>

  <TabItem value="case2" label="è‡ªè°ƒç”¨é—®é¢˜">
  ```java
  @Service
  public class TransactionFailureExample {
      // 2. è‡ªè°ƒç”¨é—®é¢˜
      @Transactional
      public void methodA() {
          // äº‹åŠ¡ç”Ÿæ•ˆ
          userRepository.save(new User());
          
          // è‡ªè°ƒç”¨ï¼Œäº‹åŠ¡ä¸ä¼šç”Ÿæ•ˆ
          this.methodB();
      }
      
      @Transactional
      public void methodB() {
          // è¿™ä¸ªæ–¹æ³•çš„äº‹åŠ¡ä¸ä¼šç”Ÿæ•ˆ
          userRepository.save(new User());
      }
  }
  ```
  <div className="card">
  <div className="card__body">
  <p><strong>åŸå› ï¼š</strong> Spring AOPä»£ç†åŸºäºä»£ç†æ¨¡å¼ï¼Œåªæœ‰é€šè¿‡ä»£ç†å¯¹è±¡è°ƒç”¨æ–¹æ³•æ—¶æ‰ä¼šåˆ›å»ºäº‹åŠ¡</p>
  <p><strong>è§£å†³æ–¹æ³•ï¼š</strong> é€šè¿‡ä»£ç†å¯¹è±¡è°ƒç”¨æ–¹æ³•ï¼ˆä½¿ç”¨AopContextæˆ–æ³¨å…¥è‡ªèº«ï¼‰</p>
  </div>
  </div>
  </TabItem>

  <TabItem value="case3" label="å¼‚å¸¸è¢«æ•è·">
  ```java
  @Transactional
  public void methodWithCaughtException() {
      try {
          userRepository.save(new User());
          throw new RuntimeException("æµ‹è¯•å¼‚å¸¸");
      } catch (Exception e) {
          // å¼‚å¸¸è¢«æ•è·ï¼Œäº‹åŠ¡ä¸ä¼šå›æ»š
          log.error("å¼‚å¸¸è¢«æ•è·", e);
      }
  }
  ```
  <div className="card">
  <div className="card__body">
  <p><strong>åŸå› ï¼š</strong> Springäº‹åŠ¡åœ¨æ–¹æ³•è¿”å›æ—¶æ£€æŸ¥æ˜¯å¦æœ‰æœªå¤„ç†çš„å¼‚å¸¸ï¼Œå¦‚æœå¼‚å¸¸è¢«æ•è·ï¼Œäº‹åŠ¡ä¸ä¼šå›æ»š</p>
  <p><strong>è§£å†³æ–¹æ³•ï¼š</strong> æ•è·å¼‚å¸¸åé‡æ–°æŠ›å‡ºæˆ–è®¾ç½®äº‹åŠ¡çŠ¶æ€ä¸ºå›æ»š</p>
  </div>
  </div>
  </TabItem>

  <TabItem value="case4" label="å¼‚å¸¸ç±»å‹ä¸åŒ¹é…">
  ```java
  @Transactional(rollbackFor = SQLException.class)
  public void methodWithWrongException() {
      userRepository.save(new User());
      throw new RuntimeException("è¿è¡Œæ—¶å¼‚å¸¸"); // æ­¤å¤„æŠ›å‡ºçš„æ˜¯RuntimeException
  }
  ```
  <div className="card">
  <div className="card__body">
  <p><strong>åŸå› ï¼š</strong> æŒ‡å®šäº†ç‰¹å®šç±»å‹çš„å¼‚å¸¸æ‰ä¼šå›æ»šï¼Œä½†æŠ›å‡ºäº†ä¸åŒç±»å‹çš„å¼‚å¸¸</p>
  <p><strong>è§£å†³æ–¹æ³•ï¼š</strong> ç¡®ä¿rollbackForåŒ…å«å¯èƒ½æŠ›å‡ºçš„å¼‚å¸¸ç±»å‹</p>
  </div>
  </div>
  </TabItem>
</Tabs>

### 5.2 è§£å†³æ–¹æ¡ˆ

```mermaid
flowchart TD
    A[äº‹åŠ¡å¤±æ•ˆ] --> B[épublicæ–¹æ³•]
    A --> C[è‡ªè°ƒç”¨é—®é¢˜]
    A --> D[å¼‚å¸¸è¢«æ•è·]
    A --> E[å¼‚å¸¸ç±»å‹ä¸åŒ¹é…]
    A --> F[å…¶ä»–å¤±æ•ˆåœºæ™¯]
    
    B --> B1["å°†æ–¹æ³•æ”¹ä¸ºpublic"]
    
    C --> C1["ä½¿ç”¨AopContext.currentProxy()"]
    C --> C2["@Autowiredæ³¨å…¥è‡ªèº«"]
    
    D --> D1["é‡æ–°æŠ›å‡ºå¼‚å¸¸"]
    D --> D2["æ‰‹åŠ¨è®¾ç½®å›æ»šçŠ¶æ€"]
    
    E --> E1["ä½¿ç”¨æ­£ç¡®çš„å¼‚å¸¸ç±»å‹"]
    E --> E2["é…ç½®åˆé€‚çš„rollbackFor"]
    
    F --> F1["ç¡®ä¿ç±»è¢«Springç®¡ç†"]
    F --> F2["æ£€æŸ¥äº‹åŠ¡ç®¡ç†å™¨é…ç½®"]
```

<div className="card">
<div className="card__body">

```java title="äº‹åŠ¡å¤±æ•ˆè§£å†³æ–¹æ¡ˆ"
@Service
public class TransactionSolutionExample {
    
    @Autowired
    private ApplicationContext applicationContext;
    
    // 1. è§£å†³è‡ªè°ƒç”¨é—®é¢˜ - ä½¿ç”¨AopContext
    @Transactional
    public void methodA() {
        userRepository.save(new User());
        
        // è·å–ä»£ç†å¯¹è±¡
        UserService proxy = (UserService) AopContext.currentProxy();
        proxy.methodB(); // äº‹åŠ¡ç”Ÿæ•ˆ
    }
    
    // 2. è§£å†³è‡ªè°ƒç”¨é—®é¢˜ - æ³¨å…¥è‡ªèº«
    @Autowired
    private UserService self;
    
    @Transactional
    public void methodAWithSelf() {
        userRepository.save(new User());
        self.methodB(); // äº‹åŠ¡ç”Ÿæ•ˆ
    }
    
    // 3. è§£å†³å¼‚å¸¸æ•è·é—®é¢˜
    @Transactional
    public void methodWithProperException() {
        try {
            userRepository.save(new User());
            throw new RuntimeException("æµ‹è¯•å¼‚å¸¸");
        } catch (Exception e) {
            log.error("å¼‚å¸¸è¢«æ•è·", e);
            // é‡æ–°æŠ›å‡ºå¼‚å¸¸ï¼Œè§¦å‘å›æ»š
            throw new RuntimeException("é‡æ–°æŠ›å‡ºå¼‚å¸¸", e);
        }
    }
}
```

</div>
</div>

:::caution æ³¨æ„äº‹é¡¹
ä½¿ç”¨AopContextéœ€è¦åœ¨é…ç½®ç±»ä¸Šæ·»åŠ `@EnableAspectJAutoProxy(exposeProxy = true)`æ³¨è§£
:::

## 6. äº‹åŠ¡æœ€ä½³å®è·µ

### 6.1 äº‹åŠ¡è®¾è®¡åŸåˆ™

<div className="card">
<div className="card__header">
<h4>äº‹åŠ¡è®¾è®¡çš„äº”é¡¹åŸåˆ™</h4>
</div>
<div className="card__body">

1. **åŸå­æ€§åŸåˆ™**ï¼šäº‹åŠ¡æ–¹æ³•åº”è¯¥å°½å¯èƒ½å°ï¼ŒåªåŒ…å«å¿…è¦çš„æ•°æ®åº“æ“ä½œ
2. **æ€§èƒ½åŸåˆ™**ï¼šé¿å…åœ¨äº‹åŠ¡ä¸­è¿›è¡Œè€—æ—¶æ“ä½œï¼Œå¦‚è¿œç¨‹è°ƒç”¨ã€æ–‡ä»¶IOç­‰
3. **éš”ç¦»åŸåˆ™**ï¼šé€‰æ‹©åˆé€‚çš„éš”ç¦»çº§åˆ«ï¼Œé¿å…å¹¶å‘é—®é¢˜
4. **ä¼ æ’­åŸåˆ™**ï¼šåˆç†ä½¿ç”¨äº‹åŠ¡ä¼ æ’­è¡Œä¸ºï¼Œé¿å…äº‹åŠ¡åµŒå¥—è¿‡æ·±
5. **å¼‚å¸¸å¤„ç†åŸåˆ™**ï¼šæ˜ç¡®å®šä¹‰å›æ»šè§„åˆ™ï¼Œä¸æ•è·å¼‚å¸¸æˆ–é‡æ–°æŠ›å‡ºå¼‚å¸¸

</div>
</div>

<Tabs>
  <TabItem value="bp1" label="äº‹åŠ¡æ–¹æ³•è¦å°" default>
  ```java
  @Service
  public class TransactionBestPractice {
      // 1. äº‹åŠ¡æ–¹æ³•è¦å°½å¯èƒ½å°
      @Transactional
      public void createUser(User user) {
          // åªåŒ…å«å¿…è¦çš„æ•°æ®åº“æ“ä½œ
          validateUser(user); // éªŒè¯é€»è¾‘åº”å°½é‡æ”¾åœ¨äº‹åŠ¡å¤–
          userRepository.save(user);
      }
      
      // éäº‹åŠ¡æ–¹æ³•
      private void validateUser(User user) {
          // éªŒè¯é€»è¾‘
      }
  }
  ```
  </TabItem>
  <TabItem value="bp2" label="é¿å…è€—æ—¶æ“ä½œ">
  ```java
  @Service
  public class TransactionBestPractice {
      // 2. é¿å…åœ¨äº‹åŠ¡ä¸­è¿›è¡Œè€—æ—¶æ“ä½œ
      @Transactional
      public void createUserWithAsyncOperation(User user) {
          userRepository.save(user);
          
          // å¼‚æ­¥å¤„ç†è€—æ—¶æ“ä½œ
          CompletableFuture.runAsync(() -> {
              sendWelcomeEmail(user.getEmail());
              updateUserStatistics();
          });
      }
  }
  ```
  </TabItem>
  <TabItem value="bp3" label="åˆç†ä½¿ç”¨ä¼ æ’­è¡Œä¸º">
  ```java
  @Service
  public class TransactionBestPractice {
      // 3. åˆç†ä½¿ç”¨äº‹åŠ¡ä¼ æ’­è¡Œä¸º
      @Transactional(propagation = Propagation.REQUIRED)
      public void createUserWithOrder(User user, Order order) {
          userRepository.save(user);
          
          // è®¢å•åˆ›å»ºä½¿ç”¨ç‹¬ç«‹äº‹åŠ¡
          orderService.createOrderWithNewTransaction(order);
      }
      
      // è®¢å•æœåŠ¡
      @Service
      public class OrderService {
          @Transactional(propagation = Propagation.REQUIRES_NEW)
          public void createOrderWithNewTransaction(Order order) {
              // ç‹¬ç«‹äº‹åŠ¡ï¼Œå³ä½¿ç”¨æˆ·åˆ›å»ºå¤±è´¥ï¼Œè®¢å•ä¹Ÿå¯ä»¥æäº¤
              orderRepository.save(order);
          }
      }
  }
  ```
  </TabItem>
  <TabItem value="bp4" label="å®Œæ•´é…ç½®">
  ```java
  // 4. ä½¿ç”¨@Transactionalæ³¨è§£çš„å®Œæ•´é…ç½®
  @Transactional(
      propagation = Propagation.REQUIRED,
      isolation = Isolation.READ_COMMITTED,
      timeout = 30,
      rollbackFor = {Exception.class},
      readOnly = false
  )
  public void completeTransactionExample(User user) {
      // å®Œæ•´çš„äº‹åŠ¡é…ç½®ç¤ºä¾‹
      userRepository.save(user);
  }
  ```
  </TabItem>
</Tabs>

### 6.2 è¯»å†™åˆ†ç¦»

```mermaid
flowchart LR
    A[Serviceæ–¹æ³•] --> B{æ˜¯å¦åªè¯»?}
    B -->|æ˜¯| C[è¯»åº“]
    B -->|å¦| D[å†™åº“]
    
    C --> C1["@Transactional(readOnly=true)"]
    D --> D1["@Transactional"]
```

<div className="card">
<div className="card__body">

```java title="è¯»å†™åˆ†ç¦»ç¤ºä¾‹"
@Service
public class UserReadWriteService {
    
    @Autowired
    private UserRepository userRepository;
    
    // å†™æ“ä½œ
    @Transactional
    public User createUser(User user) {
        return userRepository.save(user);
    }
    
    // è¯»æ“ä½œ
    @Transactional(readOnly = true)
    public User findUserById(Long id) {
        return userRepository.findById(id).orElse(null);
    }
    
    // æ‰¹é‡è¯»å–æ“ä½œ
    @Transactional(readOnly = true)
    public List<User> findAllUsers() {
        return userRepository.findAll();
    }
}
```

</div>
</div>

## 7. é¢è¯•é¢˜ç²¾é€‰

### 7.1 åŸºç¡€æ¦‚å¿µé¢˜

**Q: ä»€ä¹ˆæ˜¯äº‹åŠ¡ï¼ŸSpringäº‹åŠ¡ç®¡ç†çš„ä¼˜åŠ¿æ˜¯ä»€ä¹ˆï¼Ÿ**

A: äº‹åŠ¡æ˜¯æ•°æ®åº“æ“ä½œçš„ä¸€ä¸ªé€»è¾‘å•å…ƒï¼Œå…·æœ‰ACIDç‰¹æ€§ã€‚Springäº‹åŠ¡ç®¡ç†çš„ä¼˜åŠ¿åŒ…æ‹¬ï¼š
- **å£°æ˜å¼äº‹åŠ¡**ï¼šé€šè¿‡æ³¨è§£ç®€åŒ–äº‹åŠ¡é…ç½®
- **ç¼–ç¨‹å¼äº‹åŠ¡**ï¼šæä¾›çµæ´»çš„äº‹åŠ¡æ§åˆ¶
- **ä¼ æ’­è¡Œä¸º**ï¼šæ”¯æŒå¤æ‚çš„äº‹åŠ¡åµŒå¥—
- **éš”ç¦»çº§åˆ«**ï¼šæä¾›ä¸åŒçš„äº‹åŠ¡éš”ç¦»çº§åˆ«
- **è‡ªåŠ¨å›æ»š**ï¼šå¼‚å¸¸æ—¶è‡ªåŠ¨å›æ»šäº‹åŠ¡

**Q: Springäº‹åŠ¡çš„ä¼ æ’­è¡Œä¸ºæœ‰å“ªäº›ï¼Ÿ**

A: Springå®šä¹‰äº†7ç§äº‹åŠ¡ä¼ æ’­è¡Œä¸ºï¼š
- **REQUIRED**ï¼šæ”¯æŒå½“å‰äº‹åŠ¡ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»ºæ–°äº‹åŠ¡
- **REQUIRES_NEW**ï¼šåˆ›å»ºæ–°äº‹åŠ¡ï¼ŒæŒ‚èµ·å½“å‰äº‹åŠ¡
- **SUPPORTS**ï¼šæ”¯æŒå½“å‰äº‹åŠ¡ï¼Œä¸å­˜åœ¨åˆ™ä»¥éäº‹åŠ¡æ‰§è¡Œ
- **NOT_SUPPORTED**ï¼šä»¥éäº‹åŠ¡æ‰§è¡Œï¼ŒæŒ‚èµ·å½“å‰äº‹åŠ¡
- **MANDATORY**ï¼šå¿…é¡»åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸
- **NEVER**ï¼šä¸èƒ½åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸
- **NESTED**ï¼šåµŒå¥—äº‹åŠ¡ï¼Œå¯ä»¥ç‹¬ç«‹å›æ»š

### 7.2 å®è·µé¢˜

**Q: äº‹åŠ¡çš„éš”ç¦»çº§åˆ«æœ‰å“ªäº›ï¼Ÿå„æœ‰ä»€ä¹ˆç‰¹ç‚¹ï¼Ÿ**

A: äº‹åŠ¡éš”ç¦»çº§åˆ«åŒ…æ‹¬ï¼š
- **READ_UNCOMMITTED**ï¼šè¯»æœªæäº¤ï¼Œæ€§èƒ½æœ€é«˜ä½†å­˜åœ¨è„è¯»é—®é¢˜
- **READ_COMMITTED**ï¼šè¯»å·²æäº¤ï¼Œé¿å…è„è¯»ä½†å­˜åœ¨ä¸å¯é‡å¤è¯»
- **REPEATABLE_READ**ï¼šå¯é‡å¤è¯»ï¼Œé¿å…ä¸å¯é‡å¤è¯»ä½†å­˜åœ¨å¹»è¯»
- **SERIALIZABLE**ï¼šä¸²è¡ŒåŒ–ï¼Œé¿å…æ‰€æœ‰å¹¶å‘é—®é¢˜ä½†æ€§èƒ½æœ€ä½

**Q: ä»€ä¹ˆæƒ…å†µä¸‹Springäº‹åŠ¡ä¼šå¤±æ•ˆï¼Ÿ**

A: Springäº‹åŠ¡å¤±æ•ˆçš„å¸¸è§æƒ…å†µï¼š
- **épublicæ–¹æ³•**ï¼š@Transactionalæ³¨è§£åœ¨épublicæ–¹æ³•ä¸Šä¸ç”Ÿæ•ˆ
- **è‡ªè°ƒç”¨é—®é¢˜**ï¼šåŒä¸€ä¸ªç±»ä¸­çš„æ–¹æ³•è°ƒç”¨ä¸ä¼šç»è¿‡ä»£ç†
- **å¼‚å¸¸è¢«æ•è·**ï¼šå¼‚å¸¸è¢«catchæ•è·åä¸ä¼šè§¦å‘å›æ»š
- **å¼‚å¸¸ç±»å‹ä¸åŒ¹é…**ï¼šæŠ›å‡ºçš„å¼‚å¸¸ç±»å‹ä¸åœ¨rollbackForä¸­
- **æ•°æ®åº“ä¸æ”¯æŒ**ï¼šä½¿ç”¨çš„æ•°æ®åº“ä¸æ”¯æŒäº‹åŠ¡

### 7.3 é«˜çº§é¢˜

**Q: å¦‚ä½•è§£å†³Springäº‹åŠ¡çš„è‡ªè°ƒç”¨é—®é¢˜ï¼Ÿ**

A: è§£å†³è‡ªè°ƒç”¨é—®é¢˜çš„æ–¹æ³•ï¼š
- **ä½¿ç”¨AopContext**ï¼šé€šè¿‡AopContext.currentProxy()è·å–ä»£ç†å¯¹è±¡
- **æ³¨å…¥è‡ªèº«**ï¼šä½¿ç”¨@Autowiredæ³¨å…¥è‡ªèº«çš„ä»£ç†å¯¹è±¡
- **æå–æ–¹æ³•**ï¼šå°†éœ€è¦äº‹åŠ¡çš„æ–¹æ³•æå–åˆ°å¦ä¸€ä¸ªç±»ä¸­
- **ä½¿ç”¨AspectJ**ï¼šä½¿ç”¨AspectJç¼–è¯‘æ—¶ç»‡å…¥

**Q: å¦‚ä½•è®¾è®¡ä¸€ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡ï¼Ÿ**

A: åˆ†å¸ƒå¼äº‹åŠ¡è®¾è®¡è€ƒè™‘ï¼š
- **2PC/3PCåè®®**ï¼šä¸¤é˜¶æ®µ/ä¸‰é˜¶æ®µæäº¤åè®®
- **TCCæ¨¡å¼**ï¼šTry-Confirm-Cancelæ¨¡å¼
- **Sagaæ¨¡å¼**ï¼šé•¿äº‹åŠ¡çš„è¡¥å¿æ¨¡å¼
- **æ¶ˆæ¯äº‹åŠ¡**ï¼šåŸºäºæ¶ˆæ¯çš„æœ€ç»ˆä¸€è‡´æ€§
- **æœ¬åœ°æ¶ˆæ¯è¡¨**ï¼šç»“åˆæœ¬åœ°äº‹åŠ¡å’Œæ¶ˆæ¯é˜Ÿåˆ—

:::tip äº‹åŠ¡ç®¡ç†å­¦ä¹ è¦ç‚¹
1. **ç†è§£ACIDç‰¹æ€§**ï¼šæŒæ¡äº‹åŠ¡çš„åŸå­æ€§ã€ä¸€è‡´æ€§ã€éš”ç¦»æ€§ã€æŒä¹…æ€§
2. **ç†Ÿæ‚‰ä¼ æ’­è¡Œä¸º**ï¼šäº†è§£7ç§äº‹åŠ¡ä¼ æ’­è¡Œä¸ºçš„ä½¿ç”¨åœºæ™¯
3. **æŒæ¡éš”ç¦»çº§åˆ«**ï¼šç†è§£ä¸åŒéš”ç¦»çº§åˆ«çš„ç‰¹ç‚¹å’Œé€‚ç”¨åœºæ™¯
4. **å­¦ä¼šå¼‚å¸¸å¤„ç†**ï¼šæŒæ¡äº‹åŠ¡å›æ»šå’Œå¼‚å¸¸å¤„ç†æœºåˆ¶
5. **é¿å…å¤±æ•ˆåœºæ™¯**ï¼šäº†è§£äº‹åŠ¡å¤±æ•ˆçš„åŸå› å’Œè§£å†³æ–¹æ¡ˆ
:::

---

é€šè¿‡æœ¬ç« çš„å­¦ä¹ ï¼Œä½ åº”è¯¥å·²ç»æŒæ¡äº†Springäº‹åŠ¡ç®¡ç†çš„æ ¸å¿ƒæ¦‚å¿µã€ä¼ æ’­è¡Œä¸ºã€éš”ç¦»çº§åˆ«å’Œæœ€ä½³å®è·µã€‚äº‹åŠ¡ç®¡ç†æ˜¯ä¿è¯æ•°æ®ä¸€è‡´æ€§çš„é‡è¦æŠ€æœ¯ï¼Œåœ¨å®é™…é¡¹ç›®ä¸­åˆç†ä½¿ç”¨Springäº‹åŠ¡å¯ä»¥ç¡®ä¿ä¸šåŠ¡æ•°æ®çš„å®Œæ•´æ€§å’Œå¯é æ€§ã€‚ 