---
sidebar_position: 4
title: AngularæœåŠ¡ä¸ä¾èµ–æ³¨å…¥
description: AngularæœåŠ¡å¼€å‘å®è·µï¼ŒåŒ…æ‹¬ä¾èµ–æ³¨å…¥ã€çŠ¶æ€ç®¡ç†ä¸å¼‚æ­¥æ•°æ®å¤„ç†
authors: [Laby]
tags: [Angular, æœåŠ¡, ä¾èµ–æ³¨å…¥, çŠ¶æ€ç®¡ç†, HTTP]
last_update:
  date: 2025-08-15
  author: Laby
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import CodeBlock from '@theme/CodeBlock';

# AngularæœåŠ¡ä¸ä¾èµ–æ³¨å…¥

AngularæœåŠ¡æ˜¯ä¸€ä¸ªå¹¿æ³›çš„ç±»åˆ«ï¼ŒåŒ…å«åº”ç”¨ä¸­ç”¨äºç‰¹å®šç›®çš„çš„ä»»ä½•å€¼ã€å‡½æ•°æˆ–ç‰¹æ€§ã€‚æœåŠ¡æ˜¯ä¸€ä¸ªç±»ï¼Œå®ƒå¯ä»¥åœ¨åº”ç”¨çš„å„ä¸ªéƒ¨åˆ†ä¹‹é—´å…±äº«ï¼Œé€šè¿‡ä¾èµ–æ³¨å…¥ç³»ç»Ÿæä¾›ç»™éœ€è¦å®ƒçš„ç»„ä»¶ã€‚

:::tip æ ¸å¿ƒä»·å€¼
**AngularæœåŠ¡çš„ä¼˜åŠ¿**
- ğŸ”„ **ä»£ç å¤ç”¨**ï¼šé¿å…é‡å¤é€»è¾‘ï¼Œé›†ä¸­ç®¡ç†å…±äº«åŠŸèƒ½
- ğŸ§© **å…³æ³¨ç‚¹åˆ†ç¦»**ï¼šç»„ä»¶ä¸“æ³¨äºè§†å›¾ï¼ŒæœåŠ¡ä¸“æ³¨äºæ•°æ®å’Œä¸šåŠ¡é€»è¾‘
- ğŸ’‰ **ä¾èµ–æ³¨å…¥**ï¼šæ¾è€¦åˆæ¶æ„ï¼Œä¾¿äºæµ‹è¯•å’Œç»´æŠ¤
- ğŸ“¦ **å•ä¾‹æ¨¡å¼**ï¼šé»˜è®¤å•ä¾‹ï¼Œä¾¿äºçŠ¶æ€å…±äº«å’Œç®¡ç†
- ğŸ”Œ **å¯æµ‹è¯•æ€§**ï¼šä¾¿äºå•å…ƒæµ‹è¯•ï¼Œæ”¯æŒæ¨¡æ‹Ÿä¾èµ–
:::

## 1. æœåŠ¡åŸºç¡€

### 1.1 åˆ›å»ºæœåŠ¡

ä½¿ç”¨Angular CLIåˆ›å»ºæœåŠ¡ï¼š

```bash
ng generate service services/data
# æˆ–ç®€å†™å½¢å¼
ng g s services/data
```

ä¸€ä¸ªåŸºæœ¬çš„æœåŠ¡ç¤ºä¾‹ï¼š

```typescript title="data.service.ts"
import { Injectable } from '@angular/core';

@Injectable({
  providedIn: 'root'  // åº”ç”¨çº§å•ä¾‹
})
export class DataService {
  private data: any[] = [];
  
  constructor() { }
  
  getData(): any[] {
    return this.data;
  }
  
  addData(item: any): void {
    this.data.push(item);
  }
  
  clearData(): void {
    this.data = [];
  }
}
```

### 1.2 ä¾èµ–æ³¨å…¥

Angularçš„ä¾èµ–æ³¨å…¥(DI)ç³»ç»Ÿæ˜¯ä¸€ç§è®¾è®¡æ¨¡å¼ï¼Œå®ƒå…è®¸ç±»æ¥æ”¶å®ƒä»¬çš„ä¾èµ–ï¼Œè€Œä¸æ˜¯è‡ªå·±åˆ›å»ºå®ƒä»¬ã€‚

#### æ³¨å…¥æœåŠ¡

```typescript title="users.component.ts"
import { Component, OnInit } from '@angular/core';
import { DataService } from '../services/data.service';
import { LoggingService } from '../services/logging.service';

@Component({
  selector: 'app-users',
  template: `
    <div *ngFor="let user of users">
      {{ user.name }}
    </div>
    <button (click)="addUser()">æ·»åŠ ç”¨æˆ·</button>
  `
})
export class UsersComponent implements OnInit {
  users: any[] = [];
  
  constructor(
    private dataService: DataService,
    private logger: LoggingService
  ) {}
  
  ngOnInit(): void {
    this.users = this.dataService.getData();
    this.logger.log('å·²åŠ è½½ç”¨æˆ·æ•°æ®');
  }
  
  addUser(): void {
    const newUser = { id: Date.now(), name: `User ${this.users.length + 1}` };
    this.dataService.addData(newUser);
    this.logger.log(`å·²æ·»åŠ ç”¨æˆ·: ${newUser.name}`);
  }
}
``` 

### 1.3 æä¾›è€…å’Œæ³¨å…¥å±‚çº§

Angularçš„ä¾èµ–æ³¨å…¥ç³»ç»Ÿæœ‰å¤šä¸ªçº§åˆ«çš„æä¾›è€…ï¼ŒæŒ‰ä»é«˜åˆ°ä½çš„ä¼˜å…ˆçº§æ’åˆ—ï¼š

1. **å…ƒç´ æ³¨å…¥å™¨**ï¼šåœ¨ç»„ä»¶æˆ–æŒ‡ä»¤ä¸ŠæŒ‡å®šçš„æä¾›è€…
2. **æ¨¡å—æ³¨å…¥å™¨**ï¼šåœ¨NgModuleçš„providersæ•°ç»„ä¸­æŒ‡å®šçš„æä¾›è€…
3. **æ ¹æ³¨å…¥å™¨**ï¼šåœ¨åº”ç”¨çš„æ ¹æ¨¡å—æˆ–ä½¿ç”¨`providedIn: 'root'`æŒ‡å®šçš„æä¾›è€…

#### æä¾›è€…æ–¹å¼

```typescript title="æœåŠ¡æä¾›æ–¹å¼ç¤ºä¾‹"
// 1. åœ¨æœåŠ¡è£…é¥°å™¨ä¸­æä¾›(Angular 6+æ¨èæ–¹å¼)
@Injectable({
  providedIn: 'root' // åœ¨æ ¹æ³¨å…¥å™¨ä¸­æä¾›
})
export class GlobalService { }

// 2. åœ¨æ¨¡å—ä¸­æä¾›
@NgModule({
  providers: [ModuleService]
})
export class FeatureModule { }

// 3. åœ¨ç»„ä»¶ä¸­æä¾›
@Component({
  providers: [LocalService]
})
export class SomeComponent { }

// 4. ä½¿ç”¨å·¥å‚å‡½æ•°æä¾›
@NgModule({
  providers: [
    {
      provide: ConfigService,
      useFactory: () => {
        const config = new ConfigService();
        config.apiUrl = environment.apiUrl;
        return config;
      }
    }
  ]
})
export class AppModule { }
```

### 1.4 æä¾›è€…ä»¤ç‰Œå’Œåˆ«å

Angularçš„DIç³»ç»Ÿæ”¯æŒä½¿ç”¨ä»¤ç‰Œå’Œåˆ«åæ¥æ›´çµæ´»åœ°é…ç½®ä¾èµ–ï¼š

```typescript title="æœåŠ¡ä»¤ç‰Œå’Œåˆ«åç¤ºä¾‹"
// ä½¿ç”¨InjectionToken
import { InjectionToken } from '@angular/core';

export const API_URL = new InjectionToken<string>('api.url');

@NgModule({
  providers: [
    { provide: API_URL, useValue: 'https://api.example.com/v1' }
  ]
})
export class AppModule { }

// åœ¨ç»„ä»¶ä¸­æ³¨å…¥
@Component({
  selector: 'app-example',
  template: `<div>API URL: {{ apiUrl }}</div>`
})
export class ExampleComponent {
  constructor(@Inject(API_URL) public apiUrl: string) { }
}

// ä½¿ç”¨ç±»æä¾›è€…åˆ«å
@NgModule({
  providers: [
    { provide: BaseLogger, useClass: ProductionLogger }
  ]
})
export class AppModule { }
```

## 2. é«˜çº§æœåŠ¡æ¨¡å¼

### 2.1 å•ä¾‹æœåŠ¡ä¸æœ‰çŠ¶æ€æœåŠ¡

é»˜è®¤æƒ…å†µä¸‹ï¼ŒAngularæœåŠ¡æ˜¯å•ä¾‹çš„ï¼Œå®ƒä»¬å¯ä»¥ç”¨äºåœ¨åº”ç”¨çš„ä¸åŒéƒ¨åˆ†ä¹‹é—´å…±äº«çŠ¶æ€ï¼š

```typescript title="shared-state.service.ts"
import { Injectable } from '@angular/core';
import { BehaviorSubject, Observable } from 'rxjs';

export interface AppState {
  user: any;
  theme: string;
  notifications: any[];
}

@Injectable({
  providedIn: 'root'
})
export class SharedStateService {
  // åˆå§‹çŠ¶æ€
  private initialState: AppState = {
    user: null,
    theme: 'light',
    notifications: []
  };
  
  // ä½¿ç”¨BehaviorSubjectå­˜å‚¨çŠ¶æ€
  private state$ = new BehaviorSubject<AppState>(this.initialState);
  
  // å…¬å¼€çš„å¯è§‚å¯ŸçŠ¶æ€
  currentState$ = this.state$.asObservable();
  
  constructor() { }
  
  // è·å–å½“å‰çŠ¶æ€å¿«ç…§
  get currentState(): AppState {
    return this.state$.getValue();
  }
  
  // æ›´æ–°ç”¨æˆ·
  updateUser(user: any): void {
    this.state$.next({
      ...this.currentState,
      user
    });
  }
  
  // åˆ‡æ¢ä¸»é¢˜
  toggleTheme(): void {
    const newTheme = this.currentState.theme === 'light' ? 'dark' : 'light';
    this.state$.next({
      ...this.currentState,
      theme: newTheme
    });
  }
  
  // æ·»åŠ é€šçŸ¥
  addNotification(notification: any): void {
    this.state$.next({
      ...this.currentState,
      notifications: [...this.currentState.notifications, notification]
    });
  }
  
  // æ¸…é™¤é€šçŸ¥
  clearNotifications(): void {
    this.state$.next({
      ...this.currentState,
      notifications: []
    });
  }
}
```

### 2.2 å¤šå®ä¾‹æœåŠ¡

åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ‚¨å¯èƒ½éœ€è¦æœåŠ¡çš„å¤šä¸ªå®ä¾‹ï¼Œè€Œä¸æ˜¯å•ä¾‹ï¼š

```typescript title="counter.service.ts"
import { Injectable } from '@angular/core';

// ä¸æŒ‡å®šprovidedInï¼Œä»¥ä¾¿åœ¨éœ€è¦çš„åœ°æ–¹æä¾›å®ƒ
@Injectable()
export class CounterService {
  private count = 0;
  
  increment(): void {
    this.count++;
  }
  
  decrement(): void {
    this.count--;
  }
  
  getCount(): number {
    return this.count;
  }
  
  reset(): void {
    this.count = 0;
  }
}
```

```typescript title="counter-container.component.ts"
import { Component, OnInit } from '@angular/core';
import { CounterService } from './counter.service';

@Component({
  selector: 'app-counter-container',
  template: `
    <h2>Counter Containers</h2>
    
    <app-counter title="Counter 1"></app-counter>
    
    <app-counter title="Counter 2"></app-counter>
  `,
  // æ¯ä¸ªCounterContainerå°†æœ‰è‡ªå·±çš„CounterServiceå®ä¾‹
  providers: [CounterService]
})
export class CounterContainerComponent implements OnInit {
  constructor() { }
  
  ngOnInit(): void { }
}
```

```typescript title="counter.component.ts"
import { Component, Input } from '@angular/core';
import { CounterService } from './counter.service';

@Component({
  selector: 'app-counter',
  template: `
    <div class="counter">
      <h3>{{ title }}</h3>
      <p>Count: {{ counterService.getCount() }}</p>
      <button (click)="counterService.increment()">+</button>
      <button (click)="counterService.decrement()">-</button>
      <button (click)="counterService.reset()">Reset</button>
    </div>
  `,
  // ä¸åœ¨è¿™é‡Œæä¾›CounterServiceï¼Œ
  // è€Œæ˜¯ä½¿ç”¨ä»çˆ¶ç»„ä»¶ç»§æ‰¿çš„å®ä¾‹
})
export class CounterComponent {
  @Input() title: string;
  
  constructor(public counterService: CounterService) { }
}
``` 

## 3. HTTPæœåŠ¡ä¸æ•°æ®è®¿é—®

Angularåº”ç”¨é€šå¸¸éœ€è¦ä¸åç«¯APIè¿›è¡Œé€šä¿¡ï¼ŒHttpClientæ˜¯Angularæä¾›çš„ç”¨äºå¤„ç†HTTPè¯·æ±‚çš„æœåŠ¡ã€‚

### 3.1 åŸºç¡€HTTPæœåŠ¡

é¦–å…ˆï¼Œéœ€è¦åœ¨åº”ç”¨æ¨¡å—ä¸­å¯¼å…¥HttpClientModuleï¼š

```typescript title="app.module.ts"
import { NgModule } from '@angular/core';
import { BrowserModule } from '@angular/platform-browser';
import { HttpClientModule } from '@angular/common/http';

import { AppComponent } from './app.component';

@NgModule({
  declarations: [AppComponent],
  imports: [
    BrowserModule,
    HttpClientModule  // å¯¼å…¥HTTPå®¢æˆ·ç«¯æ¨¡å—
  ],
  providers: [],
  bootstrap: [AppComponent]
})
export class AppModule { }
```

ç„¶ååˆ›å»ºä¸€ä¸ªæ•°æ®æœåŠ¡ï¼š

```typescript title="api.service.ts"
import { Injectable } from '@angular/core';
import { HttpClient, HttpParams, HttpHeaders } from '@angular/common/http';
import { Observable } from 'rxjs';
import { catchError, retry } from 'rxjs/operators';

@Injectable({
  providedIn: 'root'
})
export class ApiService {
  private apiUrl = 'https://api.example.com';
  
  constructor(private http: HttpClient) { }
  
  // è·å–æ•°æ®
  getData<T>(endpoint: string, options?: any): Observable<T> {
    return this.http.get<T>(`${this.apiUrl}/${endpoint}`, options);
  }
  
  // æäº¤æ•°æ®
  postData<T>(endpoint: string, data: any, options?: any): Observable<T> {
    return this.http.post<T>(`${this.apiUrl}/${endpoint}`, data, options);
  }
  
  // æ›´æ–°æ•°æ®
  updateData<T>(endpoint: string, data: any, options?: any): Observable<T> {
    return this.http.put<T>(`${this.apiUrl}/${endpoint}`, data, options);
  }
  
  // åˆ é™¤æ•°æ®
  deleteData<T>(endpoint: string, options?: any): Observable<T> {
    return this.http.delete<T>(`${this.apiUrl}/${endpoint}`, options);
  }
}
```

### 3.2 å¤„ç†è¯·æ±‚é€‰é¡¹

HttpClientæ”¯æŒå¤šç§è¯·æ±‚é€‰é¡¹ï¼Œå¦‚å¤´ä¿¡æ¯ã€æŸ¥è¯¢å‚æ•°ã€å“åº”ç±»å‹ç­‰ï¼š

```typescript title="product.service.ts"
import { Injectable } from '@angular/core';
import { HttpClient, HttpHeaders, HttpParams, HttpErrorResponse } from '@angular/common/http';
import { Observable, throwError } from 'rxjs';
import { catchError, retry, tap } from 'rxjs/operators';
import { Product } from '../models/product';

@Injectable({
  providedIn: 'root'
})
export class ProductService {
  private apiUrl = 'https://api.example.com/products';
  
  constructor(private http: HttpClient) { }
  
  // è·å–äº§å“åˆ—è¡¨ï¼Œæ”¯æŒåˆ†é¡µå’Œç­›é€‰
  getProducts(page: number = 1, limit: number = 20, category?: string): Observable<Product[]> {
    let params = new HttpParams()
      .set('page', page.toString())
      .set('limit', limit.toString());
      
    if (category) {
      params = params.set('category', category);
    }
    
    return this.http.get<Product[]>(this.apiUrl, { params })
      .pipe(
        retry(2),  // å¤±è´¥æ—¶é‡è¯•2æ¬¡
        catchError(this.handleError)
      );
  }
  
  // è·å–å•ä¸ªäº§å“
  getProduct(id: string): Observable<Product> {
    return this.http.get<Product>(`${this.apiUrl}/${id}`)
      .pipe(catchError(this.handleError));
  }
  
  // åˆ›å»ºäº§å“
  createProduct(product: Product): Observable<Product> {
    const headers = new HttpHeaders({
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${this.getAuthToken()}`
    });
    
    return this.http.post<Product>(this.apiUrl, product, { headers })
      .pipe(
        tap(newProduct => console.log(`Created product with ID: ${newProduct.id}`)),
        catchError(this.handleError)
      );
  }
  
  // æ›´æ–°äº§å“
  updateProduct(product: Product): Observable<Product> {
    const headers = new HttpHeaders({
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${this.getAuthToken()}`
    });
    
    return this.http.put<Product>(`${this.apiUrl}/${product.id}`, product, { headers })
      .pipe(catchError(this.handleError));
  }
  
  // åˆ é™¤äº§å“
  deleteProduct(id: string): Observable<any> {
    const headers = new HttpHeaders({
      'Authorization': `Bearer ${this.getAuthToken()}`
    });
    
    return this.http.delete(`${this.apiUrl}/${id}`, { headers })
      .pipe(catchError(this.handleError));
  }
  
  // è·å–è®¤è¯ä»¤ç‰Œ(ç¤ºä¾‹)
  private getAuthToken(): string {
    return localStorage.getItem('auth_token') || '';
  }
  
  // é”™è¯¯å¤„ç†
  private handleError(error: HttpErrorResponse) {
    let errorMessage = '';
    
    if (error.error instanceof ErrorEvent) {
      // å®¢æˆ·ç«¯é”™è¯¯
      errorMessage = `å®¢æˆ·ç«¯é”™è¯¯: ${error.error.message}`;
    } else {
      // æœåŠ¡å™¨é”™è¯¯
      errorMessage = `æœåŠ¡å™¨é”™è¯¯ä»£ç : ${error.status}, æ¶ˆæ¯: ${error.message}`;
    }
    
    console.error(errorMessage);
    return throwError(() => new Error(errorMessage));
  }
}
```

### 3.3 HTTPæ‹¦æˆªå™¨

HTTPæ‹¦æˆªå™¨å…è®¸æ‚¨åœ¨è¯·æ±‚ç¦»å¼€åº”ç”¨æˆ–å“åº”è¿”å›åº”ç”¨ä¹‹å‰æ‹¦æˆªå¹¶ä¿®æ”¹å®ƒä»¬ï¼š

```typescript title="auth.interceptor.ts"
import { Injectable } from '@angular/core';
import {
  HttpRequest,
  HttpHandler,
  HttpEvent,
  HttpInterceptor,
  HttpErrorResponse
} from '@angular/common/http';
import { Observable, throwError } from 'rxjs';
import { catchError, switchMap } from 'rxjs/operators';
import { AuthService } from './auth.service';

@Injectable()
export class AuthInterceptor implements HttpInterceptor {
  constructor(private authService: AuthService) {}
  
  intercept(request: HttpRequest<unknown>, next: HttpHandler): Observable<HttpEvent<unknown>> {
    // å¦‚æœéœ€è¦è®¤è¯çš„è¯·æ±‚ï¼Œæ·»åŠ ä»¤ç‰Œ
    if (this.authService.isLoggedIn()) {
      request = this.addToken(request, this.authService.getAccessToken());
    }
    
    // å¤„ç†å“åº”
    return next.handle(request).pipe(
      catchError((error: HttpErrorResponse) => {
        // å¦‚æœ401æœªæˆæƒé”™è¯¯ä¸”æœ‰åˆ·æ–°ä»¤ç‰Œï¼Œå°è¯•åˆ·æ–°ä»¤ç‰Œ
        if (error.status === 401 && this.authService.hasRefreshToken()) {
          return this.handle401Error(request, next);
        }
        
        return throwError(() => error);
      })
    );
  }
  
  // æ·»åŠ è®¤è¯ä»¤ç‰Œåˆ°è¯·æ±‚å¤´
  private addToken(request: HttpRequest<any>, token: string): HttpRequest<any> {
    return request.clone({
      setHeaders: {
        Authorization: `Bearer ${token}`
      }
    });
  }
  
  // å¤„ç†401é”™è¯¯ - å°è¯•åˆ·æ–°ä»¤ç‰Œ
  private handle401Error(request: HttpRequest<any>, next: HttpHandler): Observable<HttpEvent<any>> {
    return this.authService.refreshToken().pipe(
      switchMap(token => {
        return next.handle(this.addToken(request, token));
      }),
      catchError(error => {
        // åˆ·æ–°ä»¤ç‰Œä¹Ÿå¤±è´¥ï¼Œç™»å‡ºç”¨æˆ·
        this.authService.logout();
        return throwError(() => error);
      })
    );
  }
}
```

åœ¨åº”ç”¨æ¨¡å—ä¸­æ³¨å†Œæ‹¦æˆªå™¨ï¼š

```typescript title="app.module.ts"
import { NgModule } from '@angular/core';
import { BrowserModule } from '@angular/platform-browser';
import { HTTP_INTERCEPTORS, HttpClientModule } from '@angular/common/http';
import { AuthInterceptor } from './services/auth.interceptor';

@NgModule({
  declarations: [AppComponent],
  imports: [
    BrowserModule,
    HttpClientModule
  ],
  providers: [
    { provide: HTTP_INTERCEPTORS, useClass: AuthInterceptor, multi: true }
  ],
  bootstrap: [AppComponent]
})
export class AppModule { }
``` 

## 4. ç¼“å­˜ç­–ç•¥ä¸æ€§èƒ½ä¼˜åŒ–

### 4.1 æœåŠ¡ç¼“å­˜æ¨¡å¼

åœ¨ä¸åç«¯APIé€šä¿¡æ—¶ï¼Œå®ç°ç¼“å­˜å¯ä»¥æé«˜åº”ç”¨æ€§èƒ½ï¼Œå‡å°‘ç½‘ç»œè¯·æ±‚ï¼š

```typescript title="cached-product.service.ts"
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Observable, of, throwError } from 'rxjs';
import { tap, catchError, shareReplay } from 'rxjs/operators';
import { Product } from '../models/product';

@Injectable({
  providedIn: 'root'
})
export class CachedProductService {
  private apiUrl = 'https://api.example.com/products';
  
  // ç¼“å­˜
  private productsCache: { [key: string]: Observable<Product[]> } = {};
  private productCache: { [id: string]: Observable<Product> } = {};
  
  // ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
  private cacheExpiry = 5 * 60 * 1000; // 5åˆ†é’Ÿ
  private cacheTimestamps: { [key: string]: number } = {};
  
  constructor(private http: HttpClient) { }
  
  getProducts(category?: string): Observable<Product[]> {
    const cacheKey = category || 'all';
    
    // æ£€æŸ¥ç¼“å­˜æ˜¯å¦è¿‡æœŸ
    if (this.isCacheValid(cacheKey)) {
      console.log(`Using cached products for category: ${cacheKey}`);
      return this.productsCache[cacheKey];
    }
    
    // æ— ç¼“å­˜æˆ–å·²è¿‡æœŸï¼Œå‘é€æ–°è¯·æ±‚
    const url = category ? `${this.apiUrl}?category=${category}` : this.apiUrl;
    
    // ä½¿ç”¨shareReplayåˆ›å»ºå¤šæ’­Observableï¼Œç¼“å­˜æœ€æ–°ç»“æœ
    this.productsCache[cacheKey] = this.http.get<Product[]>(url).pipe(
      tap(() => this.setCacheTimestamp(cacheKey)),
      shareReplay(1),
      catchError(error => {
        delete this.productsCache[cacheKey]; // ç§»é™¤å¤±è´¥çš„ç¼“å­˜
        return throwError(() => error);
      })
    );
    
    return this.productsCache[cacheKey];
  }
  
  getProduct(id: string): Observable<Product> {
    // æ£€æŸ¥ç¼“å­˜æ˜¯å¦è¿‡æœŸ
    if (this.isCacheValid(`product_${id}`)) {
      console.log(`Using cached product: ${id}`);
      return this.productCache[id];
    }
    
    // æ— ç¼“å­˜æˆ–å·²è¿‡æœŸï¼Œå‘é€æ–°è¯·æ±‚
    this.productCache[id] = this.http.get<Product>(`${this.apiUrl}/${id}`).pipe(
      tap(() => this.setCacheTimestamp(`product_${id}`)),
      shareReplay(1),
      catchError(error => {
        delete this.productCache[id]; // ç§»é™¤å¤±è´¥çš„ç¼“å­˜
        return throwError(() => error);
      })
    );
    
    return this.productCache[id];
  }
  
  // æ¸…é™¤ç‰¹å®šäº§å“ç¼“å­˜
  clearProductCache(id: string): void {
    if (this.productCache[id]) {
      delete this.productCache[id];
      delete this.cacheTimestamps[`product_${id}`];
    }
  }
  
  // æ¸…é™¤æ‰€æœ‰ç¼“å­˜
  clearCache(): void {
    this.productsCache = {};
    this.productCache = {};
    this.cacheTimestamps = {};
  }
  
  // æ£€æŸ¥ç¼“å­˜æ˜¯å¦æœ‰æ•ˆ
  private isCacheValid(key: string): boolean {
    if (!this.productsCache[key] && !this.productCache[key]) {
      return false; // æ²¡æœ‰ç¼“å­˜
    }
    
    const timestamp = this.cacheTimestamps[key];
    if (!timestamp) return false;
    
    return (Date.now() - timestamp) < this.cacheExpiry;
  }
  
  // è®¾ç½®ç¼“å­˜æ—¶é—´æˆ³
  private setCacheTimestamp(key: string): void {
    this.cacheTimestamps[key] = Date.now();
  }
}
```

### 4.2 æœåŠ¡æµ‹è¯•

AngularæœåŠ¡æ˜¯éå¸¸é€‚åˆæµ‹è¯•çš„å•å…ƒï¼Œå› ä¸ºå®ƒä»¬ä¸ä¾èµ–DOMæˆ–ç»„ä»¶ç”Ÿå‘½å‘¨æœŸï¼š

```typescript title="product.service.spec.ts"
import { TestBed } from '@angular/core/testing';
import { HttpClientTestingModule, HttpTestingController } from '@angular/common/http/testing';
import { ProductService } from './product.service';
import { Product } from '../models/product';

describe('ProductService', () => {
  let service: ProductService;
  let httpMock: HttpTestingController;
  
  beforeEach(() => {
    TestBed.configureTestingModule({
      imports: [HttpClientTestingModule],
      providers: [ProductService]
    });
    
    service = TestBed.inject(ProductService);
    httpMock = TestBed.inject(HttpTestingController);
  });
  
  afterEach(() => {
    // éªŒè¯æ²¡æœ‰æœªå¤„ç†çš„è¯·æ±‚
    httpMock.verify();
  });
  
  it('should be created', () => {
    expect(service).toBeTruthy();
  });
  
  describe('getProducts', () => {
    it('should return products', () => {
      const mockProducts: Product[] = [
        { id: '1', name: 'Product 1', price: 100 },
        { id: '2', name: 'Product 2', price: 200 }
      ];
      
      // è°ƒç”¨æœåŠ¡æ–¹æ³•
      service.getProducts().subscribe(products => {
        expect(products.length).toBe(2);
        expect(products).toEqual(mockProducts);
      });
      
      // æ¨¡æ‹ŸHTTPè¯·æ±‚
      const req = httpMock.expectOne('https://api.example.com/products');
      expect(req.request.method).toBe('GET');
      
      // è§£æè¯·æ±‚
      req.flush(mockProducts);
    });
    
    it('should include category in query params when provided', () => {
      // è°ƒç”¨æœåŠ¡æ–¹æ³•ï¼Œä¼ é€’categoryå‚æ•°
      service.getProducts(1, 10, 'electronics').subscribe();
      
      // æ¨¡æ‹Ÿå¹¶éªŒè¯HTTPè¯·æ±‚
      const req = httpMock.expectOne(req => {
        return req.url === 'https://api.example.com/products' &&
               req.params.get('category') === 'electronics' &&
               req.params.get('page') === '1' &&
               req.params.get('limit') === '10';
      });
      
      expect(req.request.method).toBe('GET');
      req.flush([]);
    });
    
    it('should handle error', () => {
      // è°ƒç”¨æœåŠ¡æ–¹æ³•
      service.getProducts().subscribe({
        next: () => fail('åº”è¯¥å¤±è´¥'),
        error: error => {
          expect(error).toBeTruthy();
          expect(error.message).toContain('æœåŠ¡å™¨é”™è¯¯ä»£ç : 500');
        }
      });
      
      // æ¨¡æ‹ŸHTTPè¯·æ±‚å¹¶è¿”å›é”™è¯¯
      const req = httpMock.expectOne('https://api.example.com/products');
      req.flush('Server error', { status: 500, statusText: 'Internal Server Error' });
    });
  });
  
  describe('getProduct', () => {
    it('should return a single product', () => {
      const mockProduct: Product = { id: '1', name: 'Product 1', price: 100 };
      
      // è°ƒç”¨æœåŠ¡æ–¹æ³•
      service.getProduct('1').subscribe(product => {
        expect(product).toEqual(mockProduct);
      });
      
      // æ¨¡æ‹ŸHTTPè¯·æ±‚
      const req = httpMock.expectOne('https://api.example.com/products/1');
      expect(req.request.method).toBe('GET');
      
      // è§£æè¯·æ±‚
      req.flush(mockProduct);
    });
  });
});
```

æµ‹è¯•å¸¦æœ‰ä¾èµ–çš„æœåŠ¡ï¼š

```typescript title="auth.service.spec.ts"
import { TestBed } from '@angular/core/testing';
import { HttpClientTestingModule } from '@angular/common/http/testing';
import { AuthService } from './auth.service';
import { StorageService } from './storage.service';

// åˆ›å»ºæ¨¡æ‹ŸæœåŠ¡
class MockStorageService {
  private data: { [key: string]: string } = {};
  
  getItem(key: string): string {
    return this.data[key] || null;
  }
  
  setItem(key: string, value: string): void {
    this.data[key] = value;
  }
  
  removeItem(key: string): void {
    delete this.data[key];
  }
}

describe('AuthService', () => {
  let service: AuthService;
  let storageService: StorageService;
  
  beforeEach(() => {
    TestBed.configureTestingModule({
      imports: [HttpClientTestingModule],
      providers: [
        AuthService,
        { provide: StorageService, useClass: MockStorageService }
      ]
    });
    
    service = TestBed.inject(AuthService);
    storageService = TestBed.inject(StorageService);
  });
  
  it('should be created', () => {
    expect(service).toBeTruthy();
  });
  
  it('should return isLoggedIn as false when no token', () => {
    // ä½¿ç”¨jasmine spyæ¨¡æ‹ŸstorageService.getItemæ–¹æ³•
    spyOn(storageService, 'getItem').and.returnValue(null);
    
    expect(service.isLoggedIn()).toBeFalse();
    expect(storageService.getItem).toHaveBeenCalledWith('auth_token');
  });
  
  it('should return isLoggedIn as true when token exists', () => {
    spyOn(storageService, 'getItem').and.returnValue('fake-token');
    
    expect(service.isLoggedIn()).toBeTrue();
    expect(storageService.getItem).toHaveBeenCalledWith('auth_token');
  });
});
```

## 5. æœåŠ¡æœ€ä½³å®è·µ

### 5.1 æœåŠ¡è®¾è®¡åŸåˆ™

è®¾è®¡é«˜è´¨é‡çš„AngularæœåŠ¡åº”éµå¾ªä»¥ä¸‹åŸåˆ™ï¼š

1. **å•ä¸€è´£ä»»**ï¼šæ¯ä¸ªæœåŠ¡åº”è¯¥æœ‰ä¸€ä¸ªæ˜ç¡®çš„è´£ä»»
2. **å°è£…**ï¼šéšè—å†…éƒ¨å®ç°ç»†èŠ‚ï¼Œåªæš´éœ²å¿…è¦çš„å…¬å…±API
3. **å¯æµ‹è¯•æ€§**ï¼šæœåŠ¡åº”è¯¥æ˜“äºå•å…ƒæµ‹è¯•
4. **æ¾è€¦åˆ**ï¼šæœåŠ¡ä¹‹é—´åº”è¯¥å°½é‡å‡å°‘ä¾èµ–
5. **ä¸å¯å˜æ€§**ï¼šå°½é‡ä½¿ç”¨ä¸å¯å˜æ•°æ®ç»“æ„ï¼Œé¿å…å‰¯ä½œç”¨

### 5.2 æœåŠ¡ç»„ç»‡æ¨¡å¼

#### æ ¸å¿ƒæœåŠ¡ä¸ç‰¹æ€§æœåŠ¡

å°†æœåŠ¡åˆ†ä¸ºä¸¤ç±»æœ‰åŠ©äºæ›´å¥½åœ°ç»„ç»‡ä»£ç ï¼š

1. **æ ¸å¿ƒæœåŠ¡**ï¼šåº”ç”¨çº§åˆ«çš„å•ä¾‹æœåŠ¡ï¼Œå¦‚è®¤è¯ã€æ—¥å¿—è®°å½•ã€HTTPé€šä¿¡
2. **ç‰¹æ€§æœåŠ¡**ï¼šä¸ç‰¹å®šåŠŸèƒ½æ¨¡å—å…³è”çš„æœåŠ¡ï¼Œå¦‚ç”¨æˆ·ç®¡ç†ã€äº§å“ç®¡ç†

```typescript title="core/core.module.ts"
import { NgModule, Optional, SkipSelf } from '@angular/core';
import { CommonModule } from '@angular/common';
import { HttpClientModule, HTTP_INTERCEPTORS } from '@angular/common/http';

import { AuthService } from './services/auth.service';
import { LoggingService } from './services/logging.service';
import { ApiService } from './services/api.service';
import { AuthInterceptor } from './interceptors/auth.interceptor';
import { LoggingInterceptor } from './interceptors/logging.interceptor';

@NgModule({
  imports: [
    CommonModule,
    HttpClientModule
  ],
  providers: [
    AuthService,
    LoggingService,
    ApiService,
    { provide: HTTP_INTERCEPTORS, useClass: AuthInterceptor, multi: true },
    { provide: HTTP_INTERCEPTORS, useClass: LoggingInterceptor, multi: true }
  ]
})
export class CoreModule {
  // é˜²æ­¢CoreModuleè¢«å¤šæ¬¡å¯¼å…¥
  constructor(@Optional() @SkipSelf() parentModule: CoreModule) {
    if (parentModule) {
      throw new Error('CoreModuleå·²ç»åŠ è½½ã€‚åº”è¯¥åªåœ¨AppModuleä¸­å¯¼å…¥CoreModuleã€‚');
    }
  }
}
```

#### æœåŠ¡ç»§æ‰¿ä¸ç»„åˆ

é€‰æ‹©åˆé€‚çš„æœåŠ¡è®¾è®¡æ¨¡å¼ï¼š

```typescript title="ç»§æ‰¿ç¤ºä¾‹"
// åŸºç¡€æœåŠ¡
@Injectable()
export class BaseApiService<T> {
  constructor(protected http: HttpClient) {}
  
  getAll(url: string): Observable<T[]> {
    return this.http.get<T[]>(url);
  }
  
  getById(url: string, id: string): Observable<T> {
    return this.http.get<T>(`${url}/${id}`);
  }
  
  create(url: string, entity: T): Observable<T> {
    return this.http.post<T>(url, entity);
  }
  
  update(url: string, id: string, entity: T): Observable<T> {
    return this.http.put<T>(`${url}/${id}`, entity);
  }
  
  delete(url: string, id: string): Observable<void> {
    return this.http.delete<void>(`${url}/${id}`);
  }
}

// æ´¾ç”ŸæœåŠ¡
@Injectable({
  providedIn: 'root'
})
export class UserService extends BaseApiService<User> {
  private apiUrl = 'https://api.example.com/users';
  
  constructor(http: HttpClient) {
    super(http);
  }
  
  getAllUsers(): Observable<User[]> {
    return this.getAll(this.apiUrl);
  }
  
  getUserById(id: string): Observable<User> {
    return this.getById(this.apiUrl, id);
  }
  
  // ç‰¹å®šäºç”¨æˆ·çš„æ–¹æ³•
  getUsersByDepartment(department: string): Observable<User[]> {
    return this.http.get<User[]>(`${this.apiUrl}/department/${department}`);
  }
}
```

```typescript title="ç»„åˆç¤ºä¾‹"
@Injectable({
  providedIn: 'root'
})
export class ProductService {
  private apiUrl = 'https://api.example.com/products';
  
  constructor(
    private api: ApiService,
    private logger: LoggingService,
    private analytics: AnalyticsService
  ) {}
  
  getProducts(): Observable<Product[]> {
    this.logger.log('Fetching products');
    return this.api.getData<Product[]>(this.apiUrl).pipe(
      tap(products => {
        this.analytics.trackEvent('Products_Loaded', { count: products.length });
      })
    );
  }
}
```

### 5.3 æ€§èƒ½ä¸ä¼˜åŒ–

æé«˜æœåŠ¡æ€§èƒ½çš„æŠ€å·§ï¼š

1. **ä½¿ç”¨Observableæ“ä½œç¬¦**ï¼š`shareReplay`ã€`distinctUntilChanged`ã€`debounceTime`ç­‰
2. **å®ç°ç¼“å­˜ç­–ç•¥**ï¼šç¼“å­˜é¢‘ç¹ä½¿ç”¨çš„æ•°æ®
3. **æ‰¹é‡è¯·æ±‚**ï¼šä½¿ç”¨`forkJoin`åˆå¹¶å¤šä¸ªè¯·æ±‚
4. **å–æ¶ˆè¯·æ±‚**ï¼šåœ¨ä¸éœ€è¦æ—¶å–æ¶ˆHTTPè¯·æ±‚
5. **æ‡’åŠ è½½æœåŠ¡**ï¼šä½¿ç”¨å»¶è¿ŸåŠ è½½ç‰¹æ€§æ¨¡å—å»¶è¿ŸåŠ è½½æœåŠ¡

```typescript title="ä¼˜åŒ–ç¤ºä¾‹"
@Injectable({
  providedIn: 'root'
})
export class OptimizedDataService {
  // ä½¿ç”¨ReplaySubjectç¼“å­˜æœ€æ–°å€¼
  private _data$ = new ReplaySubject<any[]>(1);
  
  // å…¬å¼€ä¸ºåªè¯»Observable
  readonly data$ = this._data$.asObservable();
  
  // è·Ÿè¸ªåŠ è½½çŠ¶æ€
  private loading = false;
  
  constructor(private http: HttpClient) {}
  
  // åªåœ¨éœ€è¦æ—¶åŠ è½½æ•°æ®
  loadData(): Observable<any[]> {
    if (!this.loading) {
      this.loading = true;
      
      this.http.get<any[]>('api/data').pipe(
        // ç¡®ä¿æ•°æ®åªè¢«è·å–ä¸€æ¬¡ï¼Œå³ä½¿æœ‰å¤šä¸ªè®¢é˜…è€…
        shareReplay(1),
        // æ— è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œéƒ½é‡ç½®loadingçŠ¶æ€
        finalize(() => this.loading = false)
      ).subscribe(data => {
        this._data$.next(data);
      });
    }
    
    return this.data$;
  }
  
  // æ‰¹é‡è¯·æ±‚ç¤ºä¾‹
  batchRequests(ids: string[]): Observable<any[]> {
    // åˆ›å»ºå¤šä¸ªè¯·æ±‚çš„æ•°ç»„
    const requests = ids.map(id => 
      this.http.get<any>(`api/data/${id}`)
    );
    
    // å¹¶è¡Œæ‰§è¡Œæ‰€æœ‰è¯·æ±‚ï¼Œç­‰å¾…æ‰€æœ‰è¯·æ±‚å®Œæˆ
    return forkJoin(requests);
  }
  
  // å¯å–æ¶ˆçš„è¯·æ±‚
  searchWithCancel(term: string, cancelPrevious: Subject<void>): Observable<any[]> {
    // å–æ¶ˆä¹‹å‰çš„è¯·æ±‚
    cancelPrevious.next();
    
    return this.http.get<any[]>(`api/search?q=${term}`).pipe(
      takeUntil(cancelPrevious)
    );
  }
}
``` 